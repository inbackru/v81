Перейти к объектам
`); printWin.document.close(); }); // Send comparison to client document.getElementById('send-comp-btn')?.addEventListener('click', function() { document.getElementById('sendCompClientModal')?.classList.remove('hidden'); }); document.getElementById('sendCompClientForm')?.addEventListener('submit', function(e) { e.preventDefault(); const name = document.getElementById('compRecipientName').value; const notes = document.getElementById('compMessageNotes').value; const properties = (window.compPropertyData || []).map(p => ({ property_id: p.property_id || p.id, property_name: p.property_name || p.title || '', property_price: p.property_price || p.current_price || p.price || 0, property_size: p.area || p.property_size || '', property_image: Array.isArray(p.property_image || p.main_image) ? (p.property_image || p.main_image)[0] : (p.property_image || p.main_image || ''), rooms: p.rooms || '', floor: p.floor || '', total_floors: p.total_floors || '', developer_name: p.developer_name || p.developer || '', address: p.address || '', cashback_rate: p.cashback_rate || 5, is_sold: p.is_sold || false, complex_name: p.complex_name || '' })); const complexes = (window.compComplexData || []).map(c => ({ name: c.name || c.title || '', photo: c.photo || c.image || c.main_image || '', min_price: c.min_price || c.price_from || 0, max_price: c.max_price || c.price_to || 0, completion_date: c.completion_date || '', cashback_rate: c.cashback_rate || 0, developer: c.developer || c.developer_name || '', address: c.address || '', object_class: c.object_class || c.housing_class || '', is_sold: c.is_sold || false })); fetch('/api/manager/generate-comparison-pdf', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFTokenComp()}, body: JSON.stringify({recipient_name: name, notes: notes, properties: properties, complexes: complexes}) }) .then(r => { if (r.headers.get('Content-Disposition')?.includes('attachment')) { return r.blob().then(blob => { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = r.headers.get('Content-Disposition').match(/filename="(.+)"/)?.[1] || 'comparison.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); document.getElementById('sendCompClientModal').classList.add('hidden'); }); } return r.json().then(data => { document.getElementById('sendCompClientModal').classList.add('hidden'); if (data.success && data.pdf_url) { window.open(data.pdf_url, '_blank'); } else { alert(data.message || 'Документ создан'); } }); }) .catch(err => { console.error('Error sending comparison:', err); document.getElementById('sendCompClientModal').classList.add('hidden'); }); });