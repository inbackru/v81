{% extends "base.html" %}

{% block title %}–ñ–ö –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ - –ø–æ–∏—Å–∫ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ | inback{% endblock %}
{% block description %}–ö–∞—Ç–∞–ª–æ–≥ –≤—Å–µ—Ö –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ —Å –∫—ç—à–±–µ–∫–æ–º –¥–æ 500 000 ‚ÇΩ. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞—Ö, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, —Ü–µ–Ω—ã, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏.{% endblock %}
{% block keywords %}–∂–∫ –∫—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –∫—Ä–∞—Å–Ω–æ–¥–∞—Ä, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –∫—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫—ç—à–±–µ–∫ –∂–∫{% endblock %}

{% block extra_head %}
<!-- Robots meta -->
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('residential_complexes', _external=True) }}">
<meta property="og:title" content="–ñ–ö –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ - –ø–æ–∏—Å–∫ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ | InBack">
<meta property="og:description" content="–ö–∞—Ç–∞–ª–æ–≥ –≤—Å–µ—Ö –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ —Å –∫—ç—à–±–µ–∫–æ–º –¥–æ 500 000 ‚ÇΩ. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞—Ö, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, —Ü–µ–Ω—ã, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏.">
<meta property="og:image" content="{{ url_for('static', filename='images/complexes-og.jpg', _external=True) }}">
<meta property="og:site_name" content="InBack">
<meta property="og:locale" content="ru_RU">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ url_for('residential_complexes', _external=True) }}">
<meta name="twitter:title" content="–ñ–ö –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ - –ø–æ–∏—Å–∫ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ | InBack">
<meta name="twitter:description" content="–ö–∞—Ç–∞–ª–æ–≥ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ —Å –∫—ç—à–±–µ–∫–æ–º. –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, —Ü–µ–Ω—ã, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏.">
<meta name="twitter:image" content="{{ url_for('static', filename='images/complexes-og.jpg', _external=True) }}">

<!-- Canonical -->
<link rel="canonical" href="{{ url_for('residential_complexes', _external=True) }}" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>
<style>
    .complex-card {
        transition: all 0.3s ease;
    }
    .complex-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Slider styles */
    .slider-dot.active {
        background-color: white !important;
    }
    
    .slider-prev:hover,
    .slider-next:hover {
        transform: translateY(-50%) scale(1.1);
    }
    
    .filter-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background-color: #0088CC;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .custom-complex-marker {
        background: none !important;
        border: none !important;
    }
    
    .custom-complex-marker div {
        animation: markerPulse 2s infinite;
        white-space: nowrap;
    }
    
    @keyframes markerPulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 136, 204, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(0, 136, 204, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 136, 204, 0); }
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
        /* MOBILE: Hide Hero section on mobile */
        #complexes-hero {
            display: none !important;
        }
        
        /* MOBILE: Sticky search bar (Avito-style) */
        #mobile-complex-search-bar {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.98);
        }
        
        /* Mobile search input */
        #mobile-complex-search-bar #complex-search-mobile {
            font-size: 0.875rem !important;
        }
        
        #mobile-complex-search-bar #complex-search-mobile::placeholder {
            color: #9ca3af !important;
        }
        
        /* Hide desktop search section background on mobile */
        #desktop-complex-search {
            padding: 0 !important;
            background: transparent !important;
        }
        
        /* Hide only the search input FLEX ROW on mobile, NOT the card container */
        #desktop-complex-search .bg-white.rounded-xl > .flex {
            display: none !important;
        }
        
        /* Make filters panel fullscreen modal on mobile when opened */
        #filtersPanel.mobile-fullscreen {
            display: flex !important;
            flex-direction: column !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important; /* Very high z-index to be above everything */
            background: white !important;
            margin-top: 0 !important; /* Override mt-6 */
            padding-top: 0 !important; /* Override pt-6 */
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            border-top: none !important; /* Override border-t */
            max-height: 100vh !important;
        }
        
        /* Make sure hidden class works */
        #filtersPanel.hidden {
            display: none !important;
        }
        
        .mobile-optimized {
            margin-bottom: 16px;
        }
        
        .mobile-optimized .complex-slider {
            height: 200px;
        }
        
        .mobile-optimized img {
            height: 200px;
        }
        
        /* Compact stats grid on mobile */
        .mobile-optimized .grid-cols-2 {
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ */
        #complexesMapContainer {
            border-radius: 0.75rem !important;
        }
        
        #complexesAvitorMap {
            height: 400px !important;
        }
        
        #complexMapToggleBtn {
            flex-direction: column !important;
            gap: 0.5rem !important;
            padding: 1rem !important;
        }
        
        /* List view styles */
        .list-view-card {
            overflow: visible !important;
        }
        
        .list-view-card .complex-slider {
            height: 320px !important;
            width: 100% !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            position: relative !important;
        }
        
        .list-view-card .slider-slide {
            width: 100% !important;
            height: 320px !important;
        }
        
        .list-view-card .slider-slide img {
            height: 320px !important;
            width: 100% !important;
            object-fit: cover !important;
            object-position: center !important;
            display: block !important;
        }
        
        /* Better touch targets */
        .mobile-optimized button {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* Hide some details on mobile */
        .hidden-mobile {
            display: none;
        }
        
        /* Mobile filter panel full width */
        #filters-panel {
            margin-left: -16px;
            margin-right: -16px;
            border-radius: 0;
        }
        
        /* Make filter inputs larger for touch */
        #filters-panel input,
        #filters-panel select {
            min-height: 48px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
    }
    
    @media (max-width: 480px) {
        .mobile-optimized .text-sm {
            font-size: 13px;
        }
        
        .mobile-optimized .p-6 {
            padding: 16px;
        }
        
        /* Single column on very small screens */
        .complexes-container {
            grid-template-columns: 1fr !important;
        }
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º Chaport –≤–∏–¥–∂–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ */
    #chaport-launcher,
    #chaport-container,
    .chaport-launcher,
    .chaport-container,
    iframe[src*="chaport"],
    div[class*="chaport"],
    div[id*="chaport"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs (hidden on mobile) -->
<div class="hidden md:block container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">–ñ–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section id="complexes-hero" class="py-6 md:py-12 bg-gradient-to-br from-blue-50 to-white">
    <div class="container mx-auto px-4">
        <h1 class="text-2xl md:text-4xl font-bold text-center mb-3 md:mb-6">–ñ–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞</h1>
        <p class="text-base md:text-xl text-gray-600 text-center mb-4 md:mb-8">{{ residential_complexes|length }} –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ —Å –∫—ç—à–±—ç–∫–æ–º –¥–æ 500 000 ‚ÇΩ</p>
    </div>
</section>

<!-- Mobile-only Sticky Search Bar (Avito style) -->
<section id="mobile-complex-search-bar" class="md:hidden sticky top-0 z-30 bg-white border-b border-gray-200 shadow-sm">
    <div class="container mx-auto px-4 py-3">
        <div class="flex items-center gap-2">
            <!-- Search Input -->
            <div class="flex-1 relative">
                <input type="text" 
                       id="complex-search-mobile"
                       placeholder="–ü–æ–∏—Å–∫ –ñ–ö: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫..." 
                       class="w-full pl-4 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-sm text-gray-700 bg-gray-50">
            </div>
            
            <!-- Open –ñ–ö Map Icon -->
            <button onclick="openFullscreenComplexesMap();" 
                    class="flex-shrink-0 w-10 h-10 bg-white border border-gray-300 rounded-lg flex items-center justify-center text-gray-600 hover:text-[#0088CC] hover:border-[#0088CC] transition-all" 
                    title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
                <i class="fas fa-map text-lg"></i>
            </button>
            
            <!-- Filter Icon -->
            <button onclick="toggleFilters();" 
                    class="relative flex-shrink-0 w-10 h-10 bg-[#0088CC] rounded-lg flex items-center justify-center text-white hover:bg-[#006699] transition-all" 
                    title="–§–∏–ª—å—Ç—Ä—ã">
                <i class="fas fa-sliders-h text-lg"></i>
                <span id="mobile-filter-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">0</span>
            </button>
        </div>
    </div>
</section>

<!-- Desktop Search Section -->
<section id="desktop-complex-search" class="py-6 bg-gradient-to-br from-blue-50 to-white">
    <div class="container mx-auto px-4">
        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6 mb-6 md:mb-8">
            <div class="flex flex-col md:flex-row md:items-center space-y-3 md:space-y-0 md:space-x-3">
                <div class="relative flex-grow">
                    <input id="complex-search" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] text-sm" placeholder="–ü–æ–∏—Å–∫ –ñ–ö –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É –∏–ª–∏ —Ä–∞–π–æ–Ω—É" type="text"/>
                    <div class="absolute left-3 top-3 text-gray-400">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                    <!-- Search Suggestions -->
                    <div id="complex-searchSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 shadow-lg z-50 max-h-64 overflow-y-auto">
                        <!-- Suggestions will be populated by JavaScript -->
                    </div>
                </div>

                <button class="bg-gradient-to-r from-[#006699] to-[#0088CC] text-white px-6 py-3 rounded-xl font-medium hover:opacity-90 transition" onclick="searchComplexes()">
                    –ù–∞–π—Ç–∏ –ñ–ö
                </button>
                <a href="/complexes-map" class="hidden md:flex items-center justify-center text-[#0088CC] hover:text-white bg-white hover:bg-[#0088CC] px-4 py-2.5 rounded-lg text-sm font-medium border border-[#0088CC] transition-all duration-200 shadow-sm hover:shadow-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    –ö–∞—Ä—Ç–∞ –ñ–ö
                </a>
                <a href="{{ url_for('properties') }}" class="hidden md:flex items-center justify-center text-[#0088CC] hover:text-white bg-white hover:bg-[#0088CC] px-4 py-2.5 rounded-lg text-sm font-medium border border-[#0088CC] transition-all duration-200 shadow-sm hover:shadow-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    </svg>
                    –ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä
                </a>
                <button class="flex items-center text-gray-600 hover:text-[#0088CC] px-3 py-1 rounded-lg text-sm relative" onclick="toggleFilters()">
                    <div id="activeFilterBadge" class="filter-badge hidden">0</div>
                    <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
                    </svg>
                    –§–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
            
            <!-- Expanded Filters -->
            <div id="filtersPanel" class="hidden mt-6 pt-6 border-t border-gray-200">
                <!-- Mobile Header with Close Button (visible only on mobile fullscreen mode) -->
                <div class="md:hidden flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-white flex-shrink-0">
                    <h3 class="text-lg font-semibold text-gray-800">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <button onclick="toggleFilters();" class="p-2 text-gray-600 hover:text-gray-700 transition-colors" title="–ó–∞–∫—Ä—ã—Ç—å">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Scrollable Content -->
                <div class="md:block flex-1 overflow-y-auto">
                <!-- Filters Content Wrapper with padding -->
                <div class="md:p-0 p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- District Filter -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">–†–∞–π–æ–Ω</label>
                        <select id="district-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                            <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
                            {% for district in districts %}
                            <option value="{{ district.id }}">{{ district.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Developer Filter -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</label>
                        <select id="developer-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                            <option value="">–í—Å–µ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</option>
                            {% for developer in developers %}
                            <option value="{{ developer.id }}">{{ developer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Status Filter -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</label>
                        <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                            <option value="">–õ—é–±–æ–π —Å—Ç–∞—Ç—É—Å</option>
                            <option value="–°—Ç—Ä–æ–∏—Ç—Å—è">–°—Ç—Ä–æ–∏—Ç—Å—è</option>
                            <option value="–°–¥–∞–Ω">–°–¥–∞–Ω</option>
                            <option value="–°–∫–æ—Ä–æ">–°–∫–æ—Ä–æ –≤ –ø—Ä–æ–¥–∞–∂–µ</option>
                        </select>
                    </div>
                    
                    <!-- New Filters Row -->
                    <div class="col-span-full">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-4 pt-4 border-t border-gray-200">
                            <!-- Object Class Filter -->
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‚≠ê –ö–ª–∞—Å—Å –∂–∏–ª—å—è</label>
                                <select id="object-class-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                                    <option value="">–õ—é–±–æ–π</option>
                                    <option value="–ü—Ä–µ–º–∏—É–º">–ü—Ä–µ–º–∏—É–º</option>
                                    <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                                    <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                </select>
                            </div>
                            
                            <!-- Year Filter -->
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">üìÖ –ì–æ–¥ —Å–¥–∞—á–∏</label>
                                <select id="completion-year-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                                    <option value="">–õ—é–±–æ–π</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2028">2028</option>
                                </select>
                            </div>
                            
                            <!-- Floors Filter -->
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">üè¢ –≠—Ç–∞–∂–Ω–æ—Å—Ç—å</label>
                                <select id="floors-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none">
                                    <option value="">–õ—é–±–∞—è</option>
                                    <option value="low">1-5 —ç—Ç–∞–∂–µ–π</option>
                                    <option value="medium">6-10 —ç—Ç–∞–∂–µ–π</option>
                                    <option value="high">10+ —ç—Ç–∞–∂–µ–π</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Rooms and Price Filter Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <!-- Rooms Filter (Checkboxes) -->
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">üõèÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                                <div class="space-y-2">
                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" value="—Å—Ç—É–¥–∏—è" data-filter-type="rooms" class="mr-2 w-4 h-4 text-[#0088CC] focus:ring-[#0088CC] rounded" onchange="applyComplexFilters()">
                                        <span class="text-sm text-gray-700">–°—Ç—É–¥–∏—è</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" value="1-–∫–æ–º–Ω" data-filter-type="rooms" class="mr-2 w-4 h-4 text-[#0088CC] focus:ring-[#0088CC] rounded" onchange="applyComplexFilters()">
                                        <span class="text-sm text-gray-700">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" value="2-–∫–æ–º–Ω" data-filter-type="rooms" class="mr-2 w-4 h-4 text-[#0088CC] focus:ring-[#0088CC] rounded" onchange="applyComplexFilters()">
                                        <span class="text-sm text-gray-700">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" value="3-–∫–æ–º–Ω" data-filter-type="rooms" class="mr-2 w-4 h-4 text-[#0088CC] focus:ring-[#0088CC] rounded" onchange="applyComplexFilters()">
                                        <span class="text-sm text-gray-700">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" value="4+-–∫–æ–º–Ω" data-filter-type="rooms" class="mr-2 w-4 h-4 text-[#0088CC] focus:ring-[#0088CC] rounded" onchange="applyComplexFilters()">
                                        <span class="text-sm text-gray-700">4+-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Price Range Filter -->
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">üí∞ –¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                                <div class="flex gap-2">
                                    <input type="number" id="price-range-from" placeholder="–æ—Ç" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none text-sm" min="0" step="0.5" onchange="applyComplexFilters()">
                                    <input type="number" id="price-range-to" placeholder="–¥–æ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] outline-none text-sm" min="0" step="0.5" onchange="applyComplexFilters()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Filters Content Wrapper -->
                </div>
                <!-- End Scrollable Content -->
                
                <!-- Mobile Apply Button (visible only on mobile fullscreen mode) -->
                <div class="md:hidden px-4 py-3 border-t border-gray-200 bg-white flex-shrink-0">
                    <button onclick="applyComplexFilters(); toggleFilters();" class="w-full bg-gradient-to-r from-[#006699] to-[#0088CC] text-white py-3 px-6 rounded-lg font-medium hover:opacity-90 transition-all shadow-lg">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map View (hidden by default) -->
<section id="mapSection" class="hidden bg-white">
    <div class="h-screen relative">
        <!-- Map container -->
        <div id="complexesMap" class="h-full w-full" style="margin-left: 320px;"></div>
        
        <!-- Floating Drawing Controls -->
        <div class="absolute top-4 right-4 flex flex-col space-y-2" style="z-index: 1000;">
            <button id="drawComplexAreaBtn" class="bg-white shadow-lg hover:shadow-xl border border-gray-200 text-gray-700 hover:text-[#0088CC] px-4 py-2 rounded-lg text-sm font-medium transition-all">
                <i class="fas fa-draw-polygon mr-2"></i>–í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å
            </button>
            <button id="clearComplexAreaBtn" class="bg-white shadow-lg hover:shadow-xl border border-gray-200 text-[#0088CC] hover:text-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-all hidden">
                <i class="fas fa-times mr-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –æ–±–ª–∞—Å—Ç—å
            </button>
        </div>
        
        <!-- Floating controls -->
        <div class="absolute top-4 right-4 z-30" style="left: 340px;">
            <div class="bg-white rounded-xl shadow-lg p-4">
                <div class="flex flex-col md:flex-row md:items-center space-y-3 md:space-y-0 md:space-x-3">
                    <div class="relative flex-grow">
                        <input id="map-search" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] text-sm" placeholder="–ü–æ–∏—Å–∫ –ñ–ö –Ω–∞ –∫–∞—Ä—Ç–µ" type="text"/>
                        <div class="absolute left-3 top-3 text-gray-400">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <button class="bg-gradient-to-r from-[#006699] to-[#0088CC] text-white px-6 py-3 rounded-xl font-medium hover:opacity-90 transition" onclick="searchComplexesOnMap()">
                        –ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                    </button>
                    <button class="flex items-center text-gray-600 hover:text-[#0088CC] px-3 py-1 rounded-lg text-sm border border-gray-300 hover:border-[#0088CC] transition" onclick="toggleMapView()">
                        <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
                        </svg>
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Left sidebar with complex cards -->
        <div id="mapSidebar" class="absolute left-4 top-4 bottom-4 w-80 bg-white rounded-xl shadow-lg overflow-hidden z-20">
            <div class="p-4 border-b border-gray-200">
                <h3 class="font-semibold text-gray-900">–ñ–ö –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
                <p class="text-sm text-gray-600" id="mapResultsCount">–ù–∞–π–¥–µ–Ω–æ 0 –∫–æ–º–ø–ª–µ–∫—Å–æ–≤</p>
            </div>
            <div class="overflow-y-auto" id="mapComplexesList" style="height: calc(100% - 70px);">
                <!-- Complex cards will be populated by JavaScript -->
            </div>
        </div>
    </div>
</section>

<!-- Complexes Grid -->
<section id="gridSection" class="py-12 bg-white">
    <div class="container mx-auto px-4">
        <!-- Mini Map Section (Avito-style) -->
        <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Mini Map Preview -->
            <div id="miniComplexesMap" class="w-full relative" style="height: 200px; cursor: pointer;" onclick="openFullscreenComplexesMap()">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto text-[#0088CC] opacity-50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Link Button -->
            <button onclick="openFullscreenComplexesMap()" class="block w-full p-4 border-t border-gray-200 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-center gap-3">
                    <svg class="w-5 h-5 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <span class="font-semibold text-gray-900">–ü–æ–∫–∞–∑–∞—Ç—å –ñ–ö –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">{{ residential_complexes|length }}</span>
                </div>
            </button>
        </div>

        <!-- Results summary and controls -->
        <div class="flex flex-col gap-4 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-2xl font-bold text-gray-900">
                    –ù–∞–π–¥–µ–Ω–æ <span id="results-count">{{ residential_complexes|length }}</span> –ñ–ö
                </h2>
                <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3 md:gap-6 w-full md:w-auto">
                    <!-- View mode toggle - —Å–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∞–π–ª–µ -->
                    <div class="hidden md:flex items-center gap-3">
                        <span class="text-sm text-gray-600">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</span>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="grid-view-btn" class="flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm" onclick="switchToGridView()">
                                <i class="fas fa-th-large mr-2"></i>
                                –°–µ—Ç–∫–∞
                            </button>
                            <button id="list-view-btn" class="flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900" onclick="switchToListView()">
                                <i class="fas fa-list mr-2"></i>
                                –°–ø–∏—Å–æ–∫
                            </button>
                        </div>
                    </div>
                    <!-- Sort - –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –Ω–∞ –º–æ–±–∞–π–ª–µ -->
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 w-full md:w-auto">
                        <span class="text-sm text-gray-600 hidden md:inline">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                        <select id="sort-select" class="w-full md:w-auto border border-gray-300 rounded-lg px-3 py-3 md:py-2 text-sm">
                            <option value="name-asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üë</option>
                            <option value="name-desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üì</option>
                            <option value="price-asc" selected>–ü–æ —Ü–µ–Ω–µ ‚Üë</option>
                            <option value="price-desc">–ü–æ —Ü–µ–Ω–µ ‚Üì</option>
                            <option value="completion-asc">–ü–æ —Å—Ä–æ–∫—É —Å–¥–∞—á–∏ ‚Üë</option>
                            <option value="completion-desc">–ü–æ —Å—Ä–æ–∫—É —Å–¥–∞—á–∏ ‚Üì</option>
                            <option value="apartments-desc">–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–≤–∞—Ä—Ç–∏—Ä ‚Üì</option>
                            <option value="apartments-asc">–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–≤–∞—Ä—Ç–∏—Ä ‚Üë</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Complexes Container - 3 Cards Per Row on Desktop -->
        <div id="complexes-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {% for complex in residential_complexes %}
            <div class="complex-card bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 hover:shadow-xl transition-all duration-300 mobile-optimized cursor-pointer group" data-complex-id="{{ complex.id }}" data-cashback-rate="{{ complex.cashback_rate|default(5.0) }}" onclick="handleCardClick(event, '/zk/{{ complex.name|slug }}')">
                <!-- Complex Image Slider -->
                <div class="relative h-56 overflow-hidden complex-slider" data-complex-id="{{ complex.id }}">
                    <div class="slider-container">
                        <div class="slider-track flex transition-transform duration-300 ease-in-out">
                            {% if complex.images and complex.images|length > 1 %}
                                {% for image in complex.images[1:] %}
                                <div class="slider-slide min-w-full">
                                    <img src="{{ image }}" alt="{{ complex.name }} - —Ñ–æ—Ç–æ {{ loop.index + 1 }}" class="w-full h-56 object-contain bg-gray-50">
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="slider-slide min-w-full">
                                    <img src="{{ complex.image }}" alt="{{ complex.name }}" class="w-full h-56 object-contain bg-gray-50">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Slider navigation -->
                    <button class="slider-prev absolute left-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10" onclick="event.stopPropagation(); prevSlide('{{ complex.id }}')">
                        <i class="fas fa-chevron-left text-sm"></i>
                    </button>
                    <button class="slider-next absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10" onclick="event.stopPropagation(); nextSlide('{{ complex.id }}')">
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                    
                    <!-- Slider dots -->
                    {% if complex.images and complex.images|length > 2 %}
                    <div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                        {% for image in complex.images[1:] %}
                        <div class="slider-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors {% if loop.first %}active{% endif %}" data-complex-id="{{ complex.id }}" data-slide="{{ loop.index0 }}" onclick="event.stopPropagation(); goToSlide('{{ complex.id }}', {{ loop.index0 }})"></div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Status badges -->
                    <div class="absolute top-3 left-3 z-10">
                        {% if complex.status == '–°–¥–∞–Ω' %}
                        <span class="bg-green-50 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">–ì–æ—Ç–æ–≤</span>
                        {% else %}
                        <span class="bg-blue-50 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">–°—Ç—Ä–æ–∏—Ç—Å—è</span>
                        {% endif %}
                    </div>
                    
                    <!-- Price badge -->
                    <div class="absolute top-3 right-3 bg-orange-50 text-gray-600 px-3 py-1 rounded-full text-sm font-bold z-10">
                        –æ—Ç {{ "{:.1f}".format((complex.real_price_from or 0) / 1000000) }} –º–ª–Ω ‚ÇΩ
                    </div>
                    
                    <!-- Favorite heart and comparison buttons -->
                    <div class="absolute bottom-3 left-3 z-20 flex gap-2">
                        <!-- Universal Heart Icon -->
                        <div class="favorite-heart w-10 h-10 bg-white/95 backdrop-blur-sm rounded-full flex items-center justify-center cursor-pointer hover:bg-white transition-all duration-200 shadow-lg hover:shadow-xl" data-complex-id="{{ complex.id }}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" onclick="var icon=this.querySelector('i'); if(icon.classList.contains('text-red-500')){icon.classList.remove('text-red-500');icon.classList.add('text-gray-400');}else{icon.classList.remove('text-gray-400');icon.classList.add('text-red-500');} if(window.favoritesManager){window.favoritesManager.toggleComplexFavorite('{{ complex.id }}',this);} event.stopPropagation();">
                            <i class="fas fa-heart text-lg text-gray-400 hover:text-red-500 transition-colors duration-200"></i>
                        </div>
                        <div class="compare-btn w-10 h-10 bg-white/95 backdrop-blur-sm rounded-full flex items-center justify-center cursor-pointer hover:bg-white hover:scale-110 transition-all duration-200 shadow-lg hover:shadow-xl border border-gray-300 hover:border-blue-300" data-complex-id="{{ complex.id }}" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é" >
                            <i class="fas fa-balance-scale text-gray-600 hover:text-blue-500 transition-colors duration-200"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Complex Info -->
                <div class="p-5">
                    <!-- Title -->
                    <div class="mb-3">
                        <h3 class="text-lg font-bold text-gray-900 mb-1">{{ complex.name }}</h3>
                        {% if complex.developer_id %}
                        <a href="/developer/{{ complex.developer|developer_slug }}" class="text-[#0088CC] hover:text-[#006699] text-sm hover:underline transition-colors">{{ complex.developer }}</a>
                        {% else %}
                        <p class="text-gray-500 text-sm">{{ complex.developer }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Description -->
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ complex.description }}</p>
                    
                    <!-- Location -->
                    <div class="flex items-center text-sm text-gray-600 mb-4">
                        <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                        <span>{{ complex.district }}, {{ complex.location }}</span>
                    </div>
                    
                    <!-- Amenities -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">–î–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">–§–∏—Ç–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä</span>
                        {% if loop.index0 % 2 == 0 %}
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">+2</span>
                        {% else %}
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">+3</span>
                        {% endif %}
                    </div>
                    
                    <!-- Stats grid -->
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div class="flex items-center">
                            <i class="fas fa-building mr-2 text-gray-400"></i>
                            <div>
                                <span class="text-gray-500">–ö–æ—Ä–ø—É—Å–æ–≤</span>
                                <div class="font-medium">{{ complex.buildings_count or 1 }}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-home mr-2 text-gray-400"></i>
                            <div>
                                <span class="text-gray-500">–ö–≤–∞—Ä—Ç–∏—Ä</span>
                                <div class="font-medium">{{ complex.available_apartments or complex.apartments_count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Apartment types with selection -->
                    <div class="border-t border-gray-100 pt-4 mb-4">
                        <div class="text-xs text-gray-500 mb-3">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã</div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            {% if complex.real_room_distribution %}
                                {% for room_type, count in complex.real_room_distribution.items() %}
                                {% set room_detail = complex.room_details.get(room_type, {}) %}
                                <button data-complex-id="{{ complex.id }}" data-room-type="{{ room_type }}" 
                                        class="p-2 border border-gray-200 rounded-lg hover:border-[#0088CC] hover:bg-blue-50 transition-colors text-left">
                                    <div class="font-medium text-gray-800">{{ room_type }}</div>
                                    <div class="text-xs text-gray-500">
                                        {% if room_detail.area_from and room_detail.area_to %}
                                            {% if room_detail.area_from != room_detail.area_to %}
                                                {{ room_detail.area_from }}-{{ room_detail.area_to }} –º¬≤
                                            {% else %}
                                                {{ room_detail.area_from }} –º¬≤
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="text-xs font-medium text-[#0088CC]">
                                        {% if room_detail.price_from and room_detail.price_to %}
                                            –æ—Ç {{ "{:.1f}".format(room_detail.price_from / 1000000) }} –¥–æ {{ "{:.1f}".format(room_detail.price_to / 1000000) }} –º–ª–Ω
                                        {% elif room_detail.price_from %}
                                            –æ—Ç {{ "{:.1f}".format(room_detail.price_from / 1000000) }} –º–ª–Ω
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-green-600">{{ count }} —à—Ç</div>
                                </button>
                                {% endfor %}
                            {% else %}
                                <div class="col-span-2 text-center py-3 text-gray-500 text-sm">
                                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–∞—Ö –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Date, Class and Status -->
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center text-gray-500">
                                <i class="fas fa-calendar mr-2"></i>
                                <span>{{ complex.completion_date or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                            </div>
                            <span class="{% if complex.status == '–°–¥–∞–Ω' %}bg-green-50{% else %}bg-orange-50{% endif %} text-gray-600 px-2 py-1 rounded-full text-xs font-medium">
                                {{ complex.status or '–ù–µ —É–∫–∞–∑–∞–Ω' }}
                            </span>
                        </div>
                        {% if complex.housing_class %}
                        <div class="flex items-center text-gray-500">
                            <i class="fas fa-star mr-2"></i>
                            <span>–ö–ª–∞—Å—Å: {{ complex.housing_class }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- No results message -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">üè¢</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">–ñ–ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
        </div>
        
        <!-- Pagination -->
        {% if pagination and pagination.total_pages > 1 %}
        <div class="flex justify-center mt-12">
            <div class="flex items-center gap-2">
                <!-- Previous Page Button -->
                {% if pagination.has_prev %}
                <a href="{{ url_for('residential_complexes', page=pagination.prev_page) }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </a>
                {% else %}
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </span>
                {% endif %}
                
                <!-- Page Numbers -->
                {% set start_page = [1, pagination.page - 2]|max %}
                {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
                
                {% if start_page > 1 %}
                <a href="{{ url_for('residential_complexes', page=1) }}" 
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">1</a>
                {% if start_page > 2 %}
                <span class="px-2 text-gray-400">...</span>
                {% endif %}
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                <a href="{{ url_for('residential_complexes', page=page_num) }}" 
                   class="px-3 py-2 border rounded-lg text-sm 
                          {% if page_num == pagination.page %}bg-[#0088CC] text-white border-[#0088CC]{% else %}border-gray-300 hover:bg-gray-50{% endif %}">
                    {{ page_num }}
                </a>
                {% endfor %}
                
                {% if end_page < pagination.total_pages %}
                {% if end_page < pagination.total_pages - 1 %}
                <span class="px-2 text-gray-400">...</span>
                {% endif %}
                <a href="{{ url_for('residential_complexes', page=pagination.total_pages) }}" 
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">{{ pagination.total_pages }}</a>
                {% endif %}
                
                <!-- Next Page Button -->
                {% if pagination.has_next %}
                <a href="{{ url_for('residential_complexes', page=pagination.next_page) }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                    –°–ª–µ–¥—É—é—â–∞—è
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </a>
                {% else %}
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 flex items-center gap-2">
                    –°–ª–µ–¥—É—é—â–∞—è
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Results Info -->
        <div class="text-center mt-4 text-sm text-gray-600">
            –ü–æ–∫–∞–∑–∞–Ω–æ {{ (pagination.page - 1) * pagination.per_page + 1 }}‚Äì{{ [pagination.page * pagination.per_page, pagination.total]|min }} 
            –∏–∑ {{ pagination.total }} –ñ–ö
        </div>
        {% endif %}
    </div>
</section>

<!-- Apartments Modal -->
<div id="apartmentsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-[#006699] to-[#0088CC] text-white p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h3 id="modalComplexName" class="text-xl font-bold"></h3>
                    <p id="modalApartmentType" class="text-blue-100"></p>
                </div>
                <button onclick="closeApartmentsModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <!-- Liters Filter -->
            <div class="mb-6">
                <div class="text-sm font-medium text-gray-700 mb-3">–§–∏–ª—å—Ç—Ä –ø–æ –ª–∏—Ç–µ—Ä–∞–º:</div>
                <div id="literFilters" class="flex flex-wrap gap-2">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                </div>
            </div>
            
            <!-- Apartments Grid -->
            <div id="apartmentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
            
            <!-- No Apartments Message -->
            <div id="noApartments" class="hidden text-center py-8 text-gray-500">
                <div class="text-4xl mb-2">üè†</div>
                <p>–í –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏—Ç–µ—Ä–∞—Ö –Ω–µ—Ç –∫–≤–∞—Ä—Ç–∏—Ä –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞</p>
            </div>
        </div>
    </div>
</div>

<script>
// ‚ö° VERSION MARKER: v1761503218
console.log('üî•üî•üî• RESIDENTIAL_COMPLEXES.HTML VERSION: v1761503218 - LOADED! üî•üî•üî•');

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ Flask –≤ JavaScript
window.manager_authenticated = {% if is_manager %}true{% else %}false{% endif %};
window.isManagerAuthenticated = {% if is_manager %}true{% else %}false{% endif %};
window.manager_id = {% if manager_id %}{{ manager_id }}{% else %}null{% endif %};

// ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ñ–ö —Å —Å–µ—Ä–≤–µ—Ä–∞!
let allComplexes = {{ all_complexes|tojson|safe }};
let displayedComplexes = [...allComplexes];
let filteredComplexes = [...allComplexes];

console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ñ–ö —Å —Å–µ—Ä–≤–µ—Ä–∞:', allComplexes.length);
console.log('üìä –ü–µ—Ä–≤—ã–π –ñ–ö:', allComplexes[0]);

// Search functionality
function setupComplexSearch() {
    const searchInput = document.getElementById('complex-search');
    const suggestionsContainer = document.getElementById('complex-searchSuggestions');
    
    // Create search suggestions
    const suggestions = [];
    allComplexes.forEach(complex => {
        suggestions.push(complex.name);
        suggestions.push(complex.developer);
        suggestions.push(complex.district);
        suggestions.push(complex.location);
    });
    
    const uniqueSuggestions = [...new Set(suggestions)].filter(Boolean);
    
    let isInitialLoad = true;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            suggestionsContainer.classList.add('hidden');
            // Auto-apply filters when search is cleared (but not on initial load)
            if (query.length === 0 && !isInitialLoad) {
                applyComplexFilters();
            }
            isInitialLoad = false;
            return;
        }
        
        isInitialLoad = false;
        
        const matchedSuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 6);
        
        if (matchedSuggestions.length > 0) {
            const suggestionHTML = matchedSuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${suggestion.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion.replace(/"/g, '&quot;')}
                </div>`)
                .join('');
            
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.classList.add('hidden');
        }
    });
}

function selectComplexSuggestion(suggestion) {
    document.getElementById('complex-search').value = suggestion;
    document.getElementById('complex-searchSuggestions').classList.add('hidden');
    applyComplexFilters();
}

// Helper function to parse completion dates for sorting
function parseCompletionDate(dateString) {
    if (!dateString) return new Date('2030-12-31'); // Future date for unknown dates
    
    // Handle different date formats
    const str = dateString.toLowerCase().trim();
    
    // Extract year and quarter
    const yearMatch = str.match(/(\d{4})/);
    const quarterMatch = str.match(/(\d)\s*–∫–≤/);
    
    if (yearMatch) {
        const year = parseInt(yearMatch[1]);
        let month = 12; // Default to end of year
        
        if (quarterMatch) {
            const quarter = parseInt(quarterMatch[1]);
            // Convert quarter to month (end of quarter)
            month = quarter * 3;
        }
        
        return new Date(year, month - 1, 1); // month is 0-indexed
    }
    
    // Try to parse as regular date
    const parsed = new Date(dateString);
    return isNaN(parsed.getTime()) ? new Date('2030-12-31') : parsed;
}

// Apply filters (make it globally accessible)
window.applyComplexFilters = function() {
    console.log('üîç applyComplexFilters called, total complexes:', allComplexes.length);
    
    // Start with all complexes, not just displayed ones
    let filtered = [...allComplexes];
    
    // Search filter - check both mobile and desktop inputs
    const desktopSearch = document.getElementById('complex-search');
    const mobileSearch = document.getElementById('complex-search-mobile');
    const searchQuery = (desktopSearch?.value || mobileSearch?.value || '').toLowerCase().trim();
    if (searchQuery) {
        filtered = filtered.filter(complex => {
            return complex.name.toLowerCase().includes(searchQuery) ||
                   complex.developer.toLowerCase().includes(searchQuery) ||
                   complex.district.toLowerCase().includes(searchQuery) ||
                   complex.location.toLowerCase().includes(searchQuery);
        });
    }
    
    // District filter
    const district = document.getElementById('district-filter').value;
    if (district) {
        filtered = filtered.filter(complex => complex.district === district);
    }
    
    // Developer filter
    const developer = document.getElementById('developer-filter').value;
    if (developer) {
        filtered = filtered.filter(complex => complex.developer === developer);
    }
    
    // Status filter - fix to use completion_date
    const status = document.getElementById('status-filter').value;
    if (status) {
        filtered = filtered.filter(complex => {
            if (status === '–°–¥–∞–Ω') {
                return complex.status === '–°–¥–∞–Ω';
            } else if (status === '–°—Ç—Ä–æ–∏—Ç—Å—è') {
                return complex.status !== '–°–¥–∞–Ω';
            }
            return true;
        });
    }
    
    // Object Class filter
    const objectClass = document.getElementById('object-class-filter').value;
    if (objectClass) {
        filtered = filtered.filter(complex => 
            complex.object_class === objectClass || 
            complex.housing_class === objectClass ||
            complex.class === objectClass
        );
    }
    
    // Completion Year filter
    const completionYear = document.getElementById('completion-year-filter').value;
    if (completionYear) {
        filtered = filtered.filter(complex => {
            const year = complex.completion_year || complex.construction_end_year;
            return year && year.toString() === completionYear;
        });
    }
    
    // Floors filter
    const floors = document.getElementById('floors-filter').value;
    if (floors) {
        filtered = filtered.filter(complex => {
            const floorCount = complex.max_floors || complex.floors || complex.floors_count || 0;
            if (floors === 'low') return floorCount >= 1 && floorCount <= 5;
            if (floors === 'medium') return floorCount >= 6 && floorCount <= 10;
            if (floors === 'high') return floorCount > 10;
            return true;
        });
    }
    
    // Rooms filter (checkboxes)
    const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
    if (selectedRooms.length > 0) {
        filtered = filtered.filter(complex => {
            // Check if complex has available_rooms data (format: ["—Å—Ç—É–¥–∏—è", "1-–∫–æ–º–Ω", "2-–∫–æ–º–Ω"])
            if (complex.available_rooms && Array.isArray(complex.available_rooms) && complex.available_rooms.length > 0) {
                // Check if any selected room type is available in this complex
                return complex.available_rooms.some(room => selectedRooms.includes(room));
            }
            // If no room data available, exclude complex when filter is active
            return false;
        });
    }
    
    // Price range filter
    const priceFrom = parseFloat(document.getElementById('price-range-from').value);
    const priceTo = parseFloat(document.getElementById('price-range-to').value);
    if (!isNaN(priceFrom) || !isNaN(priceTo)) {
        filtered = filtered.filter(complex => {
            const price = (complex.real_price_from || complex.price_from || 0) / 1000000;
            let matches = true;
            if (!isNaN(priceFrom)) matches = matches && price >= priceFrom;
            if (!isNaN(priceTo)) matches = matches && price <= priceTo;
            return matches;
        });
    }
    
    // Sort
    const sortType = document.getElementById('sort-select').value;
    switch (sortType) {
        case 'name-asc':
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'name-desc':
            filtered.sort((a, b) => b.name.localeCompare(a.name));
            break;
        case 'price-asc':
            filtered.sort((a, b) => {
                const priceA = a.real_price_from || a.price_from || 0;
                const priceB = b.real_price_from || b.price_from || 0;
                return priceA - priceB;
            });
            break;
        case 'price-desc':
            filtered.sort((a, b) => {
                const priceA = a.real_price_from || a.price_from || 0;
                const priceB = b.real_price_from || b.price_from || 0;
                return priceB - priceA;
            });
            break;
        case 'completion-asc':
            filtered.sort((a, b) => {
                const dateA = parseCompletionDate(a.completion_date);
                const dateB = parseCompletionDate(b.completion_date);
                return dateA - dateB;
            });
            break;
        case 'completion-desc':
            filtered.sort((a, b) => {
                const dateA = parseCompletionDate(a.completion_date);
                const dateB = parseCompletionDate(b.completion_date);
                return dateB - dateA;
            });
            break;
        case 'apartments-desc':
            filtered.sort((a, b) => b.apartments_count - a.apartments_count);
            break;
        case 'apartments-asc':
            filtered.sort((a, b) => a.apartments_count - b.apartments_count);
            break;
    }
    
    console.log('‚úÖ Filtering complete:', filtered.length, 'complexes after filters');
    
    filteredComplexes = filtered;
    updateComplexesList(filtered);
    updateResultsCount(filtered.length);
    
    // Filter sidebar objects by visible map bounds (only if map is loaded)
    if (typeof filterObjectsByMapBounds === 'function') {
        filterObjectsByMapBounds();
    }
};

// Update complexes list display (make it globally accessible)
window.updateComplexesList = function(complexes) {
    console.log('üìã updateComplexesList called with', complexes.length, 'complexes');
    
    const container = document.getElementById('complexes-container');
    const noResults = document.getElementById('no-results');
    
    if (complexes.length === 0) {
        console.warn('‚ö†Ô∏è No complexes to display!');
        // Hide all cards and show no results
        container.querySelectorAll('.complex-card').forEach(card => card.style.display = 'none');
        noResults.classList.remove('hidden');
        return;
    }
    console.log('‚úÖ Displaying', complexes.length, 'complexes');
    
    noResults.classList.add('hidden');
    
    // Get all existing cards and sort them according to filtered list
    const allCards = Array.from(container.querySelectorAll('.complex-card'));
    const complexIds = complexes.map(c => c.id);
    
    // Hide cards not in filtered list
    allCards.forEach(card => {
        const complexId = parseInt(card.getAttribute('data-complex-id'));
        if (complexIds.includes(complexId)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Sort visible cards according to the filtered order
    const visibleCards = allCards.filter(card => {
        const complexId = parseInt(card.getAttribute('data-complex-id'));
        return complexIds.includes(complexId);
    });
    
    // Sort cards by the order in complexes array
    visibleCards.sort((a, b) => {
        const idA = parseInt(a.getAttribute('data-complex-id'));
        const idB = parseInt(b.getAttribute('data-complex-id'));
        const indexA = complexIds.indexOf(idA);
        const indexB = complexIds.indexOf(idB);
        return indexA - indexB;
    });
    
    // Re-append cards in correct order
    visibleCards.forEach(card => {
        container.appendChild(card);
    });
}

// Helper function to create SEO-friendly slug
function createSlug(name) {
    if (!name) return "unknown";
    return name
        .replace(/["\'"]/g, '')  // Remove quotes
        .replace(/[^\w\s-]/g, '') // Remove special chars except spaces and hyphens
        .replace(/[-\s]+/g, '-')  // Replace spaces/multiple hyphens with single hyphen
        .toLowerCase()
        .replace(/^-+|-+$/g, '');  // Trim hyphens
}

// Create HTML for a complex card
function createComplexCardHTML(complex, index) {
    const hasApartments = complex.available_apartments > 0;
    const apartmentText = hasApartments ? 
        `${complex.available_apartments} ${getApartmentWordForm(complex.available_apartments)}` : 
        '–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ';
    
    return `
        <div class="complex-card bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 hover:shadow-xl transition-all duration-300 group" data-complex-id="${complex.id}">
            <!-- Complex Image Slider -->
            <div class="relative h-56 overflow-hidden complex-slider" data-complex-id="${complex.id}">
                <div class="slider-container">
                    <div class="slider-track flex transition-transform duration-300 ease-in-out">
                        <div class="slider-slide min-w-full">
                            <img src="${complex.image}" alt="${complex.name}" class="w-full h-56 object-cover">
                        </div>
                        <div class="slider-slide min-w-full">
                            <img src="${complex.image.replace('photo-1545324418', 'photo-1560448204-e02f11c3d0e2')}" alt="${complex.name} - –≤–∏–¥ 2" class="w-full h-56 object-cover" onerror="this.src='${complex.image}'">
                        </div>
                        <div class="slider-slide min-w-full">
                            <img src="${complex.image.replace('photo-1545324418', 'photo-1484154218962')}" alt="${complex.name} - –≤–∏–¥ 3" class="w-full h-56 object-cover" onerror="this.src='${complex.image}'">
                        </div>
                    </div>
                </div>
                
                <!-- Slider navigation -->
                <button class="slider-prev absolute left-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10" onclick="event.stopPropagation(); prevSlide('${complex.id}')">
                    <i class="fas fa-chevron-left text-sm"></i>
                </button>
                <button class="slider-next absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10" onclick="event.stopPropagation(); nextSlide('${complex.id}')">
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
                
                <!-- Slider dots -->
                <div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="slider-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors active" onclick="event.stopPropagation(); goToSlide('${complex.id}', 0)"></div>
                    <div class="slider-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors" onclick="event.stopPropagation(); goToSlide('${complex.id}', 1)"></div>
                    <div class="slider-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors" onclick="event.stopPropagation(); goToSlide('${complex.id}', 2)"></div>
                </div>
                
                <!-- Status badges -->
                <div class="absolute top-3 left-3 z-10">
                    ${complex.status === '–°–¥–∞–Ω' ? 
                        '<span class="bg-green-50 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">–ì–æ—Ç–æ–≤</span>' : 
                        '<span class="bg-blue-50 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">–°—Ç—Ä–æ–∏—Ç—Å—è</span>'
                    }
                </div>
                
                <!-- Price badge -->
                <div class="absolute top-3 right-3 bg-orange-50 text-gray-600 px-3 py-1 rounded-full text-sm font-bold z-10">
                    –æ—Ç ${((complex.real_price_from || 0) / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ
                </div>
                
                <!-- Favorite heart and comparison buttons -->
                <div class="absolute bottom-3 left-3 z-20 flex gap-2">
                    <div class="favorite-heart w-10 h-10 bg-white/95 backdrop-blur-sm rounded-full flex items-center justify-center cursor-pointer hover:bg-white transition-all duration-200 shadow-lg hover:shadow-xl" data-complex-id="${complex.id}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" onclick="var icon=this.querySelector('i'); if(icon.classList.contains('text-red-500')){icon.classList.remove('text-red-500');icon.classList.add('text-gray-400');}else{icon.classList.remove('text-gray-400');icon.classList.add('text-red-500');} if(window.favoritesManager){window.favoritesManager.toggleComplexFavorite('${complex.id}',this);} event.stopPropagation();">
                        <i class="fas fa-heart text-lg text-gray-400 hover:text-red-500 transition-colors duration-200"></i>
                    </div>
                    <div class="comparison-btn w-10 h-10 bg-white/95 backdrop-blur-sm rounded-full flex items-center justify-center cursor-pointer hover:bg-white hover:scale-110 transition-all duration-200 shadow-lg hover:shadow-xl border border-gray-300 hover:border-blue-300" data-complex-id="${complex.id}" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é" onclick="addToComplexCompare(${complex.id}); event.stopPropagation();">
                        <i class="fas fa-balance-scale text-gray-600 hover:text-blue-500 transition-colors duration-200"></i>
                    </div>
                </div>
            </div>
            
            <!-- Complex Info -->
            <div class="p-5">
                <!-- Title -->
                <div class="mb-3">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">${complex.name}</h3>
                    <p class="text-gray-500 text-sm">${complex.developer || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                </div>
                
                <!-- Description -->
                <p class="text-gray-600 text-sm mb-4 line-clamp-2">${complex.description || complex.address || '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∂–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å'}</p>
                
                <!-- Location -->
                <div class="flex items-center text-sm text-gray-600 mb-4">
                    <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                    <span>${complex.district || '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä'}, ${complex.location || complex.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                </div>
                
                <!-- Amenities -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">–î–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞</span>
                    <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">–§–∏—Ç–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä</span>
                    <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">+2</span>
                </div>
                
                <!-- Stats grid -->
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-building mr-2 text-gray-400"></i>
                        <div>
                            <span class="text-gray-500">–ö–æ—Ä–ø—É—Å–æ–≤</span>
                            <div class="font-medium">${((index || 0) % 3) + 2}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-home mr-2 text-gray-400"></i>
                        <div>
                            <span class="text-gray-500">–ö–≤–∞—Ä—Ç–∏—Ä</span>
                            <div class="font-medium">${complex.apartments_count || complex.available_apartments || 0}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Apartment types with prices -->
                <div class="border-t border-gray-100 pt-4 mb-4">
                    <div class="text-xs text-gray-500 mb-2">–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω</div>
                    <div class="space-y-1 text-sm">
                        ${complex.apartments ? complex.apartments.map(apartment => `
                            <div class="flex justify-between">
                                <span class="text-gray-600">${apartment.type}</span>
                                <span class="font-medium">${(apartment.price_from / 1000000).toFixed(1)} - ${(apartment.price_from * 1.3 / 1000000).toFixed(1)} –º–ª–Ω</span>
                            </div>
                        `).join('') : `
                            <div class="flex justify-between">
                                <span class="text-gray-600">–°—Ç—É–¥–∏—è</span>
                                <span class="font-medium">${((complex.real_price_from || 0) / 1000000).toFixed(1)} - ${((complex.real_price_from || 0) * 1.2 / 1000000).toFixed(1)} –º–ª–Ω</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">1-–∫–æ–º–Ω</span>
                                <span class="font-medium">${((complex.real_price_from || 0) * 1.2 / 1000000).toFixed(1)} - ${((complex.real_price_from || 0) * 1.5 / 1000000).toFixed(1)} –º–ª–Ω</span>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Date and Class -->
                <div class="space-y-2 text-sm text-gray-500 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-calendar mr-2"></i>
                        <span>${complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                    </div>
                    ${complex.housing_class ? `
                    <div class="flex items-center">
                        <i class="fas fa-star mr-2 text-yellow-500"></i>
                        <span>–ö–ª–∞—Å—Å: ${complex.housing_class}</span>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Action buttons -->
                <div class="flex gap-2">
                    <!-- Recommendation button (only for managers) -->
                    ${window.isManagerAuthenticated ? `
                    <button onclick="openRecommendModal('complex', ${complex.id}, '${complex.name}')" 
                            class="recommend-btn flex-1 px-4 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-colors" 
                            data-item-type="complex"
                            data-item-id="${complex.id}"
                            data-item-name="${complex.name}"
                            title="–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ñ–ö –∫–ª–∏–µ–Ω—Ç—É">
                        <i class="fas fa-paper-plane mr-2"></i>
                        –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Helper function to get proper word form for apartments count
function getApartmentWordForm(count) {
    if (count % 10 === 1 && count % 100 !== 11) {
        return '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
    } else if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) {
        return '–∫–≤–∞—Ä—Ç–∏—Ä—ã';
    } else {
        return '–∫–≤–∞—Ä—Ç–∏—Ä';
    }
}

// Initialize event listeners for complex cards
function initializeComplexCardListeners() {
    // Re-initialize sliders and other functionality
    setTimeout(() => {
        initAllSliders();
        if (typeof favoritesManager !== 'undefined') {
            favoritesManager.updateFavoritesUI();
            favoritesManager.updateComplexFavoritesUI();
            favoritesManager.updateFavoritesCounter();
        }
        if (typeof updateComplexCompareButtons === 'function') {
            updateComplexCompareButtons();
        }
    }, 100);
}

// Update results count
function updateResultsCount(count) {
    const countElement = document.getElementById('results-count');
    if (countElement) {
        countElement.textContent = count.toLocaleString('ru-RU');
    }
}

// Toggle filters panel
function toggleFilters() {
    const panel = document.getElementById('filtersPanel');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        // On mobile, add fullscreen class and lock body scroll
        if (window.innerWidth < 768) {
            panel.classList.add('mobile-fullscreen');
            document.body.style.overflow = 'hidden';
        }
    } else {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
}

function searchComplexes() {
    applyComplexFilters();
}

// Map functionality
let complexesMap;
let complexMarkers = [];
let isMapView = false;

function toggleMapView() {
    const mapSection = document.getElementById('mapSection');
    const gridSection = document.getElementById('gridSection');
    
    if (isMapView) {
        // Switch to grid view
        mapSection.classList.add('hidden');
        gridSection.classList.remove('hidden');
        isMapView = false;
    } else {
        // Switch to map view
        mapSection.classList.remove('hidden');
        gridSection.classList.add('hidden');
        isMapView = true;
        
        // Initialize map if not already initialized
        if (!complexesMap) {
            initializeComplexesMap();
        }
    }
}

function initializeComplexesMap() {
    // Initialize Leaflet map centered on Krasnodar
    complexesMap = L.map('complexesMap').setView([45.0355, 38.9753], 11);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(complexesMap);
    
    // Add markers for all complexes with coordinates
    const complexesWithCoords = allComplexes.filter(c => c.coordinates);
    addComplexMarkersToMap(complexesWithCoords);
    updateMapSidebar(complexesWithCoords);
    
    // Add zoom event listener to update markers
    complexesMap.on('zoomend', function() {
        addComplexMarkersToMap(complexesWithCoords);
        // Only filter by bounds if no polygon is drawn
        if (!drawnComplexPolygon) {
            filterObjectsByMapBounds();
        } else {
            filterComplexesByPolygon();
        }
    });
    
    // Add move end handler to filter objects by visible area
    complexesMap.on('moveend', function() {
        // Only filter by bounds if no polygon is drawn
        if (!drawnComplexPolygon) {
            filterObjectsByMapBounds();
        } else {
            filterComplexesByPolygon();
        }
    });
    
    // Set up drawing buttons
    document.getElementById('drawComplexAreaBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (!isComplexDrawing) {
            enableComplexDrawing();
        }
    });
    
    document.getElementById('clearComplexAreaBtn').addEventListener('click', function(e) {
        e.preventDefault();
        clearComplexDrawnArea();
    });
}

function addComplexMarkersToMap(complexes) {
    // Clear existing markers
    complexMarkers.forEach(marker => complexesMap.removeLayer(marker));
    complexMarkers = [];
    
    complexes.forEach(complex => {
        if (complex.coordinates && complex.coordinates.length === 2) {
            const [lat, lng] = complex.coordinates;
            
            // Get current zoom level to determine marker style
            const zoom = complexesMap.getZoom();
            let markerHtml;
            
            if (zoom < 13) {
                // Simple dot marker for distant view
                markerHtml = `
                    <div class="w-3 h-3 bg-gradient-to-r from-[#006699] to-[#0088CC] rounded-full border-2 border-white shadow-lg"></div>
                `;
            } else {
                // Detailed marker for close view
                markerHtml = `
                    <div class="bg-gradient-to-r from-[#006699] to-[#0088CC] text-white px-2 py-1 rounded-lg shadow-lg border border-white">
                        <div class="text-center text-xs font-medium whitespace-nowrap">
                            <div class="font-bold">${complex.apartments_count} –∫–≤.</div>
                            <div class="opacity-90">${complex.name.slice(3, 10)}...</div>
                        </div>
                    </div>
                `;
            }
            
            const iconSize = complexesMap.getZoom() < 13 ? [12, 12] : [70, 30];
            const iconAnchor = complexesMap.getZoom() < 13 ? [6, 6] : [35, 30];
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: markerHtml,
                    className: 'custom-complex-marker',
                    iconSize: iconSize,
                    iconAnchor: iconAnchor
                })
            }).addTo(complexesMap);
            
            // Add popup with complex info (improved design)
            const popupContent = `
                <div class="w-80 bg-white rounded-lg overflow-hidden">
                    <div class="relative h-40">
                        <img src="${complex.image}" alt="${complex.name}" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 bg-orange-50 text-gray-600 px-2 py-1 rounded-full text-xs font-bold">
                            –æ—Ç ${((complex.real_price_from || 0) / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ
                        </div>
                        <div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                            –ö—ç—à–±—ç–∫ ${complex.cashback_percent}%
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-900 text-lg mb-1">${complex.name}</h3>
                        <p class="text-[#0088CC] text-sm mb-2 font-medium">${complex.developer}</p>
                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                            <span>${complex.district}, ${complex.location}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-home mr-2 text-gray-400"></i>
                                <div>
                                    <span class="text-gray-500">–ö–≤–∞—Ä—Ç–∏—Ä</span>
                                    <div class="font-medium">${complex.apartments_count}</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-calendar mr-2 text-gray-400"></i>
                                <div>
                                    <span class="text-gray-500">–°–¥–∞—á–∞</span>
                                    <div class="font-medium ${complex.status === '–°–¥–∞–Ω' ? 'text-green-600' : 'text-[#0088CC]'}">${complex.completion_date}</div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-3 border-t border-gray-100">
                            <button class="w-full bg-gradient-to-r from-[#006699] to-[#0088CC] text-white py-2 px-4 rounded-lg font-medium hover:opacity-90 transition">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ñ–ö
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                maxWidth: 320,
                className: 'custom-complex-popup',
                closeButton: true,
                autoPan: true
            });
            
            complexMarkers.push(marker);
        }
    });
}

function searchComplexesOnMap() {
    const searchQuery = document.getElementById('map-search').value.toLowerCase().trim();
    let filteredComplexes = [...allComplexes.filter(c => c.coordinates)];
    
    if (searchQuery) {
        filteredComplexes = filteredComplexes.filter(complex => {
            return complex.name.toLowerCase().includes(searchQuery) ||
                   complex.developer.toLowerCase().includes(searchQuery) ||
                   complex.district.toLowerCase().includes(searchQuery) ||
                   complex.location.toLowerCase().includes(searchQuery);
        });
    }
    
    // Update markers on map
    addComplexMarkersToMap(filteredComplexes);
    
    // Update sidebar with complex cards
    updateMapSidebar(filteredComplexes);
    
    // Fit map to show all results
    if (filteredComplexes.length > 1 && complexMarkers.length > 1) {
        const group = new L.featureGroup(complexMarkers);
        complexesMap.fitBounds(group.getBounds().pad(0.1));
    } else if (filteredComplexes.length === 1 && filteredComplexes[0].coordinates) {
        complexesMap.setView(filteredComplexes[0].coordinates, 15);
    }
}

function updateMapSidebar(complexes) {
    const complexesList = document.getElementById('mapComplexesList');
    const resultsCount = document.getElementById('mapResultsCount');
    
    resultsCount.textContent = `–ù–∞–π–¥–µ–Ω–æ ${complexes.length} –∫–æ–º–ø–ª–µ–∫—Å–æ–≤`;
    
    if (complexes.length > 0) {
        const complexesHtml = complexes.map(complex => `
            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors" onclick="focusOnComplex([${complex.coordinates}])">
                <div class="flex space-x-3">
                    <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${complex.image}" alt="${complex.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-gray-900 text-sm mb-1 truncate">${complex.name}</h4>
                        <p class="text-xs text-gray-600 mb-2">${complex.developer}</p>
                        <div class="flex items-center text-xs text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                            <span class="truncate">${complex.district}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-[#0088CC] font-bold text-sm">–æ—Ç ${((complex.real_price_from || 0) / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ</span>
                                <span class="text-xs text-gray-500">${complex.apartments_count} –∫–≤–∞—Ä—Ç–∏—Ä</span>
                            </div>
                            <div class="text-right">
                                <span class="text-green-600 font-medium text-xs">–∫—ç—à–±—ç–∫ ${complex.cashback_percent}%</span>
                                <div class="text-xs ${complex.status === '–°–¥–∞–Ω' ? 'text-green-600' : 'text-[#0088CC]'}">${complex.completion_date}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        complexesList.innerHTML = complexesHtml;
    } else {
        complexesList.innerHTML = '<div class="p-4 text-center text-gray-500">–ñ–ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    }
}

function focusOnComplex(coordinates) {
    if (coordinates && coordinates.length === 2) {
        complexesMap.setView(coordinates, 16);
    }
}

// Filter objects by visible map bounds
function filterObjectsByMapBounds() {
    if (!complexesMap || !isMapView) {
        return;
    }
    
    try {
        const bounds = complexesMap.getBounds();
        const visibleComplexes = filteredComplexes.filter(complex => {
            if (!complex.coordinates || complex.coordinates.length !== 2) {
                return false;
            }
            const [lat, lng] = complex.coordinates;
            return bounds.contains([lat, lng]);
        });
        
        updateMapSidebar(visibleComplexes);
        console.log(`Filtered to ${visibleComplexes.length} complexes in map bounds`);
    } catch(e) {
        console.warn('Error filtering objects by map bounds:', e);
    }
}

// Drawing functionality for complexes
let isComplexDrawing = false;
let drawnComplexPolygon = null;
let complexDrawingHandler = null;

function enableComplexDrawing() {
    if (!complexesMap) return;
    
    isComplexDrawing = true;
    const btn = document.getElementById('drawComplexAreaBtn');
    btn.classList.add('bg-orange-500', 'text-white', 'shadow-xl');
    btn.classList.remove('text-gray-700', 'hover:text-[#0088CC]');
    btn.innerHTML = '<i class="fas fa-hand-paper mr-2"></i>–ö–ª–∏–∫–Ω–∏—Ç–µ —Ç–æ—á–∫–∏. –°–æ–µ–¥–∏–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–π';
    
    complexesMap.getContainer().style.cursor = 'crosshair';
    
    // Create temporary polygon for drawing
    const drawingPoints = [];
    const drawingMarkers = [];
    let tempPolygon = null;
    let previewLine = null;
    
    complexDrawingHandler = {
        click: function(e) {
            const clickPoint = [e.latlng.lat, e.latlng.lng];
            
            // Check if clicking on first point to close polygon (if we have at least 3 points)
            if (drawingPoints.length >= 3) {
                const firstPoint = drawingPoints[0];
                const distance = Math.sqrt(
                    Math.pow(e.latlng.lat - firstPoint[0], 2) + 
                    Math.pow(e.latlng.lng - firstPoint[1], 2)
                );
                
                // If clicking close to first point (within reasonable distance), close polygon
                if (distance < 0.005) { // ~500m threshold
                    finishComplexDrawing(drawingPoints, drawingMarkers, tempPolygon, previewLine);
                    return;
                }
            }
            
            drawingPoints.push(clickPoint);
            
            // Add visible point marker with special styling for first point
            const isFirstPoint = drawingPoints.length === 1;
            const pointMarker = L.circleMarker([e.latlng.lat, e.latlng.lng], {
                color: isFirstPoint ? '#00aa44' : '#ff6b35',
                fillColor: isFirstPoint ? '#00aa44' : '#ff6b35',
                fillOpacity: 1,
                radius: isFirstPoint ? 8 : 6,
                weight: isFirstPoint ? 3 : 2
            }).addTo(complexesMap);
            
            // Add tooltip for first point
            if (isFirstPoint) {
                pointMarker.bindTooltip('–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞<br>–ö–ª–∏–∫–Ω–∏—Ç–µ —Å—é–¥–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', {
                    permanent: false,
                    direction: 'top'
                });
            }
            
            drawingMarkers.push(pointMarker);
            
            // Update temporary polygon
            if (tempPolygon) {
                complexesMap.removeLayer(tempPolygon);
            }
            
            if (drawingPoints.length >= 3) {
                // Show polygon preview but don't auto-complete
                tempPolygon = L.polygon(drawingPoints, {
                    color: '#ff6b35',
                    fillColor: '#ff6b35',
                    fillOpacity: 0.2,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(complexesMap);
            } else if (drawingPoints.length === 2) {
                // Show line between first two points
                tempPolygon = L.polyline(drawingPoints, {
                    color: '#ff6b35',
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(complexesMap);
            }
        },
        dblclick: function(e) {
            // Prevent default double-click behavior
            e.originalEvent.preventDefault();
            // Double-click only finishes if we have enough points, but doesn't auto-complete
            if (drawingPoints.length >= 3) {
                finishComplexDrawing(drawingPoints, drawingMarkers, tempPolygon, previewLine);
            }
        },
        mousemove: function(e) {
            if (drawingPoints.length > 0) {
                // Remove previous preview line
                if (previewLine) {
                    complexesMap.removeLayer(previewLine);
                }
                
                const lastPoint = drawingPoints[drawingPoints.length - 1];
                const currentPoint = [e.latlng.lat, e.latlng.lng];
                
                // If we have 3+ points, check if cursor is near first point
                if (drawingPoints.length >= 3) {
                    const firstPoint = drawingPoints[0];
                    const distanceToFirst = Math.sqrt(
                        Math.pow(e.latlng.lat - firstPoint[0], 2) + 
                        Math.pow(e.latlng.lng - firstPoint[1], 2)
                    );
                    
                    // If close to first point, show preview to close polygon
                    if (distanceToFirst < 0.005) {
                        previewLine = L.polyline([lastPoint, firstPoint], {
                            color: '#00aa44',
                            weight: 3,
                            dashArray: '8, 8',
                            opacity: 0.8
                        }).addTo(complexesMap);
                        
                        // Change cursor style
                        complexesMap.getContainer().style.cursor = 'pointer';
                        return;
                    }
                }
                
                // Default preview line to cursor
                previewLine = L.polyline([lastPoint, currentPoint], {
                    color: '#ff6b35',
                    weight: 2,
                    dashArray: '8, 8',
                    opacity: 0.7
                }).addTo(complexesMap);
                
                // Reset cursor
                complexesMap.getContainer().style.cursor = 'crosshair';
            }
        }
    };
    
    complexesMap.on('click', complexDrawingHandler.click);
    complexesMap.on('dblclick', complexDrawingHandler.dblclick);
    complexesMap.on('mousemove', complexDrawingHandler.mousemove);
}

function finishComplexDrawing(points, markers, tempPoly, previewLine) {
    if (!complexesMap || points.length < 3) return;
    
    // Remove temporary polygon, markers and preview line
    if (tempPoly) {
        complexesMap.removeLayer(tempPoly);
    }
    if (previewLine) {
        complexesMap.removeLayer(previewLine);
    }
    markers.forEach(marker => complexesMap.removeLayer(marker));
    
    // Remove event handlers
    complexesMap.off('click', complexDrawingHandler.click);
    complexesMap.off('dblclick', complexDrawingHandler.dblclick);
    complexesMap.off('mousemove', complexDrawingHandler.mousemove);
    
    // Create final polygon
    if (drawnComplexPolygon) {
        complexesMap.removeLayer(drawnComplexPolygon);
    }
    
    drawnComplexPolygon = L.polygon(points, {
        color: '#ff6b35',
        fillColor: '#ff6b35',
        fillOpacity: 0.15,
        weight: 3
    }).addTo(complexesMap);
    
    // Reset drawing state
    isComplexDrawing = false;
    complexesMap.getContainer().style.cursor = '';
    
    // Update buttons
    const btn = document.getElementById('drawComplexAreaBtn');
    btn.classList.remove('bg-orange-500', 'text-white', 'shadow-xl');
    btn.classList.add('text-gray-700', 'hover:text-[#0088CC]');
    btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>–í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å';
    document.getElementById('clearComplexAreaBtn').classList.remove('hidden');
    
    // Filter complexes by drawn polygon
    filterComplexesByPolygon();
    
    console.log('Complex drawing completed with', points.length, 'points');
}

function clearComplexDrawnArea() {
    if (drawnComplexPolygon) {
        complexesMap.removeLayer(drawnComplexPolygon);
        drawnComplexPolygon = null;
    }
    
    // Hide clear button
    document.getElementById('clearComplexAreaBtn').classList.add('hidden');
    
    // Reset filters and show all complexes
    filterObjectsByMapBounds();
    
    console.log('Complex drawn area cleared');
}

function filterComplexesByPolygon() {
    if (!drawnComplexPolygon || !filteredComplexes) return;
    
    try {
        const polygonBounds = drawnComplexPolygon.getBounds();
        const complexesInPolygon = filteredComplexes.filter(complex => {
            if (!complex.coordinates || complex.coordinates.length !== 2) {
                return false;
            }
            
            const [lat, lng] = complex.coordinates;
            const point = L.latLng(lat, lng);
            return polygonBounds.contains(point);
        });
        
        // Update sidebar with only complexes in polygon
        updateMapSidebar(complexesInPolygon);
        
        console.log(`Filtered to ${complexesInPolygon.length} complexes in drawn polygon`);
    } catch(e) {
        console.warn('Error filtering complexes by polygon:', e);
    }
}

// Slider functionality
let sliders = {};

function nextSlide(complexId) {
    if (!sliders[complexId]) initSlider(complexId);
    const slider = sliders[complexId];
    slider.currentSlide = (slider.currentSlide + 1) % slider.totalSlides;
    updateSlider(complexId);
}

function prevSlide(complexId) {
    if (!sliders[complexId]) initSlider(complexId);
    const slider = sliders[complexId];
    slider.currentSlide = (slider.currentSlide - 1 + slider.totalSlides) % slider.totalSlides;
    updateSlider(complexId);
}

function goToSlide(complexId, slideIndex) {
    if (!sliders[complexId]) initSlider(complexId);
    sliders[complexId].currentSlide = slideIndex;
    updateSlider(complexId);
}

// Make slider functions globally available for inline handlers
window.nextSlide = nextSlide;
window.prevSlide = prevSlide;
window.goToSlide = goToSlide;

function initSlider(complexId) {
    console.log(`üé¨ Initializing slider for complex ${complexId}`);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä - –∏—â–µ–º –≤–Ω—É—Ç—Ä–∏ .complex-slider
    const sliderContainer = document.querySelector(`.complex-slider[data-complex-id="${complexId}"]`);
    if (!sliderContainer) {
        console.error(`‚ùå Slider container not found for complex ${complexId}`);
        return;
    }
    
    const slides = sliderContainer.querySelectorAll('.slider-slide');
    console.log(`üì∏ Found ${slides.length} slides for complex ${complexId}`);
    
    sliders[complexId] = {
        currentSlide: 0,
        totalSlides: slides.length
    };
}

function updateSlider(complexId) {
    console.log(`üîÑ Updating slider for complex ${complexId}`);
    const slider = sliders[complexId];
    if (!slider) {
        console.error(`‚ùå Slider data not found for complex ${complexId}`);
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä
    const sliderContainer = document.querySelector(`.complex-slider[data-complex-id="${complexId}"]`);
    if (!sliderContainer) {
        console.error(`‚ùå Slider container not found for complex ${complexId}`);
        return;
    }
    
    const sliderElement = sliderContainer.querySelector('.slider-track');
    const dots = sliderContainer.querySelectorAll('.slider-dot');
    
    if (sliderElement) {
        sliderElement.style.transform = `translateX(-${slider.currentSlide * 100}%)`;
        console.log(`‚úÖ Moved to slide ${slider.currentSlide} for complex ${complexId}`);
    } else {
        console.error(`‚ùå Slider track not found for complex ${complexId}`);
    }
    
    // Update dots
    dots.forEach((dot, index) => {
        if (index === slider.currentSlide) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}

// Initialize sliders for existing cards
function initAllSliders() {
    console.log('üöÄ initAllSliders() called');
    const sliderElements = document.querySelectorAll('.complex-slider');
    console.log(`üîç Found ${sliderElements.length} slider elements with class .complex-slider`);
    
    sliderElements.forEach((slider, index) => {
        const complexId = slider.getAttribute('data-complex-id');
        console.log(`  Slider ${index + 1}: complexId="${complexId}", already initialized: ${!!sliders[complexId]}`);
        if (complexId && !sliders[complexId]) {
            initSlider(complexId);
        }
    });
    
    console.log(`‚úÖ initAllSliders() completed. Total sliders object:`, sliders);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupComplexSearch();
    
    // Sync search fields between mobile and desktop
    const complexSearchDesktop = document.getElementById('complex-search');
    const complexSearchMobile = document.getElementById('complex-search-mobile');
    
    if (complexSearchDesktop && complexSearchMobile) {
        complexSearchDesktop.addEventListener('input', function() {
            complexSearchMobile.value = this.value;
            applyComplexFilters();
        });
        
        complexSearchMobile.addEventListener('input', function() {
            complexSearchDesktop.value = this.value;
            applyComplexFilters();
        });
    }
    
    // Set up filter event listeners - auto-apply filters on any change
    document.getElementById('district-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('developer-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('status-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('sort-select')?.addEventListener('change', applyComplexFilters);
    
    // Add event listeners for new filters
    document.getElementById('object-class-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('completion-year-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('floors-filter')?.addEventListener('change', applyComplexFilters);
    document.getElementById('price-range-from')?.addEventListener('input', applyComplexFilters);
    document.getElementById('price-range-to')?.addEventListener('input', applyComplexFilters);
    
    // Setup global variables for filtering but DON'T apply filters initially
    // Variables already initialized above
    
    // DON'T apply filters on initial load - use server-rendered HTML
    // applyComplexFilters(); // Apply initial filters
    
    // Initialize sliders and favorites
    console.log('üö® DOMContentLoaded: About to call initAllSliders() in 100ms');
    setTimeout(() => {
        console.log('‚è∞ setTimeout fired! Calling initAllSliders() now...');
        initAllSliders();
        if (typeof favoritesManager !== 'undefined') {
            favoritesManager.updateFavoritesUI();
            favoritesManager.updateComplexFavoritesUI();
            favoritesManager.updateFavoritesCounter();
        }
    }, 100);
});

// Apartments Modal Functions
let currentComplexData = null;
let currentApartmentType = null;
let selectedLiters = [];

function showApartments(complexId, apartmentType) {
    // Find complex data
    currentComplexData = allComplexes.find(c => c.id === complexId);
    currentApartmentType = apartmentType;
    
    if (!currentComplexData || !currentComplexData.apartment_types) {
        alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–∞—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        return;
    }
    
    // Find apartment type data
    const typeData = currentComplexData.apartment_types.find(t => t.type === apartmentType);
    if (!typeData) {
        alert('–î–∞–Ω–Ω—ã–π —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // Update modal header
    document.getElementById('modalComplexName').textContent = currentComplexData.name;
    document.getElementById('modalApartmentType').textContent = `${apartmentType} ‚Ä¢ ${typeData.area_from}-${typeData.area_to} –º¬≤ ‚Ä¢ –æ—Ç ${(typeData.price_from / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ`;
    
    // Show modal
    document.getElementById('apartmentsModal').classList.remove('hidden');
    
    // Initialize filters and apartments
    initializeLiterFilters();
    updateApartmentsDisplay();
    
    // Prevent body scroll using our system
    if (typeof window.lockBodyScroll === 'function') {
        window.lockBodyScroll();
    }
}

function closeApartmentsModal() {
    document.getElementById('apartmentsModal').classList.add('hidden');
    // Restore scroll using our system
    if (typeof window.unlockBodyScroll === 'function') {
        window.unlockBodyScroll();
    }
    currentComplexData = null;
    currentApartmentType = null;
    selectedLiters = [];
}

function initializeLiterFilters() {
    const filtersContainer = document.getElementById('literFilters');
    
    if (!currentComplexData.liters) {
        filtersContainer.innerHTML = '<div class="text-gray-500 text-sm">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏—Ç–µ—Ä–∞—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>';
        return;
    }
    
    // Get all available liters for current apartment type
    const typeData = currentComplexData.apartment_types.find(t => t.type === currentApartmentType);
    const availableLifters = [];
    
    typeData.layouts.forEach(layout => {
        layout.available_liters.forEach(liter => {
            if (!availableLifters.includes(liter)) {
                availableLifters.push(liter);
            }
        });
    });
    
    // Create filter buttons
    let filtersHTML = `
        <button onclick="toggleLiterFilter('all')" 
                class="liter-filter px-3 py-2 border rounded-lg text-sm transition-colors bg-[#0088CC] text-white border-[#0088CC]" 
                data-liter="all">
            –í—Å–µ –ª–∏—Ç–µ—Ä—ã
        </button>
    `;
    
    availableLifters.forEach(liter => {
        const literData = currentComplexData.liters.find(l => l.id === liter);
        const literName = literData ? literData.name : `–õ–∏—Ç–µ—Ä ${liter}`;
        
        filtersHTML += `
            <button onclick="toggleLiterFilter('${liter}')" 
                    class="liter-filter px-3 py-2 border border-gray-300 rounded-lg text-sm hover:border-[#0088CC] hover:bg-blue-50 transition-colors" 
                    data-liter="${liter}">
                ${literName}
            </button>
        `;
    });
    
    filtersContainer.innerHTML = filtersHTML;
    selectedLiters = ['all'];
}

function toggleLiterFilter(liter) {
    if (liter === 'all') {
        selectedLiters = ['all'];
    } else {
        if (selectedLiters.includes('all')) {
            selectedLiters = [liter];
        } else {
            const index = selectedLiters.indexOf(liter);
            if (index > -1) {
                selectedLiters.splice(index, 1);
                if (selectedLiters.length === 0) {
                    selectedLiters = ['all'];
                }
            } else {
                selectedLiters.push(liter);
            }
        }
    }
    
    // Update button states
    document.querySelectorAll('.liter-filter').forEach(btn => {
        const btnLiter = btn.getAttribute('data-liter');
        if (selectedLiters.includes(btnLiter)) {
            btn.className = 'liter-filter px-3 py-2 border rounded-lg text-sm transition-colors bg-[#0088CC] text-white border-[#0088CC]';
        } else {
            btn.className = 'liter-filter px-3 py-2 border border-gray-300 rounded-lg text-sm hover:border-[#0088CC] hover:bg-blue-50 transition-colors';
        }
    });
    
    updateApartmentsDisplay();
}

function updateApartmentsDisplay() {
    const apartmentsGrid = document.getElementById('apartmentsGrid');
    const noApartments = document.getElementById('noApartments');
    
    const typeData = currentComplexData.apartment_types.find(t => t.type === currentApartmentType);
    if (!typeData) return;
    
    // Filter layouts based on selected liters
    let filteredLayouts = typeData.layouts;
    if (!selectedLiters.includes('all')) {
        filteredLayouts = typeData.layouts.filter(layout => 
            layout.available_liters.some(liter => selectedLiters.includes(liter))
        );
    }
    
    if (filteredLayouts.length === 0) {
        apartmentsGrid.innerHTML = '';
        noApartments.classList.remove('hidden');
        return;
    }
    
    noApartments.classList.add('hidden');
    
    // Generate apartments grid
    let apartmentsHTML = '';
    filteredLayouts.forEach((layout, index) => {
        const availableInSelectedLiters = selectedLiters.includes('all') 
            ? layout.available_liters 
            : layout.available_liters.filter(liter => selectedLiters.includes(liter));
            
        const cashback = layout.price * 0.05;
        
        apartmentsHTML += `
            <div class="border border-gray-200 rounded-lg p-4 hover:border-[#0088CC] hover:shadow-md transition-all">
                <!-- Area and Price -->
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="text-lg font-bold text-gray-900">${layout.area} –º¬≤</div>
                        <div class="text-sm text-gray-500">${layout.floor_range} —ç—Ç–∞–∂</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-[#0088CC]">${(layout.price / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ</div>
                        <div class="text-xs text-gray-500">${Math.round(layout.price / layout.area).toLocaleString()} ‚ÇΩ/–º¬≤</div>
                    </div>
                </div>
                
                <!-- Available Liters -->
                <div class="mb-3">
                    <div class="text-xs text-gray-500 mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –≤ –ª–∏—Ç–µ—Ä–∞—Ö:</div>
                    <div class="flex flex-wrap gap-1">
                        ${availableInSelectedLiters.map(liter => {
                            const literData = currentComplexData.liters.find(l => l.id === liter);
                            const literName = literData ? literData.name : `–õ–∏—Ç–µ—Ä ${liter}`;
                            return `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${literName}</span>`;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Cashback -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-2 mb-3">
                    <div class="text-xs text-orange-700 font-medium">–ö—ç—à–±–µ–∫ ${currentComplexData.cashback_percent}%</div>
                    <div class="text-sm font-bold text-orange-800">${Math.round(cashback).toLocaleString()} ‚ÇΩ</div>
                </div>
                
                <!-- Availability -->
                <div class="flex justify-between items-center mb-3">
                    <div class="text-xs text-gray-500">–î–æ—Å—Ç—É–ø–Ω–æ –∫–≤–∞—Ä—Ç–∏—Ä:</div>
                    <div class="text-sm font-medium text-green-600">${layout.available_count} —à—Ç</div>
                </div>
                
                <!-- Action Button -->
                <button onclick="selectApartment(${index})" 
                        class="w-full bg-[#0088CC] text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-[#006699] transition-colors">
                    –í—ã–±—Ä–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É
                </button>
            </div>
        `;
    });
    
    apartmentsGrid.innerHTML = apartmentsHTML;
}

function selectApartment(layoutIndex) {
    const typeData = currentComplexData.apartment_types.find(t => t.type === currentApartmentType);
    const layout = typeData.layouts[layoutIndex];
    
    // Here you can add logic to handle apartment selection
    // For now, just show an alert
    alert(`–í—ã–±—Ä–∞–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞:\n${currentApartmentType}, ${layout.area} –º¬≤\n–¶–µ–Ω–∞: ${(layout.price / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ\n–≠—Ç–∞–∂–∏: ${layout.floor_range}\n–ö—ç—à–±–µ–∫: ${Math.round(layout.price * 0.05).toLocaleString()} ‚ÇΩ`);
    
    // You could redirect to a detailed apartment page or open a contact form
    // window.location.href = `/apartment/${currentComplexData.id}/${layoutIndex}`;
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.id === 'apartmentsModal') {
        closeApartmentsModal();
    }
});

// Authentication status for manager features (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

console.log('Manager authenticated for complex recommendations:', window.isManagerAuthenticated);

// Initialize recommendation system for complexes
document.addEventListener('DOMContentLoaded', function() {
    if (window.isManagerAuthenticated) {
        console.log('Initializing complex recommendation buttons');
        initComplexRecommendationButtons();
    }
});

function initComplexRecommendationButtons() {
    // Count existing complex recommendation buttons
    const complexButtons = document.querySelectorAll('.recommend-btn[data-item-type="complex"]');
    console.log('Complex recommendation buttons initialized for', complexButtons.length, 'complexes');
}

// Recommendation modal functions (shared with properties.html)
function openRecommendModal(itemType, itemId, itemName) {
    // Check if modal already exists
    let modal = document.getElementById('recommendModal');
    if (!modal) {
        modal = createRecommendModal();
    }
    
    // Fill form with item data
    document.getElementById('recommendType').value = itemType;
    document.getElementById('recommendItemId').value = itemId;
    document.getElementById('recommendItemName').value = itemName;
    
    // Set default title based on type
    const titleInput = document.getElementById('recommendTitle');
    if (itemType === 'complex') {
        titleInput.value = `–†–µ–∫–æ–º–µ–Ω–¥—É—é –ñ–ö "${itemName}"`;
    } else {
        titleInput.value = `–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—ä–µ–∫—Ç "${itemName}"`;
    }
    
    // Show modal
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Load clients list
    loadClientsForRecommendation();
}

function createRecommendModal() {
    const modal = document.createElement('div');
    modal.id = 'recommendModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center';
    
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é</h3>
                <button onclick="closeRecommendModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="recommendForm" class="space-y-4">
                <input type="hidden" id="recommendType" value="">
                <input type="hidden" id="recommendItemId" value="">
                <input type="hidden" id="recommendItemName" value="">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ *</label>
                    <select id="recommendClientSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500" required>
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="email" id="recommendClientEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100" readonly>
                </div>
                
                <div id="categorySection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</label>
                    <div class="space-y-2">
                        <select id="recommendCategorySelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500">
                            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <option value="new">+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                        <div id="newCategoryInput" class="hidden">
                            <input type="text" id="recommendCategoryName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ñ–ö —Å –¥–µ—Ç—Å–∫–∏–º–∏ —Å–∞–¥–∞–º–∏, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ *</label>
                    <input type="text" id="recommendTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="recommendDescription" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500" placeholder="–ü–æ—á–µ–º—É —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç—É..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–º–µ—Ç–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</label>
                    <textarea id="recommendNotes" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500" placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="recommendPriority" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500">
                        <option value="medium">–û–±—ã—á–Ω—ã–π</option>
                        <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                        <option value="low">–ù–∏–∑–∫–∏–π</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" id="submitRecommendBtn" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2" id="submitIcon"></i>
                        <span class="loading-spinner hidden mr-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span id="submitText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é</span>
                    </button>
                    <button type="button" onclick="closeRecommendModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('recommendForm').addEventListener('submit', handleRecommendSubmit);
    
    return modal;
}

// Load clients for recommendation dropdown
async function loadClientsForRecommendation() {
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('recommendClientSelect');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞...</option>';
        
        if (data.success && data.clients) {
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.full_name} (${client.email})`;
                option.dataset.email = client.email;
                select.appendChild(option);
            });
            
            // Add change handler
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const emailInput = document.getElementById('recommendClientEmail');
                const categorySection = document.getElementById('categorySection');
                
                if (selectedOption.dataset.email) {
                    emailInput.value = selectedOption.dataset.email;
                    categorySection.classList.remove('hidden');
                    loadRecommendationCategories(this.value);
                } else {
                    emailInput.value = '';
                    categorySection.classList.add('hidden');
                }
            });
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

// Load recommendation categories for selected client
async function loadRecommendationCategories(clientId) {
    try {
        const response = await fetch(`/api/manager/recommendation-categories/${clientId}`);
        const data = await response.json();
        
        const select = document.getElementById('recommendCategorySelect');
        select.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option><option value="new">+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
        
        if (data.success && data.categories) {
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.recommendations_count})`;
                select.appendChild(option);
            });
        }
        
        // Add change handler for category selection
        select.addEventListener('change', function() {
            const newCategoryInput = document.getElementById('newCategoryInput');
            if (this.value === 'new') {
                newCategoryInput.classList.remove('hidden');
            } else {
                newCategoryInput.classList.add('hidden');
            }
        });
        
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function closeRecommendModal() {
    const modal = document.getElementById('recommendModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('recommendForm').reset();
        
        // Reset button state
        const submitBtn = document.getElementById('submitRecommendBtn');
        const submitIcon = document.getElementById('submitIcon');
        const submitText = document.getElementById('submitText');
        const spinner = submitBtn.querySelector('.loading-spinner');
        
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-green-500');
        submitBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
        spinner.classList.add('hidden');
        submitIcon.classList.remove('hidden');
        submitIcon.className = 'fas fa-paper-plane mr-2';
        submitText.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é';
    }
}

async function handleRecommendSubmit(e) {
    e.preventDefault();
    
    const clientSelect = document.getElementById('recommendClientSelect');
    const selectedClientId = clientSelect.value;
    
    if (!selectedClientId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
        return;
    }
    
    const categorySelect = document.getElementById('recommendCategorySelect');
    const categoryValue = categorySelect ? categorySelect.value : '';
    const categoryName = categoryValue === 'new' ? document.getElementById('recommendCategoryName').value.trim() : '';
    
    const formData = {
        recommendation_type: document.getElementById('recommendType').value,
        item_id: document.getElementById('recommendItemId').value,
        item_name: document.getElementById('recommendItemName').value,
        title: document.getElementById('recommendTitle').value.trim(),
        client_id: selectedClientId,
        client_email: document.getElementById('recommendClientEmail').value.trim(),
        description: document.getElementById('recommendDescription').value.trim(),
        manager_notes: document.getElementById('recommendNotes').value.trim(),
        priority_level: document.getElementById('recommendPriority').value,
        category_id: categoryValue,
        category_name: categoryName,
        highlighted_features: [], 
        item_data: {}
    };
    
    if (!formData.title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
        return;
    }
    
    // Show loading state
    showRecommendationLoading();
    
    try {
        const response = await fetch('/api/manager/send_recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showRecommendationSuccess();
            setTimeout(() => {
                closeRecommendModal();
            }, 1500);
        } else {
            showRecommendationError('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        showRecommendationError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: ' + error.message);
    }
}

function showRecommendationLoading() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    submitBtn.disabled = true;
    submitIcon.classList.add('hidden');
    spinner.classList.remove('hidden');
    submitText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
}

function showRecommendationSuccess() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    spinner.classList.add('hidden');
    submitIcon.classList.remove('hidden');
    submitIcon.className = 'fas fa-check mr-2';
    submitText.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
    submitBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
    submitBtn.classList.add('bg-green-500');
}

function showRecommendationError(message) {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    submitBtn.disabled = false;
    spinner.classList.add('hidden');
    submitIcon.classList.remove('hidden');
    submitIcon.className = 'fas fa-paper-plane mr-2';
    submitText.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é';
    
    alert(message);
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
async function addToComparison(type, id) {
    const idStr = id.toString();
    
    try {
        if (type === 'complex') {
            // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ endpoint  
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/complex/add' : '/api/user/comparison/complex/add';
            
            console.log(`üè¢ Adding complex to comparison for ${isManager ? 'manager' : 'user'} via ${endpoint}`);
            
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º API endpoint –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
            const complexCard = document.querySelector(`[data-complex-id="${idStr}"]`);
            const complexData = {
                complex_id: idStr,
                complex_name: complexCard?.querySelector('h3')?.textContent || `–ñ–ö ${idStr}`,
                developer: complexCard?.querySelector('.developer')?.textContent || '',
                district: complexCard?.querySelector('.district')?.textContent || '',
                min_price: null,
                max_price: null,
                photo: complexCard?.querySelector('img')?.src || '',
                buildings_count: null,
                apartments_count: null,
                completion_date: '',
                cashback_rate: parseFloat(complexCard?.dataset.cashbackRate || '5.0')  // –†–µ–∞–ª—å–Ω—ã–π –∫—ç—à–±–µ–∫ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
            };
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                credentials: 'same-origin',
                body: JSON.stringify(complexData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–ñ–ö –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ', 'success');
                console.log('‚úÖ Complex saved to database:', id);
            } else {
                showNotification(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ñ–ö', 'error');
            }
            
        } else if (type === 'property') {
            // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ endpoint
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/property/add' : '/api/comparison/property/add';
            
            console.log(`üè† Adding property to comparison for ${isManager ? 'manager' : 'user'} via ${endpoint}`);
            
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º API endpoint –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ë–î
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏–∑ –º–æ–¥–µ–ª–∏ ComparisonProperty
            const propertyData = {
                property_id: idStr,
                property_name: document.querySelector(`[data-property-id="${idStr}"] .title`)?.textContent || `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${idStr}`,
                property_price: null,
                property_address: '',
                property_image: document.querySelector(`[data-property-id="${idStr}"] img`)?.src || ''
            };
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                credentials: 'same-origin',
                body: JSON.stringify(propertyData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–ö–≤–∞—Ä—Ç–∏—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ', 'success');
                console.log('‚úÖ Property saved to database:', id);
            } else {
                showNotification(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'error');
            }
        }
        
        // Update UI if comparison counter exists
        updateComparisonCounter();
        
    } catch (error) {
        console.error('Error adding to comparison:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ localStorage
        console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä fallback');
        
        // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫ PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä—É –∏–∑ properties-comparison-fix.js
        if (window.simpleComparisonManager) {
            if (type === 'complex') {
                await window.simpleComparisonManager.toggleComplexComparison(idStr, null);
            } else if (type === 'property') {
                await window.simpleComparisonManager.toggleComparison(idStr, null);
            }
        } else {
            // –ó–∞–ø–∞—Å–Ω–æ–π fallback –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            console.warn('PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º minimal localStorage');
            showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ - –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'warning');
        }
    }
}

// Simple notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'warning' ? 'bg-yellow-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ–ª–µ–≥–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∫ PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä—É  
function updateComparisonCounter() {
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä –∏–∑ properties-comparison-fix.js
    if (window.simpleComparisonManager) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        const totalCount = window.simpleComparisonManager.comparisons.length + 
                          window.simpleComparisonManager.complexComparisons.length;
        
        console.log('‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä–∞:', totalCount);
        
        // Update any comparison counters on the page
        const counters = document.querySelectorAll('[data-comparison-counter]');
        counters.forEach(counter => {
            counter.textContent = totalCount;
            counter.style.display = totalCount > 0 ? 'inline' : 'none';
        });
    } else {
        // Fallback: –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ –∫–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        console.log('üîÑ PostgreSQL –º–µ–Ω–µ–¥–∂–µ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ...');
        setTimeout(updateComparisonCounter, 1000);
    }
}

// Initialize comparison counter on page load
document.addEventListener('DOMContentLoaded', function() {
    updateComparisonCounter();
});

// View mode switching
let currentViewMode = 'grid'; // Default to grid

function switchToGridView() {
    currentViewMode = 'grid';
    const container = document.getElementById('complexes-container');
    const gridBtn = document.getElementById('grid-view-btn');
    const listBtn = document.getElementById('list-view-btn');
    
    // Update container classes
    container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6';
    
    // Update button states
    gridBtn.className = 'flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    listBtn.className = 'flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    
    // Restore original card structure and styles
    const cards = container.querySelectorAll('.complex-card');
    cards.forEach(card => {
        // Restore original structure if it was saved
        if (card.dataset.originalStructure) {
            card.innerHTML = card.dataset.originalStructure;
            delete card.dataset.originalStructure;
        }
        card.className = 'complex-card bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 hover:shadow-xl transition-all duration-300 mobile-optimized';
    });
    
    console.log('Switched to grid view');
}

function switchToListView() {
    currentViewMode = 'list';
    const container = document.getElementById('complexes-container');
    const gridBtn = document.getElementById('grid-view-btn');
    const listBtn = document.getElementById('list-view-btn');
    
    // Update container classes
    container.className = 'space-y-6';
    
    // Update button states
    gridBtn.className = 'flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    listBtn.className = 'flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    
    // Update card styles for list view
    const cards = container.querySelectorAll('.complex-card');
    cards.forEach(card => {
        card.className = 'complex-card bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all duration-300 list-view-card';
        // Restructure card layout for list view
        restructureCardForList(card);
    });
    
    console.log('Switched to list view');
}

function restructureCardForList(card) {
    // Check if already restructured for list view
    if (card.querySelector('.list-layout')) return;
    
    // Get data from card
    const complexId = card.dataset.complexId;
    const imageSlider = card.querySelector('.complex-slider');
    const nameElement = card.querySelector('h3');
    const developerElement = card.querySelector('a[href*="developer"], p.text-gray-500');
    const descriptionElement = card.querySelector('p.text-gray-600.line-clamp-2');
    const locationElement = card.querySelector('.fa-map-marker-alt').parentElement;
    const completionElement = card.querySelector('.fa-calendar').parentElement;
    const statusElement = card.querySelector('.bg-green-100, .bg-orange-100');
    const statsGrid = card.querySelector('.grid.grid-cols-2');
    const apartmentTypes = card.querySelector('.border-t');
    const buttons = card.querySelector('.flex.gap-2');
    
    if (!imageSlider || !nameElement) return;
    
    // Save original structure for potential switch back
    if (!card.dataset.originalStructure) {
        card.dataset.originalStructure = card.innerHTML;
    }
    
    // Create horizontal layout
    const newLayout = document.createElement('div');
    newLayout.className = 'list-layout flex gap-6 p-6';
    
    // Left side - Image (much larger to match content properly)
    const imageContainer = document.createElement('div');
    imageContainer.className = 'flex-shrink-0 w-96';
    const clonedSlider = imageSlider.cloneNode(true);
    clonedSlider.style.height = '320px';
    clonedSlider.style.width = '100%';
    clonedSlider.style.borderRadius = '12px';
    clonedSlider.style.overflow = 'hidden';
    clonedSlider.style.position = 'relative';
    
    // Force all images to fill the container
    const images = clonedSlider.querySelectorAll('img');
    images.forEach(img => {
        img.style.width = '100%';
        img.style.height = '320px';
        img.style.objectFit = 'cover';
        img.style.display = 'block';
    });
    
    // Completion date will be added to content block instead of slider
    
    imageContainer.appendChild(clonedSlider);
    
    // Right side - All content with relative positioning for completion date
    const contentContainer = document.createElement('div');
    contentContainer.className = 'flex-1 space-y-4 relative';
    
    // Header with name, developer and location (completion date moved to slider)
    const header = document.createElement('div');
    const developerText = developerElement ? developerElement.textContent : '';
    const locationText = locationElement ? locationElement.textContent.replace(/^\s*/, '') : '';
    const descriptionText = descriptionElement ? descriptionElement.textContent : '';
    
    header.innerHTML = `
        <h3 class="text-xl font-bold text-gray-900 mb-1">${nameElement.textContent}</h3>
        ${developerText ? `<div class="text-sm text-[#0088CC] mb-2">${developerText}</div>` : ''}
        <div class="flex items-center text-gray-600 mb-2">
            <i class="fas fa-map-marker-alt mr-2"></i>
            <span>${locationText}</span>
        </div>
        ${descriptionText ? `<p class="text-sm text-gray-600 mb-3">${descriptionText}</p>` : ''}
    `;
    
    // Stats in horizontal layout
    const statsContainer = document.createElement('div');
    statsContainer.className = 'flex flex-wrap gap-6 text-sm';
    if (statsGrid) {
        const statItems = statsGrid.querySelectorAll('.flex.items-center');
        statItems.forEach(item => {
            const cloned = item.cloneNode(true);
            statsContainer.appendChild(cloned);
        });
    }
    
    // Apartment types with prices in horizontal layout
    const apartmentContainer = document.createElement('div');
    if (apartmentTypes) {
        const roomButtons = apartmentTypes.querySelectorAll('button');
        if (roomButtons.length > 0) {
            apartmentContainer.innerHTML = '<div class="text-sm text-gray-600 mb-3">–ö–≤–∞—Ä—Ç–∏—Ä—ã:</div>';
            const roomsContainer = document.createElement('div');
            roomsContainer.className = 'flex flex-wrap gap-3';
            
            roomButtons.forEach(btn => {
                const roomType = btn.querySelector('.font-medium')?.textContent || '';
                const area = btn.querySelector('.text-xs.text-gray-500')?.textContent || '';
                const price = btn.querySelector('.text-xs.font-medium.text-\\[\\#0088CC\\]')?.textContent || '';
                const count = btn.querySelector('.text-xs.text-green-600')?.textContent || '';
                
                const roomCard = document.createElement('div');
                roomCard.className = 'flex items-center justify-between bg-gray-50 rounded-lg p-3 min-w-[200px] cursor-pointer hover:bg-gray-100 transition-colors';
                roomCard.onclick = () => btn.click(); // Preserve original functionality
                
                roomCard.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-900">${roomType}</div>
                        ${area ? `<div class="text-xs text-gray-500">${area}</div>` : ''}
                        ${count ? `<div class="text-xs text-green-600">${count}</div>` : ''}
                    </div>
                    ${price ? `<div class="text-sm font-bold text-[#0088CC]">${price}</div>` : ''}
                `;
                
                roomsContainer.appendChild(roomCard);
            });
            apartmentContainer.appendChild(roomsContainer);
        }
    }
    
    // Action buttons (only manager recommendation button)
    const actionsContainer = document.createElement('div');
    const managerButtons = card.querySelector('.recommend-btn');
    if (managerButtons) {
        const clonedManagerButtons = managerButtons.cloneNode(true);
        actionsContainer.appendChild(clonedManagerButtons);
    }
    
    // Add completion date badge in top right of content area (minimalist style)
    const completionText = completionElement ? completionElement.textContent.replace(/^\s*/, '') : '';
    const statusText = statusElement ? statusElement.textContent.trim() : '';
    if (completionText) {
        const dateBadge = document.createElement('div');
        dateBadge.className = `absolute top-0 right-0 ${statusText === '–°–¥–∞–Ω' ? 'bg-gray-100 text-gray-700' : 'bg-gray-100 text-gray-700'} px-3 py-1 rounded-bl text-xs font-medium`;
        dateBadge.textContent = completionText;
        contentContainer.appendChild(dateBadge);
    }
    
    // Assemble content
    contentContainer.appendChild(header);
    contentContainer.appendChild(statsContainer);
    contentContainer.appendChild(apartmentContainer);
    contentContainer.appendChild(actionsContainer);
    
    // Replace card content
    card.innerHTML = '';
    newLayout.appendChild(imageContainer);
    newLayout.appendChild(contentContainer);
    card.appendChild(newLayout);
    
    // JavaScript version of create_slug function
    function createSlug(name) {
        if (!name) return "unknown";
        
        // Transliteration map
        const translitMap = {
            '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
            '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
            '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
            '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '',
            '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya',
            '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D', '–ï': 'E', '–Å': 'Yo',
            '–ñ': 'Zh', '–ó': 'Z', '–ò': 'I', '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M',
            '–ù': 'N', '–û': 'O', '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U',
            '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch', '–®': 'Sh', '–©': 'Sch', '–™': '',
            '–´': 'Y', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
        };
        
        // Remove –ñ–ö prefix and quotes
        name = name.replace(/^–ñ–ö\s*["']?/i, '').replace(/["']/g, '');
        
        // Transliterate
        let slug = '';
        for (let char of name) {
            slug += translitMap[char] || char;
        }
        
        // Clean up
        slug = slug.replace(/[^\w\s-]/g, '').replace(/[-\s]+/g, '-').toLowerCase().replace(/^-+|-+$/g, '');
        
        return slug;
    }

    // Add click handler for card navigation
    const complexName = nameElement.textContent;
    card.style.cursor = 'pointer';
    card.onclick = (event) => handleCardClick(event, `/zk/${createSlug(complexName)}`);
    
    // Reinitialize sliders for the cloned elements
    reinitializeSlider(clonedSlider);
}

function reinitializeSlider(sliderElement) {
    // Find slider controls and re-attach event listeners
    const complexId = sliderElement.dataset.complexId;
    if (complexId) {
        const prevBtn = sliderElement.querySelector('.slider-prev');
        const nextBtn = sliderElement.querySelector('.slider-next');
        
        if (prevBtn) prevBtn.onclick = () => prevSlide(complexId);
        if (nextBtn) nextBtn.onclick = () => nextSlide(complexId);
    }
}

// Handle card clicks for navigation while preserving button functionality
function handleCardClick(event, url) {
    // Check if click was on a button or interactive element
    const target = event.target;
    const isButton = target.tagName === 'BUTTON' || target.closest('button');
    const isLink = target.tagName === 'A' || target.closest('a');
    const isInteractive = target.closest('.apartment-types') || target.closest('.favorites-btn') || target.hasAttribute('onclick');
    
    // If click was on interactive element, don't navigate
    if (isButton || isLink || isInteractive) {
        return;
    }
    
    // Navigate to complex detail page
    window.location.href = url;
}


</script>

<!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SimpleComparisonManager -->
<script>
// –°–æ–∑–¥–∞–µ–º wrapper —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ onclick
window.addToComplexCompare = async function(complexId, button = null) {
    console.log('üè¢ addToComplexCompare –≤—ã–∑–≤–∞–Ω –¥–ª—è –ñ–ö:', complexId);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞
    if (!button) {
        button = document.querySelector(`[data-complex-id="${complexId}"].compare-btn`) ||
                 document.querySelector(`[data-complex-id="${complexId}"].comparison-btn`);
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º SimpleComparisonManager –∏–∑ properties-comparison-fix.js
    if (window.simpleComparisonManager) {
        await window.simpleComparisonManager.toggleComplexComparison(complexId, button);
    } else {
        console.error('‚ùå SimpleComparisonManager –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        showNotification('–û—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
    }
};

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ UI –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîß Residential Complexes: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
    
    // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SimpleComparisonManager (–æ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑ properties-comparison-fix.js)
    let attempts = 0;
    const maxAttempts = 20; // –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ 2 —Å–µ–∫—É–Ω–¥
    
    while (!window.simpleComparisonManager && attempts < maxAttempts) {
        console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ SimpleComparisonManager... –ø–æ–ø—ã—Ç–∫–∞ ${attempts + 1}/${maxAttempts}`);
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (window.simpleComparisonManager) {
        console.log('‚úÖ SimpleComparisonManager –Ω–∞–π–¥–µ–Ω –¥–ª—è –ñ–ö!');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —á–µ—Ä–µ–∑ 500ms (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π)
        setTimeout(() => {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–æ–∫ –ñ–ö...');
            window.simpleComparisonManager.updateComparisonUI();
        }, 500);
    } else {
        console.error('‚ùå –ö–†–ò–¢–ò–ß–ù–û: SimpleComparisonManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ñ–ö!');
    }
});

// –ü–†–û–°–¢–û–ï –†–ï–®–ï–ù–ò–ï: Event delegation –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
document.addEventListener('click', function(event) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    if (event.target.closest('.favorite-heart')) {
        event.preventDefault();
        event.stopPropagation();
        
        const button = event.target.closest('.favorite-heart');
        const complexId = button.getAttribute('data-complex-id');
        const icon = button.querySelector('i');
        
        console.log('‚ù§Ô∏è –ö–ª–∏–∫ –ø–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–º—É –ñ–ö:', complexId);
        
        // –ü—Ä–æ—Å—Ç–æ–π toggle –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (icon.classList.contains('text-red-500')) {
            icon.classList.remove('text-red-500');
            icon.classList.add('text-gray-400');
            console.log('‚ù§Ô∏è –£–±—Ä–∞–ª–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', complexId);
        } else {
            icon.classList.remove('text-gray-400');
            icon.classList.add('text-red-500');
            console.log('‚ù§Ô∏è –î–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', complexId);
        }
        
        // –ü—Ä–æ–±—É–µ–º –≤—ã–∑–≤–∞—Ç—å FavoritesManager –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
        if (window.favoritesManager && window.favoritesManager.toggleComplexFavorite) {
            try {
                window.favoritesManager.toggleComplexFavorite(complexId, button);
            } catch (error) {
                console.log('‚ö†Ô∏è FavoritesManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É');
            }
        }
        
        return false;
    }
});

// Mini Complexes Map (Avito-style)
let miniComplexesMapInstance = null;

function initMiniComplexesMap() {
    const mapElement = document.getElementById('miniComplexesMap');
    if (!mapElement || miniComplexesMapInstance) return;
    
    ymaps.ready(function() {
        try {
            // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä (–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π) - –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö
            miniComplexesMapInstance = new ymaps.Map('miniComplexesMap', {
                center: [45.0355, 38.9753],
                zoom: 11,
                controls: []
            }, {
                suppressMapOpenBlock: true,
                yandexMapDisablePoiInteractivity: true
            });
            
            miniComplexesMapInstance.behaviors.disable(['drag', 'scrollZoom', 'dblClickZoom', 'multiTouch']);
            
            fetch('/api/mini-map/complexes')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.coordinates && data.coordinates.length > 0) {
                        console.log(`‚úÖ Loaded ${data.count} complex coordinates`);
                        
                        // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                        data.coordinates.forEach(complex => {
                            const placemark = new ymaps.Placemark([complex.lat, complex.lng], {
                                iconContent: '1'
                            }, {
                                preset: 'islands#blueCircleIcon',
                                iconColor: '#0088CC'
                            });
                            
                            placemark.events.add('click', function() {
                                window.location.href = '/complexes-map';
                            });
                            
                            miniComplexesMapInstance.geoObjects.add(placemark);
                        });
                        
                        console.log(`‚úÖ Added ${data.count} complexes to Yandex mini map`);
                        
                        // üéØ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –¶–ï–ù–¢–†–ò–†–û–í–ê–ù–ò–ï –ü–û –ñ–ö
                        // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ –≤—Å–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        const bounds = data.coordinates.reduce((acc, coord) => {
                            if (!acc.minLat || coord.lat < acc.minLat) acc.minLat = coord.lat;
                            if (!acc.maxLat || coord.lat > acc.maxLat) acc.maxLat = coord.lat;
                            if (!acc.minLng || coord.lng < acc.minLng) acc.minLng = coord.lng;
                            if (!acc.maxLng || coord.lng > acc.maxLng) acc.maxLng = coord.lng;
                            return acc;
                        }, {});
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –ñ–ö —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º
                        miniComplexesMapInstance.setBounds([
                            [bounds.minLat, bounds.minLng],
                            [bounds.maxLat, bounds.maxLng]
                        ], {
                            checkZoomRange: true,
                            zoomMargin: 20  // –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                        });
                        
                        console.log(`üéØ Auto-centered map: [${bounds.minLat.toFixed(4)}, ${bounds.minLng.toFixed(4)}] - [${bounds.maxLat.toFixed(4)}, ${bounds.maxLng.toFixed(4)}]`);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading complex coordinates:', error);
                });
            
            console.log('‚úÖ Yandex mini map initialized for residential complexes');
        } catch (error) {
            console.error('‚ùå Error initializing Yandex mini complexes map:', error);
        }
    });
}

// Initialize mini map on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initMiniComplexesMap, 500);
});

</script>

<!-- Fullscreen Map Modal -->
<div id="fullscreenComplexesMapModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" style="z-index: 9999;">
    <div class="w-full h-full bg-white flex flex-col">
        <!-- Header with Close Button -->
        <div class="flex items-center justify-between p-4 bg-white border-b border-gray-200">
            <h2 class="text-lg font-bold text-gray-900">–ñ–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –Ω–∞ –∫–∞—Ä—Ç–µ</h2>
            <button onclick="closeFullscreenComplexesMap()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Filter Toolbar -->
        <div class="bg-white border-b border-gray-200 px-3 py-2">
            <div class="flex items-center gap-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;">
                <!-- Status Filter Chips -->
                <button class="fullscreen-status-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-green-500" data-status="–°–¥–∞–Ω">
                    –°–¥–∞–Ω
                </button>
                <button class="fullscreen-status-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500" data-status="–°—Ç—Ä–æ–∏—Ç—Å—è">
                    –°—Ç—Ä–æ–∏—Ç—Å—è
                </button>
                <button class="fullscreen-status-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-orange-500" data-status="–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è">
                    –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è
                </button>
                
                <!-- Filters Button -->
                <button onclick="openComplexFiltersSheet()" class="flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    –§–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="fullscreenComplexesMapContainer" class="relative flex-1">
            <!-- Yandex Map -->
            <div id="fullscreenComplexesMap" class="w-full h-full"></div>
            
            <!-- List Button (Bottom Left) -->
            <button onclick="closeFullscreenComplexesMap()" class="absolute bottom-6 left-4 z-10 bg-white rounded-lg px-4 py-2 shadow-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                <span class="font-medium text-gray-700">–°–ø–∏—Å–æ–∫</span>
            </button>
        </div>
    </div>
</div>

<!-- Bottom Sheet Backdrop -->
<div id="complexBottomSheetBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300" style="z-index: 9998;" onclick="closeComplexBottomSheet()"></div>

<!-- Complex Bottom Sheet (for grouped markers) -->
<div id="complexBottomSheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out hidden" style="z-index: 9999; max-height: 70vh;">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 id="complexBottomSheetTitle" class="text-lg font-bold text-gray-900">–ñ–ö –Ω–∞ —ç—Ç–æ–π –ª–æ–∫–∞—Ü–∏–∏</h3>
        <button onclick="closeComplexBottomSheet()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <div id="bottomSheetComplexesContainer" class="p-4 overflow-y-auto space-y-3" style="max-height: calc(70vh - 64px);">
        <!-- Complex cards will be inserted here -->
    </div>
</div>

<!-- Complex Filters Bottom Sheet -->
<div id="complexFiltersBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300" style="z-index: 10001;" onclick="closeComplexFiltersSheet()"></div>

<div id="complexFiltersSheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out hidden" style="z-index: 10002; max-height: 85vh;">
    <!-- Sheet Header -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10 flex items-center justify-between rounded-t-3xl">
        <h3 class="text-lg font-semibold text-gray-800">–§–∏–ª—å—Ç—Ä—ã</h3>
        <div class="flex items-center gap-3">
            <button onclick="resetComplexFilters()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
            <button onclick="closeComplexFiltersSheet()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Sheet Content -->
    <div class="overflow-y-auto p-4 space-y-4" style="max-height: calc(85vh - 140px);">
        <!-- Rooms Filter -->
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
            <div class="flex flex-wrap gap-2">
                <button class="complex-room-chip px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:border-blue-500 transition-all" data-rooms="—Å—Ç—É–¥–∏—è">
                    –°—Ç—É–¥–∏—è
                </button>
                <button class="complex-room-chip px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:border-blue-500 transition-all" data-rooms="1-–∫–æ–º–Ω">
                    1–∫
                </button>
                <button class="complex-room-chip px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:border-blue-500 transition-all" data-rooms="2-–∫–æ–º–Ω">
                    2–∫
                </button>
                <button class="complex-room-chip px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:border-blue-500 transition-all" data-rooms="3-–∫–æ–º–Ω">
                    3–∫
                </button>
                <button class="complex-room-chip px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:border-blue-500 transition-all" data-rooms="4+-–∫–æ–º–Ω">
                    4+–∫
                </button>
            </div>
        </div>
        
        <!-- Price Range -->
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="complexPriceFrom" placeholder="–û—Ç" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="number" id="complexPriceTo" placeholder="–î–æ" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- Completion Year -->
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">–ì–æ–¥ —Å–¥–∞—á–∏</label>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="complexYearFrom" placeholder="–û—Ç" min="2020" max="2030"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="number" id="complexYearTo" placeholder="–î–æ" min="2020" max="2030"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- More Filters Button -->
        <button onclick="openComplexAdvancedFilters()" 
                class="w-full py-3 px-4 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:border-blue-500 hover:text-blue-600 transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            –ë–æ–ª—å—à–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        </button>
    </div>
    
    <!-- Sheet Footer -->
    <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 w-full">
        <button id="complexFiltersApplyBtn" onclick="applyComplexFilters()" 
                class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
            –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        </button>
    </div>
</div>

<!-- Advanced Filters Modal for Complexes -->
<div id="complexAdvancedFiltersModal" class="hidden fixed inset-0 bg-white z-[10003] w-full overflow-y-auto">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
        <div class="flex items-center gap-3">
            <button onclick="resetComplexAdvancedFilters()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
            <button onclick="closeComplexAdvancedFilters()" 
                    class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                    aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Filter Content -->
    <div class="p-4 space-y-6 pb-24">
        <!-- Developers Filter -->
        <div>
            <button onclick="toggleComplexDevelopersFilter()" 
                    class="w-full flex items-center justify-between py-3 border-b border-gray-200">
                <span class="font-semibold text-gray-800">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</span>
                <svg id="complexDevelopersArrow" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="complexDevelopersContent" class="hidden mt-3 space-y-2 max-h-60 overflow-y-auto">
                {% for developer in developers %}
                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                    <input type="checkbox" value="{{ developer.id }}" class="complex-developer-filter w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">{{ developer.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <!-- Districts Filter -->
        <div>
            <button onclick="toggleComplexDistrictsFilter()" 
                    class="w-full flex items-center justify-between py-3 border-b border-gray-200">
                <span class="font-semibold text-gray-800">–†–∞–π–æ–Ω</span>
                <svg id="complexDistrictsArrow" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="complexDistrictsContent" class="hidden mt-3 space-y-2 max-h-60 overflow-y-auto">
                {% for district in districts %}
                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                    <input type="checkbox" value="{{ district.id }}" class="complex-district-filter w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">{{ district.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <!-- Object Class Filter -->
        <div>
            <label class="block font-semibold text-gray-800 mb-3">–ö–ª–∞—Å—Å –æ–±—ä–µ–∫—Ç–∞</label>
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                    <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" class="complex-class-filter w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                </label>
                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                    <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" class="complex-class-filter w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">–ë–∏–∑–Ω–µ—Å</span>
                </label>
                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                    <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" class="complex-class-filter w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">–ü—Ä–µ–º–∏—É–º</span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- Footer with Apply Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-10">
        <button id="complexAdvancedFiltersApplyBtn" onclick="applyComplexAdvancedFilters()" 
                class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
    </div>
</div>

<!-- Include Fullscreen Map Script -->
<script src="{{ url_for('static', filename='js/complexes_fullscreen_map.js') }}"></script>

<script>
// –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ Chaport –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤
(function() {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É Chaport
    window.chaportConfig = { autoInit: false, enabled: false };
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ Chaport
    function removeChaport() {
        const selectors = [
            'iframe[src*="chaport"]',
            'div[id*="chaport"]',
            'div[class*="chaport"]',
            '#chaport-launcher',
            '#chaport-container',
            '.chaport-launcher',
            '.chaport-container'
        ];
        
        selectors.forEach(function(selector) {
            const elements = document.querySelectorAll(selector);
            elements.forEach(function(el) {
                if (el && el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
        });
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        removeChaport();
        
        if (window.Chaport) {
            try {
                window.Chaport.q = window.Chaport.q || [];
                window.Chaport.q.push(['hide']);
            } catch (e) {}
        }
    });
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ
    setInterval(removeChaport, 500);
    
    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ DOM –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(function(mutations) {
            removeChaport();
        });
        
        setTimeout(function() {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }, 100);
    }
})();
</script>

{% endblock %}