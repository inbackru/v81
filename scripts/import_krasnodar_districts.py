#!/usr/bin/env python3
"""
–ò–º–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ä–∞–π–æ–Ω–æ–≤ –∏ –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–æ—Ç–æ–≤—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤,
—Ä–∞–π–æ–Ω–æ–≤ –∏ –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –Ø–Ω–¥–µ–∫—Å.–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python scripts/import_krasnodar_districts.py
    
    # –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç)
    python scripts/import_krasnodar_districts.py --dry-run
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app import app, db
from models import District
import logging
from utils.transliteration import create_slug

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–∞–π–æ–Ω–æ–≤ –∏ –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞
# –ò—Å—Ç–æ—á–Ω–∏–∫: –Ø–Ω–¥–µ–∫—Å.–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, DaData, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
KRASNODAR_DISTRICTS = [
    # ======================
    # –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï –û–ö–†–£–ì–ê
    # ======================
    "–ö–∞—Ä–∞—Å—É–Ω—Å–∫–∏–π –æ–∫—Ä—É–≥",
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", 
    "–ó–∞–ø–∞–¥–Ω—ã–π –æ–∫—Ä—É–≥",
    "–ü—Ä–∏–∫—É–±–∞–Ω—Å–∫–∏–π –æ–∫—Ä—É–≥",
    
    # ======================
    # –ö–†–£–ü–ù–´–ï –†–ê–ô–û–ù–´
    # ======================
    "–¶–µ–Ω—Ç—Ä",
    "–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å",
    "–¢–≠–¶",
    "–Æ–±–∏–ª–µ–π–Ω—ã–π",
    "–§–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã–π",
    "–ì–∏–¥—Ä–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π",
    "–ü–∞—à–∫–æ–≤—Å–∫–∏–π",
    "–°–ª–∞–≤—è–Ω—Å–∫–∏–π",
    "–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∏–π",
    "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π",
    
    # ======================
    # –ó–ê–ü–ê–î–ù–´–ô –û–ö–†–£–ì
    # ======================
    "–ó–∞–ø–∞–¥–Ω—ã–π –æ–±—Ö–æ–¥",
    "—É–ª. –¢—É—Ä–≥–µ–Ω–µ–≤–∞",
    "—É–ª. –£—Ä–∞–ª—å—Å–∫–∞—è",
    "–ê–∫–∞–¥–µ–º–≥–æ—Ä–æ–¥–æ–∫",
    "—É–ª. –∏–º. –ö–∞–ª–∏–Ω–∏–Ω–∞",
    "–î—É–±–∏–Ω–∫–∞",
    "–ñ–ö –ó–∞–ø–∞–¥–Ω—ã–π",
    
    # ======================
    # –ö–ê–†–ê–°–£–ù–°–ö–ò–ô –û–ö–†–£–ì
    # ======================
    "—É–ª. –∏–º. 40-–ª–µ—Ç–∏—è –ü–æ–±–µ–¥—ã",
    "—É–ª. –¢–æ–ø–æ–ª–∏–Ω–∞—è –∞–ª–ª–µ—è",
    "—É–ª. –í–æ—Å—Ç–æ—á–Ω–æ-–ö—Ä—É–≥–ª–∏–∫–æ–≤—Å–∫–∞—è",
    "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω",
    "–°–•–ò",
    "–ö—É–±–∞–Ω—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è",
    "–ü–∞—Ä–∫ –ì–æ—Ä–æ–¥—Å–∫–æ–π",
    
    # ======================
    # –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –û–ö–†–£–ì
    # ======================
    "—É–ª. –ö—Ä–∞—Å–Ω–∞—è",
    "—É–ª. –ö—Ä–∞—Å–Ω–æ–∞—Ä–º–µ–π—Å–∫–∞—è",
    "—É–ª. –ì–æ–≥–æ–ª—è",
    "—É–ª. –†–∞—à–ø–∏–ª–µ–≤—Å–∫–∞—è",
    "—É–ª. –°–µ–≤–µ—Ä–Ω–∞—è",
    "—É–ª. –°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∞—è",
    "—É–ª. –°–µ–¥–∏–Ω–∞",
    "–ü–∞—Ä–∫ –°–æ–ª–Ω–µ—á–Ω—ã–π –æ—Å—Ç—Ä–æ–≤",
    
    # ======================
    # –ü–†–ò–ö–£–ë–ê–ù–°–ö–ò–ô –û–ö–†–£–ì  
    # ======================
    "—É–ª. –†–æ—Å—Å–∏–π—Å–∫–∞—è",
    "—É–ª. –∏–º. –°–µ–ª–µ–∑–Ω–µ–≤–∞",
    "—É–ª. –∏–º. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ",
    "–°—Ç–∞—Ä–æ–∫—É–±–∞–Ω—Å–∫–∏–π",
    "–Æ–ú–† (–Æ–∂–Ω—ã–π –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω)",
    "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø–æ—Å–µ–ª–æ–∫",
    "–ü–∞—Ä–∫ ¬´–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä¬ª",
    
    # ======================
    # –ú–ò–ö–†–û–†–ê–ô–û–ù–´
    # ======================
    "–º–∫—Ä. –°–ª–∞–≤—è–Ω—Å–∫–∏–π",
    "–º–∫—Ä. –ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∏–π",
    "–º–∫—Ä. –ú–æ—Å–∫–æ–≤—Å–∫–∏–π",
    "–º–∫—Ä. –§–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã–π",
    "–º–∫—Ä. –Æ–±–∏–ª–µ–π–Ω—ã–π",
    "–º–∫—Ä. –ì–∏–¥—Ä–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π",
    "–º–∫—Ä. –ü–∞—à–∫–æ–≤—Å–∫–∏–π",
    "–º–∫—Ä. –ß–µ—Ä–µ–º—É—à–∫–∏",
    "–º–∫—Ä. –≠–Ω–∫–∞",
    "–º–∫—Ä. –ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π",
    "–º–∫—Ä. –•–ª–µ–±–æ–∑–∞–≤–æ–¥",
    "–º–∫—Ä. –ì—É–±–µ—Ä–Ω—Å–∫–∏–π",
    "–º–∫—Ä. –ó–Ω–∞–º–µ–Ω—Å–∫–∏–π",
    "–º–∫—Ä. –í–∏—Ç–∞–º–∏–Ω–∫–æ–º–±–∏–Ω–∞—Ç",
    "–º–∫—Ä. –ù–µ—Ñ—Ç–µ–±–∞–∑–∞",
    "–º–∫—Ä. –ö–∞–ª–∏–Ω–∏–Ω–æ",
    "–º–∫—Ä. –ö–æ–∂–∑–∞–≤–æ–¥",
    "–º–∫—Ä. –†–æ—Å—Å–∏–π—Å–∫–∏–π",
    "–º–∫—Ä. –î—É–±–∏–Ω–∫–∞",
    
    # ======================
    # –ù–ê–°–ï–õ–Å–ù–ù–´–ï –ü–£–ù–ö–¢–´ –í –ß–ï–†–¢–ï –ì–û–†–û–î–ê
    # ======================
    "–ø–æ—Å. –ü–∞—à–∫–æ–≤—Å–∫–∏–π",
    "–ø–æ—Å. –†–æ—Å—Å–∏–π—Å–∫–∏–π",
    "–ø–æ—Å. –ó–Ω–∞–º–µ–Ω—Å–∫–∏–π",
    "–ø–æ—Å. –ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π",
    "—Å—Ç. –°—Ç–∞—Ä–æ–∫–æ—Ä—Å—É–Ω—Å–∫–∞—è",
    "—Ö—É—Ç. –õ–µ–Ω–∏–Ω–∞",
    
    # ======================
    # –ù–û–í–´–ï –ó–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –†–ê–ô–û–ù–´
    # ======================
    "—É–ª. –ê–≤–∏–∞–≥–æ—Ä–æ–¥–æ–∫",
    "—É–ª. –°–æ–ª–Ω–µ—á–Ω–∞—è",
    "—É–ª. –°–æ—Ä–º–æ–≤—Å–∫–∞—è",
    "—É–ª. –∏–º. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ",
    "—É–ª. –∏–º. –ì–µ—Ä–æ—è –Ø—Ü–∫–æ–≤–∞",
    "—É–ª. –í–æ—Å—Ç–æ—á–Ω–æ-–ö—Ä—É–≥–ª–∏–∫–æ–≤—Å–∫–∞—è",
    "—É–ª. –∏–º. –ë–∞–±—É—à–∫–∏–Ω–∞",
    "—É–ª. –∏–º. –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–∞ –°–µ–¥–∏–Ω–∞",
]


def import_districts(city_id=1, dry_run=False):
    """
    –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–∞–π–æ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É districts.
    
    Args:
        city_id: ID –≥–æ—Ä–æ–¥–∞ –≤ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 = –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä)
        dry_run: –ï—Å–ª–∏ True, —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
    """
    logger.info("=" * 60)
    logger.info(f"üèôÔ∏è  –ò–º–ø–æ—Ä—Ç —Ä–∞–π–æ–Ω–æ–≤ –¥–ª—è –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ (city_id={city_id})")
    if dry_run:
        logger.info("‚ö†Ô∏è  DRY RUN MODE - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ù–ï –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
    logger.info("=" * 60)
    logger.info(f"üìã –í—Å–µ–≥–æ —Ä–∞–π–æ–Ω–æ–≤ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ: {len(KRASNODAR_DISTRICTS)}")
    logger.info("")
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    categories = {
        '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–≥–∞': [d for d in KRASNODAR_DISTRICTS if '–æ–∫—Ä—É–≥' in d.lower()],
        '–ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω—ã': [d for d in KRASNODAR_DISTRICTS if d.startswith('–º–∫—Ä.')],
        '–ü–æ—Å—ë–ª–∫–∏': [d for d in KRASNODAR_DISTRICTS if d.startswith('–ø–æ—Å.')],
        '–£–ª–∏—Ü—ã': [d for d in KRASNODAR_DISTRICTS if d.startswith('—É–ª.')],
        '–°—Ç–∞–Ω–∏—Ü—ã/—Ö—É—Ç–æ—Ä–∞': [d for d in KRASNODAR_DISTRICTS if d.startswith(('—Å—Ç.', '—Ö—É—Ç.'))],
        '–ö—Ä—É–ø–Ω—ã–µ —Ä–∞–π–æ–Ω—ã': [d for d in KRASNODAR_DISTRICTS 
                          if not any(d.startswith(p) for p in ['–º–∫—Ä.', '–ø–æ—Å.', '—É–ª.', '—Å—Ç.', '—Ö—É—Ç.']) 
                          and '–æ–∫—Ä—É–≥' not in d.lower()],
    }
    
    for category, districts in categories.items():
        if districts:
            logger.info(f"üìç {category}: {len(districts)}")
            for d in sorted(districts)[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
                logger.info(f"   ‚Ä¢ {d}")
            if len(districts) > 5:
                logger.info(f"   ... –∏ –µ—â—ë {len(districts) - 5}")
            logger.info("")
    
    if dry_run:
        logger.info(f"‚ÑπÔ∏è  –ë—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {len(KRASNODAR_DISTRICTS)} —Ä–∞–π–æ–Ω–æ–≤")
        return len(KRASNODAR_DISTRICTS)
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –ë–î
    logger.info("üíæ –ò–º–ø–æ—Ä—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")
    logger.info("")
    
    imported = 0
    updated = 0
    skipped = 0
    
    for district_name in KRASNODAR_DISTRICTS:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ
        existing = District.query.filter_by(
            city_id=city_id,
            name=district_name
        ).first()
        
        if existing:
            # –û–±–Ω–æ–≤–ª—è–µ–º slug –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            new_slug = create_slug(district_name)
            if existing.slug != new_slug:
                existing.slug = new_slug
                db.session.add(existing)
                logger.info(f"  üîÑ –û–±–Ω–æ–≤–ª—ë–Ω slug: {district_name} ‚Üí {new_slug}")
                updated += 1
            else:
                skipped += 1
            continue
        
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ä–∞–π–æ–Ω
        slug = create_slug(district_name)
        
        new_district = District(
            city_id=city_id,
            name=district_name,
            slug=slug
        )
        
        db.session.add(new_district)
        logger.info(f"  ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: {district_name}")
        imported += 1
    
    db.session.commit()
    
    logger.info("")
    logger.info("=" * 60)
    logger.info(f"‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!")
    logger.info(f"   ‚Ä¢ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤—ã—Ö: {imported}")
    logger.info(f"   ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}")
    logger.info(f"   ‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏): {skipped}")
    logger.info(f"   ‚Ä¢ –í—Å–µ–≥–æ –≤ –ë–î –¥–ª—è –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞: {District.query.filter_by(city_id=city_id).count()}")
    logger.info("=" * 60)
    logger.info("")
    logger.info("üéâ –¢–µ–ø–µ—Ä—å API /api/districts/1 –≤–µ—Ä–Ω—ë—Ç –≤—Å–µ —Ä–∞–π–æ–Ω—ã!")
    logger.info("üéâ –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç —Å –ø–æ–ª–Ω—ã–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º!")
    
    return imported


def show_usage_example():
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    logger.info("")
    logger.info("=" * 60)
    logger.info("üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:")
    logger.info("=" * 60)
    logger.info("")
    logger.info("1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ API:")
    logger.info("   curl http://localhost:5000/api/districts/1 | python -m json.tool")
    logger.info("")
    logger.info("2Ô∏è‚É£  –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞:")
    logger.info("   ‚Ä¢ –í–≤–µ–¥–∏—Ç–µ '–ó–∞–ø–∞–¥–Ω—ã–π' –≤ –ø–æ–∏—Å–∫ ‚Üí —É–≤–∏–¥–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É '–†–∞–π–æ–Ω –ó–∞–ø–∞–¥–Ω—ã–π'")
    logger.info("   ‚Ä¢ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫—É ‚Üí –æ—Ç–∫—Ä–æ—é—Ç—Å—è –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —ç—Ç–æ–≥–æ —Ä–∞–π–æ–Ω–∞")
    logger.info("")
    logger.info("3Ô∏è‚É£  –§–∏–ª—å—Ç—Ä –Ω–∞ /properties:")
    logger.info("   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É /properties")
    logger.info("   ‚Ä¢ –í dropdown '–†–∞–π–æ–Ω' –≤—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π —Ä–∞–π–æ–Ω")
    logger.info("   ‚Ä¢ –û–±—ä–µ–∫—Ç—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
    logger.info("")
    logger.info("4Ô∏è‚É£  –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ:")
    logger.info("   python scripts/auto_fill_districts_from_addresses.py")
    logger.info("")


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='–ò–º–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ä–∞–π–æ–Ω–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞',
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    
    parser.add_argument('--city-id', type=int, default=1, help='ID –≥–æ—Ä–æ–¥–∞ –≤ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1 = –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä)')
    parser.add_argument('--dry-run', action='store_true', help='–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    
    args = parser.parse_args()
    
    with app.app_context():
        try:
            imported = import_districts(
                city_id=args.city_id,
                dry_run=args.dry_run
            )
            
            if not args.dry_run and imported > 0:
                show_usage_example()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}", exc_info=True)
            db.session.rollback()
            return 1
    
    return 0


if __name__ == '__main__':
    sys.exit(main())
