{% extends "admin/base.html" %}

{% block title %}Аналитика продаж - InBack{% endblock %}
{% block page_title %}Аналитика продаж{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-handshake text-[#0088CC]"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ total_deals }}</p>
            <p class="text-sm text-gray-500 mt-1">Всего сделок</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ successful_deals }}</p>
            <p class="text-sm text-gray-500 mt-1">Успешных сделок</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-percentage text-[#0088CC]"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ conversion_rate }}%</p>
            <p class="text-sm text-gray-500 mt-1">Конверсия</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calculator text-[#0088CC]"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ "{:,.0f}".format(avg_deal_size).replace(",", " ") }} ₽</p>
            <p class="text-sm text-gray-500 mt-1">Средний чек</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-ruble-sign text-green-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ "{:,.0f}".format(successful_revenue).replace(",", " ") }} ₽</p>
            <p class="text-sm text-gray-500 mt-1">Общая выручка (успешные)</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-coins text-green-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ "{:,.0f}".format(successful_cashback).replace(",", " ") }} ₽</p>
            <p class="text-sm text-gray-500 mt-1">Общий кэшбек (успешные)</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-spinner text-orange-500"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ active_deals }}</p>
            <p class="text-sm text-gray-500 mt-1">Активные сделки</p>
        </div>
    </div>

    {% if funnel_data %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Воронка продаж</h3>
        <div style="height: {{ funnel_data|length * 40 + 60 }}px;">
            <canvas id="funnelChart"></canvas>
        </div>
    </div>
    {% endif %}

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Динамика сделок (6 месяцев)</h3>
        <div style="height: 300px;">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    {% if manager_stats %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Эффективность менеджеров</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-3 font-semibold text-gray-600">Менеджер</th>
                        <th class="text-left py-3 px-3 font-semibold text-gray-600">Отдел</th>
                        <th class="text-left py-3 px-3 font-semibold text-gray-600">Роль</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Всего</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Активные</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Успешные</th>
                        <th class="text-right py-3 px-3 font-semibold text-gray-600">Кэшбек</th>
                        <th class="text-right py-3 px-3 font-semibold text-gray-600">Выручка</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Конверсия</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Задачи</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in manager_stats %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-3 font-medium text-gray-900">{{ m.name }}</td>
                        <td class="py-3 px-3 text-gray-600">{{ m.department }}</td>
                        <td class="py-3 px-3 text-gray-600">{{ m.role }}</td>
                        <td class="py-3 px-3 text-center">{{ m.total_deals }}</td>
                        <td class="py-3 px-3 text-center">
                            {% if m.active_deals > 0 %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ m.active_deals }}</span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-3 text-center">
                            {% if m.successful_deals > 0 %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">{{ m.successful_deals }}</span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-3 text-right text-gray-700">{{ "{:,.0f}".format(m.cashback).replace(",", " ") }} ₽</td>
                        <td class="py-3 px-3 text-right text-gray-700">{{ "{:,.0f}".format(m.revenue).replace(",", " ") }} ₽</td>
                        <td class="py-3 px-3 text-center">
                            <span class="{% if m.conversion >= 50 %}text-green-600{% elif m.conversion >= 20 %}text-orange-500{% else %}text-gray-500{% endif %} font-medium">{{ m.conversion }}%</span>
                        </td>
                        <td class="py-3 px-3 text-center">
                            {% if m.pending_tasks > 0 %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">{{ m.pending_tasks }}</span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if dept_stats %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Аналитика по отделам</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-3 font-semibold text-gray-600">Отдел</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Менеджеров</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Сделок</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Успешных</th>
                        <th class="text-right py-3 px-3 font-semibold text-gray-600">Кэшбек</th>
                        <th class="text-right py-3 px-3 font-semibold text-gray-600">Выручка</th>
                        <th class="text-center py-3 px-3 font-semibold text-gray-600">Конверсия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in dept_stats %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-3 font-medium text-gray-900">{{ d.name }}</td>
                        <td class="py-3 px-3 text-center">{{ d.managers_count }}</td>
                        <td class="py-3 px-3 text-center">{{ d.total_deals }}</td>
                        <td class="py-3 px-3 text-center">
                            {% if d.successful_deals > 0 %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">{{ d.successful_deals }}</span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-3 text-right text-gray-700">{{ "{:,.0f}".format(d.cashback).replace(",", " ") }} ₽</td>
                        <td class="py-3 px-3 text-right text-gray-700">{{ "{:,.0f}".format(d.revenue).replace(",", " ") }} ₽</td>
                        <td class="py-3 px-3 text-center">
                            <span class="{% if d.conversion >= 50 %}text-green-600{% elif d.conversion >= 20 %}text-orange-500{% else %}text-gray-500{% endif %} font-medium">{{ d.conversion }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if rejection_data %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Причины отказов</h3>
        <div class="space-y-3">
            {% for r in rejection_data %}
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-700">{{ r.reason }}</span>
                <div class="flex items-center space-x-3">
                    <div class="w-48 bg-gray-100 rounded-full h-2">
                        <div class="bg-red-400 h-2 rounded-full" style="width: {{ (r.count / rejected_deals * 100) if rejected_deals > 0 else 0 }}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-600 w-8 text-right">{{ r.count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="border-t border-gray-200 pt-8 mt-4">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
            <i class="fas fa-bullhorn text-[#0088CC]"></i>
            Маркетинг и лиды
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-user-plus text-[#0088CC]"></i>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900">{{ total_leads }}</p>
                <p class="text-sm text-gray-500 mt-1">Лидов получено</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-green-600"></i>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900">{{ total_users }}</p>
                <p class="text-sm text-gray-500 mt-1">Регистраций на сайте</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exchange-alt text-[#0088CC]"></i>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900">{{ lead_to_deal }}%</p>
                <p class="text-sm text-gray-500 mt-1">Лид → Сделка</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-orange-500"></i>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900">{{ total_applications }}</p>
                <p class="text-sm text-gray-500 mt-1">Заявок на кэшбек</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Статус лидов (заявок)</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Новые</span>
                            <span class="font-semibold text-gray-900">{{ new_leads }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-[#0088CC] h-3 rounded-full transition-all" style="width: {{ (new_leads / total_leads * 100) if total_leads > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Обработаны</span>
                            <span class="font-semibold text-gray-900">{{ processed_leads }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-amber-400 h-3 rounded-full transition-all" style="width: {{ (processed_leads / total_leads * 100) if total_leads > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Звонок совершён</span>
                            <span class="font-semibold text-gray-900">{{ called_leads }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-green-500 h-3 rounded-full transition-all" style="width: {{ (called_leads / total_leads * 100) if total_leads > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Статус заявок на кэшбек</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">На рассмотрении</span>
                            <span class="font-semibold text-gray-900">{{ pending_applications }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-[#0088CC] h-3 rounded-full transition-all" style="width: {{ (pending_applications / total_applications * 100) if total_applications > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Одобрены</span>
                            <span class="font-semibold text-gray-900">{{ approved_applications }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-amber-400 h-3 rounded-full transition-all" style="width: {{ (approved_applications / total_applications * 100) if total_applications > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Выплачены</span>
                            <span class="font-semibold text-gray-900">{{ paid_applications }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-green-500 h-3 rounded-full transition-all" style="width: {{ (paid_applications / total_applications * 100) if total_applications > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Лиды и регистрации (6 месяцев)</h3>
            <div style="height: 300px;">
                <canvas id="leadsChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 overflow-hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Воронка: Лид → Сделка → Успех</h3>
                {% set max_val = [total_leads, total_users, total_deals, 1]|max %}
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Лиды (заявки с сайта)</span>
                            <span class="font-bold text-gray-900">{{ total_leads }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-5">
                            <div class="bg-[#0088CC] h-5 rounded-full" style="width: {{ (total_leads / max_val * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Регистрации</span>
                            <span class="font-bold text-gray-900">{{ total_users }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-5">
                            <div class="bg-sky-400 h-5 rounded-full" style="width: {{ (total_users / max_val * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Сделки созданы</span>
                            <span class="font-bold text-gray-900">{{ total_deals }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-5">
                            <div class="bg-amber-400 h-5 rounded-full" style="width: {{ (total_deals / max_val * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Успешные сделки</span>
                            <span class="font-bold text-gray-900">{{ successful_deals }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-5">
                            <div class="bg-green-500 h-5 rounded-full" style="width: {{ (successful_deals / max_val * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Проваленные сделки</span>
                            <span class="font-bold text-red-600">{{ rejected_deals }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-5">
                            <div class="bg-red-400 h-5 rounded-full" style="width: {{ (rejected_deals / max_val * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            {% if source_data %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 overflow-hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Источники регистраций</h3>
                <div class="relative" style="height: 250px;">
                    <canvas id="sourcesChart"></canvas>
                </div>
            </div>
            {% endif %}
        </div>

        {% if interest_data %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Интересы лидов</h3>
                <div class="space-y-3">
                    {% for item in interest_data %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">{{ item.interest }}</span>
                        <div class="flex items-center space-x-3">
                            <div class="w-32 bg-gray-100 rounded-full h-2">
                                <div class="bg-[#0088CC] h-2 rounded-full" style="width: {{ (item.count / interest_data[0].count * 100) }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-600 w-8 text-right">{{ item.count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if budget_data %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Бюджет лидов</h3>
                <div class="space-y-3">
                    {% for item in budget_data %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">{{ item.budget }}</span>
                        <div class="flex items-center space-x-3">
                            <div class="w-32 bg-gray-100 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: {{ (item.count / budget_data[0].count * 100) }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-600 w-8 text-right">{{ item.count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if funnel_data %}
    const funnelCtx = document.getElementById('funnelChart').getContext('2d');
    new Chart(funnelCtx, {
        type: 'bar',
        data: {
            labels: [{% for s in funnel_data %}'{{ s.label }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Количество сделок',
                data: [{% for s in funnel_data %}{{ s.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [{% for s in funnel_data %}'{{ s.color }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                borderRadius: 4,
                barThickness: 24
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const amounts = [{% for s in funnel_data %}{{ s.amount }}{% if not loop.last %}, {% endif %}{% endfor %}];
                            return 'Сумма: ' + new Intl.NumberFormat('ru-RU').format(amounts[context.dataIndex]) + ' ₽';
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { display: true } },
                y: { grid: { display: false } }
            }
        }
    });
    {% endif %}

    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: [{% for m in monthly_data %}'{{ m.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [
                {
                    label: 'Всего сделок',
                    data: [{% for m in monthly_data %}{{ m.total }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#0088CC',
                    borderRadius: 4
                },
                {
                    label: 'Успешных',
                    data: [{% for m in monthly_data %}{{ m.successful }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#059669',
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { stepSize: 1 } }
            }
        }
    });

    const leadsEl = document.getElementById('leadsChart');
    if (leadsEl) {
        new Chart(leadsEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [{% for m in monthly_leads %}'{{ m.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: 'Лиды',
                        data: [{% for m in monthly_leads %}{{ m.leads }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: '#0088CC',
                        borderRadius: 4
                    },
                    {
                        label: 'Регистрации',
                        data: [{% for m in monthly_leads %}{{ m.registrations }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: '#059669',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { stepSize: 1 } }
                }
            }
        });
    }

    {% if source_data %}
    const sourcesEl = document.getElementById('sourcesChart');
    if (sourcesEl) {
        const sourceColors = ['#0088CC', '#059669', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'];
        new Chart(sourcesEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: [{% for s in source_data %}'{{ s.source }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for s in source_data %}{{ s.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: sourceColors.slice(0, {{ source_data|length }}),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}