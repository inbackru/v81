{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç | InBack{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() if csrf_token else 'no-token' }}">
{% endblock %}

{% block content %}
<style>
/* Hide header in dashboard */
header {
    display: none !important;
}

/* Adjust body padding since header is hidden */
body {
    padding-top: 0 !important;
}

/* Hide old tab navigation when sidebar is present */
{% if sidebar_links is defined and sidebar_links %}
.bg-white.border-b.border-gray-200 nav[aria-label="Tabs"] {
    display: none !important;
}
{% endif %}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.tab-button:hover {
    color: #374151 !important;
    border-color: #D1D5DB !important;
}

/* –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∫–µ—à–±–µ–∫–∞ */
.slider-blue {
    background: linear-gradient(to right, #0088CC 0%, #0088CC var(--slider-progress, 0%), #e5e7eb var(--slider-progress, 0%), #e5e7eb 100%);
}

.slider-blue::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #ffffff;
    border: 2px solid #0088CC;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 136, 204, 0.3);
    transition: all 0.2s ease;
}

.slider-blue::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 136, 204, 0.4);
}

.slider-blue::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border: 2px solid #0088CC;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 136, 204, 0.3);
    transition: all 0.2s ease;
}

.slider-blue::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 136, 204, 0.4);
}

.slider-blue::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
}

/* –°—Ç–∏–ª—å–Ω—ã–µ –ø–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∫–µ—à–±–µ–∫–∞ */
.slider {
    -webkit-appearance: none;
    background: transparent;
    cursor: pointer;
}

.slider::-webkit-slider-track {
    width: 100%;
    height: 12px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
}

.slider::-webkit-slider-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    -webkit-appearance: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border: 2px solid #4F8EF7;
    transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-track {
    width: 100%;
    height: 12px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border: none;
}

.slider::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    border: 2px solid #4F8EF7;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.slider:focus {
    outline: none;
}

.slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px rgba(79, 142, 247, 0.3);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–¥–µ–ª–æ–∫ */
.deals-filter-btn {
    background: white;
    color: #6b7280;
    border-color: #e5e7eb;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.deals-filter-btn:hover {
    background: #f9fafb;
    color: #374151;
    border-color: #0088CC;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.deals-filter-btn.active {
    background: linear-gradient(135deg, #0088CC 0%, #006699 100%);
    color: white;
    border-color: #0088CC;
    box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–¥–µ–ª–æ–∫ */
.deal-card {
    transition: all 0.2s ease;
}

.deal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
}

.status-new { background: #dbeafe; color: #1d4ed8; }
.status-reserved { background: #fef3c7; color: #d97706; }
.status-mortgage { background: #fed7aa; color: #ea580c; }
.status-completed { background: #dcfce7; color: #16a34a; }
.status-rejected { background: #fee2e2; color: #dc2626; }
</style>

<!-- Include Sidebar Component -->
{% if sidebar_links is defined and sidebar_links %}
{% include 'components/sidebar.html' %}
{% endif %}

<!-- Main Content with sidebar margin -->
<div class="{% if sidebar_links is defined and sidebar_links %}md:ml-[70px]{% endif %} transition-all duration-300">
<!-- Tab Navigation under main header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="overflow-x-auto">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="/">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="dashboard">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                    </svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="favorites">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                    </svg>
                    –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="top-favorites-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="deals">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"/>
                    </svg>
                    –°–¥–µ–ª–∫–∏
                    <span class="ml-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="deals-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="saved-searches">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    –ú–æ–∏ –ø–æ–∏—Å–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium hidden" id="saved-searches-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="recommendations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                    <span class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs px-2 py-1 rounded-full font-medium hidden" id="recommendations-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="comparison">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="comparison-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="settings">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
                {% if current_manager or (current_user.is_authenticated and current_user.role == 'manager') %}
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="clients">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    –ö–ª–∏–µ–Ω—Ç—ã
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="clients-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="data-management">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium">Excel</span>
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">
            <!-- Welcome Header -->
            <div class="mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_user.full_name or current_user.email.split('@')[0] }}! üëã
                </h1>
                <p class="text-gray-600">–í–∞—à –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å –∫–µ—à–±–µ–∫–æ–º</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Cashback Card -->
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <span class="text-xs font-semibold bg-white bg-opacity-20 px-3 py-1 rounded-full">
                            {% if cashback_applications %}{{ cashback_applications|length }}{% else %}0{% endif %} –∑–∞—è–≤–æ–∫
                        </span>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ "{:,}".format(total_cashback|default(0)|int).replace(',', ' ') }} ‚ÇΩ</div>
                        <div class="text-sm opacity-90">–û–±—â–∏–π –∫–µ—à–±–µ–∫</div>
                    </div>
                    <div class="text-xs opacity-75">+{{ "{:,}".format(pending_cashback|default(0)|int).replace(',', ' ') }} ‚ÇΩ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
                </div>

                <!-- Favorites Card -->
                <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="document.querySelector('[data-page=favorites]').click()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{% if favorites %}{{ favorites|length }}{% else %}0{% endif %}</div>
                        <div class="text-sm opacity-90">–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</div>
                    </div>
                    <div class="text-xs opacity-75">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</div>
                </div>

                <!-- Deals Card -->
                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="document.querySelector('[data-page=deals]').click()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{% if deals %}{{ deals|length }}{% else %}0{% endif %}</div>
                        <div class="text-sm opacity-90">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                    </div>
                    <div class="text-xs opacity-75">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</div>
                </div>

                <!-- Balance Card - NEW -->
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="document.querySelector('[data-page=balance]').click()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                                <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ "{:,.2f}".format(user_balance|default(0)).replace(',', ' ') }} ‚ÇΩ</div>
                        <div class="text-sm opacity-90">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                    </div>
                    <div class="text-xs opacity-75">–ë–æ–Ω—É—Å—ã –∏ –≤—ã–ø–ª–∞—Ç—ã</div>
                </div>

                <!-- Saved Searches Card -->
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="document.querySelector('[data-page=saved-searches]').click()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{% if saved_searches %}{{ saved_searches|length }}{% else %}0{% endif %}</div>
                        <div class="text-sm opacity-90">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤</div>
                    </div>
                    <div class="text-xs opacity-75">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–∏–Ω–∫–∞—Ö</div>
                </div>
            </div>
            
            <!-- –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä -->
            {% if current_user.assigned_manager_id %}
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl shadow-sm p-6 mb-8 border border-green-200">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                    {% if current_user.assigned_manager and current_user.assigned_manager.profile_image and 'randomuser.me' not in current_user.assigned_manager.profile_image %}
                    <div class="w-20 h-20 rounded-full flex-shrink-0 overflow-hidden ring-4 ring-white shadow-lg">
                        <img src="{{ current_user.assigned_manager.profile_image }}" alt="{{ current_user.assigned_manager.full_name }}" class="w-full h-full object-cover">
                    </div>
                    {% elif current_user.assigned_manager and current_user.assigned_manager.full_name %}
                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 ring-4 ring-white shadow-lg">
                        <span class="text-white font-bold text-2xl">{{ current_user.assigned_manager.full_name[0] }}</span>
                    </div>
                    {% else %}
                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 ring-4 ring-white shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                    </div>
                    {% endif %}
                    <div class="flex-1 text-center md:text-left">
                        <div class="mb-3">
                            <span class="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold mb-2">–í–∞—à —ç–∫—Å–ø–µ—Ä—Ç</span>
                            <h3 class="text-2xl font-bold text-gray-900">{{ current_user.assigned_manager.full_name if current_user.assigned_manager else '–ú–µ–Ω–µ–¥–∂–µ—Ä' }}</h3>
                            <p class="text-sm text-gray-600">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            {% if current_user.assigned_manager and current_user.assigned_manager.phone %}
                            <a href="tel:{{ current_user.assigned_manager.phone }}" class="inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                {{ current_user.assigned_manager.phone }}
                            </a>
                            {% endif %}
                            {% if current_user.assigned_manager and current_user.assigned_manager.email %}
                            <a href="mailto:{{ current_user.assigned_manager.email }}" class="inline-flex items-center justify-center px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors border border-gray-300">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                                –ù–∞–ø–∏—Å–∞—Ç—å
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-sm p-6 mb-8 border border-blue-200">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0 ring-4 ring-white shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω</h3>
                        <p class="text-gray-600 mb-4">–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞—è–≤–∫–∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –¥–ª—è –≤–∞—Å —ç–∫—Å–ø–µ—Ä—Ç–∞</p>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <a href="tel:+78612345678" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                +7 (861) 234-56-78
                            </a>
                            <a href="mailto:info@inback.ru" class="inline-flex items-center justify-center px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors border border-gray-300">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                                info@inback.ru
                            </a>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">–†–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 9:00 –¥–æ 21:00</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Two Column Layout: Recent Activity + Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Recent Activity (2/3 width) -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                        <span class="text-sm text-gray-500">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</span>
                    </div>
                    
                    <div class="space-y-4">
                        {% if recent_activities %}
                            {% for activity in recent_activities[:5] %}
                            <div class="flex items-start space-x-4 p-4 rounded-xl hover:bg-gray-50 transition-colors">
                                <div class="flex-shrink-0">
                                    {% if activity.type == 'favorite_added' %}
                                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    {% elif activity.type == 'cashback_application' %}
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    {% elif activity.type == 'search_saved' %}
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    {% else %}
                                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900">{{ activity.title }}</p>
                                    <p class="text-sm text-gray-600 truncate">{{ activity.description }}</p>
                                </div>
                                <span class="text-xs text-gray-500 whitespace-nowrap">{{ activity.created_at.strftime('%d.%m.%Y %H:%M') if activity.created_at else '–ù–µ–¥–∞–≤–Ω–æ' }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Empty State -->
                            <div class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <h4 class="text-sm font-medium text-gray-900 mb-1">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                                <p class="text-sm text-gray-500">–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ–∏—Å–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</p>
                                <button onclick="window.location.href='/properties'" class="mt-4 inline-flex items-center px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                    </svg>
                                    –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions (1/3 width) -->
                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                    
                    <!-- Property Search Action -->
                    <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-xl shadow-lg p-5 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="window.location.href='/properties'">
                        <div class="flex items-center justify-between mb-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                            <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <h4 class="font-semibold mb-1">–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É</h4>
                        <p class="text-sm opacity-90">–ü–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</p>
                    </div>
                    
                    <!-- Mortgage Calculator Action -->
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg p-5 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="window.location.href='/ipoteka'">
                        <div class="flex items-center justify-between mb-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                            </svg>
                            <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <h4 class="font-semibold mb-1">–ò–ø–æ—Ç–µ—á–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h4>
                        <p class="text-sm opacity-90">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏</p>
                    </div>
                    
                    <!-- Consultation Action -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-5 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="openApplicationModal()">
                        <div class="flex items-center justify-between mb-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            </svg>
                            <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <h4 class="font-semibold mb-1">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</h4>
                        <p class="text-sm opacity-90">–°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º</p>
                    </div>
                </div>
            </div>
            
            <!-- Recommended Properties -->
            <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –≤–∞—Å</h3>
                        <p class="text-sm text-gray-600">–ü–æ–¥–æ–±—Ä–∞–ª–∏ –æ–±—ä–µ–∫—Ç—ã –ø–æ –≤–∞—à–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º</p>
                    </div>
                    <button onclick="document.querySelector('[data-page=recommendations]').click()" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm flex items-center">
                        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                        <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
                
                {% if recommendations and recommendations|length > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for prop in recommendations[:3] %}
                    <a href="{{ prop.url or '#' }}" class="group block bg-gray-50 rounded-xl overflow-hidden hover:shadow-lg transition-all">
                        <div class="relative h-48 bg-gray-200">
                            {% if prop.image %}
                            <img src="{{ prop.image }}" alt="{{ prop.title }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300">
                                <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                </svg>
                            </div>
                            {% endif %}
                            {% if prop.cashback_rate %}
                            <div class="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                –¥–æ {{ prop.cashback_rate }}% –∫–µ—à–±—ç–∫
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-gray-900 mb-2 group-hover:text-[#0088CC] transition-colors">{{ prop.title or '–û–±—ä–µ–∫—Ç' }}</h4>
                            <p class="text-sm text-gray-600 mb-3">{{ prop.complex or '–ñ–ö –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold text-gray-900">
                                    {% if prop.price %}
                                    {{ "{:,}".format(prop.price|int).replace(',', ' ') }} ‚ÇΩ
                                    {% else %}
                                    –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                                    {% endif %}
                                </span>
                                <svg class="w-5 h-5 text-[#0088CC] opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty State -->
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</h4>
                    <p class="text-gray-600 mb-6">–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</p>
                    <button onclick="window.location.href='/properties'" class="inline-flex items-center px-6 py-3 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        –ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- How to Buy with Cashback Guide -->
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-sm p-6 mb-8 border border-gray-200">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">–ö–∞–∫ –ø–æ–∫—É–ø–∞—Ç—å —Å –∫–µ—à–±–µ–∫–æ–º</h3>
                    <p class="text-gray-600">–í—Å–µ–≥–æ 4 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞ –¥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–æ 500 000 ‚ÇΩ</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Step 1 -->
                    <div class="relative group">
                        <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all h-full border border-gray-100">
                            <div class="w-14 h-14 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-xl flex items-center justify-center text-white text-lg font-bold mb-4 group-hover:scale-110 transition-transform">
                                01
                            </div>
                            <h4 class="font-bold text-gray-900 mb-2">–í—ã–±–æ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã</h4>
                            <p class="text-sm text-gray-600">–ü–æ–¥–±–∏—Ä–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</p>
                        </div>
                        <div class="hidden lg:block absolute top-1/2 -right-3 w-6 h-0.5 bg-gradient-to-r from-gray-300 to-transparent"></div>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="relative group">
                        <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all h-full border border-gray-100">
                            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white text-lg font-bold mb-4 group-hover:scale-110 transition-transform">
                                02
                            </div>
                            <h4 class="font-bold text-gray-900 mb-2">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h4>
                            <p class="text-sm text-gray-600">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–∞—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–±–µ–∫–∞</p>
                        </div>
                        <div class="hidden lg:block absolute top-1/2 -right-3 w-6 h-0.5 bg-gradient-to-r from-gray-300 to-transparent"></div>
                    </div>
                    
                    <!-- Step 3 -->
                    <div class="relative group">
                        <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all h-full border border-gray-100">
                            <div class="w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white text-lg font-bold mb-4 group-hover:scale-110 transition-transform">
                                03
                            </div>
                            <h4 class="font-bold text-gray-900 mb-2">–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</h4>
                            <p class="text-sm text-gray-600">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</p>
                        </div>
                        <div class="hidden lg:block absolute top-1/2 -right-3 w-6 h-0.5 bg-gradient-to-r from-gray-300 to-transparent"></div>
                    </div>
                    
                    <!-- Step 4 -->
                    <div class="group">
                        <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all h-full border border-gray-100">
                            <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-lg font-bold mb-4 group-hover:scale-110 transition-transform">
                                04
                            </div>
                            <h4 class="font-bold text-gray-900 mb-2">–ö—ç—à–±–µ–∫</h4>
                            <p class="text-sm text-gray-600">–ü–µ—Ä–µ—á–∏—Å–ª—è–µ–º –¥–æ 500 000 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Applications Section -->
        <div class="content-section" id="applications">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
                    <p class="text-lg text-gray-600 mb-6">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫</p>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Favorites Section -->
        <div class="content-section" id="favorites">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Property Favorites Card -->
                <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="favorites-count">0</div>
                    </div>
                    <div class="text-sm opacity-90" id="favorites-count-label">–ö–≤–∞—Ä—Ç–∏—Ä</div>
                    <div class="mt-2 text-xs opacity-75">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
                </div>

                <!-- Complex Favorites Card -->
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2h6v4H7V6zm8 0h2v4h-2V6zM5 6h2v4H5V6zm0 6h2v4H5v-4zm4 0h6v4H9v-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="complex-favorites-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ñ–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤</div>
                    <div class="mt-2 text-xs opacity-75">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
                </div>

                <!-- Total Value Card -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="total-favorites-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–í—Å–µ–≥–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
                    <div class="mt-2 text-xs opacity-75">–ì–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É</div>
                </div>
            </div>
            
            <!-- Favorites Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Property Favorites -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã</h3>
                        <div class="flex space-x-2">
                            <button class="text-sm text-red-600 hover:text-red-700 font-medium transition-colors" onclick="clearAllPropertyFavorites()">
                                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                            <button class="text-sm text-[#0088CC] hover:text-[#006699] font-medium transition-colors flex items-center" onclick="window.location.href='/properties'">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                                –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </div>
                    <div id="favorites-list" class="space-y-3">
                        <!-- Favorites loading state -->
                        <div id="favorites-loading" class="text-center py-12">
                            <div class="relative inline-block mb-6">
                                <div class="absolute inset-0 bg-red-500 opacity-25 rounded-full animate-ping"></div>
                                <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-red-500 to-pink-600 rounded-full shadow-lg">
                                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ...</p>
                            <p class="text-gray-500 text-sm mt-2">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ</p>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="favorites-empty" class="text-center py-12 hidden">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-red-100 to-pink-200 rounded-3xl mb-6 shadow-lg">
                                <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <h4 class="text-xl font-bold text-gray-900 mb-3">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ</h4>
                            <p class="text-gray-600 mb-8 max-w-sm mx-auto">–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å –∏—Ö –ø–æ–∑–∂–µ</p>
                            <button class="inline-flex items-center bg-gradient-to-r from-red-500 to-pink-600 text-white px-8 py-4 rounded-xl hover:from-pink-600 hover:to-red-500 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl font-medium" onclick="window.location.href='/properties'">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                </svg>
                                –ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Complex Favorites -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö</h3>
                        <div class="flex space-x-2">
                            <button class="text-sm text-red-600 hover:text-red-700 font-medium transition-colors" onclick="clearAllComplexFavorites()">
                                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                            <button class="text-sm text-[#0088CC] hover:text-[#006699] font-medium transition-colors flex items-center" onclick="window.location.href='/complexes'">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                                –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </div>
                    <div id="complex-favorites-list" class="space-y-3">
                        <!-- Loading state -->
                        <div id="complex-loading" class="text-center py-12">
                            <div class="relative inline-block mb-6">
                                <div class="absolute inset-0 bg-blue-500 opacity-25 rounded-full animate-ping"></div>
                                <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full shadow-lg">
                                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –ñ–ö...</p>
                            <p class="text-gray-500 text-sm mt-2">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ</p>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="complex-empty" class="text-center py-12 hidden">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-100 to-indigo-200 rounded-3xl mb-6 shadow-lg">
                                <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2h6v4H7V6zm8 0h2v4h-2V6zM5 6h2v4H5V6zm0 6h2v4H5v-4zm4 0h6v4H9v-4z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <h4 class="text-xl font-bold text-gray-900 mb-3">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö</h4>
                            <p class="text-gray-600 mb-8 max-w-sm mx-auto">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</p>
                            <button class="inline-flex items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-8 py-4 rounded-xl hover:from-indigo-600 hover:to-blue-500 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl font-medium" onclick="window.location.href='/complexes'">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2h6v4H7V6zm8 0h2v4h-2V6zM5 6h2v4H5V6zm0 6h2v4H5v-4zm4 0h6v4H9v-4z" clip-rule="evenodd"/>
                                </svg>
                                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ñ–ö
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Deals Section -->
        <div class="content-section" id="deals">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Deals Card -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="deals-total-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                    <div class="mt-2 text-xs opacity-75">+12% –∑–∞ –º–µ—Å—è—Ü</div>
                </div>

                <!-- Active Deals Card -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="deals-active-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                    <div class="mt-2 text-xs opacity-75">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                </div>

                <!-- Completed Deals Card -->
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="deals-completed-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    <div class="mt-2 text-xs opacity-75">–£—Å–ø–µ—à–Ω–æ</div>
                </div>

                <!-- Total Cashback Card -->
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl font-bold">‚ÇΩ</span>
                        </div>
                        <div class="text-3xl font-bold" id="deals-cashback-total">0 ‚ÇΩ</div>
                    </div>
                    <div class="text-sm opacity-90">–û–±—â–∏–π –∫–µ—à–±–µ–∫</div>
                    <div class="mt-2 text-xs opacity-75">–í—ã–ø–ª–∞—á–µ–Ω–æ + –æ–∂–∏–¥–∞–µ—Ç—Å—è</div>
                </div>
            </div>

            <!-- Modern Filters -->
            <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
                    <button onclick="window.location.href='/properties'" class="text-sm text-[#0088CC] hover:text-[#006699] font-medium flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="deals-filter-btn active px-4 py-2.5 rounded-xl font-medium transition-all border-2" data-status="all">
                        <span class="inline-flex items-center">
                            –í—Å–µ
                            <span class="ml-2 px-2 py-0.5 bg-gray-100 rounded-full text-xs font-bold">0</span>
                        </span>
                    </button>
                    <button class="deals-filter-btn px-4 py-2.5 rounded-xl font-medium transition-all border-2" data-status="new,object_reserved">
                        <span class="inline-flex items-center">
                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                            –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                        </span>
                    </button>
                    <button class="deals-filter-btn px-4 py-2.5 rounded-xl font-medium transition-all border-2" data-status="mortgage">
                        <span class="inline-flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                            –ò–ø–æ—Ç–µ–∫–∞
                        </span>
                    </button>
                    <button class="deals-filter-btn px-4 py-2.5 rounded-xl font-medium transition-all border-2" data-status="successful">
                        <span class="inline-flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            –ó–∞–≤–µ—Ä—à–µ–Ω—ã
                        </span>
                    </button>
                    <button class="deals-filter-btn px-4 py-2.5 rounded-xl font-medium transition-all border-2" data-status="rejected">
                        <span class="inline-flex items-center">
                            <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                            –û—Ç–∫–ª–æ–Ω–µ–Ω—ã
                        </span>
                    </button>
                </div>
            </div>

            <!-- Deals List -->
            <div class="space-y-4" id="deals-list">
                <!-- Deals will be loaded here dynamically via JavaScript -->
            </div>
            
            <!-- Deal Card Template (hidden, used by JavaScript) -->
            <div id="deal-card-template" class="hidden">
                <div class="deal-card group bg-white rounded-2xl shadow-sm hover:shadow-xl p-6 border-2 border-gray-100 hover:border-[#0088CC]/30 transition-all duration-300">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <div class="flex items-center space-x-4 mb-3 md:mb-0">
                            <div class="relative">
                                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <span class="text-white font-bold text-lg deal-number-short"></span>
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-lg deal-number group-hover:text-[#0088CC] transition-colors"></h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                    <p class="text-sm text-gray-500 deal-created-at"></p>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge deal-status-badge"></div>
                    </div>
                    
                    <!-- Property Info -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 mb-5">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Property Details -->
                            <div>
                                <div class="flex items-start space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                        <svg class="w-5 h-5 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h5 class="font-bold text-gray-900 mb-1 deal-complex-name"></h5>
                                        <p class="text-sm text-gray-600 deal-property-description"></p>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2 ml-13">
                                    <span class="inline-flex items-center px-2.5 py-1 bg-white rounded-lg text-xs font-medium text-gray-700 shadow-sm deal-property-area"></span>
                                    <span class="inline-flex items-center px-2.5 py-1 bg-white rounded-lg text-xs font-medium text-gray-700 shadow-sm deal-property-rooms"></span>
                                    <span class="inline-flex items-center px-2.5 py-1 bg-white rounded-lg text-xs font-medium text-gray-700 shadow-sm deal-property-floor"></span>
                                </div>
                            </div>
                            
                            <!-- Right: Financial Info -->
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                    <span class="text-sm text-gray-600 flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                                            <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                        </svg>
                                        –°—Ç–æ–∏–º–æ—Å—Ç—å
                                    </span>
                                    <span class="font-bold text-gray-900 deal-price"></span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                                    <span class="text-sm text-green-700 font-medium flex items-center">
                                        <span class="text-lg mr-2">‚ÇΩ</span>
                                        –ö–µ—à–±–µ–∫
                                    </span>
                                    <span class="font-bold text-green-600 deal-cashback"></span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                    <span class="text-sm text-gray-600">–ü—Ä–æ—Ü–µ–Ω—Ç:</span>
                                    <span class="font-bold text-[#0088CC] deal-cashback-percent"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Notes -->
                    <div class="deal-client-notes-section hidden">
                        <div class="bg-blue-50 border-l-4 border-[#0088CC] rounded-r-lg p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-[#0088CC] mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 mb-1">–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏:</p>
                                    <p class="text-sm text-gray-700 deal-client-notes"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-sm p-12 text-center hidden" id="deals-empty-state">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-100 to-purple-200 rounded-3xl mb-6 shadow-lg">
                    <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p class="text-gray-600 mb-8 max-w-md mx-auto">–û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–∫—É–ø–∫—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å –∫–µ—à–±–µ–∫–æ–º, –∏ –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–¥–µ–ª–∫–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                <button onclick="window.location.href='/properties'" class="inline-flex items-center bg-gradient-to-r from-[#0088CC] to-[#006699] text-white px-8 py-4 rounded-xl hover:from-[#006699] hover:to-[#004d7a] transition-all transform hover:scale-105 shadow-lg hover:shadow-xl font-medium">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    –ù–∞–π—Ç–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
                </button>
            </div>

            <!-- Loading State -->
            <div class="bg-white rounded-2xl shadow-sm p-12 text-center hidden" id="deals-loading-state">
                <div class="relative inline-block mb-6">
                    <div class="absolute inset-0 bg-[#0088CC] opacity-25 rounded-full animate-ping"></div>
                    <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full shadow-lg">
                        <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞—è–≤–∫–∏...</p>
                <p class="text-gray-500 text-sm mt-2">–≠—Ç–æ –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
            </div>
        </div>
        
        <!-- Saved Searches & Notifications Section -->
        <div class="content-section" id="saved-searches">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Saved Searches Card -->
                <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="saved-searches-total-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤</div>
                    <div class="mt-2 text-xs opacity-75">–ì–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ</div>
                </div>

                <!-- Active Alerts Card -->
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="active-alerts-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ê–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                    <div class="mt-2 text-xs opacity-75">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–∏–Ω–æ–∫</div>
                </div>

                <!-- Quick Action Card -->
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="window.location.href='/properties'">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm opacity-90 font-semibold">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</div>
                    <div class="mt-2 text-xs opacity-75">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫</div>
                </div>
            </div>
            
            <!-- Saved Searches with Notification Settings -->
            <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏</h3>
                    <button class="inline-flex items-center text-sm text-[#0088CC] hover:text-[#006699] font-medium transition-colors" onclick="window.location.href='/properties'">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                    </button>
                </div>
                
                <div id="saved-searches-list" class="space-y-3">
                    <!-- Searches will be loaded dynamically -->
                    <!-- Loading State -->
                    <div class="text-center py-12">
                        <div class="relative inline-block mb-6">
                            <div class="absolute inset-0 bg-[#0088CC] opacity-25 rounded-full animate-ping"></div>
                            <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full shadow-lg">
                                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∏—Å–∫–∏...</p>
                        <p class="text-gray-500 text-sm mt-2">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ</p>
                    </div>
                </div>
            </div>
            
            <!-- Notification History -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
                    <button id="toggle-history" class="text-sm text-gray-600 hover:text-gray-800" onclick="toggleAlertHistory()">
                        <svg class="w-5 h-5 inline transition-transform" id="history-chevron" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                
                <div id="alert-history-content" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –ø–æ –≤–∞—à–∏–º –ø–æ–∏—Å–∫–∞–º</span>
                        </div>
                    </div>
                    
                    <div id="alert-history-list" class="space-y-3">
                        <!-- History will be loaded dynamically -->
                        <div class="text-center py-6">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-400"></div>
                            <p class="text-gray-500 mt-2 text-sm">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é...</p>
                        </div>
                    </div>
                </div>
                
                <div id="no-history-message" class="hidden text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                    <p class="text-sm mt-2">–ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã –ø–æ –≤–∞—à–∏–º –ø–æ–∏—Å–∫–∞–º, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                </div>
            </div>
        </div>
        
        <!-- Presentations Section -->
        <div class="content-section" id="recommendations">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- New Presentations Card -->
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="presentations-new-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ù–æ–≤—ã—Ö –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π</div>
                    <div class="mt-2 text-xs opacity-75">–¢—Ä–µ–±—É—é—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
                </div>

                <!-- Total Presentations Card -->
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="presentations-total-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–í—Å–µ–≥–æ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π</div>
                    <div class="mt-2 text-xs opacity-75">–û—Ç –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</div>
                </div>

                <!-- Manager Info Card -->
                <div class="bg-gradient-to-br from-orange-500 to-amber-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm opacity-90 font-semibold">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</div>
                    <div class="mt-2 text-xs opacity-75">–ü–æ–¥–±–æ—Ä–∫–∏ –¥–ª—è –≤–∞—Å</div>
                </div>
            </div>
            
            <!-- Presentations Content -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
                </div>
                
                <!-- Presentations will be loaded dynamically via JavaScript -->
                <div class="space-y-4" id="presentationsList">
                    <!-- Loading State -->
                    <div class="text-center py-12">
                        <div class="relative inline-block mb-6">
                            <div class="absolute inset-0 bg-blue-500 opacity-25 rounded-full animate-ping"></div>
                            <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full shadow-lg">
                                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...</p>
                        <p class="text-gray-500 text-sm mt-2">–ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–±–æ—Ä–∫–∏ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞</p>
                    </div>
                </div>
            </div>
        </div>
        
                
        <!-- Balance Section - NEW -->
        <div class="content-section" id="balance">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Current Balance Card -->
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                                <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold">{{ "{:,.2f}".format(user_balance|default(0)).replace(',', ' ') }} ‚ÇΩ</div>
                    </div>
                    <div class="text-sm opacity-90">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                    <div class="mt-2 text-xs opacity-75">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞</div>
                </div>

                <!-- Registration Bonus Card -->
                <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold">10 000 ‚ÇΩ</div>
                    </div>
                    <div class="text-sm opacity-90">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å</div>
                    <div class="mt-2 text-xs opacity-75">–ù–∞—á–∏—Å–ª–µ–Ω –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                </div>

                <!-- Total Earned Card -->
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold">{{ "{:,}".format(total_cashback|default(0)|int).replace(',', ' ') }} ‚ÇΩ</div>
                    </div>
                    <div class="text-sm opacity-90">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–µ—à–±–µ–∫–∞</div>
                    <div class="mt-2 text-xs opacity-75">–í—Å–µ–≥–æ –∑–∞ –≤—Ä–µ–º—è</div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞
                </h3>

                {% if balance_transactions and balance_transactions|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–∞—Ç–∞</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–∏–ø</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">–°—É–º–º–∞</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">–ë–∞–ª–∞–Ω—Å</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for transaction in balance_transactions %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ transaction.created_at.strftime('%d.%m.%Y %H:%M') }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    {{ transaction.description }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if transaction.transaction_type == 'registration_bonus' %}
                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800">
                                            –ë–æ–Ω—É—Å
                                        </span>
                                    {% elif transaction.transaction_type == 'cashback_earned' %}
                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-100 text-emerald-800">
                                            –ö–µ—à–±–µ–∫
                                        </span>
                                    {% elif transaction.transaction_type == 'withdrawal' %}
                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                            –í—ã–≤–æ–¥
                                        </span>
                                    {% else %}
                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            {{ transaction.transaction_type }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right font-medium
                                    {% if transaction.amount > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                                    {% if transaction.amount > 0 %}+{% endif %}{{ "{:,}".format(transaction.amount|int).replace(',', ' ') }} ‚ÇΩ
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                    {{ "{:,}".format(transaction.balance_after|int).replace(',', ' ') }} ‚ÇΩ
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <p class="text-gray-500 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Comparison Section -->
        <div class="content-section" id="comparison">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Properties Comparison Card -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="comparison-properties-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ö–≤–∞—Ä—Ç–∏—Ä –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏</div>
                    <div class="mt-2 text-xs opacity-75">–ì–æ—Ç–æ–≤—ã –∫ –∞–Ω–∞–ª–∏–∑—É</div>
                </div>

                <!-- Complexes Comparison Card -->
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2h6v4H7V6zm8 0h2v4h-2V6zM5 6h2v4H5V6zm0 6h2v4H5v-4zm4 0h6v4H9v-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="comparison-complexes-count">0</div>
                    </div>
                    <div class="text-sm opacity-90">–ñ–ö –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏</div>
                    <div class="mt-2 text-xs opacity-75">–ì–æ—Ç–æ–≤—ã –∫ –∞–Ω–∞–ª–∏–∑—É</div>
                </div>

                <!-- Total Comparison Card -->
                <div class="bg-gradient-to-br from-violet-500 to-fuchsia-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="window.location.href='/comparison'">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm opacity-90 font-semibold">–î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>
                    <div class="mt-2 text-xs opacity-75">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é —Ç–∞–±–ª–∏—Ü—É</div>
                </div>
            </div>
            
            <!-- Comparison Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Properties Comparison -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä</h3>
                        <button class="inline-flex items-center text-sm bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-xl hover:from-purple-600 hover:to-indigo-500 transition-all transform hover:scale-105 shadow-md hover:shadow-lg font-medium" onclick="window.location.href='/comparison'">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                            –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
                        </button>
                    </div>
                    <div id="properties-comparison-list" class="space-y-3">
                        <!-- Loading State -->
                        <div class="text-center py-12">
                            <div class="relative inline-block mb-6">
                                <div class="absolute inset-0 bg-indigo-500 opacity-25 rounded-full animate-ping"></div>
                                <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg">
                                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ...</p>
                            <p class="text-gray-500 text-sm mt-2">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É</p>
                        </div>
                    </div>
                </div>
                
                <!-- Complexes Comparison -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ñ–ö</h3>
                        <button class="inline-flex items-center text-sm bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-4 py-2 rounded-xl hover:from-cyan-600 hover:to-blue-500 transition-all transform hover:scale-105 shadow-md hover:shadow-lg font-medium" onclick="window.location.href='/comparison'">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                            –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
                        </button>
                    </div>
                    <div id="complexes-comparison-list" class="space-y-3">
                        <!-- Loading State -->
                        <div class="text-center py-12">
                            <div class="relative inline-block mb-6">
                                <div class="absolute inset-0 bg-blue-500 opacity-25 rounded-full animate-ping"></div>
                                <div class="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-full shadow-lg">
                                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-gray-700 font-medium text-lg">–ó–∞–≥—Ä—É–∂–∞–µ–º –ñ–ö...</p>
                            <p class="text-gray-500 text-sm mt-2">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden elements for comparison.js compatibility -->
        <div class="hidden">
            <div id="quickComparisonGrid"></div>
            <div id="detailedComparisonContainer"></div>
        </div>
    </div>
</div>


<!-- Data Management Section (Admins Only) -->
<div class="content-section" id="data-management">
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <div class="text-center bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-8 mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full mb-4">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ Excel</h2>
            <p class="text-lg text-gray-600 mb-6">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
            
            <!-- Status Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-properties">
                    <div class="text-2xl font-bold text-purple-600">...</div>
                    <div class="text-sm text-gray-600">–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ë–î</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-complexes">
                    <div class="text-2xl font-bold text-blue-600">...</div>
                    <div class="text-sm text-gray-600">–ñ–ö</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-developers">
                    <div class="text-2xl font-bold text-green-600">...</div>
                    <div class="text-sm text-gray-600">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-columns">
                    <div class="text-2xl font-bold text-orange-600">77</div>
                    <div class="text-sm text-gray-600">–ö–æ–ª–æ–Ω–æ–∫ Excel</div>
                </div>
            </div>
        </div>
        
        <!-- Upload Excel Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- File Upload Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞
                </h3>
                
                <form id="excel-upload-form" enctype="multipart/form-data" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition-colors" id="upload-area">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="mt-4">
                            <label for="excel-file" class="cursor-pointer">
                                <span class="mt-2 block text-sm font-medium text-gray-900">
                                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏
                                </span>
                                <span class="text-purple-600 hover:text-purple-500">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
                            </label>
                            <input type="file" id="excel-file" name="excel_file" accept=".xlsx,.xls" class="hidden">
                        </div>
                        <p class="mt-2 text-xs text-gray-500">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .xlsx, .xls (–¥–æ 50 –ú–ë)</p>
                    </div>
                    
                    <!-- Upload Options -->
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="replace-data" name="replace_data" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="auto-sync" name="auto_sync" checked class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ñ–ö</span>
                        </label>
                    </div>
                    
                    <button type="submit" id="upload-btn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 px-4 rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
                        </span>
                    </button>
                </form>
                
                <!-- Progress Bar -->
                <div id="upload-progress" class="hidden mt-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Testing & Validation Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
                </h3>
                
                <div class="space-y-3">
                    <button onclick="runFullSystemTest()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-4 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
                        </span>
                    </button>
                    
                    <button onclick="testColumnMapping()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 77 –∫–æ–ª–æ–Ω–æ–∫
                        </span>
                    </button>
                    
                    <button onclick="testNewDataCreation()" class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-3 px-4 rounded-lg font-medium hover:from-orange-700 hover:to-orange-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ñ–ö
                        </span>
                    </button>
                    
                    <button onclick="validateDataIntegrity()" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 px-4 rounded-lg font-medium hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                        </span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="test-results" class="mt-8 bg-gray-50 rounded-xl p-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="test-output" class="bg-white rounded-lg p-4 border max-h-96 overflow-y-auto">
                <pre class="text-sm text-gray-700 whitespace-pre-wrap" id="test-log"></pre>
            </div>
        </div>
        
        <!-- Upload Results -->
        <div id="upload-results" class="mt-8 bg-gray-50 rounded-xl p-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <div id="upload-output" class="bg-white rounded-lg p-4 border">
                <div id="upload-log" class="text-sm text-gray-700"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤
function pluralize(count, one, few, many) {
    const mod10 = count % 10;
    const mod100 = count % 100;
    
    if (mod10 === 1 && mod100 !== 11) {
        return one;  // 1, 21, 31... –∫–≤–∞—Ä—Ç–∏—Ä–∞
    } else if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
        return few;  // 2-4, 22-24... –∫–≤–∞—Ä—Ç–∏—Ä—ã
    } else {
        return many; // 0, 5-20, 25-30... –∫–≤–∞—Ä—Ç–∏—Ä
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–ª–æ–Ω–µ–Ω–∏–µ–º
function updateFavoritesCounter(count) {
    const countElement = document.getElementById('favorites-count');
    const labelElement = document.getElementById('favorites-count-label');
    
    if (countElement) countElement.textContent = count;
    if (labelElement) labelElement.textContent = pluralize(count, '–∫–≤–∞—Ä—Ç–∏—Ä–∞', '–∫–≤–∞—Ä—Ç–∏—Ä—ã', '–∫–≤–∞—Ä—Ç–∏—Ä');
}


// Dashboard tab switching functionality
(function() {
    'use strict';
    
    function initializeDashboardTabs() {
        console.log('Initializing dashboard tabs...');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentSections = document.querySelectorAll('.content-section');
        
        console.log('Found tab buttons:', tabButtons.length);
        console.log('Found content sections:', contentSections.length);
        
        if (tabButtons.length === 0) {
            console.warn('No tab buttons found');
            return;
        }
        
        tabButtons.forEach(function(button, index) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Tab clicked:', this.dataset.page);
                
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Ç–∞–±—ã –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                if (this.dataset.page === 'favorites' || this.dataset.page === 'comparison') {
                    updateTopMenuCounters();
                }
                
                // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                if (this.dataset.page === 'recommendations') {
                    console.log('üì¶ Loading collections for recommendations tab...');
                    if (typeof loadUserCollections === 'function') {
                        loadUserCollections();
                    }
                }
                
                // Remove active class from all buttons
                tabButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                    btn.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Hide all content sections
                contentSections.forEach(function(section) {
                    section.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                this.classList.remove('border-transparent', 'text-gray-500');
                this.classList.add('border-[#0088CC]', 'text-[#0088CC]');
                
                // Show corresponding content section
                const targetPage = this.dataset.page;
                const targetSection = document.getElementById(targetPage);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log('Activated section:', targetPage);
                    
                    // Load favorites when favorites section is activated
                    if (targetPage === 'favorites') {
                        console.log('Loading favorites list...');
                        setTimeout(() => {
                            loadFavoritesList(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –∏ –ñ–ö (—á–µ—Ä–µ–∑ createComplexCard)
                            updateFavoritesCounters(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
                        }, 100);
                    }
                    
                    // Load comparison content when comparison section is activated
                    if (targetPage === 'comparison') {
                        console.log('Loading comparison content...');
                        setTimeout(() => {
                            loadComparisonContent();
                            updateDashboardCounters();
                        }, 100);
                    }
                } else {
                    console.warn('Target section not found:', targetPage);
                }
            });
        });
        
        console.log('Dashboard tabs initialized successfully');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDashboardTabs);
    } else {
        initializeDashboardTabs();
    }
    
    // Handle hash navigation (e.g., /dashboard#favorites)
    function handleHashNavigation() {
        const hash = window.location.hash.substring(1); // Remove # from hash
        if (hash) {
            console.log('Hash detected:', hash);
            const tabButton = document.querySelector(`.tab-button[data-page="${hash}"]`);
            if (tabButton) {
                console.log('Clicking tab button for:', hash);
                tabButton.click();
            }
        }
    }
    
    // Handle hash on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', handleHashNavigation);
    } else {
        setTimeout(handleHashNavigation, 100); // Small delay to ensure tabs are initialized
    }
    
    // Handle hash changes (when clicking browser back/forward)
    window.addEventListener('hashchange', handleHashNavigation);
})();

// ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ dashboard
// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —Å—á–µ—Ç—á–∏–∫–∏ –∏ —Å–¥–µ–ª–∫–∏ —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –∫–ª–∏–∫–æ–≤ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
(function preloadDashboardData() {
    console.log('üöÄ Dashboard: Starting data preload...');
    
    // ‚úÖ –£–î–ê–õ–ï–ù–û: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –∫–ª–∏–∫ –ø–æ —Ç–∞–±—É
    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ API –∑–∞–ø—Ä–æ—Å—ã
    // loadFavoritesList() —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–∞–± "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤
    setTimeout(() => {
        console.log('üìä Preloading counters...');
        if (typeof updateDashboardCounters === 'function') {
            updateDashboardCounters();
        }
        if (typeof updateFavoritesCounters === 'function') {
            updateFavoritesCounters();
        }
        if (typeof updateTopMenuCounters === 'function') {
            updateTopMenuCounters();
        }
    }, 300);
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö
    setTimeout(() => {
        console.log('üìä Preloading deals data...');
        if (typeof loadDeals === 'function') {
            loadDeals().catch(err => {
                console.error('‚ùå Error preloading deals:', err);
            });
        }
    }, 1000);
    
    console.log('‚úÖ Dashboard preload initiated');
})();

// ‚úÖ –£–î–ê–õ–ï–ù–û: –î—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è loadComplexFavorites —Å —à–∞–±–ª–æ–Ω–æ–º heart icon
// –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ createComplexCard() —Å –∫–Ω–æ–ø–∫–æ–π "–£–¥–∞–ª–∏—Ç—å" —á–µ—Ä–µ–∑ loadFavoritesList()

// Load favorites list for dashboard - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 2-—Ö
async function loadFavoritesList() {
    console.log('‚ö° loadFavoritesList: –ù–ê–ß–ê–õ–û (1 –∑–∞–ø—Ä–æ—Å)');
    const favoritesContainer = document.getElementById('favorites-list');
    const loadingElement = document.getElementById('favorites-loading');
    const emptyElement = document.getElementById('favorites-empty');
    const complexLoadingElement = document.getElementById('complex-loading');
    const complexEmptyElement = document.getElementById('complex-empty');
    const complexFavoritesList = document.getElementById('complex-favorites-list');
    
    if (!favoritesContainer) {
        console.error('Favorites container not found');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    if (loadingElement) loadingElement.classList.remove('hidden');
    if (emptyElement) emptyElement.classList.add('hidden');
    if (complexLoadingElement) complexLoadingElement.classList.remove('hidden');
    if (complexEmptyElement) complexEmptyElement.classList.add('hidden');
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–µ loading/empty —ç–ª–µ–º–µ–Ω—Ç—ã)
    const existingCards = favoritesContainer.querySelectorAll('.property-card-wrapper, .favorite-card, [data-favorite-card], .border:not(#favorites-loading):not(#favorites-empty)');
    existingCards.forEach(card => card.remove());
    
    if (complexFavoritesList) {
        const existingComplexCards = complexFavoritesList.querySelectorAll('.border:not(#complex-loading):not(#complex-empty)');
        existingComplexCards.forEach(card => card.remove());
    }
    
    // ‚ö° –û–î–ò–ù –ó–ê–ü–†–û–° –¥–ª—è –≤—Å–µ–≥–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    try {
        const response = await fetch('/api/favorites/all', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚ö° –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ 1 –∑–∞–ø—Ä–æ—Å - –∫–≤–∞—Ä—Ç–∏—Ä—ã:', data.properties?.length || 0, '–ñ–ö:', data.complexes?.length || 0);
        
        let totalCount = 0;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
        if (data.properties && data.properties.length > 0) {
            data.properties.forEach((favorite) => {
                const favoriteCard = createFavoriteCard(favorite, !favorite.viewed);
                favoritesContainer.appendChild(favoriteCard);
                totalCount++;
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ñ–ö
        let complexCount = 0;
        if (data.complexes && data.complexes.length > 0 && complexFavoritesList) {
            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–µ loading/empty —ç–ª–µ–º–µ–Ω—Ç—ã
            const existingComplexCards = complexFavoritesList.querySelectorAll('.border:not(#complex-loading):not(#complex-empty)');
            existingComplexCards.forEach(card => card.remove());
            
            data.complexes.forEach((complex, index) => {
                const complexCard = createComplexCard(complex, !complex.viewed);
                complexFavoritesList.appendChild(complexCard);
                complexCount++;
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        if (loadingElement) loadingElement.classList.add('hidden');
        if (complexLoadingElement) complexLoadingElement.classList.add('hidden');
        
        if (totalCount === 0 && emptyElement) {
            emptyElement.classList.remove('hidden');
        }
        
        if (complexCount === 0 && complexEmptyElement) {
            complexEmptyElement.classList.remove('hidden');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        updateFavoritesCounter(totalCount);
        
        console.log('‚úÖ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ 1 –∑–∞–ø—Ä–æ—Å:', totalCount + complexCount);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
        if (loadingElement) loadingElement.classList.add('hidden');
        if (complexLoadingElement) complexLoadingElement.classList.add('hidden');
        if (emptyElement) emptyElement.classList.remove('hidden');
        if (complexEmptyElement) complexEmptyElement.classList.remove('hidden');
    }
}

function createFavoriteCard(favorite, isNew = false) {
    const priceFormatted = favorite.price ? favorite.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è';
    const cashbackFormatted = favorite.cashback_amount ? '+' + favorite.cashback_amount.toLocaleString('ru-RU') + ' ‚ÇΩ' : '';
    
    const cardElement = document.createElement('div');
    cardElement.className = `border border-gray-200 rounded-lg p-4 hover:border-red-300 transition-colors ${isNew ? 'border-l-4 border-l-green-400' : ''}`;
    
    cardElement.innerHTML = `
        <div class="flex items-start space-x-4">
            <img src="${favorite.image}" 
                 alt="–ö–≤–∞—Ä—Ç–∏—Ä–∞" class="w-16 h-12 object-cover rounded-lg">
            <div class="flex-1">
                <div class="flex items-center">
                    <h4 class="font-medium text-gray-900 text-sm">${favorite.title} –≤ ${favorite.complex}</h4>
                    ${isNew ? '<span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded">–ù–æ–≤–æ–µ</span>' : ''}
                </div>
                <p class="text-xs text-gray-600 mt-1">${favorite.district} ‚Ä¢ –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</p>
                <p class="text-xs text-gray-500 mt-1">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${favorite.created_at || '–ù–µ–¥–∞–≤–Ω–æ'}</p>
                <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-gray-900">${priceFormatted}</span>
                        ${cashbackFormatted ? `<span class="text-xs text-green-600 ml-1">${cashbackFormatted}</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-[#0088CC] hover:bg-blue-50 px-2 py-1 rounded text-xs" onclick="viewFavoriteProperty('${favorite.id}')">
                            –°–º–æ—Ç—Ä–µ—Ç—å
                        </button>
                        <button class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs" onclick="removePropertyFromFavorites('${favorite.id}', this.closest('.border'))">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return cardElement;
}

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ñ–ö
function createComplexCard(complex, isNew = false) {
    const priceFormatted = complex.min_price ? `–æ—Ç ${(complex.min_price / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ` : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è';
    const cashbackRate = complex.cashback_rate || 5; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à–±–µ–∫ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    
    // ‚úÖ –õ–û–ì–ò–ö–ê –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ñ–æ—Ç–æ –ñ–ö
    let complexImage = complex.image || 'https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?ixlib=rb-4.0.3&auto=format&fit=crop&w=80&h=60&q=80';
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ photos, –±–µ—Ä–µ–º –≤—Ç–æ—Ä—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é (–∏–Ω–¥–µ–∫—Å 1)
    if (complex.photos && Array.isArray(complex.photos) && complex.photos.length > 1) {
        complexImage = complex.photos[1];
    }
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ photos —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º, –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏ –≤–∑—è—Ç—å –≤—Ç–æ—Ä—É—é
    else if (complex.photos && typeof complex.photos === 'string') {
        const photosArray = complex.photos.split(',').map(p => p.trim()).filter(p => p);
        if (photosArray.length > 1) {
            complexImage = photosArray[1];
        }
    }
    
    const cardElement = document.createElement('div');
    cardElement.className = `border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors ${isNew ? 'border-l-4 border-l-green-400' : ''}`;
    
    cardElement.innerHTML = `
        <div class="flex items-start space-x-4">
            <img src="${complexImage}" 
                 alt="–ñ–ö" class="w-16 h-12 object-cover rounded-lg">
            <div class="flex-1">
                <div class="flex items-center">
                    <h4 class="font-medium text-gray-900 text-sm">${complex.name}</h4>
                    ${isNew ? '<span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded">–ù–æ–≤–æ–µ</span>' : ''}
                </div>
                <p class="text-xs text-gray-600 mt-1">${complex.developer || '–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                <p class="text-xs text-gray-500 mt-1">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${complex.created_at || '–ù–µ–¥–∞–≤–Ω–æ'}</p>
                <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-gray-900">${priceFormatted}</span>
                        <span class="text-xs text-green-600 ml-1">–∫–µ—à–±–µ–∫ ${cashbackRate}%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-[#0088CC] hover:bg-blue-50 px-2 py-1 rounded text-xs" onclick="viewComplexFavorite('${complex.id}')">
                            –°–º–æ—Ç—Ä–µ—Ç—å
                        </button>
                        <button class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs" onclick="removeComplexFromFavorites('${complex.id}', this.closest('.border'))">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return cardElement;
}

// ‚úÖ –§–£–ù–ö–¶–ò–ò –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ–≥–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function clearAllPropertyFavorites() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã?')) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        fetch('/api/favorites/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                const favoritesList = document.getElementById('favorites-list');
                const favoritesEmpty = document.getElementById('favorites-empty');
                const favoritesLoading = document.getElementById('favorites-loading');
                
                if (favoritesList) {
                    favoritesList.innerHTML = '';
                    favoritesList.appendChild(favoritesLoading);
                    favoritesList.appendChild(favoritesEmpty);
                    favoritesLoading.classList.add('hidden');
                    favoritesEmpty.classList.remove('hidden');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateDashboardCounters();
                updateTopMenuCounters();
                
                console.log('‚úÖ –í—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã —É–¥–∞–ª–µ–Ω—ã');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        });
    }
}

function clearAllComplexFavorites() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö?')) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö
        fetch('/api/complexes/favorites/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                const complexFavoritesList = document.getElementById('complex-favorites-list');
                
                if (complexFavoritesList) {
                    // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ñ–ö
                    const existingCards = complexFavoritesList.querySelectorAll('.border');
                    existingCards.forEach(card => card.remove());
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateDashboardCounters();
                updateTopMenuCounters();
                
                console.log('‚úÖ –í—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö —É–¥–∞–ª–µ–Ω—ã');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö');
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å –æ—Ç–º–µ—Ç–∫–æ–π –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ
async function viewFavoriteProperty(propertyId) {
    try {
        // –û—Ç–º–µ—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π
        await fetch(`/api/favorites/mark-viewed/${propertyId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±—ä–µ–∫—Ç–∞
        window.location.href = `/object/${propertyId}`;
    } catch (error) {
        console.error('Error marking favorite as viewed:', error);
        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å
        window.location.href = `/object/${propertyId}`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ñ–ö —Å –æ—Ç–º–µ—Ç–∫–æ–π –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ
async function viewComplexFavorite(complexId) {
    try {
        // –û—Ç–º–µ—á–∞–µ–º –ñ–ö –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π
        await fetch(`/api/complexes/favorites/mark-viewed/${complexId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ñ–ö
        window.location.href = `/residential-complex/${complexId}`;
    } catch (error) {
        console.error('Error marking complex favorite as viewed:', error);
        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å
        window.location.href = `/residential-complex/${complexId}`;
    }
}

// ‚úÖ –§–£–ù–ö–¶–ò–ò –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function removePropertyFromFavorites(propertyId, cardElement) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
        fetch(`/api/favorites/${propertyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ UI
                if (cardElement) {
                    cardElement.style.opacity = '0.5';
                    setTimeout(() => {
                        cardElement.remove();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                        updateDashboardCounters();
                        updateTopMenuCounters();
                        if (typeof updateHeaderFavoritesCount === 'function') {
                            updateHeaderFavoritesCount();
                        }
                    }, 200);
                }
                console.log('‚úÖ –ö–≤–∞—Ä—Ç–∏—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', propertyId);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        });
    }
}

function removeComplexFromFavorites(complexId, cardElement) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ñ–ö
        fetch(`/api/complexes/favorites/${complexId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ UI
                if (cardElement) {
                    cardElement.style.opacity = '0.5';
                    setTimeout(() => {
                        cardElement.remove();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                        updateDashboardCounters();
                        updateTopMenuCounters();
                        if (typeof updateHeaderFavoritesCount === 'function') {
                            updateHeaderFavoritesCount();
                        }
                    }, 200);
                }
                console.log('‚úÖ –ñ–ö —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', complexId);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        });
    }
}
</script>

<!-- Dashboard JavaScript Modules -->
<!-- favorites.js is loaded in base.html to avoid duplicate loading -->
<script src="{{ url_for('static', filename='js/saved_searches.js') }}"></script>
<script src="{{ url_for('static', filename='js/alert-settings.js') }}"></script>

<script>
// Dashboard initialization and counter updates
(function() {
    'use strict';
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤–µ–∑–¥–µ
    window.updateDashboardCounters = function updateDashboardCounters() {
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–≤–∞—Ä—Ç–∏—Ä - –∑–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç updateFavoritesCounters()
        // –°—á–µ—Ç—á–∏–∫ –∫–≤–∞—Ä—Ç–∏—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Ç–∞–± "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Update complex favorites counters from API
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        fetch('/api/complexes/favorites/list')
            .then(response => response.json())
            .then(data => {
                const complexesCount = data.complexes ? data.complexes.length : 0;
                const complexFavCountElement = document.getElementById('complex-favorites-count');
                if (complexFavCountElement) complexFavCountElement.textContent = complexesCount;
                console.log('üî• Dashboard: Updated complex favorites counter:', complexesCount);
            })
            .catch(error => {
                console.log('Could not load complex favorites count');
            });
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Update comparison counters from multiple sources
        // Try new format first, then fallback to old formats
        let comparisonProperties = JSON.parse(localStorage.getItem('comparisons') || '[]');
        if (comparisonProperties.length === 0) {
            comparisonProperties = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
        }
        
        const comparisonComplexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        
        const propCompCountElement = document.getElementById('comparison-properties-count');
        const complexCompCountElement = document.getElementById('comparison-complexes-count');
        
        if (propCompCountElement) propCompCountElement.textContent = comparisonProperties.length;
        if (complexCompCountElement) complexCompCountElement.textContent = comparisonComplexes.length;
        
        // Update saved searches counter
        updateSavedSearchesCounter();
    }
    
    function updateSavedSearchesCounter() {
        // This will be updated by the SavedSearchesManager when it loads
        fetch('/api/user/saved-searches/count')
            .then(response => response.json())
            .then(data => {
                const savedSearchesCountElement = document.getElementById('saved-searches-count');
                if (savedSearchesCountElement && data.success) {
                    savedSearchesCountElement.textContent = data.count;
                }
            })
            .catch(error => {
                console.log('Could not load saved searches count');
            });
    }

    // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–µ–Ω—é
    window.updateTopMenuCounters = function updateTopMenuCounters() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–µ–Ω—é (–∫–≤–∞—Ä—Ç–∏—Ä—ã + –ñ–ö)
        Promise.all([
            fetch('/api/favorites/list').then(r => r.json()),
            fetch('/api/complexes/favorites/list').then(r => r.json())
        ]).then(([propertiesData, complexesData]) => {
            const propertiesCount = propertiesData.success ? (propertiesData.favorites?.length || 0) : 0;
            const complexesCount = complexesData.complexes?.length || 0;
            const totalFavoritesCount = propertiesCount + complexesCount;
            
            const topFavElement = document.getElementById('top-favorites-count');
            if (topFavElement) {
                topFavElement.textContent = totalFavoritesCount;
                console.log('üè† –û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –º–µ–Ω—é:', totalFavoritesCount, '(', propertiesCount, '–∫–≤–∞—Ä—Ç–∏—Ä +', complexesCount, '–ñ–ö)');
            }
        }).catch(error => console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –º–µ–Ω—é:', error));

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–µ–Ω—é
        updateComparisonCounterMenu();
    };

    // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –º–µ–Ω—é
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑ API
    window.updateComparisonCounterMenu = async function updateComparisonCounterMenu() {
        try {
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API...');
            
            let propertiesCount = 0;
            let complexesCount = 0;
            
            // ‚úÖ FIX: Use the improved /api/user/comparison/load endpoint that returns counts
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/load' : '/api/user/comparison/load';
            
            try {
                const response = await fetch(endpoint);
                if (response.ok) {
                    const data = await response.json();
                    propertiesCount = data.properties_count || (data.properties ? data.properties.length : 0);
                    complexesCount = data.complexes_count || (data.complexes ? data.complexes.length : 0);
                    console.log('üè† –ö–≤–∞—Ä—Ç–∏—Ä –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –∏–∑ API:', propertiesCount);
                    console.log('üè¢ –ñ–ö –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –∏–∑ API:', complexesCount);
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', error);
            }
            
            // –û–±—â–∏–π —Å—á–µ—Ç—á–∏–∫
            const totalCount = propertiesCount + complexesCount;
            
            const compElement = document.getElementById('comparison-count');
            if (compElement) {
                compElement.textContent = totalCount;
                console.log('‚öñÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –º–µ–Ω—é:', totalCount, '(', propertiesCount, '–∫–≤–∞—Ä—Ç–∏—Ä +', complexesCount, '–ñ–ö)');
            }
            
            // Also update detailed counters if they exist
            const propCompCountElement = document.getElementById('comparison-properties-count');
            const complexCompCountElement = document.getElementById('comparison-complexes-count');
            if (propCompCountElement) propCompCountElement.textContent = propertiesCount;
            if (complexCompCountElement) complexCompCountElement.textContent = complexesCount;
        } catch (error) {
            console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', error);
        }
    };
    
    function loadFavoritesContent() {
        console.log('üî• Dashboard: loadFavoritesContent() –≥–æ—Ç–æ–≤–∞ (–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ç–∞–±)');
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å - –æ–Ω–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–∞–± "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ API –∑–∞–ø—Ä–æ—Å—ã
        // loadFavoritesList() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–ª–∏–∫–∞ –ø–æ —Ç–∞–±—É (line ~1857)
    }
    
    // ‚úÖ –ù–û–í–ê–Ø –ü–†–û–°–¢–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    async function showFavoritesCards() {
        console.log('üöÄ showFavoritesCards() –ó–ê–ü–£–©–ï–ù–ê!');
        
        const container = document.getElementById('new-favorites-container');
        const loading = document.getElementById('new-favorites-loading');
        const empty = document.getElementById('new-favorites-empty');
        
        if (!container) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä new-favorites-container –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }
        
        console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        container.innerHTML = '';
        
        let totalCards = 0;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
        try {
            console.log('üì° –ó–∞–≥—Ä—É–∂–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—ã...');
            const response = await fetch('/api/favorites/list');
            if (response.ok) {
                const data = await response.json();
                console.log('üè† –ö–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã:', data.success ? data.favorites?.length || 0 : 0);
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    data.favorites.forEach(item => {
                        const card = createSimpleCard(item, '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä:', error);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ñ–ö
        try {
            console.log('üì° –ó–∞–≥—Ä—É–∂–∞—é –ñ–ö...');
            const response = await fetch('/api/complexes/favorites/list');
            if (response.ok) {
                const data = await response.json();
                console.log('üè¢ –ñ–ö –ø–æ–ª—É—á–µ–Ω—ã:', data.complexes?.length || 0);
                
                if (data.complexes && data.complexes.length > 0) {
                    data.complexes.forEach(item => {
                        const card = createSimpleCard(item, '–∂–∫');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö:', error);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        loading.classList.add('hidden');
        
        if (totalCards > 0) {
            console.log('üéâ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', totalCards);
        } else {
            empty.classList.remove('hidden');
            console.log('üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }
    }
    
    // ‚úÖ –°–û–ó–î–ê–ù–ò–ï –ü–†–û–°–¢–´–• –ö–ê–†–¢–û–ß–ï–ö
    function createSimpleCard(item, type) {
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
        
        const isProperty = type === '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
        const title = isProperty ? item.title : item.name;
        const price = isProperty ? 
            (item.price ? item.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è') :
            (item.min_price ? '–æ—Ç ' + item.min_price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è');
        
        card.innerHTML = `
            <div class="flex items-start space-x-3">
                <img src="${item.image || '/static/images/default-property.jpg'}" 
                     alt="${title}" 
                     class="w-16 h-12 object-cover rounded">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 text-sm truncate">${title}</h4>
                    <p class="text-xs text-gray-500 mt-1">${isProperty ? item.complex : item.address}</p>
                    <p class="text-sm font-semibold text-blue-600 mt-2">${price}</p>
                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded mt-2">
                        ${type === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' ? 'üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞' : 'üè¢ –ñ–ö'}
                    </span>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    window.displayFavoritesNow = async function() {
        console.log('üöÄüöÄüöÄ displayFavoritesNow() –ó–ê–ü–£–©–ï–ù–ê –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û!');
        
        const container = document.getElementById('new-favorites-container');
        const loading = document.getElementById('new-favorites-loading');
        const empty = document.getElementById('new-favorites-empty');
        
        if (!container) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä new-favorites-container –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            alert('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }
        
        console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        container.innerHTML = '';
        
        let totalCards = 0;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
        try {
            console.log('üì° –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–≥—Ä—É–∂–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—ã...');
            const response = await fetch('/api/favorites/list');
            console.log('üì° Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('üè† –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–ª—É—á–µ–Ω—ã –∫–≤–∞—Ä—Ç–∏—Ä—ã:', data.success ? data.favorites?.length || 0 : 0);
                console.log('üè† –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä:', data);
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    data.favorites.forEach((item, index) => {
                        console.log(`üè† –°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–æ—á–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã ${index + 1}:`, item.title);
                        const card = createSimpleCard(item, '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ response –∫–≤–∞—Ä—Ç–∏—Ä:', response.status);
            }
        } catch (error) {
            console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä:', error);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ñ–ö
        try {
            console.log('üì° –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–≥—Ä—É–∂–∞—é –ñ–ö...');
            const response = await fetch('/api/complexes/favorites/list');
            console.log('üì° –ñ–ö Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('üè¢ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–ª—É—á–µ–Ω—ã –ñ–ö:', data.complexes?.length || 0);
                console.log('üè¢ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ñ–ö:', data);
                
                if (data.complexes && data.complexes.length > 0) {
                    data.complexes.forEach((item, index) => {
                        console.log(`üè¢ –°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–æ—á–∫—É –ñ–ö ${index + 1}:`, item.name);
                        const card = createSimpleCard(item, '–∂–∫');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ response –ñ–ö:', response.status);
            }
        } catch (error) {
            console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö:', error);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        loading.classList.add('hidden');
        
        if (totalCards > 0) {
            console.log('üéâ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', totalCards);
            alert(`üéâ –ü–æ–∫–∞–∑–∞–Ω–æ ${totalCards} –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ!`);
        } else {
            empty.classList.remove('hidden');
            console.log('üì≠ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            alert('üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }
    }
    
    // ‚úÖ –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 2-—Ö –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤
    window.updateFavoritesCounters = async function() {
        console.log('‚ö° updateFavoritesCounters: –ù–ê–ß–ê–õ–û (1 –∑–∞–ø—Ä–æ—Å)');
        
        try {
            const response = await fetch('/api/favorites/all');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const propCount = data.properties?.length || 0;
            const complexCount = data.complexes?.length || 0;
            
            console.log('‚ö° –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ 1 –∑–∞–ø—Ä–æ—Å - –∫–≤–∞—Ä—Ç–∏—Ä—ã:', propCount, '–ñ–ö:', complexCount);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–≤–∞—Ä—Ç–∏—Ä
            const countElement = document.getElementById('favorites-count');
            if (countElement) {
                countElement.textContent = propCount;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ñ–ö
            const complexCountElement = document.getElementById('complex-favorites-count');
            if (complexCountElement) {
                complexCountElement.textContent = complexCount;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ "–í—Å–µ–≥–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º"
            const totalCountElement = document.getElementById('total-favorites-count');
            if (totalCountElement) {
                totalCountElement.textContent = propCount + complexCount;
            }
            
            console.log('‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞ 1 –∑–∞–ø—Ä–æ—Å!');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤:', error);
        }
    }
    
    // ‚≠ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–û–í–û–ì–û –¢–ê–ë–ê: –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    window.loadMyFavorites = async function() {
        console.log('‚≠ê‚≠ê‚≠ê loadMyFavorites() –ó–ê–ü–£–©–ï–ù–ê –î–õ–Ø –ù–û–í–û–ì–û –¢–ê–ë–ê!');
        
        const loading = document.getElementById('my-fav-loading');
        const grid = document.getElementById('my-fav-grid');
        const empty = document.getElementById('my-fav-empty');
        const counter = document.getElementById('my-fav-count');
        
        if (!loading || !grid || !empty) {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
            alert('‚ùå –û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞ –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        grid.innerHTML = '';
        
        let totalCount = 0;
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
            console.log('üì° [–ù–û–í–´–ô –¢–ê–ë] –ó–∞–≥—Ä—É–∂–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—ã...');
            const propResponse = await fetch('/api/favorites/list');
            console.log('üì° [–ù–û–í–´–ô –¢–ê–ë] Response –∫–≤–∞—Ä—Ç–∏—Ä status:', propResponse.status);
            
            if (propResponse.ok) {
                const propData = await propResponse.json();
                console.log('üè† [–ù–û–í–´–ô –¢–ê–ë] –î–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä:', propData);
                
                if (propData.success && propData.favorites && propData.favorites.length > 0) {
                    propData.favorites.forEach((item, index) => {
                        console.log(`üè† [–ù–û–í–´–ô –¢–ê–ë] –°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–æ—á–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã ${index + 1}:`, item.title);
                        const card = createMyFavCard(item, '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                        grid.appendChild(card);
                        totalCount++;
                    });
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ñ–ö
            console.log('üì° [–ù–û–í–´–ô –¢–ê–ë] –ó–∞–≥—Ä—É–∂–∞—é –ñ–ö...');
            const complexResponse = await fetch('/api/complexes/favorites/list');
            console.log('üì° [–ù–û–í–´–ô –¢–ê–ë] Response –ñ–ö status:', complexResponse.status);
            
            if (complexResponse.ok) {
                const complexData = await complexResponse.json();
                console.log('üè¢ [–ù–û–í–´–ô –¢–ê–ë] –î–∞–Ω–Ω—ã–µ –ñ–ö:', complexData);
                
                if (complexData.complexes && complexData.complexes.length > 0) {
                    complexData.complexes.forEach((item, index) => {
                        console.log(`üè¢ [–ù–û–í–´–ô –¢–ê–ë] –°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–æ—á–∫—É –ñ–ö ${index + 1}:`, item.name);
                        const card = createMyFavCard(item, '–∂–∫');
                        grid.appendChild(card);
                        totalCount++;
                    });
                }
            }
            
        } catch (error) {
            console.error('‚ùå [–ù–û–í–´–ô –¢–ê–ë] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        loading.classList.add('hidden');
        
        if (totalCount > 0) {
            console.log('üéâ [–ù–û–í–´–ô –¢–ê–ë] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', totalCount);
            if (counter) counter.textContent = totalCount;
            alert(`üéâ –í –Ω–æ–≤–æ–º —Ç–∞–±–µ –ø–æ–∫–∞–∑–∞–Ω–æ ${totalCount} –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ!`);
        } else {
            empty.classList.remove('hidden');
            console.log('üì≠ [–ù–û–í–´–ô –¢–ê–ë] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            alert('üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–æ–≤–æ–º —Ç–∞–±–µ');
        }
    }
    
    // ‚≠ê –°–û–ó–î–ê–ù–ò–ï –ö–ê–†–¢–û–ß–ï–ö –î–õ–Ø –ù–û–í–û–ì–û –¢–ê–ë–ê
    function createMyFavCard(item, type) {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1';
        
        const isProperty = type === '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
        const title = isProperty ? item.title : item.name;
        const price = isProperty ? 
            (item.price ? item.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è') :
            (item.min_price ? '–æ—Ç ' + item.min_price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è');
        
        const typeIcon = isProperty ? 'üè†' : 'üè¢';
        const typeText = isProperty ? '–ö–≤–∞—Ä—Ç–∏—Ä–∞' : '–ñ–ö';
        const location = isProperty ? item.complex : item.address;
        
        card.innerHTML = `
            <div class="flex flex-col h-full">
                <div class="relative mb-4">
                    <img src="${item.image || '/static/images/default-property.jpg'}" 
                         alt="${title}" 
                         class="w-full h-48 object-cover rounded-lg">
                    <span class="absolute top-2 right-2 bg-green-600 text-white text-xs px-3 py-1 rounded-full font-medium">
                        ${typeIcon} ${typeText}
                    </span>
                </div>
                
                <div class="flex-1 flex flex-col">
                    <h4 class="font-bold text-gray-900 text-lg mb-2 line-clamp-2">${title}</h4>
                    <p class="text-sm text-gray-600 mb-3 flex-1">${location}</p>
                    <div class="border-t pt-4">
                        <p class="text-xl font-bold text-green-600 mb-3">${price}</p>
                        <button class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: PostgreSQL + localStorage –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö URL
    window.loadComparisonContent = async function loadComparisonContent() {
        let comparisonProperties = [];
        let comparisonComplexes = [];
        
        try {
            // üî• –ù–û–í–û–ï: –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ PostgreSQL API
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/load' : '/api/user/comparison/load';
            const response = await fetch(endpoint);
            const data = await response.json();
            
            if (data.success) {
                comparisonProperties = (data.properties || []).map(p => String(p));
                comparisonComplexes = (data.complexes || []).map(c => String(c));
                console.log('‚úÖ –î–∞—à–±–æ—Ä–¥: –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ PostgreSQL - –∫–≤–∞—Ä—Ç–∏—Ä—ã:', comparisonProperties.length, '–ñ–ö:', comparisonComplexes.length);
            } else {
                throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
            }
        } catch (error) {
            console.log('‚ÑπÔ∏è –î–∞—à–±–æ—Ä–¥: PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage fallback');
            
            // üì¶ FALLBACK: –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            comparisonProperties = JSON.parse(localStorage.getItem('comparisons') || '[]');
            
            // Fallback to comparison-data format if comparisons is empty
            if (comparisonProperties.length === 0) {
                const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
                comparisonProperties = comparisonData.properties || [];
            }
            
            // Last fallback to old format
            if (comparisonProperties.length === 0) {
                comparisonProperties = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
            }
            
            comparisonComplexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        }
        
        const propertiesComparisonList = document.getElementById('properties-comparison-list');
        const complexesComparisonList = document.getElementById('complexes-comparison-list');
        const quickComparisonGrid = document.getElementById('quickComparisonGrid');
        const detailedComparisonContainer = document.getElementById('detailedComparisonContainer');
        
        console.log('Loading comparison content - properties:', comparisonProperties.length, 'complexes:', comparisonComplexes.length);
        
        // Handle quick comparison grid (for comparison.js compatibility)
        if (quickComparisonGrid && detailedComparisonContainer) {
            loadQuickComparisonContent(comparisonProperties, quickComparisonGrid, detailedComparisonContainer);
        }
        
        // Properties comparison content with detailed cards
        if (propertiesComparisonList) {
            if (comparisonProperties.length > 0) {
                loadPropertiesComparisonData(comparisonProperties, propertiesComparisonList);
            } else {
                propertiesComparisonList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p class="text-gray-500 text-sm mb-2">–ü–æ–∫–∞ –≤—ã –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</p>
                        <p class="text-gray-400 text-xs">–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
                    </div>
                `;
            }
        }
        
        // Complexes comparison content
        if (complexesComparisonList) {
            if (comparisonComplexes.length > 0) {
                loadComplexesComparisonData(comparisonComplexes, complexesComparisonList);
            } else {
                complexesComparisonList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <p class="text-gray-500 text-sm mb-2">–ü–æ–∫–∞ –≤—ã –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –ñ–ö –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</p>
                        <p class="text-gray-400 text-xs">–î–æ–±–∞–≤—å—Ç–µ –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –¥–ª—è –∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
                    </div>
                `;
            }
        }
        
        // Update comparison counters in hero cards and sidebar
        const comparisonPropertiesCount = document.getElementById('comparison-properties-count');
        const comparisonComplexesCount = document.getElementById('comparison-complexes-count');
        const comparisonSidebarCount = document.getElementById('comparison-count');
        
        if (comparisonPropertiesCount) comparisonPropertiesCount.textContent = comparisonProperties.length;
        if (comparisonComplexesCount) comparisonComplexesCount.textContent = comparisonComplexes.length;
        
        const totalCount = comparisonProperties.length + comparisonComplexes.length;
        if (comparisonSidebarCount) {
            comparisonSidebarCount.textContent = totalCount;
            if (totalCount > 0) {
                comparisonSidebarCount.classList.remove('hidden');
            } else {
                comparisonSidebarCount.classList.add('hidden');
            }
        }
        
        console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è - –∫–≤–∞—Ä—Ç–∏—Ä—ã:', comparisonProperties.length, '–ñ–ö:', comparisonComplexes.length);
    }
    
    // New function for quick comparison content
    async function loadQuickComparisonContent(propertyIds, quickGrid, detailedContainer) {
        if (propertyIds.length === 0) {
            quickGrid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">–û–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br><small class="text-xs mt-2">–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞</small></div>';
            detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">–û–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        
        // Show loading state
        quickGrid.innerHTML = '<div class="col-span-full text-center py-4 text-gray-500">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>';
        
        try {
            // Load properties from API
            const propertyPromises = propertyIds.map(async (propertyId) => {
                try {
                    console.log(`Loading property ${propertyId} from API...`);
                    const response = await fetch(`/api/property/${propertyId}`);
                    console.log(`Property ${propertyId} response status:`, response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`Property ${propertyId} data loaded:`, data.title || 'no title');
                        // Wrap in expected format
                        return {
                            success: true,
                            property: data
                        };
                    }
                    console.warn(`Property ${propertyId} not found (${response.status})`);
                    return null;
                } catch (e) {
                    console.error(`Error loading property ${propertyId}:`, e);
                    return null;
                }
            });
            
            const properties = await Promise.all(propertyPromises);
            const validProperties = properties.filter(p => p && p.success && p.property);
            
            console.log('Loaded valid properties for comparison:', validProperties.length, 'of', propertyIds.length);
            
            if (validProperties.length === 0) {
                quickGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <p>–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        <small class="text-xs block mt-2">–í–æ–∑–º–æ–∂–Ω–æ –æ–±—ä–µ–∫—Ç—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏</small>
                        <button onclick="clearOldComparisonData()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                `;
                detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            // Render quick comparison cards in complex-comparison style
            quickGrid.innerHTML = validProperties.map(item => {
                const property = item.property;
                const cashback = property.cashback || 0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à–±–µ–∫ –∏–∑ calculate_cashback()
                const complexName = (property.residential_complex || property.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω')
                    .replace(/^–ñ–ö\s+–ñ–ö\s+/, '–ñ–ö ')  // Remove duplicate "–ñ–ö –ñ–ö"
                    .replace(/^–ñ–ö\s+¬´?/, '–ñ–ö ¬´')     // Normalize quotes
                    .replace(/¬´?$/, '¬ª');            // Ensure closing quote
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative hover:shadow-md transition-all duration-200">
                        <button onclick="removeFromComparison('${property.id}')" 
                                class="absolute top-3 right-3 w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition-colors text-sm font-medium">
                            √ó
                        </button>
                        
                        <div class="mb-4">
                            <img src="${property.image || '/static/images/no-image.jpg'}" 
                                 alt="${property.title}"
                                 class="w-full h-40 object-cover rounded-lg">
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <h4 class="font-bold text-lg text-gray-900 leading-tight">${property.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${complexName}</p>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">–¶–µ–Ω–∞:</span>
                                    <span class="font-bold text-lg text-[#0088CC]">${property.price?.toLocaleString() || '–ü–æ –∑–∞–ø—Ä–æ—Å—É'} ‚ÇΩ</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">–ü–ª–æ—â–∞–¥—å:</span>
                                    <span class="font-medium text-gray-900">${property.area || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} –º¬≤</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">–≠—Ç–∞–∂:</span>
                                    <span class="font-medium text-gray-900">${property.object_min_floor || property.floor || '–ù–µ —É–∫–∞–∑–∞–Ω'}${property.object_max_floor || property.total_floors ? ' –∏–∑ ' + (property.object_max_floor || property.total_floors) : ''}</span>
                                </div>
                                
                                <div class="pt-2 border-t border-gray-100">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600">–ö–µ—à–±–µ–∫:</span>
                                        <span class="font-bold text-green-600">${cashback.toLocaleString()} ‚ÇΩ</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">–ö–µ—à–±–µ–∫ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render detailed comparison (if function exists)
            if (typeof renderDetailedComparison === 'function') {
                detailedContainer.innerHTML = renderDetailedComparison(validProperties.map(item => item.property));
            } else {
                detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">–î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ</div>';
            }
            
        } catch (error) {
            console.error('Error loading quick comparison:', error);
            quickGrid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }
    
    // Load properties comparison data with real data from API
    async function loadPropertiesComparisonData(propertyIds, container) {
        if (propertyIds.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>–û–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <small class="text-xs mt-2">–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞</small>
                </div>
            `;
            return;
        }

        try {
            // Load properties from API
            const propertyPromises = propertyIds.map(async (propertyId) => {
                try {
                    const response = await fetch(`/api/property/${propertyId}`);
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (e) {
                    return null;
                }
            });
            
            const properties = await Promise.all(propertyPromises);
            const validProperties = properties.filter(p => p !== null);
            
            let html = '';
            
            if (validProperties.length === 0) {
                html = `
                    <div class="text-center py-8 text-gray-500">
                        <p>–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        <small class="text-xs block mt-2">–í–æ–∑–º–æ–∂–Ω–æ –æ–±—ä–µ–∫—Ç—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏</small>
                        <button onclick="clearOldComparisonData()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                `;
            } else {
                validProperties.forEach(property => {
                    const priceFormatted = property.price ? (property.price / 1000000).toFixed(1) + ' –º–ª–Ω ‚ÇΩ' : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
                    const cashbackAmount = property.cashback || 0;
                    const roomsText = property.object_rooms ? `${property.object_rooms}-–∫–æ–º–Ω` : '–°—Ç—É–¥–∏—è';
                    
                    const complexName = (property.residential_complex || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                        .replace(/^–ñ–ö\s+–ñ–ö\s+/, '–ñ–ö ')  // Remove duplicate "–ñ–ö –ñ–ö"
                        .replace(/^–ñ–ö\s+¬´?/, '–ñ–ö ¬´')     // Normalize quotes
                        .replace(/¬´?$/, '¬ª');            // Ensure closing quote

                    html += `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 transition-colors">
                            <div class="flex-1">
                                <h5 class="font-semibold text-gray-900 text-sm">${roomsText}, ${complexName}</h5>
                                <p class="text-xs text-gray-600 mt-1">${priceFormatted} ‚Ä¢ +${cashbackAmount.toLocaleString()} ‚ÇΩ –∫–µ—à–±–µ–∫</p>
                            </div>
                            <button class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50 transition-colors" onclick="removeFromComparison(${property.id})">
                                ‚úï
                            </button>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading properties comparison data:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</p>
                    <p class="text-xs mt-2">${error.message}</p>
                    <button onclick="clearOldComparisonData()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                        –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            `;
        }
    }

    // Load complexes comparison data by fetching each complex individually
    async function loadComplexesComparisonData(complexIds, container) {
        try {
            if (complexIds.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">–î–æ–±–∞–≤—å—Ç–µ –ñ–ö –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            let html = '';
            
            // Load each complex individually
            const complexPromises = complexIds.map(async (complexId) => {
                try {
                    const response = await fetch(`/api/complex/${complexId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Save original ID for deletion
                        data.original_id = complexId;
                        return data;
                    }
                    console.warn(`Complex ${complexId} not found`);
                    return null;
                } catch (e) {
                    console.error(`Error loading complex ${complexId}:`, e);
                    return null;
                }
            });
            
            const complexes = await Promise.all(complexPromises);
            const validComplexes = complexes.filter(c => c !== null);
            
            if (validComplexes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>–ñ–ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        <p class="text-xs mt-2">–í–æ–∑–º–æ–∂–Ω–æ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏</p>
                        <button onclick="clearOldComparisonData()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                            –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render complexes
            for (const complex of validComplexes) {
                const priceFrom = complex.min_price || complex.price_from || 5000000;
                const priceFromMillions = (priceFrom / 1000000).toFixed(1);
                const cashbackPercent = complex.cashback_rate || complex.cashback_percent || 5; // ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à–±–µ–∫ –∏–∑ –ë–î
                const cashback = Math.round(priceFrom * cashbackPercent / 100);
                
                html += `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900 text-sm">${complex.name}</h5>
                            <p class="text-xs text-gray-600">–æ—Ç ${priceFromMillions} –º–ª–Ω ‚ÇΩ ‚Ä¢ –∫–µ—à–±–µ–∫ ${cashbackPercent}% ‚Ä¢ ${complex.properties_count || complex.apartments_count || 0} –æ–±—ä–µ–∫—Ç–æ–≤</p>
                        </div>
                        <button class="text-red-600 hover:text-red-800 text-xs px-2 py-1 hover:bg-red-50 rounded transition-colors" onclick="removeFromComplexComparison('${complex.original_id}')">
                            ‚úï
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading complexes comparison data:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ñ–ö</p>
                    <p class="text-xs mt-2">${error.message}</p>
                    <button onclick="loadComparisonContent()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                    </button>
                </div>
            `;
        }
    }
    
    // Global functions for removing items from comparison
    window.removeFromComparison = async function(propertyId) {
        console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', propertyId, '—Ç–∏–ø:', typeof propertyId);
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª—è–µ–º –∏–∑ PostgreSQL –ë–î —á–µ—Ä–µ–∑ API
        try {
            const response = await fetch('/api/user/comparison/property/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ property_id: String(propertyId) })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to remove property from DB:', result);
            } else {
                console.log('‚úÖ Property removed from PostgreSQL DB:', propertyId);
            }
        } catch (error) {
            console.error('Error calling API to remove property:', error);
        }
        
        // Remove from comparison.js localStorage format
        try {
            const comparisons = JSON.parse(localStorage.getItem('comparisons') || '[]');
            console.log('–°–ø–∏—Å–æ–∫ –¥–æ —É–¥–∞–ª–µ–Ω–∏—è (comparisons):', comparisons);
            const newComparisons = comparisons.filter(id => String(id) !== String(propertyId));
            console.log('–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è (comparisons):', newComparisons);
            localStorage.setItem('comparisons', JSON.stringify(newComparisons));
        } catch (e) {
            console.error('Error removing from comparison:', e);
        }
        
        // Also remove from old format
        try {
            const oldComparisons = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
            console.log('–°–ø–∏—Å–æ–∫ –¥–æ —É–¥–∞–ª–µ–Ω–∏—è (old format):', oldComparisons);
            const newOldComparisons = oldComparisons.filter(id => String(id) !== String(propertyId));
            console.log('–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è (old format):', newOldComparisons);
            localStorage.setItem('comparison_properties', JSON.stringify(newOldComparisons));
        } catch (e) {
            console.error('Error removing from old comparison format:', e);
        }
        
        // Update UI
        updateDashboardCounters();
        loadComparisonContent();
        
        // Update comparison manager if available
        if (window.comparisonManager) {
            window.comparisonManager.updateComparisonUI();
        }
    };
    
    window.removeFromComplexComparison = async function(complexId) {
        console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ñ–ö –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', complexId, '—Ç–∏–ø:', typeof complexId);
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª—è–µ–º –∏–∑ PostgreSQL –ë–î —á–µ—Ä–µ–∑ API
        try {
            const response = await fetch('/api/user/comparison/complex/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ complex_id: String(complexId) })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to remove complex from DB:', result);
            } else {
                console.log('‚úÖ Complex removed from PostgreSQL DB:', complexId);
            }
        } catch (error) {
            console.error('Error calling API to remove complex:', error);
        }
        
        const complexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        console.log('–°–ø–∏—Å–æ–∫ –ñ–ö –¥–æ —É–¥–∞–ª–µ–Ω–∏—è:', complexes);
        const newComplexes = complexes.filter(id => String(id) !== String(complexId));
        console.log('–°–ø–∏—Å–æ–∫ –ñ–ö –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:', newComplexes);
        localStorage.setItem('comparison_complexes', JSON.stringify(newComplexes));
        
        // Reload comparison content
        loadComparisonContent();
        updateDashboardCounters();
    };
    
    // Function to clear old comparison data
    window.clearOldComparisonData = function() {
        try {
            localStorage.removeItem('comparisons');
            localStorage.removeItem('comparison_properties');
            localStorage.removeItem('comparison_complexes');
            console.log('Cleared old comparison data from localStorage');
            
            // Reload comparison content and counters
            updateDashboardCounters();
            loadComparisonContent();
            
            // Show success message
            alert('–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞.');
        } catch (e) {
            console.error('Error clearing comparison data:', e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö');
        }
    };
    
    // Guard flag to prevent duplicate initialization
    let dashboardInitialized = false;
    
    // Initialize dashboard content when everything is loaded
    function initializeDashboard() {
        if (dashboardInitialized) {
            console.log('Dashboard already initialized, skipping...');
            return;
        }
        dashboardInitialized = true;
        console.log('Initializing dashboard...');
        
        updateDashboardCounters();
        loadFavoritesContent();
        loadComparisonContent();
        initializeCashbackCalculator();
        initializeSavedSearchActions();
        
        // ‚úÖ –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        // –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // setInterval(updateDashboardCounters, 5000);
        
        // ‚úÖ –û–¢–ö–õ–Æ–ß–ï–ù–û: –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ API –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        // –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
        // setInterval(updateTopMenuCounters, 10000);
        
        // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateTopMenuCounters();
    }
    
    function initializeCashbackCalculator() {
        const priceInput = document.getElementById('cashback-price');
        const typeSelect = document.getElementById('cashback-type');
        const resultElement = document.getElementById('cashback-result');
        
        if (!priceInput || !typeSelect || !resultElement) return;
        
        function calculateCashback() {
            const price = parseFloat(priceInput.value) || 3500000;
            const percentage = parseFloat(typeSelect.value) || 5;
            const cashback = Math.round(price * percentage / 100);
            
            resultElement.textContent = cashback.toLocaleString('ru-RU') + ' ‚ÇΩ';
        }
        
        priceInput.addEventListener('input', calculateCashback);
        typeSelect.addEventListener('change', calculateCashback);
        
        // Initialize with default values
        calculateCashback();
    }
    
    function initializeSavedSearchActions() {
        // Apply search buttons
        document.querySelectorAll('.apply-search-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                let searchId = this.dataset.searchId;
                
                // Check if this is a manager's sent search (has "sent-" prefix)
                if (searchId && searchId.startsWith('sent-')) {
                    // Remove "sent-" prefix and get actual search ID
                    const actualId = searchId.replace('sent-', '');
                    
                    let isRedirecting = false;
                    
                    // Load filters for this sent search and redirect to properties
                    fetch(`/api/manager/sent-search/${actualId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load search');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success && data.search) {
                                // Build URL with filters
                                const filters = data.search.additional_filters || {};
                                const params = new URLSearchParams();
                                
                                // Helper function to check if value is valid (not null/undefined/empty string)
                                const isValidValue = (val) => val !== undefined && val !== null && val !== '';
                                
                                // Add filters to params - filter out empty values but allow 0
                                if (isValidValue(filters.complex_name)) {
                                    params.append('complex', filters.complex_name);
                                }
                                if (filters.rooms !== undefined && filters.rooms !== null) {
                                    params.append('rooms', filters.rooms);
                                }
                                if (filters.priceFrom !== undefined && filters.priceFrom !== null && filters.priceFrom !== '') {
                                    params.append('price_min', filters.priceFrom);
                                }
                                if (filters.priceTo !== undefined && filters.priceTo !== null && filters.priceTo !== '') {
                                    params.append('price_max', filters.priceTo);
                                }
                                if (filters.areaFrom !== undefined && filters.areaFrom !== null && filters.areaFrom !== '') {
                                    params.append('area_min', filters.areaFrom);
                                }
                                if (filters.areaTo !== undefined && filters.areaTo !== null && filters.areaTo !== '') {
                                    params.append('area_max', filters.areaTo);
                                }
                                if (isValidValue(filters.district)) {
                                    params.append('district', filters.district);
                                }
                                
                                // Set flag before redirect
                                isRedirecting = true;
                                
                                // Redirect to properties with filters
                                const queryString = params.toString();
                                window.location.href = queryString ? `/properties?${queryString}` : '/properties';
                            } else {
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∏—Å–∫ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                            }
                        })
                        .catch(error => {
                            console.error('Error loading sent search:', error);
                            // Only show alert if we haven't started redirecting
                            if (!isRedirecting) {
                                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
                            }
                        });
                } else if (searchId && window.savedSearchesManager) {
                    // Use the saved searches manager to apply the search properly
                    window.savedSearchesManager.applySavedSearch(searchId);
                } else if (searchId) {
                    // Fallback to old method if manager not available
                    window.location.href = `/properties?search_id=${searchId}`;
                }
            });
        });
        
        // Delete search buttons - handled by SavedSearchesManager in saved_searches.js
    }
    
    window.viewRecommendation = function(recommendationId) {
        // Mark recommendation as viewed first
        fetch(`/api/recommendations/${recommendationId}/viewed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find the recommendation element to get property details
                const recElement = document.querySelector(`[onclick="viewRecommendation(${recommendationId})"]`);
                if (recElement) {
                    const recCard = recElement.closest('.border');
                    const propertyId = recCard.dataset.propertyId;
                    if (propertyId && propertyId !== '') {
                        // Navigate to property page
                        window.location.href = `/object/${propertyId}`;
                    } else {
                        // For other recommendation types, just mark as viewed and refresh
                        console.log('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞');
                        location.reload();
                    }
                } else {
                    console.log('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞');
                    location.reload();
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    window.dismissRecommendation = function(recommendationId) {
        if (confirm('–°–∫—Ä—ã—Ç—å —ç—Ç—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é?')) {
            fetch(`/api/recommendations/${recommendationId}/dismiss`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
            });
        }
    }
    
    window.applySearchRecommendation = function(searchId) {
        console.log('Applying saved search:', 'sent-' + searchId);
        
        // Use the same logic as apply-search-btn for manager searches
        const actualId = searchId;
        let isRedirecting = false;
        
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        
        // Mark search as applied and get filters
        fetch(`/api/recommendations/search_${searchId}/apply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to apply search');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.filters) {
                // Build URL with filters
                const filters = data.filters || {};
                const params = new URLSearchParams();
                
                // Helper function to check if value is valid (not null/undefined/empty string)
                const isValidValue = (val) => val !== undefined && val !== null && val !== '';
                
                // Add filters to params - filter out empty values but allow 0
                if (isValidValue(filters.complex_name)) {
                    params.append('complex', filters.complex_name);
                }
                if (filters.rooms !== undefined && filters.rooms !== null) {
                    params.append('rooms', filters.rooms);
                }
                if (filters.priceFrom !== undefined && filters.priceFrom !== null && filters.priceFrom !== '') {
                    params.append('price_min', filters.priceFrom);
                }
                if (filters.priceTo !== undefined && filters.priceTo !== null && filters.priceTo !== '') {
                    params.append('price_max', filters.priceTo);
                }
                if (filters.areaFrom !== undefined && filters.areaFrom !== null && filters.areaFrom !== '') {
                    params.append('area_min', filters.areaFrom);
                }
                if (filters.areaTo !== undefined && filters.areaTo !== null && filters.areaTo !== '') {
                    params.append('area_max', filters.areaTo);
                }
                if (isValidValue(filters.district)) {
                    params.append('district', filters.district);
                }
                
                // Set flag before redirect
                isRedirecting = true;
                
                // Redirect to properties with filters
                const queryString = params.toString();
                window.location.href = queryString ? `/properties?${queryString}` : '/properties';
            } else if (data.success) {
                // Fallback to properties page if no filters
                isRedirecting = true;
                window.location.href = '/properties';
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Only show alert if we haven't started redirecting
            if (!isRedirecting) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
            }
        });
    }
    
    // Category filtering functions
    window.filterByCategory = function(categoryId) {
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.value = categoryId;
            filterRecommendations();
        }
    }
    
    function filterRecommendations() {
        const categoryFilter = document.getElementById('categoryFilter');
        const selectedCategory = categoryFilter ? categoryFilter.value : '';
        const recommendations = document.querySelectorAll('.recommendation-item');
        const categoryCards = document.querySelectorAll('.category-card');
        
        // Update category cards highlighting
        categoryCards.forEach(card => {
            if (selectedCategory && card.dataset.categoryId === selectedCategory) {
                card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            } else {
                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            }
        });
        
        // Filter recommendations
        recommendations.forEach(rec => {
            const recCategoryId = rec.dataset.categoryId;
            
            if (!selectedCategory || recCategoryId === selectedCategory) {
                rec.style.display = 'block';
            } else {
                rec.style.display = 'none';
            }
        });
        
        // Update showing count
        const visibleCount = document.querySelectorAll('.recommendation-item[style*="display: block"], .recommendation-item:not([style*="display: none"])').length;
        console.log(`–ü–æ–∫–∞–∑–∞–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: ${visibleCount}`);
    }
    
    // Initialize category filter
    document.addEventListener('DOMContentLoaded', function() {
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', filterRecommendations);
        }
    });
    
    // Guide toggle function
    window.toggleGuide = function() {
        const guide = document.getElementById('cashbackGuide');
        const button = event.target;
        
        if (guide.style.display === 'none') {
            guide.style.display = 'grid';
            button.textContent = '–°–∫—Ä—ã—Ç—å';
        } else {
            guide.style.display = 'none';
            button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
        }
    }
    
    // Phone binding functions
    window.bindPhone = function() {
        const phoneInput = document.getElementById('phoneInput');
        const phone = phoneInput.value.trim();
        
        if (!phone) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            return;
        }
        
        // Basic phone validation
        const phonePattern = /^(\+7|7|8)?[\s\-]?\(?[489][0-9]{2}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/;
        if (!phonePattern.test(phone.replace(/[\s\-\(\)]/g, ''))) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            return;
        }
        
        // Send verification request
        fetch('/api/bind-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ phone: phone })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä');
                // Show verification code input
                showVerificationInput();
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        });
    }
    
    window.changePhone = function() {
        if (confirm('–í—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞?')) {
            // Allow phone change
            location.reload();
        }
    }
    
    function showVerificationInput() {
        // This would show a verification code input modal
        const code = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑ SMS:');
        if (code) {
            verifyPhone(code);
        }
    }
    
    function verifyPhone(code) {
        fetch('/api/verify-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!');
                location.reload();
            } else {
                alert(data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
            }
        });
    }
    
    // Cashback checker function
    window.checkCashback = function() {
        const urlInput = document.getElementById('cashbackUrlInput');
        const resultDiv = document.getElementById('cashbackResult');
        const contentDiv = document.getElementById('cashbackContent');
        
        const url = urlInput.value.trim();
        if (!url) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä–µ–∫—Ç');
            return;
        }
        
        // Show loading state
        resultDiv.classList.remove('hidden');
        contentDiv.innerHTML = '<div class="flex items-center space-x-2"><div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span>–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à–±–µ–∫...</span></div>';
        
        // Try to extract property ID from URL
        let propertyId = null;
        const urlPatterns = [
            /\/order\/(\d+)/,
            /\/property\/(\d+)/,
            /\/object\/(\d+)/,
            /id=(\d+)/,
            /property_id=(\d+)/
        ];
        
        for (const pattern of urlPatterns) {
            const match = url.match(pattern);
            if (match) {
                propertyId = match[1];
                break;
            }
        }
        
        if (propertyId) {
            // Check if property exists in our system
            fetch(`/api/property/${propertyId}/cashback`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        contentDiv.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-gray-900">${data.property_name}</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">${data.cashback_percent}% –∫–µ—à–±–µ–∫</span>
                                </div>
                                <div class="text-lg font-semibold text-green-600">–ö–µ—à–±–µ–∫: ${data.cashback_amount.toLocaleString()} ‚ÇΩ</div>
                                <div class="text-sm text-gray-600">–¶–µ–Ω–∞: ${data.property_price.toLocaleString()} ‚ÇΩ</div>
                                <a href="/property/${propertyId}" class="inline-block mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä–µ–∫—Ç</a>
                            </div>
                        `;
                    } else {
                        contentDiv.innerHTML = `
                            <div class="text-center py-4">
                                <div class="text-gray-600 mb-2">–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—à–µ–π –±–∞–∑–µ</div>
                                <div class="text-sm text-gray-500">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π –∫–µ—à–±–µ–∫–∞</div>
                                <button onclick="openApplicationModal()" class="mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-red-600 mb-2">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–µ—à–±–µ–∫–∞</div>
                            <div class="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</div>
                        </div>
                    `;
                });
        } else {
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-yellow-600 mb-2">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±—ä–µ–∫—Ç–∞</div>
                    <div class="text-sm text-gray-500">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</div>
                    <button onclick="openApplicationModal()" class="mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</button>
                </div>
            `;
        }
    }
    
    // Cashback calculator functionality
    let cashbackData = {
        complexes: [],
        selectedComplex: null,
        currentPrice: 0,
        currentCashback: 0
    };

    // Load residential complexes for cashback calculator
    async function loadResidentialComplexes() {
        try {
            const response = await fetch('/api/residential-complexes');
            const data = await response.json();
            cashbackData.complexes = data.complexes || [];
            
            console.log('Loaded complexes for cashback:', cashbackData.complexes.length);
            
            // Initialize search functionality
            initializeCashbackComplexSearch();
            
        } catch (error) {
            console.error('Error loading residential complexes:', error);
        }
    }
    
    // Initialize complex search functionality
    function initializeCashbackComplexSearch() {
        const searchInput = document.getElementById('cashback-complex-search');
        const hiddenInput = document.getElementById('cashback-complex');
        const dropdown = document.getElementById('cashback-complex-dropdown');
        
        if (!searchInput || !hiddenInput || !dropdown) return;
        
        // Filter and show complexes
        function filterComplexes(query) {
            const filtered = cashbackData.complexes.filter(complex => 
                complex.name.toLowerCase().includes(query.toLowerCase())
            );
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0 && query) {
                dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                filtered.forEach(complex => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
                        <div class="font-medium text-gray-900">${complex.name}</div>
                        <div class="text-sm text-gray-500">–ö–µ—à–±–µ–∫: ${complex.cashback_rate}% ‚Ä¢ ${complex.district || '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä'}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        searchInput.value = complex.name;
                        hiddenInput.value = complex.id;
                        dropdown.classList.add('hidden');
                        
                        // Update rate info
                        const rateInfo = document.getElementById('complex-rate-info');
                        if (rateInfo) {
                            rateInfo.textContent = `–ü—Ä–æ—Ü–µ–Ω—Ç –∫–µ—à–±–µ–∫–∞: ${complex.cashback_rate}%`;
                        }
                        
                        calculateCashback();
                    });
                    
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.classList.remove('hidden');
        }
        
        // Search input events
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length > 0) {
                filterComplexes(query);
            } else {
                dropdown.classList.add('hidden');
                hiddenInput.value = '';
                document.getElementById('complex-rate-info').textContent = '';
            }
        });
        
        searchInput.addEventListener('focus', (e) => {
            if (e.target.value.length > 0) {
                filterComplexes(e.target.value);
            }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // Calculate cashback
    async function calculateCashback() {
        const complexHiddenInput = document.getElementById('cashback-complex');
        const priceInput = document.getElementById('cashback-price');
        const resultDiv = document.getElementById('cashback-result');
        const rateDisplay = document.getElementById('cashback-rate-display');
        const detailsDiv = document.getElementById('cashback-details');
        const applyBtn = document.getElementById('apply-cashback-btn');
        
        if (!complexHiddenInput || !priceInput || !resultDiv) return;
        
        const complexId = complexHiddenInput.value;
        const price = parseFloat(priceInput.value);
        
        if (!complexId || !price || price < 1000000) {
            resultDiv.textContent = complexId ? '–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å' : '–í—ã–±–µ—Ä–∏—Ç–µ –ñ–ö';
            if (rateDisplay) rateDisplay.textContent = '';
            if (detailsDiv) detailsDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞';
            if (applyBtn) applyBtn.disabled = true;
            return;
        }

        try {
            // Try multiple ways to get CSRF token
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken || csrfToken === 'no-token') {
                csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            }
            
            const response = await fetch('/api/cashback/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && {'X-CSRFToken': csrfToken})
                },
                body: JSON.stringify({
                    price: price,
                    complex_id: complexId
                })
            });

            const data = await response.json();
            
            if (data.error) {
                resultDiv.textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞';
                if (rateDisplay) rateDisplay.textContent = data.error;
                if (applyBtn) applyBtn.disabled = true;
                return;
            }

            // Update UI
            resultDiv.textContent = `${data.formatted_amount} ‚ÇΩ`;
            if (rateDisplay) rateDisplay.textContent = `–°—Ç–∞–≤–∫–∞: ${data.cashback_rate}%`;
            
            if (detailsDiv) {
                if (data.cashback_amount >= 500000) {
                    detailsDiv.textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–µ—à–±–µ–∫ 500 000 ‚ÇΩ';
                } else {
                    detailsDiv.textContent = `${data.cashback_rate}% –æ—Ç ${parseInt(price).toLocaleString('ru-RU')} ‚ÇΩ`;
                }
            }
            
            // Store current calculation
            cashbackData.currentPrice = price;
            cashbackData.currentCashback = data.cashback_amount;
            cashbackData.selectedComplex = {
                id: complexId,
                name: complexSelect.options[complexSelect.selectedIndex].dataset.name,
                rate: data.cashback_rate
            };
            
            if (applyBtn) applyBtn.disabled = false;
            
        } catch (error) {
            console.error('Error calculating cashback:', error);
            resultDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            if (applyBtn) applyBtn.disabled = true;
        }
    }

    // Open cashback application modal
    function openCashbackModal() {
        if (!cashbackData.selectedComplex || !cashbackData.currentCashback) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –∫–µ—à–±–µ–∫');
            return;
        }
        
        // Update modal content
        const amountEl = document.getElementById('modal-cashback-amount');
        const infoEl = document.getElementById('modal-complex-info');
        
        if (amountEl) {
            amountEl.textContent = `${parseInt(cashbackData.currentCashback).toLocaleString('ru-RU')} ‚ÇΩ`;
        }
        if (infoEl) {
            infoEl.textContent = `${cashbackData.selectedComplex.name} ‚Ä¢ ${cashbackData.selectedComplex.rate}% ‚Ä¢ ${parseInt(cashbackData.currentPrice).toLocaleString('ru-RU')} ‚ÇΩ`;
        }
        
        // Show modal
        const modal = document.getElementById('cashback-modal');
        if (modal) modal.classList.remove('hidden');
    }

    // Close cashback modal
    function closeCashbackModal() {
        const modal = document.getElementById('cashback-modal');
        if (modal) modal.classList.add('hidden');
    }

    // Submit cashback application
    let isSubmittingCashback = false;  // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    
    async function submitCashbackApplication(event) {
        event.preventDefault();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        if (isSubmittingCashback) {
            console.log('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ');
            return;
        }
        
        const name = document.getElementById('cashback-name')?.value.trim();
        const phone = document.getElementById('cashback-phone')?.value.trim();
        const submitBtn = event.target.querySelector('button[type="submit"]');
        
        if (!name || !phone) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneRegex = /^(\+7|8)?[\s\-]?\(?[489]\d{2}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$/;
        const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        if (!phoneRegex.test(phone) || cleanPhone.length < 10) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (XXX) XXX-XX-XX');
            return;
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        isSubmittingCashback = true;
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
        
        try {
            // Try multiple ways to get CSRF token
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken || csrfToken === 'no-token') {
                csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            }
            
            const response = await fetch('/api/cashback/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && {'X-CSRFToken': csrfToken})
                },
                body: JSON.stringify({
                    price: cashbackData.currentPrice,
                    complex_id: cashbackData.selectedComplex.id,
                    complex_name: cashbackData.selectedComplex.name,
                    cashback_amount: cashbackData.currentCashback,
                    name: name,
                    phone: phone
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                closeCashbackModal();
                // Reset form
                const form = document.getElementById('cashback-application-form');
                if (form) form.reset();
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
            }
            
        } catch (error) {
            console.error('Error submitting application:', error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            isSubmittingCashback = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
            }
        }
    }

    // Global functions for cashback modal
    window.openCashbackModal = openCashbackModal;
    window.closeCashbackModal = closeCashbackModal;

    // Initialize new slider-based cashback calculator
    function initializeCashbackCalculator() {
        const priceSlider = document.getElementById('price-slider');
        const rateSlider = document.getElementById('rate-slider');
        const priceDisplay = document.getElementById('price-display');
        const rateDisplay = document.getElementById('rate-display');
        const cashbackAmount = document.getElementById('cashback-amount');
        const summaryPrice = document.getElementById('summary-price');
        const applyBtn = document.getElementById('apply-cashback-btn');
        const form = document.getElementById('cashback-application-form');
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∫–µ—à–±–µ–∫–∞
        function updateCalculation() {
            if (!priceSlider || !rateSlider || !priceDisplay || !rateDisplay || !cashbackAmount || !summaryPrice) return;
            
            const price = parseFloat(priceSlider.value);
            const rate = parseFloat(rateSlider.value);
            const cashback = Math.round(price * rate / 100);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–ª–∞–π–¥–µ—Ä–æ–≤
            const priceProgress = ((price - parseFloat(priceSlider.min)) / (parseFloat(priceSlider.max) - parseFloat(priceSlider.min))) * 100;
            const rateProgress = ((rate - parseFloat(rateSlider.min)) / (parseFloat(rateSlider.max) - parseFloat(rateSlider.min))) * 100;
            
            priceSlider.style.setProperty('--slider-progress', priceProgress + '%');
            rateSlider.style.setProperty('--slider-progress', rateProgress + '%');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            priceDisplay.textContent = formatNumber(price) + ' ‚ÇΩ';
            rateDisplay.textContent = rate + '%';
            cashbackAmount.textContent = formatNumber(cashback) + ' ‚ÇΩ';
            summaryPrice.textContent = formatNumber(price) + ' ‚ÇΩ';
        }
        
        // Event listeners –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–æ–≤
        if (priceSlider) {
            priceSlider.addEventListener('input', updateCalculation);
        }
        
        if (rateSlider) {
            rateSlider.addEventListener('input', updateCalculation);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—É—á–∏—Ç—å –∫–µ—à–±–µ–∫"
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                const price = parseFloat(priceSlider?.value || 0);
                const rate = parseFloat(rateSlider?.value || 0);
                const cashback = Math.round(price * rate / 100);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º cashbackData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                cashbackData.currentPrice = price;
                cashbackData.currentCashback = cashback;
                cashbackData.selectedComplex = {
                    id: null,
                    name: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–µ—à–±–µ–∫–∞'
                };
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∑–∞—è–≤–∫–æ–π
                openCashbackModal(price, rate, cashback);
            });
        }
        
        if (form) {
            form.addEventListener('submit', submitCashbackApplication);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneInput = document.getElementById('cashback-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤–≤–æ–¥–∞
                if (value.startsWith('8') && value.length === 11) {
                    // 8XXXXXXXXXX -> 7XXXXXXXXXX
                    value = '7' + value.substring(1);
                } else if (value.startsWith('9') && value.length === 10) {
                    // 9XXXXXXXXX -> 79XXXXXXXXX
                    value = '7' + value;
                } else if (!value.startsWith('7') && value.length === 10) {
                    // XXXXXXXXXX -> 7XXXXXXXXXX (–¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å –¥—Ä—É–≥–∏—Ö —Ü–∏—Ñ—Ä –∫—Ä–æ–º–µ 7,8,9)
                    value = '7' + value;
                } else if (value.startsWith('7') && value.length > 11) {
                    // –û–±—Ä–µ–∑–∞–µ–º –¥–æ 11 —Ü–∏—Ñ—Ä
                    value = value.substring(0, 11);
                } else if (value.length > 11) {
                    // –û–±—Ä–µ–∑–∞–µ–º –¥–æ 11 —Ü–∏—Ñ—Ä
                    value = value.substring(0, 11);
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ –º–∞—Å–∫–µ +7 (XXX) XXX-XX-XX
                let formatted = '';
                if (value.length > 0) {
                    formatted = '+7';
                    if (value.length > 1) {
                        formatted += ' (' + value.substring(1, 4);
                    }
                    if (value.length >= 4) {
                        formatted += ') ' + value.substring(4, 7);
                    }
                    if (value.length >= 7) {
                        formatted += '-' + value.substring(7, 9);
                    }
                    if (value.length >= 9) {
                        formatted += '-' + value.substring(9, 11);
                    }
                }
                
                e.target.value = formatted;
            });
            
            // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å +7, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
            phoneInput.addEventListener('focus', function(e) {
                if (!e.target.value) {
                    e.target.value = '+7 ';
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        updateCalculation();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openCashbackModal(price = 0, rate = 0, cashback = 0) {
        const modal = document.getElementById('cashback-modal');
        const modalAmount = document.getElementById('modal-cashback-amount');
        const modalInfo = document.getElementById('modal-complex-info');
        
        if (modal) {
            modal.classList.remove('hidden');
            
            if (modalAmount) {
                modalAmount.textContent = formatNumber(cashback) + ' ‚ÇΩ';
            }
            
            if (modalInfo) {
                modalInfo.textContent = `–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∑–∞ ${formatNumber(price)} ‚ÇΩ (${rate}% –∫–µ—à–±–µ–∫)`;
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Wait for all modules to load
    let checkModules = setInterval(function() {
        if (window.favoritesManager && window.savedSearchesManager) {
            clearInterval(checkModules);
            initializeDashboard();
            initializeCashbackCalculator();
        }
    }, 100);
    
    // Fallback initialization after 3 seconds
    setTimeout(function() {
        if (checkModules) {
            clearInterval(checkModules);
            initializeDashboard();
            initializeCashbackCalculator();
        }
    }, 3000);
    
    // Initialize comparison system without overwriting user data
    console.log('Initializing comparison system...');
    const currentComparisons = JSON.parse(localStorage.getItem('comparisons') || '[]');
    console.log('Current comparison IDs:', currentComparisons);
    
    // Update counters without overwriting user data
    if (typeof updateDashboardCounters === 'function') {
        updateDashboardCounters();
    }
})();

// Load user data functions for dashboard
window.loadUserRecommendations = async function() {
    try {
        const response = await fetch('/api/user/recommendations');
        const data = await response.json();
        
        if (data.success) {
            console.log('Loaded recommendations:', data.recommendations.length);
            updateRecommendationsDisplay(data.recommendations);
            
            // Update recommendations count badge
            const countBadge = document.getElementById('recommendations-count');
            if (countBadge) {
                if (data.recommendations.length > 0) {
                    countBadge.textContent = data.recommendations.length;
                    countBadge.classList.remove('hidden');
                } else {
                    countBadge.classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
    }
};

window.loadUserCollections = async function() {
    try {
        const response = await fetch('/api/user/collections');
        const data = await response.json();
        
        if (data.success) {
            console.log('Loaded collections:', data.collections.length);
            updateCollectionsDisplay(data.collections);
            
            // Update recommendations count badge
            const countBadge = document.getElementById('recommendations-count');
            if (countBadge) {
                if (data.collections.length > 0) {
                    countBadge.textContent = data.collections.length;
                    countBadge.classList.remove('hidden');
                } else {
                    countBadge.classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error loading collections:', error);
    }
};

// loadUserSavedSearches removed - now handled by SavedSearchesManager in saved_searches.js

function updateRecommendationsDisplay(recommendations) {
    // Update recommendations section with dynamic data
    const recommendationsSection = document.getElementById('recommendations');
    if (!recommendationsSection) return;
    
    // Find the recommendations list container
    const listContainer = recommendationsSection.querySelector('.space-y-4, .grid');
    if (!listContainer) return;
    
    // Clear existing dynamic items
    const existingItems = listContainer.querySelectorAll('.recommendation-item');
    existingItems.forEach(item => item.remove());
    
    // Add new recommendations
    recommendations.forEach(rec => {
        const recElement = createRecommendationCard(rec);
        listContainer.appendChild(recElement);
    });
    
    if (recommendations.length === 0) {
        listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">–ù–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ—Ç</div>';
    }
}

function createRecommendationCard(rec) {
    const div = document.createElement('div');
    const isNew = rec.status === 'sent';
    div.className = `recommendation-item bg-gradient-to-br from-white to-gray-50 border-2 ${isNew ? 'border-blue-300 shadow-blue-100' : 'border-gray-200'} rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all overflow-hidden relative`;
    div.setAttribute('data-category-id', rec.category_id || '');
    
    const statusBadge = rec.status === 'sent' ? 
        `<span class="inline-flex items-center gap-1.5 px-4 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-xs font-semibold rounded-full shadow-md">
            <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
            –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        </span>` : 
        rec.status === 'viewed' ? 
        `<span class="px-4 py-1.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs font-semibold rounded-full shadow-md">
            –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ
        </span>` : 
        `<span class="px-4 py-1.5 bg-gradient-to-r from-gray-400 to-gray-500 text-white text-xs font-semibold rounded-full shadow-md">
            –ù–æ–≤–æ–µ
        </span>`;
    
    div.innerHTML = `
        <div class="flex justify-between items-start mb-5">
            <div class="flex-1 pr-4">
                <h3 class="text-xl font-bold text-gray-900 mb-2.5 leading-tight">${rec.title}</h3>
                <p class="text-gray-600 mb-4 leading-relaxed">${rec.description}</p>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md flex-shrink-0">
                            <span class="text-white font-semibold text-sm">${(rec.manager_name || '–ú')[0]}</span>
                        </div>
                        <span class="text-gray-700 font-medium">${rec.manager_name || '–ú–µ–Ω–µ–¥–∂–µ—Ä'}</span>
                    </div>
                    <span class="text-gray-500">${rec.created_at}</span>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2">
                ${statusBadge}
            </div>
        </div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
            <div>
                ${rec.recommendation_type === 'property' ? 
                    `<button onclick="viewProperty(${rec.item_id})" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl hover:from-indigo-600 hover:to-blue-500 transition-all shadow-md hover:shadow-lg text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                        </svg>
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä–µ–∫—Ç
                    </button>` :
                    `<button onclick="applySearchRecommendation(${rec.item_id})" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded-lg hover:from-[#006699] hover:to-[#0088CC] transition-all shadow-md hover:shadow-lg text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>`
                }
            </div>
            <button onclick="hideRecommendation(${rec.id})" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="–°–∫—Ä—ã—Ç—å">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    `;
    
    return div;
}

function updateCollectionsDisplay(collections) {
    const presentationsList = document.getElementById('presentationsList');
    if (!presentationsList) {
        console.log('Collections loaded but no display section found');
        return;
    }
    
    // Clear existing presentations
    presentationsList.innerHTML = '';
    
    // Update counters in hero section
    const newCount = collections.filter(c => c.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞').length;
    const totalCount = collections.length;
    
    const newCountEl = document.getElementById('presentations-new-count');
    const totalCountEl = document.getElementById('presentations-total-count');
    
    if (newCountEl) newCountEl.textContent = newCount;
    if (totalCountEl) totalCountEl.textContent = totalCount;
    
    if (collections.length === 0) {
        presentationsList.innerHTML = `
            <div class="text-center py-16">
                <div class="relative inline-block mb-6">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-3xl flex items-center justify-center shadow-lg">
                        <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                    </div>
                    <div class="absolute -top-1 -right-1 w-6 h-6 bg-blue-500 rounded-full animate-pulse"></div>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p class="text-gray-600 mb-2">–í–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –¥–ª—è –≤–∞—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤</p>
                <p class="text-gray-500 text-sm">–û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>
        `;
        return;
    }
    
    collections.forEach(collection => {
        const card = document.createElement('div');
        const isNew = collection.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
        card.className = `relative bg-gradient-to-br from-white to-gray-50 border-2 ${isNew ? 'border-blue-300 shadow-blue-100' : 'border-gray-200'} rounded-2xl p-6 hover:border-blue-400 hover:shadow-lg transition-all`;
        
        // Create properties preview
        let propertiesPreview = '';
        if (collection.properties && collection.properties.length > 0) {
            propertiesPreview = `
                <div class="flex items-center gap-2 mb-4">
                    <div class="flex -space-x-2">
                        ${collection.properties.slice(0, 4).map(prop => `
                            <div class="w-16 h-16 rounded-lg overflow-hidden border-2 border-white shadow-sm">
                                ${prop.image ? 
                                    `<img src="${prop.image}" alt="${prop.title}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                                    </div>`
                                }
                            </div>
                        `).join('')}
                    </div>
                    ${collection.properties_count > 4 ? 
                        `<div class="flex items-center justify-center w-16 h-16 bg-blue-50 rounded-lg text-blue-600 font-semibold text-sm">
                            +${collection.properties_count - 4}
                        </div>` : ''
                    }
                </div>
            `;
        }
        
        card.innerHTML = `
            <!-- New Badge (if applicable) - Moved to top right corner -->
            ${isNew ? `
            <div class="absolute top-3 right-3">
                <span class="inline-flex items-center gap-1.5 px-4 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-xs font-semibold rounded-full shadow-md">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                    –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                </span>
            </div>` : ''}
            
            <!-- Header with Manager Info -->
            <div class="flex items-center gap-3 mb-4">
                ${collection.manager_avatar && (
                    collection.manager_avatar.startsWith('http') || 
                    collection.manager_avatar.startsWith('/') || 
                    collection.manager_avatar.includes('uploads/') || 
                    collection.manager_avatar.includes('static/')
                ) && !collection.manager_avatar.includes('randomuser.me') ? 
                    `<img src="${collection.manager_avatar}" alt="${collection.manager_name}" class="w-12 h-12 rounded-xl object-cover shadow-md">` : 
                    `<div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-white font-bold text-base">${collection.manager_avatar && !collection.manager_avatar.startsWith('http') ? collection.manager_avatar : '–ú'}</span>
                    </div>`
                }
                <div class="flex-1">
                    <p class="text-sm font-bold text-gray-900">${collection.manager_name || '–ú–µ–Ω–µ–¥–∂–µ—Ä'}</p>
                    <p class="text-xs text-gray-500 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        ${collection.created_at}
                    </p>
                </div>
            </div>
            
            <!-- Title and Description -->
            <div class="mb-4">
                <h3 class="font-bold text-gray-900 text-lg mb-1.5 leading-tight">${collection.title}</h3>
                ${collection.description ? `<p class="text-gray-600 text-sm leading-relaxed">${collection.description}</p>` : ''}
            </div>
            
            <!-- Properties Preview -->
            ${propertiesPreview}
            
            <!-- Property Count and Action Buttons -->
            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                    </div>
                    <span class="font-medium">${collection.properties_count} ${collection.properties_count === 1 ? '–æ–±—ä–µ–∫—Ç' : collection.properties_count < 5 ? '–æ–±—ä–µ–∫—Ç–∞' : '–æ–±—ä–µ–∫—Ç–æ–≤'}</span>
                </div>
                <div class="flex items-center gap-2">
                    <a href="/presentation/modern/${collection.unique_url}" target="_blank" 
                       data-collection-id="${collection.id}"
                       data-is-new="${isNew}"
                       onclick="markPresentationViewed(event, ${collection.id})"
                       class="inline-flex items-center gap-1.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white px-4 py-2 rounded-lg hover:from-[#006699] hover:to-[#0088CC] transition-colors text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <span>–°–º–æ—Ç—Ä–µ—Ç—å</span>
                    </a>
                    <button onclick="deletePresentation(${collection.id})" 
                            class="p-2 border border-gray-300 text-gray-600 rounded-lg hover:border-red-300 hover:text-red-600 hover:bg-red-50 transition-colors" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        presentationsList.appendChild(card);
    });
    
    console.log(`Displayed ${collections.length} presentations with manager avatars and property previews`);
}

// updateSavedSearchesDisplay and createSavedSearchCard removed - now handled by SavedSearchesManager in saved_searches.js

function formatSearchFilters(filters) {
    const formatted = [];
    
    // Helper to check if value is not empty
    const hasValue = (val) => {
        if (Array.isArray(val)) return val.length > 0;
        if (typeof val === 'string') return val.trim() !== '';
        return val !== null && val !== undefined;
    };
    
    // Process each filter
    Object.entries(filters).forEach(([key, value]) => {
        if (!hasValue(value)) return;
        
        const label = getFilterLabel(key);
        let formattedValue = value;
        
        // Format specific fields
        if (key === 'rooms' && Array.isArray(value)) {
            formattedValue = value.map(r => r === '0' ? '–°—Ç—É–¥–∏—è' : `${r}-–∫–æ–º–Ω`).join(', ');
        } else if ((key === 'priceTo' || key === 'price_max') && value) {
            formattedValue = `${value} –º–ª–Ω ‚ÇΩ`;
        } else if ((key === 'priceFrom' || key === 'price_min') && value) {
            formattedValue = `${value} –º–ª–Ω ‚ÇΩ`;
        } else if ((key === 'areaTo' || key === 'area_max') && value) {
            formattedValue = `${value} –º¬≤`;
        } else if ((key === 'areaFrom' || key === 'area_min') && value) {
            formattedValue = `${value} –º¬≤`;
        } else if (Array.isArray(value)) {
            formattedValue = value.join(', ');
        }
        
        formatted.push({ label, value: formattedValue });
    });
    
    return formatted;
}

function getFilterLabel(key) {
    const labels = {
        // New format
        'district': '–†–∞–π–æ–Ω',
        'developer': '–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫', 
        'rooms': '–ö–æ–º–Ω–∞—Ç—ã',
        'price_min': '–¶–µ–Ω–∞ –æ—Ç',
        'price_max': '–¶–µ–Ω–∞ –¥–æ',
        'area_min': '–ü–ª–æ—â–∞–¥—å –æ—Ç',
        'area_max': '–ü–ª–æ—â–∞–¥—å –¥–æ',
        // Old format (compatibility)
        'priceFrom': '–¶–µ–Ω–∞ –æ—Ç',
        'priceTo': '–¶–µ–Ω–∞ –¥–æ',
        'areaFrom': '–ü–ª–æ—â–∞–¥—å –æ—Ç',
        'areaTo': '–ü–ª–æ—â–∞–¥—å –¥–æ',
        'districts': '–†–∞–π–æ–Ω—ã',
        'developers': '–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏',
        'completion': '–°—Ä–æ–∫ —Å–¥–∞—á–∏',
        'propertyClass': '–ö–ª–∞—Å—Å',
        'wallMaterial': '–ú–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω',
        'floorsTotal': '–≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ'
    };
    return labels[key] || key;
}

// Load data when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Load user data after a short delay
    setTimeout(() => {
        if (typeof loadUserRecommendations === 'function') loadUserRecommendations();
        if (typeof loadUserCollections === 'function') loadUserCollections(); 
        // Removed loadUserSavedSearches() - handled by SavedSearchesManager in saved_searches.js
        
        // Load data management stats if on that tab
        if (document.getElementById('data-management')) {
            loadDataStats();
        }
    }, 1500);
});

// ========== DATA MANAGEMENT FUNCTIONS ==========

// Load current data statistics
function loadDataStats() {
    fetch('/admin/data-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#data-stats-properties .text-2xl').textContent = data.properties;
                document.querySelector('#data-stats-complexes .text-2xl').textContent = data.complexes;
                document.querySelector('#data-stats-developers .text-2xl').textContent = data.developers;
                document.querySelector('#data-stats-columns .text-2xl').textContent = data.columns;
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

// Excel file upload functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('excel-upload-form');
    const fileInput = document.getElementById('excel-file');
    const uploadArea = document.getElementById('upload-area');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const uploadBtn = document.getElementById('upload-btn');
    
    if (!uploadForm) return; // Not on data management page
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-purple-400', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-400', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-400', 'bg-purple-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            uploadArea.querySelector('span').textContent = files[0].name;
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            uploadArea.querySelector('span').textContent = e.target.files[0].name;
        }
    });
    
    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('replace_data', document.getElementById('replace-data').checked);
        formData.append('auto_sync', document.getElementById('auto-sync').checked);
        
        // Show progress
        progressDiv.classList.remove('hidden');
        uploadBtn.disabled = true;
        uploadBtn.querySelector('span').innerHTML = `
            <svg class="w-5 h-5 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4z"/>
            </svg>
            –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...
        `;
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            progressPercent.textContent = Math.round(progress) + '%';
        }, 500);
        
        fetch('/admin/upload-excel', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            
            setTimeout(() => {
                progressDiv.classList.add('hidden');
                uploadBtn.disabled = false;
                uploadBtn.querySelector('span').innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
                `;
                
                // Show results
                showUploadResults(data);
                
                // Reload stats
                loadDataStats();
                
                // Reset form
                uploadForm.reset();
                uploadArea.querySelector('span').textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                
            }, 1000);
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);
            
            progressDiv.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.querySelector('span').innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            `;
            
            showUploadResults({success: false, error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'});
        });
    });
});

// Testing functions
function runFullSystemTest() {
    runTest('/admin/test-system', '–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã');
}

function testColumnMapping() {
    runTest('/admin/test-columns', '–ü—Ä–æ–≤–µ—Ä–∫–∞ 77 –∫–æ–ª–æ–Ω–æ–∫ Excel');
}

function testNewDataCreation() {
    runTest('/admin/test-new-data', '–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
}

function validateDataIntegrity() {
    runTest('/admin/test-system', '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö');
}

function runTest(endpoint, testName) {
    const testResults = document.getElementById('test-results');
    const testLog = document.getElementById('test-log');
    
    // Show test area
    testResults.classList.remove('hidden');
    testLog.textContent = `üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: ${testName}\n\n–û–∂–∏–¥–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...`;
    
    // Scroll to results
    testResults.scrollIntoView({ behavior: 'smooth' });
    
    fetch(endpoint, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            let result = `‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù: ${testName}\n`;
            result += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            if (data.success) {
                result += `‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢: –£–°–ü–ï–®–ù–û\n\n`;
                result += `üìã –î–ï–¢–ê–õ–ò:\n${data.output}`;
            } else {
                result += `‚ùå –†–ï–ó–£–õ–¨–¢–ê–¢: –û–®–ò–ë–ö–ê\n\n`;
                result += `üìã –î–ï–¢–ê–õ–ò:\n${data.error || data.output}`;
            }
            
            testLog.textContent = result;
            
            // Reload stats after test
            loadDataStats();
        })
        .catch(error => {
            testLog.textContent = `‚ùå –û–®–ò–ë–ö–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø –¢–ï–°–¢–ê: ${testName}\n\n–û—à–∏–±–∫–∞: ${error.message}`;
        });
}

function showUploadResults(data) {
    const uploadResults = document.getElementById('upload-results');
    const uploadLog = document.getElementById('upload-log');
    
    uploadResults.classList.remove('hidden');
    
    if (data.success) {
        uploadLog.innerHTML = `
            <div class="flex items-center mb-3">
                <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <h4 class="text-lg font-semibold text-green-800">–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!</h4>
            </div>
            <p class="text-gray-700">${data.message}</p>
        `;
    } else {
        uploadLog.innerHTML = `
            <div class="flex items-center mb-3">
                <svg class="w-6 h-6 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <h4 class="text-lg font-semibold text-red-800">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
            </div>
            <p class="text-gray-700">${data.error}</p>
        `;
    }
    
    // Scroll to results
    uploadResults.scrollIntoView({ behavior: 'smooth' });
}

// =============================
// DEALS FUNCTIONALITY
// =============================

// Global deals data
let currentDeals = [];
let currentDealsFilter = 'all';

// Load deals when deals tab is opened
function loadDeals() {
    const loadingState = document.getElementById('deals-loading-state');
    const emptyState = document.getElementById('deals-empty-state');
    const dealsList = document.getElementById('deals-list');
    
    // Show loading state
    loadingState.classList.remove('hidden');
    emptyState.classList.add('hidden');
    dealsList.innerHTML = '';
    
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingState.classList.add('hidden');
        
        if (data.success && data.deals && data.deals.length > 0) {
            currentDeals = data.deals;
            updateDealsStats(currentDeals);
            renderDeals(currentDeals);
            updateDealsCount(currentDeals.length);
        } else {
            currentDeals = [];
            updateDealsStats([]);
            emptyState.classList.remove('hidden');
            updateDealsCount(0);
        }
    })
    .catch(error => {
        console.error('Error loading deals:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        updateDealsCount(0);
    });
}

// Update deals statistics
function updateDealsStats(deals) {
    const totalCount = deals.length;
    const activeCount = deals.filter(d => ['new', 'object_reserved', 'mortgage'].includes(d.status)).length;
    const completedCount = deals.filter(d => d.status === 'successful').length;
    const totalCashback = deals.reduce((sum, d) => sum + (d.cashback_amount || 0), 0);
    
    document.getElementById('deals-total-count').textContent = totalCount;
    document.getElementById('deals-active-count').textContent = activeCount;
    document.getElementById('deals-completed-count').textContent = completedCount;
    document.getElementById('deals-cashback-total').textContent = formatPrice(totalCashback);
}

// Render deals cards
function renderDeals(deals) {
    const dealsList = document.getElementById('deals-list');
    const template = document.getElementById('deal-card-template');
    
    dealsList.innerHTML = '';
    
    deals.forEach(deal => {
        const cardClone = template.cloneNode(true);
        cardClone.id = `deal-${deal.id}`;
        cardClone.classList.remove('hidden');
        
        // Fill in deal data
        const numberShort = deal.deal_number.replace('DL', '');
        cardClone.querySelector('.deal-number-short').textContent = numberShort.slice(-3);
        cardClone.querySelector('.deal-number').textContent = `–°–¥–µ–ª–∫–∞ ${deal.deal_number}`;
        cardClone.querySelector('.deal-created-at').textContent = formatDate(deal.created_at);
        
        // Status badge
        const statusBadge = cardClone.querySelector('.deal-status-badge');
        statusBadge.textContent = deal.status_display;
        statusBadge.className = `status-badge status-${deal.status}`;
        
        // Property details
        cardClone.querySelector('.deal-complex-name').textContent = deal.complex_name;
        cardClone.querySelector('.deal-property-description').textContent = deal.property_description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
        
        // Property specs
        const specs = [];
        if (deal.property_area) specs.push(`${deal.property_area} –º¬≤`);
        if (deal.property_rooms) specs.push(`${deal.property_rooms} –∫–æ–º–Ω.`);
        if (deal.property_floor) specs.push(`${deal.property_floor} —ç—Ç–∞–∂`);
        
        cardClone.querySelector('.deal-property-area').textContent = specs[0] || '';
        cardClone.querySelector('.deal-property-rooms').textContent = specs[1] || '';
        cardClone.querySelector('.deal-property-floor').textContent = specs[2] || '';
        
        // Price and cashback
        cardClone.querySelector('.deal-price').textContent = formatPrice(deal.property_price);
        cardClone.querySelector('.deal-cashback').textContent = formatPrice(deal.cashback_amount);
        cardClone.querySelector('.deal-cashback-percent').textContent = `${deal.cashback_percentage.toFixed(1)}%`;
        
        // Client notes
        if (deal.client_notes) {
            cardClone.querySelector('.deal-client-notes-section').classList.remove('hidden');
            cardClone.querySelector('.deal-client-notes').textContent = deal.client_notes;
        }
        
        dealsList.appendChild(cardClone);
    });
}

// Filter deals by status
function filterDeals(statusFilter) {
    currentDealsFilter = statusFilter;
    
    // Update filter buttons
    document.querySelectorAll('.deals-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-status="${statusFilter}"]`).classList.add('active');
    
    // Filter deals
    let filteredDeals = currentDeals;
    if (statusFilter !== 'all') {
        const statusArray = statusFilter.split(',');
        filteredDeals = currentDeals.filter(deal => statusArray.includes(deal.status));
    }
    
    // Render filtered deals
    if (filteredDeals.length > 0) {
        document.getElementById('deals-empty-state').classList.add('hidden');
        renderDeals(filteredDeals);
    } else {
        document.getElementById('deals-list').innerHTML = '';
        document.getElementById('deals-empty-state').classList.remove('hidden');
    }
}

// Update deals count in tab
function updateDealsCount(count) {
    const countElement = document.getElementById('deals-count');
    if (countElement) {
        countElement.textContent = count;
        countElement.classList.toggle('hidden', count === 0);
    }
}

// Format price helper
function formatPrice(price) {
    if (!price) return '0 ‚ÇΩ';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(price);
}

// Format date helper
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Initialize deals filter event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for filter buttons
    document.querySelectorAll('.deals-filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            filterDeals(status);
        });
    });
    
    // Add deals loading to tab click events
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-page="deals"]');
        if (target) {
            // Small delay to ensure page is shown first
            setTimeout(() => {
                console.log('ü§ù Loading deals after tab click...');
                loadDeals();
            }, 100);
        }
    });
    
    // Also hook into existing showPage function if it exists
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        // Call original function first
        if (originalShowPage) {
            originalShowPage(pageId);
        }
        
        // Load deals when deals page is shown
        if (pageId === 'deals') {
            console.log('ü§ù Loading deals via showPage...');
            loadDeals();
        }
    };
});

// Mark presentation as viewed
async function markPresentationViewed(event, collectionId) {
    console.log(`üìã markPresentationViewed called for collection ${collectionId}`);
    
    const isNew = event.currentTarget.getAttribute('data-is-new') === 'true';
    console.log(`üìã Is new status: ${isNew}`);
    
    // If already viewed, just open
    if (!isNew) {
        console.log(`üìã Already viewed, skipping mark as viewed`);
        return true;
    }
    
    try {
        console.log(`üìã Sending mark-viewed request...`);
        // Send request to mark as viewed
        const response = await fetch(`/collection/${collectionId}/mark-viewed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        console.log(`üìã Mark-viewed response status: ${response.status}`);
        
        if (response.ok) {
            // Find and remove the "–ù–æ–≤–∞—è" badge
            const card = event.currentTarget.closest('.border');
            const badge = card.querySelector('.bg-blue-100.text-blue-800');
            if (badge) {
                console.log(`üìã Found badge, removing...`);
                badge.style.transition = 'all 0.3s ease-out';
                badge.style.opacity = '0';
                badge.style.transform = 'scale(0.8)';
                setTimeout(() => badge.remove(), 300);
            } else {
                console.log(`üìã No badge found`);
            }
            
            // Update data attribute
            event.currentTarget.setAttribute('data-is-new', 'false');
            
            console.log(`‚úÖ –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ${collectionId} –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è`);
        } else {
            console.error(`‚ùå Mark-viewed failed with status ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏:', error);
    }
    
    // Continue opening presentation
    return true;
}

// Delete presentation
async function deletePresentation(collectionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user/presentation/${collectionId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove card from DOM with animation
            const card = event.target.closest('.border');
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                card.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    card.remove();
                    // Reload page if no more presentations
                    const remaining = document.querySelectorAll('#presentationsList .border').length;
                    if (remaining === 0) {
                        location.reload();
                    }
                }, 300);
            }
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏');
        }
    } catch (error) {
        console.error('Error deleting presentation:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏');
    }
}

// Send presentation to manager
async function sendPresentationToManager(collectionId) {
    if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä—É? –≠—Ç–æ —É–≤–µ–¥–æ–º–∏—Ç –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/collection/${collectionId}/notify-manager`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É!');
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('Error sending notification:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
    }
}

// =============================
// PHONE VERIFICATION
// =============================

async function bindPhone() {
    const phone = document.getElementById('phoneInput').value.trim();
    
    if (!phone) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        return;
    }
    
    try {
        const response = await fetch('/api/user/phone/send-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ phone })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showVerificationCodeModal(phone);
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
        }
    } catch (error) {
        console.error('Error sending verification code:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
}

function changePhone() {
    location.reload();
}

function showVerificationCodeModal(phone) {
    const modal = document.createElement('div');
    modal.id = 'verification-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
            <p class="text-gray-600 mb-4">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –Ω–æ–º–µ—Ä ${phone}</p>
            <input 
                type="text" 
                id="verification-code"
                maxlength="6"
                placeholder="–ö–æ–¥ –∏–∑ SMS"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] mb-4"
            />
            <div class="flex space-x-3">
                <button 
                    onclick="verifyPhoneCode()" 
                    class="flex-1 px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded-lg hover:from-[#006699] hover:to-[#004466] transition-all"
                >
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
                <button 
                    onclick="closeVerificationModal()" 
                    class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors"
                >
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('verification-code').focus();
}

async function verifyPhoneCode() {
    const code = document.getElementById('verification-code').value.trim();
    
    if (!code) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
        return;
    }
    
    try {
        const response = await fetch('/api/user/phone/verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ code })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('–¢–µ–ª–µ—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!');
            closeVerificationModal();
            location.reload();
        } else {
            alert(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
        }
    } catch (error) {
        console.error('Error verifying code:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
}

function closeVerificationModal() {
    const modal = document.getElementById('verification-modal');
    if (modal) {
        modal.remove();
    }
}

</script>

        <!-- Settings Section -->
        <div class="content-section" id="settings">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mb-6 space-y-3">
                        {% for category, message in messages %}
                            <div class="flex items-center justify-between p-4 rounded-2xl border-2 {% if category == 'success' %}bg-gradient-to-r from-emerald-50 to-green-50 border-emerald-200{% elif category == 'error' %}bg-gradient-to-r from-red-50 to-rose-50 border-red-200{% else %}bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200{% endif %} shadow-sm">
                                <div class="flex items-center gap-3">
                                    {% if category == 'success' %}
                                    <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <span class="text-emerald-900 font-medium">{{ message }}</span>
                                    {% elif category == 'error' %}
                                    <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                    <span class="text-red-900 font-medium">{{ message }}</span>
                                    {% else %}
                                    <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-blue-900 font-medium">{{ message }}</span>
                                    {% endif %}
                                </div>
                                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-white/50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Simple Section Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                <p class="text-gray-600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∞–∫–∫–∞—É–Ω—Ç–∞</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Profile Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-8">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                        
                        <form method="POST" action="{{ url_for('profile') }}" class="space-y-6">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            
                            <!-- Profile Photo -->
                            <div class="mb-6 pb-6 border-b border-gray-200">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</label>
                                <div class="flex items-center gap-4">
                                    <img id="profile-avatar" 
                                         src="{{ current_user.profile_image }}" 
                                         data-initials="{{ current_user.full_name[0].upper() if current_user.full_name else '–ü' }}"
                                         class="avatar w-20 h-20 rounded-xl object-cover border-2 border-gray-200">
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <label for="avatar-upload" class="px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition-all text-center text-sm font-medium">
                                            –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                                        </label>
                                        <input type="file" id="avatar-upload" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                                        <span class="text-xs text-gray-500 self-center">PNG, JPG –¥–æ 5MB</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Full Name -->
                            <div>
                                <label for="full_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                    –§–ò–û
                                </label>
                                <input type="text" 
                                       id="full_name" 
                                       name="full_name" 
                                       value="{{ current_user.full_name }}"
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                       required>
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Email
                                </label>
                                <input type="email" 
                                       id="email" 
                                       name="email" 
                                       value="{{ current_user.email }}"
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                       required>
                            </div>

                            <!-- Phone -->
                            <div>
                                <label for="profile_phone" class="block text-sm font-semibold text-gray-700 mb-2">
                                    –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                                </label>
                                <input type="tel" 
                                       id="profile_phone" 
                                       name="phone" 
                                       value="{{ current_user.phone or '' }}"
                                       placeholder="+7 (___) ___-__-__"
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>

                            <!-- Telegram ID -->
                            <div>
                                <label for="telegram_id" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Telegram ID
                                    <span class="text-gray-500 font-normal text-xs ml-1">(–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)</span>
                                </label>
                                <input type="text" 
                                       id="telegram_id" 
                                       name="telegram_id" 
                                       value="{{ current_user.telegram_id or '' }}"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789"
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <div class="mt-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl">
                                    <div class="flex items-start gap-3">
                                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="text-sm text-blue-900 flex-1">
                                            <p class="font-semibold mb-2">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Telegram ID?</p>
                                            <ol class="list-decimal list-inside space-y-1.5 text-xs">
                                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <span class="font-mono bg-blue-100 px-1.5 py-0.5 rounded">@userinfobot</span></li>
                                                <li>–ù–∞–∂–º–∏—Ç–µ START –∏ –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –≤–∞—à ID</li>
                                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789) –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —ç—Ç–æ –ø–æ–ª–µ</li>
                                            </ol>
                                            <p class="mt-3 text-blue-800 font-medium flex items-center gap-1.5">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                </svg>
                                                –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –≤ Telegram!
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Divider -->
                            <div class="border-t-2 border-gray-100 pt-6 mt-8">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                                <p class="text-sm text-gray-600">–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å</p>
                            </div>

                            <!-- New Password -->
                            <div>
                                <label for="new_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                    –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                                </label>
                                <input type="password" 
                                       id="new_password" 
                                       name="new_password" 
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                       minlength="6"
                                       placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                            </div>

                            <!-- Confirm Password -->
                            <div>
                                <label for="confirm_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                                </label>
                                <input type="password" 
                                       id="confirm_password" 
                                       name="confirm_password" 
                                       class="w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                       minlength="6"
                                       placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                            </div>

                            <!-- Submit Buttons -->
                            <div class="flex flex-col sm:flex-row items-center gap-4 pt-6 border-t-2 border-gray-100">
                                <a href="#" onclick="document.querySelector('[data-page=dashboard]').click(); return false;" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3.5 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    –ù–∞–∑–∞–¥
                                </a>
                                <button type="submit" 
                                        class="w-full sm:flex-1 inline-flex items-center justify-center gap-2 px-8 py-3.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:from-blue-600 hover:to-indigo-700 shadow-lg hover:shadow-xl transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Manager Info -->
                    {% if current_user.assigned_manager_id and assigned_manager %}
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-5">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                                <div class="flex-shrink-0" id="managerAvatarContainer">
                                    {% if assigned_manager.profile_image and 'randomuser.me' not in assigned_manager.profile_image %}
                                        {% if assigned_manager.profile_image.startswith('http') or assigned_manager.profile_image.startswith('/static/') or assigned_manager.profile_image.startswith('/') %}
                                            <img src="{{ assigned_manager.profile_image }}" 
                                                 alt="{{ assigned_manager.full_name }}"
                                                 class="avatar w-14 h-14 rounded-xl object-cover border-2 border-white shadow manager-avatar"
                                                 data-initials="{{ assigned_manager.full_name[0].upper() if assigned_manager.full_name else '–ú' }}">
                                        {% else %}
                                            <img src="{{ url_for('static', filename=assigned_manager.profile_image) }}" 
                                                 alt="{{ assigned_manager.full_name }}"
                                                 class="avatar w-14 h-14 rounded-xl object-cover border-2 border-white shadow manager-avatar"
                                                 data-initials="{{ assigned_manager.full_name[0].upper() if assigned_manager.full_name else '–ú' }}">
                                        {% endif %}
                                    {% else %}
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-xl shadow">
                                        {{ assigned_manager.full_name[0].upper() if assigned_manager.full_name else '–ú' }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-900 truncate">{{ assigned_manager.full_name }}</p>
                                    <p class="text-xs text-gray-600 truncate">{{ assigned_manager.position or '–°—Ç–∞—Ä—à–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä' }}</p>
                                </div>
                            </div>
                            
                            {% if assigned_manager.phone %}
                            <a href="tel:{{ assigned_manager.phone }}" class="flex items-center gap-3 p-3 text-sm text-gray-700 hover:bg-blue-50 rounded-xl transition-colors group">
                                <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-200 rounded-lg flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <span class="font-medium">{{ assigned_manager.phone }}</span>
                            </a>
                            {% endif %}
                            
                            {% if assigned_manager.email %}
                            <a href="mailto:{{ assigned_manager.email }}" class="flex items-center gap-3 p-3 text-sm text-gray-700 hover:bg-blue-50 rounded-xl transition-colors group">
                                <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-200 rounded-lg flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <span class="font-medium truncate">{{ assigned_manager.email }}</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border-2 border-dashed border-blue-300 p-8 text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-2">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h3>
                        <p class="text-sm text-gray-600 mb-5">–í–∞–º –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</p>
                        <a href="{{ url_for('contacts') }}" class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl text-sm font-semibold hover:from-blue-600 hover:to-indigo-700 shadow-lg transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                        </a>
                    </div>
                    {% endif %}

                    <!-- Account Info -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-5">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                <span class="text-sm text-gray-600 font-medium">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
                                <span class="text-sm font-bold text-gray-900">{{ current_user.created_at.strftime('%d.%m.%Y') if current_user.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                <span class="text-sm text-gray-600 font-medium">–°—Ç–∞—Ç—É—Å</span>
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-bold {% if current_user.is_active %}bg-gradient-to-r from-emerald-500 to-green-600 text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
                                    {% if current_user.is_active %}
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    –ê–∫—Ç–∏–≤–µ–Ω
                                    {% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                <span class="text-sm text-gray-600 font-medium">–ò—Å—Ç–æ—á–Ω–∏–∫</span>
                                <span class="text-sm font-bold text-gray-900">{{ current_user.registration_source or 'Website' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            // Phone formatting for settings page
            document.getElementById('profile_phone').addEventListener('input', function (e) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                e.target.value = !x[2] ? x[1] : '+' + x[1] + ' (' + x[2] + ') ' + x[3] + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
            });

            // Password confirmation validation for settings page
            document.querySelector('#settings form').addEventListener('submit', function(e) {
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                
                if (newPassword && newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                    return false;
                }
            });

            // Avatar upload function for settings page
            function uploadAvatar(input) {
                if (!input.files || !input.files[0]) {
                    return;
                }
                
                const file = input.files[0];
                
                // Validate file type
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: PNG, JPG, JPEG, GIF, WEBP');
                    input.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 5MB');
                    input.value = '';
                    return;
                }
                
                // Show loading state
                const avatar = document.getElementById('profile-avatar');
                const originalSrc = avatar.src;
                
                // Create FormData and upload
                const formData = new FormData();
                formData.append('avatar', file);
                
                fetch('{{ url_for("upload_user_avatar") }}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update avatar image
                        avatar.src = data.avatar_url + '?t=' + new Date().getTime();
                        alert('–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                        avatar.src = originalSrc;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
                    avatar.src = originalSrc;
                })
                .finally(() => {
                    input.value = '';
                });
            }
            </script>
        </div>
        <!-- End Settings Section -->

</div><!-- End sidebar content wrapper -->
<!-- Load PostgreSQL comparison functionality -->
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>

<script>
// Sidebar tab switching
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Sidebar tab switching initialized');
    
    // Get all sidebar links
    const sidebarLinks = document.querySelectorAll('.sidebar-link[data-page]');
    console.log('üîç Found sidebar links:', sidebarLinks.length);
    
    function switchPage(page) {
        console.log('üîÑ Switching to page:', page);
        
        // Save active tab to localStorage
        localStorage.setItem('dashboard_active_tab', page);
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show selected section
        const targetSection = document.getElementById(page);
        if (targetSection) {
            targetSection.classList.add('active');
            console.log('‚úÖ Activated section:', page);
            
            // Load content for specific pages
            if (page === 'favorites') {
                console.log('üî• Loading favorites content...');
                loadFavoritesList();
            } else if (page === 'comparison') {
                console.log('üî• Loading comparison content...');
                if (typeof loadComparisonContent === 'function') {
                    loadComparisonContent();
                }
            }
        } else {
            console.warn('‚ùå Section not found:', page);
        }
        
        // Update sidebar active state
        sidebarLinks.forEach(l => {
            const isActive = l.getAttribute('data-page') === page;
            
            if (isActive) {
                // Add active styles (light and dark mode)
                l.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'text-[#0088CC]', 'dark:text-blue-400');
                l.classList.remove('text-gray-700', 'dark:text-gray-300');
            } else {
                // Remove active styles and restore inactive
                l.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'text-[#0088CC]', 'dark:text-blue-400');
                l.classList.add('text-gray-700', 'dark:text-gray-300');
            }
        });
        
        // Update tab buttons active state
        document.querySelectorAll('.tab-button').forEach(btn => {
            const isActive = btn.getAttribute('data-page') === page;
            
            if (isActive) {
                // Active button: Blue border and text, no hover
                btn.classList.add('border-[#0088CC]', 'text-[#0088CC]');
                btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            } else {
                // Inactive button: Transparent border, gray text, with hover
                btn.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
        });
    }
    
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const page = this.getAttribute('data-page');
            const href = this.getAttribute('href');
            
            // If href doesn't start with #, it's an external link - let it navigate normally
            if (href && !href.startsWith('#')) {
                console.log('üîó Following external link:', href);
                return; // Don't prevent default, allow navigation
            }
            
            e.preventDefault();
            switchPage(page);
            this.classList.add('active');
        });
    });
    
    // Also handle tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            switchPage(page);
        });
    });
    
    // Restore last active tab from localStorage or set default to dashboard
    const savedTab = localStorage.getItem('dashboard_active_tab') || 'dashboard';
    console.log('üìå Active tab:', savedTab);
    
    // Always apply switchPage to ensure correct highlighting
    const targetSection = document.getElementById(savedTab);
    if (targetSection) {
        switchPage(savedTab);
    } else {
        // Fallback to dashboard if saved tab doesn't exist
        console.log('üìå Saved tab not found, switching to dashboard');
        switchPage('dashboard');
    }
});
</script>
{% endblock %}
