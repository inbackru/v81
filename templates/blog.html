{% extends "base.html" %}

{% block title %}InBack –ñ—É—Ä–Ω–∞–ª | –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏{% endblock %}
{% block description %}InBack –ñ—É—Ä–Ω–∞–ª - —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ–± –∏–ø–æ—Ç–µ–∫–µ, –∑–∞–∫–æ–Ω–∞—Ö, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –≤ —Å—Ñ–µ—Ä–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ {{ current_city.name_genitive if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞' }}{% endblock %}
{% block keywords %}–±–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∫—ç—à–±–µ–∫ –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∏–ø–æ—Ç–µ–∫–∞ {{ current_city.name if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä' }}, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç—ã{% endblock %}

{% block head %}
<!-- Robots meta -->
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('blog', _external=True) }}">
<meta property="og:title" content="InBack –ñ—É—Ä–Ω–∞–ª | –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏">
<meta property="og:description" content="InBack –ñ—É—Ä–Ω–∞–ª - —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ–± –∏–ø–æ—Ç–µ–∫–µ, –∑–∞–∫–æ–Ω–∞—Ö, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –≤ —Å—Ñ–µ—Ä–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ {{ current_city.name_genitive if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞' }}">
<meta property="og:image" content="{{ url_for('static', filename='images/blog-og.jpg', _external=True) }}">
<meta property="og:site_name" content="InBack">
<meta property="og:locale" content="ru_RU">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ url_for('blog', _external=True) }}">
<meta name="twitter:title" content="InBack –ñ—É—Ä–Ω–∞–ª | –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏">
<meta name="twitter:description" content="–ò–ø–æ—Ç–µ–∫–∞, –∑–∞–∫–æ–Ω—ã, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}">
<meta name="twitter:image" content="{{ url_for('static', filename='images/blog-og.jpg', _external=True) }}">

<!-- Canonical -->
<link rel="canonical" href="{{ url_for('blog', _external=True) }}" />
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="container mx-auto px-4 py-3 text-sm">
    <nav aria-label="Breadcrumb" class="flex">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a class="text-[#0088CC] hover:underline inline-flex items-center" href="{{ url_for('index') }}">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path clip-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" fill-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-500 ml-1 md:ml-2">InBack –ñ—É—Ä–Ω–∞–ª</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<!-- Hero Section with 3D Animation -->
<section class="relative py-20 bg-gradient-to-b from-white to-gray-50 overflow-hidden">
    <!-- 3D Background Elements -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="floating-shape floating-shape-1"></div>
        <div class="floating-shape floating-shape-2"></div>
        <div class="floating-shape floating-shape-3"></div>
        <div class="floating-shape floating-shape-4"></div>
        <div class="floating-shape floating-shape-5"></div>
        <div class="grid-overlay"></div>
    </div>
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 text-center relative z-10">
        <div class="hero-content">
            <h1 class="text-5xl md:text-7xl font-bold text-gray-900 mb-6 hero-title">
                <span class="inline-block transform-3d">InBack</span>
                <span class="inline-block transform-3d text-[#0088CC]">–ñ—É—Ä–Ω–∞–ª</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 mb-10 max-w-4xl mx-auto leading-relaxed hero-subtitle">
                –ò–ø–æ—Ç–µ–∫–∞, –∑–∞–∫–æ–Ω—ã, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}
            </p>
        </div>
        
        <!-- Advanced Search -->
        <div class="max-w-xl mx-auto">
            <div class="relative">
                <input type="text" 
                       id="blog-search-input" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—å—è–º..."
                       value="{{ search_query or '' }}"
                       class="w-full px-6 py-4 pr-14 text-gray-900 bg-white bg-opacity-90 backdrop-blur-md rounded-3xl border-0 shadow-2xl focus:ring-4 focus:ring-white focus:ring-opacity-50 focus:outline-none transition-all duration-300 placeholder-gray-500"
                       autocomplete="off">
                <button id="search-btn" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-[#0088CC] hover:bg-[#006699] text-white rounded-2xl flex items-center justify-center transition-all duration-200 hover:scale-105">
                    <i class="fas fa-search text-sm"></i>
                </button>
                
                <!-- Search Suggestions Dropdown -->
                <div id="search-suggestions" class="absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-10">
                    <!-- Dynamic suggestions will be inserted here -->
                </div>
                
                <!-- Search Results Count -->
                {% if search_query %}
                <div class="absolute top-full left-0 right-0 mt-2 text-white text-sm text-center">
                    <span class="bg-[#0088CC] bg-opacity-80 px-3 py-1 rounded-full">
                        –ù–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ç–µ–π: {{ articles|length }}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Search Tags -->
            <div class="flex flex-wrap justify-center gap-2 mt-4">
                <button class="quick-search-tag px-3 py-1 text-sm bg-white bg-opacity-20 text-white rounded-full hover:bg-opacity-30 transition-all" data-query="–∫—ç—à–±–µ–∫">
                    –∫—ç—à–±–µ–∫
                </button>
                <button class="quick-search-tag px-3 py-1 text-sm bg-white bg-opacity-20 text-white rounded-full hover:bg-opacity-30 transition-all" data-query="–∏–ø–æ—Ç–µ–∫–∞">
                    –∏–ø–æ—Ç–µ–∫–∞
                </button>
                <button class="quick-search-tag px-3 py-1 text-sm bg-white bg-opacity-20 text-white rounded-full hover:bg-opacity-30 transition-all" data-query="–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏">
                    –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="quick-search-tag px-3 py-1 text-sm bg-white bg-opacity-20 text-white rounded-full hover:bg-opacity-30 transition-all" data-query="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">
                    –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
                </button>
            </div>
        </div>
    </div>
</section>


<!-- Category Navigation -->
<nav class="container mx-auto px-4 py-8">
    <div class="flex flex-wrap justify-center gap-2">
        {% set active_category = current_category.slug if current_category else category_filter %}
        <a href="/blog" class="{% if not active_category %}bg-[#0088CC] text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %} text-xs px-3 py-1 rounded-full transition-colors">
            –í—Å–µ
        </a>
        {% for category in all_categories %}
        <a href="/blog/category/{{ category.slug }}" class="{% if active_category == category.slug %}bg-[#0088CC] text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %} text-xs px-3 py-1 rounded-full transition-colors">
            {{ category.name }}
        </a>
        {% endfor %}
    </div>
</nav>

<!-- Sort & Filter Controls -->
<div class="container mx-auto px-4 pt-4 pb-0">
    <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">
            –°—Ç–∞—Ç–µ–π: <span class="font-semibold text-gray-700">{{ total_articles }}</span>
        </p>
        <div class="flex items-center gap-2">
            <label for="blog-sort" class="text-sm text-gray-500 whitespace-nowrap">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <select id="blog-sort" onchange="applyBlogSort(this.value)" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-[#0088CC]/20 focus:border-[#0088CC]">
                <option value="date_desc" {% if sort_order == 'date_desc' or not sort_order %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="date_asc" {% if sort_order == 'date_asc' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            </select>
        </div>
    </div>
</div>

<!-- Main Content with Dynamic Categories -->
<div class="container mx-auto px-4 py-12">
    {% if show_category_sections %}
    <!-- –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏) -->
    {% for item in categories_with_articles %}
    {% set category = item.category %}
    {% set category_articles = item.articles %}
    <!-- {{ category.name }} Section -->
    <section class="mb-16">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-900">{{ category.name }}</h2>
            <a href="/blog/category/{{ category.slug }}" class="text-[#0088CC] hover:text-[#006699] font-medium">
                –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
            </a>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for article in category_articles %}
            <article class="group">
                <a href="{{ article.url }}" class="block bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 hover:-translate-y-1 h-full w-full cursor-pointer">
                    <div class="aspect-[4/3] relative bg-cover bg-center" 
                         style="background-image: url('{{ article.featured_image }}');">
                        <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                        <div class="absolute top-4 left-4 w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-newspaper text-white text-xl"></i>
                        </div>
                        <div class="absolute bottom-4 left-4 right-4 text-white z-10">
                            {% if article.category_name %}
                            <div class="inline-block bg-[#0088CC] text-white text-xs px-2 py-1 rounded mb-2">
                                {{ article.category_name }}
                            </div>
                            {% endif %}
                            <div class="text-xs opacity-80 mb-1">{{ article.published_at|russian_date if article.published_at else article.created_at|russian_date }}</div>
                            <h3 class="text-lg font-bold line-clamp-2 group-hover:text-blue-200 transition-colors">
                                {{ article.title }}
                            </h3>
                        </div>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-600 line-clamp-3 mb-3">
                            {{ article.excerpt|striptags }}
                        </p>
                        <div class="text-xs text-gray-500">
                            –ß–∏—Ç–∞—Ç—å {{ article.reading_time }} –º–∏–Ω
                        </div>
                    </div>
                </a>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endfor %}
    {% else %}
    <!-- –†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏–ª–∏ –ø–æ–∏—Å–∫–æ–º) -->
    <div id="articles-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for article in articles %}
        <article class="group">
            <a href="{{ article.url }}" class="block bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 hover:-translate-y-1 h-full w-full cursor-pointer">
                <div class="aspect-[4/3] relative bg-cover bg-center" 
                     style="background-image: url('{{ article.featured_image }}');">
                    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                    <div class="absolute top-4 left-4 w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-newspaper text-white text-xl"></i>
                    </div>
                    <div class="absolute bottom-4 left-4 right-4 text-white z-10">
                        {% if article.category_name %}
                        <div class="inline-block bg-[#0088CC] text-white text-xs px-2 py-1 rounded mb-2">
                            {{ article.category_name }}
                        </div>
                        {% endif %}
                        <div class="text-xs opacity-80 mb-1">{{ article.published_at|russian_date if article.published_at else article.created_at|russian_date }}</div>
                        <h3 class="text-lg font-bold line-clamp-2 group-hover:text-blue-200 transition-colors">
                            {{ article.title }}
                        </h3>
                    </div>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 line-clamp-3 mb-3">
                        {{ article.excerpt|striptags }}
                    </p>
                    <div class="text-xs text-gray-500">
                        –ß–∏—Ç–∞—Ç—å {{ article.reading_time }} –º–∏–Ω
                    </div>
                </div>
            </a>
        </article>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Pagination -->
    {% if total_pages and total_pages > 1 %}
    <div class="flex justify-center items-center gap-2 mt-12 mb-8">
        {% if current_page > 1 %}
        <a href="/blog?page={{ current_page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_order and sort_order != 'date_desc' %}&sort={{ sort_order }}{% endif %}" 
           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 transition-colors">
            ¬´ –ü—Ä–µ–¥—ã–¥—É—â–∞—è
        </a>
        {% endif %}
        
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num == current_page %}
            <span class="px-4 py-2 bg-[#0088CC] text-white rounded-lg font-semibold">
                {{ page_num }}
            </span>
            {% elif page_num == 1 or page_num == total_pages or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
            <a href="/blog?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_order and sort_order != 'date_desc' %}&sort={{ sort_order }}{% endif %}" 
               class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 transition-colors">
                {{ page_num }}
            </a>
            {% elif page_num == current_page - 2 or page_num == current_page + 2 %}
            <span class="px-2 text-gray-400">...</span>
            {% endif %}
        {% endfor %}
        
        {% if current_page < total_pages %}
        <a href="/blog?page={{ current_page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_order and sort_order != 'date_desc' %}&sort={{ sort_order }}{% endif %}" 
           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 transition-colors">
            –°–ª–µ–¥—É—é—â–∞—è ¬ª
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- CTA Block - –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è -->
<div class="container mx-auto px-4 mb-12">
    <div class="relative overflow-hidden bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-100 rounded-2xl p-8 lg:p-10">
        <!-- Decorative Icon (Desktop only) -->
        <div class="hidden lg:block absolute right-8 top-1/2 -translate-y-1/2 opacity-5">
            <svg class="w-32 h-32 text-blue-300" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
            </svg>
        </div>
        
        <div class="relative z-10">
            <div class="lg:flex lg:items-center lg:justify-between lg:gap-8">
                <div class="mb-6 lg:mb-0 lg:flex-1">
                    <h3 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3">
                        –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã? –ó–∞–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!
                    </h3>
                    <p class="text-gray-600 text-base lg:text-lg mb-4 lg:mb-0">
                        –†–∞—Å—Å–∫–∞–∂–µ–º –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, –∏–ø–æ—Ç–µ–∫–µ –∏ –∫—ç—à–±–µ–∫–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è.
                    </p>
                </div>
                
                <div class="lg:flex-shrink-0">
                    <button onclick="openApplicationModal()" 
                            class="w-full lg:w-auto px-8 py-4 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-xl hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg hover:shadow-xl font-semibold text-base lg:text-lg whitespace-nowrap">
                        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
                    </button>
                    <p class="text-sm text-gray-500 text-center mt-2">
                        –û—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function applyBlogSort(sortValue) {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortValue);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    const blogSearchInput = document.getElementById('blog-search-input');
    const searchBtn = document.getElementById('search-btn');
    const quickSearchTags = document.querySelectorAll('.quick-search-tag');
    const articlesContainer = document.getElementById('articles-container');
    
    let searchTimeout;
    let isSearching = false;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
    async function performLiveSearch(query) {
        try {
            console.log('üîç Live search triggered with query:', query);
            console.log('üì¶ Articles container found:', !!articlesContainer);
            
            const trimmedQuery = query.trim();
            
            // –ï—Å–ª–∏ –º—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–ª–æ–≥–∞ (–±–µ–∑ –ø–æ–∏—Å–∫–∞), –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–µ–≥–∞–º
            if (!articlesContainer && trimmedQuery) {
                console.log('üîÑ No articles container found, search mode redirect handled by tag click');
                return;
            }
            
            isSearching = true;
            
            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ç–µ–π
            if (!trimmedQuery) {
                window.location.href = '/blog';
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
            const url = `/api/blog/search?q=${encodeURIComponent(trimmedQuery)}`;
            console.log('üì° Making API request to:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('üì® API response:', data);
            
            console.log('üîß Processing API data:', data);
            
            if (data.articles && articlesContainer) {
                console.log('‚úÖ Calling updateArticlesDisplay');
                updateArticlesDisplay(data.articles, trimmedQuery);
            } else {
                console.error('‚ùå Cannot update display:', {
                    hasArticles: !!data.articles,
                    hasContainer: !!articlesContainer
                });
            }
            
            isSearching = false;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            isSearching = false;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–µ–π
    function updateArticlesDisplay(articles, query) {
        console.log('üé® updateArticlesDisplay called with:', {
            articlesCount: articles.length,
            query: query,
            containerExists: !!articlesContainer
        });
        
        if (!articlesContainer) {
            console.error('‚ùå Articles container not found!');
            return;
        }
        
        if (articles.length === 0) {
            articlesContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="text-gray-400 text-6xl mb-4">üìù</div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">–°—Ç–∞—Ç—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p class="text-gray-600">–ü–æ –∑–∞–ø—Ä–æ—Å—É "${query}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.</p>
                </div>
            `;
            return;
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å—Ç–∞—Ç–µ–π
        let articlesHTML = '';
        articles.forEach(article => {
            articlesHTML += `
                <article class="group">
                    <a href="${article.url}" class="block bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 hover:-translate-y-1 h-full w-full cursor-pointer">
                        <div class="aspect-[4/3] relative bg-cover bg-center" 
                             style="background-image: url('${article.featured_image}'); pointer-events: none;">
                            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                            <div class="absolute top-4 left-4 w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-percentage text-white text-xl"></i>
                            </div>
                            <div class="absolute bottom-4 left-4 right-4 text-white z-10">
                                <div class="text-xs opacity-80 mb-1">${formatDate(article.published_at || article.created_at)}</div>
                                <h3 class="text-lg font-bold line-clamp-2 group-hover:text-blue-200 transition-colors">
                                    ${highlightSearchTerm(article.title, query)}
                                </h3>
                            </div>
                        </div>
                        <div class="p-4" style="pointer-events: none;">
                            <p class="text-sm text-gray-600 line-clamp-3 mb-3">
                                ${highlightSearchTerm(article.excerpt, query)}
                            </p>
                            <div class="text-xs text-gray-500">
                                –ß–∏—Ç–∞—Ç—å ${article.reading_time || 5} –º–∏–Ω
                            </div>
                        </div>
                    </a>
                </article>
            `;
        });
        
        articlesContainer.innerHTML = articlesHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    function highlightSearchTerm(text, term) {
        if (!text || !term) return text || '';
        const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    function formatDate(dateStr) {
        if (!dateStr) return '–ù–µ–¥–∞–≤–Ω–æ';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (Enter –∏–ª–∏ –∫–Ω–æ–ø–∫–∞)
    function performBlogSearch(query) {
        if (query.trim()) {
            window.location.href = `/blog?search=${encodeURIComponent(query.trim())}`;
        } else {
            window.location.href = '/blog';
        }
    }
    
    // Live search –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
    if (blogSearchInput) {
        blogSearchInput.addEventListener('input', function(e) {
            const query = e.target.value;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–≥–æ–≤ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ (–µ—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏–∫–æ–º—É –∏–∑ —Ç–µ–≥–æ–≤)
            const matchingTag = Array.from(quickSearchTags).find(tag => tag.dataset.query === query);
            if (!matchingTag) {
                setActiveTag(null); // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–≥–∏
            } else {
                setActiveTag(query); // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–≥
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            clearTimeout(searchTimeout);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è debounce (500ms)
            searchTimeout = setTimeout(() => {
                if (!isSearching) {
                    performLiveSearch(query);
                }
            }, 500);
        });
    }
    
    // Handle search button click
    if (searchBtn) {
        searchBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (blogSearchInput) {
                performBlogSearch(blogSearchInput.value);
            }
        });
    }
    
    // Handle Enter key in search input
    if (blogSearchInput) {
        blogSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performBlogSearch(this.value);
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ç–µ–≥–æ–≤
    function setActiveTag(activeQuery) {
        quickSearchTags.forEach(tag => {
            const tagQuery = tag.dataset.query;
            if (activeQuery && tagQuery === activeQuery) {
                // –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–≥ - —Å–∏–Ω–∏–π —Ñ–æ–Ω
                tag.classList.add('bg-blue-500', 'bg-opacity-100');
                tag.classList.remove('bg-white', 'bg-opacity-20');
                console.log('üè∑Ô∏è Activated tag:', tagQuery);
            } else {
                // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–≥ - –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω
                tag.classList.remove('bg-blue-500', 'bg-opacity-100');
                tag.classList.add('bg-white', 'bg-opacity-20');
            }
        });
        
        if (!activeQuery) {
            console.log('üè∑Ô∏è All tags deactivated');
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–≥–∞
    function checkInitialActiveTag() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');
        if (searchQuery && blogSearchInput) {
            blogSearchInput.value = searchQuery;
            setActiveTag(searchQuery);
        }
    }
    
    // Handle quick search tags
    console.log('üè∑Ô∏è Found quick search tags:', quickSearchTags.length);
    
    quickSearchTags.forEach((tag, index) => {
        console.log(`üè∑Ô∏è Setting up tag ${index}:`, tag.dataset.query, 'Element:', tag);
        console.log(`üè∑Ô∏è Tag classes:`, tag.className);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        tag.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üè∑Ô∏è Quick tag clicked (click event):', this.dataset.query);
            console.log('üè∑Ô∏è Tag element:', this);
            
            const query = this.dataset.query;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ù–ï–ú–ï–î–õ–ï–ù–ù–û –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
            setActiveTag(query);
            
            if (blogSearchInput) {
                blogSearchInput.value = query;
                console.log('üè∑Ô∏è Starting live search for tag:', query);
                
                // –ï—Å–ª–∏ –º—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–ª–æ–≥–∞ (–±–µ–∑ –ø–æ–∏—Å–∫–∞), –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞
                // –Ω–æ –ê–ö–¢–ò–í–ù–´–ô –¢–ï–ì —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä
                if (!articlesContainer) {
                    console.log('üîÑ Redirecting to search mode with active tag...');
                    window.location.href = `/blog?search=${encodeURIComponent(query)}`;
                    return;
                }
                
                // –ï—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–∏—Å–∫–∞, –ø—Ä–æ—Å—Ç–æ –∏—â–µ–º
                performLiveSearch(query);
            }
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
        tag.addEventListener('mousedown', function(e) {
            console.log('üè∑Ô∏è Tag mousedown:', this.dataset.query);
        });
        
        tag.addEventListener('mouseup', function(e) {
            console.log('üè∑Ô∏è Tag mouseup:', this.dataset.query);
        });
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkInitialActiveTag();
});
</script>

{% endblock %}
