<!-- Collapsible Sidebar Component - Aceternity Style -->
<aside id="app-sidebar" class="fixed top-0 left-0 z-[51] h-screen transition-all duration-300 ease-in-out bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 shadow-lg sidebar-collapsed">
    <!-- Desktop Sidebar -->
    <div class="hidden md:flex flex-col h-full px-3 py-4">
        <!-- Logo -->
        <div class="flex items-center mb-8 transition-all duration-300 h-10" id="sidebar-logo">
            <a href="/" class="flex items-center space-x-2 min-w-0">
                <div class="w-8 h-8 bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    In
                </div>
                <span class="font-bold text-gray-900 dark:text-white whitespace-nowrap overflow-hidden sidebar-text opacity-0">InBack</span>
            </a>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 space-y-1 overflow-y-auto overflow-x-hidden">
            {% for link in sidebar_links %}
            <a href="{{ link.href }}" 
               class="sidebar-link flex items-center px-3 py-3 text-gray-700 dark:text-gray-300 rounded-lg transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 group relative {% if link.active %}bg-blue-50 dark:bg-blue-900/20 text-[#0088CC] dark:text-blue-400{% endif %}"
               data-page="{{ link.page }}">
                <div class="w-5 h-5 flex-shrink-0 {% if link.active %}text-[#0088CC]{% endif %}">
                    {{ link.icon|safe }}
                </div>
                <span class="sidebar-text ml-3 text-sm font-medium whitespace-nowrap overflow-hidden opacity-0 transition-all duration-200 group-hover:translate-x-1">
                    {{ link.label }}
                </span>
                {% if link.badge %}
                {% if link.badge_color == 'balance' %}
                <span class="sidebar-text ml-auto bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-medium opacity-0 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/></svg>
                    {{ link.badge }}
                </span>
                {% else %}
                <span class="sidebar-text ml-auto bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full font-medium opacity-0">
                    {{ link.badge }}
                </span>
                {% endif %}
                {% endif %}
            </a>
            {% endfor %}
        </nav>

        <!-- User Profile / Logout -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
            {% if user_profile %}
            <div class="relative" id="avatar-checkin-wrapper">
                <button onclick="toggleCheckinDropdown(event)" class="sidebar-link flex items-center px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 group w-full">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 overflow-hidden relative">
                        {% if user_profile.avatar %}
                        <img src="{{ user_profile.avatar }}" alt="{{ user_profile.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-r from-[#0088CC] to-[#006699] flex items-center justify-center text-white font-bold text-sm">
                            {{ user_profile.initials }}
                        </div>
                        {% endif %}
                        <div id="checkin-indicator" class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white bg-gray-300"></div>
                    </div>
                    <div class="sidebar-text ml-3 overflow-hidden opacity-0">
                        <p class="text-sm font-medium whitespace-nowrap">{{ user_profile.name }}</p>
                        <p class="text-xs whitespace-nowrap" id="checkin-status-text">
                            <span class="text-gray-400">Загрузка...</span>
                        </p>
                    </div>
                </button>
                <div id="checkin-dropdown" class="hidden absolute bottom-full left-0 mb-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden">
                    <div class="p-3 border-b border-gray-100">
                        <p class="text-sm font-semibold text-gray-900">{{ user_profile.name }}</p>
                        <p class="text-xs text-gray-400" id="checkin-dropdown-status">Не на работе</p>
                    </div>
                    <div class="p-2">
                        <button id="checkin-btn" onclick="doCheckin()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all hover:bg-green-50 text-green-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span id="checkin-btn-text">На работе</span>
                        </button>
                        <a href="{{ user_profile.href }}" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all hover:bg-gray-50 text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                            Профиль
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <a href="{{ url_for('logout') }}" class="sidebar-link flex items-center px-3 py-2 mt-2 text-red-600 dark:text-red-400 rounded-lg transition-all duration-200 hover:bg-red-50 dark:hover:bg-red-900/20 group">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <span class="sidebar-text ml-3 text-sm font-medium whitespace-nowrap overflow-hidden opacity-0">
                    Выход
                </span>
            </a>
        </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <div class="md:hidden flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
        <a href="/" class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center text-white font-bold text-sm">
                In
            </div>
            <span class="font-bold text-gray-900 dark:text-white">InBack</span>
        </a>
        <button id="mobile-sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" id="hamburger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 hidden" id="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-sidebar-menu" class="hidden md:hidden h-full overflow-y-auto bg-white dark:bg-gray-900 pb-20">
        <nav class="px-4 py-4 space-y-1">
            {% for link in sidebar_links %}
            <a href="{{ link.href }}" 
               class="flex items-center justify-between px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-800 {% if link.active %}bg-blue-50 dark:bg-blue-900/20 text-[#0088CC]{% endif %}"
               data-page="{{ link.page }}">
                <div class="flex items-center space-x-3">
                    <div class="w-5 h-5 flex-shrink-0">
                        {{ link.icon|safe }}
                    </div>
                    <span class="text-sm font-medium">{{ link.label }}</span>
                </div>
                {% if link.badge %}
                {% if link.badge_color == 'balance' %}
                <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-medium flex items-center gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/></svg>
                    {{ link.badge }}
                </span>
                {% else %}
                <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full font-medium">
                    {{ link.badge }}
                </span>
                {% endif %}
                {% endif %}
            </a>
            {% endfor %}
        </nav>

        <div class="border-t border-gray-200 dark:border-gray-700 mx-4 my-4"></div>

        {% if user_profile %}
        <a href="{{ user_profile.href }}" class="flex items-center px-8 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">
            <div class="w-10 h-10 rounded-full flex-shrink-0 overflow-hidden">
                {% if user_profile.avatar %}
                <img src="{{ user_profile.avatar }}" alt="{{ user_profile.name }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full bg-gradient-to-r from-[#0088CC] to-[#006699] flex items-center justify-center text-white font-bold">
                    {{ user_profile.initials }}
                </div>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium">{{ user_profile.name }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ user_profile.role }}</p>
            </div>
        </a>
        {% endif %}

        <a href="{{ url_for('logout') }}" class="flex items-center px-8 py-3 mt-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            <span class="ml-3 text-sm font-medium">Выход</span>
        </a>
    </div>
</aside>

<style>
/* Sidebar States */
#app-sidebar.sidebar-collapsed {
    width: 70px;
}

#app-sidebar.sidebar-expanded {
    width: 280px;
}

#app-sidebar.sidebar-collapsed .sidebar-text {
    opacity: 0;
    width: 0;
}

#app-sidebar.sidebar-expanded .sidebar-text {
    opacity: 1;
    width: auto;
}

/* Smooth transitions */
#app-sidebar {
    transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
}

.sidebar-text {
    transition: opacity 200ms cubic-bezier(0.4, 0, 0.2, 1), width 200ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Hide scrollbar but keep functionality */
#app-sidebar nav::-webkit-scrollbar {
    width: 4px;
}

#app-sidebar nav::-webkit-scrollbar-track {
    background: transparent;
}

#app-sidebar nav::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 2px;
}

#app-sidebar nav::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* Mobile overlay */
@media (max-width: 768px) {
    #app-sidebar {
        transform: translateX(-100%);
        width: 100% !important;
        max-width: 320px;
    }
    
    #app-sidebar.mobile-open {
        transform: translateX(0);
    }
}
</style>

<script>
// Sidebar Logic
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('app-sidebar');
    const mobileToggle = document.getElementById('mobile-sidebar-toggle');
    const mobileSidebarMenu = document.getElementById('mobile-sidebar-menu');
    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');
    
    // Desktop: Hover to expand/collapse
    if (window.innerWidth >= 768) {
        sidebar.addEventListener('mouseenter', function() {
            sidebar.classList.remove('sidebar-collapsed');
            sidebar.classList.add('sidebar-expanded');
        });
        
        sidebar.addEventListener('mouseleave', function() {
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
        });
    }
    
    // Mobile: Toggle menu
    if (mobileToggle) {
        mobileToggle.addEventListener('click', function() {
            const isOpen = mobileSidebarMenu.classList.contains('hidden');
            
            if (isOpen) {
                mobileSidebarMenu.classList.remove('hidden');
                hamburgerIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
                sidebar.classList.add('mobile-open');
            } else {
                mobileSidebarMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                sidebar.classList.remove('mobile-open');
            }
        });
    }
    
    // Close mobile menu when clicking a link
    const mobileLinks = mobileSidebarMenu?.querySelectorAll('a');
    if (mobileLinks) {
        mobileLinks.forEach(link => {
            link.addEventListener('click', function() {
                mobileSidebarMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                sidebar.classList.remove('mobile-open');
            });
        });
    }

    loadCheckinStatus();

    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('checkin-dropdown');
        const wrapper = document.getElementById('avatar-checkin-wrapper');
        if (dropdown && wrapper && !wrapper.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
});

function toggleCheckinDropdown(e) {
    e.preventDefault();
    e.stopPropagation();
    const dropdown = document.getElementById('checkin-dropdown');
    if (dropdown) dropdown.classList.toggle('hidden');
}

function updateCheckinUI(isCheckedIn, since, duration) {
    const indicator = document.getElementById('checkin-indicator');
    const statusText = document.getElementById('checkin-status-text');
    const dropdownStatus = document.getElementById('checkin-dropdown-status');
    const btnText = document.getElementById('checkin-btn-text');
    const btn = document.getElementById('checkin-btn');
    if (indicator) {
        indicator.className = 'absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white ' + (isCheckedIn ? 'bg-green-500' : 'bg-gray-300');
    }
    if (statusText) {
        statusText.innerHTML = isCheckedIn
            ? '<span class="text-green-600 font-medium">На работе с ' + since + '</span>'
            : '<span class="text-gray-400">Не на работе</span>';
    }
    if (dropdownStatus) {
        dropdownStatus.textContent = isCheckedIn ? 'На работе с ' + since + ' (' + (duration || '') + ')' : 'Не на работе';
        dropdownStatus.className = 'text-xs ' + (isCheckedIn ? 'text-green-600 font-medium' : 'text-gray-400');
    }
    if (btn && btnText) {
        if (isCheckedIn) {
            btnText.textContent = 'Уйти с работы';
            btn.className = 'w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all hover:bg-red-50 text-red-600';
        } else {
            btnText.textContent = 'На работе';
            btn.className = 'w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all hover:bg-green-50 text-green-700';
        }
    }
}

async function loadCheckinStatus() {
    try {
        const res = await fetch('/api/manager/checkin/status');
        const data = await res.json();
        if (data.success) {
            updateCheckinUI(data.is_checked_in, data.since || '', data.duration || '');
        }
    } catch(e) {
        console.log('Checkin status unavailable');
    }
}

async function doCheckin() {
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        const res = await fetch('/api/manager/checkin', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken} });
        const data = await res.json();
        if (data.success) {
            if (data.status === 'checked_in') {
                updateCheckinUI(true, data.time, '0м');
            } else {
                updateCheckinUI(false, '', '');
            }
        }
    } catch(e) { console.error('Checkin error:', e); }
    document.getElementById('checkin-dropdown')?.classList.add('hidden');
}
</script>
