{% extends "base.html" %}

{% block title %}–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} - InBack.ru{% endblock %}

{% block description %}–í–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}. –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏ –ñ–ö —Å –∫—ç—à–±–µ–∫–æ–º.{% endblock %}

{% block content %}
<div class="bg-gradient-to-r from-[#0088CC] to-[#006699] text-white py-6 md:py-16 hidden md:block">
    <div class="container mx-auto px-4 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
            <div class="favorites-counter">
                <i class="fas fa-heart text-4xl"></i>
                <div class="badge show">0</div>
            </div>
        </div>
        <h1 class="text-4xl font-bold mb-4">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h1>
        <p class="text-xl text-blue-100 max-w-2xl mx-auto">
            –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ. –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ –≤—ã–±–∏—Ä–∞–π—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏.
        </p>
    </div>
</div>

<div class="md:hidden pt-4 pb-2 px-4">
    <h1 class="text-xl font-bold text-gray-900">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>
</div>

<section class="py-6 md:py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Empty State -->
        <div id="empty-favorites" class="text-center py-8 md:py-16">
            <div class="mb-6 md:mb-8">
                <i class="fas fa-heart text-4xl md:text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-lg md:text-2xl font-bold text-gray-700 mb-3 md:mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</h2>
                <p class="text-gray-500 mb-8 max-w-md mx-auto">
                    –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –Ω–∞–∂–∏–º–∞—è –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –æ–±—ä–µ–∫—Ç–∞
                </p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{{ url_for('properties') }}" class="inline-flex items-center px-6 py-3 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    –ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä
                </a>
                <a href="{{ url_for('districts') }}" class="inline-flex items-center px-6 py-3 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-blue-50 transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    –í—ã–±—Ä–∞—Ç—å —Ä–∞–π–æ–Ω
                </a>
            </div>

            <!-- Pulse Animation Tutorial -->
            <div class="mt-12 p-6 bg-white rounded-xl shadow-md max-w-lg mx-auto">
                <h3 class="font-semibold mb-4 flex items-center justify-center gap-2">
                    <span>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?</span>
                </h3>
                <div class="flex items-center justify-center gap-4 mb-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <i class="fas fa-home text-2xl text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-600">–ù–∞–π–¥–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É</p>
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <div class="favorite-heart pulse">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ</p>
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <div class="favorite-heart favorited">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">–ì–æ—Ç–æ–≤–æ!</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500">
                    –°–µ—Ä–¥–µ—á–∫–æ —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω—ã–º –∏ –±—É–¥–µ—Ç –ø—É–ª—å—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
                </p>
            </div>
        </div>

        <!-- Favorites Grid -->
        <div id="favorites-grid" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <div class="flex space-x-1 favorites-tabs">
                    <button onclick="switchFavoritesTab('properties')" id="fav-tab-properties" class="fav-tab active px-6 py-2.5 rounded-lg text-sm font-medium bg-[#0088CC] text-white transition-colors">
                        <i class="fas fa-home mr-2"></i>–ö–≤–∞—Ä—Ç–∏—Ä—ã (<span id="properties-count">0</span>)
                    </button>
                    <button onclick="switchFavoritesTab('complexes')" id="fav-tab-complexes" class="fav-tab px-6 py-2.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-building mr-2"></i>–ñ–ö (<span id="complexes-count">0</span>)
                    </button>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="compareSelectedProperties()" id="compare-btn" class="hidden px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                        <i class="fas fa-balance-scale mr-2"></i>
                        –°—Ä–∞–≤–Ω–∏—Ç—å (<span id="selected-count">0</span>)
                    </button>
                    <button onclick="clearAllFavorites()" class="px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition-colors text-sm">
                        <i class="fas fa-trash mr-2"></i>
                        –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
            </div>

            <div id="properties-section" class="favorites-content">
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
                <div id="properties-empty" class="text-center py-12">
                    <i class="fas fa-home text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä</p>
                    <p class="text-gray-400 text-sm mt-2">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –Ω–∞–∂–∏–º–∞—è –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ</p>
                    <a href="{{ url_for('properties') }}" class="inline-flex items-center px-5 py-2.5 mt-4 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        <i class="fas fa-search mr-2"></i>–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã
                    </a>
                </div>
            </div>

            <div id="complexes-section" class="favorites-content hidden">
                <div id="complexes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
                <div id="complexes-empty" class="text-center py-12">
                    <i class="fas fa-building text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö</p>
                    <p class="text-gray-400 text-sm mt-2">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</p>
                    <a href="{{ url_for('residential_complexes') }}" class="inline-flex items-center px-5 py-2.5 mt-4 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        <i class="fas fa-search mr-2"></i>–°–º–æ—Ç—Ä–µ—Ç—å –ñ–ö
                    </a>
                </div>
            </div>

            <!-- Comparison Panel (Hidden by default) -->
            <div id="comparison-panel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-6 border-b">
                        <h3 class="text-xl font-bold">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
                        <button onclick="closeComparison()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="comparison-content" class="p-6">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let totalProperties = 0;
let totalComplexes = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadAllFavorites();
});

function switchFavoritesTab(tab) {
    document.querySelectorAll('.fav-tab').forEach(btn => {
        btn.classList.remove('active', 'bg-[#0088CC]', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-600');
    });
    
    const activeTab = document.getElementById(`fav-tab-${tab}`);
    if (activeTab) {
        activeTab.classList.remove('bg-gray-100', 'text-gray-600');
        activeTab.classList.add('active', 'bg-[#0088CC]', 'text-white');
    }
    
    document.querySelectorAll('.favorites-content').forEach(el => el.classList.add('hidden'));
    const target = document.getElementById(`${tab}-section`);
    if (target) target.classList.remove('hidden');
    
    const compareBtn = document.getElementById('compare-btn');
    if (compareBtn) {
        if (tab === 'properties' && totalProperties > 0) {
            compareBtn.classList.remove('hidden');
        } else {
            compareBtn.classList.add('hidden');
        }
    }
}

async function loadAllFavorites() {
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ...');
    
    const [propertiesResult, complexesResult] = await Promise.allSettled([
        loadPropertyFavorites(),
        loadComplexFavorites()
    ]);
    
    if (totalProperties === 0 && totalComplexes === 0) {
        showEmptyState();
    } else {
        if (totalProperties > 0) {
            switchFavoritesTab('properties');
        } else {
            switchFavoritesTab('complexes');
        }
    }
}

async function loadPropertyFavorites() {
    try {
        const response = await fetch('/api/favorites/list');
        const data = await response.json();
        
        if (data.success && data.favorites && data.favorites.length > 0) {
            totalProperties = data.favorites.length;
            renderFavoriteCards(data.favorites);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä:', error);
    }
}

async function loadComplexFavorites() {
    try {
        const response = await fetch('/api/complexes/favorites/list');
        const data = await response.json();
        console.log('Complex favorites response:', data);
        
        let complexIds = [];
        
        if (data.success && data.complexes && data.complexes.length > 0) {
            totalComplexes = data.complexes.length;
            renderComplexCards(data.complexes.map(c => ({...c, complex_id: c.id || c.complex_id})));
            return;
        } else if (data.success && data.favorites && data.favorites.length > 0) {
            complexIds = data.favorites.map(fav => fav.complex_id || fav.id).filter(Boolean);
        }
        
        if (complexIds.length === 0 && window.favoritesManager && window.favoritesManager.favoriteComplexes) {
            const fmComplexes = window.favoritesManager.favoriteComplexes;
            complexIds = fmComplexes.map(item => typeof item === 'object' ? item.id : item).filter(Boolean);
            console.log('Using FavoritesManager complex IDs:', complexIds);
        }
        
        if (complexIds.length === 0) {
            try {
                const stored = localStorage.getItem('inback_favorite_complexes');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    complexIds = parsed.map(item => typeof item === 'object' ? item.id : item).filter(Boolean);
                    console.log('Using localStorage complex IDs:', complexIds);
                }
            } catch(e) {}
        }
        
        if (complexIds.length > 0) {
            const complexDetails = await Promise.all(
                complexIds.map(async (complexId) => {
                    try {
                        const res = await fetch(`/api/complex/${complexId}`);
                        const detail = await res.json();
                        if (detail.success !== false) {
                            return { ...detail, complex_id: complexId };
                        }
                        return null;
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö:', complexId, e);
                        return null;
                    }
                })
            );
            
            const validComplexes = complexDetails.filter(c => c !== null);
            totalComplexes = validComplexes.length;
            
            if (validComplexes.length > 0) {
                renderComplexCards(validComplexes);
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö:', error);
    }
}

function updateTotalCount() {
    const total = totalProperties + totalComplexes;
    const headerBadge = document.querySelector('.favorites-counter .badge');
    if (headerBadge) headerBadge.textContent = total;
    
    const propertiesCount = document.getElementById('properties-count');
    const complexesCount = document.getElementById('complexes-count');
    if (propertiesCount) propertiesCount.textContent = totalProperties;
    if (complexesCount) complexesCount.textContent = totalComplexes;
}

function renderComplexCards(complexes) {
    const emptyState = document.getElementById('empty-favorites');
    const favoritesGrid = document.getElementById('favorites-grid');
    const complexesContainer = document.getElementById('complexes-container');
    const complexesCount = document.getElementById('complexes-count');
    const complexesEmpty = document.getElementById('complexes-empty');
    
    emptyState.classList.add('hidden');
    favoritesGrid.classList.remove('hidden');
    complexesCount.textContent = complexes.length;
    if (complexesEmpty) complexesEmpty.classList.add('hidden');
    updateTotalCount();
    
    const cardsHTML = complexes.map(complex => {
        const name = complex.name || complex.title || '–ñ–ö';
        const developer = complex.developer || complex.developer_name || '';
        const address = complex.address || '';
        const image = complex.image || complex.main_image || complex.photo || '/static/images/placeholder.jpg';
        const complexId = complex.complex_id || complex.id;
        
        let priceText = '';
        if (complex.price_from || complex.min_price) {
            const price = complex.price_from || complex.min_price;
            priceText = '–æ—Ç ' + Number(price).toLocaleString('ru-RU') + ' ‚ÇΩ';
        } else if (complex.price_range) {
            priceText = complex.price_range;
        }
        
        const completionDate = complex.completion_date || complex.deadline || '';
        
        return `
            <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative">
                <div class="relative">
                    <img src="${image}" alt="${name}" class="w-full h-48 object-cover" onerror="this.src='/static/images/placeholder.jpg'">
                    <button onclick="removeComplexFavorite('${complexId}')" 
                            class="absolute top-3 right-3 w-10 h-10 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center z-20">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
                <div class="p-3 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold mb-2 text-gray-800">${name}</h3>
                    ${developer ? `<p class="text-sm text-gray-600 mb-2"><i class="fas fa-hard-hat mr-1 text-[#0088CC]"></i> ${developer}</p>` : ''}
                    ${address ? `<p class="text-sm text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i> ${address}</p>` : ''}
                    ${completionDate ? `<p class="text-sm text-gray-600 mb-3"><i class="fas fa-calendar-alt mr-1 text-[#0088CC]"></i> –°–¥–∞—á–∞: ${completionDate}</p>` : ''}
                    ${priceText ? `<div class="text-xl font-bold text-[#0088CC] mb-4">${priceText}</div>` : ''}
                    <a href="/residential-complex/${complexId}" 
                       class="block px-4 py-2 bg-[#0088CC] text-white text-center rounded-lg hover:bg-[#0077BB] transition-colors font-medium">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>
            </div>
        `;
    }).join('');
    
    complexesContainer.innerHTML = cardsHTML;
}

async function removeComplexFavorite(complexId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) return;
    
    try {
        const response = await fetch(`/api/complexes/favorites/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ complex_id: complexId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            totalComplexes = 0;
            totalProperties = 0;
            await loadAllFavorites();
        } else {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ñ–ö:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
}

function renderFavoriteCards(favorites) {
    const emptyState = document.getElementById('empty-favorites');
    const favoritesGrid = document.getElementById('favorites-grid');
    const favoritesContainer = document.getElementById('favorites-container');
    const propertiesSection = document.getElementById('properties-section');
    const propertiesCount = document.getElementById('properties-count');
    
    emptyState.classList.add('hidden');
    favoritesGrid.classList.remove('hidden');
    propertiesCount.textContent = favorites.length;
    const propertiesEmpty = document.getElementById('properties-empty');
    if (propertiesEmpty) propertiesEmpty.classList.add('hidden');
    updateTotalCount();
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    const cardsHTML = favorites.map(property => {
        const isSold = property.is_sold || false;
        
        // –ö–ª–∞—Å—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        const cardClass = isSold 
            ? 'bg-gray-100 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden opacity-75 relative' 
            : 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative';
        
        const titleClass = isSold 
            ? 'text-lg font-semibold mb-2 text-gray-500 line-through' 
            : 'text-lg font-semibold mb-2 text-gray-800';
        
        const priceClass = isSold 
            ? 'text-xl font-bold text-gray-400' 
            : 'text-xl font-bold text-blue-600';
        
        const imageClass = isSold 
            ? 'w-full h-48 object-cover grayscale' 
            : 'w-full h-48 object-cover';
        
        // –ë–µ–π–¥–∂ "–ü–†–û–î–ê–ù"
        const statusBadge = isSold 
            ? `<div class="absolute top-3 right-3 z-20">
                 <span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                   ${property.status_label || '–ü–†–û–î–ê–ù'}
                 </span>
               </div>`
            : `<button onclick="removeFavorite('${property.id}')" 
                      class="absolute top-3 right-3 w-10 h-10 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center z-20">
                  <i class="fas fa-heart"></i>
               </button>`;
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        const actionButtons = isSold 
            ? `<div class="flex gap-2 mt-4">
                 <button onclick="removeFavorite('${property.id}')" 
                         class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm font-medium">
                   <i class="fas fa-trash mr-1"></i> –£–¥–∞–ª–∏—Ç—å
                 </button>
                 ${property.similar_search_url 
                   ? `<a href="${property.similar_search_url}" 
                         class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium text-center">
                        <i class="fas fa-search mr-1"></i> –ü–æ–¥–æ–±—Ä–∞—Ç—å –∞–Ω–∞–ª–æ–≥
                      </a>`
                   : ''}
               </div>`
            : `<a href="/property/${property.inner_id || property.id}" 
                  class="block mt-4 px-4 py-2 bg-[#0088CC] text-white text-center rounded-lg hover:bg-[#0077BB] transition-colors font-medium">
                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ
               </a>`;
        
        return `
            <div class="${cardClass}">
                <div class="relative">
                    <img src="${property.image}" alt="${property.title}" class="${imageClass}">
                    ${statusBadge}
                </div>
                <div class="p-3 sm:p-6">
                    <h3 class="${titleClass} text-base sm:text-lg">${property.title}</h3>
                    <p class="text-xs sm:text-sm ${isSold ? 'text-gray-400' : 'text-gray-600'} mb-1 sm:mb-2">üìç ${property.district}</p>
                    <p class="text-xs sm:text-sm ${isSold ? 'text-gray-400' : 'text-gray-600'} mb-2 sm:mb-3">üè¢ ${property.complex}</p>
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-1 mb-2 sm:mb-3">
                        <div class="${priceClass} text-lg sm:text-xl">${property.price.toLocaleString()} ‚ÇΩ</div>
                        ${isSold 
                          ? `<div class="text-xs sm:text-sm text-gray-400 italic">–ö—ç—à–±–µ–∫ –±—ã–ª: ${property.cashback_amount.toLocaleString()} ‚ÇΩ</div>`
                          : `<div class="text-xs sm:text-sm text-green-600 font-medium">üí∞ ${property.cashback_amount.toLocaleString()} ‚ÇΩ</div>`
                        }
                    </div>
                    <div class="text-xs text-gray-500">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${property.created_at}</div>
                    ${actionButtons}
                </div>
            </div>
        `;
    }).join('');
    
    favoritesContainer.innerHTML = cardsHTML;
    console.log('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
}

function showEmptyState() {
    const emptyState = document.getElementById('empty-favorites');
    const favoritesGrid = document.getElementById('favorites-grid');
    
    emptyState.classList.remove('hidden');
    favoritesGrid.classList.add('hidden');
    document.getElementById('properties-section').classList.add('hidden');
    document.getElementById('complexes-section').classList.add('hidden');
}

// ‚úÖ –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –ò–ó –ò–ó–ë–†–ê–ù–ù–û–ì–û
async function removeFavorite(propertyId) {
    console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', propertyId);
    
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/favorites/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ property_id: propertyId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            totalProperties = 0;
            totalComplexes = 0;
            await loadAllFavorites();
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', data.message);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
}

// ‚úÖ –í–ï–°–¨ –°–¢–ê–†–´–ô –ö–û–î –£–î–ê–õ–ï–ù - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 –Ω–æ–≤—ã–µ –ø—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—à–µ

function renderPropertyCard(property) {
    const pricePerSqm = property.area ? Math.round(property.price / property.area) : 0;
    return `
        <div class="property-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative">
            <!-- Favorite Heart (always favorited on this page) -->
            <div class="favorite-heart favorited" data-property-id="${property.id}" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ">
                <i class="fas fa-heart"></i>
            </div>
            
            <!-- Comparison Checkbox -->
            <div class="absolute top-3 left-3 z-20">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" class="comparison-checkbox sr-only" data-property-id="${property.id}" onchange="updateComparisonButton()">
                    <div class="w-6 h-6 bg-white border-2 border-gray-300 rounded flex items-center justify-center transition-colors hover:border-blue-500">
                        <i class="fas fa-check text-[#0088CC] text-xs hidden"></i>
                    </div>
                </label>
            </div>
            
            <img src="${property.image}" alt="${property.title}" class="w-full h-48 object-cover">
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">${property.title}, ${property.area} –º¬≤</h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${property.district}, ${property.complex_name}
                </p>
                <p class="text-gray-600 text-sm mb-3">${property.floor}/${property.total_floors} —ç—Ç–∞–∂</p>
                
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-[#0088CC]">
                            ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        <div class="text-sm text-gray-500">
                            ${pricePerSqm.toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-green-600">–ö—ç—à–±–µ–∫ 5%</div>
                        <div class="text-sm text-gray-500">–¥–æ ${Math.floor(property.price * 0.05).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <a href="/object/${property.id}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                    <button onclick="shareProperty(${property.id})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                        <i class="fas fa-share-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function updateComparisonButton() {
    const selected = document.querySelectorAll('.comparison-checkbox:checked');
    const compareBtn = document.getElementById('compare-btn');
    const selectedCount = document.getElementById('selected-count');
    
    selectedCount.textContent = selected.length;
    
    if (selected.length >= 2) {
        compareBtn.classList.remove('hidden');
    } else {
        compareBtn.classList.add('hidden');
    }
}

function clearAllFavorites() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã?')) {
        if (window.favoritesManager) {
            window.favoritesManager.clearAllFavorites();
        }
        loadFavoritesPage();
    }
}

function shareProperty(propertyId) {
    const url = `${window.location.origin}/object/${propertyId}`;
    if (navigator.share) {
        navigator.share({
            title: '–ö–≤–∞—Ä—Ç–∏—Ä–∞ —Å –∫—ç—à–±–µ–∫–æ–º –Ω–∞ InBack.ru',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            window.favoritesManager?.showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        });
    }
}

// Comparison functionality
function compareSelectedProperties() {
    const selected = Array.from(document.querySelectorAll('.comparison-checkbox:checked'))
                          .map(cb => cb.dataset.propertyId);
    
    if (selected.length < 2) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
        return;
    }
    
    // Show comparison panel
    document.getElementById('comparison-panel').classList.remove('hidden');
    // Add comparison logic here
}

function closeComparison() {
    document.getElementById('comparison-panel').classList.add('hidden');
}
</script>

<style>
/* Custom checkbox styles */
.comparison-checkbox:checked + div {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.comparison-checkbox:checked + div i {
    display: block !important;
}

/* Favorite heart positioning for favorites page */
.property-card .favorite-heart {
    top: 12px;
    right: 12px;
}
</style>
{% endblock %}