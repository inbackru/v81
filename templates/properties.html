{% extends "base.html" %}
{% set city_slug = current_city.slug if current_city else (session.city_slug if session.city_slug else 'krasnodar') %}

{% block title %}–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | inback{% endblock %}
{% block description %}–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ 2,5-5% –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É? –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ Inback. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}{% endblock %}
{% block keywords %}–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É, –∫—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É, –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É, —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–±–µ–∫–∞ inback, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—ç—à–±–µ–∫–∞, —ç—Ç–∞–ø—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–±–µ–∫–∞, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞—Ö –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ —Å –∫—ç—à–±–µ–∫–æ–º, –∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º, –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫–≤–∞—Ä—Ç–∏—Ä—ã –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, –∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –°–æ—á–∏, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –°–æ—á–∏, –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –∏–ø–æ—Ç–µ–∫—É –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –æ–¥–Ω–æ–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –¥–≤—É—Ö–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, —Å—Ç—É–¥–∏—è –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞, –∫–≤–∞—Ä—Ç–∏—Ä–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞ —Å –∫—ç—à–±–µ–∫–æ–º, –∂–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ –Ω–µ–¥–æ—Ä–æ–≥–æ, –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä —Ü–µ–Ω—ã, –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å –æ—Ç–¥–µ–ª–∫–æ–π –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä{% endblock %}

{% block extra_head %}
<!-- Robots meta -->
<meta name="robots" content="index, follow">
<!-- City ID and Coordinates for JavaScript filters -->
<meta name="city-id" content="{{ current_city.id if current_city else 1 }}">
<meta name="city-lat" content="{{ current_city.latitude if current_city else 45.0355 }}">
<meta name="city-lon" content="{{ current_city.longitude if current_city else 38.9753 }}">
<meta name="city-zoom" content="{{ current_city.zoom_level if current_city else 12 }}">
<!-- DEBUG: Verify city context + Set global city coordinates -->
<script>
window.cityCoordinates = [{{ current_city.latitude if current_city else 45.0355 }}, {{ current_city.longitude if current_city else 38.9753 }}];
window.cityZoom = {{ current_city.zoom_level if current_city else 12 }};
window.currentCityName = "{{ current_city.name if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä' }}";
console.log("‚úÖ GLOBAL CITY SET: name={{current_city.name if current_city else 'NULL'}}, center=[{{ current_city.latitude if current_city else 45.0355 }}, {{ current_city.longitude if current_city else 38.9753 }}]");
</script>

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('properties', _external=True) }}">
<meta property="og:title" content="–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | InBack">
<meta property="og:description" content="–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ 2,5-5% –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É? –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ InBack. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}">
<meta property="og:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<meta property="og:site_name" content="InBack">
<meta property="og:locale" content="ru_RU">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ url_for('properties', _external=True) }}">
<meta name="twitter:title" content="–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | InBack">
<meta name="twitter:description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞ –ø–æ–∫—É–ø–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ {{ current_city.name_genitive if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞' }}. –ö—ç—à–±–µ–∫ 2,5-5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∂–∏–ª—å—è.">
<meta name="twitter:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<!-- ‚ö° –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫—ç—à–∞ HTML -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- Canonical URL handled by base.html -->

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "–ì–ª–∞–≤–Ω–∞—è",
      "item": "https://inback.ru"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏",
      "item": "https://inback.ru/properties"
    }
  ]
}
</script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
<style>
    /* Hide scrollbar for map room filters */
    .overflow-x-auto::-webkit-scrollbar {
        display: none;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 640px) {
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª - —Ç–æ–ª—å–∫–æ –¥–ª—è properties page */
        body.properties-page {
            overflow-x: hidden !important;
        }
        
        /* Properties container - single column only */
        #properties-container {
            display: flex !important;
            flex-direction: column !important;
            max-width: 100% !important;
            width: 100% !important;
        }
        
        #properties-container > div,
        #properties-container > * {
            max-width: 100% !important;
            width: 100% !important;
            display: block !important;
            flex-wrap: nowrap !important;
        }
        
        /* MOBILE: Sticky search bar (Avito-style) with SuperSearch */
        #mobile-search-bar {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.98);
        }
        
        /* Mobile search input (now property-search on mobile) */
        #mobile-search-bar #property-search {
            font-size: 0.875rem !important;
        }
        
        #mobile-search-bar #property-search::placeholder {
            color: #9ca3af !important;
        }
    
        /* MOBILE: –°–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ hero –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –º–æ–±–∞–π–ª–µ */
        #properties-hero {
            display: none !important;
        }
        
        /* MOBILE: –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è search —Å–µ–∫—Ü–∏—è */
        section.py-8.bg-gray-50 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        /* –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /properties) */
        section.py-8.bg-gray-50 .bg-white.rounded-lg.shadow-md {
            padding: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Desktop search input */
        section.py-8.bg-gray-50 #property-search-desktop {
            padding: 0.625rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "–ü–æ–∏—Å–∫ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏" */
        section.py-8.bg-gray-50 .flex .text-sm.text-gray-500 {
            display: none !important;
        }

    
        
        /* MOBILE: –§–∏–ª—å—Ç—Ä—ã –≤ —Å—Ç–∏–ª–µ Avito - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º */
        section.py-8.bg-gray-50 .filters-container {
            padding: 0.75rem 0 !important;
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        
        /* –°–ö–†–´–í–ê–ï–ú –Ω–∞–¥–ø–∏—Å—å "–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã" –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 .filters-container > div > .text-gray-600.whitespace-nowrap.font-medium {
            display: none !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –ë–ï–ó —Å–∫—Ä–æ–ª–ª–∞, flex-wrap –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ */
        section.py-8.bg-gray-50 .filters-container > div {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            padding: 0 1rem !important;
            width: 100% !important;
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        section.py-8.bg-gray-50 .filters-container > div > div {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            width: 100% !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫ –∏ —Å–¥–∞—á—É –Ω–∞ –º–æ–±–∞–π–ª–µ - –æ–Ω–∏ –±—É–¥—É—Ç –≤ "–ï—â—ë" */
        section.py-8.bg-gray-50 .dropdown[data-filter="developers"],
        section.py-8.bg-gray-50 .dropdown[data-filter="completion"] {
            display: none !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–ï—â—ë" - —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        section.py-8.bg-gray-50 #advancedFiltersToggle {
            flex: 0 0 auto !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ - —Å—Ç–∏–ª—å Avito */
        section.py-8.bg-gray-50 .dropdown-btn {
            font-size: 0.875rem !important;
            padding: 0.75rem 1rem !important;
            border-radius: 0 !important;
            border: none !important;
            background: white !important;
            white-space: nowrap !important;
            font-weight: 400 !important;
            transition: all 0.2s !important;
            color: #374151 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-btn:active {
            background: #F3F4F6 !important;
            transform: scale(0.98) !important;
        }
        
        /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #active-filters-container {
            padding: 0.5rem !important;
            margin-top: 0.75rem !important;
            border-radius: 0.5rem !important;
        }
        
        section.py-8.bg-gray-50 #active-filters-container .text-sm {
            font-size: 0.75rem !important;
        }
        
        section.py-8.bg-gray-50 #active-filters-container #active-filters-list {
            gap: 0.375rem !important;
        }
        
        /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–∫–∞–∑ –ø—É—Å—Ç—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #active-filters-container.hidden {
            display: none !important;
        }
        
        /* –ö–†–ò–¢–ò–ß–ù–û: –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∫–æ–≥–¥–∞ –æ–Ω–∏ –∑–∞–∫—Ä—ã—Ç—ã */
        section.py-8.bg-gray-50 #advancedFiltersPanel.hidden {
            display: none !important;
        }
        
        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ */
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) .grid {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) .p-6 {
            padding: 1rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) h4 {
            font-size: 0.875rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) label {
            font-size: 0.8125rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) input,
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) select {
            font-size: 0.875rem !important;
            padding: 0.5rem !important;
        }
        
        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –í–°–ï–ì–î–ê –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 10000 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            max-height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
            background: white !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #closeAdvancedFilters {
            display: none !important;
        }
        
        /* Dropdown –º–µ–Ω—é –Ω–∞ –º–æ–±–∞–π–ª–µ - –≤—ã—Å–æ–∫–∏–π z-index */
        section.py-8.bg-gray-50 .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.75rem !important;
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        section.py-8.bg-gray-50 .dropdown {
            position: relative !important;
            z-index: 10 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative !important;
            z-index: 10 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-item {
            padding: 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è —Ü–µ–Ω—ã */
        section.py-8.bg-gray-50 #priceFrom,
        section.py-8.bg-gray-50 #priceTo {
            font-size: 0.75rem !important;
            padding: 0.375rem !important;
        }

        
        
        /* MOBILE: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã - —É–±–∏—Ä–∞–µ–º –Ω–∞–µ–∑–∂–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        #propertiesMapContainer {
            position: relative !important;
            z-index: 1 !important;
            width: 100% !important;
            margin: 0.5rem 0 !important;
        }
        
        #propertiesMap {
            height: 350px !important;
            width: 100% !important;
            position: relative !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã */
        #mapToggleBtn {
            width: 100% !important;
            justify-content: center !important;
            text-align: center !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º overflow –ø—Ä–æ–±–ª–µ–º—ã */
        #properties-container,
        .properties-list-container {
            overflow-x: hidden !important;
            width: 100% !important;
        }

        
        /* –ö–†–ò–¢–ò–ß–ù–û: –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π layout –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .property-card {
            margin-bottom: 12px;
            flex-direction: column !important;
            min-height: auto !important;
        }
        
        .property-card > div:first-child {
            width: 100% !important;
            height: 200px !important;
        }
        
        .property-card .carousel-container {
            height: 200px !important;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
            cursor: grab;
        }
        .property-card .carousel-container img {
            -webkit-user-drag: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            pointer-events: none;
            draggable: false;
        }
        
        .property-card .carousel {
            height: 200px;
        }
        
        .property-card .carousel-item img {
            height: 200px;
            object-fit: cover;
            background: #f8f9fa;
        }
        
        .property-card .carousel-controls {
            display: none;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-card > div:last-child {
            padding: 1rem !important;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-card h2 {
            font-size: 1.125rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* –¢–µ–≥–∏ */
        .property-card .flex.gap-2 {
            flex-wrap: wrap;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .property-card .flex.gap-2 button,
        .property-card .flex.gap-2 a {
            width: 36px !important;
            height: 36px !important;
        }
        
        /* –ë–ª–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .manager-block {
            padding: 0.75rem !important;
        }
        
        .manager-block .flex {
            flex-direction: column;
            gap: 0.75rem !important;
        }
        
        .manager-block img {
            width: 48px !important;
            height: 48px !important;
        }
        
        .manager-block h3 {
            font-size: 1rem !important;
        }
        
        .manager-block p {
            font-size: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-1 {
            font-size: 0.75rem !important;
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–æ–ø–∏–Ω–≥–æ–º */
        .pagination-bar {
            flex-direction: column !important;
            gap: 1rem !important;
            align-items: flex-start !important;
        }
        
        .pagination-bar .text-sm,
        .pagination-bar > div {
            font-size: 0.75rem !important;
        }
        
        .pagination-bar .flex {
            width: 100% !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .pagination-bar a,
        .pagination-bar span {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .pagination-bar button {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* MOBILE: Pagination –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
        #properties-container .pagination-bar {
            flex-direction: column !important;
            gap: 1rem !important;
        }
        
        /* Toolbar: row layout on mobile */
        #properties-toolbar > .flex {
            flex-direction: row !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }
        
        #properties-toolbar h3 {
            font-size: 1rem !important;
        }
        
        #properties-toolbar .flex.gap-2 {
            width: 100%;
            flex-wrap: wrap;
            gap: 0.5rem !important;
        }
        
        #properties-toolbar button,
        #properties-toolbar select {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        
        /* View toggle buttons styling */
        #properties-toolbar .flex.items-center.bg-gray-100 button {
            padding: 0.375rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #properties-toolbar .flex.items-center.bg-gray-100 svg {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }

        
        /* MOBILE: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ z-index –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ–Ω—é */
        header,
        nav,
        .mobile-menu-toggle,
        #mobile-menu,
        button[aria-label="Toggle menu"] {
            z-index: 9999 !important;
            position: relative !important;
        }
        
        /* –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–∞—Ä—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç header */
        #propertiesMap,
        #propertiesMapContainer,
        .ymaps-2-1-79-map {
            z-index: 1 !important;
        }
        
        /* Filters z-index - —Ç–æ–ª—å–∫–æ –¥–ª—è properties */
        section.py-8.bg-gray-50 .filters-container,
        section.py-8.bg-gray-50 .dropdown-menu {
            z-index: 50 !important;
        }
        
        /* –ü–æ–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ header */
        #property-search,
        #property-search-desktop,
        .bg-white.rounded-lg.shadow-md {
            z-index: 10 !important;
        }
        
        /* MOBILE: Bottom Sheet Styles */
        #bottomSheetBackdrop.active {
            opacity: 1 !important;
        }
        
        #propertyBottomSheet.active {
            transform: translateY(0) !important;
        }
        
        /* Property cards in bottom sheet */
        .property-sheet-card {
            min-width: 280px;
            max-width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            scroll-snap-align: start;
            transition: transform 0.2s;
        }
        
        .property-sheet-card:active {
            transform: scale(0.98);
        }
        
        /* Smooth scrolling for bottom sheet */
        #bottomSheetPropertiesContainer::-webkit-scrollbar {
            display: none;
        }
        
        #bottomSheetPropertiesContainer {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Vertical property cards in bottom sheet */
        .bottom-sheet-property-card {
            width: 100%;
            margin-bottom: 0.75rem;
        }

        }

    .mobile-quick-chip {
        background: white;
        color: #374151;
    }
    .mobile-quick-chip.active {
        background: #0088CC;
        color: white;
        border-color: #0088CC;
    }
    #mobile-quick-filters .overflow-x-auto::-webkit-scrollbar {
        display: none;
    }
    #mobile-quick-filters .overflow-x-auto {
        -ms-overflow-style: none;
        scrollbar-width: none;
        -webkit-overflow-scrolling: touch;
    }
    /* ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    
    /* –£–º–µ–Ω—å—à–∞–µ–º Hero section –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ */
    #properties-hero {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    #properties-hero h2 {
        margin-bottom: 0.5rem !important;
        font-size: 1.5rem !important;
    }
    
    #properties-hero p {
        margin-bottom: 0.5rem !important;
        font-size: 1rem !important;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –î–û–õ–ñ–ù–´ –±—ã—Ç—å flex –¥–ª—è horizontal layout */
    .property-card {
        display: flex !important;
        flex-direction: row !important;
        visibility: visible !important;
    }

    /* Compact dropdown menu - scoped to search section */
    #search-section .dropdown {
        position: relative;
        display: inline-block;
    }
    
    #search-section .dropdown-btn {
        background: white;
        border: none;
        color: #374151;
        font-weight: 400;
        padding: 0.75rem 1rem;
        border-radius: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    #search-section .dropdown-btn:hover {
        background: rgba(0, 136, 204, 0.1);
    }
    
    #search-section .dropdown-btn svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }
    
    #search-section .dropdown-btn.open svg {
        transform: rotate(180deg);
    }
    
    #search-section .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    #search-section .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-menu .dropdown-section {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-menu .dropdown-section:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu .dropdown-section h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .dropdown-menu .filter-option {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .dropdown-menu .filter-option:hover {
        color: #0088CC;
    }
    
    .dropdown-menu .filter-option input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        accent-color: #0088CC;
    }
    
    .dropdown-menu .price-inputs {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .price-inputs input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
    }
    
    .dropdown-menu .price-inputs input:focus {
        border-color: #0088CC;
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-menu .apply-price-btn {
        background: #0088CC;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        margin: 0.5rem 1rem 0;
        transition: opacity 0.2s;
    }
    
    .dropdown-menu .apply-price-btn:hover {
        opacity: 0.9;
    }
    
    /* Active filter chips - LIGHT GRAY MINIMAL STYLE */
    .active-filter-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #F3F4F6;
        color: #111827;
        padding: 0.375rem 0.75rem;
        border-radius: 12px;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        gap: 0.5rem;
        margin: 0.25rem;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    
    .active-filter-chip:hover {
        background: #E5E7EB;
    }
    
    .active-filter-chip .remove-btn {
        width: auto;
        height: auto;
        background: none;
        border-radius: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        color: #6B7280;
        line-height: 1;
        transition: color 0.2s ease;
        flex-shrink: 0;
        padding: 0 2px;
    }
    
    .active-filter-chip .remove-btn:hover {
        color: #111827;
    }
    
    /* Beautiful Filter Button Styles */
    .filter-option-btn {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        position: relative;
    }

    .filter-option-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn.active {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1d4ed8;
    }

    .filter-option-btn.active svg {
        color: #3b82f6;
    }

    /* Quick Filter Dropdown Styles - scoped to search section only */
    #search-section .dropdown {
        position: relative;
        display: inline-block;
    }

    #search-section .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #search-section .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem;
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    #search-section .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    #search-section .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background-color: #f3f4f6;
    }

    /* Filter counter badge */
    .filter-counter {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
    }
    
    /* Toggle switches */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #0088CC;
        background-color: #0088CC;
    }
    
    .toggle-checkbox:checked + .toggle-label {
        background-color: #0088CC;
    }
    
    .toggle-label {
        transition: background-color 0.2s;
    }
    
    /* Hide unsupported advanced filters based on user feedback */
    .filter-dropdown[data-filter="property_class"],
    .filter-dropdown[data-filter="wall_material"],
    .filter-dropdown[data-filter="floors_total"],
    .filter-dropdown[data-filter="window_view"],
    .filter-dropdown[data-filter="cardinal_direction"],
    .filter-dropdown[data-filter="apartment_category"],
    .filter-dropdown[data-filter="entrance_access"],
    .filter-dropdown[data-filter="panoramic"],
    .filter-dropdown[data-filter="developer_pv"],
    .filter-dropdown[data-filter="mortgage_types"],
    .filter-dropdown[data-filter="escrow"],
    .filter-dropdown[data-filter="property_rights_cost"],
    .filter-dropdown[data-filter="direction"],
    .filter-dropdown[data-filter="registration"],
    .filter-dropdown[data-filter="nearby_places"] {
        display: none !important;
    }
    
    /* Hide sections if they become empty */
    .space-y-3:has(.filter-dropdown:not([style*="display: none"]):only-child) {
        min-height: 100px;
    }
    
    /* Hide specific quick filter buttons by unique selectors */
    button[data-filter="distance"]:not(:only-child) {
        /* Keep "–î–æ —Ü–µ–Ω—Ç—Ä–∞" - it's supported */
    }
    
    /* More specific approach: manually hide unsupported buttons by finding parent containers */
    /* This will be handled by JavaScript after page load for better compatibility */
    
    /* Manager Favorites Styles */
    .manager-favorite-heart {
        transition: all 0.3s ease;
        background: rgba(0, 136, 204, 0.9) !important;
    }
    
    .manager-favorite-heart:hover {
        background: #0088CC !important;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    .manager-favorite-heart i {
        color: white !important;
        font-size: 14px;
    }
    
    .manager-favorite-heart.manager-favorited {
        background: #0088CC !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #0088CC;
    }
    
    /* Mobile Filter Modal Panels - Fullscreen */
    @media (max-width: 767px) {
        #advancedFiltersPanel,
        #roomsFilterPanel,
        #priceFilterPanel,
        #developerFilterPanel,
        #saveSearchModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            z-index: 9999 !important;
            overflow: hidden;
        }
        
        #advancedFiltersPanel.hidden,
        #roomsFilterPanel.hidden,
        #priceFilterPanel.hidden,
        #developerFilterPanel.hidden,
        #saveSearchModal.hidden {
            display: none !important;
        }
    }
    
    .manager-favorite-heart.manager-favorited i {
        color: #FFD700 !important;
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.pulse-blue {
        animation: pulse-blue 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Blue pulse animation for manager hearts */
    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 136, 204, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0);
        }
    }
    
    /* Heartbeat animation for favorited manager stars */
    @keyframes heartbeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
    
    /* Floating stars animation for manager favorites */
    .floating-star {
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        animation: float-up-star 2s ease-out forwards;
        font-size: 14px;
        color: #0088CC;
        text-shadow: 0 0 6px rgba(0, 136, 204, 0.8);
    }
    
    @keyframes float-up-star {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0.8);
        }
        50% {
            opacity: 1;
            transform: translateY(-30px) scale(1.2);
        }
        100% {
            opacity: 0;
            transform: translateY(-60px) scale(0.6);
        }
    }
    
    /* Ensure proper spacing between favorite buttons */
    .favorite-heart {
        transition: all 0.3s ease;
    }
    
    .favorite-heart:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .favorite-heart.favorited {
        box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444;
    }
    
    .favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Improve button container layout */
    .absolute.top-3.right-3.flex.gap-2 {
        right: 12px !important;
    }
    
    /* Manager AND User Comparison Styles - Using BRAND BLUE (same as favorites) */
    .compare-btn {
        transition: all 0.3s ease;
    }
    
    .compare-btn:hover i {
        color: white !important;
    }
    
    .compare-btn.manager-comparison-active,
    .compare-btn.user-comparison-active {
        background: #0088CC !important;
    }
    
    .compare-btn.manager-comparison-active i,
    .compare-btn.user-comparison-active i {
        color: white !important;
    }
    
    .compare-btn.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Scale beat animation for comparison icons */
    @keyframes scalebeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
    
    /* Fullscreen map property cards - 2 columns with full content visibility */
    #mapDesktopPropertiesContainer .property-card {
        display: flex !important;
        flex-direction: column !important;
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
    }
    
    #mapDesktopPropertiesContainer .property-card > .relative,
    #mapDesktopPropertiesContainer .property-card .carousel-container {
        width: 100% !important;
        height: 180px !important;
        min-height: 180px !important;
        max-height: 180px !important;
    }
    
    #mapDesktopPropertiesContainer .property-card .w-80 {
        width: 100% !important;
    }
    
    #mapDesktopPropertiesContainer .property-card .h-60 {
        height: 180px !important;
    }
    
    /* Ensure content section is fully visible */
    #mapDesktopPropertiesContainer .property-card .flex-1,
    #mapDesktopPropertiesContainer .property-card .p-6 {
        overflow: visible !important;
        height: auto !important;
    }
    
    /* Show all text content */
    #mapDesktopPropertiesContainer .property-card * {
        overflow: visible !important;
        text-overflow: unset !important;
        white-space: normal !important;
    }
</style>

<script>
// City slug for URL generation
var citySlug = '{{ city_slug }}';
window.citySlug = citySlug;

// ‚ö° –†–ê–ù–ù–ò–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –§–£–ù–ö–¶–ò–ô - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –î–û –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML –ø–∞–Ω–µ–ª–µ–π
// –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã inline onclick –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–∞–Ω–µ–ª—è—Ö

console.log('‚ö° Early filter functions initializing...');

window.removeFilterAndReload = function(filterType, value) {
    console.log('üîÑ removeFilterAndReload:', filterType, value);
    var url = new URL(window.location.href);
    
    if (filterType === 'rooms') {
        var currentRooms = url.searchParams.get('rooms');
        if (currentRooms && value !== undefined) {
            var roomsArray = currentRooms.split(',').filter(r => r !== String(value));
            if (roomsArray.length > 0) {
                url.searchParams.set('rooms', roomsArray.join(','));
            } else {
                url.searchParams.delete('rooms');
            }
        } else {
            url.searchParams.delete('rooms');
        }
    } else if (filterType === 'price') {
        url.searchParams.delete('price_min');
        url.searchParams.delete('price_max');
    } else if (filterType === 'property_type') {
        url.searchParams.delete('property_type');
    } else if (filterType === 'area') {
        url.searchParams.delete('area_min');
        url.searchParams.delete('area_max');
    } else {
        url.searchParams.delete(filterType);
    }
    
    window.location.href = url.toString();
};

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–∞–Ω–µ–ª–µ–π
window.closeAllFilterPanels = function() {
    ['roomsFilterPanel', 'priceFilterPanel', 'developerFilterPanel', 'advancedFiltersPanel'].forEach(id => {
        var panel = document.getElementById(id);
        if (panel) {
            panel.classList.add('hidden');
            panel.classList.remove('mobile-fullscreen');
        }
    });
    document.body.style.overflow = '';
};

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–º–Ω–∞—Ç
window.applyRoomsFilter = function() {
    console.log('‚ö° applyRoomsFilter (early version) called');
    var panel = document.getElementById('roomsFilterPanel');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
    // –í—ã–∑—ã–≤–∞–µ–º applyFilters –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
    if (typeof window.unusedAF === 'function') {
        console.log('‚úÖ Calling window.applyFilters()');
        window.applyFilters();
    } else {
        console.warn('‚ö†Ô∏è window.applyFilters not yet defined, filters not applied');
    }
};

window.applyDeveloperFilter = function() {
    console.log('‚ö° applyDeveloperFilter (early version) called');
    var panel = document.getElementById('developerFilterPanel');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
    if (typeof window.applyFilters === 'function') {
        window.applyFilters();
    }
};

window.closeAllDropdowns = function() {
    var searchSection = document.querySelector('#search-section');
    if (searchSection) {
        searchSection.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.classList.add('hidden');
            menu.classList.remove('open');
        });
    }
};

window.handlePropertyTypeChange = function() {
    var selected = document.querySelector('input[name="property_type"]:checked');
    if (!selected) return;
    
    var typeLabels = {
        'all': '–í—Å–µ —Ç–∏–ø—ã',
        'apartments': '–ö–≤–∞—Ä—Ç–∏—Ä—ã',
        'houses': '–î–æ–º–∞',
        'townhouses': '–¢–∞—É–Ω—Ö–∞—É—Å—ã',
        'penthouses': '–ü–µ–Ω—Ç—Ö–∞—É—Å—ã',
        'apartments_commercial': '–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã'
    };
    
    var label = document.getElementById('property-type-label');
    if (label) {
        label.textContent = typeLabels[selected.value] || '–í—Å–µ —Ç–∏–ø—ã';
    }
    
    window.closeAllDropdowns();
};

window.handleRoomFilterChange = function() {
    var checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(function(cb) { return cb.value; });
    
    var roomLabels = {
        '0': '–°—Ç—É–¥–∏–∏',
        '1': '1-–∫',
        '2': '2-–∫',
        '3': '3-–∫',
        '4': '4-–∫'
    };
    
    var buttonText = document.getElementById('roomsFilterText');
    if (buttonText) {
        if (checkedRooms.length === 0) {
            buttonText.textContent = '–ö–æ–º–Ω–∞—Ç';
        } else {
            buttonText.textContent = checkedRooms.map(function(r) { return roomLabels[r] || r; }).join(', ');
        }
    }
};

window.updatePriceLabel = function() {
    var fromVal = document.getElementById('priceFromInput');
    var toVal = document.getElementById('priceToInput');
    var label = document.getElementById('priceFilterText');
    if (!label) return;
    var from = fromVal ? fromVal.value : '';
    var to = toVal ? toVal.value : '';
    if (from && to) {
        label.textContent = from + '-' + to + ' –º–ª–Ω';
    } else if (from) {
        label.textContent = '–æ—Ç ' + from + ' –º–ª–Ω';
    } else if (to) {
        label.textContent = '–¥–æ ' + to + ' –º–ª–Ω';
    } else {
        label.textContent = '–¶–µ–Ω–∞';
    }
};

// ‚ö° –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ URL
window.applyFiltersViaURL = function() {
    console.log('‚ö° applyFiltersViaURL called');
    
    var params = new URLSearchParams(window.location.search);
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
    // –ö–æ–º–Ω–∞—Ç—ã
    var rooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
    params.delete('rooms');
    rooms.forEach(r => params.append('rooms', r));
    
    // –¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
    var propertyType = document.querySelector('input[name="property_type"]:checked');
    if (propertyType && propertyType.value !== 'all') {
        params.set('property_type', propertyType.value);
    } else {
        params.delete('property_type');
    }
    
    // –¶–µ–Ω–∞
    var priceFrom = document.getElementById('priceFrom');
    var priceTo = document.getElementById('priceTo');
    if (priceFrom && priceFrom.value) {
        var val = parseFloat(priceFrom.value);
        if (val < 1000) val = val * 1000000;
        params.set('price_min', val);
    } else {
        params.delete('price_min');
    }
    if (priceTo && priceTo.value) {
        var val = parseFloat(priceTo.value);
        if (val < 1000) val = val * 1000000;
        params.set('price_max', val);
    } else {
        params.delete('price_max');
    }
    
    // –†–∞–π–æ–Ω
    var districts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value);
    params.delete('district');
    districts.forEach(d => params.append('district', d));
    
    // –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫
    var developers = Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value);
    params.delete('developer');
    developers.forEach(d => params.append('developer', d));
    
    // –ü–ª–æ—â–∞–¥—å
    var areaFrom = document.getElementById('areaFrom');
    var areaTo = document.getElementById('areaTo');
    if (areaFrom && areaFrom.value) params.set('area_min', areaFrom.value);
    else params.delete('area_min');
    if (areaTo && areaTo.value) params.set('area_max', areaTo.value);
    else params.delete('area_max');
    
    // –≠—Ç–∞–∂
    var floorFrom = document.getElementById('floorFrom');
    var floorTo = document.getElementById('floorTo');
    if (floorFrom && floorFrom.value) params.set('floor_min', floorFrom.value);
    else params.delete('floor_min');
    if (floorTo && floorTo.value) params.set('floor_max', floorTo.value);
    else params.delete('floor_max');
    
    // ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ò–õ–¨–¢–†–´ ==========
    
    // –°—Ä–æ–∫ —Å–¥–∞—á–∏ (completion)
    var completion = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
    params.delete('completion');
    completion.forEach(v => params.append('completion', v));
    
    // –ö–ª–∞—Å—Å –æ–±—ä–µ–∫—Ç–∞ (object_class)
    var objectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_classes"]:checked')).map(cb => cb.value);
    params.delete('object_classes');
    objectClasses.forEach(v => params.append('object_classes', v));
    
    // –†–µ–º–æ–Ω—Ç (renovation)
    var renovation = Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value);
    params.delete('renovation');
    renovation.forEach(v => params.append('renovation', v));
    
    // –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (features)
    var features = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
    params.delete('features');
    features.forEach(v => params.append('features', v));
    
    // –°–¥–∞–Ω–Ω–æ—Å—Ç—å (building_released)
    var buildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
    params.delete('building_released');
    buildingReleased.forEach(v => params.append('building_released', v));
    
    // –≠—Ç–∞–∂ –≤ –∑–¥–∞–Ω–∏–∏ (building floors)
    var buildingFloorsMin = document.getElementById('buildingFloorsFrom');
    var buildingFloorsMax = document.getElementById('buildingFloorsTo');
    if (buildingFloorsMin && buildingFloorsMin.value) params.set('building_floors_min', buildingFloorsMin.value);
    else params.delete('building_floors_min');
    if (buildingFloorsMax && buildingFloorsMax.value) params.set('building_floors_max', buildingFloorsMax.value);
    else params.delete('building_floors_max');
    
    // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    var buildYearMin = document.getElementById('buildYearFrom');
    var buildYearMax = document.getElementById('buildYearTo');
    if (buildYearMin && buildYearMin.value) params.set('build_year_min', buildYearMin.value);
    else params.delete('build_year_min');
    if (buildYearMax && buildYearMax.value) params.set('build_year_max', buildYearMax.value);
    else params.delete('build_year_max');
    
    // –û–ø—Ü–∏–∏ —ç—Ç–∞–∂–∞ (floor_options)
    var floorOptions = Array.from(document.querySelectorAll('input[data-filter-type="floor_options"]:checked')).map(cb => cb.value);
    params.delete('floor_options');
    floorOptions.forEach(v => params.append('floor_options', v));
    
    // –†–µ–≥–∏–æ–Ω—ã
    var regions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
    params.delete('regions');
    regions.forEach(v => params.append('regions', v));
    
    params.delete('page');
    
    var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newUrl;
};

window._realFilterProperties = null;
window._realToggleQuickRoomFilter = null;

// ‚ö° –†–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è applyFilters - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
window.unusedAF = function() {
    console.log('‚ö° applyFilters called');
    
    // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
    if (window._isModalMapOpen()) {
        console.log('üó∫Ô∏è Modal map is open - deferring to real function');
        if (window._realApplyFilters) {
            return window._realApplyFilters();
        }
        // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        window._pendingFilterCalls.push({ type: 'applyFilters' });
        setTimeout(() => {
            if (window._realApplyFilters) {
                window._realApplyFilters();
            }
        }, 300);
        return;
    }
    
    // –î–ª—è —Å–ø–∏—Å–∫–∞ - URL –ø–æ–¥—Ö–æ–¥
    console.log('üìã List view - using URL method');
    window.applyFiltersViaURL();
};

// ‚ö° –†–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è filterProperties - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
window.filterProperties = function() {
    console.log('‚ö° filterProperties called');
    
    // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
    if (window._isModalMapOpen()) {
        console.log('üó∫Ô∏è Modal map is open - deferring to real function');
        if (window._realFilterProperties) {
            return window._realFilterProperties();
        }
        // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        setTimeout(() => {
            if (window._realFilterProperties) {
                window._realFilterProperties();
            }
        }, 300);
        return;
    }
    
    // –î–ª—è —Å–ø–∏—Å–∫–∞ - URL –ø–æ–¥—Ö–æ–¥
    console.log('üìã List view - using URL method');
    window.applyFiltersViaURL();
};

// ‚ö° –†–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è toggleQuickRoomFilter - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
window.toggleQuickRoomFilter = function(room) {
    console.log('‚ö° toggleQuickRoomFilter called with room:', room);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º mapFilters –µ—Å–ª–∏ –Ω–µ—Ç
    if (!window.mapFilters) {
        window.mapFilters = { rooms: [], price_min: '', price_max: '', area_min: '', area_max: '' };
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
    var index = window.mapFilters.rooms.indexOf(room);
    if (index > -1) {
        window.mapFilters.rooms = [];
    } else {
        window.mapFilters.rooms = [room];
    }
    
    console.log('üó∫Ô∏è Room filter toggled:', room, 'Current rooms:', window.mapFilters.rooms);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('[data-quick-room]').forEach(btn => {
        var btnRoom = parseInt(btn.dataset.quickRoom);
        if (window.mapFilters.rooms.includes(btnRoom)) {
            btn.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        } else {
            btn.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        }
    });
    
    // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    if (window._isModalMapOpen()) {
        console.log('üó∫Ô∏è Modal map is open - updating map with filters');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
        setTimeout(() => {
            if (typeof window.updateMapWithFilters === 'function') {
                window.updateMapWithFilters();
                console.log('‚úÖ Map updated with filters');
            } else {
                console.warn('‚ö†Ô∏è updateMapWithFilters not available yet, retrying...');
                setTimeout(() => {
                    if (typeof window.updateMapWithFilters === 'function') {
                        window.updateMapWithFilters();
                        console.log('‚úÖ Map updated with filters (delayed)');
                    }
                }, 500);
            }
        }, 100);
        return; // –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
    }
    
    // –î–ª—è —Å–ø–∏—Å–∫–∞ - URL –ø–æ–¥—Ö–æ–¥
    console.log('üìã List view - using URL method for room filter');
    var params = new URLSearchParams(window.location.search);
    params.delete('rooms');
    if (window.mapFilters.rooms.length > 0) {
        window.mapFilters.rooms.forEach(r => params.append('rooms', r));
    }
    params.delete('page');
    
    var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newUrl;
};

window.applyPriceFilter = function() {
    console.log('‚ö° applyPriceFilter called');
    
    var priceFrom = document.getElementById('priceFrom');
    var priceTo = document.getElementById('priceTo');
    
    var priceDropdown = document.getElementById('priceFilterPanel');
    if (priceDropdown) {
        priceDropdown.classList.add('hidden');
    }
    
    var priceText = document.getElementById('priceFilterText');
    if (priceText) {
        var fromV = priceFrom ? priceFrom.value : '';
        var toV = priceTo ? priceTo.value : '';
        if (fromV || toV) {
            var from = fromV ? '–æ—Ç ' + fromV : '';
            var to = toV ? '–¥–æ ' + toV : '';
            priceText.textContent = [from, to].filter(Boolean).join(' ') + ' –º–ª–Ω';
        } else {
            priceText.textContent = '–¶–µ–Ω–∞';
        }
    }
};

console.log('‚úÖ Early filter functions defined and ready');

// Map modal functions - —Ä–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è –¥–ª—è inline onclick
window.openMapDisplay = function() {
    console.log('üó∫Ô∏è openMapDisplay() called (early version)');
    
    var modal = document.getElementById('fullscreenMapModal');
    if (!modal) {
        console.warn('‚ö†Ô∏è fullscreenMapModal not found');
        return;
    }
    
    // Show modal
    modal.classList.remove('hidden');
    
    var isMobile = window.innerWidth < 1024;
    
    // Initialize map if not already done
    setTimeout(() => {
        if (isMobile) {
            var mobileContainer = document.getElementById('fullscreenMapContainer');
            if (mobileContainer && !mobileContainer.__map && window.ymaps) {
                console.log('üó∫Ô∏è Early: Initializing mobile fullscreen map...');
                ymaps.ready(function() {
                    mobileContainer.innerHTML = '';
                    var mapEl = document.createElement('div');
                    mapEl.style.width = '100%';
                    mapEl.style.height = '100%';
                    mobileContainer.appendChild(mapEl);
                    
                    var listBtn = document.createElement('button');
                    listBtn.onclick = function() { window.closeFullscreenMap(); };
                    listBtn.className = 'absolute bottom-6 left-4 z-[10] px-5 py-3 bg-white text-gray-900 rounded-xl shadow-lg text-sm font-semibold hover:bg-gray-50 transition-all flex items-center gap-2 border border-gray-200';
                    listBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg> –°–ø–∏—Å–æ–∫';
                    mobileContainer.appendChild(listBtn);
                    
                    var map = new ymaps.Map(mapEl, {
                        center: [43.5855, 39.7231],
                        zoom: 12,
                        controls: ['zoomControl']
                    });
                    mobileContainer.__map = map;
                    window.fullscreenMapContainer = mobileContainer;
                    if (typeof updateFullscreenMapMarkers === 'function') {
                        updateFullscreenMapMarkers();
                    }
                });
            } else if (mobileContainer && mobileContainer.__map) {
                if (typeof updateFullscreenMapMarkers === 'function') {
                    updateFullscreenMapMarkers();
                }
            }
        } else {
            if (typeof window.initializeDesktopFullscreenMap === 'function') {
                console.log('üó∫Ô∏è Calling initializeDesktopFullscreenMap()');
                window.initializeDesktopFullscreenMap();
            } else if (typeof initializeDesktopMap === 'function') {
                console.log('üó∫Ô∏è Calling initializeDesktopMap()');
                initializeDesktopMap();
            } else {
                console.log('‚è≥ Map initialization functions not yet loaded');
            }
        }
    }, 100);
};

// Alias for backward compatibility
window.openFullscreenMap = function() {
    console.log('üó∫Ô∏è openFullscreenMap() called (early alias)');
    return window.openMapDisplay();
};

// Close map
window.closeFullscreenMap = function() {
    console.log('üó∫Ô∏è closeFullscreenMap() called');
    var modal = document.getElementById('fullscreenMapModal');
    if (modal) {
        modal.classList.add('hidden');
    }
};

// –§—É–Ω–∫—Ü–∏–∏ Save Search Modal - —Ä–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è –¥–ª—è inline onclick
window.openSaveSearchModal = function() {
    console.log('üíó Opening save search modal (early)');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    var isAuthenticated = window.user_authenticated || window.manager_authenticated;
    
    if (!isAuthenticated) {
        console.log('‚ö†Ô∏è User not authenticated, showing registration prompt');
        alert('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∏—Å–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
        setTimeout(function() {
            if (typeof openApplicationModal === 'function') {
                openApplicationModal();
            } else {
                window.location.href = '/register';
            }
        }, 100);
        return;
    }
    
    var panel = document.getElementById('saveSearchModal');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        if (typeof window.closeAllFilterPanels === 'function') {
            window.closeAllFilterPanels();
        }
        
        panel.classList.remove('hidden');
        
        // –ù–∞ –º–æ–±–∞–π–ª–µ –¥–µ–ª–∞–µ–º fullscreen
        var isMobile = window.innerWidth < 640;
        if (isMobile) {
            panel.classList.add('mobile-fullscreen');
            document.body.style.overflow = 'hidden';
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ—É–Ω–∫—Ü–∏–π, –≤—ã–∑—ã–≤–∞–µ–º –∏—Ö
        if (typeof generateSearchNameForModal === 'function') {
            var searchName = generateSearchNameForModal();
            var nameInput = document.getElementById('searchNameInputModal');
            if (nameInput) nameInput.value = searchName;
        }
        
        if (typeof updateFiltersPreview === 'function') {
            updateFiltersPreview();
        }
        
        console.log('‚úÖ Save search modal opened');
    }
};

window.closeSaveSearchModal = function() {
    var panel = document.getElementById('saveSearchModal');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
    }
    if (window.forceRestoreScroll) {
        window.forceRestoreScroll();
    } else {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Save Search Modal - —Ä–∞–Ω–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
window.generateSearchNameForModal = function() {
    var roomSet = new Set();
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(function(el) { roomSet.add(el.value); });
    var rooms = Array.from(roomSet);
    var districtSet = new Set();
    document.querySelectorAll('input[data-filter-type="district"]:checked').forEach(function(el) { districtSet.add(el.getAttribute('data-district-name') || el.value); });
    var districts = Array.from(districtSet);
    
    var parts = [];
    
    var propertyType = document.querySelector('input[name="property_type"]:checked');
    if (propertyType && propertyType.value !== 'all') {
        parts.push(propertyType.closest('label')?.textContent.trim() || propertyType.value);
    }
    
    if (rooms.length > 0) {
        var roomText = rooms.map(function(r) {
            if (r === '0') return '–°—Ç—É–¥–∏—è';
            return r + '-–∫';
        }).join(', ');
        parts.push(roomText);
    }
    
    var priceTo = document.getElementById('priceTo')?.value;
    if (priceTo) parts.push('–¥–æ ' + priceTo + ' –º–ª–Ω');
    
    var areaTo = document.getElementById('areaTo')?.value;
    if (areaTo) parts.push('–¥–æ ' + areaTo + ' –º¬≤');
    
    if (districts.length > 0) {
        parts.push('–≤ ' + districts.slice(0, 2).join(', '));
    }
    
    return parts.length > 0 ? parts.join(', ') : '–ü–æ–∏—Å–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏';
};

window.updateFiltersPreview = function() {
    console.log('üîç updateFiltersPreview() called');
    var preview = document.getElementById('currentFiltersPreview');
    if (!preview) {
        console.warn('‚ö†Ô∏è currentFiltersPreview element not found');
        return;
    }
    
    function uniqueLabels(filterType) {
        var seen = new Set();
        var result = [];
        document.querySelectorAll('input[data-filter-type="' + filterType + '"]:checked').forEach(function(el) {
            var val = el.value;
            if (!seen.has(val)) {
                seen.add(val);
                result.push({ value: val, label: (el.closest('label')?.textContent.trim() || val) });
            }
        });
        return result;
    }
    
    var filters = [];
    
    var propertyType = document.querySelector('input[name="property_type"]:checked');
    if (propertyType && propertyType.value !== 'all') {
        var ptLabel = propertyType.closest('label')?.textContent.trim() || propertyType.value;
        filters.push('<div class="text-gray-700"><i class="fas fa-home text-[#0088CC] mr-2"></i><strong>–¢–∏–ø:</strong> ' + ptLabel + '</div>');
    }
    
    var rooms = uniqueLabels('rooms');
    if (rooms.length > 0) {
        var roomText = rooms.map(function(r) {
            if (r.value === '0') return '–°—Ç—É–¥–∏—è';
            return r.value + '-–∫–æ–º–Ω';
        }).join(', ');
        filters.push('<div class="text-gray-700"><i class="fas fa-door-open text-blue-500 mr-2"></i><strong>–ö–æ–º–Ω–∞—Ç—ã:</strong> ' + roomText + '</div>');
    }
    
    var priceFrom = document.getElementById('priceFrom')?.value;
    var priceTo = document.getElementById('priceTo')?.value;
    if (priceFrom || priceTo) {
        var priceText = '';
        if (priceFrom && priceTo) priceText = '–æ—Ç ' + priceFrom + ' –¥–æ ' + priceTo + ' –º–ª–Ω ‚ÇΩ';
        else if (priceFrom) priceText = '–æ—Ç ' + priceFrom + ' –º–ª–Ω ‚ÇΩ';
        else priceText = '–¥–æ ' + priceTo + ' –º–ª–Ω ‚ÇΩ';
        filters.push('<div class="text-gray-700"><i class="fas fa-ruble-sign text-green-500 mr-2"></i><strong>–¶–µ–Ω–∞:</strong> ' + priceText + '</div>');
    }
    
    var areaFrom = document.getElementById('areaFrom')?.value;
    var areaTo = document.getElementById('areaTo')?.value;
    if (areaFrom || areaTo) {
        var areaText = '';
        if (areaFrom && areaTo) areaText = '–æ—Ç ' + areaFrom + ' –¥–æ ' + areaTo + ' –º¬≤';
        else if (areaFrom) areaText = '–æ—Ç ' + areaFrom + ' –º¬≤';
        else areaText = '–¥–æ ' + areaTo + ' –º¬≤';
        filters.push('<div class="text-gray-700"><i class="fas fa-ruler-combined text-[#0088CC] mr-2"></i><strong>–ü–ª–æ—â–∞–¥—å:</strong> ' + areaText + '</div>');
    }
    
    var floorFrom = document.getElementById('floorFrom')?.value;
    var floorTo = document.getElementById('floorTo')?.value;
    if (floorFrom || floorTo) {
        var floorText = '';
        if (floorFrom && floorTo) floorText = '–æ—Ç ' + floorFrom + ' –¥–æ ' + floorTo;
        else if (floorFrom) floorText = '–æ—Ç ' + floorFrom;
        else floorText = '–¥–æ ' + floorTo;
        filters.push('<div class="text-gray-700"><i class="fas fa-layer-group text-indigo-500 mr-2"></i><strong>–≠—Ç–∞–∂:</strong> ' + floorText + '</div>');
    }
    
    var districts = uniqueLabels('district');
    if (districts.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i><strong>–†–∞–π–æ–Ω—ã:</strong> ' + districts.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var developers = uniqueLabels('developer');
    if (developers.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-industry text-orange-500 mr-2"></i><strong>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏:</strong> ' + developers.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var objectClasses = uniqueLabels('object_classes');
    if (objectClasses.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-building text-[#0088CC] mr-2"></i><strong>–ö–ª–∞—Å—Å:</strong> ' + objectClasses.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var completion = uniqueLabels('completion');
    if (completion.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-calendar-check text-teal-500 mr-2"></i><strong>–°—Ä–æ–∫ —Å–¥–∞—á–∏:</strong> ' + completion.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var renovation = uniqueLabels('renovation');
    if (renovation.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-paint-roller text-[#0088CC] mr-2"></i><strong>–û—Ç–¥–µ–ª–∫–∞:</strong> ' + renovation.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var features = uniqueLabels('features');
    if (features.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-star text-yellow-500 mr-2"></i><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong> ' + features.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var buildingReleased = uniqueLabels('building_released');
    if (buildingReleased.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>–°—Ç–∞—Ç—É—Å:</strong> ' + buildingReleased.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    var floorOptions = uniqueLabels('floor_options');
    if (floorOptions.length > 0) {
        filters.push('<div class="text-gray-700"><i class="fas fa-arrows-alt-v text-gray-500 mr-2"></i><strong>–≠—Ç–∞–∂:</strong> ' + floorOptions.map(function(d) { return d.label; }).join(', ') + '</div>');
    }
    
    console.log('‚úÖ Total filters found: ' + filters.length);
    
    if (filters.length === 0) {
        preview.innerHTML = '<div class="text-gray-400 italic">–§–∏–ª—å—Ç—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
    } else {
        preview.innerHTML = filters.join('');
    }
};

// ========== SEARCH MODAL FUNCTIONS (EARLY) ==========
// ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
var modalSearchDebounceTimer = null;
var modalSearchDropdown = null;

function initModalSearchSuggestions() {
    var input = document.getElementById('modal-search-input');
    if (!input || input.dataset.suggestionsInitialized) return;
    
    console.log('üîç Initializing suggestions for modal-search-input');
    input.dataset.suggestionsInitialized = 'true';
    
    // –°–æ–∑–¥–∞—ë–º dropdown –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
    if (!modalSearchDropdown) {
        modalSearchDropdown = document.createElement('div');
        modalSearchDropdown.className = 'mt-3 bg-white border border-gray-200 rounded-lg shadow-xl max-h-80 overflow-y-auto hidden';
        input.closest('.p-4').appendChild(modalSearchDropdown);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞
    input.addEventListener('input', (e) => {
        var query = e.target.value.trim();
        
        clearTimeout(modalSearchDebounceTimer);
        
        if (query.length === 0) {
            modalSearchDropdown.classList.add('hidden');
            return;
        }
        
        modalSearchDebounceTimer = setTimeout(async () => {
            try {
                var response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
                var data = await response.json();
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    showModalSuggestions(data.suggestions);
                } else {
                    modalSearchDropdown.classList.add('hidden');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
                modalSearchDropdown.classList.add('hidden');
            }
        }, 200);
    });
}

function showModalSuggestions(suggestions) {
    if (!modalSearchDropdown) return;
    
    var html = suggestions.map(sug => `
        <div class="suggestion-item px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
             onclick="window.location.href='${sug.url}'">
            <div class="flex items-center gap-3">
                <div class="text-gray-600 text-sm">${sug.icon || 'üîç'}</div>
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${sug.text || sug.title}</div>
                    ${sug.count ? `<div class="text-xs text-gray-500">${sug.count} –æ–±—ä–µ–∫—Ç–æ–≤</div>` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    modalSearchDropdown.innerHTML = html;
    modalSearchDropdown.classList.remove('hidden');
}

window.openSearchModal = function() {
    var panel = document.getElementById('searchModalPanel');
    if (!panel) return;
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
    if (typeof window.closeAllFilterPanels === 'function') {
        window.closeAllFilterPanels();
    }
    
    panel.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    initModalSearchSuggestions();
    
    // –§–æ–∫—É—Å –Ω–∞ input
    setTimeout(() => {
        var input = document.getElementById('modal-search-input');
        if (input) input.focus();
    }, 100);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    loadSearchHistory();
    loadPopularSearches();
};

window.closeSearchModal = function() {
    var panel = document.getElementById('searchModalPanel');
    if (panel) {
        panel.classList.add('hidden');
        document.body.style.overflow = '';
    }
};

window.clearModalSearch = function() {
    var input = document.getElementById('modal-search-input');
    if (input) {
        input.value = '';
        input.focus();
    }
};

window.selectPopularSearch = function(query) {
    var input = document.getElementById('modal-search-input');
    if (input) {
        input.value = query;
        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ (–∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
        performSearchFromModal(query);
    }
};

// ‚úÖ performSearchFromModal() –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ /static/js/mobile-search-redirect.js

window.loadSearchHistory = async function() {
    try {
        var container = document.getElementById('searchHistoryList');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // Call API to get search history
        var response = await fetch('/api/search/history/list', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Handle unauthenticated users gracefully
        if (response.status === 401) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>';
            return;
        }
        
        if (!response.ok) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        
        var data = await response.json();
        var history = data.history || [];
        
        if (history.length === 0) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        
        // Show last 20 searches from database (already sorted by API)
        container.innerHTML = history.map(item => `
            <button onclick="selectPopularSearch('${(item.query || '').replace(/'/g, "\\'")}')" 
                    class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200 flex items-center gap-2">
                <i class="fas fa-history text-gray-400"></i>
                ${item.query || ''}
                ${item.result_count ? `<span class="ml-auto text-xs text-gray-400">${item.result_count}</span>` : ''}
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading search history:', error);
        var container = document.getElementById('searchHistoryList');
        if (container) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        }
    }
};

window.saveToSearchHistory = async function(query, resultCount = 0) {
    if (!query || query.trim() === '') return;
    
    try {
        // Get CSRF token
        var csrfToken = window.csrf_token || document.querySelector('meta[name="csrf-token"]')?.content;
        
        if (!csrfToken) {
            console.warn('CSRF token not found, skipping search history save');
            return;
        }
        
        // Call API to save search history
        var response = await fetch('/api/search/history/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                query: query.trim(),
                result_count: resultCount
            })
        });
        
        // Handle 401 silently (not authenticated - this is OK for guests)
        if (response.status === 401) {
            console.log('Search history not saved (user not authenticated)');
            return;
        }
        
        if (!response.ok) {
            console.warn('Failed to save search history:', response.status);
            return;
        }
        
        var data = await response.json();
        if (data.success) {
            console.log('Search history saved successfully');
        }
    } catch (error) {
        // Fail silently - don't show errors to users
        console.error('Error saving search history:', error);
    }
};

window.loadPopularSearches = async function() {
    try {
        var container = document.getElementById('popularSearchesList');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // Call API to get popular searches
        var response = await fetch('/api/search/popular?limit=10', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // Fallback to default popular searches with direct URLs
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
            return;
        }
        
        var data = await response.json();
        var popular = data.suggestions || [];
        
        if (popular.length === 0) {
            // Fallback to default popular searches with direct URLs
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
            return;
        }
        
        // Render popular searches from API
        container.innerHTML = popular.map(item => `
            <button onclick="selectPopularSearch('${(item.text || item.query || '').replace(/'/g, "\\'")}')" 
                    class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                ${item.text || item.query || ''}
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading popular searches:', error);
        // Fallback to default popular searches with direct URLs
        var container = document.getElementById('popularSearchesList');
        if (container) {
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
        }
    }
};

window.saveSearchFromModal = async function() {
    console.log('üíæ Saving search from modal (early)...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    var isAuthenticated = window.user_authenticated || window.manager_authenticated;
    if (!isAuthenticated) {
        alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
        window.closeSaveSearchModal();
        if (typeof openApplicationModal === 'function') {
            openApplicationModal();
        }
        return;
    }
    
    var searchName = document.getElementById('searchNameInputModal')?.value;
    
    if (!searchName || !searchName.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞');
        return;
    }
    
    try {
        function uniqueChecked(ft) {
            return [...new Set(Array.from(document.querySelectorAll('input[data-filter-type="' + ft + '"]:checked')).map(function(cb) { return cb.value; }))];
        }
        
        var searchUrl = window.location.pathname + window.location.search;
        
        var urlParams = new URLSearchParams(window.location.search);
        var params = {
            rooms: uniqueChecked('rooms'),
            districts: uniqueChecked('district'),
            developers: uniqueChecked('developer'),
            completion: uniqueChecked('completion'),
            object_classes: uniqueChecked('object_classes'),
            renovation: uniqueChecked('renovation'),
            features: uniqueChecked('features'),
            building_released: uniqueChecked('building_released'),
            floor_options: uniqueChecked('floor_options'),
            regions: uniqueChecked('region'),
            cities: uniqueChecked('city'),
            price_min: urlParams.get('price_min') || '',
            price_max: urlParams.get('price_max') || '',
            area_min: urlParams.get('area_min') || '',
            area_max: urlParams.get('area_max') || '',
            floor_min: urlParams.get('floor_min') || '',
            floor_max: urlParams.get('floor_max') || '',
            building_floors_min: urlParams.get('building_floors_min') || '',
            building_floors_max: urlParams.get('building_floors_max') || '',
            property_type: urlParams.get('property_type') || '',
            search_url: searchUrl
        };
        
        console.log('üíæ Saving search with URL:', searchUrl);
        console.log('üíæ Saving search params:', params);
        
        var isManager = Boolean(window.manager_authenticated);
        
        var endpoint, requestData;
        
        if (isManager) {
            endpoint = '/api/manager/saved-searches';
            requestData = {
                name: searchName,
                filters: params
            };
        } else {
            endpoint = '/api/user/saved-searches';
            requestData = {
                name: searchName,
                description: '',
                notify_new_matches: true,
                search_type: 'properties',
                search_url: searchUrl,
                rooms: params.rooms,
                districts: params.districts,
                developers: params.developers,
                completion: params.completion,
                object_classes: params.object_classes,
                renovation: params.renovation,
                features: params.features,
                building_released: params.building_released,
                floor_options: params.floor_options,
                regions: params.regions,
                cities: params.cities,
                price_min: params.price_min,
                price_max: params.price_max,
                area_min: params.area_min,
                area_max: params.area_max,
                floor_min: params.floor_min,
                floor_max: params.floor_max,
                building_floors_min: params.building_floors_min,
                building_floors_max: params.building_floors_max,
                property_type: params.property_type
            };
        }
        
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –ø–æ–∏—Å–∫:', { endpoint, requestData });
        
        var csrfToken = window.csrf_token || document.querySelector('meta[name="csrf-token"]')?.content || document.querySelector('input[name="csrf_token"]')?.value;
        var headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        var response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin',
            body: JSON.stringify(requestData)
        });
        
        var result = await response.json();
        
        if (result.success) {
            alert('–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            window.closeSaveSearchModal();
            if (window.savedSearchesManager && typeof window.savedSearchesManager.loadSavedSearches === 'function') {
                window.savedSearchesManager.loadSavedSearches();
            }
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫'));
        }
    } catch (error) {
        console.error('Save search error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
};

console.log('‚úÖ Early filter functions defined and ready');
</script>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<div class="hidden md:block container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
<form style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<!-- Advanced Search Form -->
<section id="properties-hero" class="py-4 bg-white">
    <div class="max-w-7xl mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center mb-6">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}</h2>
        <p class="text-xl text-gray-600 text-center mb-12">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</p>
    </div>
</section>

<!-- Mobile-only Sticky Search Bar (Avito style) with SMART SEARCH -->
<section id="mobile-search-bar" class="md:hidden sticky top-0 z-30 bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center gap-2">
            <!-- Smart Search Input (SuperSearch works here) -->
            <div class="flex-1 relative">
                <input type="text" 
                       id="property-search"
                       placeholder="–£–º–Ω—ã–π –ø–æ–∏—Å–∫: —Ä–∞–π–æ–Ω, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, –ñ–ö..." 
                       class="w-full pl-4 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-sm text-gray-700 bg-gray-50"
                       onclick="if(window.innerWidth < 768) { event.preventDefault(); openSearchModal(); this.blur(); }"
                       readonly>
            </div>
            
            <!-- Save Search Icon -->
            <button onclick="window.openSaveSearchModal();" 
                    class="flex-shrink-0 w-10 h-10 bg-white border border-gray-300 rounded-lg flex items-center justify-center text-gray-600 hover:text-red-500 hover:border-red-500 transition-all" 
                    title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫">
                <i class="fas fa-heart text-lg"></i>
            </button>
            
            <!-- Filter Icon with Badge -->
            <button onclick="openMobileFilters();" 
                    class="flex-shrink-0 w-10 h-10 bg-[#0088CC] rounded-lg flex items-center justify-center text-white hover:bg-[#006699] transition-all relative" 
                    title="–§–∏–ª—å—Ç—Ä—ã">
                <div id="advancedFiltersCounterMobile" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                <i class="fas fa-sliders-h text-lg"></i>
            </button>
        </div>
    </div>
</section>

<script>
function toggleMobileQuickFilter(btn, filterType) {
    btn.classList.toggle('active');
    if (filterType === 'mortgage') {
        var mortgageCheckbox = document.querySelector('input[data-filter-type="mortgage"]');
        if (mortgageCheckbox) mortgageCheckbox.checked = btn.classList.contains('active');
    } else if (filterType.startsWith('rooms-')) {
        var roomValue = filterType.split('-')[1];
        var roomCheckbox = document.querySelector('input[data-filter-type="rooms"][value="' + roomValue + '"]');
        if (roomCheckbox) {
            roomCheckbox.checked = btn.classList.contains('active');
            if (typeof window.handleRoomFilterChange === 'function') window.handleRoomFilterChange();
        }
    } else if (filterType === 'new') {
        var newRadio = document.querySelector('input[data-filter-type="property_type"][value="apartments"]');
        if (newRadio && btn.classList.contains('active')) {
            newRadio.checked = true;
        } else {
            var allRadio = document.querySelector('input[data-filter-type="property_type"][value="all"]');
            if (allRadio) allRadio.checked = true;
        }
        if (typeof window.handlePropertyTypeChange === 'function') window.handlePropertyTypeChange();
    }
    if (typeof window.applyFilters === 'function') window.applyFilters();
}
window.toggleMobileQuickFilter = toggleMobileQuickFilter;
</script>
<div id="mobile-quick-filters" class="md:hidden bg-white border-b border-gray-200">
    <div id="mqf-scroll" class="flex items-center gap-2 px-4 py-2 overflow-x-auto" style="scrollbar-width:none;-webkit-overflow-scrolling:touch;overflow-x:scroll;-ms-overflow-style:none;">
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="mortgage">
            –í –∏–ø–æ—Ç–µ–∫—É <span class="text-gray-400 ml-1" id="mqf-mortgage-count"></span>
        </button>
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="rooms-0">
            –°—Ç—É–¥–∏–∏ <span class="text-gray-400 ml-1" id="mqf-rooms-0-count"></span>
        </button>
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="rooms-1">
            1-–∫–æ–º–Ω <span class="text-gray-400 ml-1" id="mqf-rooms-1-count"></span>
        </button>
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="rooms-2">
            2-–∫–æ–º–Ω <span class="text-gray-400 ml-1" id="mqf-rooms-2-count"></span>
        </button>
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="rooms-3">
            3-–∫–æ–º–Ω <span class="text-gray-400 ml-1" id="mqf-rooms-3-count"></span>
        </button>
        <button class="mobile-quick-chip flex-shrink-0 px-4 py-2 rounded-full border border-gray-300 text-sm font-medium whitespace-nowrap transition-all" data-filter="new">
            –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ <span class="text-gray-400 ml-1" id="mqf-new-count"></span>
        </button>
    </div>
</div>
<script>
(function() {
    var el = document.getElementById('mqf-scroll');
    if (!el) return;
    var isDragging = false, startX = 0, scrollLeft = 0, moved = false;
    el.addEventListener('touchstart', function(e) {
        isDragging = true;
        moved = false;
        startX = e.touches[0].pageX - el.offsetLeft;
        scrollLeft = el.scrollLeft;
    }, {passive: true});
    el.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        var x = e.touches[0].pageX - el.offsetLeft;
        var walk = (startX - x);
        if (Math.abs(walk) > 5) moved = true;
        el.scrollLeft = scrollLeft + walk;
    }, {passive: true});
    el.addEventListener('touchend', function() { isDragging = false; }, {passive: true});
    el.addEventListener('mousedown', function(e) {
        isDragging = true;
        moved = false;
        startX = e.pageX - el.offsetLeft;
        scrollLeft = el.scrollLeft;
        el.style.cursor = 'grabbing';
    });
    el.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        var x = e.pageX - el.offsetLeft;
        var walk = (startX - x);
        if (Math.abs(walk) > 5) moved = true;
        el.scrollLeft = scrollLeft + walk;
    });
    el.addEventListener('mouseup', function() { isDragging = false; el.style.cursor = 'grab'; });
    el.addEventListener('mouseleave', function() { isDragging = false; el.style.cursor = 'grab'; });
    el.style.cursor = 'grab';
    el.querySelectorAll('.mobile-quick-chip').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            if (moved) { e.preventDefault(); e.stopPropagation(); return; }
            toggleMobileQuickFilter(btn, btn.dataset.filter);
        });
    });
})();
</script>

<!-- Search Block (Desktop only - mobile uses sticky bar) -->
<section id="search-section" class="py-8 bg-gray-50 md:relative md:top-0">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Unified Search + Filters Row (DESKTOP ONLY) -->
        <div class="bg-white rounded-xl shadow-md mb-6 md:mb-8 hidden md:flex items-center px-4 py-3 gap-3 search-wrapper">
            
            <!-- Property Type Filter -->
            <div class="dropdown relative search-filter-btn" data-filter="property_type">
                <button class="dropdown-btn px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-1 whitespace-nowrap" onclick="window.toggleDropdown(event, this.nextElementSibling)">
                    <span id="property-type-label">{% if filters and filters.property_type and filters.property_type != 'all' %}{% if filters.property_type == 'apartments' %}–ö–≤–∞—Ä—Ç–∏—Ä—ã{% elif filters.property_type == 'houses' %}–î–æ–º–∞{% elif filters.property_type == 'townhouses' %}–¢–∞—É–Ω—Ö–∞—É—Å—ã{% elif filters.property_type == 'penthouses' %}–ü–µ–Ω—Ç—Ö–∞—É—Å—ã{% elif filters.property_type == 'apartments_commercial' %}–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã{% else %}{{ filters.property_type }}{% endif %}{% else %}–í—Å–µ —Ç–∏–ø—ã{% endif %}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-menu absolute top-full left-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="all" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if not filters or not filters.property_type or filters.property_type == 'all' %} checked{% endif %}> –í—Å–µ —Ç–∏–ø—ã</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="apartments" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if filters and filters.property_type == 'apartments' %} checked{% endif %}> –ö–≤–∞—Ä—Ç–∏—Ä—ã</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="houses" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if filters and filters.property_type == 'houses' %} checked{% endif %}> –î–æ–º–∞</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="townhouses" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if filters and filters.property_type == 'townhouses' %} checked{% endif %}> –¢–∞—É–Ω—Ö–∞—É—Å—ã</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="penthouses" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if filters and filters.property_type == 'penthouses' %} checked{% endif %}> –ü–µ–Ω—Ç—Ö–∞—É—Å—ã</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="radio" name="property_type" value="apartments_commercial" data-filter-type="property_type" class="mr-2" onchange="window.handlePropertyTypeChange();"{% if filters and filters.property_type == 'apartments_commercial' %} checked{% endif %}> –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</label>
                </div>
            </div>

            <!-- Separator -->
            <div class="h-5 w-px bg-gray-300"></div>

            <!-- Room Filter -->
            <div class="dropdown relative search-filter-btn" data-filter="rooms">
                <button class="dropdown-btn px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-1 whitespace-nowrap" onclick="window.toggleDropdown(event, this.nextElementSibling)">
                    <span id="roomsFilterText">{% if filters and filters.rooms %}{% set room_labels = [] %}{% for r in filters.rooms %}{% if r == '0' or r == 0 %}{% set _ = room_labels.append('–°—Ç—É–¥–∏–∏') %}{% else %}{% set _ = room_labels.append(r|string + '-–∫') %}{% endif %}{% endfor %}{{ room_labels|join(', ') }}{% else %}–ö–æ–º–Ω–∞—Ç{% endif %}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-menu hidden bg-white border border-gray-200 rounded-lg shadow-lg z-50 absolute top-full left-0 mt-2 p-2 min-w-[150px]">
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="checkbox" value="0" data-filter-type="rooms" class="mr-2" onchange="window.handleRoomFilterChange();"{% if filters and ('0' in filters.rooms or 0 in filters.rooms) %} checked{% endif %}> –°—Ç—É–¥–∏—è</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="checkbox" value="1" data-filter-type="rooms" class="mr-2" onchange="window.handleRoomFilterChange();"{% if filters and ('1' in filters.rooms or 1 in filters.rooms) %} checked{% endif %}> 1-–∫</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="checkbox" value="2" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange();"{% if filters and ('2' in filters.rooms or 2 in filters.rooms) %} checked{% endif %}> 2-–∫</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="checkbox" value="3" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange();"{% if filters and ('3' in filters.rooms or 3 in filters.rooms) %} checked{% endif %}> 3-–∫</label>
                    <label class="dropdown-item block px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors"><input type="checkbox" value="4" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange();"{% if filters and ('4' in filters.rooms or 4 in filters.rooms) %} checked{% endif %}> 4-–∫</label>
                </div>
            </div>

            <!-- Separator -->
            <div class="h-5 w-px bg-gray-300"></div>

            <!-- Price Filter -->
            <div class="dropdown relative search-filter-btn" data-filter="price">
                <button class="dropdown-btn px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-1 whitespace-nowrap" onclick="window.toggleDropdown(event, this.nextElementSibling)">
                    <span id="priceFilterText">{% if filters and (filters.price_min or filters.price_max) %}{% set p_min = (filters.price_min|float / 1000000)|round(1) if filters.price_min and filters.price_min|float >= 1000 else filters.price_min %}{% set p_max = (filters.price_max|float / 1000000)|round(1) if filters.price_max and filters.price_max|float >= 1000 else filters.price_max %}{% if p_min and p_max %}{{ p_min }}-{{ p_max }} –º–ª–Ω{% elif p_min %}–æ—Ç {{ p_min }} –º–ª–Ω{% elif p_max %}–¥–æ {{ p_max }} –º–ª–Ω{% endif %}{% else %}–¶–µ–Ω–∞{% endif %}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-menu hidden bg-white border border-gray-200 rounded-lg shadow-lg z-50 absolute top-full left-0 mt-2" style="min-width: 280px;">
                    <div class="p-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">–û—Ç, –º–ª–Ω ‚ÇΩ</label>
                                <input type="number" id="priceFromInput" placeholder="1" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" oninput="window.updatePriceLabel();" value="{% if filters and filters.price_min %}{{ (filters.price_min|float / 1000000)|round(1) if filters.price_min|float >= 1000 else filters.price_min }}{% endif %}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">–î–æ, –º–ª–Ω ‚ÇΩ</label>
                                <input type="number" id="priceToInput" placeholder="20" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" oninput="window.updatePriceLabel();" value="{% if filters and filters.price_max %}{{ (filters.price_max|float / 1000000)|round(1) if filters.price_max|float >= 1000 else filters.price_max }}{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEARCH INPUT - CENTER -->
            <div id="search-input-container" class="relative flex-grow min-w-0">
                <input id="property-search-desktop" class="w-full px-4 py-2 border-0 focus:ring-0 outline-none text-sm text-gray-700 bg-transparent" placeholder="–ì–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å, –º–µ—Ç—Ä–æ, —Ä–∞–π–æ–Ω, –∂/–¥, —à–æ—Å—Å–µ –∏–ª–∏ –ñ–ö" type="text" onchange="window.applyFilters();"/>
                <button id="search-close-btn" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors" onclick="closeExpandedSearch()" title="–ó–∞–∫—Ä—ã—Ç—å">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div id="property-searchSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 shadow-lg z-50 max-h-64 overflow-y-auto">
                    <!-- Suggestions populated by JavaScript -->
                </div>
            </div>

            <!-- Unified Apply Button -->
            <button onclick="window.applyFilters(); window.closeAllDropdowns();" class="flex items-center bg-[#0088CC] hover:bg-[#006699] text-white px-5 py-2.5 rounded-full text-sm font-medium transition-colors flex-shrink-0 gap-1.5 self-center h-10">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                –ù–∞–π—Ç–∏
            </button>

            <!-- RIGHT SIDE BUTTONS -->
            <!-- Filters Button with Badge -->
            <button class="search-filter-btn flex items-center text-gray-600 hover:text-[#0088CC] px-3 py-2 rounded-lg text-sm relative flex-shrink-0" onclick="window.toggleFiltersModal()">
                <div id="advancedFiltersCounter" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
                </svg>
                <span class="hidden md:inline">–§–∏–ª—å—Ç—Ä—ã</span>
            </button>

            <!-- Save Search Button -->
            <button onclick="window.openSaveSearchModal();" class="search-filter-btn flex items-center text-gray-600 hover:text-red-500 px-3 py-2 rounded-lg text-sm transition-all flex-shrink-0" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫">
                <i class="fas fa-heart mr-1"></i>
                <span class="hidden md:inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>

            <!-- Properties Counter - RIGHT SIDE -->
            <div class="text-sm text-gray-700 font-semibold flex-shrink-0 whitespace-nowrap">
                <span id="search-counter-value">{{ total_properties or 0 }}</span> –∫–≤–∞—Ä—Ç–∏—Ä
            </div>

            
                

            </div>
            
            <!-- –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π -->
            {% set has_active_filters = (filters and (filters.rooms or filters.price_min or filters.price_max or filters.area_min or filters.area_max or filters.floor_min or filters.floor_max or filters.building_floors_min or filters.building_floors_max or filters.developers or filters.developer or filters.residential_complex or filters.completion or filters.property_type or filters.renovation or filters.features or filters.object_classes or filters.floor_options or filters.building_released or filters.search)) %}
            <div id="active-filters-container" class="{% if not has_active_filters %}hidden{% endif %} mt-4">
                <!-- Mobile collapsed badge -->
                <div id="mob-filters-badge" class="md:hidden flex items-center justify-between bg-[#0088CC]/5 border border-[#0088CC]/20 rounded-xl px-3 py-2 cursor-pointer" onclick="toggleMobileFilters()">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 019 17v-5.586L4.293 6.707A1 1 0 014 6V3z" clip-rule="evenodd"/></svg>
                        <span class="text-sm font-medium text-[#0088CC]">–§–∏–ª—å—Ç—Ä—ã: <span id="mob-active-filters-count">0</span></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); window.location.href='/{{ city_slug }}/novostrojki'; return false;" class="text-xs text-gray-400 hover:text-red-500">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        <svg id="mob-filters-chevron" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                </div>
                <div id="mob-filters-expanded" class="hidden md:block">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div id="active-filters-list" class="flex flex-wrap items-center gap-2">
                        <!-- Server-rendered active filters -->
                        {% if filters %}
                            {% if filters.rooms %}
                                {% for r in filters.rooms %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {% if r == '0' or r == 0 %}–°—Ç—É–¥–∏—è{% else %}{{ r }}-–∫–æ–º–Ω.{% endif %}
                                    <button onclick="window.removeFilter('rooms', '{{ r }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.price_min or filters.price_max %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –¶–µ–Ω–∞: {% if filters.price_min %}–æ—Ç {{ (filters.price_min|int / 1000000)|round(1) }} –º–ª–Ω{% endif %}{% if filters.price_min and filters.price_max %} ‚Äî {% endif %}{% if filters.price_max %}–¥–æ {{ (filters.price_max|int / 1000000)|round(1) }} –º–ª–Ω{% endif %}
                                <button onclick="window.removeFilter('price')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.property_type and filters.property_type != 'all' %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                {% if filters.property_type == 'apartments' %}–ö–≤–∞—Ä—Ç–∏—Ä—ã{% elif filters.property_type == 'houses' %}–î–æ–º–∞{% elif filters.property_type == 'townhouses' %}–¢–∞—É–Ω—Ö–∞—É—Å—ã{% elif filters.property_type == 'penthouses' %}–ü–µ–Ω—Ç—Ö–∞—É—Å—ã{% elif filters.property_type == 'apartments_commercial' %}–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã{% else %}{{ filters.property_type }}{% endif %}
                                <button onclick="window.removeFilter('property_type')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.area_min or filters.area_max %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –ü–ª–æ—â–∞–¥—å: {% if filters.area_min %}–æ—Ç {{ filters.area_min }} –º¬≤{% endif %}{% if filters.area_min and filters.area_max %} ‚Äî {% endif %}{% if filters.area_max %}–¥–æ {{ filters.area_max }} –º¬≤{% endif %}
                                <button onclick="window.removeFilter('area')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.floor_min or filters.floor_max %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –≠—Ç–∞–∂: {% if filters.floor_min %}–æ—Ç {{ filters.floor_min }}{% endif %}{% if filters.floor_min and filters.floor_max %} ‚Äî {% endif %}{% if filters.floor_max %}–¥–æ {{ filters.floor_max }}{% endif %}
                                <button onclick="window.removeFilter('floor')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.building_floors_min or filters.building_floors_max %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ: {% if filters.building_floors_min %}–æ—Ç {{ filters.building_floors_min }}{% endif %}{% if filters.building_floors_min and filters.building_floors_max %} ‚Äî {% endif %}{% if filters.building_floors_max %}–¥–æ {{ filters.building_floors_max }}{% endif %}
                                <button onclick="window.removeFilter('building_floors')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.developers %}
                                {% for dev in filters.developers %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {{ dev }}
                                    <button onclick="window.removeFilter('developers', '{{ dev }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.developer %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫: {{ filters.developer }}
                                <button onclick="window.removeFilter('developer')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.residential_complex %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                –ñ–ö: {{ filters.residential_complex }}
                                <button onclick="window.removeFilter('residential_complex')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                            {% if filters.completion %}
                                {% for comp in filters.completion %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    –°–¥–∞—á–∞ {{ comp }} –≥.
                                    <button onclick="window.removeFilter('completion', '{{ comp }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.object_classes %}
                                {% for oc in filters.object_classes %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    –ö–ª–∞—Å—Å: {{ oc }}
                                    <button onclick="window.removeFilter('object_classes', '{{ oc }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.renovation %}
                                {% for ren in filters.renovation %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {% if ren == 'no_renovation' %}–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏{% elif ren == 'fine_finish' %}–ß–∏—Å—Ç–æ–≤–∞—è{% elif ren == 'rough_finish' %}–ß–µ—Ä–Ω–æ–≤–∞—è{% elif ren == 'pre_finish' %}–ü—Ä–µ–¥—á–∏—Å—Ç–æ–≤–∞—è{% elif ren == 'turnkey' %}–ü–æ–¥ –∫–ª—é—á{% else %}{{ ren }}{% endif %}
                                    <button onclick="window.removeFilter('renovation', '{{ ren }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.features %}
                                {% for feat in filters.features %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {% if feat == 'accreditation' %}–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è{% elif feat == 'green_mortgage' %}–õ—å–≥–æ—Ç–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞{% else %}{{ feat }}{% endif %}
                                    <button onclick="window.removeFilter('features', '{{ feat }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.floor_options %}
                                {% for fo in filters.floor_options %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {% if fo == 'not_first' %}–ù–µ –ø–µ—Ä–≤—ã–π{% elif fo == 'not_last' %}–ù–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π{% elif fo == 'last' %}–ü–æ—Å–ª–µ–¥–Ω–∏–π{% elif fo == 'first' %}–ü–µ—Ä–≤—ã–π{% else %}{{ fo }}{% endif %}
                                    <button onclick="window.removeFilter('floor_options', '{{ fo }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.building_released %}
                                {% for br in filters.building_released %}
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                    {% if br == 'true' %}–°–¥–∞–Ω–Ω—ã–π –¥–æ–º{% elif br == 'false' %}–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ{% else %}{{ br }}{% endif %}
                                    <button onclick="window.removeFilter('building_released', '{{ br }}')" class="ml-1 hover:text-[#006699]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </span>
                                {% endfor %}
                            {% endif %}
                            {% if filters.search %}
                            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-[#0088CC]/10 text-[#0088CC] text-sm rounded-full font-medium">
                                ¬´{{ filters.search }}¬ª
                                <button onclick="window.removeFilter('search')" class="ml-1 hover:text-[#006699]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <button id="clearAllFilters" class="text-sm text-[#0088CC] hover:text-[#006699] transition-colors font-semibold whitespace-nowrap flex-shrink-0" onclick="window.location.href='/{{ city_slug }}/properties'; return false;">
                        –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
                    </button>
                </div>
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="advancedFiltersPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="flex items-center gap-3">
                            <button id="resetAdvancedFiltersTop" onclick="resetAdvancedFilters();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <!-- Close button for mobile -->
                            <button id="closeAdvancedFiltersBtn" onclick="document.getElementById('advancedFiltersPanel').classList.add('hidden');" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Scrollable Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        
                        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                </svg>
                                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
                            </h4>
                            
                            <!-- –ü–ª–æ—â–∞–¥—å -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                                <div class="flex gap-2">
                                    <input type="number" id="quickAreaFrom" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="quickAreaTo" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- –≠—Ç–∞–∂ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                                <div class="flex gap-2">
                                    <input type="number" id="quickFloorFrom" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="quickFloorTo" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ç–∞–∂ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞</label>
                                <div class="flex gap-2">
                                    <input type="number" id="maxFloorFromDesktop" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="maxFloorToDesktop" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                            </h4>
                            
                            <!-- –ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if "–ë–∏–∑–Ω–µ—Å" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ë–∏–∑–Ω–µ—Å</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if "–ö–æ–º—Ñ–æ—Ä—Ç" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if "–ü—Ä–µ–º–∏—É–º" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ü—Ä–µ–º–∏—É–º</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- –û—Ç–¥–µ–ª–∫–∞ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–∫–∞</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="no_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if 'no_renovation' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="fine_finish" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if 'fine_finish' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ß–∏—Å—Ç–æ–≤–∞—è</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                –£—Å–ª–æ–≤–∏—è
                            </h4>
                            
                            <!-- –ò–ø–æ—Ç–µ–∫–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                    <span class="ml-2 text-sm text-gray-700">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                    <span class="ml-2 text-sm text-gray-700">–õ—å–≥–æ—Ç–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ—á–µ–µ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                                –ü—Ä–æ—á–µ–µ
                            </h4>
                            
                            <!-- –°—Ä–æ–∫ —Å–¥–∞—á–∏ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2024" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                        <span class="ml-2 text-sm text-gray-700">2024</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2025" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                        <span class="ml-2 text-sm text-gray-700">2025</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2026" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                        <span class="ml-2 text-sm text-gray-700">2026</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2028" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();">
                                        <span class="ml-2 text-sm text-gray-700">2028</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- –°—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏ -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if "true" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">–°–¥–∞–Ω–Ω—ã–π –¥–æ–º</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="window.updateFilteredCount();" {% if "false" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Footer - Sticky Bottom (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∞–π–ª–µ) -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button id="apply-advanced-filters-id" onclick="applyFilters();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="priceFilteredCountDisplay">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Rooms Filter Modal Panel (Mobile) -->
            <div id="roomsFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetRoomsFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('roomsFilterPanel').classList.add('hidden'); document.getElementById('roomsFilterPanel').classList.remove('mobile-fullscreen'); document.body.style.overflow = '';" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-3">
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="0" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();" {% if filters and ('0' in filters.rooms or 0 in filters.rooms) %}checked{% endif %}>
                            <span class="ml-3 text-base text-gray-700">–°—Ç—É–¥–∏—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="1" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();" {% if filters and ('1' in filters.rooms or 1 in filters.rooms) %}checked{% endif %}>
                            <span class="ml-3 text-base text-gray-700">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="2" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();" {% if filters and ('2' in filters.rooms or 2 in filters.rooms) %}checked{% endif %}>
                            <span class="ml-3 text-base text-gray-700">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="3" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();" {% if filters and ('3' in filters.rooms or 3 in filters.rooms) %}checked{% endif %}>
                            <span class="ml-3 text-base text-gray-700">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="4" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();" {% if filters and ('4' in filters.rooms or 4 in filters.rooms) %}checked{% endif %}>
                            <span class="ml-3 text-base text-gray-700">4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyRoomsFilter();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="priceFilteredCountDisplay">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Price Filter Modal Panel (Mobile) -->
            <div id="priceFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–¶–µ–Ω–∞</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetPriceFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('priceFilterPanel').classList.add('hidden'); document.getElementById('priceFilterPanel').classList.remove('mobile-fullscreen'); document.body.style.overflow = '';" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <input type="number" id="priceFromModalInput" oninput="window.updateFilteredCount()" placeholder="–û—Ç" min="0" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" oninput="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();">
                                </div>
                                <div>
                                    <input type="number" id="priceToModalInput" oninput="window.updateFilteredCount()" placeholder="–î–æ" min="0" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" oninput="if(typeof window.unusedUFC === 'function') window.updateFilteredCount();">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyPriceFilterModal();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="priceFilteredCountDisplay">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Developer Filter Modal Panel (Mobile) -->
            <div id="developerFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetDeveloperFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('developerFilterPanel').classList.add('hidden');" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-3" id="developers-modal-panel">
                        <!-- Will be populated dynamically by loadDevelopers() -->
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyDeveloperFilter();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="developerFilteredCount">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Search Modal Panel (Fullscreen Overlay) -->
<div id="searchModalPanel" class="hidden fixed inset-0 z-[9999] bg-white overflow-hidden flex flex-col" onclick="if(event.target === this) closeSearchModal();">
    <!-- Header - Sticky Top -->
    <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] px-4 py-4 sticky top-0 z-10" onclick="event.stopPropagation();">
        <div class="flex items-center justify-between w-full gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-search text-white text-lg"></i>
                </div>
                <h3 class="text-lg font-semibold text-white">–£–º–Ω—ã–π –ø–æ–∏—Å–∫</h3>
            </div>
            <button onclick="closeSearchModal();" class="text-white/90 hover:text-white transition-colors flex-shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Content -->
    <div class="p-4 overflow-y-auto flex-1 bg-white">
        <!-- Search Input -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="modal-search-input"
                       placeholder="–†–∞–π–æ–Ω, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, –ñ–ö, —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã..." 
                       class="w-full pl-4 pr-10 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-base text-gray-700 bg-gray-50"
                       autocomplete="off"
                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); performSearchFromModal(this.value); }">
                <button onclick="clearModalSearch();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Search History -->
        <div id="searchHistory" class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-history text-gray-400"></i>
                –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
            </h4>
            <div id="searchHistoryList" class="space-y-2">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <!-- Popular Searches -->
        <div id="popularSearches" class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-fire text-orange-500"></i>
                –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            </h4>
            <div id="popularSearchesList" class="flex flex-wrap gap-2">
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API -->
                <div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal Panel (Responsive: Fullscreen on Mobile, Centered on Desktop) -->
<div id="saveSearchModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 md:p-0">
    <!-- Modal Container -->
    <div class="bg-white w-full h-full md:h-auto md:max-w-lg md:rounded-2xl md:shadow-2xl overflow-hidden flex flex-col md:max-h-[90vh]">
                <!-- Header - Sticky Top -->
                <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] px-4 py-4 md:rounded-t-2xl sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-heart text-white text-lg"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫</h3>
                        </div>
                        <button onclick="closeSaveSearchModal();" class="text-white/90 hover:text-white transition-colors flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                    <div class="space-y-5">
                        <!-- Info Card -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-info-circle text-blue-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-blue-900 leading-relaxed">
                                        –ú—ã –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Name Input -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-tag text-gray-400 mr-2"></i>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
                            </label>
                            <input type="text" 
                                   id="searchNameInputModal" 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2-–∫–æ–º–Ω –≤ –¶–µ–Ω—Ç—Ä–µ –¥–æ 6 –º–ª–Ω" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] transition-all">
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                            </p>
                        </div>
                        
                        {% if is_manager %}
                        <!-- Manager: Client Email Input -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-envelope text-gray-400 mr-2"></i>Email –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                            </label>
                            <input type="email" 
                                   id="clientEmailInputModal" 
                                   placeholder="client@example.com" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] transition-all">
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-user-tie text-gray-400 mr-1"></i>
                                –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- Current Filters Preview -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-filter text-gray-400 mr-2"></i>–í–∞—à–∏ —Ñ–∏–ª—å—Ç—Ä—ã
                            </label>
                            <div id="currentFiltersPreview" class="space-y-2 text-sm text-gray-600">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 md:rounded-b-2xl sticky bottom-0 z-10">
                    <button onclick="saveSearchFromModal();" class="w-full py-3.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-semibold text-base flex items-center justify-center gap-2">
                        <i class="fas fa-heart"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫
                    </button>
                </div>
            </div>
        </div>
</div>

</section>

<!-- Main Content Section -->
<section class="px-4 py-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Mini Map Section - Compact on mobile, full on desktop -->
        <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Mini Map Preview - hidden on mobile, shown on desktop -->
            <div id="miniPropertiesMap" class="hidden md:block w-full relative" style="height: 200px; cursor: pointer;" onclick="handleMapClick(event)">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto text-[#0088CC] opacity-50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Link Button -->
            <button onclick="openFullscreenMap()" class="w-full px-4 py-3 hover:bg-gray-50 transition-colors cursor-pointer md:border-t md:border-gray-200">
                <div class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="font-semibold text-gray-900 text-sm">–ù–∞ –∫–∞—Ä—Ç–µ</span>
                    <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs font-medium properties-count">{{ total_properties or 0 }}</span>
                </div>
            </button>
        </div>

        <!-- Fullscreen Map Modal (Mobile/Desktop Responsive) -->
        <div id="fullscreenMapModal" 
             class="fixed inset-0 bg-white z-50 hidden flex flex-col" 
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="mapModalTitle">
            <!-- Modal Header - Mobile Only -->
            <div class="lg:hidden bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button onclick="closeFullscreenMap()" 
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                            aria-label="–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <h3 id="mapModalTitle" class="font-semibold text-gray-900">–û–±—ä–µ–∫—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
                </div>
                <div class="flex items-center gap-2">
                    <span id="mapObjectsCount" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">0</span>
                    <button onclick="closeMapAndSyncFilters()" 
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-medium hover:from-blue-700 hover:to-blue-800 transition-all shadow-md flex items-center gap-2"
                            aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        –°–ø–∏—Å–æ–∫
                    </button>
                </div>
            </div>
            
            <!-- Desktop Layout: Header + Cards + Map -->
            <div class="hidden lg:flex flex-col flex-1 overflow-hidden">
                <!-- Filter Header Toolbar -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10 flex-shrink-0">
                    <!-- Draw Area Button (always visible, outside of overflow container) -->
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <!-- ‚úÖ Logo -->
                        <a href="/" class="flex items-center gap-2 flex-shrink-0 mr-2 pl-2 border-r border-gray-200 pr-3 hover:opacity-80 transition-opacity">
                            <div class="w-8 h-8 bg-gradient-to-r from-[#0088CC] to-[#006699] rounded flex items-center justify-center text-white font-bold text-xs">In</div>
                        </a>
                        
                        <button id="mapDrawAreaBtn" onclick="enableMapDrawing()" 
                                class="px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-600 hover:bg-blue-50 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            –í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å
                        </button>
                        
                        <!-- Clear Area Button (hidden by default) -->
                        <button id="mapClearAreaBtn" onclick="clearMapDrawnArea()" 
                                class="hidden px-3 py-1.5 rounded-full border border-red-300 bg-red-50 text-red-600 text-xs font-medium whitespace-nowrap transition-all hover:border-red-500 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            –û—Ç–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-3 flex-1 overflow-x-auto ml-3" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
                        <!-- Quick Room Filters -->
                        <button data-quick-room="0" onclick="toggleQuickRoomFilter(0)" 
                                class="quick-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium transition-all hover:border-blue-600 hover:bg-blue-50">
                            –°—Ç—É–¥–∏—è
                        </button>
                        <button data-quick-room="1" onclick="toggleQuickRoomFilter(1)" 
                                class="quick-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium transition-all hover:border-blue-600 hover:bg-blue-50">
                            1-–∫–æ–º–Ω
                        </button>
                        <button data-quick-room="2" onclick="toggleQuickRoomFilter(2)" 
                                class="quick-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium transition-all hover:border-blue-600 hover:bg-blue-50">
                            2-–∫–æ–º–Ω
                        </button>
                        <button data-quick-room="3" onclick="toggleQuickRoomFilter(3)" 
                                class="quick-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium transition-all hover:border-blue-600 hover:bg-blue-50">
                            3-–∫–æ–º–Ω
                        </button>
                        <button data-quick-room="4" onclick="toggleQuickRoomFilter(4)" 
                                class="quick-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium transition-all hover:border-blue-600 hover:bg-blue-50">
                            4+–∫–æ–º–Ω
                        </button>
                        
                        <!-- Search Input -->
                        <div class="relative flex-shrink-0" style="min-width: 200px; overflow: visible;">
                            <input type="text" id="mapSearchInput" 
                                   placeholder="–ê–¥—Ä–µ—Å, –ñ–ö, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫..." 
                                   class="w-full px-3 py-1.5 pl-8 border border-gray-300 rounded-full text-xs focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                   autocomplete="off">
                            <svg class="absolute left-2.5 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <!-- Autocomplete dropdown - fixed position to avoid overflow clipping -->
                            <div id="mapSearchDropdown" class="hidden fixed bg-white border border-gray-200 rounded-lg shadow-xl max-h-64 overflow-y-auto" style="z-index: 99999; min-width: 280px;">
                            </div>
                        </div>
                        
                        <!-- Advanced Filters -->
                        <button onclick="openMapAdvancedFilters()" 
                                class="flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-600 hover:bg-blue-50 flex items-center gap-2 relative">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0-4v2m0-6V4"></path>
                            </svg>
                            –ï—â—ë —Ñ–∏–ª—å—Ç—Ä—ã
                            <span id="mapActiveFiltersCount" class="hidden absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">0</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-3 flex-shrink-0 ml-4">
                        <span id="mapObjectsCountDesktop" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">0</span>
                        <button onclick="closeMapAndSyncFilters()" 
                                class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-xs font-medium hover:bg-gray-200 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            –°–ø–∏—Å–æ–∫
                        </button>
                    </div>
                </div>
                
                <!-- ‚úÖ Active Filters Display -->
                <div id="mapActiveFiltersContainer" class="hidden bg-blue-50 border-b border-blue-200 px-4 py-2 flex items-center gap-2 flex-wrap text-xs">
                    <span class="font-medium text-gray-700">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</span>
                    <div id="mapActiveFiltersList" class="flex items-center gap-2 flex-wrap"></div>
                </div>
                
                <!-- Content: Cards + Map -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Left Panel: Property Cards (2-column grid) -->
                    <div class="w-[600px] bg-white border-r border-gray-200 flex flex-col overflow-hidden" style="height: 100%;">
                        <!-- Cards Container with 2-column grid -->
                        <div id="mapDesktopPropertiesContainer" class="overflow-y-auto flex-1 p-4" style="max-height: calc(100% - 20px); height: 100%;">
                            <!-- Property cards will be loaded here in 2-column grid -->
                        </div>
                    </div>
                    
                    <!-- Right Panel: Map -->
                    <div class="flex-1 bg-gray-100 relative overflow-hidden">
                        <div id="fullscreenMapContainerDesktop" class="w-full h-full" style="height: 100%;" aria-label="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏">
                            <!-- Map will be initialized here -->
                        </div>
                        
                        <!-- Map Legend -->
                        <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10 text-xs">
                            <div class="font-semibold text-gray-900 mb-2">–°—Ç–∞—Ç—É—Å:</div>
                            <div class="space-y-1 text-gray-700">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: #10B981;"></div>
                                    <span>–°–¥–∞–Ω</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: #F59E0B;"></div>
                                    <span>–°—Ç—Ä–æ–∏—Ç—Å—è</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: #EF4444;"></div>
                                    <span>–°—Ç–∞—Ä—Ç –ø—Ä–æ–¥–∞–∂</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Toolbar for Map (Mobile Only) -->
            <div id="mapFilterToolbar" class="lg:hidden bg-white border-b border-gray-200 px-3 py-2 sticky top-[60px] z-[9]">
                <div class="flex items-center gap-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- Filter Button - ICON ONLY with Badge -->
                    <button id="mapQuickFiltersBtn" onclick="openMapQuickFilters()" 
                            class="relative flex-shrink-0 p-2.5 rounded-full border-2 border-blue-600 text-blue-600 hover:bg-blue-50 transition-all shadow-sm"
                            aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0-4v2m0-6V4"></path>
                        </svg>
                        <!-- Filter Badge (–Ω–∞ –∫–∞—Ä—Ç–µ) -->
                        <span id="advancedFiltersCounterMap" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Quick Room Filters -->
                    <button data-toolbar-room="0" onclick="toggleToolbarRoomFilter(0)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        –°—Ç—É–¥–∏—è
                    </button>
                    <button data-toolbar-room="1" onclick="toggleToolbarRoomFilter(1)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        1–∫
                    </button>
                    <button data-toolbar-room="2" onclick="toggleToolbarRoomFilter(2)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        2–∫
                    </button>
                    <button data-toolbar-room="3" onclick="toggleToolbarRoomFilter(3)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        3–∫
                    </button>
                    <button data-toolbar-room="4" onclick="toggleToolbarRoomFilter(4)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        4+–∫
                    </button>
                    
                    <!-- Quick Price Filter -->
                    <button id="mapToolbarPriceBtn" onclick="openMapQuickFilters()" 
                            class="flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        –¶–µ–Ω–∞
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="mapFilterLoading" class="hidden mt-2 flex items-center gap-2 text-sm text-gray-600">
                    <svg class="animate-spin h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...</span>
                </div>
            </div>
            
            <!-- Quick Filters Bottom Sheet (Mobile Only) -->
            <div id="mapQuickFiltersBackdrop" 
                 class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-[60] hidden transition-opacity duration-300"
                 style="opacity: 0;"
                 onclick="closeMapQuickFilters()">
            </div>
            
            <div id="mapQuickFiltersSheet" 
                 class="lg:hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[70] hidden w-full max-w-full"
                 style="transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 85vh;">
                <!-- Sheet Header -->
                <div class="sticky top-0 bg-white rounded-t-3xl px-4 py-3 border-b border-gray-200 z-10 w-full">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                    <div class="flex items-center justify-between w-full">
                        <h3 class="text-lg font-bold text-gray-900">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="resetQuickFilters()" 
                                    class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="closeMapQuickFilters()" 
                                    class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                    aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sheet Content - Scrollable -->
                <div class="overflow-y-auto px-4 py-4 space-y-6 w-full" style="max-height: calc(85vh - 140px); scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Rooms Filter -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–ö–æ–º–Ω–∞—Ç–Ω–æ—Å—Ç—å</label>
                        <div class="flex flex-wrap gap-2">
                            <button data-quick-room="0" onclick="toggleQuickRoomFilter(0)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                –°—Ç—É–¥–∏—è
                            </button>
                            <button data-quick-room="1" onclick="toggleQuickRoomFilter(1)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                1-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="2" onclick="toggleQuickRoomFilter(2)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                2-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="3" onclick="toggleQuickRoomFilter(3)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                3-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="4" onclick="toggleQuickRoomFilter(4)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                4+–∫–æ–º–Ω
                            </button>
                        </div>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="quickPriceFrom" placeholder="–æ—Ç" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                            <input type="number" id="quickPriceTo" placeholder="–¥–æ" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Area Range -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="quickAreaFrom" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                            <input type="number" id="quickAreaTo" oninput="window.updateFilteredCount()" placeholder="–¥–æ" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- More Filters Link -->
                    <button onclick="openMapAdvancedFiltersFromQuick()" 
                            class="w-full py-3 px-4 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:border-blue-500 hover:text-blue-600 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        –ë–æ–ª—å—à–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    </button>
                </div>
                
                <!-- Sheet Footer -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 w-full">
                    <button onclick="applyQuickFilters()" 
                            class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
                        –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters Modal for Map (Mobile) + Desktop Right Panel -->
            <div id="mapAdvancedFiltersModal" class="hidden fixed inset-0 bg-white z-[60] w-full lg:w-80 lg:right-0 lg:top-0 lg:bottom-0 lg:rounded-l-2xl lg:border-l lg:border-gray-200 lg:shadow-xl lg:inset-auto" style="transition: transform 0.3s ease-out;">
                <!-- Header -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10 flex items-center justify-between lg:rounded-tl-2xl">
                    <h3 class="text-lg font-semibold text-gray-800 lg:text-base">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div class="flex items-center gap-3">
                        <button onclick="resetMapAdvancedFilters()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                        <button onclick="closeMapAdvancedFilters()" 
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Scrollable Content -->
                <div class="overflow-y-auto p-4 space-y-6 w-full lg:pb-24" style="height: calc(100vh - 120px); max-height: calc(100vh - 120px);">
                    <!-- Price Range -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapPriceFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapPriceTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Area -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapAreaFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapAreaTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Floor -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapFloorFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapFloorTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Developers -->
                    <div>
                        <button onclick="toggleMapDevelopersList()" 
                                class="w-full flex items-center justify-between text-sm font-medium text-gray-700 mb-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <span>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</span>
                            <svg id="mapDevelopersChevron" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="mapDevelopersList" class="hidden space-y-2 max-h-60 overflow-y-auto">
                            <!-- Will be populated dynamically by loadDevelopers() -->
                        </div>
                    </div>
                    
                    <!-- Completion Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                        <div class="space-y-2">
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2024" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2024</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2025" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2025</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2026" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2026</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Building Status: Delivered/Under Construction -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å –¥–æ–º–∞</label>
                        <div class="space-y-2">
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="delivered" data-map-filter="building_status" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">üü¢ –°–¥–∞–Ω</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="under_construction" data-map-filter="building_status" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">üî® –°—Ç—Ä–æ–∏—Ç—Å—è</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Object Class -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                        <div class="space-y-2">
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ë–∏–∑–Ω–µ—Å</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ü—Ä–µ–º–∏—É–º</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 lg:rounded-bl-2xl">
                    <button onclick="applyMapAdvancedFilters()" 
                            class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg lg:py-2 lg:text-sm">
                        –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </button>
                </div>
            </div>
            
            <!-- Map Container (Mobile Only) -->
            <div id="fullscreenMapContainer" class="lg:hidden w-full h-full relative" style="height: calc(100vh - 140px);" aria-label="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏">
                <!-- Return to List Button - Bottom Left -->
                <button onclick="closeFullscreenMap()" 
                        class="absolute bottom-6 left-4 z-[10] px-5 py-3 bg-white text-gray-900 rounded-xl shadow-lg text-sm font-semibold hover:bg-gray-50 transition-all flex items-center gap-2 border border-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    –°–ø–∏—Å–æ–∫
                </button>
            </div>
        </div>

        <!-- Mobile Bottom Sheet for Property Cards -->
        <div id="bottomSheetBackdrop" 
             class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden transition-opacity duration-300"
             style="opacity: 0;"
             onclick="closePropertyBottomSheet()">
        </div>
        
        <div id="propertyBottomSheet" 
             class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[70] hidden"
             style="transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 70vh;">
            <!-- Bottom Sheet Header -->
            <div class="sticky top-0 bg-white rounded-t-3xl px-4 py-3 border-b border-gray-200 z-10">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-900">–ö–≤–∞—Ä—Ç–∏—Ä—ã –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ</h3>
                    <button onclick="closePropertyBottomSheet()" 
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                            aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Bottom Sheet Content - Vertical Scroll -->
            <div id="bottomSheetPropertiesContainer" 
                 class="overflow-y-auto px-4 py-2 space-y-3"
                 style="max-height: 60vh; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                <!-- Property cards will be inserted here dynamically -->
            </div>
        </div>

        <!-- Results Header -->
        <div id="properties-toolbar" class="max-w-7xl mx-auto w-full mb-4 px-1">
            <div class="flex items-center justify-between py-2 gap-2">
                <span class="text-sm text-gray-600 whitespace-nowrap">
                    {% if results_text %}
                        {{ results_text }}
                    {% else %}
                        –ù–∞–π–¥–µ–Ω–æ <span id="results-count">{{ total_properties or 0 }}</span> 
                        {% set count = total_properties or 0 %}
                        {% if count % 100 in [11, 12, 13, 14] %}–æ–±—ä–µ–∫—Ç–æ–≤
                        {% elif count % 10 == 1 %}–æ–±—ä–µ–∫—Ç
                        {% elif count % 10 in [2, 3, 4] %}–æ–±—ä–µ–∫—Ç–∞
                        {% else %}–æ–±—ä–µ–∫—Ç–æ–≤{% endif %}
                    {% endif %}
                </span>
                <span class="text-gray-300 hidden sm:inline">|</span>
                <button id="sort-toggle" class="flex items-center gap-1 text-sm text-[#0088CC] font-medium whitespace-nowrap ml-auto" onclick="document.getElementById('sort-dropdown').classList.toggle('hidden');">
                    <span id="sort-label">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                </button>
                <select id="sort-select" class="hidden absolute opacity-0 pointer-events-none">
                    <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="price-asc">–ü–æ —Ü–µ–Ω–µ ‚Üë</option>
                    <option value="price-desc">–ü–æ —Ü–µ–Ω–µ ‚Üì</option>
                    <option value="area-asc">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üë</option>
                    <option value="area-desc">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üì</option>
                    <option value="date-desc">–ü–æ –¥–∞—Ç–µ ‚Üì</option>
                </select>
                <div id="sort-dropdown" class="hidden fixed inset-0 z-50 flex items-end justify-center bg-black/30" onclick="if(event.target===this)this.classList.add('hidden');">
                    <div class="bg-white rounded-t-2xl w-full max-w-md p-4 pb-8 shadow-xl">
                        <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                        <h4 class="text-base font-semibold text-gray-900 mb-3">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h4>
                        <div class="space-y-1" id="sort-options">
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50 active" data-value="" onclick="selectSort(this)">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50" data-value="price-asc" onclick="selectSort(this)">–ü–æ —Ü–µ–Ω–µ ‚Üë</button>
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50" data-value="price-desc" onclick="selectSort(this)">–ü–æ —Ü–µ–Ω–µ ‚Üì</button>
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50" data-value="area-asc" onclick="selectSort(this)">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üë</button>
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50" data-value="area-desc" onclick="selectSort(this)">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üì</button>
                            <button class="sort-option w-full text-left px-4 py-3 rounded-lg text-sm hover:bg-gray-50" data-value="date-desc" onclick="selectSort(this)">–ü–æ –¥–∞—Ç–µ ‚Üì</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
        function selectSort(btn) {
            var val = btn.dataset.value;
            var label = btn.textContent.trim();
            document.getElementById('sort-select').value = val;
            document.getElementById('sort-label').textContent = label;
            document.getElementById('sort-dropdown').classList.add('hidden');
            document.querySelectorAll('.sort-option').forEach(function(b){b.classList.remove('active','bg-blue-50','text-[#0088CC]','font-semibold');});
            btn.classList.add('active','bg-blue-50','text-[#0088CC]','font-semibold');
            var event = new Event('change', {bubbles: true});
            document.getElementById('sort-select').dispatchEvent(event);
        }
        (function syncSortUI() {
            var sel = document.getElementById('sort-select');
            if (!sel) return;
            var params = new URLSearchParams(window.location.search);
            var sortVal = params.get('sort') || sel.value || '';
            if (sortVal) { sel.value = sortVal; }
            var currentVal = sel.value;
            var opts = document.querySelectorAll('.sort-option');
            opts.forEach(function(o) {
                o.classList.remove('active','bg-blue-50','text-[#0088CC]','font-semibold');
                if (o.dataset.value === currentVal) {
                    o.classList.add('active','bg-blue-50','text-[#0088CC]','font-semibold');
                    var lbl = document.getElementById('sort-label');
                    if (lbl) lbl.textContent = o.textContent.trim();
                }
            });
        })();
        </script>
    </div>
</section>

<!-- Property Cards Container - Grid Layout -->
<section class="py-0 bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-4">
        <div id="properties-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 w-full">
            <!-- Properties will be loaded here -->
        </div>
    </div>
</section>

<!-- Call-to-Action Section -->
<section class="py-8 bg-white">
    <div class="max-w-7xl mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">
                    –ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–¥–±–æ—Ä–∫—É –∫–≤–∞—Ä—Ç–∏—Ä
                </h2>
                <p class="text-sm text-gray-600">
                    –ù–∞—à–∏ —ç–∫—Å–ø–µ—Ä—Ç—ã –ø–æ–¥–±–µ—Ä—É—Ç –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫—ç—à–±–µ–∫–æ–º
                </p>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex flex-col sm:flex-row gap-3 mb-3">
                    <input type="text" placeholder="–í–∞—à–µ –∏–º—è" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <input type="tel" placeholder="+7 (900) 123-45-67" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <select class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option>–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç</option>
                        <option>–î–æ 3 –º–ª–Ω ‚ÇΩ</option>
                        <option>3-5 –º–ª–Ω ‚ÇΩ</option>
                        <option>5-8 –º–ª–Ω ‚ÇΩ</option>
                        <option>8-12 –º–ª–Ω ‚ÇΩ</option>
                        <option>–°–≤—ã—à–µ 12 –º–ª–Ω ‚ÇΩ</option>
                    </select>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 items-center">
                    <button onclick="openApplicationModal();" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition-colors text-sm">
                        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É
                    </button>
                    <p class="text-xs text-gray-500">
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
console.log('üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô SCRIPT –ó–ê–ü–£–©–ï–ù!');

// ‚úÖ –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –°–ë–†–û–°–ê –§–ò–õ–¨–¢–†–û–í
window.TOTAL_RESET = function() {
    console.log('üî• TOTAL_RESET –ê–ö–¢–ò–í–ò–†–û–í–ê–ù - –°–ë–†–û–° –í–°–ï–ì–û!');
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
    const newUrl = '/properties';
    console.log('üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞:', newUrl);
    window.location.href = newUrl;
};

// ‚úÖ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É
console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è TOTAL_RESET –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');

// ===== IMAGE SLIDER FUNCTIONS (using transform-based sliding from properties-list-updater.js) =====
function nextImageSlide(button, event) {
    if (event) { event.stopPropagation(); event.preventDefault(); }
    var container = button.closest('.carousel-container');
    if (container && window.carouselNext) window.carouselNext(container);
    return false;
}
function prevImageSlide(button, event) {
    if (event) { event.stopPropagation(); event.preventDefault(); }
    var container = button.closest('.carousel-container');
    if (container && window.carouselPrev) window.carouselPrev(container);
    return false;
}
function goToImageSlide(button, slideIndex, event) {
    if (event) { event.stopPropagation(); event.preventDefault(); }
    var container = button.closest('.carousel-container');
    if (container && window.carouselGoTo) window.carouselGoTo(container, slideIndex);
    return false;
}
window.nextImageSlide = nextImageSlide;
window.prevImageSlide = prevImageSlide;
window.goToImageSlide = goToImageSlide;

window.initializeImageCarousels = function() {
    console.log('üé† Initializing image carousels...');
    if (typeof initCarouselSwipeHandlers === 'function') {
        initCarouselSwipeHandlers();
    } else if (typeof window.initCarouselSwipeHandlers === 'function') {
        window.initCarouselSwipeHandlers();
    }
    if (typeof initMobileCarouselSwipe === 'function') {
        initMobileCarouselSwipe();
    }
    console.log('‚úÖ Image carousels initialized');
};

function initMobileCarouselSwipe() {
    if (typeof window.initCarouselSwipeHandlers === 'function') {
        window.initCarouselSwipeHandlers();
    }
}
window.initMobileCarouselSwipe = initMobileCarouselSwipe;

window.toggleMobileQuickFilter = function(btn, filterType) {
    btn.classList.toggle('active');
    
    if (filterType === 'mortgage') {
        var mortgageCheckbox = document.querySelector('input[data-filter-type="mortgage"]');
        if (mortgageCheckbox) {
            mortgageCheckbox.checked = btn.classList.contains('active');
        }
    } else if (filterType.startsWith('rooms-')) {
        var roomValue = filterType.split('-')[1];
        var roomCheckbox = document.querySelector('input[data-filter-type="rooms"][value="' + roomValue + '"]');
        if (roomCheckbox) {
            roomCheckbox.checked = btn.classList.contains('active');
            if (typeof window.handleRoomFilterChange === 'function') {
                window.handleRoomFilterChange();
            }
        }
    } else if (filterType === 'new') {
        var newRadio = document.querySelector('input[data-filter-type="property_type"][value="apartments"]');
        if (newRadio && btn.classList.contains('active')) {
            newRadio.checked = true;
        } else {
            var allRadio = document.querySelector('input[data-filter-type="property_type"][value="all"]');
            if (allRadio) allRadio.checked = true;
        }
        if (typeof window.handlePropertyTypeChange === 'function') {
            window.handlePropertyTypeChange();
        }
    }
    
    if (typeof window.applyFilters === 'function') {
        window.applyFilters();
    }
};

function initQuickFiltersDrag() {
    var container = document.querySelector('#mobile-quick-filters .overflow-x-auto');
    if (!container || container._dragInitialized) return;
    container._dragInitialized = true;
    var isDown = false;
    var startX = 0;
    var scrollLeftStart = 0;
    var hasDragged = false;
    
    container.addEventListener('mousedown', function(e) {
        isDown = true;
        hasDragged = false;
        startX = e.pageX;
        scrollLeftStart = container.scrollLeft;
        container.style.cursor = 'grab';
    });
    container.addEventListener('mousemove', function(e) {
        if (!isDown) return;
        var walk = e.pageX - startX;
        if (Math.abs(walk) > 5) {
            hasDragged = true;
            container.style.cursor = 'grabbing';
            e.preventDefault();
        }
        if (hasDragged) {
            container.scrollLeft = scrollLeftStart - walk;
        }
    });
    container.addEventListener('mouseup', function() {
        isDown = false;
        container.style.cursor = '';
        if (hasDragged) {
            container.querySelectorAll('.mobile-quick-chip').forEach(function(btn) {
                btn.style.pointerEvents = 'none';
            });
            setTimeout(function() {
                container.querySelectorAll('.mobile-quick-chip').forEach(function(btn) {
                    btn.style.pointerEvents = '';
                });
            }, 100);
        }
    });
    container.addEventListener('mouseleave', function() {
        isDown = false;
        container.style.cursor = '';
    });
    
    var touchStartX = 0;
    var touchScrollLeft = 0;
    var touchDragging = false;
    container.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        touchScrollLeft = container.scrollLeft;
        touchDragging = false;
    }, {passive: true});
    container.addEventListener('touchmove', function(e) {
        var dx = touchStartX - e.touches[0].clientX;
        if (Math.abs(dx) > 5) touchDragging = true;
        if (touchDragging) {
            container.scrollLeft = touchScrollLeft + dx;
        }
    }, {passive: false});
    container.addEventListener('touchend', function() {
        if (touchDragging) {
            container.querySelectorAll('.mobile-quick-chip').forEach(function(btn) {
                btn.style.pointerEvents = 'none';
            });
            setTimeout(function() {
                container.querySelectorAll('.mobile-quick-chip').forEach(function(btn) {
                    btn.style.pointerEvents = '';
                });
            }, 200);
        }
    }, {passive: true});
}
document.addEventListener('DOMContentLoaded', initQuickFiltersDrag);

console.log('‚úÖ Carousel functions loaded and available globally');



// Set authentication status immediately at the start
window.user_authenticated = {{ user_authenticated|tojson|safe }};
window.manager_authenticated = {{ manager_authenticated|tojson|safe }};
window.isManager = {{ manager_authenticated|tojson|safe }};
{% if current_manager %}
window.current_manager = {{ current_manager.to_dict()|tojson|safe }};
{% else %}
window.current_manager = null;
{% endif %}

// User's assigned manager data for properties page
{% if manager %}
window.userManager = {{ manager|tojson|safe }};
{% else %}
window.userManager = null;
{% endif %}

// ‚ö° VERSION MARKER: v1761503218
console.log('üî•üî•üî• PROPERTIES.HTML VERSION: v1761503218 - LOADED! üî•üî•üî•');

// Debug authentication status
console.log('Authentication status:', {
    user_authenticated: window.user_authenticated,
    manager_authenticated: window.manager_authenticated,
    current_manager: window.current_manager || null
});

let map;
let markers = [];

// Properties already filtered and paginated by server
let allProperties = {{ properties|tojson|safe }};
window.allProperties = allProperties; // Make globally accessible
console.log('‚úÖ window.allProperties initialized:', window.allProperties.length, 'properties');
let filteredProperties = allProperties; // Don't re-filter on client
window.filteredProperties = filteredProperties;
// Note: window.serverSidePagination, totalProperties, totalPages set in extra_head block

let selectedRooms = new Set();
let currentSortBy = 'price-desc';
let currentPage = {{ page }};
window.itemsPerPage = 20;
let residentialComplexes = [];

// Completely remove old favorites system - now handled by FavoritesManager
// Clear localStorage to avoid conflicts
if (localStorage.getItem('favorites')) {
    localStorage.removeItem('favorites');
    console.log('Cleared old localStorage favorites');
}

// Favorites counter is now handled by FavoritesManager class
// function updateFavoritesCounter() - DEPRECATED

// Advanced Filters Object
let advancedFilters = {
    districts: [],
    developers: [],
    propertyTypes: [],
    priceMin: 0,
    priceMax: 0,
    roomTypes: [],
    distances: [],
    areas: [],
    directions: [],
    payments: [],
    areaFrom: 0,
    areaTo: 0
};

// Add galleries to properties for testing
allProperties.forEach((property, index) => {
    if (!property.gallery) {
        property.gallery = [
            property.image,
            `https://via.placeholder.com/400x300/FF5722/FFFFFF?text=–ö—É—Ö–Ω—è`,
            `https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=–°–ø–∞–ª—å–Ω—è`,
            `https://via.placeholder.com/400x300/9C27B0/FFFFFF?text=–í–∏–¥`
        ];
    }
});

// ‚úÖ sortProperties —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ /static/js/properties-sorting.js

// Initialize smart autocomplete search for properties catalog
function initializePropertiesSmartSearch() {
    const searchInput = document.getElementById('property-search');
    if (!searchInput) return;
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –µ—Å–ª–∏ SuperSearch —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    if (typeof SuperSearch !== 'undefined' || searchInput.dataset.superSearchInitialized) {
        console.log('‚è≠Ô∏è Skipping SmartAutocomplete - SuperSearch already handles property-search');
        return;
    }
    
    // Make the input container relative
    searchInput.parentElement.style.position = 'relative';
    
    // Initialize smart autocomplete
    const autocomplete = new SmartAutocomplete(searchInput, {
        placeholder: '–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É, –ñ–ö, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É...',
        onSelect: function(suggestion) {
            console.log('üéØ SmartAutocomplete onSelect called:', suggestion);
            handlePropertiesSearchSelection(suggestion);
        },
        onSearch: function(query, suggestion) {
            console.log('üîç SmartAutocomplete onSearch called:', query, suggestion);
            performPropertiesSmartSearch(query, suggestion);
        }
    });
    
    // Store reference globally
    window.propertiesAutocomplete = autocomplete;
}

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è SuperSearch
window.handlePropertySuggestionSelect = function(suggestion) {
    console.log('üéØ Properties selected suggestion:', suggestion);
    handlePropertiesSearchSelection(suggestion);
};

// Handle search suggestion selection for properties
function handlePropertiesSearchSelection(suggestion) {
    console.log('üè∑Ô∏è Handling suggestion:', suggestion);
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –µ—Å—Ç—å URL, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ –Ω–µ–º—É
    if (suggestion.url) {
        console.log('üîó Navigating to URL:', suggestion.url);
        window.location.href = suggestion.url;
        return;
    }
    
    // Fallback - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    switch(suggestion.type) {
        case 'address':
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
            break;
        case 'complex':
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –ñ–ö
            console.log('üèóÔ∏è Setting complex filter:', suggestion.text);
            activeFilters.residential_complex = suggestion.text;
            if (window.activeFilters) {
                window.activeFilters.residential_complex = suggestion.text;
            }
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É, —Ç.–∫. —Ñ–∏–ª—å—Ç—Ä —Ç–µ–ø–µ—Ä—å –≤ activeFilters.residential_complex
            document.getElementById('property-search').value = '';
            applyFilters();
            console.log('‚úÖ Complex filter applied:', activeFilters.residential_complex);
            break;
        case 'developer':
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É
            console.log('üè¢ Setting developer filter:', suggestion.text);
            const developerSelect = document.getElementById('developer-filter');
            if (developerSelect) {
                const option = Array.from(developerSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    developerSelect.value = option.value;
                    console.log('‚úÖ Developer filter set to:', option.value);
                } else {
                    console.warn('‚ö†Ô∏è Developer not found in select:', suggestion.text);
                }
            }
            document.getElementById('property-search').value = '';
            applyFilters();
            break;
        case 'district':
            const districtSelect = document.getElementById('district-filter');
            if (districtSelect) {
                const option = Array.from(districtSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    districtSelect.value = option.value;
                }
            }
            applyFilters();
            break;
        case 'rooms':
            // Handle room type suggestions
            if (suggestion.text.includes('–°—Ç—É–¥–∏')) {
                document.querySelector('input[value="0"]')?.click();
            } else if (suggestion.text.includes('1-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="1"]')?.click();
            } else if (suggestion.text.includes('2-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="2"]')?.click();
            } else if (suggestion.text.includes('3-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="3"]')?.click();
            }
            break;
        default:
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
    }
}

// Smart search for properties catalog
function performPropertiesSmartSearch(query, suggestion) {
    console.log('Performing properties smart search:', query, suggestion);
    document.getElementById('property-search').value = query;
    applyFilters();
}

// Enhanced search functionality with comprehensive suggestions for ALL parameters
function initializeSearch() {
    // Legacy function - replaced with smart search
    if (typeof initializePropertiesSmartSearch === 'function') {
        initializePropertiesSmartSearch();
    }
    
    const searchInput = document.getElementById('property-search');
    const suggestionsContainer = document.getElementById('property-searchSuggestions');
    
    // Create comprehensive search suggestions covering ALL filter types with REAL database data
    const suggestions = {
        districts: ['–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π'],
        rooms: ['–°—Ç—É–¥–∏—è', '1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è'],
        propertyClass: ['–≠–∫–æ–Ω–æ–º', '–ö–æ–º—Ñ–æ—Ä—Ç', '–ë–∏–∑–Ω–µ—Å', '–ü—Ä–µ–º–∏—É–º'],
        wallMaterial: ['–ö–∏—Ä–ø–∏—á', '–ú–æ–Ω–æ–ª–∏—Ç', '–ü–∞–Ω–µ–ª—å', '–ì–∞–∑–æ–±–µ—Ç–æ–Ω'],
        floorsTotal: ['–¥–æ 5 —ç—Ç–∞–∂–µ–π', '6-10 —ç—Ç–∞–∂–µ–π', '11-20 —ç—Ç–∞–∂–µ–π', '–±–æ–ª–µ–µ 20 —ç—Ç–∞–∂–µ–π'],
        completion: ['2024', '2025', '2026', '2028'],
        developers: ['–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è', 'AVA', '–¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ò–ù–í–ï–°–¢–ò–¶–ò–û–ù–ù–ê–Ø –ö–û–ú–ü–ê–ù–ò–Ø', '–°–ó –ö–ê–°–ö–ê–î', '–¢–û–ß–ù–û', '–°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ó–ê–°–¢–†–û–ô–©–ò–ö –ö–û–†–û–ù–ê'],
        complexes: ['–ñ–ö –ì–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å "–ù–µ—Å–∫—É—á–Ω—ã–π —Å–∞–¥"', '–ñ–ö –õ–µ—Å—Ç–æ—Ä–∏—è', '–ñ–ö –§–õ–û–†–ê', '–ñ–ö "–ö–∏—Å–ª–æ—Ä–æ–¥"', '–ñ–ö "–ß–∞–π–Ω—ã–µ —Ö–æ–ª–º—ã"', '–ñ–ö –ì–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å "–ì—Ä–∞–Ω–¥ –ö–∞—Å–∫–∞–¥"'],
        properties: [],
        streets: []
    };
    
    // Add property and complex data
    allProperties.forEach(property => {
        const propertyTitle = property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω';
        suggestions.properties.push(propertyTitle + ' ' + property.area + ' –º¬≤');
        suggestions.complexes.push(property.residential_complex);
        suggestions.developers.push(property.developer);
        suggestions.streets.push(property.location);
    });
    
    // Add –ñ–ö suggestions
    residentialComplexes.forEach(complex => {
        suggestions.complexes.push(complex.name);
        suggestions.developers.push(complex.developer);
        suggestions.streets.push(complex.location);
    });
    
    // Remove duplicates from each category
    Object.keys(suggestions).forEach(key => {
        suggestions[key] = [...new Set(suggestions[key])].filter(Boolean);
    });
    
    const allSuggestions = Object.values(suggestions).flat();
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
            return;
        }
        
        // Filter both property and –ñ–ö suggestions
        const propertySuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 5);
            
        const complexSuggestions = residentialComplexes
            .filter(complex => 
                complex.name.toLowerCase().includes(query) ||
                complex.developer.toLowerCase().includes(query) ||
                complex.location.toLowerCase().includes(query)
            )
            .slice(0, 3);
        
        let suggestionHTML = '';
        
        if (propertySuggestions.length > 0) {
            suggestionHTML += propertySuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`)
                .join('');
        }
        
        if (complexSuggestions.length > 0) {
            if (propertySuggestions.length > 0) {
                suggestionHTML += '<div class="border-t border-gray-200 my-1"></div>';
            }
            suggestionHTML += complexSuggestions
                .map(complex => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${complex.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building mr-2 text-[#0088CC]"></i><strong>${complex.name}</strong><br>
                    <small class="text-gray-500 ml-6">${complex.developer} ‚Ä¢ ${complex.apartments_count} –∫–≤–∞—Ä—Ç–∏—Ä</small>
                </div>`)
                .join('');
        }
        
        if (suggestionHTML && suggestionsContainer) {
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });
}

// New smart search function
function performSmartSearch() {
    const searchValue = document.getElementById('property-search').value.trim();
    if (!searchValue) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');
        return;
    }
    
    // Clear all current filters first
    clearAllFilters();
    
    // Try to detect and apply filters based on search
    const searchLower = searchValue.toLowerCase();
    
    // Check districts
    const districts = ['—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π', '–∑–∞–ø–∞–¥–Ω—ã–π', '–∫–∞—Ä–∞—Å—É–Ω—Å–∫–∏–π', '–ø—Ä–∏–∫—É–±–∞–Ω—Å–∫–∏–π', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã–π'];
    districts.forEach(district => {
        if (searchLower.includes(district)) {
            const checkbox = document.querySelector(`input[data-filter-type="district"][value*="${district}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check property class
    const propertyClasses = ['—ç–∫–æ–Ω–æ–º', '–∫–æ–º—Ñ–æ—Ä—Ç', '–±–∏–∑–Ω–µ—Å', '–ø—Ä–µ–º–∏—É–º'];
    propertyClasses.forEach(cls => {
        if (searchLower.includes(cls)) {
            const checkbox = document.querySelector(`input[data-filter="property_class"][value*="${cls}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check wall materials
    const materials = ['–∫–∏—Ä–ø–∏—á', '–º–æ–Ω–æ–ª–∏—Ç', '–ø–∞–Ω–µ–ª—å', '–≥–∞–∑–æ–±–µ—Ç–æ–Ω'];
    materials.forEach(material => {
        if (searchLower.includes(material)) {
            const checkbox = document.querySelector(`input[data-filter="wall_material"][value*="${material}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Apply filters and search
    applyFilters();
}

function selectSuggestion(suggestion, category) {
    document.getElementById('property-search').value = suggestion;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    
    // Auto-apply the selected filter
    if (category === 'district') {
        const checkbox = document.querySelector(`input[data-filter-type="district"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'developer') {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${suggestion}"]`) ||
                        document.querySelector(`input[data-filter="developer"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    }
    
    console.log('Selected suggestion:', suggestion, 'Category:', category);
    
    // Apply search filter
    applyFilters();
}

function selectComplexSuggestion(complexName) {
    document.getElementById('property-search').value = complexName;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    applyFilters();
}

// Room filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const roomButtons = document.querySelectorAll('.room-btn');
    
    roomButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rooms = this.dataset.rooms;
            
            if (selectedRooms.has(rooms)) {
                selectedRooms.delete(rooms);
                this.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.add('border-gray-300', 'text-gray-700');
            } else {
                selectedRooms.add(rooms);
                this.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.remove('border-gray-300', 'text-gray-700');
            }
            
            applyFilters();
        });
    });
    
    // Advanced filters panel handlers
    const advancedToggle = document.getElementById('advancedFiltersToggle');
    const advancedPanel = document.getElementById('advancedFiltersPanel');
    const applyAdvancedBtn = document.getElementById('applyAdvancedFilters');
    const applyAdvancedBtnBottom = document.getElementById('applyAdvancedFiltersBottom');
    
    if (advancedToggle && advancedPanel) {
        advancedToggle.addEventListener('click', function() {
            const isVisible = !advancedPanel.classList.contains('hidden');
            advancedPanel.classList.toggle('hidden');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (!isVisible) {
                updateFilteredResultsCount();
                console.log('‚úÖ Advanced filters panel opened, count updated');
            }
        });
    }
    
    // Update results count when applying filters from top button
    if (applyAdvancedBtn) {
        applyAdvancedBtn.addEventListener('click', function() {
            console.log('üîò Apply button (top) clicked');
            applyFilters();
        });
    }
    
    // Update results count when applying filters from bottom button
    if (applyAdvancedBtnBottom) {
        applyAdvancedBtnBottom.addEventListener('click', function() {
            console.log('üîò Apply button (bottom) clicked');
            applyFilters();
        });
    }
});

// Update filtered results count - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π total –∏–∑ —Å–∏—Å—Ç–µ–º—ã
function updateFilteredResultsCount() {
    const resultsCountEl = document.getElementById('filteredResultsCount');
    
    if (!resultsCountEl) {
        console.log('‚ö†Ô∏è filteredResultsCount element not found');
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ pagination (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º AJAX –∑–∞–ø—Ä–æ—Å–µ)
    const currentTotal = window.totalProperties || 311;
    resultsCountEl.textContent = currentTotal.toString();
    console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏:', currentTotal);
}

// Function to remove specific filter and reload page (for active filter badges)
        url.searchParams.delete('price_min');
        url.searchParams.delete('price_max');
    } else if (filterType === 'property_type') {
        url.searchParams.delete('property_type');
    } else if (filterType === 'developers') {
        const devs = url.searchParams.getAll('developers').filter(d => d !== value);
        url.searchParams.delete('developers');
        url.searchParams.delete('developer');
        devs.forEach(d => url.searchParams.append('developers', d));
    } else if (filterType === 'districts') {
        const dists = url.searchParams.getAll('districts').filter(d => d !== value);
        url.searchParams.delete('districts');
        dists.forEach(d => url.searchParams.append('districts', d));
    } else {
        url.searchParams.delete(filterType);
    }
    
    console.log('üóëÔ∏è Removing filter:', filterType, value, '-> Redirect to:', url.toString());
    window.location.href = url.toString();
}

// Apply filters function - called from buttons
            const data = await response.json();
            
            console.log('üåç Smart Search —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', data);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ª–∏ –≥–æ—Ä–æ–¥ –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
            if (data.detected_city && data.detected_city.city_slug) {
                const detectedCitySlug = data.detected_city.city_slug;
                const currentCitySlug = '{{ current_city.slug if current_city else "krasnodar" }}';
                const currentCityId = {{ current_city.id if current_city else 1 }};
                window.currentCityId = currentCityId;
                
                if (detectedCitySlug !== currentCitySlug) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                    console.log(`üöÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞: ${currentCitySlug} ‚Üí ${detectedCitySlug}`);
                    window.location.href = `/${detectedCitySlug}/properties?search=${encodeURIComponent(searchQuery)}`;
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –±—É–¥–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç
                }
            }
        } catch (error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ Smart Search API:', error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
    }
    
    // Apply the filters
    filterProperties();
    
    // Close the advanced filters panel
    const advancedPanel = document.getElementById('advancedFiltersPanel');
    if (advancedPanel) {
        advancedPanel.classList.add('hidden');
        console.log('‚úÖ Advanced filters panel closed after applying filters');
    }
}

// Reset advanced filters function
function resetAdvancedFilters() {
    console.log('üîÑ –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –ø–∞–Ω–µ–ª–∏...');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
    document.getElementById('areaFrom').value = '';
    document.getElementById('areaTo').value = '';
    document.getElementById('floorFrom').value = '';
    document.getElementById('floorTo').value = '';
    document.getElementById('maxFloorFrom').value = '';
    document.getElementById('maxFloorTo').value = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('#advancedFiltersPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    updateFilteredResultsCount();
    
    console.log('‚úÖ –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã');
}

// ========== –ú–û–î–ê–õ–¨–ù–´–ï –ü–ê–ù–ï–õ–ò –§–ò–õ–¨–¢–†–û–í (Rooms, Price, Developer) ==========

// Rooms Filter Modal
function openRoomsFilterPanel() {
    const panel = document.getElementById('roomsFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.unusedUFC === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('roomsFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Rooms filter panel opened');
    }
}

function resetRoomsFilter() {
    document.querySelectorAll('#roomsFilterPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.unusedUFC === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('roomsFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Rooms filter reset');
}

function applyRoomsFilter() {
    console.log('üîµ applyRoomsFilter called');
    const panel = document.getElementById('roomsFilterPanel');
    if (!panel) {
        console.error('‚ùå roomsFilterPanel not found!');
        return;
    }
    
    console.log('üîµ Closing panel...');
    panel.classList.add('hidden');
    panel.classList.remove('mobile-fullscreen');
    document.body.style.overflow = '';
    
    console.log('üîµ Panel closed, applying filters...');
    applyFilters();
    console.log('‚úÖ Rooms filter applied and panel closed');
}
window.applyRoomsFilter = applyRoomsFilter;
window.openRoomsFilterPanel = openRoomsFilterPanel;
window.resetRoomsFilter = resetRoomsFilter;

// Price Filter Modal
function openPriceFilterPanel() {
    const panel = document.getElementById('priceFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ desktop dropdown
        const priceFrom = document.getElementById('priceFrom');
        const priceTo = document.getElementById('priceTo');
        const priceFromModal = document.getElementById('priceFromModal');
        const priceToModal = document.getElementById('priceToModal');
        
        if (priceFrom && priceFromModal) priceFromModal.value = priceFrom.value;
        if (priceTo && priceToModal) priceToModal.value = priceTo.value;
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.unusedUFC === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('priceFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Price filter panel opened');
    }
}

function resetPriceFilter() {
    document.getElementById('priceFromModal').value = '';
    document.getElementById('priceToModal').value = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.unusedUFC === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('priceFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Price filter reset');
}

        applyFilters();
    }
    
    const panel = document.getElementById('priceFilterPanel');
    panel.classList.add('hidden');
    panel.classList.remove('mobile-fullscreen');
    document.body.style.overflow = '';
    console.log('‚úÖ Price filter applied and panel closed');
}
window.openPriceFilterPanel = openPriceFilterPanel;
window.resetPriceFilter = resetPriceFilter;

// Developer Filter Modal
function openDeveloperFilterPanel() {
    const panel = document.getElementById('developerFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.unusedUFC === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('developerFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Developer filter panel opened');
    }
}

function resetDeveloperFilter() {
    document.querySelectorAll('#developerFilterPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.unusedUFC === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('developerFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Developer filter reset');
}

function applyDeveloperFilter() {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å—ã —Å desktop dropdown
    const modalCheckboxes = document.querySelectorAll('#developerFilterPanel input[type="checkbox"]:checked');
    const desktopCheckboxes = document.querySelectorAll('.dropdown[data-filter="developers"] input[type="checkbox"]');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º desktop —á–µ–∫–±–æ–∫—Å—ã
    desktopCheckboxes.forEach(cb => cb.checked = false);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    modalCheckboxes.forEach(modalCb => {
        const value = modalCb.value;
        const desktopCb = document.querySelector(`.dropdown[data-filter="developers"] input[value="${value}"]`);
        if (desktopCb) desktopCb.checked = true;
    });
    
    applyFilters();
    document.getElementById('developerFilterPanel').classList.add('hidden');
    console.log('‚úÖ Developer filter applied and panel closed');
}
window.applyDeveloperFilter = applyDeveloperFilter;
window.openDeveloperFilterPanel = openDeveloperFilterPanel;
window.resetDeveloperFilter = resetDeveloperFilter;

// Save Search Modal
function openSaveSearchModal() {
    console.log('üíó Opening save search modal');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = window.user_authenticated || window.manager_authenticated;
    
    if (!isAuthenticated) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if (confirm('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∏—Å–∫–∏, –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–µ–π—á–∞—Å?')) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (typeof openApplicationModal === 'function') {
                openApplicationModal();
            } else {
                // –ò–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                window.location.href = '/register';
            }
        }
        return;
    }
    
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        const searchName = generateSearchNameForModal();
        const nameInput = document.getElementById('searchNameInputModal');
        if (nameInput) {
            nameInput.value = searchName;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º preview —Ñ–∏–ª—å—Ç—Ä–æ–≤
        updateFiltersPreview();
        
        console.log('‚úÖ Save search modal opened');
    }
}

function closeSaveSearchModal() {
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
    }
    if (window.forceRestoreScroll) {
        window.forceRestoreScroll();
    } else {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
}

// saveSearchFromModal defined in early block (window.saveSearchFromModal)
// generateSearchNameForModal –∏ updateFiltersPreview –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —Ä–∞–Ω–Ω–µ–º –±–ª–æ–∫–µ (—Å—Ç—Ä–æ–∫–∞ ~1133-1201)

// –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function closeAllFilterPanels() {
    ['advancedFiltersPanel', 'roomsFilterPanel', 'priceFilterPanel', 'developerFilterPanel', 'saveSearchModal', 'searchModalPanel'].forEach(panelId => {
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.classList.add('hidden');
            panel.classList.remove('mobile-fullscreen');
        }
    });
    if (window.forceRestoreScroll) {
        window.forceRestoreScroll();
    } else {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ inline onclick
window.applyRoomsFilter = applyRoomsFilter;
window.applyDeveloperFilter = applyDeveloperFilter;
window.resetRoomsFilter = resetRoomsFilter;
window.resetPriceFilter = resetPriceFilter;
window.resetDeveloperFilter = resetDeveloperFilter;
window.openRoomsFilterPanel = openRoomsFilterPanel;
window.openPriceFilterPanel = openPriceFilterPanel;
window.openDeveloperFilterPanel = openDeveloperFilterPanel;
window.closeAllFilterPanels = closeAllFilterPanels;

console.log('‚úÖ Filter panel functions exported to window');

// ========== –ü–ï–†–ï–•–í–ê–¢ –ö–õ–ò–ö–û–í –ù–ê DROPDOWN –ö–ù–û–ü–ö–ê–• –î–õ–Ø –ú–û–ë–ê–ô–õ–ê ==========
document.addEventListener('DOMContentLoaded', function() {
    // Rooms filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const roomsDropdownBtn = document.querySelector('.dropdown[data-filter="rooms"] .dropdown-btn');
    if (roomsDropdownBtn) {
        roomsDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openRoomsFilterPanel();
            }
        });
    }
    
    // Price filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const priceDropdownBtn = document.querySelector('.dropdown[data-filter="price"] .dropdown-btn');
    if (priceDropdownBtn) {
        priceDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openPriceFilterPanel();
            }
        });
    }
    
    // Developer filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const developerDropdownBtn = document.querySelector('.dropdown[data-filter="developers"] .dropdown-btn');
    if (developerDropdownBtn) {
        developerDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openDeveloperFilterPanel();
            }
        });
    }
    
    console.log('‚úÖ Mobile filter panel listeners initialized');
});

// Apply all filters
function resetAllFilters() {
    // Reset all form elements
    document.getElementById('property-search').value = '';
    document.getElementById('district-filter').value = '';
    document.getElementById('developer-filter').value = '';
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('area-from').value = '';
    document.getElementById('area-to').value = '';
    document.getElementById('property-type-filter').value = '';
    document.getElementById('completion-date-filter').value = '';
    document.getElementById('mortgage-filter').value = '';
    document.getElementById('sort-select').value = 'price-asc';
    
    // Reset room buttons
    selectedRooms.clear();
    document.querySelectorAll('.room-btn').forEach(button => {
        button.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        button.classList.add('border-gray-300', 'text-gray-700');
    });
    
    // Reset advanced filters
    if (typeof resetAdvancedFilters === 'function') {
        resetAdvancedFilters();
    }
    
    // Hide reset button
    document.getElementById('resetFiltersBtn').style.display = 'none';
    
    // Clear URL parameters and redirect to clean properties page
    window.location.href = '/' + citySlug + '/properties';
}


// Update properties list display with pagination
function updatePropertiesList(properties) {
    const listContainer = document.getElementById('properties-container');
    
    if (!listContainer) {
        console.warn('Properties container not found - display mode may not be available');
        return;
    }
    
    if (properties.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">üîç</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">–ö–≤–∞—Ä—Ç–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            </div>
        `;
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –µ—Å–ª–∏ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –î–ï–õ–ê–ï–ú –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–¥–µ—Å—å - properties —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    console.log(`üìä –†–µ–Ω–¥–µ—Ä–∏–º ${properties.length} –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${currentPage}`);
    const paginatedProperties = properties; // –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    
    // Get current view mode from data attribute
    const isGridView = listContainer.getAttribute('data-view-mode') === 'grid';
    
    if (isGridView) {
        listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
        listContainer.className = 'space-y-6';
    }
    
    console.log(`üîÑ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: —Ä–µ–∂–∏–º ${isGridView ? '—Å–µ—Ç–∫–∞' : '—Å–ø–∏—Å–æ–∫'}, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}, –æ–±—ä–µ–∫—Ç–æ–≤: ${properties.length}`);
    
    // Create manager block (will be inserted between properties) - uses user's manager or company data
    const manager = window.userManager;
    const managerName = manager ? manager.name : 'InBack';
    const managerPhone = manager ? manager.phone : '8 (862) 266-62-16';
    const managerEmail = manager ? manager.email : 'info@inback.ru';
    const managerPhoto = manager && manager.photo ? manager.photo : null;
    const managerInitials = manager ? (manager.name.split(' ')[0][0] + (manager.name.split(' ')[1] ? manager.name.split(' ')[1][0] : '')) : 'IB';
    const managerLabel = manager ? '–ú–µ–Ω–µ–¥–∂–µ—Ä' : 'InBack';
    const helpText = manager ? '–æ—Ç –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞' : '–æ—Ç –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã';
    
    const managerBlock = `
        <div class="manager-block bg-gray-100 rounded-lg p-4 border border-gray-200 shadow-sm relative ${isGridView ? 'md:col-span-2 lg:col-span-3' : ''}" id="manager-block-${currentPage}">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors" onclick="this.parentElement.style.display='none';" title="√ó">
                <i class="fas fa-times"></i>
            </button>
            <div class="flex items-center gap-4">
                <div class="flex-shrink-0">
                    ${managerPhoto 
                        ? `<img src="${managerPhoto}" alt="${managerName}" class="w-16 h-16 rounded object-cover">` 
                        : manager 
                            ? `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-sm font-bold">${managerInitials}</div>`
                            : `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-xl"><i class="fas fa-building"></i></div>`
                    }
                    <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 text-center font-medium">${managerLabel}</div>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${managerName}</h3>
                    <p class="text-gray-600 text-sm mb-3">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –ø–æ–º–æ—â—å ${helpText} –ø–æ –ø–æ–∫—É–ø–∫–µ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏</p>
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-phone text-xs"></i>
                            <span>${managerPhone}</span>
                        </div>
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-envelope text-xs"></i>
                            <span>${managerEmail}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Render paginated properties with manager blocks inserted
    const propertyCards = [];
    paginatedProperties.forEach((property, index) => {
        // Add manager block after every 6th property (every 2 rows in grid view)
        if (index > 0 && index % 6 === 0) {
            propertyCards.push(managerBlock);
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (isGridView) {
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–µ—Ç–∫–∏
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer flex flex-col h-full" 
                 data-property-url="/${citySlug}/object/${property.id}"
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}"
                 data-property-type="${property.property_type || property.type}">
                
                <!-- Image Section -->
                <div class="relative h-48 group">
                    <div class="carousel-container w-full h-full relative overflow-hidden bg-gray-100" data-property-id="${property.id}" style="touch-action:pan-y;cursor:grab;user-select:none;">
                        <div class="carousel-track" style="display:flex;width:${((property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length) * 100}%;transform:translateX(0);will-change:transform;" data-index="0" data-count="${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide" style="width:${100/((property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length)}%;flex-shrink:0;height:100%;" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'} ${property.area} –º¬≤ –≤ –ñ–ö ${property.complex_name || property.residential_complex || ''}" class="w-full h-full object-cover" draggable="false" style="user-select:none;-webkit-user-drag:none;-webkit-touch-callout:none;pointer-events:none;">
                            </div>
                        `).join('')}
                        </div>
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <button onclick="event.stopPropagation(); event.preventDefault(); window.carouselPrev(this.closest('.carousel-container'));" class="absolute left-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); window.carouselNext(this.closest('.carousel-container'));" class="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    
                    ${(property.gallery && property.gallery.length > 1) ? `
                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 z-20 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        ${(property.gallery || []).map((_, di) => `
                            <span class="carousel-dot w-1.5 h-1.5 rounded-full ${di === 0 ? 'bg-white' : 'bg-white/50'} cursor-pointer" data-slide="${di}" onclick="event.stopPropagation(); var c=this.closest('.property-card');if(c){window.carouselGoTo(c.querySelector('.carousel-container'),${di});}"></span>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- Badges -->
                    <div class="hidden sm:flex absolute top-2 left-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                    
                    <div class="absolute top-2 right-2 w-7 h-7 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                        <i class="fas fa-heart text-gray-400 hover:text-red-500 text-xs transition-colors"></i>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-4 flex flex-col flex-1">
                    <h3 class="font-semibold text-gray-900 mb-2 text-sm">
                        ${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'}, ${property.area} –º¬≤, ${property.floor}/${property.total_floors} —ç—Ç.
                    </h3>
                    
                    <div class="mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-xs" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || '–ñ–ö –õ–µ—Ç–Ω–∏–π'}
                        </a>
                        <span class="text-blue-600 text-xs"> ‚Ä¢ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</span>
                    </div>
                    
                    <div class="text-gray-600 text-xs mb-3">
                        <span class="font-medium">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫:</span> ${property.developer || property.developer_name || '–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è'}
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <div class="flex items-center justify-between mt-auto">
                        <div>
                            ${property.price && property.price > 0 ? `
                            <div class="text-lg font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                            </div>
                            <div class="flex items-center gap-1 flex-wrap">
                                <div class="text-xs text-green-600">
                                    –æ—Ç ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å
                                </div>
                                ${property.cashback && property.cashback > 0 ? `
                                <div class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-medium">
                                    –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback).toLocaleString('ru-RU')} ‚ÇΩ
                                </div>
                                ` : ''}
                            </div>
                            ` : `
                            <div class="text-lg font-bold text-gray-900">
                                –ü–æ –∑–∞–ø—Ä–æ—Å—É
                            </div>
                            `}
                        </div>
                        <div class="hidden sm:flex gap-1">
                            <button class="map-btn w-8 h-8 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white transition-all duration-200 shadow-sm" 
                                    data-property-id="${property.id}" 
                                    data-lat="${property.latitude || 45.0355}" 
                                    data-lon="${property.longitude || 38.9753}" 
                                    data-name="${property.complex_name || property.residential_complex || ''}" 
                                    title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
                                <i class="fas fa-map-marker-alt text-xs"></i>
                            </button>
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-8 h-8 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white transition-all duration-200 shadow-sm" 
                               title="PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf text-xs"></i>
                            </a>
                            <button class="compare-btn w-8 h-8 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white transition-all duration-200 shadow-sm" 
                                    data-property-id="${property.id}" title="–°—Ä–∞–≤–Ω–∏—Ç—å" onclick="event.stopPropagation();">
                                <i class="fas fa-balance-scale text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex sm:hidden items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                        <a href="tel:${property.manager_phone || property.phone || '+78622666216'}" class="flex-1 flex items-center justify-center gap-2 bg-[#0088CC] text-white rounded-full py-2.5 text-sm font-medium" onclick="event.stopPropagation();">
                            <i class="fas fa-phone text-xs"></i>
                            <span>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</span>
                        </a>
                        <button class="favorite-heart w-10 h-10 bg-gray-100 hover:bg-red-50 rounded-full flex items-center justify-center" data-property-id="${property.id}" onclick="event.stopPropagation();" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                            <i class="fas fa-heart text-gray-400 text-sm"></i>
                        </button>
                        <button class="compare-btn w-10 h-10 bg-gray-100 hover:bg-blue-50 rounded-full flex items-center justify-center" data-property-id="${property.id}" onclick="event.stopPropagation();" title="–°—Ä–∞–≤–Ω–∏—Ç—å">
                            <i class="fas fa-balance-scale text-gray-400 text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>`);
        } else {
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 w-full flex cursor-pointer min-h-[280px] sm:min-h-[280px]" 
                 data-property-url="/${citySlug}/object/${property.id}"
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}"
                 data-property-type="${property.property_type || property.type}">
                
                <!-- Image Section with Slider -->
                <div class="relative w-full sm:w-80 h-52 sm:h-60 flex-shrink-0 group">
                    <div class="carousel-container w-full h-full relative overflow-hidden bg-gray-100 sm:rounded-lg rounded-t-lg" data-property-id="${property.id}" style="touch-action:pan-y;cursor:grab;user-select:none;">
                        <div class="carousel-track" style="display:flex;width:${((property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length) * 100}%;transform:translateX(0);will-change:transform;" data-index="0" data-count="${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide" style="width:${100/((property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).length)}%;flex-shrink:0;height:100%;" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'} ${property.area} –º¬≤ –≤ –ñ–ö ${property.complex_name || property.residential_complex || ''} - —Ñ–æ—Ç–æ ${index + 1}" class="w-full h-full object-cover" draggable="false" style="user-select:none;-webkit-user-drag:none;-webkit-touch-callout:none;pointer-events:none;">
                            </div>
                        `).join('')}
                        </div>
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <button onclick="event.stopPropagation(); event.preventDefault(); window.carouselPrev(this.closest('.carousel-container'));" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); window.carouselNext(this.closest('.carousel-container'));" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    
                    ${(property.gallery && property.gallery.length > 1) ? `
                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 z-20 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        ${(property.gallery || []).slice(0, 6).map((_, di) => `
                            <span class="carousel-dot w-1.5 h-1.5 rounded-full ${di === 0 ? 'bg-white' : 'bg-white/50'} cursor-pointer" data-slide="${di}" onclick="event.stopPropagation(); var c=this.closest('.property-card');if(c){window.carouselGoTo(c.querySelector('.carousel-container'),${di});}"></span>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- Cashback Badge - desktop only -->
                    <div class="hidden sm:block absolute top-3 left-3 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                    
                    <!-- Favorite Heart -->
                    <div class="absolute top-3 right-3 flex gap-2 z-20">
                        <div class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                            <i class="fas fa-heart text-gray-400 hover:text-red-500 text-sm transition-colors"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="flex-1 p-4 sm:p-6 flex flex-col">
                    <h2 class="text-base sm:text-xl font-semibold text-gray-900 mb-2 sm:mb-3">
                        ${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'}, ${property.area} –º¬≤, ${property.floor}/${property.total_floors} —ç—Ç.
                    </h2>
                    
                    <div class="mb-1 sm:mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-xs sm:text-sm font-medium" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || '–ñ–ö –õ–µ—Ç–Ω–∏–π'}
                        </a>
                        <span class="text-blue-600 text-xs sm:text-sm"> ‚Ä¢ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</span>
                    </div>
                    
                    <!-- Address - hidden on mobile -->
                    <div class="hidden sm:block text-gray-500 text-sm mb-2">
                        ${property.address || ''}
                    </div>
                    
                    <!-- Developer -->
                    <div class="text-gray-600 text-xs sm:text-sm mb-2 sm:mb-4">
                        <span class="font-medium">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫:</span> ${property.developer || property.developer_name || ''}
                    </div>
                    
                    <!-- Tags - hidden on mobile -->
                    <div class="hidden sm:flex gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.floor}-–π —ç—Ç–∞–∂</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.renovation_display_name || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏'}</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.complex_object_class_display_name || '–ö–æ–º—Ñ–æ—Ä—Ç'}</span>
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <!-- Price + Desktop Action Buttons -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col gap-1 sm:gap-2">
                            ${property.price && property.price > 0 ? `
                            <div class="text-lg sm:text-2xl font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                            </div>
                            <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
                                <div class="text-xs text-green-600 sm:bg-green-100 sm:text-green-800 sm:px-2 sm:py-1 sm:rounded">
                                    –æ—Ç ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å
                                </div>
                                ${property.cashback && property.cashback > 0 ? `
                                <div class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-medium">
                                    –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback).toLocaleString('ru-RU')} ‚ÇΩ
                                </div>
                                ` : ''}
                            </div>
                            ` : `
                            <div class="text-lg sm:text-2xl font-bold text-gray-900">
                                –ü–æ –∑–∞–ø—Ä–æ—Å—É
                            </div>
                            `}
                        </div>
                        <div class="hidden sm:flex gap-2">
                            <button class="map-btn w-10 h-10 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white hover:scale-105 transition-all duration-200 shadow-sm" 
                                    data-property-id="${property.id}" 
                                    data-lat="${property.latitude || 45.0355}" 
                                    data-lon="${property.longitude || 38.9753}" 
                                    data-name="${property.complex_name || property.residential_complex || ''}" 
                                    title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-10 h-10 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white hover:scale-105 transition-all duration-200 shadow-sm" 
                               title="–°–∫–∞—á–∞—Ç—å PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <button class="compare-btn w-10 h-10 bg-[#0088CC]/10 hover:bg-[#0088CC] rounded-full flex items-center justify-center text-[#0088CC] hover:text-white hover:scale-105 transition-all duration-200 shadow-sm" 
                                    data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é" onclick="event.stopPropagation();">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile Action Bar -->
                    <div class="mobile-action-bar flex sm:hidden items-center gap-2 mt-3 pt-3 border-t border-gray-100 relative z-20" style="pointer-events:auto;">
                        <button class="mobile-call-btn flex-1 flex items-center justify-center gap-2 bg-green-500 text-white rounded-full py-2.5 text-sm font-medium" 
                                style="touch-action:manipulation;pointer-events:auto;" 
                                data-property-id="${property.id}"
                                data-complex-name="${(property.complex_name || property.residential_complex || '').replace(/"/g, '&quot;')}"
                                onclick="event.stopPropagation();event.stopImmediatePropagation();openPhoneModal(this.dataset.propertyId, this.dataset.complexName);"
                                data-phone="${property.manager_phone || property.phone || '+78622666216'}">
                            <i class="fas fa-phone text-xs"></i>
                            <span>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</span>
                        </button>
                        <button class="map-btn w-9 h-9 bg-[#0088CC]/10 rounded-full flex items-center justify-center" 
                                data-property-id="${property.id}" 
                                data-lat="${property.latitude || 45.0355}" 
                                data-lon="${property.longitude || 38.9753}" 
                                data-name="${property.complex_name || property.residential_complex || ''}" 
                                style="touch-action:manipulation;" 
                                onclick="event.stopPropagation();event.stopImmediatePropagation();openMapModal(parseFloat(this.dataset.lat), parseFloat(this.dataset.lon), this.dataset.name || '–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ');" 
                                title="–ù–∞ –∫–∞—Ä—Ç–µ">
                            <i class="fas fa-map-marker-alt text-[#0088CC] text-sm"></i>
                        </button>
                        <a href="/object/${property.id}/pdf" target="_blank" 
                           class="w-9 h-9 bg-[#0088CC]/10 rounded-full flex items-center justify-center" 
                           style="touch-action:manipulation;" onclick="event.stopPropagation();event.stopImmediatePropagation();" title="PDF">
                            <i class="fas fa-file-pdf text-[#0088CC] text-sm"></i>
                        </a>
                        <button class="compare-btn w-9 h-9 bg-[#0088CC]/10 rounded-full flex items-center justify-center" data-property-id="${property.id}" style="touch-action:manipulation;" onclick="event.stopPropagation();event.stopImmediatePropagation();" title="–°—Ä–∞–≤–Ω–∏—Ç—å">
                            <i class="fas fa-balance-scale text-[#0088CC] text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>`);
        }
    });
    
    // Set the combined content to container
    listContainer.innerHTML = propertyCards.join('');
    
    // ‚úÖ –£–ë–†–ê–õ–ò: –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ filterProperties()
    // updatePaginationControls(totalItems, totalPages);
    
    // Initialize favorites and comparison buttons after rendering
    setTimeout(() => {
        initializeAllButtons();
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (window.favoritesManager) {
            console.log('üîÑ Updating favorites UI after rendering');
            window.favoritesManager.updateFavoritesUI();
            window.favoritesManager.updateComplexFavoritesUI();
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        const isManager = document.querySelector('a[href*="manager/dashboard"]') !== null;
        console.log('üîç Checking manager status:', isManager);
        console.log('üîç Property cards found:', document.querySelectorAll('.property-card').length);
        
        if (isManager) {
            let addedButtons = 0;
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            document.querySelectorAll('.property-card').forEach((card, index) => {
                const existingPresentationBtn = card.querySelector('.presentation-btn');
                const compareBtn = card.querySelector('.compare-btn');
                const propertyId = compareBtn?.getAttribute('data-property-id') || 
                                 card.querySelector('.favorite-heart')?.getAttribute('data-property-id');
                
                console.log(`üîç Card ${index}: compareBtn=${!!compareBtn}, existingBtn=${!!existingPresentationBtn}, propertyId=${propertyId}`);
                
                // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è - –∏–º–µ–Ω–Ω–æ —Ç—É–¥–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                if (compareBtn && !existingPresentationBtn && propertyId) {
                    const buttonsContainer = compareBtn.parentElement;
                    console.log(`üîç Found buttons container:`, buttonsContainer?.className);
                    
                    if (buttonsContainer) {
                        const presentationBtn = document.createElement('button');
                        presentationBtn.className = 'presentation-btn w-10 h-10 bg-white border border-[#0088CC] rounded flex items-center justify-center text-[#0088CC] hover:bg-blue-50 hover:border-blue-600 hover:text-blue-700 hover:scale-105 transition-all duration-200';
                        presentationBtn.setAttribute('data-property-id', propertyId);
                        presentationBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é';
                        presentationBtn.innerHTML = '<i class="fas fa-plus"></i>';
                        presentationBtn.onclick = function(e) {
                            e.stopPropagation();
                            openPresentationModal(propertyId);
                        };
                        buttonsContainer.appendChild(presentationBtn);
                        addedButtons++;
                    }
                }
            });
            console.log(`üîÑ –ö–Ω–æ–ø–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${addedButtons} –∏–∑ ${document.querySelectorAll('.property-card').length}`);
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
        if (typeof ensureCompareButtonIcons === 'function') {
            ensureCompareButtonIcons();
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        setTimeout(() => {
            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (window.favoritesManager) {
                window.favoritesManager.updateFavoritesUI();
                window.favoritesManager.updateComplexFavoritesUI();
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            if (typeof window.reinitComparisonButtons === 'function') {
                window.reinitComparisonButtons();
            }
        }, 100);
        
        console.log('Property list updated, buttons initialized');
    }, 50);
}
window.updatePropertiesList = updatePropertiesList; // Make globally accessible

// Advanced Filters System  
// ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º activeFilters –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
const urlInitParams = new URLSearchParams(window.location.search);
let activeFilters = {};
if (urlInitParams.has('residential_complex')) {
    activeFilters.residential_complex = urlInitParams.get('residential_complex');
    console.log('üèóÔ∏è Initialized activeFilters.residential_complex from URL:', activeFilters.residential_complex);
}
if (urlInitParams.has('developer')) {
    activeFilters.developer_name = urlInitParams.get('developer');
    console.log('üè¢ Initialized activeFilters.developer_name from URL:', activeFilters.developer_name);
}
if (urlInitParams.has('address') || urlInitParams.has('q')) {
    activeFilters.address = urlInitParams.get('address') || urlInitParams.get('q');
    console.log('üìç Initialized activeFilters.address from URL:', activeFilters.address);
}

// ‚úÖ SYNC: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å UI
const roomsFromURL = urlInitParams.getAll('rooms');
if (roomsFromURL.length > 0) {
    activeFilters.rooms = roomsFromURL;
    console.log('üö™ Initialized activeFilters.rooms from URL:', roomsFromURL);
}

// ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ UI —Å URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
function syncUIFromURL() {
    try {
        console.log('üîÑ Syncing UI from URL parameters...');
        const params = new URLSearchParams(window.location.search);
        console.log('üìã URL params:', window.location.search);
    
    // Sync room checkboxes
    const rooms = params.getAll('rooms');
    if (rooms.length > 0) {
        rooms.forEach(room => {
            const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${room}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`‚úÖ Room ${room} checkbox checked from URL`);
            }
        });
        // Update button text
        const roomsButtonText = document.getElementById('roomsFilterText');
        if (roomsButtonText) {
            const roomLabels = rooms.map(r => r === '0' ? '–°—Ç—É–¥–∏–∏' : r + '-–∫').join(', ');
            roomsButtonText.textContent = roomLabels;
            console.log('‚úÖ Updated room button text:', roomLabels);
        }
    }
    
    // Sync price inputs
    const priceMin = params.get('price_min');
    const priceMax = params.get('price_max');
    if (priceMin) {
        const priceFromEl = document.getElementById('priceFrom');
        const priceFromModal = document.getElementById('priceFromModal');
        // URL contains price in rubles, inputs expect millions
        const priceMinInMillions = parseFloat(priceMin) >= 1000000 ? (parseFloat(priceMin) / 1000000).toString() : priceMin;
        if (priceFromEl) priceFromEl.value = priceMinInMillions;
        if (priceFromModal) priceFromModal.value = priceMinInMillions;
    }
    if (priceMax) {
        const priceToEl = document.getElementById('priceTo');
        const priceToModal = document.getElementById('priceToModal');
        // URL contains price in rubles, inputs expect millions
        const priceMaxInMillions = parseFloat(priceMax) >= 1000000 ? (parseFloat(priceMax) / 1000000).toString() : priceMax;
        if (priceToEl) priceToEl.value = priceMaxInMillions;
        if (priceToModal) priceToModal.value = priceMaxInMillions;
    }
    if (priceMin || priceMax) {
        const priceButtonText = document.getElementById('priceFilterText');
        if (priceButtonText) {
            const minText = priceMin ? (parseInt(priceMin)/1000000).toFixed(1) + ' –º–ª–Ω' : '';
            const maxText = priceMax ? (parseInt(priceMax)/1000000).toFixed(1) + ' –º–ª–Ω' : '';
            if (minText && maxText) {
                priceButtonText.textContent = minText + ' - ' + maxText;
            } else if (minText) {
                priceButtonText.textContent = '–æ—Ç ' + minText;
            } else if (maxText) {
                priceButtonText.textContent = '–¥–æ ' + maxText;
            }
        }
    }
    
    // Sync developer filter
    const developer = params.get('developer');
    if (developer) {
        const devCheckbox = document.querySelector(`input[data-filter-type="developers"][value="${developer}"]`);
        if (devCheckbox) devCheckbox.checked = true;
    }
    
    // Sync districts
    params.getAll('districts').forEach(district => {
        const distCheckbox = document.querySelector(`input[data-filter-type="districts"][value="${district}"]`);
        if (distCheckbox) distCheckbox.checked = true;
    });
    
    console.log('‚úÖ UI synced from URL');
    
    // Update active filters display
    if (typeof window.displayActiveFilters === 'function') {
        setTimeout(() => {
            window.displayActiveFilters();
            console.log('‚úÖ Active filters display updated');
        }, 100);
    }
    } catch (error) {
        console.error('‚ùå Error syncing UI from URL:', error);
    }
}
window.syncUIFromURL = syncUIFromURL;

// Run sync immediately and also after delay to ensure all elements exist
console.log('üìå syncUIFromURL registered, will call now...');
try {
    // Immediate call
    syncUIFromURL();
} catch(e) {
    console.error('‚ùå Immediate syncUIFromURL failed:', e);
}

// Also call with delay as backup
setTimeout(function() {
    try {
        console.log('‚è∞ Running delayed syncUIFromURL...');
        syncUIFromURL();
    } catch(e) {
        console.error('‚ùå Delayed syncUIFromURL failed:', e);
    }
}, 500);

window.activeFilters = activeFilters; // Make globally accessible
let originalProperties = [...allProperties];

function initializeClearAllButton() {
    // Clear all filters button - –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ"...');
    const clearAllBtn = document.getElementById('clearAllFilters');
    if (clearAllBtn) {
        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ clearAllFilters –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫');
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = '/' + (window.citySlug || '{{ city_slug }}') + '/properties';
            return;
        });
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ clearAllFilters —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    } else {
        console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ clearAllFilters –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM');
        console.log('üîç –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:');
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach((btn, index) => {
            console.log(`–ö–Ω–æ–ø–∫–∞ ${index}: id="${btn.id}", class="${btn.className}", text="${btn.textContent.trim()}"`);
        });
    }
}

// ‚úÖ –£–î–ê–õ–ï–ù–ê: –ü–µ—Ä–≤–∞—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è

// Initialize dropdown filters functionality
function initializeDropdownFilters() {
    console.log('üîß initializeDropdownFilters() CALLED');
    
    // Remove existing listeners to prevent duplicates
    const existingListeners = document.querySelectorAll('[data-dropdown-initialized]');
    existingListeners.forEach(el => el.removeAttribute('data-dropdown-initialized'));
    
    // Get property filter buttons - include quick filters but exclude header dropdowns  
    const searchSection = document.querySelector('section.py-8.bg-gray-50');
    const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
    
    console.log('üîç searchSection:', searchSection);
    console.log('üîç propertySection:', propertySection);
    
    if (!searchSection && !propertySection) {
        console.error('‚ùå NO sections found!');
        return;
    }
    
    // Get quick filter buttons from search section and advanced filter buttons from property section
    let filterButtons = [];
    if (searchSection) {
        const quickFilterBtns = Array.from(searchSection.querySelectorAll('.dropdown .dropdown-btn'));
        console.log(`‚úÖ Found ${quickFilterBtns.length} quick filter buttons in searchSection`);
        filterButtons = filterButtons.concat(quickFilterBtns);
    }
    if (propertySection) {
        filterButtons = filterButtons.concat(Array.from(propertySection.querySelectorAll('.filter-dropdown .filter-option-btn, #toggleAllFilters')));
    }
    
    // Also get buttons from advanced filters section
    const advancedSection = document.querySelector('#advancedFiltersSection');
    if (advancedSection) {
        filterButtons = filterButtons.concat(Array.from(advancedSection.querySelectorAll('.filter-dropdown .filter-option-btn')));
    }
    
    filterButtons.forEach(button => {
        // Skip if already initialized
        if (button.hasAttribute('data-dropdown-initialized')) return;
        button.setAttribute('data-dropdown-initialized', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.id === 'toggleAllFilters') {
                // Handle "–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã" button specially
                toggleAdvancedFilters();
                return;
            }
            
            const dropdown = this.closest('.filter-dropdown') || this.closest('.dropdown');
            let menu = null;
            
            if (dropdown) {
                menu = dropdown.querySelector('.dropdown-menu');
            }
            
            if (!menu && dropdown) {
                // Also check for filter-dropdown-menu class for advanced filters
                menu = dropdown.querySelector('.filter-dropdown-menu');
            }
            
            if (menu) {
                // Check current menu state BEFORE closing others
                let isCurrentMenuOpen = false;
                if (menu.classList.contains('dropdown-menu')) {
                    isCurrentMenuOpen = menu.classList.contains('open');
                } else if (menu.classList.contains('filter-dropdown-menu')) {
                    isCurrentMenuOpen = !menu.classList.contains('hidden');
                }
                
                // Close all dropdowns including the current one
                document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(openMenu => {
                    openMenu.classList.remove('open');
                    openMenu.classList.add('hidden');
                });
                
                // If the clicked menu was closed, open it
                if (!isCurrentMenuOpen) {
                    if (menu.classList.contains('dropdown-menu')) {
                        menu.classList.add('open');
                        menu.classList.remove('hidden');
                    } else if (menu.classList.contains('filter-dropdown-menu')) {
                        menu.classList.remove('hidden');
                    }
                    console.log('Dropdown opened');
                } else {
                    console.log('Dropdown closed');
                }
            }
        });
    });
    
    // Remove existing document click listener and add fresh one
    if (window.dropdownDocumentListener) {
        document.removeEventListener('click', window.dropdownDocumentListener);
    }
    
    window.dropdownDocumentListener = function(e) {
        // Only close property filter dropdowns, never touch header
        const searchSection = document.querySelector('section.py-8.bg-gray-50');
        const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
        
        if (!e.target.closest('.filter-dropdown') && !e.target.closest('.dropdown') && !e.target.closest('#allFiltersPanel') && !e.target.closest('header') && !e.target.closest('nav')) {
            // Close dropdowns within search section (quick filters)
            if (searchSection) {
                searchSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
            
            // Close dropdowns within property section (advanced filters)
            if (propertySection) {
                propertySection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                propertySection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
                propertySection.querySelectorAll('#allFiltersPanel').forEach(panel => {
                    panel.classList.add('hidden');
                });
            }
            
            // Close dropdowns within advanced filters section
            const advancedSection = document.querySelector('#advancedFiltersSection');
            if (advancedSection) {
                advancedSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                advancedSection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        }
    };
    
    document.addEventListener('click', window.dropdownDocumentListener);
}

// Handle property type filter changes (–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–í—Ç–æ—Ä–∏—á–∫–∞)
function handlePropertyTypeFilterChange(event) {
    const sourceRadio = event ? event.target : null;
    if (!sourceRadio) return;
    
    const selectedValue = sourceRadio.value;
    
    // Update button text
    let buttonText = '–í—Å–µ —Ç–∏–ø—ã';
    if (selectedValue === 'new') {
        buttonText = '–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞';
    } else if (selectedValue === 'secondary') {
        buttonText = '–í—Ç–æ—Ä–∏—á–Ω–∞—è';
    }
    
    const textElement = document.getElementById('propertyTypeFilterText');
    if (textElement) {
        textElement.textContent = buttonText;
    }
    
    console.log('Property type filter changed:', selectedValue);
}

function handleRoomFilterChange() {
    if (window.roomFilterTimeout) {
        clearTimeout(window.roomFilterTimeout);
    }
    
    window.roomFilterTimeout = setTimeout(() => {
        const checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        const roomLabels = {
            '0': '–°—Ç—É–¥–∏–∏',
            '1': '1-–∫',
            '2': '2-–∫',
            '3': '3-–∫',
            '4': '4-–∫'
        };
        
        const buttonText = document.getElementById('roomsFilterText');
        if (buttonText) {
            if (checkedRooms.length === 0) {
                buttonText.textContent = '–ö–æ–º–Ω–∞—Ç';
            } else {
                buttonText.textContent = checkedRooms.map(r => roomLabels[r] || r).join(', ');
            }
        }
    }, 100);
}

// Handle region filter changes
function handleRegionFilterChange() {
    if (window.regionFilterTimeout) {
        clearTimeout(window.regionFilterTimeout);
    }
    
    window.regionFilterTimeout = setTimeout(() => {
        const checkedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        console.log('Region filters changed:', checkedRegions);
        
        // Update button text
        const buttonText = document.getElementById('regionFilterText');
        if (buttonText) {
            if (checkedRegions.length === 0) {
                buttonText.textContent = '–†–µ–≥–∏–æ–Ω';
            } else if (checkedRegions.length === 1) {
                buttonText.textContent = checkedRegions[0];
            } else {
                buttonText.textContent = `${checkedRegions.length} —Ä–µ–≥–∏–æ–Ω–æ–≤`;
            }
        }
        
        // ‚úÖ REMOVED: filterProperties() - only update UI, actual filtering happens via "–ù–∞–π—Ç–∏" button
    }, 100);
}

// Handle city filter changes
function handleCityFilterChange() {
    if (window.cityFilterTimeout) {
        clearTimeout(window.cityFilterTimeout);
    }
    
    window.cityFilterTimeout = setTimeout(() => {
        const checkedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        console.log('City filters changed:', checkedCities);
        
        // Update button text
        const buttonText = document.getElementById('cityFilterText');
        if (buttonText) {
            if (checkedCities.length === 0) {
                buttonText.textContent = '–ì–æ—Ä–æ–¥';
            } else if (checkedCities.length === 1) {
                buttonText.textContent = checkedCities[0];
            } else {
                buttonText.textContent = `${checkedCities.length} –≥–æ—Ä–æ–¥–æ–≤`;
            }
        }
        
        // ‚úÖ REMOVED: filterProperties() - only update UI, actual filtering happens via "–ù–∞–π—Ç–∏" button
    }, 100);
}

// Apply filters with proper function name
function applyFiltersFixed() {
    console.log('Applying filters...');
    filterProperties();
}

// Apply price filter
        if (priceTo) text += `–¥–æ ${priceTo}–º–ª–Ω`;
        buttonText.textContent = text.trim() + ' ‚ÇΩ';
    } else {
        buttonText.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
    }
    
    // Only update filter state and display active filters, don't trigger search
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="price"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Apply advanced filters from "–ï—â–µ" section
function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    const advancedFilters = {};
    
    // Area range
    const areaFrom = document.getElementById('areaFrom').value;
    const areaTo = document.getElementById('areaTo').value;
    if (areaFrom) advancedFilters.areaFrom = parseInt(areaFrom);
    if (areaTo) advancedFilters.areaTo = parseInt(areaTo);
    
    // Floor range
    const floorFrom = document.getElementById('floorFrom').value;
    const floorTo = document.getElementById('floorTo').value;
    if (floorFrom) advancedFilters.floorFrom = parseInt(floorFrom);
    if (floorTo) advancedFilters.floorTo = parseInt(floorTo);
    
    // Building type (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞)
    const buildingTypes = Array.from(document.querySelectorAll('input[data-filter-type="building_type"]:checked')).map(cb => cb.value);
    if (buildingTypes.length > 0) advancedFilters.buildingTypes = buildingTypes;
    
    // Building status (—Å—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û  
    const buildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
    if (buildingReleased.length > 0) advancedFilters.buildingReleased = buildingReleased;
    
    // Build year range (–¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–∞ —Å–¥–∞—á–∏)
    const buildYearFrom = document.getElementById('buildYearFrom')?.value;
    const buildYearTo = document.getElementById('buildYearTo')?.value;
    if (buildYearFrom || buildYearTo) {
        advancedFilters.buildYearRange = {
            from: buildYearFrom ? parseInt(buildYearFrom) : null,
            to: buildYearTo ? parseInt(buildYearTo) : null
        };
    }
    
    // Features (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
    const features = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
    if (features.length > 0) advancedFilters.features = features;
    
    // Object class (–∫–ª–∞—Å—Å –∂–∏–ª—å—è)
    const objectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_classes"]:checked')).map(cb => cb.value);
    if (objectClasses.length > 0) advancedFilters.objectClasses = objectClasses;
    
    // Update activeFilters with advanced filters
    Object.assign(activeFilters, advancedFilters);
    
    console.log('Advanced filters applied:', advancedFilters);
    
    // Update filters counter
    const totalFilters = Object.keys(advancedFilters).length;
    const counter = document.getElementById('allFiltersCounter');
    if (counter) {
        if (totalFilters > 0) {
            counter.textContent = totalFilters;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }
    
    // Apply filters
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="advanced"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Toggle advanced filters section
function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
        section.classList.toggle('hidden');
        console.log('Advanced filters toggled:', !section.classList.contains('hidden'));
    }
}

// Enhanced filter properties function with room filtering
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–∏—Å—Ç–µ–º–µ —Ä–∞–Ω–Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
window._realFilterPropertiesImpl = function() {
    // Prevent concurrent filtering operations
    if (window.isFiltering) return;
    window.isFiltering = true;
    
    try {
        if (!allProperties || allProperties.length === 0) {
            console.log('No properties to filter');
            return;
        }

        if (window.serverSidePagination && !window._isModalMapOpen()) {
            console.log('‚úÖ Server-side pagination active - skipping client-side filtering, displaying all', allProperties.length, 'server-rendered properties');
            filteredProperties = allProperties;
            window.filteredProperties = filteredProperties;
            updateResultsCount(filteredProperties.length);
            updatePropertiesList(filteredProperties);
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer && window.totalPages > 1) {
                updatePaginationControls(window.totalProperties, window.totalPages);
            }
            setTimeout(() => { initializeAllButtons(); }, 50);
            return;
        }
        
        // Get room filters
        const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        // Get price filters  
        const priceFromEl = document.getElementById('priceFrom');
        const priceToEl = document.getElementById('priceTo');
        const priceFrom = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
        const priceTo = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
        
        // Get completion date filters
        const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
        
        // Get ADVANCED filters from "–ï—â–µ" section
        const areaFromEl = document.getElementById('areaFrom');
        const areaToEl = document.getElementById('areaTo');
        const areaFrom = areaFromEl ? parseFloat(areaFromEl.value || 0) : 0;
        const areaTo = areaToEl ? parseFloat(areaToEl.value || 0) : 0;
        
        const floorFromEl = document.getElementById('floorFrom');
        const floorToEl = document.getElementById('floorTo');
        const floorFrom = floorFromEl ? parseInt(floorFromEl.value || 0) : 0;
        const floorTo = floorToEl ? parseInt(floorToEl.value || 0) : 0;
        
        // Building floors range (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è maxFloorFrom/maxFloorTo
        const maxFloorFromEl = document.getElementById('maxFloorFrom');
        const maxFloorToEl = document.getElementById('maxFloorTo');
        const maxFloorFrom = maxFloorFromEl ? parseInt(maxFloorFromEl.value || 0) : 0;
        const maxFloorTo = maxFloorToEl ? parseInt(maxFloorToEl.value || 0) : 0;
        
        // Building types - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è –≤–º–µ—Å—Ç–æ —á–µ–∫–±–æ–∫—Å–æ–≤ (—á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–µ—Ç –≤ HTML)
        const selectedBuildingTypes = []; // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ - —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á–µ–Ω
        const selectedBuildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
        const selectedRenovationTypes = Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value);
        const selectedObjectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_classes"]:checked')).map(cb => cb.value);
        const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value);
        const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value);
        
        // Get regional filters
        const selectedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        const selectedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        
        console.log('Filtering with:', {
            rooms: selectedRooms,
            priceFrom: priceFrom,
            priceTo: priceTo,
            completion: selectedCompletionDates,
            area: {from: areaFrom, to: areaTo},
            floor: {from: floorFrom, to: floorTo},
            buildingTypes: selectedBuildingTypes,
            buildingFloors: {from: maxFloorFrom, to: maxFloorTo},
            buildingReleased: selectedBuildingReleased,
            features: selectedFeatures,
            renovation: selectedRenovationTypes,
            objectClasses: selectedObjectClasses,
            developers: selectedDevelopers,
            districts: selectedDistricts,
            regions: selectedRegions,
            cities: selectedCities,
            complex: activeFilters.residential_complex || null,  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ñ–ö
            search: window.mapFilters?.search || ''  // ‚úÖ –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É/–ñ–ö/–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É
        });
        
        // Get search text from mapFilters
        const searchText = (window.mapFilters?.search || '').toLowerCase().trim();
        
        // Debug: Show filter details
        if (floorFrom > 0 || floorTo > 0) {
            console.log(`Floor filter active: from ${floorFrom} to ${floorTo}`);
        }
        if (selectedDevelopers.length > 0) {
            console.log(`Developer filter active:`, selectedDevelopers);
        }
        
        // Debug: show some sample property data
        if (allProperties.length > 0) {
            console.log('Sample property for debugging:', {
                price: allProperties[0].price,
                priceInMillions: allProperties[0].price / 1000000,
                completion_date: allProperties[0].completion_date,
                rooms: allProperties[0].rooms,
                developer_name: allProperties[0].developer_name,
                complex_object_class_display_name: allProperties[0].complex_object_class_display_name,
                renovation_display_name: allProperties[0].renovation_display_name,
                object_min_floor: allProperties[0].object_min_floor,
                object_max_floor: allProperties[0].object_max_floor,
                object_area: allProperties[0].object_area
            });
        }
        
        filteredProperties = allProperties.filter(property => {
            // Room filter (merge quick and advanced filters)
            const allSelectedRooms = [...selectedRooms];
            if (advancedFilters.roomTypes && advancedFilters.roomTypes.length > 0) {
                allSelectedRooms.push(...advancedFilters.roomTypes);
            }
            
            if (allSelectedRooms.length > 0) {
                const match = allSelectedRooms.some(room => {
                    // ‚úÖ Support numeric values from filter checkboxes
                    const roomNum = parseInt(room);
                    
                    // Check if it's a valid numeric value
                    if (!isNaN(roomNum)) {
                        if (roomNum === 4) {
                            return property.rooms >= 4;  // 4+ –∫–æ–º–Ω–∞—Ç–Ω–∞—è
                        }
                        return property.rooms === roomNum;
                    }
                    
                    // ‚úÖ FALLBACK: Support old text formats for backward compatibility
                    const normalizedRoom = room.toLowerCase();
                    
                    if (normalizedRoom === '—Å—Ç—É–¥–∏—è' || normalizedRoom === 'studio') {
                        return property.rooms === 0;  // –°—Ç—É–¥–∏—è = 0 –∫–æ–º–Ω–∞—Ç
                    }
                    if (normalizedRoom === '1-–∫–æ–º–Ω' || normalizedRoom === '1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '1 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 1;  // 1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '2-–∫–æ–º–Ω' || normalizedRoom === '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '2 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 2;  // 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '3-–∫–æ–º–Ω' || normalizedRoom === '3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '3 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 3;  // 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '4+-–∫–æ–º–Ω' || normalizedRoom === '4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '4 –∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom.includes('4+')) {
                        return property.rooms >= 4;   // 4+ –∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    return false;
                });
                if (!match) return false;
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: PRICE FILTER (—Ü–µ–Ω–∞) - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            if (priceFrom > 0 || priceTo > 0) {
                const priceInMillions = parseFloat(property.price) / 1000000;
                
                if (priceFrom > 0 && priceInMillions < priceFrom) {
                    return false;
                }
                if (priceTo > 0 && priceInMillions > priceTo) {
                    return false;
                }
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Completion date filter (—Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–¥–∞—á–∏)
            if (selectedCompletionDates.length > 0) {
                console.log(`Completion filter active:`, selectedCompletionDates);
                console.log(`Property completion_date: "${property.completion_date}"`);
                
                const match = selectedCompletionDates.some(date => {
                    // –°–¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                    if (date === '–°–¥–∞–Ω') {
                        return property.completion_date === '–°–¥–∞–Ω' || 
                               property.status === 'ready' || 
                               property.completion_date === '–ì–æ—Ç–æ–≤' ||
                               property.completion_date === '–°–¥–∞–Ω–æ';
                    }
                    
                    // –ì–æ–¥—ã —Å–¥–∞—á–∏ (2024, 2025, 2026, 2028)
                    if (date.match(/^\d{4}$/)) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ completion_date —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–æ–¥
                        const hasYear = property.completion_date && property.completion_date.includes(date);
                        console.log(`Year ${date} check: "${property.completion_date}" includes "${date}"? ${hasYear}`);
                        return hasYear;
                    }
                    
                    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    return property.completion_date === date;
                });
                
                if (!match) {
                    console.log(`‚ùå Completion date filter: no match for "${property.completion_date}"`);
                    return false;
                }
                console.log(`‚úÖ Completion date filter: match found!`);
            }
            
            // ADVANCED FILTERS from "–ï—â–µ" section
            
            // Area filter (–ø–ª–æ—â–∞–¥—å)
            if (areaFrom > 0 || areaTo > 0) {
                const area = parseFloat(property.area || 0);
                if (areaFrom > 0 && area < areaFrom) return false;
                if (areaTo > 0 && area > areaTo) return false;
            }
            
            // Floor filter (—ç—Ç–∞–∂) - —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂—É –ö–í–ê–†–¢–ò–†–´
            if (floorFrom > 0 || floorTo > 0) {
                const minFloor = parseInt(property.object_min_floor || property.floor || 0);
                const maxFloor = parseInt(property.object_max_floor || property.total_floors || minFloor);
                
                // –í–ê–ñ–ù–û: —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —ç—Ç–∞–∂—É –ö–í–ê–†–¢–ò–†–´, –Ω–µ –∑–¥–∞–Ω–∏—è
                // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–¥–æ 3 —ç—Ç–∞–∂–∞" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞ 1-3 —ç—Ç–∞–∂–∞—Ö
                if (floorFrom > 0 && minFloor < floorFrom) return false;
                if (floorTo > 0 && minFloor > floorTo) return false;
            }
            
            // Building floors filter (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ç–∞–∂–Ω–æ—Å—Ç–∏ –∑–¥–∞–Ω–∏—è
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingMaxFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingMaxFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingMaxFloors > maxFloorTo) return false;
            }
            
            // Building floors filter (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingFloors > maxFloorTo) return false;
            }
            
            // Building status filter (—Å—Ç–∞—Ç—É—Å —Å–¥–∞–Ω–Ω–æ—Å—Ç–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
            if (selectedBuildingReleased.length > 0) {
                const match = selectedBuildingReleased.some(status => {
                    const buildingReleased = property.complex_building_released; // –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
                    
                    if (status === 'true') {
                        // –°–¥–∞–Ω–Ω—ã–π –¥–æ–º - –ø—Ä–æ–≤–µ—Ä—è–µ–º complex_building_released = True
                        return buildingReleased === true || buildingReleased === 'True' || buildingReleased === 'true';
                    }
                    
                    if (status === 'false') {
                        // –í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º complex_building_released = False
                        return buildingReleased === false || buildingReleased === 'False' || buildingReleased === 'false';
                    }
                    
                    return false;
                });
                if (!match) return false;
            }
            
            // Build year range filter (–¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–∞ —Å–¥–∞—á–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
            const buildYearFrom = document.getElementById('buildYearFrom')?.value;
            const buildYearTo = document.getElementById('buildYearTo')?.value;
            if (buildYearFrom || buildYearTo) {
                const buildingYear = parseInt(property.complex_building_end_build_year || 0); // –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
                
                if (buildYearFrom && buildingYear < parseInt(buildYearFrom)) return false;
                if (buildYearTo && buildingYear > parseInt(buildYearTo)) return false;
            }
            
            // Developer filter (–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ –∏–∑ Excel
            if (selectedDevelopers.length > 0) {
                const match = selectedDevelopers.some(developer => {
                    return property.developer_name === developer || 
                           property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Complex filter (–∂–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å) - –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ complex=
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω –ò –Ω–µ null/–Ω–µ –ø—É—Å—Ç–æ–π
            if (activeFilters.residential_complex && activeFilters.residential_complex !== null && activeFilters.residential_complex !== '' && activeFilters.residential_complex !== 'null') {
                const complexName = activeFilters.residential_complex;
                
                // Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏—â–µ–º –∏ —á—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
                console.log(`üè† Complex filter: looking for "${complexName}"`);
                console.log(`üîç Property complex_name: "${property.complex_name}"`);
                
                // –ë–æ–ª–µ–µ –≥–∏–±–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ - —É—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                const match = property.complex_name === complexName || 
                             property.residential_complex === complexName ||
                             property.complex === complexName ||
                             // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–≤—ã—á–µ–∫
                             (property.complex_name && property.complex_name.includes(complexName.replace(/"/g, ''))) ||
                             (complexName.includes(property.complex_name));
                             
                if (!match) {
                    console.log(`‚ùå Complex filter: "${complexName}" not found in "${property.complex_name}"`);
                    return false;
                }
                console.log(`‚úÖ Complex filter: match found!`);
            } else if (activeFilters.residential_complex === null || activeFilters.residential_complex === 'null') {
                // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä —Å–±—Ä–æ—à–µ–Ω
                console.log('üîÑ Complex filter is NULL/cleared - showing all properties');
            }
            
            // District filter (—Ä–∞–π–æ–Ω)
            if (selectedDistricts.length > 0) {
                const match = selectedDistricts.some(district => {
                    return property.district === district || 
                           property.address_locality_name === district;
                });
                if (!match) return false;
            }
            
            // Region filter (—Ä–µ–≥–∏–æ–Ω)
            if (selectedRegions.length > 0) {
                const match = selectedRegions.some(region => {
                    return property.parsed_region === region || 
                           property.region_name === region || 
                           property.region === region;
                });
                if (!match) return false;
            }
            
            // City filter (–≥–æ—Ä–æ–¥) - –∏—â–µ–º –≤ –ø–æ–ª–Ω–æ–º –∞–¥—Ä–µ—Å–µ
            if (selectedCities.length > 0) {
                const match = selectedCities.some(city => {
                    const fullAddress = (property.address || property.address_display_name || '').toLowerCase();
                    return fullAddress.includes(city.toLowerCase());
                });
                if (!match) return false;
            }
            
            // Features filter (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
            if (selectedFeatures.length > 0) {
                // –°–ª–æ–≤–∞—Ä—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∏ —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π
                const featureMapping = {
                    'accreditation': '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è',
                    'green_mortgage': '–ó–µ–ª–µ–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞',
                    'ready': '–°–¥–∞–Ω',
                    'under_construction': '–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ',
                    'no_finish': '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏',
                    'with_finish': '–° –æ—Ç–¥–µ–ª–∫–æ–π'
                };
                
                const match = selectedFeatures.some(feature => {
                    const russianFeature = featureMapping[feature] || feature;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–ª—è —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏
                    return (property.features && property.features.includes(russianFeature)) ||
                           (property.amenities && property.amenities.includes(russianFeature)) ||
                           (property.description && property.description.includes(russianFeature)) ||
                           // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∑–µ–ª–µ–Ω–æ–π –∏–ø–æ—Ç–µ–∫–∏
                           (feature === 'green_mortgage' && (property.has_green_mortgage || property.green_mortgage)) ||
                           // –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏
                           (feature === 'accreditation' && property.building_accreditation);
                });
                if (!match) return false;
            }
            
            // Renovation filter (–æ—Ç–¥–µ–ª–∫–∞)
            if (selectedRenovationTypes.length > 0) {
                const match = selectedRenovationTypes.some(renovationType => {
                    const propertyRenovation = property.renovation_display_name || property.renovation_type || property.renovation || '';
                    return propertyRenovation.toLowerCase().includes(renovationType.toLowerCase()) ||
                           propertyRenovation === renovationType;
                });
                if (!match) return false;
            }
            
            // Object class filter (–∫–ª–∞—Å—Å –∂–∏–ª—å—è)
            if (selectedObjectClasses.length > 0) {
                console.log('Object class filter active with:', selectedObjectClasses);
                const propertyClass = property.complex_object_class_display_name || property.object_class || property.property_class || property.class || '';
                console.log(`Property class field: "${propertyClass}" (property id: ${property.id})`);
                
                const match = selectedObjectClasses.some(objClass => {
                    const matches = propertyClass.toLowerCase().includes(objClass.toLowerCase()) || 
                                  propertyClass === objClass ||
                                  property.object_class === objClass || 
                                  property.property_class === objClass ||
                                  property.class === objClass;
                    return matches;
                });
                
                if (match) {
                    console.log(`‚úÖ Object class MATCH for property ${property.id}: "${propertyClass}"`);
                } else {
                    console.log(`‚ùå Object class NO MATCH for property ${property.id}: "${propertyClass}" vs [${selectedObjectClasses.join(', ')}]`);
                }
                
                if (!match) return false;
            }
            
            // Advanced filters integration
            // District filter (from advanced filters)
            if (advancedFilters.districts && advancedFilters.districts.length > 0) {
                const match = advancedFilters.districts.some(district => {
                    return property.district === district;
                });
                if (!match) return false;
            }
            
            // Developer filter (from advanced filters)
            if (advancedFilters.developers && advancedFilters.developers.length > 0) {
                const match = advancedFilters.developers.some(developer => {
                    return property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Property type filter (from advanced filters)
            if (advancedFilters.propertyTypes && advancedFilters.propertyTypes.length > 0) {
                const match = advancedFilters.propertyTypes.some(type => {
                    return property.type === type || property.property_type === type;
                });
                if (!match) return false;
            }
            
            // Area filter (from advanced filters)
            if (advancedFilters.areas && advancedFilters.areas.length > 0) {
                const match = advancedFilters.areas.some(areaRange => {
                    const area = parseFloat(property.area);
                    if (areaRange === '30-50') return area >= 30 && area <= 50;
                    if (areaRange === '50-70') return area >= 50 && area <= 70;
                    if (areaRange === '70-100') return area >= 70 && area <= 100;
                    if (areaRange === '100+') return area > 100;
                    return false;
                });
                if (!match) return false;
            }
            
            // Area range filter (from advanced filters)
            if (advancedFilters.areaFrom > 0 || advancedFilters.areaTo > 0) {
                const area = parseFloat(property.area);
                if (advancedFilters.areaFrom > 0 && area < advancedFilters.areaFrom) return false;
                if (advancedFilters.areaTo > 0 && area > advancedFilters.areaTo) return false;
            }
            
            // Distance filter (from advanced filters)
            if (advancedFilters.distances && advancedFilters.distances.length > 0) {
                const match = advancedFilters.distances.some(distanceRange => {
                    // Mock distance calculation - in real app would be calculated from coordinates
                    const mockDistance = Math.random() * 20; // 0-20 km
                    if (distanceRange === '0-5') return mockDistance <= 5;
                    if (distanceRange === '5-10') return mockDistance > 5 && mockDistance <= 10;
                    if (distanceRange === '10-15') return mockDistance > 10 && mockDistance <= 15;
                    if (distanceRange === '15+') return mockDistance > 15;
                    return false;
                });
                if (!match) return false;
            }
            
            // Payment methods filter (from advanced filters)
            if (advancedFilters.payments && advancedFilters.payments.length > 0) {
                // Mock payment methods - in real app would check property payment options
                const match = advancedFilters.payments.some(payment => {
                    return true; // All properties support all payment methods for now
                });
                if (!match) return false;
            }
            
            // Direction filter (from advanced filters)
            if (advancedFilters.directions && advancedFilters.directions.length > 0) {
                // Mock direction - in real app would check property orientation
                const directions = ['—Å–µ–≤–µ—Ä', '—é–≥', '–≤–æ—Å—Ç–æ–∫', '–∑–∞–ø–∞–¥', '—é–≥–æ-–≤–æ—Å—Ç–æ–∫', '—é–≥–æ-–∑–∞–ø–∞–¥', '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫', '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥'];
                const propertyDirection = directions[property.id % directions.length];
                const match = advancedFilters.directions.includes(propertyDirection);
                if (!match) return false;
            }
            
            // Search filter (by address, complex name, developer name)
            if (searchText) {
                const address = (property.address || '').toLowerCase();
                const complexName = (property.complex_name || property.residential_complex || '').toLowerCase();
                const developerName = (property.developer_name || '').toLowerCase();
                const district = (property.district || '').toLowerCase();
                
                const matchSearch = address.includes(searchText) || 
                                   complexName.includes(searchText) || 
                                   developerName.includes(searchText) ||
                                   district.includes(searchText);
                if (!matchSearch) return false;
            }
            
            return true;
        });
        
        console.log(`üéØ FILTERING RESULT: ${filteredProperties.length} properties from ${allProperties.length} total`);
        
        // Store globally for other functions
        window.filteredProperties = filteredProperties;
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –°–†–ê–ó–£ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        console.log(`üîÑ Calling updateResultsCount with: ${filteredProperties.length}`);
        updateResultsCount(filteredProperties.length);
        
        // ‚úÖ –ù–ï –í–´–ó–´–í–ê–ï–ú updatePropertiesList –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∏–∂–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        currentPage = 1; // Reset to first page when filtering
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–∞–≥–∏–Ω–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const totalPages = Math.ceil(filteredProperties.length / window.itemsPerPage);
        
        // –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const endIndex = startIndex + window.itemsPerPage;
        const pageProperties = filteredProperties.slice(startIndex, endIndex);
        
        console.log(`üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages}, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ${pageProperties.length} –æ–±—ä–µ–∫—Ç–æ–≤ (${startIndex+1}-${Math.min(endIndex, filteredProperties.length)} –∏–∑ ${filteredProperties.length})`);
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ù–ï –≤—Å–µ filtered
        updatePropertiesList(pageProperties);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (totalPages > 1) {
            updatePaginationControls(filteredProperties.length, totalPages);
        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer) paginationContainer.innerHTML = '';
        }
        
        // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: Update active filters display
        displayActiveFilters();
        
        // Initialize buttons after filtering
        setTimeout(() => {
            initializeAllButtons();
            console.log('Buttons reinitialized after filtering');
        }, 50);
        
        // Update fullscreen map markers if map is open
        if (window.fullscreenMapContainer && window.fullscreenMapContainer.__map) {
            updateFullscreenMapMarkers();
        }
        
    } finally {
        window.isFiltering = false;
    }
};

// ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ filterProperties
window._realFilterProperties = window._realFilterPropertiesImpl;
console.log('‚úÖ Real filterProperties registered');

// ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–û: Update results counter - –ù–ê–•–û–î–ò–ú –õ–Æ–ë–û–ô H3 —Å "–ù–∞–π–¥–µ–Ω–æ"
function updateResultsCount(count) {
    // ‚úÖ SERVER-SIDE MODE: Use server's total count
    if (window.serverSidePagination && window.totalProperties !== undefined) {
        count = window.totalProperties;
        console.log(`üåê Using server-side count: ${count}`);
    } else {
        console.log(`üîÑ updateResultsCount called with count: ${count}`);
    }
    
    // üî• –ù–û–í–û–ï: –¢—Ä–µ–∫–∞–µ–º –ø–æ–∏—Å–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    if (window.currentSearchQuery) {
        console.log(`üìä Tracking search: "${window.currentSearchQuery}" with ${count} results`);
        saveToSearchHistory(window.currentSearchQuery, count);
        // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        window.currentSearchQuery = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "–æ–±—ä–µ–∫—Ç"  
    function getObjectWord(count) {
        if (count % 100 >= 11 && count % 100 <= 14) return "–æ–±—ä–µ–∫—Ç–æ–≤";
        switch (count % 10) {
            case 1: return "–æ–±—ä–µ–∫—Ç";
            case 2: case 3: case 4: return "–æ–±—ä–µ–∫—Ç–∞";
            default: return "–æ–±—ä–µ–∫—Ç–æ–≤";
        }
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 1: –ò—â–µ–º –ª—é–±–æ–π H3 –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç "–ù–∞–π–¥–µ–Ω–æ"
    const h3Elements = document.querySelectorAll('h3');
    let targetH3 = null;
    
    for (let h3 of h3Elements) {
        if (h3.textContent && h3.textContent.includes('–ù–∞–π–¥–µ–Ω–æ')) {
            targetH3 = h3;
            break;
        }
    }
    
    if (targetH3) {
        // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ H3
        targetH3.innerHTML = `–ù–∞–π–¥–µ–Ω–æ <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω H3 —Å "–ù–∞–π–¥–µ–Ω–æ": ${count} ${getObjectWord(count)}`);
        return;
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 2: –ï—Å–ª–∏ H3 –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º span results-count
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
        resultsCount.textContent = count;
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω span results-count: ${count}`);
        return;
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 3: –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
    console.error(`‚ùå –ù–ï –ù–ê–ô–î–ï–ù —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞! –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...`);
    
    // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const resultsSection = document.querySelector('.bg-white.rounded-xl.shadow-sm.border.border-gray-200.p-4');
    if (resultsSection) {
        const newH3 = document.createElement('h3');
        newH3.className = 'text-xl font-bold text-gray-900';
        newH3.innerHTML = `–ù–∞–π–¥–µ–Ω–æ <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        resultsSection.insertBefore(newH3, resultsSection.firstChild);
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π H3: ${count} ${getObjectWord(count)}`);
        return;
    }
    
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞!');
}

// –û–¢–ö–õ–Æ–ß–ï–ù–û: JavaScript –ø–∞–≥–∏–Ω–∞—Ü–∏—è (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è)
function updatePaginationControls(totalItems, totalPages) {
    // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è - JavaScript –ø–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è
    console.log('‚ö†Ô∏è JavaScript pagination disabled - using server-side pagination');
    return;
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Go to specific page - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
function goToPage(page) {
    const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
    const totalPages = Math.ceil(dataToUse.length / window.itemsPerPage);
    
    if (page < 1 || page > totalPages) {
        console.log(`‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: ${page}, –¥–æ—Å—Ç—É–ø–Ω–æ: 1-${totalPages}`);
        return;
    }
    
    console.log(`üìÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É ${page} –∏–∑ ${totalPages}`);
    
    currentPage = page;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const endIndex = startIndex + window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, endIndex);
    
    console.log(`üìÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã ${startIndex+1}-${Math.min(endIndex, dataToUse.length)} –∏–∑ ${dataToUse.length}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePropertiesList(pageProperties);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePaginationControls(dataToUse.length, totalPages);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
    const propertiesContainer = document.getElementById('properties-container');
    if (propertiesContainer) {
        propertiesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Advanced Filters Functions
// advancedFilters already declared above

function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Update the quick filters to match advanced filters
    if (advancedFilters.districts.length > 0) {
        // Update district dropdown if exists
        const districtSelect = document.querySelector('select[name="district"]');
        if (districtSelect) {
            districtSelect.value = advancedFilters.districts[0];
        }
    }
    
    // Apply the unified filter logic
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
    
    // Hide advanced filters panel
    toggleAdvancedFilters();
}

function clearAllAdvancedFilters() {
    console.log('Clearing all advanced filters...');
    
    // Clear all checkboxes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Clear main filter checkboxes too
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update results display
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
}

function updateAdvancedFiltersResultsCount() {
    const resultCountElement = document.getElementById('advancedResultsCount');
    if (resultCountElement) {
        const count = filteredProperties.length || allProperties.length;
        resultCountElement.textContent = `${count} –∫–≤–∞—Ä—Ç–∏—Ä –Ω–∞–π–¥–µ–Ω–æ`;
    }
}

// Save current filters function
function saveCurrentFilters() {
    console.log('Saving current filters state...');
    toggleAdvancedFilters(); // Just close the panel for now
}

// Initialize advanced filters dropdowns
function initializeAdvancedFilters() {
    // Handle dropdown toggle for advanced filters
    document.querySelectorAll('#advancedFiltersSection .filter-option-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.closest('.filter-dropdown');
            if (!dropdown) return;
            
            const menu = dropdown.querySelector('.dropdown-menu');
            if (!menu) return;
            
            // Close other dropdowns
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('hidden');
            console.log('Advanced dropdown toggled');
        });
    });
    
    // Handle checkbox changes in advanced filters - AJAX MODE
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('‚úÖ Advanced filter checkbox changed (AJAX MODE):', this.value, this.checked);
            
            // ‚úÖ –ù–û–í–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º AJAX —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π
            if (typeof window.unusedAF === 'function') {
                window.applyFilters();
            } else {
                console.warn('‚ö†Ô∏è window.applyFilters not available yet, using fallback');
            }
            
            // Update active filters display
            if (typeof window.displayActiveFilters === 'function') {
                window.displayActiveFilters();
            }
            
            // Real-time update of filter count
            updateAdvancedFiltersResultsCount();
            
            // Initialize buttons after filtering
            setTimeout(() => {
                initializeAllButtons();
                console.log('Buttons reinitialized after advanced filtering');
            }, 50);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#advancedFiltersSection .filter-dropdown')) {
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// Display active filters

// Remove individual filter
function removeFilter(type, value) {
    if (type === 'rooms') {
        const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRoomFilterChange();
    } else if (type === 'price') {
        document.getElementById('priceFrom').value = '';
        document.getElementById('priceTo').value = '';
        document.getElementById('priceFilterText').textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
    } else if (type === 'completion') {
        const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'distance') {
        const checkbox = document.querySelector(`input[data-filter="distance"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'area') {
        const checkbox = document.querySelector(`input[data-filter="area"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'areaRange') {
        const areaFrom = document.getElementById('areaFrom');
        const areaTo = document.getElementById('areaTo');
        if (areaFrom) areaFrom.value = '';
        if (areaTo) areaTo.value = '';
    } else if (type === 'direction') {
        const checkbox = document.querySelector(`input[data-filter="direction"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'payment') {
        const checkbox = document.querySelector(`input[data-filter="payment"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'district') {
        const checkbox = document.querySelector(`input[data-filter="district"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'developer') {
        const checkbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType') {
        const checkbox = document.querySelector(`input[data-filter="propertyType"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'advancedRooms') {
        const checkbox = document.querySelector(`#advancedFiltersSection input[data-filter="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType2') {
        const checkbox = document.querySelector(`input[data-filter="property_type"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'salesStart') {
        const checkbox = document.querySelector(`input[data-filter="sales_start"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'parking') {
        const checkbox = document.querySelector(`input[data-filter="parking"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'elevator') {
        const checkbox = document.querySelector(`input[data-filter="elevator"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'registration') {
        const checkbox = document.querySelector(`input[data-filter="registration"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'nearbyPlaces') {
        const checkbox = document.querySelector(`input[data-filter="nearby_places"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'windowView') {
        const checkbox = document.querySelector(`input[data-filter="window_view"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'specialApartments') {
        const checkbox = document.querySelector(`input[data-filter="special_apartments"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'dropdownDeveloper') {
        const dropdown = document.getElementById('developer-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'dropdownDistrict') {
        const dropdown = document.getElementById('district-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'worldSides') {
        const checkbox = document.querySelector(`input[data-filter="world_sides"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'region') {
        const checkbox = document.querySelector(`input[data-filter-type="region"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRegionFilterChange();
    } else if (type === 'city') {
        const checkbox = document.querySelector(`input[data-filter-type="city"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleCityFilterChange();
    }
    
    // Update advanced filters object (excluding duplicates from quick filters)
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    
    // New advanced filters - add to activeFilters too
    advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Update activeFilters with all new advanced filters
    activeFilters.propertyClass = advancedFilters.propertyClass;
    activeFilters.wallMaterial = advancedFilters.wallMaterial;
    activeFilters.floorsTotal = advancedFilters.floorsTotal;
    activeFilters.propertyType = advancedFilters.propertyType;
    activeFilters.salesStart = advancedFilters.salesStart;
    activeFilters.parking = advancedFilters.parking;
    activeFilters.elevator = advancedFilters.elevator;
    activeFilters.registration = advancedFilters.registration;
    activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
    activeFilters.windowView = advancedFilters.windowView;
    activeFilters.specialApartments = advancedFilters.specialApartments;
    activeFilters.worldSides = advancedFilters.worldSides;
    advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Update area range
    const areaFromValue = document.getElementById('areaFrom')?.value;
    const areaToValue = document.getElementById('areaTo')?.value;
    advancedFilters.areaFrom = parseFloat(areaFromValue) || 0;
    advancedFilters.areaTo = parseFloat(areaToValue) || 0;
    
    filterProperties();
    displayActiveFilters();
}

// View switching functions
function switchToListView() {
    document.getElementById('listViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('gridViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'space-y-6';
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToGridView() {
    document.getElementById('gridViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('listViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToMapView() {
    alert('–ö–∞—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// Open map display and initialize desktop map
function openMapDisplay() {
    console.log('üó∫Ô∏è openMapDisplay() called');
    
    const modal = document.getElementById('fullscreenMapModal');
    if (!modal) {
        console.warn('‚ö†Ô∏è fullscreenMapModal not found');
        return;
    }
    
    // Show modal
    modal.classList.remove('hidden');
    
    const isMobile = window.innerWidth < 1024;
    
    setTimeout(() => {
        if (isMobile) {
            // Initialize mobile map
            const mobileContainer = document.getElementById('fullscreenMapContainer');
            if (mobileContainer && !mobileContainer.__map && window.ymaps) {
                console.log('üó∫Ô∏è Initializing mobile fullscreen map...');
                ymaps.ready(() => {
                    mobileContainer.innerHTML = '';
                    const mapEl = document.createElement('div');
                    mapEl.style.width = '100%';
                    mapEl.style.height = '100%';
                    mobileContainer.appendChild(mapEl);
                    
                    // Add back the list button
                    const listBtn = document.createElement('button');
                    listBtn.onclick = closeFullscreenMap;
                    listBtn.className = 'absolute bottom-6 left-4 z-[10] px-5 py-3 bg-white text-gray-900 rounded-xl shadow-lg text-sm font-semibold hover:bg-gray-50 transition-all flex items-center gap-2 border border-gray-200';
                    listBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg> –°–ø–∏—Å–æ–∫';
                    mobileContainer.appendChild(listBtn);
                    
                    const map = new ymaps.Map(mapEl, {
                        center: [43.5855, 39.7231],
                        zoom: 12,
                        controls: ['zoomControl']
                    });
                    mobileContainer.__map = map;
                    window.fullscreenMapContainer = mobileContainer;
                    updateFullscreenMapMarkers();
                });
            } else if (mobileContainer && mobileContainer.__map) {
                console.log('‚úÖ Mobile map already initialized, updating markers');
                updateFullscreenMapMarkers();
            }
        } else {
            // Desktop map
            if (!document.getElementById('fullscreenMapContainerDesktop')?.__map) {
                console.log('üó∫Ô∏è Map not initialized, calling initializeDesktopMap()');
                initializeDesktopMap();
            } else {
                console.log('‚úÖ Map already initialized, just showing');
            }
            loadDesktopMapProperties();
        }
    }, 100);
}

// Alias for backward compatibility
window.openFullscreenMap = function() {
    return openMapDisplay();
};

// Load properties into desktop map left panel
function loadDesktopMapProperties() {
    const container = document.getElementById('mapDesktopPropertiesContainer');
    if (!container) {
        console.warn('‚ö†Ô∏è mapDesktopPropertiesContainer not found');
        return;
    }
    
    const propertiesToShow = window.filteredProperties && window.filteredProperties.length > 0
        ? window.filteredProperties
        : window.allProperties || [];
    
    console.log('üìã Loading', propertiesToShow.length, 'properties into desktop map');
    
    // Clear container
    container.innerHTML = '';
    
    // Display properties in single column with full details
    const gridHTML = propertiesToShow.map((prop, idx) => {
        const priceFormatted = prop.price ? prop.price.toLocaleString('ru-RU') : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
        const rooms = prop.rooms === 0 ? '–°—Ç—É–¥–∏—è' : prop.rooms + '-–∫–æ–º–Ω';
        const image = (prop.gallery_images && prop.gallery_images[0]) || prop.image || 'https://images.unsplash.com/photo-1560448204-603b3fc33ddc?w=400';
        const developer = prop.developer_name || prop.developer || '';
        const complex = prop.complex_name || prop.residential_complex || '–ñ–ö';
        
        return `
            <div data-property-id="${prop.id}" class="bg-white rounded-lg shadow-sm hover:shadow-md transition-all border border-gray-100 cursor-pointer overflow-hidden" onclick="window.location.href='/object/${prop.id}'">
                <img src="${image}" alt="${rooms}" class="w-full h-32 object-cover" onerror="this.src='https://images.unsplash.com/photo-1560448204-603b3fc33ddc?w=400'">
                <div class="p-3">
                    <div class="text-lg font-bold text-blue-600 mb-1">${priceFormatted} ‚ÇΩ</div>
                    <div class="text-sm text-gray-900">${rooms}, ${prop.area || 0} –º¬≤</div>
                    <div class="text-sm text-gray-700 mt-1">${complex}</div>
                    ${developer ? `<div class="text-xs text-gray-500 mt-1">${developer}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="grid grid-cols-1 gap-3">${gridHTML}</div>`;
    
    console.log('‚úÖ Loaded properties into left panel');
    
    // Add hover sync for new properties - use setTimeout to ensure DOM is updated
    setTimeout(() => {
        console.log('‚è≥ Adding hover sync after DOM update...');
        addDesktopMapHoverSync();
    }, 50);
}

function closeMapDisplay() {
    const modal = document.getElementById('fullscreenMapModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function initializeDesktopMap() {
    const container = document.getElementById('fullscreenMapContainerDesktop');
    if (!container || !window.ymaps) {
        console.log('‚ö†Ô∏è Map container or ymaps not available');
        return;
    }
    
    console.log('üó∫Ô∏è Initializing desktop fullscreen map...');
    
    ymaps.ready(() => {
        // Clear container
        container.innerHTML = '';
        
        // Re-add legend HTML
        const legendHTML = `
            <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10 text-xs">
                <div class="font-semibold text-gray-900 mb-2">–°—Ç–∞—Ç—É—Å:</div>
                <div class="space-y-1 text-gray-700">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: #10B981;"></div>
                        <span>–°–¥–∞–Ω</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: #F59E0B;"></div>
                        <span>–°—Ç—Ä–æ–∏—Ç—Å—è</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: #EF4444;"></div>
                        <span>–°—Ç–∞—Ä—Ç –ø—Ä–æ–¥–∞–∂</span>
                    </div>
                </div>
            </div>
        `;
        
        // Create wrapper for map content
        const mapWrapper = document.createElement('div');
        mapWrapper.style.position = 'relative';
        mapWrapper.style.width = '100%';
        mapWrapper.style.height = '100%';
        mapWrapper.innerHTML = legendHTML;
        container.appendChild(mapWrapper);
        
        // Create actual map element
        const mapElement = document.createElement('div');
        mapElement.style.width = '100%';
        mapElement.style.height = '100%';
        mapWrapper.insertBefore(mapElement, mapWrapper.firstChild);
        
        // Initialize map
        const map = new ymaps.Map(mapElement, {
            center: [43.5855, 39.7231],  // –°–æ—á–∏
            zoom: 12,
            controls: ['zoomControl', 'fullscreenControl']
        });
        
        // Store map reference
        container.__map = map;
        
        // Load and display properties
        updateMapWithFilters();
    });
}

window.updateMapWithFilters = function() {
    const container = document.getElementById('fullscreenMapContainerDesktop');
    if (!container || !container.__map) {
        console.log('‚ö†Ô∏è Map not ready');
        return;
    }
    
    const map = container.__map;
    map.geoObjects.removeAll();
    
    // Get properties to show
    const propertiesToShow = window.filteredProperties && window.filteredProperties.length > 0
        ? window.filteredProperties
        : window.allProperties || [];
    
    console.log('üó∫Ô∏è Updating desktop map with', propertiesToShow.length, 'properties');
    
    if (propertiesToShow.length === 0) {
        console.log('‚ö†Ô∏è No properties to display');
        return;
    }
    
    // Group by coordinates
    const grouped = {};
    propertiesToShow.forEach(prop => {
        let coordKey = 'default';
        if (prop.latitude && prop.longitude) {
            coordKey = `${prop.latitude.toFixed(4)}_${prop.longitude.toFixed(4)}`;
        }
        if (!grouped[coordKey]) {
            grouped[coordKey] = { properties: [], lat: prop.latitude, lng: prop.longitude };
        }
        grouped[coordKey].properties.push(prop);
    });
    
    // Create markers
    const allBounds = [];
    Object.values(grouped).forEach(group => {
        if (!group.lat || !group.lng) return;
        
        try {
            const count = group.properties.length;
            const minPrice = Math.min(...group.properties.map(p => p.price || Infinity).filter(p => p !== Infinity));
            const priceText = minPrice !== Infinity ? Math.round(minPrice / 1000000 * 10) / 10 + '–ú' : '?';
            
            let preset = 'islands#blueDotIcon';
            // Color based on status
            if (group.properties[0].completion_date === '–°–¥–∞–Ω') {
                preset = 'islands#greenDotIcon';
            } else if (group.properties[0].completion_date === '–°—Ç–∞—Ä—Ç –ø—Ä–æ–¥–∞–∂') {
                preset = 'islands#orangeDotIcon';
            }
            
            const placemark = new ymaps.Placemark(
                [group.lat, group.lng],
                { balloonContent: `${count} –æ–±—ä–µ–∫—Ç–æ–≤ –æ—Ç ${priceText}‚ÇΩ` },
                { preset: preset }
            );
            
            // Store properties for hover sync
            placemark._properties = group.properties;
            placemark._originalPreset = preset;
            
            map.geoObjects.add(placemark);
            allBounds.push([group.lat, group.lng]);
        } catch (e) {
            console.warn('Error adding marker:', e);
        }
    });
    
    // Center map on markers
    if (allBounds.length > 0) {
        try {
            map.setBounds(allBounds, { checkZoomRange: true, zoomMargin: 40 });
        } catch (e) {
            console.warn('Error setting bounds:', e);
        }
    }
    
    console.log('‚úÖ Desktop map updated with', Object.keys(grouped).length, 'markers');
    
    // Add hover sync for desktop map
    addDesktopMapHoverSync();
};

// Hover sync for desktop map
window.addDesktopMapHoverSync = function() {
    const container = document.getElementById('fullscreenMapContainerDesktop');
    if (!container || !container.__map) {
        console.warn('‚ö†Ô∏è Desktop map container or map not found');
        return;
    }
    
    const map = container.__map;
    const cards = document.querySelectorAll('#mapDesktopPropertiesContainer [data-property-id]');
    
    console.log('üéØ addDesktopMapHoverSync: Found', cards.length, 'cards to sync');
    
    if (cards.length === 0) {
        console.log('‚ö†Ô∏è No property cards found for desktop map hover sync');
        return;
    }
    
    cards.forEach(card => {
        // –£–î–ê–õ–Ø–ï–ú –°–¢–ê–†–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
        
        const propId = parseInt(newCard.dataset.propertyId);
        console.log('üéØ Attaching hover handlers to card ID:', propId);
        
        newCard.addEventListener('mouseenter', function() {
            console.log('üéØ Mouse enter card:', propId);
            
            // –ò—â–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä
            let found = false;
            map.geoObjects.each(placemark => {
                if (placemark._properties && Array.isArray(placemark._properties)) {
                    const match = placemark._properties.find(p => p && p.id === propId);
                    if (match) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                        placemark.options.set('preset', 'islands#redDotIcon');
                        placemark.options.set('zIndex', 1000);
                        console.log('‚úÖ Highlighted marker for property', propId);
                        found = true;
                    }
                }
            });
            
            if (!found) {
                console.warn('‚ùå Marker not found for property', propId);
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            newCard.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
        });
        
        newCard.addEventListener('mouseleave', function() {
            console.log('üéØ Mouse leave card:', propId);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            map.geoObjects.each(placemark => {
                if (placemark._originalPreset) {
                    placemark.options.set('preset', placemark._originalPreset);
                    placemark.options.set('zIndex', 500);
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–æ—á–∫–∏
            newCard.classList.remove('ring-2', 'ring-red-500', 'bg-red-50');
        });
    });
    
    console.log('‚úÖ Desktop map hover sync enabled for', cards.length, 'cards');
};

// ‚úÖ –£–î–ê–õ–ï–ù–ê: –í—Ç–æ—Ä–∞—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—ã–∑—ã–≤–∞–µ–º –º–æ—é –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    initializeClearAllButton();
    initializeAdvancedFilters();
    initializeDropdownFilters();
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ carousel
    if (typeof window.initializeImageCarousels === 'function') {
        window.initializeImageCarousels();
    }
    
    // Add event listeners for main filter dropdowns to show active filters
    const developerFilter = document.getElementById('developer-filter');
    if (developerFilter) {
        developerFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    const districtFilter = document.getElementById('district-filter');
    if (districtFilter) {
        districtFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    // Initialize NEW filter dropdowns (registration, nearby places, etc.)
    const filterDropdowns = document.querySelectorAll('.filter-dropdown');
    console.log('Found filter dropdowns:', filterDropdowns.length, filterDropdowns);
    filterDropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close other filter dropdowns
                filterDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                        const otherArrow = otherDropdown.querySelector('.dropdown-arrow');
                        if (otherMenu) {
                            otherMenu.classList.remove('open');
                            otherMenu.classList.add('hidden');
                        }
                        if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Toggle current dropdown
                const isOpen = menu.classList.contains('open');
                if (isOpen) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.classList.add('open');
                    menu.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
                
                console.log('Filter dropdown toggled:', dropdown);
                
                // Show dropdown options when opened  
                if (!isOpen) {
                    console.log('Dropdown opened');
                    // Determine filter type from existing checkboxes or button text
                    let filterType = menu.querySelector('input[data-filter]')?.getAttribute('data-filter');
                    
                    if (!filterType) {
                        // If no existing checkboxes, determine from button text
                        const buttonText = btn.textContent.trim();
                        if (buttonText.includes('–ü—Ä–æ–ø–∏—Å–∫–∞')) filterType = 'registration';
                        else if (buttonText.includes('–ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º')) filterType = 'nearby_places';
                        else if (buttonText.includes('–í–∏–¥ –∏–∑ –æ–∫–æ–Ω')) filterType = 'window_view';
                        else if (buttonText.includes('–í–∏–¥–æ–≤—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã')) filterType = 'special_apartments';
                        else if (buttonText.includes('–°—Ç–æ—Ä–æ–Ω—ã —Å–≤–µ—Ç–∞')) filterType = 'world_sides';
                    }
                    
                    if (filterType) {
                        console.log('Filter type detected:', filterType);
                        showDropdownOptions(menu, filterType);
                    }
                } else {
                    console.log('Dropdown closed');
                }
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            filterDropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                if (menu) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                }
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            });
        }
    });
    
    // Initialize favorite and comparison buttons
    setTimeout(() => {
        initializeAllButtons();
        // Initialize ComparisonManager (loads from database for managers)
        if (window.ComparisonManager && window.ComparisonManager.init) {
            window.ComparisonManager.init();
        }
        // Favorites counter now handled by FavoritesManager
        console.log('Initial page setup complete with favorites and comparison');
    }, 100);
    
    // Initialize view mode to list by default
    const container = document.getElementById('properties-container');
    if (container && !container.getAttribute('data-view-mode')) {
        container.setAttribute('data-view-mode', 'list');
    }
    
    console.log('Dropdown filters initialized, including', filterDropdowns.length, 'new filter dropdowns');
    
    // Function to show dropdown options for new filters
    function showDropdownOptions(menu, filterType) {
        console.log('Showing options for filter:', filterType);
        const existingOptions = menu.querySelectorAll('input[type="checkbox"]');
        
        // If options already exist, don't duplicate
        if (existingOptions.length > 0) {
            console.log('Options already exist for', filterType);
            return;
        }
        
        let options = [];
        
        // Define options for each filter type
        switch(filterType) {
            case 'registration':
                options = ['–í–æ–∑–º–æ–∂–Ω–∞', '–ù–µ–≤–æ–∑–º–æ–∂–Ω–∞', '–í—Ä–µ–º–µ–Ω–Ω–∞—è'];
                break;
            case 'nearby_places':
                options = ['–®–∫–æ–ª–∞', '–î–µ—Ç—Å–∫–∏–π —Å–∞–¥', '–ë–æ–ª—å–Ω–∏—Ü–∞', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ü–∞—Ä–∫'];
                break;
            case 'window_view':
                options = ['–ù–∞ –¥–≤–æ—Ä', '–ù–∞ —É–ª–∏—Ü—É', '–ù–∞ –º–æ—Ä–µ', '–ù–∞ –≥–æ—Ä—ã'];
                break;
            case 'special_apartments':
                options = ['–£–≥–ª–æ–≤–∞—è', '–ü–µ–Ω—Ç—Ö–∞—É—Å', '–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è', '–° —Ç–µ—Ä—Ä–∞—Å–æ–π'];
                break;
            case 'world_sides':
                options = ['–°–µ–≤–µ—Ä', '–Æ–≥', '–í–æ—Å—Ç–æ–∫', '–ó–∞–ø–∞–¥'];
                break;
            default:
                console.log('Unknown filter type:', filterType);
                return;
        }
        
        // Create container for options if it doesn't exist
        let container = menu.querySelector('.p-3.space-y-2');
        if (!container) {
            container = document.createElement('div');
            container.className = 'p-3 space-y-2';
            menu.appendChild(container);
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Add options
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="${filterType}" value="${option}" onchange="updateAdvancedFilters()"> ${option}
            `;
            container.appendChild(label);
        });
        
        console.log('Added', options.length, 'options for', filterType);
    }
});

// Check if a specific filter has active values
function checkIfFilterIsActive(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Check if any room checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        case 'price':
            // Check if price inputs have values
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            return (priceFrom && priceFrom.value) || (priceTo && priceTo.value);
            
        case 'completion':
            // Check if any completion checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        default:
            // Generic check for any input with value
            const inputs = dropdown.querySelectorAll('input');
            return Array.from(inputs).some(input => {
                if (input.type === 'checkbox') return input.checked;
                if (input.type === 'text' || input.type === 'number') return input.value;
                return false;
            });
    }
}

// Clear specific filter values via double-click (add separate function)
function clearFilterByDoubleClick(button) {
    const dropdown = button.closest('.filter-dropdown') || button.closest('.dropdown');
    if (!dropdown) return;
    
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = '–¢–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            button.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = '–°—Ä–æ–∫ —Å–¥–∞—á–∏';
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
    console.log('Filter cleared by double-click:', filterType);
}

// Clear specific filter values
function clearSpecificFilter(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const roomsBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (roomsBtn) roomsBtn.textContent = '–¢–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            // Update button text
            const priceBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (priceBtn) priceBtn.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const completionBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (completionBtn) completionBtn.textContent = '–°—Ä–æ–∫ —Å–¥–∞—á–∏';
            break;
            
        default:
            // Generic clear for all inputs
            dropdown.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
}

// Legacy function for backward compatibility 
function initializeFavoriteButtons() {
    initializeAllButtons();
}

// handleFavoriteClick function removed - now handled by FavoritesManager

// Initialize comparison and recommendation buttons only
function initializeAllButtons() {
    // Favorites are now handled by FavoritesManager class
    
    // Clear previous initialization for comparison and recommendation buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        if (btn.hasAttribute('data-compare-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-compare-initialized');
        }
    });
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-recommend-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-recommend-initialized');
        }
    });
    
    // Favorite buttons are now initialized by FavoritesManager
    // Removed duplicate initialization to prevent conflicts
    
    // Initialize comparison buttons with NEW unified system
    document.querySelectorAll('.compare-btn').forEach(btn => {
        const propertyId = parseInt(btn.getAttribute('data-property-id'));
        
        // Update button state using new system
        if (window.ComparisonManager) {
            window.ComparisonManager.updateButton(propertyId);
        }
        
        // Add event listener if not already added
        if (!btn.hasAttribute('data-compare-initialized')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addToCompare(propertyId);
            });
            btn.setAttribute('data-compare-initialized', 'true');
        }
    });
    
    // Initialize recommendation buttons for managers using the new function
    if (window.manager_authenticated) {
        initializeRecommendButtons();
    }
    
    // Clean up old comparison systems and initialize new one
    localStorage.removeItem('propertyComparison'); // Remove old system
    localStorage.removeItem('complexComparison'); // Remove old system
    
    // Initialize comparison counter on page load
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
    
    console.log('Initialized buttons for', document.querySelectorAll('.property-card').length, 'properties');
}

// Legacy function for backward compatibility
function initializeComparisonButtons() {
    initializeAllButtons();
}

// Legacy toggleFavorite function - now delegates to FavoritesManager
function toggleFavorite(propertyId) {
    if (window.favoritesManager) {
        const heartElement = document.querySelector(`.favorite-heart[data-property-id="${propertyId}"]`);
        window.favoritesManager.toggleFavorite(propertyId, heartElement);
    } else {
        console.error('FavoritesManager not initialized');
    }
}

// NEW UNIFIED COMPARISON SYSTEM
window.ComparisonManager = {
    initialized: false,
    
    // Initialize - load from database for managers
    init: async function() {
        if (this.initialized) return;
        this.initialized = true;
        
        const isManager = Boolean(window.manager_authenticated);
        if (isManager) {
            console.log('üîç Manager detected - loading comparison from database...');
            await this.loadFromDatabase();
        }
        this.updateCounters();
        this.updateAllButtons();
    },
    
    // Load comparison data from PostgreSQL (managers only)
    loadFromDatabase: async function() {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const response = await fetch('/api/manager/comparison/load');
            if (response.ok) {
                const result = await response.json();
                console.log('üì¶ Database comparison data:', result);
                
                if (result.success) {
                    const data = {
                        properties: result.properties || [],
                        complexes: result.complexes || []
                    };
                    localStorage.setItem('comparison-data', JSON.stringify(data));
                    console.log('‚úÖ Loaded from database:', data);
                    this.updateCounters();
                    this.updateAllButtons();
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading comparison from database:', error);
        }
    },
    
    // Sync to database (managers only)
    syncToDatabase: async function(action, type, id) {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const endpoint = `/api/manager/comparison/${type}/${action}`;
            const body = type === 'property' ? { property_id: id } : { complex_id: id };
            
            console.log(`üì° Syncing to database: ${action} ${type} ${id}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const result = await response.json();
            if (result.success) {
                console.log(`‚úÖ Synced to database: ${action} ${type} ${id}`);
            }
        } catch (error) {
            console.error('‚ùå Error syncing to database:', error);
        }
    },
    
    // Get current comparison data
    getData: function() {
        return JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    },
    
    // Save comparison data
    saveData: function(data) {
        localStorage.setItem('comparison-data', JSON.stringify(data));
        this.updateCounters();
    },
    
    // Add property to comparison
    addProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (!data.properties.includes(idStr)) {
            if (data.properties.length >= 4) {
                this.showMessage('–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 4 –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'warning');
                return false;
            }
            data.properties.push(idStr);
            this.saveData(data);
            this.showMessage('–ö–≤–∞—Ä—Ç–∏—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ', 'success');
            console.log('Property added to comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('add', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Remove property from comparison
    removeProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (data.properties.includes(idStr)) {
            data.properties = data.properties.filter(id => id !== idStr);
            this.saveData(data);
            this.showMessage('–ö–≤–∞—Ä—Ç–∏—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'info');
            console.log('Property removed from comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('remove', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Check if property is in comparison
    hasProperty: function(propertyId) {
        const data = this.getData();
        return data.properties.includes(propertyId.toString());
    },
    
    // Update all counters
    updateCounters: function() {
        const data = this.getData();
        const totalCount = data.properties.length + data.complexes.length;
        
        // Update global comparison counter in header
        const globalCounter = document.getElementById('comparison-count');
        if (globalCounter) {
            globalCounter.textContent = totalCount;
            globalCounter.style.display = totalCount > 0 ? 'flex' : 'none';
        }
        
        // Update dashboard counters if available
        const propertiesCount = document.getElementById('properties-tab-count');
        if (propertiesCount) {
            propertiesCount.textContent = data.properties.length;
        }
        
        const complexesCount = document.getElementById('complexes-tab-count');
        if (complexesCount) {
            complexesCount.textContent = data.complexes.length;
        }
    },
    
    // Show notification message
    showMessage: function(message, type = 'info') {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            console.log(`[${type}] ${message}`);
        }
    },
    
    // Update button state
    updateButton: function(propertyId) {
        const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
        if (!button) return;
        
        const isInComparison = this.hasProperty(propertyId);
        
        if (isInComparison) {
            button.classList.add('added', 'user-comparison-active');
            button.classList.remove('bg-[#0088CC]/10');
            button.style.background = '';
            button.innerHTML = '<i class="fas fa-balance-scale text-white"></i>';
            button.title = '–£–±—Ä–∞—Ç—å –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è';
        } else {
            button.classList.remove('added', 'user-comparison-active');
            button.classList.add('bg-[#0088CC]/10', 'text-[#0088CC]');
            button.style.background = '';
            button.innerHTML = '<i class="fas fa-balance-scale text-[#0088CC]"></i>';
            button.title = '–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é';
        }
    },
    
    // Update all comparison buttons on the page
    updateAllButtons: function() {
        const data = this.getData();
        document.querySelectorAll('.compare-btn[data-property-id]').forEach(btn => {
            const propertyId = btn.dataset.propertyId;
            if (propertyId) {
                this.updateButton(propertyId);
            }
        });
        console.log('üîÑ Updated all comparison buttons');
    }
};

// Main comparison function
function addToCompare(propertyId) {
    // Prevent rapid clicks
    const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
    if (button && button.disabled) return;
    
    // Temporarily disable button
    if (button) {
        button.disabled = true;
        setTimeout(() => button.disabled = false, 500);
    }
    
    // Toggle comparison state
    if (window.ComparisonManager.hasProperty(propertyId)) {
        window.ComparisonManager.removeProperty(propertyId);
    } else {
        window.ComparisonManager.addProperty(propertyId);
    }
    
    // Update button appearance
    window.ComparisonManager.updateButton(propertyId);
}

// View Mode Toggle Functions
function switchToListView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - list view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'list');
    
    // Update button styles
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Re-render properties with list view - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to list view');
}

function switchToGridView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - grid view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'grid');
    
    // Update button styles
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Re-render properties with grid view - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞  
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to grid view');
}

</script>

<!-- Favorites system is loaded globally in base.html to prevent duplicates -->

<!-- Presentation Functions - Versioned for cache busting -->
<script src="{{ url_for('static', filename='js/presentation.js') }}?v={{ range(1000, 9999) | random }}"></script>

<!-- Floating "Find Property" Popup Widget -->
<div id="property-assist-popup" class="fixed left-4 bottom-4 z-50 hidden opacity-0 transition-all duration-500 transform translate-y-4 max-w-xs" style="max-width: 320px;">
    <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-5 relative">
        <button onclick="closePropertyAssistPopup()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors w-6 h-6 flex items-center justify-center">
            <i class="fas fa-times text-sm"></i>
        </button>
        <div class="flex items-start gap-4">
            <div class="flex-1 pr-4">
                <h4 class="font-bold text-gray-900 text-base mb-2 leading-tight">–ù–µ —Ç—Ä–∞—Ç—å—Ç–µ –≤—Ä–µ–º—è –Ω–∞ –ø–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä—ã!</h4>
                <p class="text-gray-600 text-sm leading-relaxed">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ–¥–±–µ—Ä–µ–º –¥–ª—è –≤–∞—Å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ–±—ä–µ–∫—Ç –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ –∏ –ø—Ä–æ–≤–µ–¥–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–¥–µ–ª–∫—É –ø–æ –≤—Ç–æ—Ä–∏—á–∫–µ!</p>
            </div>
            <div class="flex-shrink-0 mt-1">
                <svg class="w-14 h-14 text-[#0088CC]" viewBox="0 0 64 64" fill="none">
                    <rect x="14" y="16" width="16" height="32" rx="2" stroke="currentColor" stroke-width="2.5" fill="none"/>
                    <rect x="34" y="8" width="16" height="40" rx="2" stroke="currentColor" stroke-width="2.5" fill="none"/>
                    <rect x="18" y="22" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="24" y="22" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="18" y="30" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="24" y="30" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="18" y="38" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="38" y="14" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="44" y="14" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="38" y="22" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="44" y="22" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="38" y="30" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="44" y="30" width="4" height="4" rx="0.5" fill="currentColor"/>
                    <rect x="38" y="38" width="4" height="4" rx="0.5" fill="currentColor"/>
                </svg>
            </div>
        </div>
        <button onclick="openApplicationModal(); closePropertyAssistPopup();" class="mt-4 w-full bg-[#0088CC] hover:bg-[#006699] text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 text-sm">
            –ü–æ–¥–±–µ—Ä–∏—Ç–µ –º–Ω–µ –æ–±—ä–µ–∫—Ç
        </button>
    </div>
</div>

<script>
(function() {
    const POPUP_DISMISS_KEY = 'property_assist_popup_dismissed';
    const DISMISS_DAYS = 7;

    function isPopupDismissed() {
        const dismissed = localStorage.getItem(POPUP_DISMISS_KEY);
        if (!dismissed) return false;
        const dismissedAt = parseInt(dismissed, 10);
        const daysPassed = (Date.now() - dismissedAt) / (1000 * 60 * 60 * 24);
        return daysPassed < DISMISS_DAYS;
    }

    function showPopup() {
        const popup = document.getElementById('property-assist-popup');
        if (!popup || isPopupDismissed()) return;
        popup.classList.remove('hidden');
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                popup.classList.remove('opacity-0', 'translate-y-4');
                popup.classList.add('opacity-100', 'translate-y-0');
            });
        });
    }

    window.closePropertyAssistPopup = function() {
        const popup = document.getElementById('property-assist-popup');
        if (!popup) return;
        popup.classList.add('opacity-0', 'translate-y-4');
        popup.classList.remove('opacity-100', 'translate-y-0');
        setTimeout(() => popup.classList.add('hidden'), 500);
        localStorage.setItem(POPUP_DISMISS_KEY, Date.now().toString());
    };

    if (window.innerWidth >= 768) {
        setTimeout(showPopup, 5000);
    }
})();
</script>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ property-filters.js -->
<script>
// Server-side pagination flags - MUST be set before property-filters.js loads
window.serverSidePagination = true;
window.totalProperties = {{ total_properties|default(0) }};
window.totalPages = {{ total_pages|default(1) }};
window.currentServerPage = {{ page|default(1) }};

// ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentCityId –î–û –∑–∞–≥—Ä—É–∑–∫–∏ property-filters.js
// –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∫–Ω–æ–ø–∫–µ "–ù–∞–π—Ç–∏"
window.currentCityId = {{ current_city.id if current_city else 1 }};
console.log('üèôÔ∏è Current city ID:', window.currentCityId);

// Developers mapping: ID ‚Üí Name (–¥–ª—è displayActiveFilters)
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–ª—é—á–∏, —Ç.–∫. URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∏
// NOTE: This is refreshed by loadDevelopers() AJAX call when city changes
window.developersMap = {
    {% if developers %}
    {% for developer in developers %}
    "{{ developer.id }}": "{{ developer.name|replace('"', '\\"') }}"{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
};

console.log('‚úÖ Filter variables initialized (before property-filters.js):', {
    serverSidePagination: window.serverSidePagination,
    totalProperties: window.totalProperties,
    totalPages: window.totalPages,
    page: window.currentServerPage,
    currentCityId: window.currentCityId,
    developersCount: Object.keys(window.developersMap).length
});

// ‚úÖ View mode switching with localStorage persistence
// Initialize from localStorage or default to 'list'
window.currentViewMode = localStorage.getItem('propertiesViewMode') || 'list';

function switchToListView() {
    // üîÑ SYNC MAP FILTERS TO URL BEFORE SWITCHING
    if (typeof window.syncMapFiltersToUrl === 'function') {
        console.log('üîÑ Syncing map filters before switching to list view...');
        window.syncMapFiltersToUrl(); // This might reload the page if filters exist
        // If the page resets with filters, we don't need to continue
        // So we'll add a small delay before continuing
    }
    
    window.currentViewMode = 'list';
    localStorage.setItem('propertiesViewMode', 'list');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('‚ùå Container #properties-container not found');
        return;
    }
    
    // Update container classes - LIST MODE
    container.className = 'space-y-6 w-full';
    
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 w-full flex cursor-pointer min-h-[280px]';
        
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-80 flex-shrink-0 group';
            imageSection.style.height = '240px';
            imageSection.style.width = '';
        }
        
        const carousel = card.querySelector('.carousel-container');
        if (carousel) {
            carousel.style.height = '240px';
        }
        
        const children = Array.from(card.children);
        const contentSection = children.length > 1 ? children[1] : null;
        if (contentSection && contentSection.querySelector('h2')) {
            contentSection.className = 'flex-1 p-6 flex flex-col';
            contentSection.style.display = '';
            const h2 = contentSection.querySelector('h2');
            if (h2) h2.className = 'text-xl font-semibold text-gray-900 mb-3';
        }
    });
    
    // Update button states
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('‚úÖ Switched to list view');
}

function switchToGridView() {
    window.currentViewMode = 'grid';
    localStorage.setItem('propertiesViewMode', 'grid');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('‚ùå Container #properties-container not found');
        return;
    }
    
    container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 w-full';
    
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 w-full flex flex-col cursor-pointer';
        
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-full flex-shrink-0 group';
            imageSection.style.height = '192px';
            imageSection.style.width = '100%';
        }
        
        const carousel = card.querySelector('.carousel-container');
        if (carousel) {
            carousel.style.height = '192px';
        }
        
        const children = Array.from(card.children);
        const contentSection = children.length > 1 ? children[1] : null;
        if (contentSection && contentSection.querySelector('h2')) {
            contentSection.className = 'p-4 flex flex-col flex-1';
            contentSection.style.display = '';
            const h2 = contentSection.querySelector('h2');
            if (h2) h2.className = 'text-base font-semibold text-gray-900 mb-2';
        }
    });
    
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('‚úÖ Switched to grid view');
}

// Make functions globally accessible
window.switchToListView = switchToListView;
window.switchToGridView = switchToGridView;

console.log('‚úÖ View switching functions loaded');

// Initialize view on page load from localStorage or default
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Initializing properties page view...');
    console.log('üìã Current view mode:', window.currentViewMode);
    
    // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ AJAX API
    setTimeout(() => {
        console.log('üì¶ Loading initial properties via AJAX...');
        const container = document.getElementById('properties-container');
        if (container && container.querySelectorAll('.property-card').length === 0) {
            console.log('üîÑ No cards found, fetching from API...');
            const currentUrl = new URLSearchParams(window.location.search);
            currentUrl.set('page', '1');
            if (window.currentCityId && !currentUrl.has('city_id')) {
                currentUrl.set('city_id', window.currentCityId);
            }
            const apiUrl = '/api/properties/list?' + currentUrl.toString();
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ API response:', data.properties ? data.properties.length : 0, 'properties');
                    if (data.properties && data.properties.length > 0) {
                        if (typeof window.updatePropertiesList === 'function') {
                            window.updatePropertiesList(data.properties);
                            console.log('‚úÖ Initial properties loaded from API');
                        }
                    } else {
                        container.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    }
                    if (window.infiniteScrollManager && window.infiniteScrollManager.markReady) {
                        window.infiniteScrollManager.markReady();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Failed to load properties:', error);
                    if (window.infiniteScrollManager && window.infiniteScrollManager.markReady) {
                        window.infiniteScrollManager.markReady();
                    }
                });
        } else {
            console.log('‚úÖ Cards already present, skipping AJAX load');
            if (window.infiniteScrollManager && window.infiniteScrollManager.markReady) {
                window.infiniteScrollManager.markReady();
            }
        }
    }, 300);
    
    // Apply saved view mode or default to list
    if (window.currentViewMode === 'grid') {
        switchToGridView();
    } else {
        switchToListView();
    }
});
</script>
<!-- ‚úÖ CACHE BUSTER -->
<script>console.log('üî• –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø HTML –ó–ê–ì–†–£–ñ–ï–ù–ê - v1769888700');</script>
<!-- ‚úÖ MOBILE SEARCH REDIRECT: Smart room query detection (MUST LOAD FIRST) -->
<script src="{{ url_for('static', filename='js/mobile-search-redirect.js') }}?v=1761859100"></script>
<!-- ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ü–ï–†–í–û–ô -->
<script src="{{ url_for('static', filename='js/properties-sorting.js') }}?v=1761507235"></script>
<!-- ‚úÖ AJAX LIST UPDATER: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ -->
<script src="{{ url_for('static', filename='js/properties-list-updater.js') }}?v=1761509300"></script>
<!-- ‚úÖ INFINITE SCROLL: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ -->
<script src="{{ url_for('static', filename='js/infinite-scroll.js') }}?v=1761507444"></script>

<script src="{{ url_for('static', filename='js/property-filters.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/expandable-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/smart_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/favorites.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties_mini_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/saved_searches.js') }}?v=1761577011"></script>
<script src="{{ url_for('static', filename='js/property-card-click.js') }}"></script>
<script>
// Initialize SmartAutocomplete for properties search
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SmartAutocomplete !== 'undefined' && typeof initializePropertiesSmartSearch === 'function') {
        initializePropertiesSmartSearch();
        console.log('‚úÖ SmartAutocomplete initialized for properties page');
    }
});

// Initialize SavedSearchesManager after the script is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SavedSearchesManager !== 'undefined') {
        window.savedSearchesManager = new SavedSearchesManager();
        console.log('‚úÖ SavedSearchesManager initialized');
    }
});

// ====================================
// LIVE FILTER COUNT UPDATE HANDLERS
// ====================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Initializing live filter count update handlers...');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (typeof window.unusedUFC === 'function') {
        setTimeout(() => window.updateFilteredCount(), 500);
    }
    
    // ===== –ß–ï–ö–ë–û–ö–°–´ –§–ò–õ–¨–¢–†–û–í =====
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const filterCheckboxes = document.querySelectorAll(
        'input[data-filter-type="rooms"], ' +
        'input[data-filter-type="developer"], ' +
        'input[data-filter-type="district"], ' +
        'input[data-filter-type="completion"], ' +
        'input[data-filter-type="object_classes"], ' +
        'input[data-filter-type="renovation"], ' +
        'input[data-filter-type="floor_options"], ' +
        'input[data-filter-type="features"], ' +
        'input[data-filter-type="building_released"]'
    );
    
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('‚úÖ Filter checkbox changed:', this.getAttribute('data-filter-type'));
            if (typeof window.unusedUFC === 'function') {
                window.updateFilteredCount();
            }
        });
    });
    
    console.log(`‚úÖ Added listeners to ${filterCheckboxes.length} filter checkboxes`);
    
    // ===== –ò–ù–ü–£–¢–´ –§–ò–õ–¨–¢–†–û–í =====
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö/—á–∏—Å–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
    const filterInputs = document.querySelectorAll(
        '#priceFrom, #priceTo, #priceFromModal, #priceToModal, ' +
        '#areaFrom, #areaTo, ' +
        '#floorFrom, #floorTo, ' +
        '#maxFloorFrom, #maxFloorTo, ' +
        '#buildYearFrom, #buildYearTo'
    );
    
    filterInputs.forEach(input => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'input' event –¥–ª—è —Ä–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
        input.addEventListener('input', function() {
            console.log('‚úÖ Filter input changed:', this.id);
            if (typeof window.unusedUFC === 'function') {
                window.updateFilteredCount();
            }
        });
    });
    
    console.log(`‚úÖ Added listeners to ${filterInputs.length} filter inputs`);
    
    // ===== –ö–ù–û–ü–ö–ê "–ü–û–ö–ê–ó–ê–¢–¨" –í –†–ê–°–®–ò–†–ï–ù–ù–´–• –§–ò–õ–¨–¢–†–ê–• =====
    
    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const applyAdvancedButton = document.getElementById('applyAdvancedFilters');
    if (applyAdvancedButton) {
        applyAdvancedButton.addEventListener('click', function() {
            console.log('‚úÖ Apply advanced filters button clicked');
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            if (typeof window.unusedAF === 'function') {
                window.applyFilters();
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            const panel = document.getElementById('advancedFiltersPanel');
            if (panel) {
                panel.classList.add('hidden');
                // –£–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –º–æ–±–∞–π–ª–µ
                if (window.innerWidth <= 640) {
                    panel.classList.remove('mobile-fullscreen');
                    document.body.style.overflow = '';
                }
                console.log('‚úÖ Advanced filters panel closed');
            }
        });
        console.log('‚úÖ Apply advanced filters button handler registered');
    }
    
    console.log('‚úÖ Live filter count update initialized');
});

// ====================================
// DROPDOWN MANAGEMENT (Avito/Cian-style)
// ====================================

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è dropdown'–∞–º–∏ - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
function toggleDropdown(event, currentDropdown) {
    event.stopPropagation();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ dropdown'—ã
    document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π dropdown - –∑–∞–∫—Ä—ã–≤–∞–µ–º
        if (menu !== currentDropdown) {
            menu.classList.remove('open');
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π dropdown
    if (currentDropdown) {
        currentDropdown.classList.toggle('open');
    }
}

// ====================================
// MOBILE BOTTOM SHEET PANEL HANDLERS
// ====================================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –ö–æ–º–Ω–∞—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
function toggleRoomsPanel(event) {
    const isMobile = window.innerWidth < 640;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º bottom sheet –ø–∞–Ω–µ–ª—å
        event.preventDefault();
        event.stopPropagation();
        
        const panel = document.getElementById('roomsFilterPanel');
        if (panel) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            const dropdown = event.currentTarget.parentElement.querySelector('.dropdown-menu');
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            panel.classList.remove('hidden');
            
            // –î–æ–±–∞–≤–ª—è–µ–º mobile-fullscreen –∫–ª–∞—Å—Å
            if (isMobile) {
                panel.classList.add('mobile-fullscreen');
                document.body.style.overflow = 'hidden';
            }
            
            console.log('‚úÖ Rooms panel opened on mobile');
        }
    }
    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π dropdown (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –¶–µ–Ω—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
function togglePricePanel(event) {
    const isMobile = window.innerWidth < 640;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º bottom sheet –ø–∞–Ω–µ–ª—å
        event.preventDefault();
        event.stopPropagation();
        
        const panel = document.getElementById('priceFilterPanel');
        if (panel) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            const dropdown = event.currentTarget.parentElement.querySelector('.dropdown-menu');
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            panel.classList.remove('hidden');
            
            // –î–æ–±–∞–≤–ª—è–µ–º mobile-fullscreen –∫–ª–∞—Å—Å
            if (isMobile) {
                panel.classList.add('mobile-fullscreen');
                document.body.style.overflow = 'hidden';
            }
            
            console.log('‚úÖ Price panel opened on mobile');
        }
    }
    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π dropdown (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (Avito-style)
function openMobileFilters() {
    console.log('üîß openMobileFilters() called');
    
    const panel = document.getElementById('advancedFiltersPanel');
    if (panel) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –ù–∞ –º–æ–±–∞–π–ª–µ –¥–µ–ª–∞–µ–º fullscreen
        const isMobile = window.innerWidth < 640;
        if (isMobile) {
            panel.classList.add('mobile-fullscreen');
            document.body.style.overflow = 'hidden';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.unusedUFC === 'function') {
            window.updateFilteredCount();
        }
        
        console.log('‚úÖ Advanced filters panel opened on mobile');
    } else {
        console.warn('‚ö†Ô∏è advancedFiltersPanel not found');
    }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
// –¢–µ–ø–µ—Ä—å property-search –≤ –º–æ–±–∏–ª—å–Ω–æ–º sticky bar, property-search-desktop –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
document.addEventListener('DOMContentLoaded', function() {
    const mobileSearch = document.getElementById('property-search'); // –í mobile sticky bar
    const desktopSearch = document.getElementById('property-search-desktop'); // –í desktop section
    
    if (mobileSearch && desktopSearch) {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –º–æ–±–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π property-search)
        mobileSearch.addEventListener('input', function() {
            desktopSearch.value = this.value;
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø–æ–∏—Å–∫
        desktopSearch.addEventListener('input', function() {
            mobileSearch.value = this.value;
            // Trigger autocomplete on mobile search too
            if (typeof SmartAutocomplete !== 'undefined' && mobileSearch.dispatchEvent) {
                mobileSearch.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
        mobileSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (typeof window.unusedAF === 'function') {
                    window.applyFilters();
                }
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–º
        desktopSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (typeof window.unusedAF === 'function') {
                    window.applyFilters();
                }
            }
        });
        
        console.log('‚úÖ Mobile (property-search) and desktop (property-search-desktop) search synchronized');
    }
});

console.log('‚úÖ Mobile bottom sheet handlers initialized');

// Handle card clicks for navigation while preserving button functionality
function handleCardClick(event, url) {
    // Check if click was on a button or interactive element
    const target = event.target;
    const isButton = target.tagName === 'BUTTON' || target.closest('button');
    const isLink = target.tagName === 'A' || target.closest('a');
    const isInteractive = target.closest('.favorite-heart') || target.closest('.comparison-btn');
    
    // If click was on interactive element, don't navigate
    if (isButton || isLink || isInteractive) {
        console.log('‚è∏Ô∏è handleCardClick: Ignoring click on interactive element');
        return;
    }
    
    // Navigate to property detail page
    console.log('üîó handleCardClick: Navigating to:', url);
    window.location.href = url;
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ë–ï–ó –¢–ê–ë–û–í - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π layout) -->
<div id="filters-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" onclick="window.toggleFiltersModal()"></div>
    
    <!-- Modal Container -->
    <div class="relative min-h-screen flex items-start justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:max-w-2xl md:my-8 md:rounded-2xl shadow-xl flex flex-col" style="max-height: 100vh;">
            
            <!-- Sticky Header -->
            <div class="sticky top-0 bg-white z-10 px-4 md:px-6 py-4 border-b border-gray-200 md:rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900">–§–∏–ª—å—Ç—Ä—ã</h2>
                    <div class="flex items-center gap-3">
                        <button onclick="window.location.href=window.location.pathname;" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors">
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                        <button onclick="window.toggleFiltersModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Scrollable Content - –í–°–ï —Ñ–∏–ª—å—Ç—Ä—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6" id="filters-modal-content">
                <div class="space-y-8">
                    
                    <!-- ========== –°–ï–ö–¶–ò–Ø: –ö–í–ê–†–¢–ò–†–ê ========== -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 pb-2 border-b-2 border-[#0088CC]">–ö–≤–∞—Ä—Ç–∏—Ä–∞</h3>
                        
                        <!-- –ü–ª–æ—â–∞–¥—å -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                            <div class="flex gap-2">
                                <input type="number" id="areaFromModal" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="areaToModal" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- –≠—Ç–∞–∂ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="floorFromModal" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="floorToModal" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="not_first" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–ù–µ –ø–µ—Ä–≤—ã–π</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="not_last" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–ù–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="last" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–ü–æ—Å–ª–µ–¥–Ω–∏–π</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –û—Ç–¥–µ–ª–∫–∞ (—Å–µ—Ä—ã–µ –∫–Ω–æ–ø–∫–∏) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–∫–∞</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="no_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="fine_finish" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–ß–∏—Å—Ç–æ–≤–∞—è</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Å–∫–∏–¥–∫–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏</label>
                            <div class="space-y-2">
                                <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-sm text-gray-700">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤</span>
                                </label>
                                <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-sm text-gray-700">–õ—å–≥–æ—Ç–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- ========== –°–ï–ö–¶–ò–Ø: –î–û–ú ========== -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 pb-2 border-b-2 border-[#0088CC]">–î–æ–º</h3>
                        
                        <!-- –°—Ä–æ–∫ —Å–¥–∞—á–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2024" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">2024</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2025" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">2025</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2026" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">2026</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2028" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">2028</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –°—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–°–¥–∞–Ω–Ω—ã–π –¥–æ–º</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();">
                                    <span class="text-[#111827]">–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞</label>
                            <div class="flex gap-2">
                                <input type="number" id="maxFloorFromModal" oninput="window.updateFilteredCount()" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="maxFloorToModal" oninput="window.updateFilteredCount()" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- –ö–ª–∞—Å—Å –∂–∏–ª—å—è -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –∂–∏–ª—å—è</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();" {% if "–ö–æ–º—Ñ–æ—Ä—Ç" in filters.get("object_classes", []) %}checked{% endif %}>
                                    <span class="text-[#111827]">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();" {% if "–ë–∏–∑–Ω–µ—Å" in filters.get("object_classes", []) %}checked{% endif %}>
                                    <span class="text-[#111827]">–ë–∏–∑–Ω–µ—Å</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-filter-type="object_classes" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="window.updateFilteredCount();" {% if "–ü—Ä–µ–º–∏—É–º" in filters.get("object_classes", []) %}checked{% endif %}>
                                    <span class="text-[#111827]">–ü—Ä–µ–º–∏—É–º</span>
                                </label>
                            </div>
                        </div>
                        
                    </div>
                    
                </div>
            </div>
            
            <!-- Sticky Footer -->
            <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 md:rounded-b-2xl">
                <button id="apply-filters-modal-btn-id" class="w-full py-3 md:py-4 bg-[#0088CC] hover:bg-[#006699] text-white rounded-lg font-semibold transition-all text-base md:text-lg shadow-lg">
                    –ü–æ–∫–∞–∑–∞—Ç—å <span id="priceFilteredCountDisplay">0</span> <span id="modal-filtered-word">–æ–±—ä–µ–∫—Ç–æ–≤</span>
                </button>
                <script>
                document.getElementById('apply-filters-modal-btn-id').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üî¥ MODAL APPLY BUTTON CLICKED');
                    var modal = document.getElementById('filters-modal');
                    var inputs = modal ? modal.querySelectorAll('input[type="number"]') : [];
                    var state = {};
                    inputs.forEach(function(inp) {
                        if (inp.value && inp.value.trim() !== '') {
                            console.log('üéØ Modal input:', inp.id, '=', inp.value);
                        }
                    });
                    if (typeof window.applyFiltersManual === 'function') {
                        window.applyFiltersManual();
                    } else if (typeof window.applyFilters === 'function') {
                        window.applyFilters();
                    } else {
                        console.error('‚ùå No applyFilters function found!');
                    }
                });
                </script>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal - Simple centered window -->
<div id="map-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 md:p-8 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-2xl w-full max-w-3xl relative shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="mapModalContent">
        <button onclick="closeMapModal()" class="absolute top-3 right-3 z-30 w-8 h-8 bg-white hover:bg-gray-100 rounded-full flex items-center justify-center shadow transition-colors">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div id="map-container" class="w-full h-[400px] md:h-[500px] rounded-2xl overflow-hidden bg-gray-100"></div>
        <h2 id="map-title" class="hidden"></h2>
    </div>
</div>

<script>
function openMapModal(lat, lon, name, propertyId) {
    const modal = document.getElementById('map-modal');
    const modalContent = document.getElementById('mapModalContent');
    const container = document.getElementById('map-container');
    
    modal.classList.remove('hidden');
    modal.offsetHeight;
    modal.classList.remove('opacity-0');
    modal.classList.add('opacity-100');
    modalContent.classList.remove('scale-95', 'opacity-0');
    modalContent.classList.add('scale-100', 'opacity-100');
    
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        if (window.ymaps) {
            container.innerHTML = '';
            
            const map = new ymaps.Map(container, {
                center: [lat, lon],
                zoom: 16,
                controls: ['zoomControl']
            });
            
            const placemark = new ymaps.Placemark(
                [lat, lon],
                { 
                    hintContent: name || '–û–±—ä–µ–∫—Ç'
                },
                { 
                    preset: 'islands#blueDotIcon',
                    iconColor: '#0088CC'
                }
            );
            map.geoObjects.add(placemark);
            
            container.__map = map;
        }
    }, 150);
}

function closeMapModal() {
    const modal = document.getElementById('map-modal');
    const modalContent = document.getElementById('mapModalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    modal.classList.add('opacity-0');
    modal.classList.remove('opacity-100');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        const container = document.getElementById('map-container');
        if (container) container.innerHTML = '';
    }, 300);
}
// MAIN toggleQuickRoomFilter - –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞–Ω–Ω—é—é –≤–µ—Ä—Å–∏—é, —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
// –†–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏ –∫–∞—Ä—Ç—ã
window._realToggleQuickRoomFilterImpl = function(room) {
    if (!window.mapFilters) {
        window.mapFilters = { rooms: [], price_min: '', price_max: '', area_min: '', area_max: '' };
    }
    
    const index = window.mapFilters.rooms.indexOf(room);
    if (index > -1) {
        // Remove if already selected
        window.mapFilters.rooms = [];
    } else {
        // Replace with new room (only one filter at a time)
        window.mapFilters.rooms = [room];
    }
    
    console.log('üó∫Ô∏è Room filter toggled:', room, 'Current rooms:', window.mapFilters.rooms);
    
    // Update ALL button states (modal and fullscreen)
    document.querySelectorAll('[data-quick-room]').forEach(btn => {
        const btnRoom = parseInt(btn.dataset.quickRoom);
        if (window.mapFilters.rooms.includes(btnRoom)) {
            btn.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        } else {
            btn.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        }
    });
    
    // üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–ò–î–ò–ú–ê –õ–ò desktop –∫–∞—Ä—Ç–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–±—ä–µ–∫—Ç)
    const desktopMapModal = document.getElementById('fullscreenMapModal');
    const isDesktopMapOpen = desktopMapModal && !desktopMapModal.classList.contains('hidden');
    
    console.log('üó∫Ô∏è Desktop map open:', isDesktopMapOpen, 'Has hidden class:', desktopMapModal?.classList.contains('hidden'));
    
    if (isDesktopMapOpen) {
        // Desktop –∫–∞—Ä—Ç–∞ –û–¢–ö–†–´–¢–ê - –≤—ã–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û updateMapWithFilters, –ù–ï filterProperties
        console.log('üó∫Ô∏è Desktop map detected! Calling updateMapWithFilters()');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(() => {
            if (window.updateMapWithFilters && typeof window.updateMapWithFilters === 'function') {
                window.updateMapWithFilters();
                console.log('‚úÖ Desktop map markers updated');
            } else {
                console.warn('‚ö†Ô∏è updateMapWithFilters not available');
            }
        }, 100);
    }
    // –î–ª—è —Å–ø–∏—Å–∫–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –∑–¥–µ—Å—å, —Ä–∞–Ω—è—è –≤–µ—Ä—Å–∏—è —Å–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
};

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
window._realToggleQuickRoomFilter = window._realToggleQuickRoomFilterImpl;
console.log('‚úÖ Real toggleQuickRoomFilter registered');

// Function to update modal map with filters
async function updateMapModalWithFilters() {
    const container = document.getElementById('map-container');
    if (!container) {
        console.warn('‚ö†Ô∏è Map container not found');
        return;
    }
    
    const params = new URLSearchParams();
    if (window.currentCityId) {
        params.append('city_id', window.currentCityId);
    }
    
    // Add current map filters
    if (window.mapFilters?.rooms?.length > 0) {
        window.mapFilters.rooms.forEach(room => params.append('rooms', room));
    }
    if (window.mapFilters?.price_min) {
        params.append('price_min', window.mapFilters.price_min);
    }
    if (window.mapFilters?.price_max) {
        params.append('price_max', window.mapFilters.price_max);
    }
    if (window.mapFilters?.area_min) {
        params.append('area_min', window.mapFilters.area_min);
    }
    if (window.mapFilters?.area_max) {
        params.append('area_max', window.mapFilters.area_max);
    }
    if (window.mapFilters?.search) {
        params.append('search', window.mapFilters.search);
    }
    
    // Also pass URL-based filters that mapFilters might miss
    const urlParams = new URLSearchParams(window.location.search);
    const passThrough = ['property_type', 'floor_min', 'floor_max', 'building_floors_min', 'building_floors_max', 'developer', 'residential_complex'];
    passThrough.forEach(key => {
        if (urlParams.has(key) && !params.has(key)) {
            params.set(key, urlParams.get(key));
        }
    });
    const multiPassThrough = ['floor_options[]', 'completion[]', 'object_classes[]', 'renovation[]', 'building_released[]', 'developers[]', 'districts[]', 'features[]', 'rooms[]'];
    multiPassThrough.forEach(key => {
        const vals = urlParams.getAll(key);
        const cleanKey = key.replace('[]', '');
        if (vals.length > 0 && !params.has(cleanKey) && !params.has(key)) {
            vals.forEach(v => params.append(cleanKey, v));
        }
    });
    // Also handle rooms from URL if not already set from mapFilters
    if (!params.has('rooms')) {
        const urlRooms = urlParams.getAll('rooms[]') || urlParams.getAll('rooms');
        if (urlRooms.length > 0) {
            urlRooms.forEach(r => params.append('rooms', r));
        }
    }
    
    try {
        console.log('üó∫Ô∏è Modal: Fetching with filters:', params.toString());
        const response = await fetch(`/api/map-properties?${params.toString()}`);
        const data = await response.json();
        
        if (!data.properties) {
            console.warn('‚ö†Ô∏è No properties in response');
            return;
        }
        
        console.log('‚úÖ Modal: Got', data.properties.length, 'filtered properties');
        
        // Update counter
        const countEl = document.getElementById('map-count');
        if (countEl) {
            countEl.textContent = data.properties.length + ' –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ';
        }
        
        // Get map instance
        const map = container.__map;
        if (!map) {
            console.warn('‚ö†Ô∏è Map instance not found on container');
            return;
        }
        
        // Clear markers
        map.geoObjects.removeAll();
        
        // Group properties
        const grouped = {};
        data.properties.forEach(prop => {
            let coordKey = 'default';
            if (prop.coordinates?.lat && prop.coordinates?.lng) {
                coordKey = `${prop.coordinates.lat.toFixed(4)}_${prop.coordinates.lng.toFixed(4)}`;
            }
            if (!grouped[coordKey]) {
                grouped[coordKey] = { properties: [], lat: prop.coordinates?.lat, lng: prop.coordinates?.lng };
            }
            grouped[coordKey].properties.push(prop);
        });
        
        // Add markers
        Object.values(grouped).forEach(group => {
            try {
                let placemark;
                if (typeof createEnhancedYandexMarker === 'function') {
                    placemark = createEnhancedYandexMarker(group.properties);
                } else {
                    const count = group.properties.length;
                    const minPrice = Math.min(...group.properties.map(p => p.price || Infinity).filter(p => p !== Infinity));
                    const priceText = minPrice !== Infinity ? Math.round(minPrice / 1000000 * 10) / 10 + '–ú' : '?';
                    placemark = new ymaps.Placemark(
                        [group.lat, group.lng],
                        { balloonContent: `${count} –æ–±—ä–µ–∫—Ç–æ–≤ –æ—Ç ${priceText}‚ÇΩ` },
                        { preset: 'islands#blueCircleDotIcon' }
                    );
                }
                
                if (placemark) {
                    map.geoObjects.add(placemark);
                }
            } catch (e) {
                console.warn('Error adding marker:', e);
            }
        });
        
        console.log('‚úÖ Modal: Updated', Object.keys(grouped).length, 'marker groups');
        
        // Re-enable hover sync after map update
        addModalMapHoverSync();
        
        // Update sidebar with filtered properties
        if (data.properties.length > 0 && document.getElementById('mapSidebarProperties')) {
            const sidebar = document.getElementById('mapSidebarProperties');
            sidebar.innerHTML = data.properties.slice(0, 5).map(prop => `
                <div class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-property-id="${prop.id}" onclick="window.location.href='/object/${prop.id}'">
                    <h4 class="font-semibold text-sm text-gray-900 line-clamp-1">${prop.residential_complex || '–ñ–ö'}</h4>
                    <p class="text-xs text-gray-500">${prop.rooms || 0}–∫–æ–º–Ω, ${prop.area || '?'} –º¬≤</p>
                    <p class="font-bold text-sm text-gray-900 mt-1">${Math.round(prop.price / 1000000)}–ú ‚ÇΩ</p>
                </div>
            `).join('');
        }
        
    } catch (err) {
        console.error('‚ùå Error updating modal map with filters:', err);
    }
}


// Toggle room filter in modal
function toggleQuickRoomFilterModal(room) {
    if (!window.mapFilters) window.mapFilters = { rooms: [], price_min: '', price_max: '', area_min: '', area_max: '' };
    
    const index = window.mapFilters.rooms.indexOf(room);
    if (index > -1) {
        // Remove if already selected
        window.mapFilters.rooms = [];
    } else {
        // Replace with new room (only one filter at a time)
        window.mapFilters.rooms = [room];
    }
    
    // Update button states
    document.querySelectorAll('.quick-room-chip-modal').forEach(btn => {
        const room = parseInt(btn.dataset.quickRoom);
        if (window.mapFilters.rooms.includes(room)) {
            btn.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        } else {
            btn.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        }
    });
    
    console.log('üó∫Ô∏è Modal filter toggled - rooms:', window.mapFilters.rooms);
    updateMapModalWithFilters();
}

// Map search functionality - using event delegation for dynamic elements
console.log('üîß Map search script loading...');
(function initMapSearch() {
    console.log('üîß initMapSearch starting...');
    let searchTimeout = null;
    
    // Use event delegation on document level
    document.addEventListener('input', function(e) {
        console.log('üìù Input event on:', e.target.id);
        if (e.target.id !== 'mapSearchInput') return;
        
        const searchInput = e.target;
        const searchDropdown = document.getElementById('mapSearchDropdown');
        if (!searchDropdown) return;
        
        const query = searchInput.value.trim();
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            searchDropdown.classList.add('hidden');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            const cityId = window.currentCityId || 1;
            console.log('üîç Map search query:', query, 'city:', cityId);
            fetch(`/api/search/suggestions?query=${encodeURIComponent(query)}&city_id=${cityId}`)
                .then(response => response.json())
                .then(suggestions => {
                    console.log('üîç Map search results:', suggestions.length);
                    if (suggestions.length === 0) {
                        searchDropdown.classList.add('hidden');
                        return;
                    }
                    
                    searchDropdown.innerHTML = suggestions.slice(0, 8).map(item => {
                        const escapedText = (item.text || '').replace(/"/g, '&quot;');
                        return `
                        <div class="map-search-item px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0" 
                             data-type="${item.type}" 
                             data-text="${escapedText}"
                             data-url="${item.url || ''}">
                            <div class="flex items-center gap-2">
                                <i class="${item.icon || 'fas fa-search'} text-gray-400 text-xs w-4"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-medium text-gray-800 truncate">${item.text}</div>
                                    <div class="text-xs text-gray-500 truncate">${item.subtitle || ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                    
                    // Position fixed dropdown below input
                    const inputRect = e.target.getBoundingClientRect();
                    searchDropdown.style.top = (inputRect.bottom + 4) + 'px';
                    searchDropdown.style.left = inputRect.left + 'px';
                    searchDropdown.style.width = Math.max(inputRect.width, 280) + 'px';
                    searchDropdown.classList.remove('hidden');
                })
                .catch(err => {
                    console.error('Map search error:', err);
                    searchDropdown.classList.add('hidden');
                });
        }, 300);
    });
    
    // Handle click on search items
    document.addEventListener('click', function(e) {
        const item = e.target.closest('.map-search-item');
        if (item) {
            const searchInput = document.getElementById('mapSearchInput');
            const searchDropdown = document.getElementById('mapSearchDropdown');
            if (searchInput && searchDropdown) {
                const searchText = item.dataset.text;
                searchInput.value = searchText;
                searchDropdown.classList.add('hidden');
                
                // Apply search filter to map
                console.log('üó∫Ô∏è Map search item selected:', searchText);
                if (typeof window.applyMapSearchFilter === 'function') {
                    window.applyMapSearchFilter(searchText);
                }
            }
            return;
        }
        
        // Hide dropdown on click outside
        const searchInput = document.getElementById('mapSearchInput');
        const searchDropdown = document.getElementById('mapSearchDropdown');
        if (searchInput && searchDropdown && !searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
            searchDropdown.classList.add('hidden');
        }
    });
    
    // Handle Enter key
    document.addEventListener('keypress', function(e) {
        if (e.target.id !== 'mapSearchInput' || e.key !== 'Enter') return;
        
        e.preventDefault();
        const searchDropdown = document.getElementById('mapSearchDropdown');
        if (searchDropdown) searchDropdown.classList.add('hidden');
        
        const searchText = e.target.value.trim();
        console.log('üó∫Ô∏è Map search applied (Enter):', searchText);
        applyMapSearchFilter(searchText);
    });
    
    // Universal function to apply search filter to the current map view
    window.applyMapSearchFilter = function(searchText) {
        if (!window.mapFilters) window.mapFilters = { rooms: [], price_min: '', price_max: '', area_min: '', area_max: '' };
        window.mapFilters.search = searchText;
        
        // Determine which map view is active
        const fullscreenModal = document.getElementById('fullscreenMapModal');
        const isFullscreenOpen = fullscreenModal && !fullscreenModal.classList.contains('hidden');
        
        if (isFullscreenOpen) {
            // Fullscreen map - reload with API filter
            console.log('üîç Applying search to fullscreen map:', searchText);
            
            // Call the fullscreen map reload function that uses API with search param
            if (typeof window.reloadFullscreenMapWithFilters === 'function') {
                window.reloadFullscreenMapWithFilters();
            }
            
            // Also filter the property list on the left side
            if (typeof window.filterProperties === 'function') {
                window.filterProperties();
            }
        } else if (typeof updateMapModalWithFilters === 'function') {
            // Modal map
            console.log('üîç Applying search to modal map:', searchText);
            updateMapModalWithFilters();
        }
    };
    
    console.log('üó∫Ô∏è Map search event delegation initialized');
})();

// Clear all filters in modal
function clearMapFiltersModal() {
    if (!window.mapFilters) return;
    window.mapFilters.rooms = [];
    window.mapFilters.price_min = '';
    window.mapFilters.price_max = '';
    window.mapFilters.area_min = '';
    window.mapFilters.area_max = '';
    
    // Reset button states
    document.querySelectorAll('.quick-room-chip-modal').forEach(btn => {
        btn.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    });
    
    console.log('üó∫Ô∏è Modal filters cleared');
    updateMapModalWithFilters();
}

// Update map and sidebar when filters change in modal


// Load similar properties in sidebar
function loadMapSidebarProperties(currentPropertyId) {
    const sidebarProperties = document.getElementById('mapSidebarProperties');
    
    // Get properties from current page
    const allProperties = Array.from(document.querySelectorAll('.property-card')).map(card => {
        const propertyId = card.querySelector('.favorite-heart')?.getAttribute('data-property-id');
        const img = card.querySelector('img')?.src || 'https://via.placeholder.com/300x200';
        const title = card.querySelector('.property-title')?.textContent || '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
        const price = card.querySelector('.property-price')?.textContent || '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        const rooms = card.querySelector('.property-rooms')?.textContent || '1-–∫–æ–º–Ω';
        const area = card.querySelector('.property-area')?.textContent || '50 –º¬≤';
        
        return { id: propertyId, img, title, price, rooms, area };
    }).filter(p => p.id && p.id != currentPropertyId).slice(0, 5);
    
    if (allProperties.length === 0) {
        sidebarProperties.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">–î—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    
    sidebarProperties.innerHTML = allProperties.map(prop => `
        <div class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" onclick="window.location.href='/object/${prop.id}'">
            <img src="${prop.img}" alt="Property" class="w-full h-24 object-cover rounded-lg mb-2">
            <h4 class="font-semibold text-sm text-gray-900 line-clamp-1">${prop.title}</h4>
            <p class="text-xs text-gray-500 mb-2">${prop.rooms}, ${prop.area}</p>
            <p class="font-bold text-sm text-gray-900">${prop.price}</p>
        </div>
    `).join('');
}




// Add hover synchronization for modal map
function addModalMapHoverSync() {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer || !window.ymaps) return;
    
    const map = mapContainer.__map;
    if (!map) return;
    
    const sidebar = document.getElementById('mapSidebarProperties');
    if (!sidebar) return;
    
    // Add hover to sidebar cards
    sidebar.addEventListener('mouseenter', (e) => {
        const card = e.target.closest('[data-property-id]');
        if (!card) return;
        
        const propId = parseInt(card.dataset.propertyId);
        console.log('üéØ Hovering modal property:', propId);
        
        // Find and highlight corresponding marker
        map.geoObjects.each(geoObject => {
            if (geoObject._markerProperties) {
                const matchedProp = geoObject._markerProperties.find(p => p.id === propId);
                if (matchedProp) {
                    geoObject.options.set('preset', 'islands#redCircleIcon');
                    geoObject.options.set('zIndex', 1000);
                    console.log('üéØ Highlighted marker for property', propId);
                }
            }
        });
        
        card.classList.add('bg-blue-100', 'border-blue-500');
    }, true);
    
    sidebar.addEventListener('mouseleave', (e) => {
        const card = e.target.closest('[data-property-id]');
        if (!card) return;
        
        // Reset all markers
        map.geoObjects.each(geoObject => {
            if (geoObject._markerProperties && geoObject._originalPreset) {
                geoObject.options.set('preset', geoObject._originalPreset);
                geoObject.options.set('zIndex', 500);
            }
        });
        
        card.classList.remove('bg-blue-100', 'border-blue-500');
    }, true);
}

// Call hover sync when modal map is ready
window.addEventListener('modalMapReady', () => {
    addModalMapHoverSync();
});


// Close modal on ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('map-modal').classList.contains('hidden')) {
        closeMapModal();
    }
});

// Close modal on outside click
document.getElementById('map-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'map-modal') {
        closeMapModal();
    }
});

// Event delegation for map buttons
document.addEventListener('click', (e) => {
    if (e.target.closest('.map-btn')) {
        const btn = e.target.closest('.map-btn');
        const lat = parseFloat(btn.dataset.lat);
        const lon = parseFloat(btn.dataset.lon);
        const name = btn.dataset.name;
        const propertyId = btn.dataset.propertyId;
        
        openMapModal(lat, lon, name, propertyId);
        e.preventDefault();
        e.stopPropagation();
    }
});

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–¢–†–û–ï–ù–ù–û–ô –ö–ê–†–¢–´ –ù–ê PROPERTIES PAGE ==========
document.addEventListener('DOMContentLoaded', function() {
    const mapContainer = document.getElementById('properties-map');
    if (!mapContainer || !window.ymaps) return;
    
    console.log('üó∫Ô∏è Properties Map: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É');
    
    setTimeout(() => {
        ymaps.ready(function() {
            const map = new ymaps.Map('properties-map', {
                center: [45.3533, 39.0533],  // –¶–µ–Ω—Ç—Ä –ö—É–±–∞–Ω–∏ (–±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –≤–∏–¥)
                zoom: 9,
                controls: ['zoomControl', 'fullscreenControl']
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –æ–±—ä–µ–∫—Ç—ã —Å–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
            fetch('/api/map-properties')
                .then(response => response.json())
                .then(data => {
                    if (!data.properties || data.properties.length === 0) {
                        console.log('‚ùå –ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –≤ API');
                        return;
                    }
                    
                    console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É:', data.properties.length);
                    
                    let successCount = 0;
                    const allBounds = [];
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ö–ê–ñ–î–û–ì–û –æ–±—ä–µ–∫—Ç–∞
                    data.properties.forEach((prop, idx) => {
                        try {
                            // –í–∞–∂–Ω–æ: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ [lat, lng]
                            let lat, lng;
                            
                            if (Array.isArray(prop.coordinates)) {
                                // –§–æ—Ä–º–∞—Ç –º–∞—Å—Å–∏–≤–∞ [lat, lng]
                                [lat, lng] = prop.coordinates;
                            } else if (typeof prop.coordinates === 'object' && prop.coordinates !== null) {
                                // –§–æ—Ä–º–∞—Ç –æ–±—ä–µ–∫—Ç–∞ {lat, lng}
                                lat = prop.coordinates.lat;
                                lng = prop.coordinates.lng;
                            } else {
                                console.warn(`–û–±—ä–µ–∫—Ç ${prop.id} - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:`, prop.coordinates);
                                return;
                            }
                            
                            if (!lat || !lng) {
                                console.warn(`–û–±—ä–µ–∫—Ç ${prop.id} - –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç`);
                                return;
                            }
                            
                            // –í—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
                            let color = 'blue';
                            if (prop.status === '—Å–¥–∞–Ω') color = 'green';
                            else if (prop.status === '—Å—Ç–∞—Ä—Ç_–ø—Ä–æ–¥–∞–∂') color = 'orange';
                            
                            const preset = `islands#${color}DotIcon`;
                            const complex = prop.residential_complex_name || prop.residential_complex || '–ñ–ö';
                            
                            const placemark = new ymaps.Placemark(
                                [lat, lng],
                                { 
                                    balloonContent: `<strong>${complex}</strong><br>${prop.title || '–û–±—ä–µ–∫—Ç'}`
                                },
                                { preset: preset }
                            );
                            
                            map.geoObjects.add(placemark);
                            allBounds.push([lat, lng]);
                            successCount++;
                            
                        } catch (err) {
                            console.error(`–û—à–∏–±–∫–∞ —Å –æ–±—ä–µ–∫—Ç–æ–º ${prop.id}:`, err, prop);
                        }
                    });
                    
                    console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–≤: ${successCount} –∏–∑ ${data.properties.length}`);
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
                    if (allBounds.length > 0) {
                        try {
                            map.setBounds(allBounds, { 
                                checkZoomRange: true,
                                zoomMargin: 40
                            });
                            console.log('üéØ –ö–∞—Ä—Ç–∞ –æ—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞', allBounds.length, '—Ç–æ—á–µ–∫');
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–∞—Ä—Ç—ã:', err);
                        }
                    }
                })
                .catch(err => console.error('‚ùå Error loading map:', err));
        });
    }, 100);
});
// ========== –ö–û–ù–ï–¶ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –í–°–¢–†–û–ï–ù–ù–û–ô –ö–ê–†–¢–´ ==========

// Update fullscreen map markers based on filtered properties
function updateFullscreenMapMarkers() {
    const container = document.getElementById('fullscreenMapContainer');
    if (!container || !container.__map) {
        console.log('‚ö†Ô∏è Fullscreen map not available');
        return;
    }
    
    const map = container.__map;
    
    // Build API URL from current page filters
    const urlParams = new URLSearchParams(window.location.search);
    const apiUrl = '/api/map-properties?' + urlParams.toString();
    
    console.log('üìç Fetching all map properties from API:', apiUrl);
    
    fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                console.warn('‚ö†Ô∏è Map API error:', data.error);
                renderFullscreenMapMarkers(map, window.allProperties || []);
                return;
            }
            console.log('üìç API returned', data.properties.length, 'properties for map');
            renderFullscreenMapMarkers(map, data.properties);
        })
        .catch(err => {
            console.warn('‚ö†Ô∏è Map API fetch failed, using local data:', err);
            renderFullscreenMapMarkers(map, window.allProperties || []);
        });
}

function renderFullscreenMapMarkers(map, propertiesToShow) {
    map.geoObjects.removeAll();
    
    console.log('üìç Rendering fullscreen map with', propertiesToShow.length, 'properties');
    
    if (propertiesToShow.length === 0) {
        console.log('‚ö†Ô∏è No properties to display');
        return;
    }
    
    const grouped = {};
    propertiesToShow.forEach(prop => {
        let coordKey = 'default';
        const lat = prop.latitude || prop.lat;
        const lng = prop.longitude || prop.lng || prop.lon;
        if (lat && lng) {
            coordKey = `${parseFloat(lat).toFixed(4)}_${parseFloat(lng).toFixed(4)}`;
        }
        if (!grouped[coordKey]) {
            grouped[coordKey] = { properties: [], lat: parseFloat(lat), lng: parseFloat(lng) };
        }
        grouped[coordKey].properties.push(prop);
    });
    
    Object.values(grouped).forEach(group => {
        try {
            if (!group.lat || !group.lng || isNaN(group.lat) || isNaN(group.lng)) return;
            
            let placemark;
            if (typeof createEnhancedYandexMarker === 'function') {
                placemark = createEnhancedYandexMarker(group.properties);
            } else {
                const count = group.properties.length;
                const minPrice = Math.min(...group.properties.map(p => p.price || Infinity).filter(p => p !== Infinity));
                const priceText = minPrice !== Infinity ? Math.round(minPrice / 1000000 * 10) / 10 + '–ú' : '?';
                placemark = new ymaps.Placemark(
                    [group.lat, group.lng],
                    { balloonContent: `${count} –æ–±—ä–µ–∫—Ç–æ–≤ –æ—Ç ${priceText}‚ÇΩ` },
                    { preset: 'islands#blueCircleDotIcon' }
                );
            }
            
            if (placemark) {
                placemark._properties = group.properties;
                placemark._originalPreset = placemark.options.get('preset');
                map.geoObjects.add(placemark);
            }
        } catch (e) {
            console.warn('Error adding marker:', e);
        }
    });
    
    console.log('‚úÖ Updated', Object.keys(grouped).length, 'markers on fullscreen map');
    
    addFullscreenMapHoverSync();
}

// Hover sync for fullscreen map
function addFullscreenMapHoverSync() {
    const container = document.getElementById('fullscreenMapContainer');
    if (!container || !container.__map) return;
    
    const map = container.__map;
    const cards = document.querySelectorAll('[data-property-id]');
    
    if (cards.length === 0) {
        console.log('‚ö†Ô∏è No property cards found for hover sync');
        return;
    }
    
    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            const propId = parseInt(card.dataset.propertyId);
            console.log('üéØ Hovering property:', propId);
            
            // Find and highlight marker
            map.geoObjects.each(placemark => {
                if (placemark._properties) {
                    const match = placemark._properties.find(p => p.id === propId);
                    if (match) {
                        placemark.options.set('preset', 'islands#redCircleIcon');
                        placemark.options.set('zIndex', 1000);
                        console.log('üéØ Highlighted marker for', propId);
                    }
                }
            });
            
            card.classList.add('bg-blue-100', 'border-blue-500');
        });
        
        card.addEventListener('mouseleave', () => {
            // Reset markers
            map.geoObjects.each(placemark => {
                if (placemark._originalPreset) {
                    placemark.options.set('preset', placemark._originalPreset);
                    placemark.options.set('zIndex', 500);
                }
            });
            
            card.classList.remove('bg-blue-100', 'border-blue-500');
        });
    });
    
    console.log('‚úÖ Hover sync enabled for', cards.length, 'cards');
}

function toggleMobileFilters() {
    const expanded = document.getElementById('mob-filters-expanded');
    const chevron = document.getElementById('mob-filters-chevron');
    if (expanded) {
        expanded.classList.toggle('hidden');
        if (chevron) {
            chevron.style.transform = expanded.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const filtersList = document.getElementById('active-filters-list');
    const countEl = document.getElementById('mob-active-filters-count');
    if (filtersList && countEl) {
        const chips = filtersList.querySelectorAll('span.inline-flex, .active-filter-chip');
        countEl.textContent = chips.length;
    }
});

</script>

{% endblock %}
