{% extends "base.html" %}
{% set city_slug = current_city.slug if current_city else (session.city_slug if session.city_slug else 'krasnodar') %}

{% block title %}{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м²{% endif %} в {{ current_city.name_prepositional if current_city else 'Краснодаре' }} - {{ property.complex_name or 'ЖК' }} с кэшбеком{% endblock %}

{% block description %}{% if property.rooms == 0 %}Студия площадью {{ property.area }} м² в ЖК {{ property.complex_name }} - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽. Кэшбек до {{ (property.cashback_percent or 4.0)|round(1) }}% при покупке. {{ current_city.name if current_city else 'Краснодар' }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м² в ЖК {{ property.complex_name }} - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽. Кэшбек до {{ (property.cashback_percent or 4.0)|round(1) }}% при покупке. {{ current_city.name if current_city else 'Краснодар' }}{% endif %}{% endblock %}

{% block og_title %}{% if property.rooms == 0 %}Студия {{ property.area }} м² в ЖК {{ property.complex_name }} - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽{% else %}{{ property.rooms }}-комнатная {{ property.area }} м² в ЖК {{ property.complex_name }} - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽{% endif %}{% endblock %}

{% block og_description %}{% if property.rooms == 0 %}Студия площадью {{ property.area }} м² в ЖК {{ property.complex_name }}. Цена {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽. Кэшбек до {{ (property.cashback_percent or 4.0)|round(1) }}% от InBack{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м² в ЖК {{ property.complex_name }}. Цена {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽. Кэшбек до {{ (property.cashback_percent or 4.0)|round(1) }}% от InBack{% endif %}{% endblock %}

{% block twitter_title %}{% if property.rooms == 0 %}Студия {{ property.area }} м² - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽{% else %}{{ property.rooms }}-комн. {{ property.area }} м² - {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽{% endif %}{% endblock %}

{% block twitter_description %}ЖК {{ property.complex_name }}. Кэшбек до {{ (property.cashback_percent or 4.0)|round(1) }}%. {{ current_city.name if current_city else 'Краснодар' }}{% endblock %}

{% block keywords %}купить квартиру {{ current_city.name if current_city else 'Краснодар' }}, {{ property.complex_name }}, квартира в новостройке {{ current_city.name if current_city else 'Краснодар' }}, {{ property.rooms }}-комнатная квартира {{ current_city.name if current_city else 'Краснодар' }}, квартира с кэшбеком, новостройка {{ current_city.name if current_city else 'Краснодар' }}, ЖК {{ property.complex_name }} цены, квартира от застройщика {{ current_city.name if current_city else 'Краснодар' }}, купить квартиру в ипотеку {{ current_city.name if current_city else 'Краснодар' }}, квартира {{ property.area }} м², недвижимость {{ current_city.name if current_city else 'Краснодар' }}, купить квартиру с отделкой, квартира в ЖК {{ property.complex_name }}, новостройка с кэшбеком {{ current_city.name if current_city else 'Краснодар' }}, купить квартиру недорого {{ current_city.name if current_city else 'Краснодар' }}, квартира в новостройке Краснодарский край, ипотека на квартиру {{ current_city.name if current_city else 'Краснодар' }}, семейная ипотека квартира, военная ипотека квартира, IT ипотека квартира{% endblock %}

{% block canonical %}{{ url_for('property_detail', property_id=property.id, _external=True) }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Property-specific Open Graph image -->
{% if property.gallery and property.gallery|length > 0 %}
<meta property="og:image" content="{{ property.gallery[0] }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
{% elif property.image %}
<meta property="og:image" content="{{ property.image }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
{% endif %}

<!-- Apartment Schema for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Apartment",
  "name": {% if property.title %}{{ property.title|tojson }}{% elif property.rooms == 0 %}{{ ("Студия " ~ property.area|string ~ " м²")|tojson }}{% else %}{{ ((property.rooms|string) ~ "-комнатная квартира " ~ property.area|string ~ " м²")|tojson }}{% endif %},
  "description": {% if property.rooms == 0 %}{{ ("Студия площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ " с кэшбеком до " ~ (property.cashback_percent or 5)|string ~ "%")|tojson }}{% else %}{{ ((property.rooms|string) ~ "-комнатная квартира площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ " с кэшбеком до " ~ (property.cashback_percent or 5)|string ~ "%")|tojson }}{% endif %},
  "numberOfRooms": {{ property.rooms or 0 }},
  "floorSize": {
    "@type": "QuantitativeValue",
    "value": {{ property.area }},
    "unitCode": "MTK"
  },
  {% if property.full_address or property.address %}
  "address": {
    "@type": "PostalAddress",
    "streetAddress": {{ (property.full_address or property.address)|tojson }},
    "addressLocality": {{ (property.address_locality_display_name or property.district or (current_city.name if current_city else 'Краснодар'))|tojson }},
    "addressRegion": {{ (current_city.region.name if current_city and current_city.region else 'Краснодарский край')|tojson }},
    "addressCountry": "RU"
  },
  {% endif %}
  {% if property.address_position_lat and property.address_position_lon %}
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": {{ property.address_position_lat }},
    "longitude": {{ property.address_position_lon }}
  },
  {% endif %}
  "offers": {
    "@type": "Offer",
    "price": {{ property.price|tojson }},
    "priceCurrency": "RUB",
    "availability": "https://schema.org/InStock",
    "seller": {
      "@type": "Organization",
      "name": "InBack.ru"
    }
  },
  {% if property.floor %}
  "floorLevel": {{ property.floor|tojson }},
  {% endif %}
  {% if property.total_floors %}
  "numberOfBathroomsTotal": 1,
  {% endif %}
  {% if property.developer %}
  "landlord": {
    "@type": "Organization",
    "name": {{ property.developer|tojson }}
  },
  {% endif %}
  {% if property.image or (property.gallery and property.gallery|length > 0) %}
  "image": [
    {% if property.gallery and property.gallery|length > 0 %}
      {% for image in property.gallery %}
        {{ image|tojson }}{% if not loop.last %},{% endif %}
      {% endfor %}
    {% elif property.image %}
      {{ property.image|tojson }}
    {% endif %}
  ],
  {% endif %}
  "amenityFeature": [
    {% if property.finishing or property.renovation %}
    {
      "@type": "LocationFeatureSpecification",
      "name": "Отделка",
      "value": {{ (property.finishing or property.renovation)|tojson }}
    }{% if property.completion_date %},{% endif %}
    {% endif %}
    {% if property.completion_date %}
    {
      "@type": "LocationFeatureSpecification",
      "name": "Срок сдачи",
      "value": {{ property.completion_date|tojson }}
    }
    {% endif %}
  ],
  "containedInPlace": {
    "@type": "ApartmentComplex",
    "name": {{ property.complex_name|tojson }}
  }
}
</script>

<!-- Structured Data JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Главная",
          "item": "{{ url_for('index', _external=True) }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Новостройки",
          "item": "{{ url_for('properties', _external=True) }}"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": {% if property.title %}{{ property.title|tojson }}{% elif property.rooms == 0 %}{{ ("Студия " ~ property.area|string ~ " м²")|tojson }}{% else %}{{ ((property.rooms|string) ~ "-комнатная квартира " ~ property.area|string ~ " м²")|tojson }}{% endif %},
          "item": "{{ url_for('property_detail', property_id=property.id, _external=True) }}"
        }
      ]
    },
    {
      "@type": "WebPage",
      "name": {% if property.rooms == 0 %}{{ ("Студия " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name)|tojson }}{% else %}{{ ((property.rooms|string) ~ "-комнатная квартира " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name)|tojson }}{% endif %},
      "description": {% if property.rooms == 0 %}{{ ("Студия площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ ". Цена " ~ (property.price|int)|string ~ " ₽")|tojson }}{% else %}{{ ((property.rooms|string) ~ "-комнатная квартира площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ ". Цена " ~ (property.price|int)|string ~ " ₽")|tojson }}{% endif %},
      "url": "{{ url_for('property_detail', property_id=property.id, _external=True) }}",
      "inLanguage": "ru-RU",
      "publisher": {
        "@type": "Organization",
        "name": "InBack",
        "url": "{{ url_for('index', _external=True) }}"
      }
    }
  ]
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": {% if property.rooms == 0 %}{{ ("Какая цена студии в ЖК " ~ property.complex_name ~ "?")|tojson }}{% else %}{{ ("Какая цена " ~ property.rooms|string ~ "-комнатной квартиры в ЖК " ~ property.complex_name ~ "?")|tojson }}{% endif %},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {% if property.rooms == 0 %}{{ ("Цена студии площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ " составляет " ~ '{:,.0f}'.format(property.price|float) ~ " ₽. При покупке через InBack вы получите кэшбек до " ~ (property.cashback_percent or 5)|string ~ "% от стоимости.")|tojson }}{% else %}{{ ("Цена " ~ property.rooms|string ~ "-комнатной квартиры площадью " ~ property.area|string ~ " м² в ЖК " ~ property.complex_name ~ " составляет " ~ '{:,.0f}'.format(property.price|float) ~ " ₽. При покупке через InBack вы получите кэшбек до " ~ (property.cashback_percent or 5)|string ~ "% от стоимости.")|tojson }}{% endif %}
      }
    },
    {
      "@type": "Question",
      "name": {{ ("Какой кэшбек можно получить при покупке квартиры в ЖК " ~ property.complex_name ~ "?")|tojson }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ ("При покупке квартиры в ЖК " ~ property.complex_name ~ " через InBack вы получаете кэшбек от 2.5% до " ~ (property.cashback_percent or 5)|string ~ "% от стоимости квартиры. Это возврат части комиссии напрямую покупателю без посредников.")|tojson }}
      }
    },
    {
      "@type": "Question",
      "name": {{ ("Можно ли купить квартиру в ЖК " ~ property.complex_name ~ " в ипотеку?")|tojson }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ ("Да, квартиры в ЖК " ~ property.complex_name ~ " доступны по всем ипотечным программам: семейная ипотека от 3.5%, IT ипотека от 3.5%, военная ипотека, стандартная ипотека. При покупке через InBack кэшбек совместим с любой ипотечной программой.")|tojson }}
      }
    },
    {
      "@type": "Question",
      "name": {{ ("Когда сдаётся ЖК " ~ property.complex_name ~ "?")|tojson }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {% if property.completion_date %}{{ ("Срок сдачи ЖК " ~ property.complex_name ~ ": " ~ property.completion_date ~ ". Уточните актуальные сроки у наших менеджеров по телефону.")|tojson }}{% else %}{{ ("Уточните актуальные сроки сдачи ЖК " ~ property.complex_name ~ " у наших менеджеров. Мы поможем подобрать оптимальный вариант и оформить кэшбек.")|tojson }}{% endif %}
      }
    }
  ]
}
</script>

<style>
.custom-property-marker {
    background: transparent !important;
    border: none !important;
}

.property-gallery-dot.active {
    background-color: white !important;
}

.gallery-slides {
    transition: transform 0.5s ease-in-out;
}

.safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 0px);
}

@media (max-width: 767px) {
    .max-w-6xl { max-width: 100% !important; }
    .gallery-container { touch-action: pan-x; }
    .gallery-slides img { object-fit: cover; }
    h1 { font-size: 1.25rem !important; line-height: 1.75rem !important; }
    h2 { font-size: 1.125rem !important; }
    .property-gallery-dot { width: 8px; height: 8px; }
    body { overflow-x: hidden; }
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="hidden md:block container mx-auto px-4 py-3 text-sm">
    <nav aria-label="Breadcrumb" class="flex">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a class="text-[#0088CC] hover:underline inline-flex items-center" href="/">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Главная
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <a href="{{ url_for('properties') }}" class="text-[#0088CC] hover:underline ml-1 md:ml-2">Новостройки</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-500 ml-1 md:ml-2">
                        {% if property.title %}
                            {{ property.title }}
                        {% elif property.rooms == 0 %}
                            Студия {{ property.area }} м²
                        {% else %}
                            {{ property.rooms }}-комнатная квартира {{ property.area }} м²
                        {% endif %}
                    </span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="max-w-6xl mx-auto px-4 py-4 md:py-8 pb-20 md:pb-8">
    <!-- Кэшбек баннер (hidden on mobile) -->
    <div class="hidden md:block bg-gradient-to-r from-[#006699] to-[#0088CC] rounded-2xl p-4 md:p-6 text-white mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="mb-4 md:mb-0">
                <h2 class="text-lg md:text-2xl font-bold mb-2">Получите кэшбек при покупке этой квартиры!</h2>
                <p class="opacity-90 text-sm md:text-base">Приобретая эту квартиру через наш сервис, вы получите кэшбек до {{ property.cashback_percent or 5 }}% от стоимости.</p>
            </div>
            <button onclick="openCashbackModal()" class="w-full md:w-auto mt-3 md:mt-0 bg-white text-[#0088CC] hover:bg-opacity-90 font-semibold px-6 py-3 rounded-xl whitespace-nowrap transition-all">
                Получить кэшбек
            </button>
        </div>
    </div>

    <!-- Основная карточка -->
    <div class="bg-white rounded-2xl overflow-hidden shadow-lg mb-8">
        <!-- Галерея -->
        <div class="relative">
            <!-- Favorite Heart Button -->
            <div class="absolute top-4 right-4 z-20">
                <div class="favorite-heart" data-property-id="{{ property.id }}" title="Добавить в избранное">
                    <i class="fas fa-heart"></i>
                </div>
            </div>
            
            <div class="h-72 md:h-96 bg-gray-200 overflow-hidden gallery-container">
                <div class="gallery-slides flex h-full transition-transform duration-500">
                    {% if property.gallery and property.gallery|length > 0 %}
                        {% for image in property.gallery %}
                        <div class="gallery-slide min-w-full h-full">
                            <img alt="{% if property.title %}{{ property.title }}{% elif property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комнатная квартира{% endif %} - фото {{ loop.index }}" class="w-full h-full object-contain bg-gray-50 cursor-pointer" src="{{ image }}" onclick="openPhotoModal({{ loop.index0 }})"/>
                        </div>
                        {% endfor %}
                    {% elif property.image and 'placeholder' not in property.image %}
                        <div class="gallery-slide min-w-full h-full">
                            <img alt="{% if property.title %}{{ property.title }}{% elif property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комнатная квартира{% endif %}" class="w-full h-full object-contain bg-gray-50 cursor-pointer" src="{{ property.image }}" onclick="openPhotoModal(0)"/>
                        </div>
                    {% else %}
                        <div class="gallery-slide min-w-full h-full">
                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100">
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-home text-4xl mb-2 text-gray-400"></i>
                                    <p class="text-lg font-medium">{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комнатная квартира{% endif %}</p>
                                    <p class="text-sm">{{ property.area }} м² • ЖК {{ property.complex_name }}</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Navigation buttons -->
                {% if (property.gallery and property.gallery|length > 1) or (property.image and 'placeholder' not in property.image) %}
                <button onclick="prevPropertySlide()" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-sm rounded-full hidden md:flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="nextPropertySlide()" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-sm rounded-full hidden md:flex items-center justify-center text-gray-600 hover:bg-white transition-all z-10">
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
                
                <!-- Dots indicator -->
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
                    {% if property.gallery and property.gallery|length > 0 %}
                        {% for image in property.gallery %}
                        <div class="property-gallery-dot w-2.5 h-2.5 md:w-2 md:h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors{% if loop.first %} active{% endif %}" onclick="goToPropertySlide({{ loop.index0 }})"></div>
                        {% endfor %}
                    {% elif property.image and 'placeholder' not in property.image %}
                        <div class="property-gallery-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors active" onclick="goToPropertySlide(0)"></div>
                    {% else %}
                        <div class="property-gallery-dot w-2 h-2 bg-white/60 rounded-full cursor-pointer hover:bg-white transition-colors active" onclick="goToPropertySlide(0)"></div>
                    {% endif %}
                </div>
            </div>
            
            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-sm font-medium flex items-center">
                <i class="fas fa-camera mr-2 text-[#0088CC]"></i>
                <span>{{ property.gallery|length if property.gallery and property.gallery|length > 0 else 1 }} фото</span>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-[1fr_320px] gap-6">

                <!-- BLOCK 1: Цена — order-1 mobile (right after title), right col row 1 desktop -->
                <div class="order-1 md:order-2 md:col-start-2 md:row-start-1">
                    <!-- Цена -->
                    <div class="bg-gray-50 rounded-xl p-4 md:p-6 mb-4 md:mb-6">
                        <div class="hidden md:flex items-center justify-between mb-4">
                            <h3 class="font-bold">Стоимость квартиры</h3>
                        </div>
                        <div class="text-2xl md:text-2xl font-bold mb-2 md:mb-4 bg-gradient-to-r from-[#006699] to-[#0088CC] bg-clip-text text-transparent">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                        <div class="flex items-center gap-3 mb-2 md:mb-3 text-sm text-gray-500">
                            <span>{{ "{:,.0f}".format(property.price / property.area).replace(',', ' ') }} ₽/м²</span>
                        </div>
                        <div class="bg-[#0088CC]/5 border border-[#0088CC]/20 rounded-lg p-3 mb-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">Выгода с InBack</span>
                                <span class="text-lg font-bold text-[#0088CC]">до {{ "{:,.0f}".format(property.cashback_amount).replace(',', ' ') }} ₽</span>
                            </div>
                        </div>
                        <button onclick="openApplicationModal({
                            property_id: '{{ property.id }}',
                            property_name: '{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м²{% endif %}',
                            complex_name: '{{ property.complex_name or '' }}',
                            price: '{{ property.price or 0 }}',
                            area: '{{ property.area or 0 }}',
                            floor: '{{ property.floor or 0 }}',
                            rooms: '{{ property.rooms or 0 }}',
                            district: '{{ property.district or '' }}',
                            address: '{{ property.address or '' }}'
                        })" class="w-full bg-gradient-to-r from-[#006699] to-[#0088CC] hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-xl transition-all mb-3">
                            Посмотреть квартиру
                        </button>
                        
                        <!-- PDF и поделиться — desktop only -->
                        <div class="hidden md:flex gap-2 mb-3">
                            <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-3 rounded-lg text-center text-sm transition-all">
                                <i class="fas fa-file-pdf mr-1"></i>
                                PDF
                            </a>
                            <button onclick="shareProperty()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-3 rounded-lg text-sm transition-all">
                                <i class="fas fa-share-alt mr-1"></i>
                                Поделиться
                            </button>
                        </div>
                    </div>
                </div>

                <!-- BLOCK 2: Описание лота — order-2 mobile (after price), left col spanning rows desktop -->
                <div class="order-2 md:order-1 md:col-start-1 md:row-start-1 md:row-span-6">
                    <!-- Заголовок и метки -->
                    <div class="mb-4">
                        <h1 class="text-2xl md:text-3xl font-bold mb-2">{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м²{% endif %}</h1>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-gray-100 text-[#0088CC] px-3 py-1 rounded-full text-sm">Новостройка</span>
                            <span class="bg-gray-100 text-[#7e5bef] px-3 py-1 rounded-full text-sm">{{ property.finishing or property.renovation or "Чистовая отделка" }}</span>
                            <span class="bg-gray-100 text-green-700 px-3 py-1 rounded-full text-sm">{{ property.floor }}/{{ property.total_floors }} этаж</span>
                            {% if property.balcony %}
                            <span class="bg-gray-100 text-yellow-700 px-3 py-1 rounded-full text-sm">Балкон {{ property.balcony_area }} м²</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="mb-6">
                        <div class="flex items-center text-gray-600 mb-1">
                            <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                            <span>{{ property.full_address or property.location or property.address or ((property.complex_name or 'ЖК') + ', ' + (property.district or '')) }}</span>
                        </div>
                        <p class="text-sm text-gray-500">Рядом: {{ property.nearby or "торговые центры, парки, школы" }}</p>
                        <button onclick="scrollToMap()" class="mt-2 inline-flex items-center gap-2 text-sm text-[#0088CC] hover:text-[#006699] font-medium transition-colors">
                            <i class="fas fa-map-marked-alt"></i>
                            Показать на карте
                        </button>
                    </div>

                    <!-- Характеристики -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 md:grid-cols-3 md:gap-4 mb-6 text-sm md:text-base">
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Площадь</p>
                            <p class="font-semibold">{{ property.area }} м²</p>
                        </div>
                        {% if property.kitchen_area %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Кухня</p>
                            <p class="font-semibold">{{ property.kitchen_area }} м²</p>
                        </div>
                        {% endif %}
                        {% if property.living_area %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Жилая площадь</p>
                            <p class="font-semibold">{{ property.living_area }} м²</p>
                        </div>
                        {% endif %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Этаж</p>
                            <p class="font-semibold">{{ property.floor }} из {{ property.total_floors }}</p>
                        </div>
                        {% if property.ceiling_height %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Высота потолков</p>
                            <p class="font-semibold">{{ property.ceiling_height }} м</p>
                        </div>
                        {% endif %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Вид из окна</p>
                            <p class="font-semibold">{{ property.view or "Двор" }}</p>
                        </div>
                        {% if property.completion_date %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Срок сдачи</p>
                            <p class="font-semibold">{{ property.completion_date }}</p>
                        </div>
                        {% endif %}
                        {% if property.developer %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Застройщик</p>
                            <p class="font-semibold">{{ property.developer }}</p>
                        </div>
                        {% endif %}
                        {% if property.class_type %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Класс жилья</p>
                            <p class="font-semibold">{{ property.class_type }}</p>
                        </div>
                        {% endif %}
                        {% if property.complex_building_released is defined %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Статус объекта</p>
                            <p class="font-semibold {% if property.complex_building_released %}text-green-600{% else %}text-orange-600{% endif %}">
                                {% if property.complex_building_released %}Сдан{% else %}Строится{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        {% if property.renovation_display_name %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Отделка</p>
                            <p class="font-semibold">{{ property.renovation_display_name }}</p>
                        </div>
                        {% endif %}
                        {% if property.square_price %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Цена за м²</p>
                            <p class="font-semibold">{{ "{:,.0f}".format(property.square_price).replace(',', ' ') }} ₽/м²</p>
                        </div>
                        {% endif %}
                        {% if property.building_name %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Корпус</p>
                            <p class="font-semibold">{{ property.building_name }}</p>
                        </div>
                        {% endif %}
                        {% if property.total_floors and property.floor %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Этажи в корпусе</p>
                            <p class="font-semibold">{{ property.floor }}—{{ property.total_floors }}</p>
                        </div>
                        {% endif %}
                        {% if property.deal_type %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Тип сделки</p>
                            <p class="font-semibold">
                                {% if property.deal_type == 'sale' %}Продажа{% else %}{{ property.deal_type }}{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        {% if property.complex_start_build_year and property.complex_first_build_quarter %}
                        <div class="py-1 border-b border-gray-100 md:border-0 md:py-0">
                            <p class="text-gray-400 text-xs md:text-sm">Начало строительства</p>
                            <p class="font-semibold">{{ property.complex_first_build_quarter }} кв. {{ property.complex_start_build_year }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Mobile Mini Map (after specs) -->
                    <div class="md:hidden mb-6 rounded-xl overflow-hidden border border-gray-200 shadow-sm">
                        <div id="property-mobile-map" class="w-full h-48"></div>
                        <div class="px-3 py-2.5 bg-gray-50 flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-600 min-w-0">
                                <i class="fas fa-map-marker-alt text-[#0088CC]"></i>
                                <span class="truncate">{{ property.full_address or property.address or ((property.address_locality_display_name or 'Краснодар') + ', ' + (property.complex_name or 'ЖК')) }}</span>
                            </div>
                            <a href="https://yandex.ru/maps/?pt={{ property.address_position_lon or property.longitude or 39.0 }},{{ property.address_position_lat or property.latitude or 45.0 }}&z=16&l=map" target="_blank" class="text-xs text-[#0088CC] font-medium whitespace-nowrap ml-2">Открыть</a>
                        </div>
                    </div>

                    <!-- Ипотека и финансирование -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-4">Ипотека и финансирование</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold mb-3 text-[#0088CC]">Доступные программы</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                        <span class="text-sm">Ипотека</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                        <span class="text-sm">Семейная ипотека</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                        <span class="text-sm">IT ипотека</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                        <span class="text-sm">Рассрочка</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold mb-3 text-gray-600">Дополнительно</h4>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Консультация эксперта</span>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Помощь с документами</span>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Юридическое сопровождение</span>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Расчет кэшбека</span>
                                </div>
                                
                                {% if property.balcony and property.balcony != 'Нет' %}
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Балкон: {{ property.balcony }} {% if property.balcony_area %}{{ property.balcony_area }} м²{% endif %}</span>
                                </div>
                                {% endif %}
                                {% if property.ceiling_height and property.ceiling_height != 'Нет' %}
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Высота потолков: {{ property.ceiling_height }} м</span>
                                </div>
                                {% endif %}
                                {% if property.kitchen_area %}
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Кухня: {{ property.kitchen_area }} м²</span>
                                </div>
                                {% endif %}
                                {% if property.renovation_display_name %}
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                    <span class="text-sm">Отделка: {{ property.renovation_display_name }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ваш менеджер / Контакты компании -->
                    <div class="mb-6 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-sm border border-blue-100">
                        {% if manager %}
                        <!-- Персональный менеджер -->
                        <div class="flex items-start gap-3 md:gap-4">
                            <!-- Фото менеджера -->
                            <div class="flex-shrink-0">
                                {% if manager.photo %}
                                <img src="{{ manager.photo }}" alt="{{ manager.name }}" class="w-14 h-14 md:w-20 md:h-20 rounded-full object-cover border-2 border-white shadow-md">
                                {% else %}
                                <div class="w-14 h-14 md:w-20 md:h-20 rounded-full bg-gradient-to-br from-[#0088CC] to-blue-600 flex items-center justify-center text-white text-lg md:text-2xl font-bold border-2 border-white shadow-md">
                                    {{ manager.name.split()[0][0] }}{{ manager.name.split()[1][0] if manager.name.split()|length > 1 else '' }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Информация о менеджере -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-base md:text-xl text-gray-900 mb-1">{{ manager.name }}</h3>
                                <p class="text-xs md:text-sm text-gray-600 mb-3 md:mb-4">Получите бесплатную помощь от нашего менеджера по покупке новостройки</p>
                                
                                <div class="space-y-2">
                                    <!-- Телефон -->
                                    <a href="tel:{{ manager.phone }}" class="flex items-center gap-2 md:gap-3 text-gray-700 hover:text-[#0088CC] transition-colors group">
                                        <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-white flex items-center justify-center group-hover:bg-[#0088CC]/10 transition-colors flex-shrink-0">
                                            <i class="fas fa-phone text-[#0088CC] text-sm md:text-base"></i>
                                        </div>
                                        <span class="font-medium text-sm md:text-base truncate">{{ manager.phone }}</span>
                                    </a>
                                    
                                    <!-- Email - скрыт на маленьких экранах -->
                                    <a href="mailto:{{ manager.email }}" class="hidden md:flex items-center gap-3 text-gray-700 hover:text-[#0088CC] transition-colors group">
                                        <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center group-hover:bg-[#0088CC]/10 transition-colors">
                                            <i class="fas fa-envelope text-[#0088CC]"></i>
                                        </div>
                                        <span class="font-medium">{{ manager.email }}</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Контакты компании (если менеджера нет) -->
                        <div class="flex items-start gap-3 md:gap-4">
                            <!-- Логотип компании -->
                            <div class="flex-shrink-0">
                                <div class="w-14 h-14 md:w-20 md:h-20 rounded-full bg-gradient-to-br from-[#0088CC] to-blue-600 flex items-center justify-center text-white shadow-md">
                                    <i class="fas fa-building text-2xl md:text-3xl"></i>
                                </div>
                            </div>
                            
                            <!-- Информация о компании -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-base md:text-xl text-gray-900 mb-1">InBack</h3>
                                <p class="text-xs md:text-sm text-gray-600 mb-3 md:mb-4">Получите бесплатную консультацию по покупке новостройки с кэшбеком</p>
                                
                                <div class="space-y-2">
                                    <!-- Телефон компании -->
                                    <a href="tel:+78622666216" class="flex items-center gap-2 md:gap-3 text-gray-700 hover:text-[#0088CC] transition-colors group">
                                        <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-white flex items-center justify-center group-hover:bg-[#0088CC]/10 transition-colors flex-shrink-0">
                                            <i class="fas fa-phone text-[#0088CC] text-sm md:text-base"></i>
                                        </div>
                                        <span class="font-medium text-sm md:text-base">8 (862) 266-62-16</span>
                                    </a>
                                    
                                    <!-- Email компании - скрыт на маленьких экранах -->
                                    <a href="mailto:info@inback.ru" class="hidden md:flex items-center gap-3 text-gray-700 hover:text-[#0088CC] transition-colors group">
                                        <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center group-hover:bg-[#0088CC]/10 transition-colors">
                                            <i class="fas fa-envelope text-[#0088CC]"></i>
                                        </div>
                                        <span class="font-medium">info@inback.ru</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Описание -->
                    {% if property.description or property.detailed_description %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Об этой квартире</h3>
                        {% if property.description %}
                        <p class="text-gray-700 mb-3">
                            {{ property.description }}
                        </p>
                        {% endif %}
                        {% if property.detailed_description %}
                        <p class="text-gray-700">
                            {{ property.detailed_description }}
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Варианты отделки -->
                    {% if property.finish_options %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Варианты отделки</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {% for option in property.finish_options %}
                            <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all">
                                {% if option.image %}
                                <div class="h-32 bg-gray-200 overflow-hidden">
                                    <img src="{{ option.image }}" alt="{{ option.type }}" class="w-full h-full object-cover">
                                </div>
                                {% endif %}
                                <div class="p-4">
                                    <div class="font-semibold mb-2">{{ option.type }}</div>
                                    <p class="text-sm text-gray-600 mb-3">{{ option.description }}</p>
                                    <div class="text-sm space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Стены:</span>
                                            <span>{{ option.details.walls }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Пол:</span>
                                            <span>{{ option.details.floor }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Санузел:</span>
                                            <span>{{ option.details.bathroom }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            <p>Фото отделки представлены для примера. Фактическая отделка может отличаться.</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Инфраструктура -->
                    {% if property.infrastructure %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Инфраструктура</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            {% for amenity in property.infrastructure %}
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-[#0088CC]/10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-sm text-[#0088CC]"></i>
                                </div>
                                <div>
                                    <span class="text-sm">{{ amenity }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Преимущества -->
                    {% if property.advantages %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Преимущества</h3>
                        <div class="space-y-3">
                            {% for advantage in property.advantages %}
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-1 text-[#0088CC]">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <p class="text-gray-700">{{ advantage }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- BLOCK 3: Кэшбек — order-3 mobile, right col row 2 desktop -->
                <div class="order-3 md:col-start-2 md:row-start-2">
                    <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-100">
                        <h3 class="font-bold text-lg mb-3 text-[#0088CC]">Ваша выгода</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-2xl font-bold text-[#0088CC]">до {{ "{:,.0f}".format(property.cashback_amount).replace(',', ' ') }} ₽</span>
                        </div>
                        <div class="text-sm text-gray-500 mb-4">
                            до {{ property.cashback_percent }}% от стоимости квартиры
                        </div>
                        <p class="text-sm text-gray-600 mb-4">
                            При покупке этой квартиры через наш сервис вы получаете дополнительный кэшбек на карту после сделки.
                        </p>
                        <button onclick="openCashbackModal()" class="w-full bg-white hover:bg-gray-50 text-[#0088CC] font-semibold py-3 px-4 rounded-xl border border-[#0088CC] transition-all">
                            Получить кэшбек
                        </button>
                    </div>
                </div>

                <!-- BLOCK 4: Калькулятор — order-4 mobile, right col row 3 desktop -->
                <div class="order-4 md:col-start-2 md:row-start-3">
                    <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
                        <div class="flex items-center gap-2.5 mb-5">
                            <div class="w-8 h-8 bg-[#0088CC]/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calculator text-[#0088CC] text-sm"></i>
                            </div>
                            <h3 class="font-bold text-base text-gray-900">Семейная ипотека</h3>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-1">Стоимость квартиры</div>
                        <div class="font-bold text-lg text-gray-900 mb-4">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                        
                        <div class="grid grid-cols-3 gap-2.5 mb-4">
                            <div>
                                <label class="block text-[11px] text-gray-400 mb-1">Взнос, %</label>
                                <input type="number" id="mortgage-down-payment" value="20" min="10" max="80"
                                       class="w-full py-2 px-2 text-sm border border-gray-200 rounded-lg text-center focus:border-[#0088CC] focus:ring-1 focus:ring-[#0088CC]/20 outline-none transition-colors min-h-[44px]">
                            </div>
                            <div>
                                <label class="block text-[11px] text-gray-400 mb-1">Ставка, %</label>
                                <input type="number" id="mortgage-rate" value="6.0" step="0.1" min="3" max="20"
                                       class="w-full py-2 px-2 text-sm border border-gray-200 rounded-lg text-center focus:border-[#0088CC] focus:ring-1 focus:ring-[#0088CC]/20 outline-none transition-colors min-h-[44px]">
                            </div>
                            <div>
                                <label class="block text-[11px] text-gray-400 mb-1">Срок, лет</label>
                                <input type="number" id="mortgage-term" value="30" min="5" max="30"
                                       class="w-full py-2 px-2 text-sm border border-gray-200 rounded-lg text-center focus:border-[#0088CC] focus:ring-1 focus:ring-[#0088CC]/20 outline-none transition-colors min-h-[44px]">
                            </div>
                        </div>
                        
                        <div id="family-mortgage-limit-warning" class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 text-sm" style="display: none;">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-info-circle text-amber-500 mt-0.5"></i>
                                <div class="text-amber-700 text-xs">
                                    <strong>Лимит:</strong> макс. 6 млн ₽. Превышение добавлено к взносу.
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 pt-4 mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Первый взнос</span>
                                <span id="mortgage-down-amount" class="text-sm font-medium text-gray-700">{{ "{:,.0f}".format(property.price * 0.2).replace(',', ' ') }} ₽</span>
                            </div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-400">Сумма кредита</span>
                                <span id="loan-amount" class="text-sm font-medium text-gray-700">{{ "{:,.0f}".format(property.price * 0.8).replace(',', ' ') }} ₽</span>
                            </div>
                            <div class="bg-[#0088CC]/5 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500">Платёж в месяц</span>
                                    <span id="monthly-payment" class="text-xl font-bold text-[#0088CC]">—</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="openApplicationModal()" class="w-full bg-[#0088CC] hover:bg-[#006699] text-white font-semibold py-2.5 px-4 rounded-lg transition-colors text-sm">
                            Подать заявку на ипотеку
                        </button>
                        
                        <p class="text-[11px] text-gray-400 mt-3 text-center">
                            Предварительный расчёт. Условия определяет банк.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Планировка -->
    {% if property.layout_image %}
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6">Планировка квартиры</h2>
        <div class="flex justify-center">
            <img alt="Планировка {{ property.title }}" class="max-w-full h-auto rounded-xl" src="{{ property.layout_image }}"/>
        </div>
    </div>
    {% endif %}

    <!-- Информация о здании -->
    {% if property.building_info %}
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6">О доме</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <p class="text-gray-500 text-sm">Тип дома</p>
                <p class="font-semibold">{{ property.building_info.type }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Класс</p>
                <p class="font-semibold">{{ property.building_info.class }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Год постройки</p>
                <p class="font-semibold">{{ property.building_info.year }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Лифты</p>
                <p class="font-semibold">{{ property.building_info.elevator }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Продающий блок "Запишитесь на онлайн показ" -->
    <div class="mb-8 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-2xl p-4 md:p-8 border border-blue-100 relative overflow-hidden">
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex-1">
                <h3 class="text-xl md:text-3xl font-bold mb-3 text-gray-800">Запишитесь на онлайн показ</h3>
                <p class="text-gray-600 text-sm md:text-lg max-w-2xl">
                    Онлайн показ позволит будущим владельцам ознакомиться с планировкой. 
                    Запишитесь на онлайн показ и мы расскажем и покажем вам будущую квартиру.
                </p>
            </div>
            <div class="flex-shrink-0 w-full md:w-auto">
                <button onclick="openOnlineShowingModal()" class="bg-[#0088CC] text-white hover:bg-[#006699] font-semibold w-full md:w-auto px-6 py-3 md:px-8 md:py-4 text-sm md:text-base rounded-xl whitespace-nowrap transition-all shadow-md hover:shadow-lg">
                    Записаться на онлайн показ
                </button>
            </div>
        </div>
        
        <!-- Декоративная иконка дивана -->
        <div class="absolute right-0 top-1/2 transform -translate-y-1/2 opacity-5 hidden lg:block text-blue-300" style="font-size: 180px; right: -20px;">
            <i class="fas fa-couch"></i>
        </div>
    </div>
    
    <!-- О жилом комплексе -->
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6">О жилом комплексе {{ property.complex_name }}</h2>
        
        <!-- Фотографии ЖК -->
        {% if property.gallery and property.gallery|length > 1 %}
        <div class="mb-6">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                {% for image in property.gallery[:6] %}
                <div class="aspect-video rounded-lg overflow-hidden cursor-pointer">
                    <img src="{{ image }}" alt="ЖК {{ property.complex_name }}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" onclick="openPhotoModal({{ loop.index0 }})">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        
        <!-- Информация о ЖК -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h4 class="font-semibold mb-3 text-[#0088CC]">Основные характеристики</h4>
                <div class="space-y-2 text-sm">
                    {% if property.class_type %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Класс недвижимости:</span>
                        <span class="font-medium">{{ property.class_type }}</span>
                    </div>
                    {% endif %}
                    {% if property.completion_date != 'Уточняется' %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Срок завершения:</span>
                        <span class="font-medium">{{ property.completion_date }}</span>
                    </div>
                    {% endif %}
                    {% if property.developer %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Застройщик:</span>
                        <span class="font-medium">{{ property.developer }}</span>
                    </div>
                    {% endif %}
                    {% if property.complex_name %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Название ЖК:</span>
                        <span class="font-medium">{{ property.complex_name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div>
                <h4 class="font-semibold mb-3 text-[#0088CC]">Особенности комплекса</h4>
                <div class="space-y-2 text-sm">
                    {% if property.has_accreditation %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Аккредитован банками</span>
                    </div>
                    {% endif %}
                    {% if property.has_green_mortgage %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Зеленая ипотека</span>
                    </div>
                    {% endif %}
                    {% if property.with_renovation %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Квартиры с отделкой</span>
                    </div>
                    {% endif %}
                    {% if property.has_mortgage_subsidy %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Льготная ипотека</span>
                    </div>
                    {% endif %}
                    {% if property.complex_financing_sber %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Финансирование Сбербанк</span>
                    </div>
                    {% endif %}
                    {% if property.complex_has_big_check %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Большая проверка пройдена</span>
                    </div>
                    {% endif %}
                    {% if property.complex_building_accreditation %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Корпус аккредитован</span>
                    </div>
                    {% endif %}
                    {% if property.trade_in_available %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Доступен Trade-in</span>
                    </div>
                    {% endif %}
                    {% if property.chat_available %}
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                        <span>Онлайн-консультации</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Статистика по квартирам -->
        {% if complex_info and complex_info.total_apartments > 0 %}
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <h4 class="font-semibold mb-3">В этом ЖК доступно:</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ complex_info.total_apartments }}</div>
                    <div class="text-gray-600">всего квартир</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ complex_info.studios_count if property.rooms == 0 else 0 }}</div>
                    <div class="text-gray-600">
                        {% if property.rooms == 0 %}студий
                        {% elif property.rooms == 1 %}1-комнатных
                        {% elif property.rooms == 2 %}2-комнатных  
                        {% elif property.rooms == 3 %}3-комнатных
                        {% elif property.rooms == 4 %}4-комнатных
                        {% else %}{{ property.rooms }}-комнатных
                        {% endif %}
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ complex_info.buildings_count }}</div>
                    <div class="text-gray-600">корпусов</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Другие квартиры в ЖК -->
        {% if similar_apartments and similar_apartments|length > 0 %}
        <div class="mt-6">
            <h4 class="font-semibold mb-4">Другие квартиры в {{ property.complex_name }}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                {% for apartment in similar_apartments[:8] %}
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="aspect-[4/3] relative overflow-hidden">
                        <img src="{{ apartment.image }}" alt="{{ apartment.title }}" 
                             class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                        <div class="absolute top-2 right-2 bg-[#0088CC] text-white text-xs px-2 py-1 rounded">
                            до {{ "{:,.0f}".format(apartment.cashback).replace(',', ' ') }} ₽ кэшбек
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="text-sm font-medium mb-1">{{ apartment.room_type }}</div>
                        <div class="text-xs text-gray-600 mb-2">{{ apartment.area }} м² • {{ apartment.floor }}/{{ apartment.total_floors }} эт.</div>
                        <div class="text-lg font-bold text-[#0088CC] mb-2">
                            {{ "{:,.0f}".format(apartment.price).replace(',', ' ') }} ₽
                        </div>
                        <a href="{{ url_for('property_detail', property_id=apartment.id) }}" 
                           class="block w-full bg-gray-100 hover:bg-[#0088CC] hover:text-white text-center text-sm py-2 rounded-lg transition-all">
                            Подробнее
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="mt-6">
            <a href="{{ url_for('residential_complex_detail', complex_name=property.complex_name) }}" class="w-full md:w-auto text-center block md:inline-block bg-[#0088CC] text-white px-6 py-3 rounded-lg hover:bg-[#0077BB] transition-colors">
                Подробнее о ЖК
            </a>
        </div>
    </div>
    
    <!-- Варианты отделки -->
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold mb-4">Варианты отделки в ЖК</h2>
        <p class="text-gray-600 mb-4">Как может выглядеть отделка</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Чистовая отделка -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="aspect-[3/2] rounded-lg overflow-hidden mb-3">
                    <img src="{{ url_for('static', filename='images/fine_finish.jpg') if url_for else '/static/images/fine_finish.jpg' }}" alt="Чистовая отделка" class="w-full h-full object-cover">
                </div>
                <h4 class="font-semibold mb-2">Чистовая</h4>
                <p class="text-sm text-gray-600 mb-2">Квартира готова к переезду: обои, ламинат, сантехника, двери установлены.</p>
                <a href="#" onclick="event.preventDefault(); openFinishModal('turnkey')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Подробнее</a>
            </div>
            
            <!-- Черновая отделка -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="aspect-[3/2] rounded-lg overflow-hidden mb-3">
                    <img src="{{ url_for('static', filename='images/rough_finish.jpg') }}" alt="Черновая отделка" class="w-full h-full object-cover">
                </div>
                <h4 class="font-semibold mb-2">Черновая</h4>
                <p class="text-sm text-gray-600 mb-2">Стяжка, штукатурка, перегородки. Электричество и отопление подведены.</p>
                <a href="#" onclick="event.preventDefault(); openFinishModal('rough')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Подробнее</a>
            </div>
        </div>
    </div>
    
    <!-- Как это работает -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-8 mb-8">
        <h2 class="text-lg md:text-xl font-bold mb-6 text-gray-900">Как это работает</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <div class="relative">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-[#0088CC] rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-sm font-bold text-white">1</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-gray-900 mb-1">Выбор квартиры</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">Подбираем вариант из каталога проверенных застройщиков</p>
                    </div>
                </div>
            </div>
            
            <div class="relative">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-[#0088CC] rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-sm font-bold text-white">2</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-gray-900 mb-1">Оформление</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">Регистрируем вас у застройщика для получения кэшбека</p>
                    </div>
                </div>
            </div>
            
            <div class="relative">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-[#0088CC] rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-sm font-bold text-white">3</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-gray-900 mb-1">Сопровождение</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">Юридическая поддержка и ведение документов до завершения</p>
                    </div>
                </div>
            </div>
            
            <div class="relative">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-[#0088CC] rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-sm font-bold text-white">4</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-gray-900 mb-1">Получение кэшбека</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">Возврат до 500 000 ₽ на вашу карту после сделки</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Почему стоит купить эту квартиру -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-8 mb-8">
        <h2 class="text-lg md:text-xl font-bold mb-6 text-gray-900">Почему стоит купить эту квартиру</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-wallet text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Кэшбек до 500 000 ₽</h3>
                    <p class="text-xs text-gray-500">Возврат денег после покупки на вашу карту</p>
                </div>
            </div>
            
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-chart-line text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Рост стоимости</h3>
                    <p class="text-xs text-gray-500">Недвижимость растёт в цене на 10-15% в год</p>
                </div>
            </div>
            
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-key text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Готова к заселению</h3>
                    <p class="text-xs text-gray-500">Переезжайте сразу после оформления</p>
                </div>
            </div>
            
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-store text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Развитая инфраструктура</h3>
                    <p class="text-xs text-gray-500">Школы, сады, магазины рядом</p>
                </div>
            </div>
            
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-road text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Удобная транспортная развязка</h3>
                    <p class="text-xs text-gray-500">Быстрый доступ в центр города</p>
                </div>
            </div>
            
            <div class="flex items-start gap-3 p-4 rounded-xl bg-gray-50">
                <div class="w-9 h-9 bg-[#0088CC]/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-shield-alt text-[#0088CC] text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sm text-gray-900 mb-0.5">Проверенный застройщик</h3>
                    <p class="text-xs text-gray-500">Надёжная компания с репутацией</p>
                </div>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3">
            <a href="#" onclick="event.preventDefault(); openApplicationModal({
                type: 'property',
                id: '{{ property.id }}',
                title: '{{ property.title or (property.rooms|string + '-комнатная квартира ' + property.area|string + ' м²') }}',
                complex: '{{ property.complex_name }}',
                price: '{{ property.price }}',
                area: '{{ property.area }}',
                rooms: '{{ property.rooms }}',
                floor: '{{ property.floor }}',
                total_floors: '{{ property.total_floors }}',
                district: '{{ property.district }}',
                url: '{{ request.url }}'
            })" class="w-full sm:w-auto text-center bg-[#0088CC] hover:bg-[#006699] text-white px-6 py-2.5 rounded-lg font-medium text-sm transition-colors">
                Получить консультацию
            </a>
            <a href="#" onclick="event.preventDefault(); openApplicationModal({
                type: 'property',
                id: '{{ property.id }}',
                title: '{{ property.title or (property.rooms|string + '-комнатная квартира ' + property.area|string + ' м²') }}',
                complex: '{{ property.complex_name }}',
                price: '{{ property.price }}',
                area: '{{ property.area }}',
                rooms: '{{ property.rooms }}',
                floor: '{{ property.floor }}',
                total_floors: '{{ property.total_floors }}',
                district: '{{ property.district }}',
                url: '{{ request.url }}'
            })" class="w-full sm:w-auto text-center bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2.5 rounded-lg font-medium text-sm transition-colors">
                Посмотреть квартиру
            </a>
        </div>
    </div>
    
    
    <!-- Расположение на карте -->
    <div id="property-map-section" class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8">
        <div class="relative">
            <div id="property-map" class="w-full h-64 md:h-96"></div>
            <div class="absolute top-3 left-3 bg-white/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-md">
                <div class="flex items-center gap-2">
                    <i class="fas fa-map-marker-alt text-[#0088CC]"></i>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">{{ property.complex_name }}</p>
                        <p class="text-xs text-gray-500">{{ property.address_locality_display_name or property.district or 'Краснодар' }}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 md:p-5">
            <p class="text-sm text-gray-600 mb-3">
                <i class="fas fa-location-dot text-[#0088CC] mr-1.5"></i>
                {{ property.full_address or property.address or ((property.address_locality_display_name or 'Краснодар') + ', ' + (property.complex_name or 'ЖК')) }}
            </p>
            <div class="flex gap-2">
                <a href="https://yandex.ru/maps/?ll={{ property.address_position_lon or 39.0 }},{{ property.address_position_lat or 45.0 }}&z=16&pt={{ property.address_position_lon or 39.0 }},{{ property.address_position_lat or 45.0 }}" 
                   target="_blank" 
                   class="flex-1 flex items-center justify-center gap-2 text-xs md:text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2.5 rounded-lg transition-colors font-medium">
                    <i class="fab fa-yandex text-red-500"></i>
                    Яндекс Карты
                </a>
                <a href="https://maps.google.com/?q={{ property.address_position_lat or 45.0 }},{{ property.address_position_lon or 39.0 }}" 
                   target="_blank" 
                   class="flex-1 flex items-center justify-center gap-2 text-xs md:text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2.5 rounded-lg transition-colors font-medium">
                    <i class="fab fa-google text-blue-500"></i>
                    Google Maps
                </a>
            </div>
            
            <!-- Инфраструктура -->
            <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-gray-100">
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-7 h-7 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-bus text-[#0088CC] text-xs"></i>
                    </span>
                    <div>
                        <span class="text-gray-500 text-xs">Автобус</span>
                        <p class="font-medium text-sm leading-tight">200 м</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-7 h-7 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-shopping-bag text-[#0088CC] text-xs"></i>
                    </span>
                    <div>
                        <span class="text-gray-500 text-xs">ТЦ</span>
                        <p class="font-medium text-sm leading-tight">500 м</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-7 h-7 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-graduation-cap text-[#0088CC] text-xs"></i>
                    </span>
                    <div>
                        <span class="text-gray-500 text-xs">Школа</span>
                        <p class="font-medium text-sm leading-tight">400 м</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-7 h-7 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-child text-[#0088CC] text-xs"></i>
                    </span>
                    <div>
                        <span class="text-gray-500 text-xs">Детский сад</span>
                        <p class="font-medium text-sm leading-tight">300 м</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Застройщик -->
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6">Застройщик</h2>
        <div class="flex items-start gap-3 md:gap-6">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-gray-200 rounded-xl flex items-center justify-center">
                <span class="text-lg font-bold text-[#0088CC]">{{ property.developer[:3].upper() }}</span>
            </div>
            <div class="flex-1">
                <h3 class="text-lg md:text-xl font-semibold mb-2">{{ property.developer }}</h3>
                <p class="text-gray-600 mb-4">Надежный застройщик с многолетним опытом строительства качественного жилья в Краснодаре. Все объекты сданы в срок.</p>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Построено объектов:</span>
                        <span class="font-medium">15+</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Опыт работы:</span>
                        <span class="font-medium">12 лет</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<!-- Яндекс.Карты API -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=" type="text/javascript"></script>

<script>

    // Красивый слайдер с эффектами
    const swiper = new Swiper('.property-slider', {
        loop: true,
        autoplay: {
            delay: 4000,
            disableOnInteraction: false,
            pauseOnMouseEnter: true,
        },
        // Убираем fade эффект для лучшего листания
        effect: 'slide',
        speed: 600,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
            renderBullet: function (index, className) {
                return '<span class="' + className + '">' + (index + 1) + '</span>';
            },
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        keyboard: {
            enabled: true,
            onlyInViewport: true
        },
        mousewheel: false,
        touchRatio: 1,
        touchAngle: 45,
        grabCursor: true,
        slidesPerView: 1,
        spaceBetween: 0,
        resistance: true,
        resistanceRatio: 0.85,
        centeredSlides: false,
        watchSlidesProgress: true,
        watchSlidesVisibility: true,
        preloadImages: false,
        lazy: {
            loadPrevNext: true,
            loadPrevNextAmount: 2
        },
        on: {
            init: function() {
                console.log('Слайдер инициализирован');
            },
            slideChange: function() {
                // Плавная анимация при смене слайда
                this.slides.forEach(slide => {
                    slide.style.opacity = '1';
                });
            }
        }
    });

    function scrollToMap() {
        const mapSection = document.getElementById('property-map-section');
        if (mapSection) {
            mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            mapSection.classList.add('ring-2', 'ring-[#0088CC]', 'ring-offset-2');
            setTimeout(() => {
                mapSection.classList.remove('ring-2', 'ring-[#0088CC]', 'ring-offset-2');
            }, 2000);
        }
    }

    // Initialize Yandex Map
    ymaps.ready(function() {
        {% if property.address_position_lat and property.address_position_lon %}
        const propertyLat = {{ property.address_position_lat }};
        const propertyLng = {{ property.address_position_lon }};
        {% else %}
        const propertyLat = 45.0355;
        const propertyLng = 38.9753;
        {% endif %}
        
        const map = new ymaps.Map('property-map', {
            center: [propertyLat, propertyLng],
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
        });
        
        var mobileMapEl = document.getElementById('property-mobile-map');
        if (mobileMapEl) {
            var mobileMap = new ymaps.Map('property-mobile-map', {
                center: [propertyLat, propertyLng],
                zoom: 15,
                controls: ['zoomControl']
            });
            mobileMap.behaviors.disable('scrollZoom');
            mobileMap.geoObjects.add(new ymaps.Placemark([propertyLat, propertyLng], {}, {preset: 'islands#blueCircleDotIcon'}));
        }
        
        // Добавляем слой с инфраструктурой
        const infraLayer = new ymaps.ObjectManager({
            clusterize: false,
            gridSize: 32,
            geoObjectOpenBalloonOnClick: false
        });
        
        // Создаем метку для квартиры
        const placemark = new ymaps.Placemark([propertyLat, propertyLng], {
            balloonContentHeader: '{{ property.complex_name }}',
            balloonContentBody: `
                <div class="text-center p-2">
                    <div class="text-sm text-gray-600 mb-2">{{ property.title }}</div>
                    <div class="text-lg font-bold text-blue-600">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                    <div class="text-xs text-gray-500 mt-1">{{ "{:,.0f}".format(property.price / property.area).replace(',', ' ') }} ₽/м²</div>
                </div>
            `,
            hintContent: '{{ property.complex_name }}'
        }, {
            preset: 'islands#redDotIcon',
            iconColor: '#0088CC'
        });
        
        map.geoObjects.add(placemark);
        placemark.balloon.open();
        
        // Поиск ближайшей инфраструктуры
        const searchControl = new ymaps.control.SearchControl({
            options: {
                provider: 'yandex#search',
                size: 'small',
                float: 'left'
            }
        });
        
        // Показываем объекты инфраструктуры поблизости
        setTimeout(() => {
            // Школы
            ymaps.geocode(`школа около ${propertyLat}, ${propertyLng}`, {
                results: 3,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const schoolMark = new ymaps.Placemark(coords, {
                        hintContent: 'Школа'
                    }, {
                        preset: 'islands#greenEducationIcon',
                        iconColor: '#4CAF50'
                    });
                    map.geoObjects.add(schoolMark);
                });
            });
            
            // Детские сады
            ymaps.geocode(`детский сад около ${propertyLat}, ${propertyLng}`, {
                results: 3,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const kindergartenMark = new ymaps.Placemark(coords, {
                        hintContent: 'Детский сад'
                    }, {
                        preset: 'islands#yellowIcon',
                        iconColor: '#FFC107'
                    });
                    map.geoObjects.add(kindergartenMark);
                });
            });
            
            // Больницы
            ymaps.geocode(`больница около ${propertyLat}, ${propertyLng}`, {
                results: 2,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const hospitalMark = new ymaps.Placemark(coords, {
                        hintContent: 'Больница'
                    }, {
                        preset: 'islands#redMedicalIcon',
                        iconColor: '#F44336'
                    });
                    map.geoObjects.add(hospitalMark);
                });
            });
            
            // Магазины
            ymaps.geocode(`магазин около ${propertyLat}, ${propertyLng}`, {
                results: 5,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const shopMark = new ymaps.Placemark(coords, {
                        hintContent: 'Магазин'
                    }, {
                        preset: 'islands#blueShoppingIcon',
                        iconColor: '#2196F3'
                    });
                    map.geoObjects.add(shopMark);
                });
            });
        }, 1000);
    });

    // Share property function
    function shareProperty() {
        const url = window.location.href;
        const title = document.title;
        
        if (navigator.share) {
            navigator.share({
                title: title,
                url: url
            }).catch(error => console.warn('Property detail error:', error));
        } else if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => {
                alert('Ссылка скопирована в буфер обмена!');
            }).catch(() => {
                fallbackCopyTextToClipboard(url);
            });
        } else {
            fallbackCopyTextToClipboard(url);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            alert('Ссылка скопирована в буфер обмена!');
        } catch (err) {
            alert('Не удалось скопировать ссылку. URL: ' + text);
        }
        
        document.body.removeChild(textArea);
    }

    // Ипотечный калькулятор
    function calculateMortgage() {
        const propertyPrice = {{ property.price }};
        const maxLoanAmount = 6000000; // Максимальная сумма по семейной ипотеке
        let downPaymentPercent = parseFloat(document.getElementById('mortgage-down-payment').value);
        const rate = parseFloat(document.getElementById('mortgage-rate').value);
        const termYears = parseInt(document.getElementById('mortgage-term').value);
        
        // Расчет с учетом ограничения семейной ипотеки
        let loanAmount = propertyPrice * (1 - downPaymentPercent / 100);
        let downPaymentAmount = propertyPrice * (downPaymentPercent / 100);
        
        // Если сумма кредита превышает лимит семейной ипотеки
        if (loanAmount > maxLoanAmount) {
            loanAmount = maxLoanAmount;
            downPaymentAmount = propertyPrice - loanAmount;
            const actualDownPaymentPercent = (downPaymentAmount / propertyPrice) * 100;
            
            // Обновляем поле первоначального взноса
            document.getElementById('mortgage-down-payment').value = actualDownPaymentPercent.toFixed(1);
        }
        
        const monthlyRate = (rate / 100) / 12;
        const totalMonths = termYears * 12;
        
        // Формула аннуитетного платежа
        let monthlyPayment;
        if (rate === 0) {
            monthlyPayment = loanAmount / totalMonths;
        } else {
            monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                           (Math.pow(1 + monthlyRate, totalMonths) - 1);
        }
        
        // Обновляем интерфейс
        document.getElementById('mortgage-down-amount').textContent = formatNumber(downPaymentAmount) + ' ₽';
        document.getElementById('loan-amount').textContent = formatNumber(loanAmount) + ' ₽';
        document.getElementById('monthly-payment').textContent = formatNumber(monthlyPayment) + ' ₽';
        
        // Показываем предупреждение если достигнут лимит
        const warningElement = document.getElementById('family-mortgage-limit-warning');
        if (loanAmount >= maxLoanAmount) {
            if (warningElement) warningElement.style.display = 'block';
        } else {
            if (warningElement) warningElement.style.display = 'none';
        }
    }
    
    function formatNumber(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    // Инициализация калькулятора
    document.addEventListener('DOMContentLoaded', function() {
        // Первоначальный расчет
        calculateMortgage();
        
        // Привязка событий к полям ввода
        const inputs = ['mortgage-down-payment', 'mortgage-rate', 'mortgage-term'];
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateMortgage);
                element.addEventListener('change', calculateMortgage);
            }
        });
    });

    // Property Gallery functionality  
    let propertyCurrentSlide = 0;
    let propertySlideInterval;
    
    function prevPropertySlide() {
        const gallery = document.querySelector('.gallery-slides');
        const dots = document.querySelectorAll('.property-gallery-dot');
        
        if (!gallery || !dots.length) return;
        
        propertyCurrentSlide = (propertyCurrentSlide - 1 + dots.length) % dots.length;
        updatePropertyGallery();
    }

    function nextPropertySlide() {
        const gallery = document.querySelector('.gallery-slides');
        const dots = document.querySelectorAll('.property-gallery-dot');
        
        if (!gallery || !dots.length) return;
        
        propertyCurrentSlide = (propertyCurrentSlide + 1) % dots.length;
        updatePropertyGallery();
    }

    function goToPropertySlide(index) {
        propertyCurrentSlide = index;
        updatePropertyGallery();
    }

    function updatePropertyGallery() {
        const gallery = document.querySelector('.gallery-slides');
        const dots = document.querySelectorAll('.property-gallery-dot');
        
        if (!gallery || !dots.length) return;
        
        gallery.style.transform = `translateX(-${propertyCurrentSlide * 100}%)`;
        
        dots.forEach((dot, index) => {
            if (index === propertyCurrentSlide) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    }

    (function() {
        var gc = document.querySelector('.gallery-container');
        if (!gc) return;
        var sx = 0, sy = 0, moving = false;
        gc.addEventListener('touchstart', function(e) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; moving = true; }, {passive: true});
        gc.addEventListener('touchend', function(e) {
            if (!moving) return; moving = false;
            var dx = e.changedTouches[0].clientX - sx;
            var dy = e.changedTouches[0].clientY - sy;
            if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
                if (dx < 0) nextPropertySlide(); else prevPropertySlide();
            }
        }, {passive: true});
    })();

    function startPropertyAutoSlide() {
        const dots = document.querySelectorAll('.property-gallery-dot');
        if (dots.length > 1) {
            propertySlideInterval = setInterval(() => {
                nextPropertySlide();
            }, 4000); // Автоматическое переключение каждые 4 секунды
        }
    }

    function stopPropertyAutoSlide() {
        if (propertySlideInterval) {
            clearInterval(propertySlideInterval);
        }
    }

    // Touch swipe support for property gallery
    function initPropertyGallerySwipe() {
        const container = document.querySelector('.gallery-container');
        const gallery = document.querySelector('.gallery-slides');
        if (!container || !gallery) return;

        let startX = 0, startY = 0, currentX = 0, isDragging = false, isHorizontal = null;
        const totalSlides = document.querySelectorAll('.gallery-slide').length;

        function onStart(x, y) {
            if (totalSlides <= 1) return;
            isDragging = true;
            isHorizontal = null;
            startX = x;
            startY = y;
            currentX = 0;
            stopPropertyAutoSlide();
            gallery.style.transition = 'none';
        }

        function onMove(x, y) {
            if (!isDragging) return;
            const dx = x - startX;
            const dy = y - startY;
            if (isHorizontal === null) {
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    isHorizontal = Math.abs(dx) > Math.abs(dy);
                }
                return;
            }
            if (!isHorizontal) return;
            currentX = dx;
            const offset = -(propertyCurrentSlide * 100) + (currentX / container.offsetWidth * 100);
            gallery.style.transform = `translateX(${offset}%)`;
        }

        function onEnd() {
            if (!isDragging) return;
            isDragging = false;
            gallery.style.transition = 'transform 0.3s ease';
            const threshold = container.offsetWidth * 0.15;
            if (currentX < -threshold && propertyCurrentSlide < totalSlides - 1) {
                propertyCurrentSlide++;
            } else if (currentX > threshold && propertyCurrentSlide > 0) {
                propertyCurrentSlide--;
            }
            updatePropertyGallery();
            startPropertyAutoSlide();
        }

        container.addEventListener('touchstart', function(e) {
            onStart(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: true });
        container.addEventListener('touchmove', function(e) {
            onMove(e.touches[0].clientX, e.touches[0].clientY);
            if (isHorizontal) e.preventDefault();
        }, { passive: false });
        container.addEventListener('touchend', onEnd);

        container.addEventListener('mousedown', function(e) {
            e.preventDefault();
            onStart(e.clientX, e.clientY);
        });
        document.addEventListener('mousemove', function(e) {
            onMove(e.clientX, e.clientY);
        });
        document.addEventListener('mouseup', onEnd);
    }

    // Touch swipe for photo modal
    function initPhotoModalSwipe() {
        const modal = document.getElementById('photoModal');
        if (!modal) return;
        let startX = 0, isDragging = false;

        modal.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            isDragging = true;
        }, { passive: true });
        modal.addEventListener('touchend', function(e) {
            if (!isDragging) return;
            isDragging = false;
            const dx = e.changedTouches[0].clientX - startX;
            if (Math.abs(dx) > 50) {
                if (dx < 0) nextPhoto();
                else prevPhoto();
            }
        });
    }

    // Инициализация автослайдера для галереи квартиры
    document.addEventListener('DOMContentLoaded', function() {
        startPropertyAutoSlide();
        initPropertyGallerySwipe();
        initPhotoModalSwipe();
        
        // Остановить автослайдер при наведении мыши
        const galleryContainer = document.querySelector('.gallery-container');
        if (galleryContainer) {
            galleryContainer.addEventListener('mouseenter', stopPropertyAutoSlide);
            galleryContainer.addEventListener('mouseleave', startPropertyAutoSlide);
        }
    });

    // Photo modal functionality for property detail
    let photoModalImages = {{ property.gallery|tojson if property.gallery and property.gallery|length > 0 else ('[\"' + property.image + '\"]' if property.image and 'placeholder' not in property.image else '[]')|safe }};
    let currentPhotoIndex = 0;

    function openPhotoModal(index = 0) {
        currentPhotoIndex = index;
        const modal = document.getElementById('photoModal');
        const modalImg = document.getElementById('modalImg');
        const counter = document.getElementById('photoCounter');
        
        if (photoModalImages.length > 0) {
            modalImg.src = photoModalImages[currentPhotoIndex];
            counter.textContent = `${currentPhotoIndex + 1} из ${photoModalImages.length}`;
            modal.classList.remove('hidden');
            // Prevent body scroll using our system
            if (typeof window.lockBodyScroll === 'function') {
                window.lockBodyScroll();
            }
        }
    }

    function closePhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.classList.add('hidden');
        // Restore scroll using our system
        if (typeof window.unlockBodyScroll === 'function') {
            window.unlockBodyScroll();
        }
    }

    function prevPhoto() {
        if (photoModalImages.length > 0) {
            currentPhotoIndex = (currentPhotoIndex - 1 + photoModalImages.length) % photoModalImages.length;
            openPhotoModal(currentPhotoIndex);
        }
    }

    function nextPhoto() {
        if (photoModalImages.length > 0) {
            currentPhotoIndex = (currentPhotoIndex + 1) % photoModalImages.length;
            openPhotoModal(currentPhotoIndex);
        }
    }

    // Keyboard navigation for photo modal
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('photoModal');
        if (!modal.classList.contains('hidden')) {
            if (e.key === 'Escape') {
                closePhotoModal();
            } else if (e.key === 'ArrowLeft') {
                prevPhoto();
            } else if (e.key === 'ArrowRight') {
                nextPhoto();
            }
        }
    });
</script>

<!-- Photo Modal -->
<div id="photoModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center hidden">
    <div class="relative max-w-screen-lg max-h-screen w-full h-full flex items-center justify-center p-4">
        <!-- Close button -->
        <button onclick="closePhotoModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-60">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- Previous button -->
        <button onclick="prevPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-60">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        
        <!-- Next button -->
        <button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-60">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        
        <!-- Image -->
        <img id="modalImg" src="" alt="Фото квартиры" class="max-w-full max-h-full object-contain">
        
        <!-- Counter -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
            <span id="photoCounter">1 из 1</span>
        </div>
    </div>
</div>

<!-- Модальное окно для отделки -->
<div id="finishModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Отделка квартиры</h2>
                <button onclick="closeFinishModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <div id="modalContent">
                <!-- Контент будет добавлен через JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
function openFinishModal(type) {
    const modal = document.getElementById('finishModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');
    
    if (type === 'turnkey') {
        title.textContent = 'Чистовая отделка';
        content.innerHTML = `
            <div class="space-y-6">
                <img src="{{ url_for('static', filename='images/fine_finish.jpg') if url_for else '/static/images/fine_finish.jpg' }}" 
                     alt="Чистовая отделка" class="w-full h-64 object-cover rounded-lg">
                
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold">Что включено в чистовую отделку:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Финишная отделка стен и потолков</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Напольное покрытие (ламинат/паркет)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Установленная сантехника</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Межкомнатные двери</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Кухонный гарнитур</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Освещение и розетки</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Плитка в ванной и на кухне</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Готова к переезду</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (type === 'rough') {
        title.textContent = 'Черновая отделка';
        content.innerHTML = `
            <div class="space-y-6">
                <img src="{{ url_for('static', filename='images/rough_finish.jpg') }}" 
                     alt="Черновая отделка" class="w-full h-64 object-cover rounded-lg">
                
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold">Что включено в черновую отделку:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Выровненные стены (штукатурка)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Стяжка пола</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Перегородки и проемы</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Входная дверь</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Электропроводка и водопровод</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Система отопления</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Окна установлены</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-black rounded-full flex-shrink-0"></span>
                                <span>Готова к финишной отделке</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    modal.classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeFinishModal() {
    const modal = document.getElementById('finishModal');
    modal.classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
}

// Закрытие модального окна при клике вне его
document.getElementById('finishModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFinishModal();
    }
});

// Закрытие модального окна при нажатии Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('finishModal');
        if (!modal.classList.contains('hidden')) {
            closeFinishModal();
        }
    }
});

// Cashback Modal Functions
function openCashbackModal() {
    document.getElementById('cashbackModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeCashbackModal() {
    document.getElementById('cashbackModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
}

// Online Showing Modal Functions
function openOnlineShowingModal() {
    document.getElementById('onlineShowingModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeOnlineShowingModal() {
    document.getElementById('onlineShowingModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
}

// Phone formatting
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 0 && value[0] !== '7') {
        value = '7' + value;
    }
    if (value.length > 11) {
        value = value.substring(0, 11);
    }
    
    let formatted = '+7';
    if (value.length > 1) {
        formatted += ' ' + value.substring(1, 4);
    }
    if (value.length > 4) {
        formatted += ' ' + value.substring(4, 7);
    }
    if (value.length > 7) {
        formatted += ' ' + value.substring(7, 9);
    }
    if (value.length > 9) {
        formatted += ' ' + value.substring(9, 11);
    }
    
    input.value = formatted;
}

// Cashback Form Submission
async function submitCashbackRequest(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Отправка...';
    
    const formData = {
        name: form.cashback_name.value,
        phone: form.cashback_phone.value,
        email: form.cashback_email.value,
        property_id: {{ property.id }},
        property_title: '{{ property.title or (property.rooms|string + "-комнатная квартира " + property.area|string + " м²") }}',
        property_address: '{{ property.full_address or property.address }}',
        property_price: {{ property.price }}
    };
    
    try {
        const response = await fetch('/api/property/{{ property.id }}/request-cashback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('✅ Заявка на кэшбек успешно отправлена! Мы свяжемся с вами в ближайшее время.');
            closeCashbackModal();
            form.reset();
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Не удалось отправить заявку'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Произошла ошибка при отправке заявки');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Online Showing Form Submission
async function submitOnlineShowingRequest(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Отправка...';
    
    const formData = {
        name: form.showing_name.value,
        phone: form.showing_phone.value,
        email: form.showing_email.value,
        datetime: form.showing_datetime.value,
        property_id: {{ property.id }},
        property_title: '{{ property.title or (property.rooms|string + "-комнатная квартира " + property.area|string + " м²") }}',
        property_address: '{{ property.full_address or property.address }}',
        property_price: {{ property.price }}
    };
    
    try {
        const response = await fetch('/api/property/{{ property.id }}/request-online-showing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('✅ Заявка на онлайн показ успешно отправлена! Мы свяжемся с вами для подтверждения времени.');
            closeOnlineShowingModal();
            form.reset();
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Не удалось отправить заявку'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Произошла ошибка при отправке заявки');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Close modals on click outside
document.addEventListener('click', function(e) {
    if (e.target.id === 'cashbackModal') {
        closeCashbackModal();
    }
    if (e.target.id === 'onlineShowingModal') {
        closeOnlineShowingModal();
    }
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCashbackModal();
        closeOnlineShowingModal();
    }
});
</script>

<!-- Cashback Modal -->
<div id="cashbackModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 relative" onclick="event.stopPropagation()">
        <button onclick="closeCashbackModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
        </button>
        
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Получить кэшбек</h2>
        <p class="text-gray-600 mb-6">Заполните форму и мы свяжемся с вами для расчета кэшбека</p>
        
        <form onsubmit="submitCashbackRequest(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ваше имя *</label>
                <input type="text" name="cashback_name" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="Иван Иванов">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Телефон *</label>
                <input type="tel" name="cashback_phone" required 
                    oninput="formatPhone(this)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="+7 XXX XXX XX XX">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="cashback_email" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="example@mail.ru">
            </div>
            
            <div class="bg-blue-50 rounded-lg p-4 text-sm">
                <p class="text-gray-700"><strong>Объект:</strong> {{ property.title or (property.rooms|string + "-комнатная квартира " + property.area|string + " м²") }}</p>
                <p class="text-gray-700 mt-1"><strong>Адрес:</strong> {{ property.full_address or property.address }}</p>
                <p class="text-gray-700 mt-1"><strong>Цена:</strong> {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽</p>
            </div>
            
            <button type="submit" class="w-full bg-[#0088CC] text-white font-semibold py-3 px-6 rounded-lg hover:bg-[#006699] transition-all shadow-md hover:shadow-lg">
                Отправить заявку
            </button>
            
            <p class="text-xs text-gray-500 text-center">Нажимая кнопку, вы соглашаетесь с <a href="/privacy-policy" class="text-[#0088CC] hover:underline">политикой конфиденциальности</a></p>
        </form>
    </div>
</div>

<!-- Online Showing Modal -->
<div id="onlineShowingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 relative" onclick="event.stopPropagation()">
        <button onclick="closeOnlineShowingModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
        </button>
        
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Онлайн показ квартиры</h2>
        <p class="text-gray-600 mb-6">Запишитесь на онлайн показ и мы покажем вам квартиру</p>
        
        <form onsubmit="submitOnlineShowingRequest(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ваше имя *</label>
                <input type="text" name="showing_name" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="Иван Иванов">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Телефон *</label>
                <input type="tel" name="showing_phone" required 
                    oninput="formatPhone(this)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="+7 XXX XXX XX XX">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="showing_email" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all"
                    placeholder="example@mail.ru">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Желаемая дата и время *</label>
                <input type="datetime-local" name="showing_datetime" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none transition-all">
            </div>
            
            <div class="bg-blue-50 rounded-lg p-4 text-sm">
                <p class="text-gray-700"><strong>Объект:</strong> {{ property.title or (property.rooms|string + "-комнатная квартира " + property.area|string + " м²") }}</p>
                <p class="text-gray-700 mt-1"><strong>Адрес:</strong> {{ property.full_address or property.address }}</p>
                <p class="text-gray-700 mt-1"><strong>Цена:</strong> {{ "{:,}".format(property.price|int).replace(',', ' ') }} ₽</p>
            </div>
            
            <button type="submit" class="w-full bg-[#0088CC] text-white font-semibold py-3 px-6 rounded-lg hover:bg-[#006699] transition-all shadow-md hover:shadow-lg">
                Записаться на показ
            </button>
            
            <p class="text-xs text-gray-500 text-center">Нажимая кнопку, вы соглашаетесь с <a href="/privacy-policy" class="text-[#0088CC] hover:underline">политикой конфиденциальности</a></p>
        </form>
    </div>
</div>

<!-- Floating Call Button - Mobile Only -->
<div class="md:hidden fixed bottom-16 right-4 z-[9997]" style="padding-bottom: env(safe-area-inset-bottom, 0px);">
    <button onclick="openPhoneModal('{{ property.id }}', '{{ property.complex_name or "" }}')" 
            class="w-14 h-14 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95">
        <i class="fas fa-phone-alt text-lg"></i>
    </button>
</div>

{% endblock %}