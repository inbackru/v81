{% extends "base.html" %}

{% block title %}Панель менеджера | InBack{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<style>
header { display: none !important; }
body { padding-top: 0 !important; }

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.favorites-tab-content {
    display: none;
}

.favorites-tab-content.active {
    display: block;
}

#mobileBottomNav {
    display: none !important;
}

.mgr-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9998;
    background: white;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    padding-bottom: env(safe-area-inset-bottom, 0px);
}
.mgr-bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 8px 0;
    font-size: 10px;
    font-weight: 500;
    color: #9ca3af;
    transition: color 0.2s;
    position: relative;
    -webkit-tap-highlight-color: transparent;
}
.mgr-bottom-nav-item.active {
    color: #0088CC;
}
.mgr-bottom-nav-item .nav-badge {
    position: absolute;
    top: 2px;
    right: calc(50% - 16px);
    background: #ef4444;
    color: white;
    font-size: 9px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

.mgr-fullscreen-modal {
    position: fixed;
    inset: 0;
    z-index: 10010;
    background: #f3f4f6;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
}
.mgr-fullscreen-modal.open {
    transform: translateX(0);
}

.mgr-more-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    background: rgba(0,0,0,0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}
.mgr-more-overlay.open {
    opacity: 1;
    pointer-events: auto;
}
.mgr-more-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10001;
    background: white;
    border-radius: 20px 20px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding-bottom: env(safe-area-inset-bottom, 0px);
    max-height: 70vh;
    overflow-y: auto;
}
.mgr-more-panel.open {
    transform: translateY(0);
}

@media (max-width: 767px) {
    #dashboard-tab-nav {
        display: none !important;
    }
    body > footer, body > .footer, #footer-section, footer {
        display: none !important;
    }
    .mgr-stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }
    .mgr-stats-grid > *:last-child:nth-child(odd) {
        grid-column: 1 / -1;
    }
    .mgr-stats-grid .text-3xl {
        font-size: 1.125rem;
    }
    .mgr-stats-grid > div {
        padding: 0.75rem;
        border-radius: 1rem;
    }
    .mgr-stats-grid > div .mb-4 {
        margin-bottom: 0.375rem;
    }
    .mgr-stats-grid > div .mb-2 {
        margin-bottom: 0.25rem;
    }
    .mgr-stats-grid > div .p-3 {
        padding: 0.375rem;
    }
    .mgr-stats-grid > div .p-3 svg {
        width: 1rem;
        height: 1rem;
    }
    .mgr-stats-grid > div .text-sm {
        font-size: 0.7rem;
    }
    .mgr-stats-grid > div .text-xs {
        font-size: 0.625rem;
    }
    .mgr-stats-grid > div .w-5 {
        width: 0.875rem;
        height: 0.875rem;
    }
    .mgr-stats-grid > div {
        transform: none !important;
    }
    .mgr-stats-grid > div:hover {
        transform: none !important;
    }
    .bg-gradient-to-b .max-w-7xl {
        padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
    }
    .mgr-welcome-header h1 {
        font-size: 1.25rem;
    }
    .mgr-welcome-header p {
        font-size: 0.8125rem;
    }
    .mgr-welcome-header .w-12 {
        width: 2.25rem;
        height: 2.25rem;
    }
    .mgr-welcome-header .w-12 svg {
        width: 1.125rem;
        height: 1.125rem;
    }
    .mgr-activity-grid {
        grid-template-columns: 1fr !important;
    }
    .mgr-activity-grid > .lg\\:col-span-2 {
        padding: 0.75rem !important;
    }
    .mgr-activity-grid > .lg\\:col-span-2 h3.text-xl {
        font-size: 1rem;
    }
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 > div {
        padding: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
    }
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .text-sm {
        font-size: 0.75rem;
        line-height: 1.2;
    }
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .text-xs {
        font-size: 0.625rem;
    }
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .w-8,
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .w-9 {
        width: 1.75rem;
        height: 1.75rem;
    }
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .w-8 svg,
    .mgr-activity-grid > .lg\\:col-span-2 .space-y-1 .w-9 svg {
        width: 0.875rem;
        height: 0.875rem;
    }
    .mgr-activity-grid .quick-actions-list a {
        padding: 0.75rem;
    }
    .mgr-activity-grid .quick-actions-list .w-12 {
        width: 2.25rem;
        height: 2.25rem;
    }
    .mgr-activity-grid .quick-actions-list .w-12 svg,
    .mgr-activity-grid .quick-actions-list .w-12 i {
        font-size: 0.875rem;
        width: 1.125rem;
        height: 1.125rem;
    }
    .mgr-activity-grid .quick-actions-list h4 {
        font-size: 0.8125rem;
    }
    .mgr-activity-grid .quick-actions-list p {
        font-size: 0.6875rem;
    }
    .mgr-create-banner .text-2xl {
        font-size: 1rem;
    }
    .mgr-create-banner {
        padding: 1rem !important;
    }
    .mgr-create-banner .text-sm {
        font-size: 0.75rem;
    }
    .mgr-create-banner .text-xs {
        font-size: 0.625rem;
    }

    /* Reduce outer wrapper padding on mobile */
    .bg-gradient-to-b.from-white.to-gray-50 > .max-w-7xl { padding-top: 0.5rem !important; padding-bottom: 0 !important; }

    /* Clients section mobile */
    #clients .max-w-7xl { padding: 1rem !important; padding-top: 0.5rem !important; }
    #clients h2.text-2xl { font-size: 1.25rem; }
    #clients .bg-white.rounded-2xl.shadow-sm.p-4.mb-6 { padding: 0.75rem; margin-bottom: 0.75rem; }
    #clients input.pl-10 { padding-top: 0.625rem; padding-bottom: 0.625rem; font-size: 0.8125rem; }
    #clients table { display: none; }
    #clients .overflow-x-auto { overflow: visible; }
    #clients .bg-white.rounded-2xl.shadow-sm.border { border: none; box-shadow: none; background: transparent; }
    .mgr-mobile-clients-cards { display: block !important; }

    /* Deals section mobile */
    #deals .max-w-7xl { padding: 1rem !important; padding-top: 0.5rem !important; }
    #deals h1.text-3xl { font-size: 1.25rem; }
    #deals .mt-2 { margin-top: 0.25rem; font-size: 0.8125rem; }
    #deals .grid-cols-1.md\\:grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }
    #deals .grid-cols-1.md\\:grid-cols-4 > div {
        padding: 0.75rem !important;
        border-radius: 1rem !important;
    }
    #deals .grid-cols-1.md\\:grid-cols-4 .text-2xl { font-size: 1.125rem; }
    #deals .grid-cols-1.md\\:grid-cols-4 .text-sm { font-size: 0.6875rem; }
    #deals .grid-cols-1.md\\:grid-cols-4 .w-10 { width: 2rem; height: 2rem; }
    #deals .grid-cols-1.md\\:grid-cols-4 .w-10 svg { width: 1rem; height: 1rem; }
    #deals table#deals-table { display: none; }
    #deals .overflow-x-auto { overflow: visible; }
    .mgr-mobile-deals-cards { display: block !important; }
    #deals .p-5.border-b { padding: 0.75rem; }
    #deals #search-deals { font-size: 0.8125rem; padding-top: 0.5rem; padding-bottom: 0.5rem; }
    #deals select#status-filter { font-size: 0.8125rem; padding: 0.5rem 0.75rem; }

    /* Collections section mobile */
    #collections .max-w-7xl { padding: 1rem !important; }
    #collections h2.text-2xl { font-size: 1.25rem; }
    #collections .bg-white.rounded-xl.shadow-sm.p-6 { padding: 1rem; }
    #collections .flex.justify-between.items-center.mb-6 { flex-direction: column; align-items: stretch; gap: 0.75rem; margin-bottom: 1rem; }
    #collections .grid { gap: 0.75rem !important; }

    /* Presentations section mobile */
    #presentations .max-w-7xl { padding: 1rem !important; padding-top: 0.5rem !important; }
    #presentations h2.text-2xl { font-size: 1.25rem; }
    #presentations .grid { gap: 0.75rem !important; }

    /* Saved searches section mobile */
    #saved-searches .max-w-7xl { padding: 1rem !important; }
    #saved-searches h2.text-lg { font-size: 1.125rem; }
    #saved-searches .p-5 { padding: 0.75rem; }
    #saved-searches .flex.items-center.justify-between.p-5 { flex-direction: column; align-items: stretch; gap: 0.75rem; padding: 0.75rem; }
    #saved-searches .grid { gap: 0.75rem !important; }

    /* Comparison section mobile */
    #comparison .max-w-7xl { padding: 1rem !important; }
    #comparison h1.text-3xl { font-size: 1.25rem; }
    #comparison .grid-cols-1.md\\:grid-cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }
    #comparison .grid-cols-1.md\\:grid-cols-3 > div:last-child:nth-child(odd) {
        grid-column: 1 / -1;
    }
    #comparison .grid-cols-1.md\\:grid-cols-3 > div {
        padding: 0.75rem !important;
        border-radius: 1rem !important;
    }
    #comparison .grid-cols-1.md\\:grid-cols-3 .text-2xl { font-size: 1.125rem; }
    #comparison .comp-tab-button { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
    #comp-table-container .overflow-x-auto { -webkit-overflow-scrolling: touch; }
    #comp-table-container table th,
    #comp-table-container table td { padding: 0.5rem 0.75rem; font-size: 0.75rem; white-space: nowrap; }
    #comp-table-container table th.w-48 { width: auto; min-width: 100px; }
    #comp-table-container .px-6.py-4.bg-gray-50 { padding: 0.75rem; flex-direction: column; gap: 0.5rem; }
    #comparison .flex.gap-3 { gap: 0.5rem; }
    #comparison .flex.gap-3 button { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
    #sendCompClientModal > div { margin: 0; max-width: 100%; border-radius: 0; min-height: 100vh; }
    #sendCompClientModal { padding: 0; }

    /* Favorites section mobile */
    #favorites .max-w-7xl { padding: 1rem !important; padding-top: 0.5rem !important; }
    #favorites .grid-cols-1.md\\:grid-cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }

    /* Mobile bottom padding for all sections */
    .content-section > div:last-child {
        padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
    }

    /* Activity section - mobile card-like items */
    #recent-recommendations > div {
        padding: 10px 8px !important;
        border-bottom: 1px solid #f3f4f6;
        border-radius: 0 !important;
        gap: 10px !important;
    }
    #recent-recommendations > div:last-child {
        border-bottom: none;
    }
    #recent-recommendations > div .flex-shrink-0 .w-10 {
        width: 32px !important;
        height: 32px !important;
    }
    #recent-recommendations > div .flex-shrink-0 .w-10 svg {
        width: 14px !important;
        height: 14px !important;
    }
    #recent-recommendations > div .flex-1 {
        min-width: 0;
        overflow: hidden;
    }
    #recent-recommendations > div .flex-1 p.text-sm.font-medium {
        font-size: 13px !important;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #recent-recommendations > div .flex-1 p.text-sm.text-gray-600 {
        font-size: 11px !important;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #recent-recommendations > div > span.text-xs {
        font-size: 10px !important;
        flex-shrink: 0;
        max-width: 60px;
        text-align: right;
    }
    #recent-recommendations .text-center.py-12 {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    #recent-recommendations .w-16 {
        width: 2.5rem;
        height: 2.5rem;
    }
    #recent-recommendations .w-16 svg {
        width: 1.25rem;
        height: 1.25rem;
    }

    /* Header notification bell mobile */
    #mgr-notification-bell-btn .absolute.-top-1 {
        font-size: 9px;
        width: 16px;
        height: 16px;
    }
}
</style>

<!-- Include Sidebar Component -->
{% if sidebar_links is defined and sidebar_links %}
{% include 'components/sidebar.html' %}
{% endif %}

<!-- Main Content with sidebar margin -->
<div class="{% if sidebar_links is defined and sidebar_links %}md:ml-[70px]{% endif %} transition-all duration-300">

<!-- Compact Top Panel -->
<div class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-3">
            <div class="flex items-center gap-3">
                <div class="flex w-8 h-8 bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg items-center justify-center text-white font-bold text-sm">
                    In
                </div>
                <span class="hidden md:inline font-bold text-gray-900 text-lg">InBack</span>
                {% if current_manager.email.startswith('demo') %}
                <span class="px-2 py-0.5 text-xs bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-full font-medium">DEMO</span>
                {% endif %}
            </div>

            <div class="flex items-center gap-4">
                <a href="/" class="hidden sm:flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-gray-700 px-4 py-2 rounded-full border border-blue-200 transition-colors">
                    <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span class="text-sm font-medium">На сайт</span>
                </a>

                <div class="relative" id="mgr-notification-bell-container">
                    <button id="mgr-notification-bell-btn" class="relative flex items-center justify-center w-9 h-9 rounded-full hover:bg-gray-100 transition-colors" title="Уведомления">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <span id="mgr-notification-badge" class="hidden absolute -top-0.5 -right-0.5 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" style="font-size: 10px;">0</span>
                    </button>
                    <div id="mgr-notification-dropdown" class="hidden absolute right-0 mt-2 w-80 sm:w-96 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden">
                        <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-900">Уведомления</h3>
                            <button id="mgr-mark-all-read-btn" class="text-xs text-[#0088CC] hover:text-[#006699] font-medium transition-colors hidden">Прочитать все</button>
                        </div>
                        <div id="mgr-notification-list" class="max-h-80 overflow-y-auto">
                            <div class="flex items-center justify-center py-8 text-gray-400">
                                <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                                <span class="text-sm">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <button id="avatar-dropdown-btn" class="flex items-center gap-2 hover:bg-gray-50 rounded-lg p-1 transition-colors">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center shadow-sm overflow-hidden">
                            {% if current_manager.profile_image %}
                            <img src="{{ current_manager.profile_image }}" alt="{{ current_manager.full_name }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full bg-gradient-to-r from-[#0088CC] to-[#006699] flex items-center justify-center text-white font-bold text-sm">
                                {{ current_manager.full_name[0].upper() if current_manager.full_name else 'M' }}
                            </div>
                            {% endif %}
                        </div>
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <div id="avatar-dropdown-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                                    {% if current_manager.profile_image %}
                                    <img src="{{ current_manager.profile_image }}" alt="{{ current_manager.full_name }}" class="w-full h-full object-cover">
                                    {% else %}
                                    <div class="w-full h-full bg-gradient-to-r from-[#0088CC] to-[#006699] flex items-center justify-center text-white font-bold text-sm">
                                        {{ current_manager.full_name[0].upper() if current_manager.full_name else 'M' }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ current_manager.full_name }}</p>
                                    <p class="text-xs text-[#0088CC] font-medium">{{ current_manager.display_position }}</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">{{ current_manager.email }}</p>
                        </div>
                        <a href="{{ url_for('manager_profile') }}" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Профиль
                        </a>
                        <div id="desktopShiftBlock" class="px-4 py-3 border-b border-gray-100">
                            <div class="flex items-center gap-3">
                                <div id="deskShiftIconWrap" class="w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg id="deskShiftIconInactive" class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    <svg id="deskShiftIconActive" class="w-4 h-4 text-green-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div id="deskShiftLabel" class="text-xs text-gray-400">Смена не начата</div>
                                    <div class="text-sm font-bold text-gray-900" id="deskShiftDuration">--:--:--</div>
                                </div>
                                <button id="deskShiftToggleBtn" onclick="toggleCheckin()" class="flex items-center justify-center w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 text-white transition-colors shadow-sm">
                                    <svg id="deskShiftPlayIcon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                                    <svg id="deskShiftStopIcon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/></svg>
                                </button>
                            </div>
                        </div>
                        <a href="{{ url_for('logout') }}" class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            Выход
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">

            <!-- Welcome Header -->
            <div class="mb-6 md:mb-8 mgr-welcome-header">
                <div class="flex items-center gap-3 md:gap-4 mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-xl flex items-center justify-center flex-shrink-0" id="welcome-icon">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900" id="welcome-title">
                            Добро пожаловать, {{ current_manager.full_name.split()[0] }}!
                        </h1>
                        <p class="text-gray-600" id="welcome-messages">Панель управления менеджера недвижимости</p>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 mgr-stats-grid">
                <!-- Clients Card -->
                <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('clients')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ total_clients }}</div>
                        <div class="text-sm opacity-90">Клиентов</div>
                    </div>
                    <div class="text-xs opacity-75">Управление клиентами</div>
                </div>

                <!-- Deals Card -->
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('deals')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ deals_count }}</div>
                        <div class="text-sm opacity-90">Активных сделок</div>
                    </div>
                    <div class="text-xs opacity-75">Управление сделками</div>
                </div>

                <!-- Collections Card -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('collections')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ collections_count }}</div>
                        <div class="text-sm opacity-90">Подборок</div>
                    </div>
                    <div class="text-xs opacity-75">Редактирование и отправка</div>
                </div>

                <!-- Presentations Card -->
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('presentations')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                                <path d="M16 5a1 1 0 011 1v8a1 1 0 01-1 1h-4V5h4z"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold">{{ presentations_count }}</div>
                        <div class="text-sm opacity-90">Презентаций</div>
                    </div>
                    <div class="text-xs opacity-75">Маркетинговые материалы</div>
                </div>

                <!-- Favorites Card -->
                <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('favorites')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold"><span id="new-properties-count">0</span></div>
                        <div class="text-sm opacity-90">Избранных объектов</div>
                    </div>
                    <div class="text-xs opacity-75"><span id="new-complexes-count">0</span> ЖК сохранено</div>
                </div>

                <!-- Comparison Card -->
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('comparison')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold" id="comparison-stat-count">0</div>
                        <div class="text-sm opacity-90">В сравнении</div>
                    </div>
                    <div class="text-xs opacity-75">Анализ объектов</div>
                </div>

                <!-- Saved Searches Card -->
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer" onclick="showSection('saved-searches')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <div class="text-3xl font-bold" id="saved-searches-stat-count">0</div>
                        <div class="text-sm opacity-90">Сохраненных поисков</div>
                    </div>
                    <div class="text-xs opacity-75">Быстрый доступ к фильтрам</div>
                </div>

                <!-- Quick Create Banner -->
                <a href="/properties" class="block bg-gradient-to-r from-[#0088CC] via-[#0099DD] to-[#00AAEE] rounded-2xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform cursor-pointer relative overflow-hidden mgr-create-banner">
                    <div class="absolute top-0 right-0 opacity-10">
                        <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <div class="relative z-10 flex items-center justify-between gap-6">
                        <div class="flex-1">
                            <div class="inline-block px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold mb-3 backdrop-blur-sm">
                                Быстрое действие
                            </div>
                            <h3 class="text-2xl font-bold mb-2">Создать подборку</h3>
                            <p class="text-sm opacity-90 mb-3">Подберите недвижимость для клиента</p>
                            <div class="flex items-center gap-4 text-xs opacity-85">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Поиск по фильтрам
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Отправка клиенту
                                </span>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <div class="hidden lg:flex w-16 h-16 bg-white bg-opacity-20 rounded-full items-center justify-center backdrop-blur-sm flex-shrink-0">
                                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <svg class="w-5 h-5 opacity-75 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Recent Activity + Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 mgr-activity-grid">
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-4 md:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Последняя активность</h3>
                            <p class="text-sm text-gray-500 mt-1">За последние 7 дней</p>
                        </div>
                    </div>
                    <div id="recent-recommendations" class="space-y-1">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h4 class="text-sm font-medium text-gray-900 mb-1">Нет активности</h4>
                            <p class="text-sm text-gray-500">Активности пока нет. Начните работу с клиентами!</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 md:space-y-4 quick-actions-list">
                    <h3 class="text-lg md:text-xl font-bold text-gray-900 mb-3 md:mb-4">Быстрые действия</h3>
                    <a href="#" onclick="showAddClientModal(); return false;" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Добавить клиента</h4>
                            <p class="text-sm text-gray-500">Новый клиент в базу</p>
                        </div>
                    </a>
                    <a href="/properties" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Создать подборку</h4>
                            <p class="text-sm text-gray-500">Подборка недвижимости</p>
                        </div>
                    </a>
                    <a href="#" onclick="showSection('deals'); return false;" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Создать сделку</h4>
                            <p class="text-sm text-gray-500">Новая сделка с клиентом</p>
                        </div>
                    </a>
                    <a href="/manager/kanban" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-sky-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-columns text-[#0088CC] text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Канбан сделок</h4>
                            <p class="text-sm text-gray-500">Воронка продаж</p>
                        </div>
                    </a>
                    <a href="/manager/calendar" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-calendar-alt text-amber-600 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Календарь задач</h4>
                            <p class="text-sm text-gray-500">Расписание и дедлайны</p>
                        </div>
                    </a>
                    <a href="/manager/employees" class="group flex items-center space-x-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                        <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-users text-[#0088CC] text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Сотрудники</h4>
                            <p class="text-sm text-gray-500">Команда и статусы</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Clients Section -->
        <div class="content-section" id="clients">
            <div class="hidden max-md:flex items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
                <button onclick="switchMgrTab('dashboard')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-[#0088CC]/10 text-[#0088CC]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="flex-1 min-w-0">
                    <h1 class="text-sm font-bold text-gray-900">Клиенты</h1>
                    <p class="text-xs text-gray-500">Управление клиентами</p>
                </div>
                <button onclick="showAddClientModal()" class="flex items-center gap-1.5 bg-[#0088CC] text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Добавить
                </button>
            </div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6 max-md:hidden">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Управление клиентами</h2>
                        <p class="text-sm text-gray-500 mt-1">Все ваши клиенты в одном месте</p>
                    </div>
                    <button onclick="showAddClientModal()" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#004466] text-white rounded-xl text-sm font-medium transition-all shadow-sm hover:shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Добавить клиента
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="clients-search-input" placeholder="Поиск по имени, email или телефону..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-transparent text-sm"
                               oninput="filterClients(this.value)">
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Клиент</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">Телефон</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">Email</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">Предпочтения</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">Дата</th>
                                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="6" class="text-center py-8 text-gray-500">Загрузка клиентов...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mgr-mobile-clients-cards hidden space-y-2 p-3" id="clients-mobile-cards"></div>
                </div>
            </div>
        </div>

        <!-- Create Collection Section -->
        <div class="content-section" id="create-collection">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Создать подборку недвижимости</h2>
                    
                    <!-- Collection Form -->
                    <form id="collection-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Название подборки</label>
                                <input type="text" id="collection-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="Введите название подборки">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Клиент</label>
                                <div class="flex space-x-2">
                                    <select id="collection-client" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="">Выберите клиента</option>
                                    </select>
                                    <button type="button" id="add-client-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm whitespace-nowrap">
                                        + Добавить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Search Section -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Поиск недвижимости</h3>
                            <div class="space-y-4" id="property-search-container">
                                <!-- Основные фильтры -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Район</label>
                                        <select id="filter-district" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все районы</option>
                                            {% for district in districts %}
                                            <option value="{{ district }}">{{ district }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Застройщик</label>
                                        <select id="filter-developer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все застройщики</option>
                                            {% for developer in developers %}
                                            <option value="{{ developer }}">{{ developer }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Комнаты</label>
                                        <select id="filter-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Любое количество</option>
                                            <option value="студия">Студия</option>
                                            <option value="1">1 комната</option>
                                            <option value="2">2 комнаты</option>
                                            <option value="3">3 комнаты</option>
                                            <option value="4">4+ комнат</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Жилой комплекс</label>
                                        <select id="filter-complex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все ЖК</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Цена и площадь -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена от</label>
                                        <input type="number" id="filter-price-min" placeholder="От, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена до</label>
                                        <input type="number" id="filter-price-max" placeholder="До, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь от</label>
                                        <input type="number" id="filter-area-min" placeholder="От, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь до</label>
                                        <input type="number" id="filter-area-max" placeholder="До, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                </div>

                                <!-- Дополнительные фильтры (скрытые по умолчанию) -->
                                <div class="border-t pt-4">
                                    <button id="toggle-advanced-filters" class="text-[#0088cc] hover:text-[#006699] text-sm font-medium mb-4">
                                        + Дополнительные фильтры
                                    </button>
                                    <div id="advanced-filters" class="manager-favorites-hidden space-y-4">
                                        <!-- Этажи и характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж от</label>
                                                <input type="number" id="filter-floor-min" placeholder="От" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж до</label>
                                                <input type="number" id="filter-floor-max" placeholder="До" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой статус</option>
                                                    <option value="строительство">Строительство</option>
                                                    <option value="сдан">Сдан</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Отделка</label>
                                                <select id="filter-finishing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любая отделка</option>
                                                    <option value="черновая">Черновая</option>
                                                    <option value="чистовая">Стандартная</option>
                                                    <option value="под ключ">Премиум</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Дополнительные характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Класс дома</label>
                                                <select id="filter-class" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой класс</option>
                                                    <option value="эконом">Эконом</option>
                                                    <option value="комфорт">Комфорт</option>
                                                    <option value="бизнес">Бизнес</option>
                                                    <option value="элитный">Элитный</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Материал стен</label>
                                                <select id="filter-material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой материал</option>
                                                    <option value="кирпич">Кирпич</option>
                                                    <option value="монолит">Монолит</option>
                                                    <option value="панель">Панель</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков от</label>
                                                <input type="number" id="filter-ceiling-min" placeholder="От, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков до</label>
                                                <input type="number" id="filter-ceiling-max" placeholder="До, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                        </div>
                                        
                                        <!-- Удобства -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-balcony" class="mr-2 text-[#0088cc]">
                                                    Балкон/Лоджия
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-parking" class="mr-2 text-[#0088cc]">
                                                    Парковка
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-view" class="mr-2 text-[#0088cc]">
                                                    Красивый вид
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-penthouse" class="mr-2 text-[#0088cc]">
                                                    Пентхаус
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Ипотека -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-family-mortgage" class="mr-2 text-[#0088cc]">
                                                    Семейная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-it-mortgage" class="mr-2 text-[#0088cc]">
                                                    IT ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-military-mortgage" class="mr-2 text-[#0088cc]">
                                                    Военная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-rural-mortgage" class="mr-2 text-[#0088cc]">
                                                    Сельская ипотека
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Результаты поиска -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex items-center space-x-4">
                                            <h4 class="text-lg font-medium text-gray-800">Результаты поиска</h4>
                                            <span id="results-count" class="text-sm text-gray-500">0 квартир</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="saveCurrentSearch()" class="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                                <i class="fas fa-save"></i> Сохранить поиск
                                            </button>
                                            <button onclick="showSavedSearches()" class="px-3 py-2 bg-[#0088CC] text-white rounded text-sm hover:bg-[#006699]">
                                                <i class="fas fa-folder"></i> Сохранённые поиски
                                            </button>
                                        </div>
                                    </div>
                                        <div class="flex items-center space-x-3">
                                            <!-- View toggle -->
                                            <div class="flex border border-gray-300 rounded-lg">
                                                <button type="button" id="view-grid-btn" class="px-3 py-2 text-sm bg-[#0088cc] text-white rounded-l-lg">
                                                    <i class="fas fa-th"></i>
                                                </button>
                                                <button type="button" id="view-list-btn" class="px-3 py-2 text-sm bg-white text-gray-600 border-l border-gray-300 rounded-r-lg hover:bg-gray-50">
                                                    <i class="fas fa-list"></i>
                                                </button>
                                            </div>
                                            <button type="button" id="search-apartments-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                                Найти квартиры
                                            </button>
                                        </div>
                                    </div>
                                    <div id="properties-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>
                                    </div>
                                </div>

                                <!-- Выбранные объекты -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-lg font-medium text-gray-800">Выбранные объекты для подборки</h4>
                                        <span id="selected-count" class="text-sm text-gray-500">0 объектов</span>
                                    </div>
                                    <div id="selected-properties" class="space-y-3">
                                        <p class="text-gray-500 text-center py-4">Объекты не выбраны</p>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button type="button" id="clear-selection-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" disabled>
                                            Очистить выбор
                                        </button>
                                        <div class="space-x-3">
                                            <button type="button" id="save-collection-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" disabled>
                                                Сохранить подборку
                                            </button>
                                            <button type="button" id="send-collection-btn" class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors" disabled>
                                                Отправить клиенту
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Мои подборки</h2>
                            <button onclick="showSection('create-collection')" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать новую
                            </button>
                        </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="collections-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Загрузка подборок...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Presentations Section -->
            <div class="content-section" id="presentations">
                <div class="hidden max-md:flex items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
                    <button onclick="switchMgrTab('dashboard')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-[#0088CC]/10 text-[#0088CC]">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-sm font-bold text-gray-900">Презентации</h1>
                        <p class="text-xs text-gray-500">Подборки объектов</p>
                    </div>
                    <button onclick="showCreatePresentationModal()" class="flex items-center gap-1.5 bg-[#0088CC] text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Создать
                    </button>
                </div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Presentations List View -->
                    <div id="presentations-list-view">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6 max-md:hidden">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Презентации</h2>
                                <p class="text-sm text-gray-500 mt-1">Подборки объектов для ваших клиентов</p>
                            </div>
                            <button onclick="showCreatePresentationModal()" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#004466] text-white rounded-xl text-sm font-medium transition-all shadow-sm hover:shadow-md">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                                Создать презентацию
                            </button>
                        </div>

                        <!-- Presentations Grid -->
                        <div id="presentations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="col-span-full text-center py-8 text-gray-500">Загрузка презентаций...</div>
                        </div>
                    </div>

                    <!-- Presentation Viewer (Hidden by default) -->
                    <div id="presentation-viewer" class="hidden">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-5 border-b border-gray-100 gap-2">
                                <button onclick="showPresentationsList()" class="inline-flex items-center px-3 py-1.5 sm:px-4 sm:py-2 text-sm font-medium text-gray-700 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors self-start">
                                    <svg class="w-4 h-4 mr-1.5 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    Назад к списку
                                </button>
                                <div id="presentation-viewer-actions" class="flex items-center space-x-2 flex-wrap gap-y-1">
                                </div>
                            </div>
                            <div id="presentation-content" class="p-3 sm:p-5">
                                <div class="text-center py-12">
                                    <div class="w-12 h-12 border-4 border-gray-200 border-t-[#0088CC] rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-sm text-gray-500">Загрузка презентации...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Рекомендации клиентам</h2>
                        <div class="flex gap-2">
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                <i class="fas fa-sync mr-2"></i>
                                Обновить
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Отправлено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-sent">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-eye text-2xl text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотрено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-viewed">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-sky-50 to-sky-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-heart text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Заинтересованы</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-interested">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-calendar text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотры назначены</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-scheduled">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="rec-filter-client" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все клиенты</option>
                            </select>
                            <select id="rec-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все статусы</option>
                                <option value="sent">Отправлено</option>
                                <option value="viewed">Просмотрено</option>
                                <option value="interested">Заинтересованы</option>
                                <option value="not_interested">Не заинтересованы</option>
                                <option value="scheduled_viewing">Просмотр назначен</option>
                            </select>
                            <select id="rec-filter-type" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все типы</option>
                                <option value="property">Квартиры</option>
                                <option value="complex">ЖК</option>
                            </select>
                            <select id="rec-filter-priority" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все приоритеты</option>
                                <option value="urgent">Срочно</option>
                                <option value="high">Высокий</option>
                                <option value="normal">Обычный</option>
                            </select>
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                Применить фильтры
                            </button>
                        </div>
                    </div>

                    <!-- Recommendations List -->
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Загрузка рекомендаций...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Saved Searches Section -->
            <div class="content-section" id="saved-searches">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between p-5 border-b border-gray-100">
                            <div>
                                <h2 class="text-lg font-bold text-gray-900">Сохранённые поиски</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Быстрый доступ к настроенным фильтрам</p>
                            </div>
                            <button onclick="createNewSearch()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Создать поиск
                            </button>
                        </div>
                        <div class="p-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="saved-searches-grid">
                                <div class="text-center py-12 col-span-full">
                                    <div class="w-12 h-12 border-4 border-gray-200 border-t-[#0088CC] rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-sm text-gray-500">Загрузка сохранённых поисков...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deals Section -->
            <div class="content-section" id="deals">
                <div class="hidden max-md:flex items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
                    <button onclick="switchMgrTab('dashboard')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-[#0088CC]/10 text-[#0088CC]">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-sm font-bold text-gray-900">Сделки</h1>
                        <p class="text-xs text-gray-500">Управление сделками</p>
                    </div>
                    <button onclick="openCreateDealModal()" class="flex items-center gap-1.5 bg-[#0088CC] text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Создать
                    </button>
                </div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 max-md:hidden">
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Сделки</h1>
                            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Отслеживайте и управляйте сделками с клиентами</p>
                        </div>
                        <button onclick="openCreateDealModal()" 
                                class="inline-flex items-center px-5 py-2.5 bg-[#0088CC] hover:bg-[#006699] text-white rounded-xl font-medium transition-colors text-sm shadow-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Новая сделка
                        </button>
                    </div>

                    <div class="flex gap-2 mb-5 overflow-x-auto pb-1 -mx-1 px-1">
                        <a href="{{ url_for('manager_deals_kanban') }}" class="inline-flex items-center gap-1.5 px-3.5 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium text-gray-700 hover:border-[#0088CC] hover:text-[#0088CC] transition-colors whitespace-nowrap shadow-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4zm5 0a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H8a1 1 0 01-1-1V4zm6-1a1 1 0 00-1 1v12a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3z"/></svg>
                            Канбан
                        </a>
                        <a href="{{ url_for('manager_tasks_calendar') }}" class="inline-flex items-center gap-1.5 px-3.5 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium text-gray-700 hover:border-[#0088CC] hover:text-[#0088CC] transition-colors whitespace-nowrap shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Календарь
                        </a>
                        <a href="{{ url_for('manager_deals_archive') }}" class="inline-flex items-center gap-1.5 px-3.5 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium text-gray-700 hover:border-[#0088CC] hover:text-[#0088CC] transition-colors whitespace-nowrap shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                            Архив
                        </a>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="active-deals-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">Активных сделок</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="completed-deals-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">Завершено</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="in-progress-deals-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">В процессе</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="total-cashback">0 ₽</div>
                            </div>
                            <div class="text-sm opacity-90">Общий кешбэк</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                        <div class="p-5 border-b border-gray-100">
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                <div class="relative flex-1">
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                    <input type="text" id="search-deals" placeholder="Поиск по номеру, клиенту или ЖК..."
                                           class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0088CC]/20 focus:border-[#0088CC] text-sm transition-all">
                                </div>
                                <select id="status-filter" 
                                        class="px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0088CC]/20 focus:border-[#0088CC] text-sm bg-white transition-all">
                                    <option value="">Все статусы</option>
                                    <option value="new">Новые</option>
                                    <option value="object_reserved">Зарезервирован</option>
                                    <option value="mortgage">Ипотека</option>
                                    <option value="successful">Завершены</option>
                                    <option value="rejected">Отклонены</option>
                                </select>
                                <button onclick="clearFilters()" 
                                        class="px-4 py-2.5 text-gray-500 hover:text-gray-700 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors text-sm">
                                    Сбросить
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full" id="deals-table">
                                <thead>
                                    <tr class="border-b border-gray-100">
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Номер</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Клиент</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ЖК</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Стоимость</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Кешбэк</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Статус</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Дата</th>
                                        <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50" id="deals-tbody">
                                    <tr id="no-deals-row">
                                        <td colspan="8" class="px-6 py-16 text-center">
                                            <div class="flex flex-col items-center">
                                                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                                                    <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                                </div>
                                                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет сделок</h4>
                                                <p class="text-sm text-gray-500 mb-4">Создайте первую сделку с клиентом</p>
                                                <button onclick="openCreateDealModal()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                                    Создать сделку
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mgr-mobile-deals-cards hidden space-y-2 p-3" id="deals-mobile-cards"></div>
                    </div>
                </div>
            </div>

           

            <!-- Combined Favorites Section -->
            <div class="content-section" id="favorites">
                <div class="hidden max-md:flex items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
                    <button onclick="switchMgrTab('dashboard')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-[#0088CC]/10 text-[#0088CC]">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-sm font-bold text-gray-900">Избранное</h1>
                        <p class="text-xs text-gray-500">Сохранённые объекты</p>
                    </div>
                </div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="favorites-properties-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">Квартир</div>
                            <div class="text-xs opacity-75 mt-1">В избранном</div>
                        </div>
                        <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2h6v4H7V6zm8 0h2v4h-2V6zM5 6h2v4H5V6zm0 6h2v4H5v-4zm4 0h6v4H9v-4z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="favorites-complexes-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">Жилых комплексов</div>
                            <div class="text-xs opacity-75 mt-1">В избранном</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="favorites-total-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">Всего в избранном</div>
                            <div class="text-xs opacity-75 mt-1">Готовы к просмотру</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                        <div class="border-b border-gray-100">
                            <nav class="flex space-x-0" aria-label="Tabs">
                                <button class="flex-1 md:flex-none px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap favorites-tab-button active" data-tab="properties">
                                    <svg class="w-4 h-4 mr-1 md:mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                    Квартиры
                                    <span class="ml-1 md:ml-1.5 bg-[#0088CC] text-white text-xs px-1.5 md:px-2 py-0.5 rounded-full font-medium" id="favorites-props-badge">0</span>
                                </button>
                                <button class="flex-1 md:flex-none px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap favorites-tab-button" data-tab="complexes">
                                    <svg class="w-4 h-4 mr-1 md:mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                    <span class="hidden sm:inline">Жилые комплексы</span><span class="sm:hidden">ЖК</span>
                                    <span class="ml-1 md:ml-1.5 bg-gray-200 text-gray-600 text-xs px-1.5 md:px-2 py-0.5 rounded-full font-medium" id="favorites-cx-badge">0</span>
                                </button>
                            </nav>
                        </div>

                        <div class="p-5">
                            <div id="favorites-properties-tab" class="favorites-tab-content active">
                                <div id="empty-properties" class="text-center py-16">
                                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                                    </div>
                                    <h4 class="text-sm font-medium text-gray-900 mb-1">Нет избранных объектов</h4>
                                    <p class="text-sm text-gray-500 mb-4">Добавьте квартиры в избранное для быстрого доступа</p>
                                    <button onclick="window.location.href='/properties'" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        Найти квартиру
                                    </button>
                                </div>
                                <div id="properties-container" class="manager-favorites-hidden">
                                    <div id="properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    </div>
                                </div>
                            </div>

                            <div id="favorites-complexes-tab" class="favorites-tab-content">
                                <div id="empty-complexes" class="text-center py-16">
                                    <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-8 h-8 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                    </div>
                                    <h4 class="text-sm font-medium text-gray-900 mb-1">Нет избранных ЖК</h4>
                                    <p class="text-sm text-gray-500 mb-4">Добавьте жилые комплексы в избранное для отслеживания</p>
                                    <button onclick="window.location.href='/complexes'" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        Посмотреть ЖК
                                    </button>
                                </div>
                                <div id="favorite-complexes-container">
                                    <div id="favorite-complexes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Section -->
            <div class="content-section" id="comparison">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Сравнение</h1>
                            <p class="mt-2 text-gray-600">Сравнивайте характеристики объектов для клиентов</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="clear-comparison-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                                Очистить все
                            </button>
                            <button id="export-comparison-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                Экспорт в PDF
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="comp-total-count">0</div>
                            </div>
                            <div class="text-sm opacity-90">В сравнении</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <span class="text-lg font-bold">₽</span>
                                </div>
                                <div class="text-2xl font-bold" id="comp-average-price">—</div>
                            </div>
                            <div class="text-sm opacity-90">Средняя цена</div>
                        </div>
                        <div class="bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-2xl shadow-lg p-5 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                                </div>
                                <div class="text-2xl font-bold" id="comp-average-area">—</div>
                            </div>
                            <div class="text-sm opacity-90">Средняя площадь</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                        <div class="border-b border-gray-100">
                            <nav class="flex space-x-0" aria-label="Comparison Tabs">
                                <button class="flex-1 md:flex-none px-6 py-4 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap comp-tab-button active" data-comp-tab="properties">
                                    <svg class="w-4 h-4 mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                    Квартиры
                                </button>
                                <button class="flex-1 md:flex-none px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap comp-tab-button" data-comp-tab="complexes">
                                    <svg class="w-4 h-4 mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                    ЖК
                                </button>
                            </nav>
                        </div>

                        <div class="p-5">
                            <div id="comp-empty-state" class="text-center py-16">
                                <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </div>
                                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет объектов для сравнения</h4>
                                <p class="text-sm text-gray-500 mb-4">Добавьте объекты к сравнению на страницах объектов и ЖК</p>
                                <button onclick="window.location.href='/properties'" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                    Перейти к объектам
                                </button>
                            </div>

                            <div id="comp-table-container" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50 border-b">
                                            <tr id="comp-table-header">
                                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 w-48">Характеристика</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200" id="comp-table-body">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="px-6 py-4 bg-gray-50 border-t flex justify-between items-center">
                                    <button id="send-comp-btn" class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors text-sm">
                                        Отправить клиенту
                                    </button>
                                    <div class="text-sm text-gray-500">
                                        Последнее обновление: <span id="comp-last-updated">сейчас</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>
</div>

<!-- Send Comparison to Client Modal -->
<div id="sendCompClientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full mx-4 relative">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Отправить клиенту</h3>
            <button onclick="document.getElementById('sendCompClientModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="p-6">
            <form id="sendCompClientForm">
                <div class="mb-4">
                    <label for="compRecipientName" class="block text-sm font-medium text-gray-700 mb-2">Имя получателя</label>
                    <input type="text" id="compRecipientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0088CC] focus:border-transparent" placeholder="Введите имя клиента" required>
                </div>
                <div class="mb-4">
                    <label for="compMessageNotes" class="block text-sm font-medium text-gray-700 mb-2">Сообщение</label>
                    <textarea id="compMessageNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none" placeholder="Дополнительные заметки (необязательно)"></textarea>
                </div>
                <div class="mb-6">
                    <p class="text-sm font-medium text-gray-700 mb-3">Скрыть в документе:</p>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="checkbox" id="compHideComplexNames" class="rounded border-gray-300 text-[#0088CC] focus:ring-[#0088CC]"><span class="ml-2 text-sm text-gray-600">Названия ЖК</span></label>
                        <label class="flex items-center"><input type="checkbox" id="compHideDeveloperNames" class="rounded border-gray-300 text-[#0088CC] focus:ring-[#0088CC]"><span class="ml-2 text-sm text-gray-600">Названия застройщиков</span></label>
                        <label class="flex items-center"><input type="checkbox" id="compHideAddresses" class="rounded border-gray-300 text-[#0088CC] focus:ring-[#0088CC]"><span class="ml-2 text-sm text-gray-600">Адреса объектов</span></label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('sendCompClientModal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">Создать PDF</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Photo Zoom Modal for Comparison -->
<div id="compPhotoZoomModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
    <div class="relative max-w-5xl max-h-full">
        <button onclick="event.stopPropagation(); document.getElementById('compPhotoZoomModal').classList.add('hidden')" class="absolute -top-12 right-0 text-white text-4xl hover:text-gray-300 z-10">&times;</button>
        <img id="compZoomedPhoto" src="" alt="Увеличенное фото" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    </div>
</div>

<script>
// IMMEDIATELY DEFINE CRITICAL FUNCTIONS AT TOP
console.log('🚀 Defining critical functions FIRST...');

// Internal favorites tabs functionality
function switchFavoriteTab(tabName) {
    console.log('🔄 Switching favorites tab to:', tabName);
    
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        const isActive = button.dataset.tab === tabName;
        button.classList.toggle('active', isActive);
        if (isActive) {
            button.classList.remove('border-transparent', 'text-gray-500');
            button.classList.add('border-[#0088CC]', 'text-[#0088CC]');
        } else {
            button.classList.add('border-transparent', 'text-gray-500');
            button.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
        }
    });
    
    const tabContents = document.querySelectorAll('.favorites-tab-content');
    tabContents.forEach(content => {
        const isActive = content.id === `favorites-${tabName}-tab`;
        content.classList.toggle('active', isActive);
        content.classList.toggle('hidden', !isActive);
    });
    
    // Load content based on tab
    if (tabName === 'properties' && document.getElementById('properties-grid').children.length === 0) {
        loadFavoriteProperties();
    } else if (tabName === 'complexes' && document.getElementById('favorite-complexes-grid').children.length === 0) {
        loadFavoriteComplexes();
    }
    
    console.log('✅ Switched to', tabName, 'tab');
}

// Add event listeners for internal tabs
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            switchFavoriteTab(this.dataset.tab);
        });
    });

    const avatarBtn = document.getElementById('avatar-dropdown-btn');
    const avatarMenu = document.getElementById('avatar-dropdown-menu');
    if (avatarBtn && avatarMenu) {
        avatarBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (window.innerWidth < 768) {
                avatarMenu.classList.add('hidden');
                openMgrProfile();
                return;
            }
            avatarMenu.classList.toggle('hidden');
        });
        document.addEventListener('click', function(e) {
            if (!avatarBtn.contains(e.target) && !avatarMenu.contains(e.target)) {
                avatarMenu.classList.add('hidden');
            }
        });
    }

    // ===== MANAGER NOTIFICATION BELL =====
    (function() {
        const bellBtn = document.getElementById('mgr-notification-bell-btn');
        const dropdown = document.getElementById('mgr-notification-dropdown');
        const badge = document.getElementById('mgr-notification-badge');
        const listEl = document.getElementById('mgr-notification-list');
        const markAllBtn = document.getElementById('mgr-mark-all-read-btn');
        if (!bellBtn || !dropdown) return;
        let isOpen = false;
        let loaded = false;

        function getCSRF() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }

        function timeAgo(dateStr) {
            if (!dateStr) return '';
            const diff = (Date.now() - new Date(dateStr).getTime()) / 1000;
            if (diff < 60) return 'только что';
            if (diff < 3600) return Math.floor(diff / 60) + ' мин назад';
            if (diff < 86400) return Math.floor(diff / 3600) + ' ч назад';
            if (diff < 604800) return Math.floor(diff / 86400) + ' дн назад';
            return new Date(dateStr).toLocaleDateString('ru-RU');
        }

        function typeIcon(type) {
            const icons = {
                'success': '<svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                'warning': '<svg class="w-5 h-5 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>',
                'error': '<svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                'info': '<svg class="w-5 h-5 text-[#0088CC] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                'presentation_view': '<svg class="w-5 h-5 text-[#0088CC] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>',
                'deal_update': '<svg class="w-5 h-5 text-[#0088CC] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
            };
            return icons[type] || icons['info'];
        }

        function renderNotifications(notifications) {
            if (!notifications || notifications.length === 0) {
                listEl.innerHTML = '<div class="flex flex-col items-center justify-center py-10 text-gray-400"><svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="text-sm">Нет уведомлений</span></div>';
                markAllBtn.classList.add('hidden');
                return;
            }
            const hasUnread = notifications.some(function(n) { return !n.is_read; });
            if (hasUnread) markAllBtn.classList.remove('hidden');
            else markAllBtn.classList.add('hidden');

            listEl.innerHTML = notifications.map(function(n) {
                const unreadClass = !n.is_read ? 'bg-blue-50' : '';
                const unreadDot = !n.is_read ? '<span class="notif-unread-dot w-2 h-2 bg-[#0088CC] rounded-full flex-shrink-0"></span>' : '';
                return '<div class="notification-item flex items-start gap-3 px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors border-b border-gray-100 ' + unreadClass + '" data-id="' + n.id + '" data-source="' + n.source + '" data-url="' + (n.action_url || '') + '">' +
                    typeIcon(n.type) +
                    '<div class="flex-1 min-w-0">' +
                    '<p class="text-sm font-medium text-gray-900 truncate">' + n.title + '</p>' +
                    '<p class="text-xs text-gray-500 mt-0.5" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">' + n.message + '</p>' +
                    '<p class="text-xs text-gray-400 mt-1">' + timeAgo(n.created_at) + '</p>' +
                    '</div>' +
                    unreadDot +
                    '</div>';
            }).join('');

            listEl.querySelectorAll('.notification-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    var id = this.dataset.id;
                    var source = this.dataset.source;
                    var url = this.dataset.url;
                    var dot = this.querySelector('.notif-unread-dot');
                    if (dot) {
                        fetch('/api/manager/notifications/mark-read', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                            body: JSON.stringify({ id: parseInt(id), source: source })
                        }).then(function() {
                            item.classList.remove('bg-blue-50');
                            dot.remove();
                            updateBadge(-1);
                        });
                    }
                    if (url) window.location.href = url;
                });
            });
        }

        function updateBadge(delta) {
            var count = parseInt(badge.textContent) || 0;
            if (delta === 0) count = 0;
            else count = Math.max(0, count + delta);
            badge.textContent = count < 10 ? count : '9+';
            if (count === 0) badge.classList.add('hidden');
            else badge.classList.remove('hidden');
        }

        function loadNotifications() {
            fetch('/api/manager/notifications').then(function(r) { return r.json(); }).then(function(data) {
                if (data.success) {
                    renderNotifications(data.notifications);
                    var c = data.unread_count || 0;
                    badge.textContent = c < 10 ? c : '9+';
                    if (c > 0) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                }
                loaded = true;
            }).catch(function() {
                listEl.innerHTML = '<div class="text-center py-6 text-gray-400 text-sm">Ошибка загрузки</div>';
                loaded = true;
            });
        }

        bellBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (window.innerWidth < 768) {
                dropdown.classList.add('hidden');
                isOpen = false;
                openMgrNotifications();
                return;
            }
            isOpen = !isOpen;
            dropdown.classList.toggle('hidden', !isOpen);
            if (isOpen && !loaded) loadNotifications();
        });

        markAllBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            fetch('/api/manager/notifications/mark-read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                body: JSON.stringify({ all: true })
            }).then(function() {
                updateBadge(0);
                loaded = false;
                loadNotifications();
            });
        });

        document.addEventListener('click', function(e) {
            if (isOpen && !document.getElementById('mgr-notification-bell-container').contains(e.target)) {
                isOpen = false;
                dropdown.classList.add('hidden');
            }
        });
    })();
});

// ===== NEW OPTIMIZED DASHBOARD LOADER =====
// Makes ONE API call instead of 7-8 sequential calls
window.loadDashboardData = function() {
    const startTime = performance.now();
    console.log('🚀 Loading ALL dashboard data from single API call...');
    
    fetch('/api/manager/dashboard/all')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }
            
            console.log('📦 Received dashboard data:', data);
            
            // ===== 1. UPDATE CLIENTS =====
            if (data.clients) {
                const clientsCountElement = document.getElementById('clients-count');
                if (clientsCountElement) {
                    clientsCountElement.textContent = data.clients.length;
                }
                
                if (typeof window.displayClients === 'function') {
                    window.displayClients(data.clients);
                }
                console.log('✅ Clients updated:', data.clients.length);
            }
            
            // ===== 2. UPDATE WELCOME MESSAGE =====
            if (data.welcome && data.welcome.messages) {
                const container = document.getElementById('welcome-messages');
                const titleElement = document.getElementById('welcome-title');
                
                if (titleElement && data.welcome.messages[0]) {
                    titleElement.textContent = data.welcome.messages[0];
                }
                
                if (container && data.welcome.messages.length > 1) {
                    const messagesHtml = data.welcome.messages.slice(1).map((message, index) => {
                        const className = index === 0 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }).join('');
                    container.innerHTML = messagesHtml;
                }
                console.log('✅ Welcome message updated');
            }
            
            // ===== 3. UPDATE ACTIVITY FEED (RECENT RECOMMENDATIONS) =====
            if (data.activities) {
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    if (data.activities.length === 0) {
                        container.innerHTML = `<div class="text-center py-12">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h4 class="text-sm font-medium text-gray-900 mb-1">Нет активности</h4>
                            <p class="text-sm text-gray-500">Активности пока нет. Начните работу с клиентами!</p>
                        </div>`;
                    } else {
                        const html = data.activities.slice(0, 5).map(activity => {
                            let bgColor = 'bg-blue-100';
                            let textColor = 'text-blue-600';
                            let iconSvg = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>';
                            
                            if (activity.type === 'presentation_view' || activity.icon === 'eye') {
                                bgColor = 'bg-sky-100';
                                textColor = 'text-[#0088CC]';
                                iconSvg = '<path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>';
                            } else if (activity.type === 'recommendation' || activity.icon === 'paper-plane') {
                                bgColor = 'bg-blue-100';
                                textColor = 'text-blue-600';
                                iconSvg = '<path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>';
                            } else if (activity.type === 'task_reminder' || activity.icon === 'clock') {
                                bgColor = 'bg-orange-100';
                                textColor = 'text-orange-600';
                                iconSvg = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>';
                            } else if (activity.icon === 'user-plus') {
                                bgColor = 'bg-green-100';
                                textColor = 'text-green-600';
                                iconSvg = '<path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>';
                            } else if (activity.type === 'deal_update' || activity.icon === 'briefcase') {
                                bgColor = 'bg-sky-100';
                                textColor = 'text-[#0088CC]';
                                iconSvg = '<path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/><path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>';
                            } else if (activity.type === 'task_update' || activity.icon === 'clipboard') {
                                bgColor = 'bg-amber-100';
                                textColor = 'text-amber-600';
                                iconSvg = '<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>';
                            } else if (activity.type === 'comment' || activity.icon === 'chat') {
                                bgColor = 'bg-gray-100';
                                textColor = 'text-gray-600';
                                iconSvg = '<path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>';
                            }
                            
                            return `
                                <div class="flex items-start space-x-4 p-4 rounded-xl hover:bg-gray-50 transition-colors">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 ${textColor}" fill="currentColor" viewBox="0 0 20 20">
                                                ${iconSvg}
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                                        <p class="text-sm text-gray-600 truncate">${activity.description}</p>
                                    </div>
                                    <span class="text-xs text-gray-500 whitespace-nowrap">${activity.time_ago}</span>
                                </div>
                            `;
                        }).join('');
                        container.innerHTML = html;
                    }
                }
                console.log('✅ Activity feed updated:', data.activities.length, 'activities');
            }
            
            // ===== 4. UPDATE FAVORITES COUNTS =====
            if (data.favorites) {
                const totalCount = data.favorites.total_count || 
                                 (data.favorites.properties_count + data.favorites.complexes_count);
                
                const favoritesTotalElement = document.getElementById('favorites-total-count');
                if (favoritesTotalElement) {
                    favoritesTotalElement.textContent = totalCount;
                }
                
                const propertiesCountElement = document.getElementById('favorites-properties-count');
                if (propertiesCountElement) {
                    propertiesCountElement.textContent = data.favorites.properties_count || 0;
                }
                
                const complexesCountElement = document.getElementById('favorites-complexes-count');
                if (complexesCountElement) {
                    complexesCountElement.textContent = data.favorites.complexes_count || 0;
                }
                
                console.log('✅ Favorites counts updated:', totalCount);
            }
            
            // ===== 5. UPDATE SAVED SEARCHES COUNT =====
            if (data.saved_searches) {
                const savedSearchesCountElement = document.getElementById('saved-searches-count');
                if (savedSearchesCountElement && data.saved_searches.count > 0) {
                    savedSearchesCountElement.textContent = data.saved_searches.count;
                    savedSearchesCountElement.style.display = 'inline-block';
                }
                const savedSearchesStatCount = document.getElementById('saved-searches-stat-count');
                if (savedSearchesStatCount) {
                    savedSearchesStatCount.textContent = data.saved_searches.count || 0;
                }
                console.log('✅ Saved searches count updated:', data.saved_searches.count);
            }
            
            // ===== 6. UPDATE DEALS COUNT =====
            if (typeof data.deals_count !== 'undefined') {
                const dealsCountElement = document.getElementById('deals-count');
                if (dealsCountElement) {
                    dealsCountElement.textContent = data.deals_count;
                }
                console.log('✅ Deals count updated:', data.deals_count);
            }
            
            // ===== 7. UPDATE COMPARISON COUNTS =====
            if (data.comparison) {
                const totalCount = data.comparison.total_count || 
                                 (data.comparison.properties_count + data.comparison.complexes_count);
                
                const comparisonCountElement = document.getElementById('comparison-count');
                if (comparisonCountElement) {
                    comparisonCountElement.textContent = totalCount;
                }
                const comparisonStatCount = document.getElementById('comparison-stat-count');
                if (comparisonStatCount) {
                    comparisonStatCount.textContent = totalCount;
                }
                console.log('✅ Comparison count updated:', totalCount);
            }
            
            // ===== SUCCESS - LOG PERFORMANCE =====
            const loadTime = Math.round(performance.now() - startTime);
            console.log(`✅ Dashboard loaded in ${loadTime}ms from single API call`);
            console.log(`⚡ Performance improvement: ~27000ms → ${loadTime}ms (${Math.round((27000 - loadTime) / 270)}% faster)`);
            
        })
        .catch(error => {
            const loadTime = Math.round(performance.now() - startTime);
            console.error('❌ Error loading dashboard data:', error);
            console.error('❌ Error message:', error.message);
            console.error('❌ Error stack:', error.stack);
            console.error(`Failed after ${loadTime}ms`);
            
            // Fallback to individual calls if aggregated call fails
            console.warn('⚠️ Falling back to individual API calls due to error');
            if (typeof window.loadClients === 'function') window.loadClients();
            if (typeof window.loadWelcomeMessage === 'function') window.loadWelcomeMessage();
            if (typeof window.loadRecentRecommendations === 'function') window.loadRecentRecommendations();
        });
};

console.log('✅ loadDashboardData function defined');

// Define loadClients function IMMEDIATELY
window.loadClients = function() {
    console.log('🔄 Loading clients NOW...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Загрузка клиентов...</div>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Clients data received:', data);
            if (data.success) {
                console.log('✅ Success! Displaying', data.clients.length, 'clients');
                
                const clientsCountElement = document.getElementById('clients-count');
                if (clientsCountElement) {
                    clientsCountElement.textContent = data.clients.length;
                    console.log('✅ Updated clients count to:', data.clients.length);
                }
                
                if (typeof window.displayClients === 'function') {
                    window.displayClients(data.clients);
                }
                updateClientSelect(data.clients);
            } else {
                console.error('❌ API returned error:', data.error);
                tableBody.innerHTML = 
                    `<div class="col-span-full text-center py-8 text-red-500">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading clients:', error);
            tableBody.innerHTML = 
                '<div class="col-span-full text-center py-8 text-red-500">Ошибка загрузки клиентов</div>';
        });
};

console.log('✅ loadClients function defined at top:', typeof window.loadClients);

// Define loadRecommendations function IMMEDIATELY
window.loadRecommendations = function() {
    console.log('🔄 Loading recommendations NOW...');
    const container = document.getElementById('recommendations-container');
    
    if (!container) {
        console.error('❌ recommendations-container not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 text-gray-500">Загрузка рекомендаций...</div>';
    
    fetch('/api/manager/recommendations')
        .then(response => {
            console.log('📡 Recommendations response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Recommendations data received:', data);
            if (data.success) {
                console.log('✅ Success! Found', data.recommendations.length, 'recommendations');
                
                // Update recommendations count in tab
                const recommendationsCountElement = document.getElementById('recommendations-count');
                if (recommendationsCountElement) {
                    recommendationsCountElement.textContent = data.recommendations.length;
                    console.log('✅ Updated recommendations count to:', data.recommendations.length);
                }
                
                // Update stats
                if (data.stats) {
                    document.getElementById('recommendations-sent').textContent = data.stats.sent || 0;
                    document.getElementById('recommendations-viewed').textContent = data.stats.viewed || 0;
                    document.getElementById('recommendations-interested').textContent = data.stats.interested || 0;
                    document.getElementById('recommendations-scheduled').textContent = data.stats.scheduled || 0;
                }
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
                } else {
                    container.innerHTML = data.recommendations.map(rec => `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-medium text-gray-900">${rec.property_title || rec.title || 'Объект недвижимости'}</h4>
                                    <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${rec.status || 'Отправлено'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
                            <div class="text-xs text-gray-500">
                                Отправлено: ${new Date(rec.created_at || rec.sent_at).toLocaleDateString('ru-RU')}
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                console.error('❌ API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 text-red-500">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading recommendations:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
        });
};

console.log('✅ loadRecommendations function defined at top:', typeof window.loadRecommendations);

// Define loadManagerSavedSearches function IMMEDIATELY  
window.loadManagerSavedSearches = function() {
    console.log('🔄 Loading manager saved searches NOW...');
    const container = document.getElementById('saved-searches-grid');
    
    if (!container) {
        console.error('❌ saved-searches-grid not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка сохранённых поисков...</p></div>';
    
    fetch('/api/manager/saved-searches')
        .then(response => {
            console.log('📡 Saved searches response status:', response.status);
            if (!response.ok) {
                console.error('❌ Saved searches API error - Status:', response.status);
                return response.text().then(text => {
                    console.error('❌ Response text:', text.substring(0, 200));
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Saved searches data received:', data);
            if (data.success) {
                console.log('✅ Success! Found', data.searches.length, 'saved searches');
                
                if (!data.searches || data.searches.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <div class="text-gray-400 mb-4">
                                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-lg">Сохранённые поиски не найдены</p>
                            <p class="text-gray-400 text-sm mt-2">Создайте поиск на странице "Недвижимость" и сохраните его</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.searches.map(search => {
                        // Parse filters to get meaningful description
                        let filtersDescription = 'Все объекты';
                        let activeFiltersCount = 0;
                        
                        if (search.additional_filters) {
                            try {
                                const filters = JSON.parse(search.additional_filters);
                                const parts = [];
                                
                                if (filters.rooms && filters.rooms.length > 0) {
                                    parts.push(filters.rooms.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.priceFrom || filters.priceTo) {
                                    const from = filters.priceFrom || '0';
                                    const to = filters.priceTo || '∞';
                                    parts.push(`${from}-${to} млн`);
                                    activeFiltersCount++;
                                }
                                
                                if (filters.districts && filters.districts.length > 0) {
                                    parts.push(filters.districts.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.developers && filters.developers.length > 0) {
                                    parts.push(filters.developers.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (parts.length > 0) {
                                    filtersDescription = parts.join(' • ');
                                }
                            } catch (e) {
                                console.error('Error parsing filters:', e);
                            }
                        }
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-900 mb-1">${search.name || 'Без названия'}</h3>
                                        <p class="text-sm text-gray-600">${filtersDescription}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                                        ${activeFiltersCount} ${activeFiltersCount === 1 ? 'фильтр' : activeFiltersCount < 5 ? 'фильтра' : 'фильтров'}
                                    </span>
                                </div>
                                
                                <div class="text-xs text-gray-500 mb-3">
                                    ${new Date(search.created_at).toLocaleDateString('ru-RU')}
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="viewSearch(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white rounded text-sm hover:bg-[#006699] transition-colors">
                                        Просмотр
                                    </button>
                                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                        Отправить
                                    </button>
                                    <button onclick="deleteSearch(${search.id})" class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm hover:bg-red-50 hover:text-red-600 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zM8 11a1 1 0 102 0v2a1 1 0 11-2 0v-2zm4 0a1 1 0 102 0v2a1 1 0 11-2 0v-2z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } else {
                console.error('❌ API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading saved searches:', error);
            container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка загрузки сохранённых поисков</p></div>';
        });
};

console.log('✅ loadManagerSavedSearches function defined at top:', typeof window.loadManagerSavedSearches);

// Define missing functions for saved searches
window.viewSearch = function(searchId) {
    console.log('🔍 View search:', searchId);
    
    fetch(`/api/manager/saved-searches`)
        .then(response => {
            if (!response.ok) {
                console.error('❌ View search API error - Status:', response.status);
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const search = data.searches.find(s => s.id === searchId);
                if (search && search.additional_filters) {
                    try {
                        const filters = JSON.parse(search.additional_filters);
                        
                        if (filters.search_url) {
                            console.log('🔍 Opening saved search_url:', filters.search_url);
                            window.open(filters.search_url, '_blank');
                            return;
                        }
                        
                        const params = new URLSearchParams();
                        
                        if (filters.rooms && filters.rooms.length > 0) {
                            filters.rooms.forEach(r => params.append('rooms[]', r));
                        }
                        if (filters.price_min && filters.price_min !== '') {
                            params.append('price_min', filters.price_min);
                        }
                        if (filters.price_max && filters.price_max !== '') {
                            params.append('price_max', filters.price_max);
                        }
                        if (filters.area_min && filters.area_min !== '') {
                            params.append('area_min', filters.area_min);
                        }
                        if (filters.area_max && filters.area_max !== '') {
                            params.append('area_max', filters.area_max);
                        }
                        if (filters.floor_min && filters.floor_min !== '') {
                            params.append('floor_min', filters.floor_min);
                        }
                        if (filters.floor_max && filters.floor_max !== '') {
                            params.append('floor_max', filters.floor_max);
                        }
                        if (filters.districts && filters.districts.length > 0) {
                            filters.districts.forEach(d => params.append('districts[]', d));
                        }
                        if (filters.developers && filters.developers.length > 0) {
                            filters.developers.forEach(d => params.append('developers[]', d));
                        }
                        if (filters.completion && filters.completion.length > 0) {
                            filters.completion.forEach(c => params.append('completion[]', c));
                        }
                        if (filters.object_classes && filters.object_classes.length > 0) {
                            filters.object_classes.forEach(c => params.append('object_classes[]', c));
                        }
                        if (filters.renovation && filters.renovation.length > 0) {
                            filters.renovation.forEach(r => params.append('renovation[]', r));
                        }
                        if (filters.building_released && filters.building_released.length > 0) {
                            filters.building_released.forEach(b => params.append('building_released[]', b));
                        }
                        if (filters.floor_options && filters.floor_options.length > 0) {
                            filters.floor_options.forEach(f => params.append('floor_options[]', f));
                        }
                        if (filters.property_type) {
                            params.append('property_type', filters.property_type);
                        }
                        
                        const url = `/properties?${params.toString()}`;
                        console.log('🔍 Opening search with filters:', url);
                        window.open(url, '_blank');
                    } catch (e) {
                        console.error('Error parsing filters:', e);
                        window.open(`/properties`, '_blank');
                    }
                } else {
                    window.open(`/properties`, '_blank');
                }
            }
        })
        .catch(error => {
            console.error('Error loading search filters:', error);
            window.open(`/properties`, '_blank');
        });
};

window.sendSearchToClient = function(searchId) {
    console.log('📧 Send search to client:', searchId);
    
    // Show client selection modal
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                        <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]">
                            <option value="">Загрузка клиентов...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                        <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]" placeholder="Добавьте персональное сообщение..."></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="closeSendSearchModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="flex-1 px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699]">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients for selection
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('client-select');
                select.innerHTML = '<option value="">Выберите клиента</option>' + 
                    data.clients.map(client => 
                        `<option value="${client.id}">${client.full_name} (${client.email})</option>`
                    ).join('');
            }
        });
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value;
    
    if (!clientId) {
        alert('Пожалуйста, выберите клиента');
        return;
    }
    
    fetch('/api/manager/send-search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            search_id: searchId,
            client_id: clientId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Поиск успешно отправлен клиенту!');
            closeSendSearchModal();
        } else {
            alert('Ошибка при отправке: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error sending search:', error);
        alert('Ошибка при отправке поиска');
    });
};

window.deleteSearch = function(searchId) {
    if (!confirm('Вы уверены, что хотите удалить этот сохранённый поиск?')) {
        return;
    }
    
    fetch(`/api/manager/saved-search/${searchId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Поиск успешно удалён!');
            // Reload saved searches
            loadManagerSavedSearches();
        } else {
            alert('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error deleting search:', error);
        alert('Ошибка при удалении поиска');
    });
};

console.log('✅ Saved searches functions defined');

// Navigation functionality - Global scope
window.showSection = function(sectionId) {
    console.log('🎯 showSection called with:', sectionId);
    
    localStorage.setItem('manager_dashboard_active_tab', sectionId);
    
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    const targetSection = document.getElementById(sectionId);
    
    if (targetSection) {
        targetSection.classList.add('active');
        console.log('✅ Section activated:', sectionId);
    } else {
        console.error('❌ Section not found:', sectionId);
    }
    
    document.querySelectorAll('.sidebar-link[data-page]').forEach(l => {
        const isActive = l.getAttribute('data-page') === sectionId;
        if (isActive) {
            l.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'text-[#0088CC]', 'dark:text-blue-400');
            l.classList.remove('text-gray-700', 'dark:text-gray-300');
        } else {
            l.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'text-[#0088CC]', 'dark:text-blue-400');
            l.classList.add('text-gray-700', 'dark:text-gray-300');
        }
    });
    
    // Load section-specific data
    if (sectionId === 'clients') {
        console.log('🎯 Clients section selected - calling loadClients');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('❌ window.loadClients is not a function');
        }
    } else if (sectionId === 'collections') {
        loadCollections();
    } else if (sectionId === 'saved-searches') {
        loadManagerSavedSearches();
    } else if (sectionId === 'deals') {
        console.log('🤝 Deals section selected - loading real data');
        if (typeof window.loadStaticDealsData === 'function') {
            window.loadStaticDealsData();
        }
    } else if (sectionId === 'presentations') {
        console.log('🎯 Presentations section selected - calling loadPresentations');
        if (typeof window.loadPresentations === 'function') {
            window.loadPresentations();
        } else if (typeof loadPresentations === 'function') {
            loadPresentations();
        } else {
            console.error('❌ loadPresentations function not found');
        }
    } else if (sectionId === 'recommendations') {
        console.log('🎯 Recommendations section selected - calling loadRecommendations');
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('❌ window.loadRecommendations is not a function');
        }
    } else if (sectionId === 'favorites') {
        console.log('🎯 Favorites section selected - loading both properties and complexes');
        if (typeof window.loadFavoriteProperties === 'function') {
            window.loadFavoriteProperties();
        }
        if (typeof window.loadFavoriteComplexes === 'function') {
            window.loadFavoriteComplexes();
        }
        updateFavoritesCounts();
    } else if (sectionId === 'comparison') {
        console.log('🎯 Comparison section selected - loading comparison data');
        if (typeof window.loadComparisonData === 'function') {
            window.loadComparisonData();
        }
    } else if (sectionId === 'overview' || sectionId === 'dashboard') {
        console.log('🎯 Dashboard overview selected - data already loaded by loadDashboardData');
    }
}

// Add click handlers to tab buttons  
document.querySelectorAll('.tab-button[data-page]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const page = e.currentTarget.dataset.page;
        if (page) {
            window.showSection(page);
        }
    });
});

// Alias for backward compatibility
window.switchToSection = window.showSection;

// User menu toggle (only if element exists)
const userMenuButton = document.getElementById('user-menu-button');
if (userMenuButton) {
    userMenuButton.addEventListener('click', function() {
        const menu = document.getElementById('user-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    });
}

// Property search functionality - Make functions global
let selectedProperties = [];
let currentView = 'grid'; // grid or list
let collections = [];
let complexes = {};

// Global functions
window.searchApartments = function() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const complex = document.getElementById('filter-complex').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    const areaMin = document.getElementById('filter-area-min').value;
    const areaMax = document.getElementById('filter-area-max').value;
    const floorMin = document.getElementById('filter-floor-min').value;
    const floorMax = document.getElementById('filter-floor-max').value;
    const status = document.getElementById('filter-status').value;
    const finishing = document.getElementById('filter-finishing').value;
    
    const searchParams = new URLSearchParams();
    if (district) searchParams.append('district', district);
    if (developer) searchParams.append('developer', developer);
    if (rooms) searchParams.append('rooms', rooms);
    if (complex) searchParams.append('complex', complex);
    if (priceMin) searchParams.append('price_min', priceMin);
    if (priceMax) searchParams.append('price_max', priceMax);
    if (areaMin) searchParams.append('area_min', areaMin);
    if (areaMax) searchParams.append('area_max', areaMax);
    if (floorMin) searchParams.append('floor_min', floorMin);
    if (floorMax) searchParams.append('floor_max', floorMax);
    if (status) searchParams.append('status', status);
    if (finishing) searchParams.append('finishing', finishing);
    
    // Show loading state
    document.getElementById('properties-results').innerHTML = 
        '<p class="text-gray-500 col-span-full text-center py-8">Поиск квартир...</p>';
    
    // Load the EXACT same data that properties.html uses
    console.log('Loading properties using same method as properties.html...');
    
    // First try to get the data from the same endpoint properties.html uses
    fetch('/properties')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract the allProperties array from the script tag
            const scriptTags = doc.querySelectorAll('script');
            let allProperties = [];
            
            for (let script of scriptTags) {
                if (script.textContent.includes('let allProperties = ')) {
                    const match = script.textContent.match(/let allProperties = (\[.*?\]);/s);
                    if (match) {
                        try {
                            allProperties = JSON.parse(match[1]);
                            console.log('Successfully extracted properties from properties.html:', allProperties.length);
                            break;
                        } catch (e) {
                            console.error('Failed to parse properties from properties.html:', e);
                        }
                    }
                }
            }
            
            if (allProperties.length === 0) {
                console.log('Could not extract from properties.html, trying JSON endpoint...');
                return fetch('/data/properties_expanded.json').then(r => r.json());
            }
            
            return allProperties;
        })
        .then(allProperties => {
            console.log('Final properties data:', allProperties.length);
            console.log('Sample property:', allProperties[0]);
            
            // Apply filtering exactly like properties.html
            let filteredProperties = allProperties.filter(property => {
                // District filter
                if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
                    return false;
                }
                
                // Developer filter
                if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
                    return false;
                }
                
                // Rooms filter - exactly like properties.html
                if (rooms) {
                    const propertyType = property.type || '';
                    const propertyRooms = property.rooms || 0;
                    
                    if (rooms === 'студия' && propertyType !== 'студия') return false;
                    if (rooms === '1' && propertyRooms !== 1) return false;
                    if (rooms === '2' && propertyRooms !== 2) return false;
                    if (rooms === '3' && propertyRooms !== 3) return false;
                    if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
                }
                
                // Complex filter (ЖК filter)
                if (complex && complex !== 'Все ЖК' && property.complex_name && !property.complex_name.toLowerCase().includes(complex.toLowerCase())) {
                    return false;
                }
                
                // Price filter (in millions like properties.html)
                if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
                if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
                
                // Area filter
                if (areaMin && property.area < parseFloat(areaMin)) return false;
                if (areaMax && property.area > parseFloat(areaMax)) return false;
                
                // Floor filter
                if (floorMin && property.floor < parseInt(floorMin)) return false;
                if (floorMax && property.floor > parseInt(floorMax)) return false;
                
                return true;
            });
            
            console.log('Filtered properties:', filteredProperties.length);
            
            // Show filtered results - limit to 20 for performance
            const displayProps = filteredProperties.slice(0, 20);
            displayApartments(displayProps);
            document.getElementById('results-count').textContent = `${filteredProperties.length} квартир (показано ${displayProps.length})`;
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            document.getElementById('properties-results').innerHTML = 
                '<p class="text-red-500 col-span-full text-center py-8">Ошибка загрузки данных</p>';
            document.getElementById('results-count').textContent = '0 квартир';
        });
}

function filterProperties(properties, filters) {
    const { 
        district, developer, rooms, complex, priceMin, priceMax, areaMin, areaMax, 
        floorMin, floorMax, status, finishing, buildingClass, material, ceilingMin, ceilingMax,
        hasBalcony, hasParking, hasView, isPenthouse, familyMortgage, itMortgage, militaryMortgage, ruralMortgage
    } = filters;
    
    return properties.filter(property => {
        // District filter
        if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
            return false;
        }
        
        // Rooms filter - fix to match property data structure
        if (rooms) {
            const propertyType = property.type || '';
            const propertyRooms = property.rooms || 0;
            
            if (rooms === 'студия' && propertyType !== 'студия') return false;
            if (rooms === '1' && propertyRooms !== 1) return false;
            if (rooms === '2' && propertyRooms !== 2) return false;
            if (rooms === '3' && propertyRooms !== 3) return false;
            if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
        }
        
        // Complex filter
        if (complex && property.complex_id && property.complex_id != complex) {
            return false;
        }
        
        // Price filter (in millions)
        if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
        if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
        
        // Area filter
        if (areaMin && property.area < parseFloat(areaMin)) return false;
        if (areaMax && property.area > parseFloat(areaMax)) return false;
        
        // Floor filter
        if (floorMin && property.floor < parseInt(floorMin)) return false;
        if (floorMax && property.floor > parseInt(floorMax)) return false;
        
        // Status filter
        if (status) {
            const completionDate = property.completion_date || '';
            if (status === 'сдан' && !completionDate.toLowerCase().includes('сдан')) return false;
            if (status === 'строительство' && completionDate.toLowerCase().includes('сдан')) return false;
        }
        
        // Finishing filter  
        if (finishing) {
            const finishType = property.finish_type || '';
            if (finishing === 'черновая' && !finishType.toLowerCase().includes('черновая')) return false;
            if (finishing === 'чистовая' && !finishType.toLowerCase().includes('чистовая')) return false;
            if (finishing === 'под ключ' && !finishType.toLowerCase().includes('премиум')) return false;
        }
        
        // Building class filter
        if (buildingClass && property.building_class && !property.building_class.toLowerCase().includes(buildingClass.toLowerCase())) {
            return false;
        }
        
        // Material filter
        if (material && property.wall_material && !property.wall_material.toLowerCase().includes(material.toLowerCase())) {
            return false;
        }
        
        // Ceiling height filter
        if (ceilingMin && property.ceiling_height && property.ceiling_height < parseFloat(ceilingMin)) return false;
        if (ceilingMax && property.ceiling_height && property.ceiling_height > parseFloat(ceilingMax)) return false;
        
        // Amenities filters
        if (hasBalcony && !property.has_balcony) return false;
        if (hasParking && !property.has_parking) return false;
        if (hasView && !property.has_view) return false;
        if (isPenthouse && !property.is_penthouse) return false;
        
        // Mortgage filters
        if (familyMortgage && !property.family_mortgage) return false;
        if (itMortgage && !property.it_mortgage) return false;
        if (militaryMortgage && !property.military_mortgage) return false;
        if (ruralMortgage && !property.rural_mortgage) return false;
        
        return true;
    });
}

function displayApartments(apartments) {
    const container = document.getElementById('properties-results');
    
    if (apartments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Квартиры не найдены</p>';
        return;
    }
    
    if (currentView === 'grid') {
        // Grid view
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
        container.innerHTML = apartments.map(apartment => {
            const images = apartment.gallery || [apartment.image] || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=300&q=80';
            const cashback = Math.round(apartment.price * 0.05); // 5% cashback
            
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="relative">
                        <img src="${mainImage}" alt="${apartment.title || apartment.complex_name}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                            Кешбэк ₽${(cashback / 1000000).toFixed(1)}М
                        </div>
                        <div class="absolute bottom-2 left-2 bg-white px-2 py-1 rounded text-xs font-medium">
                            ${apartment.rooms === 0 ? 'Студия' : apartment.rooms + '-комн.'}
                        </div>
                    </div>
                    <div class="p-4">
                        <h5 class="font-medium text-gray-900 mb-1">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                        <p class="text-sm text-gray-600 mb-2">${apartment.district} • ${apartment.developer}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">${apartment.area} м²</span>
                            <span class="text-xs text-gray-500">${apartment.floor}/${apartment.total_floors || apartment.max_floor || 'Н/Д'} этаж</span>
                        </div>
                        <p class="text-lg font-bold text-[#0088cc] mb-2">₽${apartment.price?.toLocaleString() || 'Цена по запросу'}</p>
                        <p class="text-sm text-green-600 mb-3">Кешбек: ₽${cashback.toLocaleString()}</p>
                        <div class="flex gap-2">
                            <button onclick="viewProperty(${apartment.id})" class="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                Подробнее
                            </button>
                            <button onclick="selectProperty(${apartment.id})" class="flex-1 px-3 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        // List view
        container.className = 'space-y-4';
        container.innerHTML = apartments.map(apartment => {
            const complex = complexes[apartment.complex_id] || {};
            const images = apartment.images || complex.images || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=150&q=80';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="flex gap-4">
                        <img src="${mainImage}" alt="${apartment.complex_name}" class="w-32 h-24 object-cover rounded flex-shrink-0">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-medium text-gray-900">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                                    <p class="text-sm text-gray-600">${apartment.district} • ${apartment.developer}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-[#0088cc]">${apartment.price.toLocaleString()} ₽</p>
                                    <p class="text-sm text-green-600">Кешбек: ${apartment.cashback.toLocaleString()} ₽</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-4 text-sm text-gray-500">
                                    <span>${apartment.type === 'студия' ? 'Студия' : apartment.rooms + '-комн.'}</span>
                                    <span>${apartment.area} м²</span>
                                    <span>${apartment.floor}/${apartment.max_floor} этаж</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewProperty(${apartment.id})" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                        Подробнее
                                    </button>
                                    <button onclick="selectProperty(${apartment.id})" class="px-4 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                        ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Make all functions global
window.selectProperty = function(propertyId) {
    // Toggle selection
    if (selectedProperties.includes(propertyId)) {
        // Remove from selection
        const index = selectedProperties.indexOf(propertyId);
        selectedProperties.splice(index, 1);
    } else {
        // Add to selection
        selectedProperties.push(propertyId);
    }
    
    updateSelectedProperties();
    updateButtons();
    
    // Update visual state in search results
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer) {
        searchApartments(); // Refresh to update visual state
    }
}

window.updateSelectedProperties = function() {
    const container = document.getElementById('selected-properties');
    const countElement = document.getElementById('selected-count');
    
    countElement.textContent = `${selectedProperties.length} объектов`;
    
    if (selectedProperties.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Объекты не выбраны</p>';
        return;
    }
    
    // Fetch selected properties details
    Promise.all(selectedProperties.map(id => 
        fetch(`/api/properties/${id}`).then(r => r.json())
    )).then(responses => {
        const totalCashback = responses.reduce((sum, response) => {
            return sum + (response.success ? response.property.cashback : 0);
        }, 0);
        
        container.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-blue-900">Общий кешбек по подборке:</span>
                    <span class="text-xl font-bold text-blue-900">${totalCashback.toLocaleString()} ₽</span>
                </div>
            </div>
        ` + responses.map((response, index) => {
            if (!response.success) return '';
            const property = response.property;
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <h6 class="font-medium">${property.complex_name}</h6>
                        <p class="text-sm text-gray-600">${property.district} • ${property.developer}</p>
                        <p class="text-sm text-gray-600">${property.rooms}-комн. • ${property.area} м² • ${property.price.toLocaleString()} ₽</p>
                        <p class="text-sm text-green-600">Кешбек: ${property.cashback.toLocaleString()} ₽</p>
                    </div>
                    <button onclick="removeProperty(${index})" class="ml-3 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    });
}

window.updateButtons = function() {
    const hasSelection = selectedProperties.length > 0;
    document.getElementById('save-collection-btn').disabled = !hasSelection;
    document.getElementById('send-collection-btn').disabled = !hasSelection;
    document.getElementById('clear-selection-btn').disabled = !hasSelection;
}

window.removeProperty = function(index) {
    selectedProperties.splice(index, 1);
    updateSelectedProperties();
    updateButtons();
    
    // Refresh search results to update visual state
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
        searchApartments();
    }
}

// Save search with client-compatible format
window.saveCurrentSearch = function() {
    openSaveSearchModal();
};

// Create save search modal
function openSaveSearchModal() {
    const modalHTML = `
        <div id="save-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Сохранить поиск</h3>
                <form id="save-search-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Название поиска</label>
                        <input type="text" id="manager-search-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="Например: 2-комн в центре до 10млн">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email клиента</label>
                        <input type="email" id="manager-client-email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="client@example.com">
                        <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту и сохранён в его аккаунте</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                        <textarea id="manager-search-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                                  placeholder="Дополнительные заметки о поиске"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSaveSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            Отмена
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Auto-generate search name
    generateManagerSearchName();
    
    // Bind events
    document.getElementById('save-search-form').addEventListener('submit', handleSaveSearch);
}

function generateManagerSearchName() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    
    let name = 'Поиск ';
    if (rooms) name += rooms + ' ';
    if (district) name += 'в ' + district + ' ';
    if (developer) name += 'от ' + developer + ' ';
    if (priceMin || priceMax) {
        name += `${priceMin || '0'}-${priceMax || '∞'} млн`;
    }
    
    document.getElementById('manager-search-name').value = name.trim() || 'Мой поиск';
}

function closeSaveSearchModal() {
    const modal = document.getElementById('save-search-modal');
    if (modal) modal.remove();
}

async function handleSaveSearch(e) {
    e.preventDefault();
    
    const searchName = document.getElementById('manager-search-name').value.trim();
    const clientEmail = document.getElementById('manager-client-email').value.trim();
    const description = document.getElementById('manager-search-description').value.trim();
    
    if (!searchName) {
        alert('Введите название поиска');
        return;
    }
    
    // Convert manager filters to client-compatible format
    const clientFilters = convertManagerFiltersToClient();
    
    const searchData = {
        name: searchName,
        description: description,
        client_email: clientEmail,
        notify_new_matches: true,
        search_type: 'properties',
        ...clientFilters
    };
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(searchData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeSaveSearchModal();
            if (clientEmail) {
                alert(`Поиск успешно сохранён и отправлен клиенту на ${clientEmail}!`);
            } else {
                alert('Поиск успешно сохранён!');
            }
        } else {
            alert('Ошибка при сохранении поиска: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска');
    }
}

// Convert manager filters to client-compatible format
function convertManagerFiltersToClient() {
    return {
        // Basic filters
        location: document.getElementById('filter-district').value || '',
        developer: document.getElementById('filter-developer').value || '',
        property_type: document.getElementById('filter-rooms').value || '',
        complex_name: document.getElementById('filter-complex').value || '',
        
        // Price (convert to client format)
        price_min: document.getElementById('filter-price-min').value ? 
                   parseFloat(document.getElementById('filter-price-min').value) * 1000000 : null,
        price_max: document.getElementById('filter-price-max').value ? 
                   parseFloat(document.getElementById('filter-price-max').value) * 1000000 : null,
        
        // Size
        size_min: document.getElementById('filter-area-min').value ? 
                  parseFloat(document.getElementById('filter-area-min').value) : null,
        size_max: document.getElementById('filter-area-max').value ? 
                  parseFloat(document.getElementById('filter-area-max').value) : null,
        
        // Floor
        floor_min: document.getElementById('filter-floor-min').value ? 
                   parseInt(document.getElementById('filter-floor-min').value) : null,
        floor_max: document.getElementById('filter-floor-max').value ? 
                   parseInt(document.getElementById('filter-floor-max').value) : null,
        
        // Additional filters as JSON
        additional_filters: JSON.stringify({
            status: document.getElementById('filter-status').value || '',
            finishing: document.getElementById('filter-finishing').value || '',
            buildingClass: document.getElementById('filter-class') ? document.getElementById('filter-class').value : '',
            material: document.getElementById('filter-material') ? document.getElementById('filter-material').value : '',
            ceilingMin: document.getElementById('filter-ceiling-min') ? document.getElementById('filter-ceiling-min').value : '',
            ceilingMax: document.getElementById('filter-ceiling-max') ? document.getElementById('filter-ceiling-max').value : '',
            hasBalcony: document.getElementById('filter-balcony') ? document.getElementById('filter-balcony').checked : false,
            hasParking: document.getElementById('filter-parking') ? document.getElementById('filter-parking').checked : false,
            hasView: document.getElementById('filter-view') ? document.getElementById('filter-view').checked : false,
            isPenthouse: document.getElementById('filter-penthouse') ? document.getElementById('filter-penthouse').checked : false,
            familyMortgage: document.getElementById('filter-family-mortgage') ? document.getElementById('filter-family-mortgage').checked : false,
            itMortgage: document.getElementById('filter-it-mortgage') ? document.getElementById('filter-it-mortgage').checked : false,
            militaryMortgage: document.getElementById('filter-military-mortgage') ? document.getElementById('filter-military-mortgage').checked : false,
            ruralMortgage: document.getElementById('filter-rural-mortgage') ? document.getElementById('filter-rural-mortgage').checked : false
        })
    };
};

// Show saved searches from server
window.showSavedSearches = function() {
    loadSavedSearchesPage();
};

async function loadSavedSearchesPage() {
    try {
        const response = await fetch('/api/searches', {
            method: 'GET',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            displaySavedSearchesModal(result.searches);
        } else {
            alert('Ошибка загрузки сохранённых поисков');
        }
    } catch (error) {
        console.error('Error loading saved searches:', error);
        alert('Ошибка загрузки сохранённых поисков');
    }
}

function displaySavedSearchesModal(searches) {
    if (searches.length === 0) {
        alert('У вас нет сохранённых поисков');
        return;
    }
    
    const searchesHTML = searches.map(search => `
        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${search.name}</h4>
                    <div class="text-sm text-gray-600 mt-1">
                        Создан: ${search.created_at}
                    </div>
                    ${getSearchSummary(search)}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="loadSavedSearch(${search.id})" class="px-3 py-1 bg-[#0088cc] text-white text-sm rounded hover:bg-[#0077bb]">
                        Применить
                    </button>
                    <button onclick="deleteSavedSearch(${search.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        Удалить
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    const modalHTML = `
        <div id="saved-searches-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Сохранённые поиски</h3>
                    <button onclick="closeSavedSearchesModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="searches-list">
                    ${searchesHTML}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeSavedSearchesModal() {
    const modal = document.getElementById('saved-searches-modal');
    if (modal) modal.remove();
}

function getSearchSummary(search) {
    const parts = [];
    
    if (search.property_type) parts.push(search.property_type);
    if (search.location) parts.push('в ' + search.location);
    if (search.price_min || search.price_max) {
        let priceRange = '';
        if (search.price_min) priceRange += `от ${formatPrice(search.price_min)}`;
        if (search.price_max) priceRange += ` до ${formatPrice(search.price_max)}`;
        parts.push(priceRange);
    }
    if (search.developer) parts.push('от ' + search.developer);
    if (search.complex_name) parts.push('ЖК ' + search.complex_name);

    if (parts.length === 0) return '';
    return `<div class="mt-2 text-sm text-gray-600">${parts.join(', ')}</div>`;
}

function formatPrice(price) {
    if (price >= 1000000) {
        return (price / 1000000).toFixed(1) + 'млн';
    }
    return price.toLocaleString() + 'р';
}

async function loadSavedSearch(searchId) {
    try {
        const response = await fetch(`/api/searches/${searchId}/apply`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            applySavedSearch(result.search);
            closeSavedSearchesModal();
            alert('Поиск применён');
        } else {
            alert('Ошибка при применении поиска');
        }
    } catch (error) {
        console.error('Error applying search:', error);
        alert('Ошибка при применении поиска');
    }
}

function applySavedSearch(search) {
    // Clear current filters
    document.getElementById('filter-district').value = '';
    document.getElementById('filter-developer').value = '';
    document.getElementById('filter-rooms').value = '';
    document.getElementById('filter-complex').value = '';
    document.getElementById('filter-price-min').value = '';
    document.getElementById('filter-price-max').value = '';
    document.getElementById('filter-area-min').value = '';
    document.getElementById('filter-area-max').value = '';
    
    // Apply basic filters
    if (search.location) document.getElementById('filter-district').value = search.location;
    if (search.developer) document.getElementById('filter-developer').value = search.developer;
    if (search.property_type) document.getElementById('filter-rooms').value = search.property_type;
    if (search.complex_name) document.getElementById('filter-complex').value = search.complex_name;
    
    // Apply price filters (convert from rubles to millions)
    if (search.price_min) document.getElementById('filter-price-min').value = (search.price_min / 1000000).toString();
    if (search.price_max) document.getElementById('filter-price-max').value = (search.price_max / 1000000).toString();
    
    // Apply size filters
    if (search.size_min) document.getElementById('filter-area-min').value = search.size_min.toString();
    if (search.size_max) document.getElementById('filter-area-max').value = search.size_max.toString();
    
    // Apply additional filters if available
    if (search.additional_filters) {
        try {
            const additionalFilters = JSON.parse(search.additional_filters);
            
            if (additionalFilters.status && document.getElementById('filter-status')) {
                document.getElementById('filter-status').value = additionalFilters.status;
            }
            if (additionalFilters.finishing && document.getElementById('filter-finishing')) {
                document.getElementById('filter-finishing').value = additionalFilters.finishing;
            }
            
            // Apply advanced filters
            if (document.getElementById('filter-class') && additionalFilters.buildingClass) {
                document.getElementById('filter-class').value = additionalFilters.buildingClass;
            }
            if (document.getElementById('filter-material') && additionalFilters.material) {
                document.getElementById('filter-material').value = additionalFilters.material;
            }
            
            // Apply checkboxes
            if (document.getElementById('filter-balcony')) document.getElementById('filter-balcony').checked = additionalFilters.hasBalcony || false;
            if (document.getElementById('filter-parking')) document.getElementById('filter-parking').checked = additionalFilters.hasParking || false;
            if (document.getElementById('filter-view')) document.getElementById('filter-view').checked = additionalFilters.hasView || false;
            if (document.getElementById('filter-penthouse')) document.getElementById('filter-penthouse').checked = additionalFilters.isPenthouse || false;
            
        } catch (e) {
            console.log('Could not parse additional filters:', e);
        }
    }
    
    // Execute search
    searchApartments();
}

async function deleteSavedSearch(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/searches/${searchId}`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the searches modal
            closeSavedSearchesModal();
            loadSavedSearchesPage();
        } else {
            alert('Ошибка при удалении поиска');
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка при удалении поиска');
    }
};

// View property details
window.viewProperty = function(propertyId) {
    // Open property in new tab or modal
    window.open(`/property/${propertyId}`, '_blank');
};

// Load clients - Global scope - MAIN FUNCTION
window.loadClients = function() {
    console.log('🔄 Loading clients...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Загрузка клиентов...</div>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Clients data received:', data);
            if (data.success) {
                console.log('✅ Success! Displaying', data.clients.length, 'clients');
                displayClients(data.clients);
                updateClientSelect(data.clients);
                const countElement = document.getElementById('clients-count');
                if (countElement) {
                    countElement.textContent = data.clients.length;
                }
            } else {
                console.error('❌ API returned error:', data.error);
                tableBody.innerHTML = 
                    `<div class="col-span-full text-center py-8 text-red-500">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading clients:', error);
            tableBody.innerHTML = 
                '<div class="col-span-full text-center py-8 text-red-500">Ошибка загрузки клиентов</div>';
        });
}

// Ensure displayClients is available
window.displayClients = function(clients) {
    console.log('📝 Displaying clients:', clients);
    const container = document.getElementById('clients-table-body');
    if (!container) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    if (!clients || clients.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900 mb-1">Клиенты не найдены</h4>
                    <p class="text-sm text-gray-500">Добавьте первого клиента</p>
                </td>
            </tr>`;
        var mobileCards = document.getElementById('clients-mobile-cards');
        if (mobileCards) {
            mobileCards.innerHTML = '<div class="text-center py-8 text-gray-500"><p class="text-sm font-medium mb-1">Клиенты не найдены</p><p class="text-xs">Добавьте первого клиента</p></div>';
        }
        return;
    }
    
    window._allClientsData = clients;
    
    const formatDate = (dateString) => {
        if (!dateString) return '—';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (e) {
            return '—';
        }
    };
    
    container.innerHTML = clients.map(client => {
        const initials = (client.full_name || 'К').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const colors = ['from-[#0088CC] to-[#006699]', 'from-green-500 to-emerald-600', 'from-blue-500 to-blue-600', 'from-teal-500 to-cyan-600', 'from-indigo-500 to-blue-600'];
        const colorIndex = (client.id || 0) % colors.length;
        const preferences = client.search_preferences || '—';
        const createdDate = formatDate(client.created_at);
        
        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-3">
                        ${client.profile_image
                            ? `<img src="${client.profile_image}" alt="${client.full_name || ''}" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
                            : ''}
                        <div class="w-10 h-10 bg-gradient-to-r ${colors[colorIndex]} rounded-full items-center justify-center text-white font-bold text-xs flex-shrink-0" style="display:${client.profile_image ? 'none' : 'flex'}">
                            ${initials}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${client.full_name || 'Не указано'}</p>
                            <p class="text-xs text-gray-500">Активен</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${client.phone || '—'}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 hidden md:table-cell truncate">${client.email || '—'}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 hidden lg:table-cell truncate" title="${preferences}">${preferences.length > 30 ? preferences.substring(0, 27) + '...' : preferences}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 hidden md:table-cell">${createdDate}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right">
                    <div class="flex items-center justify-end gap-1">
                        <button onclick="openSendCredentialsModal(${client.id}, '${(client.full_name || '').replace(/'/g, "\\'")}', '${client.email || ''}', '${client.phone || ''}')" class="p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors" title="Отправить доступ">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        </button>
                        <button onclick="editClient(${client.id})" class="p-2 text-[#0088CC] hover:bg-blue-50 rounded-lg transition-colors" title="Изменить">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </button>
                        <button onclick="deleteClient(${client.id}, this.dataset.name)" data-name="${(client.full_name || '').replace(/"/g, '&quot;')}" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Удалить">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </td>
            </tr>`;
    }).join('');

    var mobileCards = document.getElementById('clients-mobile-cards');
    if (mobileCards) {
        mobileCards.innerHTML = clients.map(function(client) {
            var initials = (client.full_name || 'К').split(' ').map(function(n){return n[0];}).join('').substring(0, 2).toUpperCase();
            var colors = ['from-[#0088CC] to-[#006699]', 'from-green-500 to-emerald-600', 'from-blue-500 to-blue-600'];
            var colorIndex = (client.id || 0) % colors.length;
            var avatarHtml = '';
            if (client.profile_image) {
                avatarHtml = '<img src="' + client.profile_image + '" alt="' + (client.full_name || '') + '" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'">';
            }
            return '<div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">' +
                '<div class="flex items-center gap-3">' +
                avatarHtml +
                '<div class="w-10 h-10 bg-gradient-to-r ' + colors[colorIndex] + ' rounded-full items-center justify-center text-white font-bold text-xs flex-shrink-0" style="display:' + (client.profile_image ? 'none' : 'flex') + '">' + initials + '</div>' +
                '<div class="flex-1 min-w-0">' +
                '<p class="text-sm font-semibold text-gray-900 truncate">' + (client.full_name || 'Не указано') + '</p>' +
                '<p class="text-xs text-gray-500 truncate">' + (client.phone || client.email || '—') + '</p>' +
                '</div>' +
                '<div class="flex items-center gap-1 flex-shrink-0">' +
                '<button onclick="openSendCredentialsModal(' + client.id + ', \'' + (client.full_name || '').replace(/'/g, "\\'") + '\', \'' + (client.email || '') + '\', \'' + (client.phone || '') + '\')" class="p-1.5 text-emerald-600 hover:bg-emerald-50 rounded-lg" title="Отправить доступ"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>' +
                '<button onclick="editClient(' + client.id + ')" class="p-1.5 text-[#0088CC] hover:bg-blue-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>' +
                '<button onclick="deleteClient(' + client.id + ')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>' +
                '</div></div></div>';
        }).join('');
    }
}

window.filterClients = function(query) {
    if (!window._allClientsData) return;
    const q = query.toLowerCase().trim();
    if (!q) {
        const original = window._allClientsData;
        window.displayClients(original);
        window._allClientsData = original;
        return;
    }
    const original = window._allClientsData;
    const filtered = original.filter(c => 
        (c.full_name || '').toLowerCase().includes(q) ||
        (c.email || '').toLowerCase().includes(q) ||
        (c.phone || '').includes(q)
    );
    window.displayClients(filtered);
    window._allClientsData = original;
}

// Removed duplicate - using window.displayClients above

function updateClientSelect(clients) {
    const select = document.getElementById('collection-client');
    select.innerHTML = '<option value="">Выберите клиента</option>' + 
        clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
}

// Load recommendations - Global scope
window.loadRecommendations = function() {
    console.log('Loading recommendations...');
    fetch('/api/manager/recommendations')
        .then(response => response.json())
        .then(data => {
            console.log('Recommendations data received:', data);
            if (data.success) {
                displayRecommendations(data.recommendations);
                updateRecommendationsStats(data.stats || {});
            } else {
                console.error('Failed to load recommendations:', data.error);
                document.getElementById('recommendations-container').innerHTML = 
                    '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
        });
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-medium text-gray-900">${rec.property_title || 'Объект недвижимости'}</h4>
                    <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                </div>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(rec.status)}">
                    ${getStatusText(rec.status)}
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
            <div class="text-xs text-gray-500">
                Отправлено: ${new Date(rec.created_at).toLocaleDateString('ru-RU')}
            </div>
        </div>
    `).join('');
}

function updateRecommendationsStats(stats) {
    document.getElementById('recommendations-sent').textContent = stats.sent || 0;
    document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
    document.getElementById('recommendations-interested').textContent = stats.interested || 0;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-blue-100 text-blue-800',
        'viewed': 'bg-green-100 text-green-800',
        'interested': 'bg-sky-100 text-sky-800',
        'not_interested': 'bg-gray-100 text-gray-800',
        'scheduled_viewing': 'bg-orange-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

// Load complexes for filter
function loadComplexes() {
    fetch('/api/complexes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('filter-complex');
                select.innerHTML = '<option value="">Все ЖК</option>' + 
                    data.complexes.map(complex => `<option value="${complex.id}">${complex.name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading complexes:', error));
}

// Send credentials modal
window.openSendCredentialsModal = function(clientId, clientName, clientEmail, clientPhone) {
    const existing = document.getElementById('sendCredentialsModal');
    if (existing) existing.remove();

    const hasEmail = clientEmail && clientEmail.trim();
    const hasPhone = clientPhone && clientPhone.trim();

    const modal = document.createElement('div');
    modal.id = 'sendCredentialsModal';
    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
    modal.innerHTML = `
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSendCredentialsModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-white font-semibold text-lg">Отправить данные для входа</h3>
                    <button onclick="closeSendCredentialsModal()" class="text-white/70 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="text-gray-600 text-sm mb-4">
                    Клиенту <strong class="text-gray-900">${clientName}</strong> будет сгенерирован новый временный пароль и отправлены данные для входа в личный кабинет.
                </p>

                <div class="space-y-3 mb-6">
                    <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${hasEmail ? 'border-gray-200 hover:border-[#0088CC]' : 'border-gray-100 opacity-50 cursor-not-allowed'}" id="credMethodEmail">
                        <input type="radio" name="credMethod" value="email" ${hasEmail ? 'checked' : 'disabled'} class="sr-only" onchange="updateCredMethodUI()">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-5 h-5 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 text-sm">Email</div>
                            <div class="text-xs text-gray-500 truncate">${hasEmail ? clientEmail : 'Не указан'}</div>
                        </div>
                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 cred-radio ${hasEmail ? 'border-[#0088CC]' : 'border-gray-300'}">
                            ${hasEmail ? '<div class="w-2.5 h-2.5 rounded-full bg-[#0088CC]"></div>' : ''}
                        </div>
                    </label>

                    <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${hasPhone ? 'border-gray-200 hover:border-[#0088CC]' : 'border-gray-100 opacity-50 cursor-not-allowed'}" id="credMethodSms">
                        <input type="radio" name="credMethod" value="sms" ${hasPhone && !hasEmail ? 'checked' : ''} ${hasPhone ? '' : 'disabled'} class="sr-only" onchange="updateCredMethodUI()">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 text-sm">SMS</div>
                            <div class="text-xs text-gray-500 truncate">${hasPhone ? clientPhone : 'Не указан'}</div>
                        </div>
                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 cred-radio ${hasPhone && !hasEmail ? 'border-[#0088CC]' : 'border-gray-300'}">
                            ${hasPhone && !hasEmail ? '<div class="w-2.5 h-2.5 rounded-full bg-[#0088CC]"></div>' : ''}
                        </div>
                    </label>
                </div>

                <div id="credSendResult" class="hidden mb-4"></div>

                <div class="flex items-center space-x-3">
                    <button onclick="closeSendCredentialsModal()" class="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">
                        Отмена
                    </button>
                    <button onclick="sendClientCredentials(${clientId})" id="btnSendCreds" class="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-xl hover:from-[#006699] hover:to-[#004466] transition-all flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const emailLabel = document.getElementById('credMethodEmail');
    const smsLabel = document.getElementById('credMethodSms');
    if (emailLabel) emailLabel.onclick = function(e) {
        if (emailLabel.querySelector('input').disabled) return;
        emailLabel.querySelector('input').checked = true;
        updateCredMethodUI();
    };
    if (smsLabel) smsLabel.onclick = function(e) {
        if (smsLabel.querySelector('input').disabled) return;
        smsLabel.querySelector('input').checked = true;
        updateCredMethodUI();
    };
};

window.updateCredMethodUI = function() {
    const radios = document.querySelectorAll('input[name="credMethod"]');
    radios.forEach(r => {
        const label = r.closest('label');
        const dot = label.querySelector('.cred-radio');
        if (r.checked) {
            label.classList.remove('border-gray-200');
            label.classList.add('border-[#0088CC]');
            dot.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-[#0088CC]"></div>';
            dot.classList.remove('border-gray-300');
            dot.classList.add('border-[#0088CC]');
        } else {
            label.classList.remove('border-[#0088CC]');
            label.classList.add('border-gray-200');
            dot.innerHTML = '';
            dot.classList.remove('border-[#0088CC]');
            dot.classList.add('border-gray-300');
        }
    });
};

window.closeSendCredentialsModal = function() {
    const modal = document.getElementById('sendCredentialsModal');
    if (modal) modal.remove();
};

window.sendClientCredentials = async function(clientId) {
    const selected = document.querySelector('input[name="credMethod"]:checked');
    if (!selected) {
        const result = document.getElementById('credSendResult');
        result.className = 'mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800 text-sm';
        result.textContent = 'Выберите способ отправки';
        return;
    }

    const btn = document.getElementById('btnSendCreds');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Отправка...';

    const result = document.getElementById('credSendResult');

    try {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        if (csrfMeta) headers['X-CSRFToken'] = csrfMeta.content;

        const resp = await fetch(`/api/manager/client/${clientId}/send-credentials`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ method: selected.value })
        });
        const data = await resp.json();

        if (data.success) {
            result.className = 'mb-4 p-3 rounded-lg bg-green-50 border border-green-200 text-green-800 text-sm';
            result.innerHTML = '<strong>&#10003;</strong> ' + data.message;
            btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Отправлено';
            btn.classList.remove('from-[#0088CC]', 'to-[#006699]');
            btn.classList.add('from-emerald-500', 'to-emerald-600');
            setTimeout(() => closeSendCredentialsModal(), 3000);
        } else {
            result.className = 'mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm';
            result.innerHTML = data.error || 'Ошибка отправки';
            btn.disabled = false;
            btn.innerHTML = origHtml;
        }
    } catch (err) {
        console.error('Send credentials error:', err);
        result.className = 'mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm';
        result.textContent = 'Ошибка сети при отправке';
        btn.disabled = false;
        btn.innerHTML = origHtml;
    }
};

// Edit client function
window.editClient = function(clientId) {
    // Find client data using correct endpoint
    fetch(`/manager/get-client/${clientId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            console.log('Client data received:', data);
            if (data.success) {
                const client = data;
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.id = 'edit-client-modal-overlay';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Редактировать клиента</h3>
                            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <form id="edit-client-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя</label>
                                    <input type="text" id="edit-client-full-name" value="${client.full_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="edit-client-email" value="${client.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                    <input type="tel" id="edit-client-phone" value="${client.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                    <select id="edit-client-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="1" ${client.is_active ? 'selected' : ''}>Активен</option>
                                        <option value="0" ${!client.is_active ? 'selected' : ''}>Неактивен</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Сохранить</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('edit-client-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveClientChanges(clientId);
                });
            } else {
                alert('Ошибка загрузки данных клиента');
            }
        })
        .catch(error => {
            console.error('Error loading client:', error);
            alert('Ошибка загрузки данных клиента');
        });
};

// Delete client function
window.deleteClient = function(clientId, clientName) {
    if (confirm(`Вы уверены, что хотите удалить клиента "${clientName}"?`)) {
        fetch(`/manager/delete-client`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `client_id=${clientId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Клиент успешно удален');
                loadClients(); // Reload the clients list
            } else {
                alert(data.message || 'Ошибка при удалении клиента');
            }
        })
        .catch(error => {
            console.error('Error deleting client:', error);
            alert('Ошибка при удалении клиента');
        });
    }
};

// Close edit modal
window.closeEditModal = function() {
    const modal = document.getElementById('edit-client-modal-overlay');
    if (modal) {
        modal.remove();
    }
};

// Save client changes
function saveClientChanges(clientId) {
    const formData = new FormData();
    formData.append('client_id', clientId);
    formData.append('full_name', document.getElementById('edit-client-full-name').value);
    formData.append('email', document.getElementById('edit-client-email').value);
    formData.append('phone', document.getElementById('edit-client-phone').value);
    if (document.getElementById('edit-client-status').value === '1') {
        formData.append('is_active', 'on');
    }
    
    fetch(`/manager/edit-client`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Данные клиента обновлены');
            closeEditModal();
            loadClients(); // Reload the clients list
        } else {
            alert(data.message || 'Ошибка при сохранении');
        }
    })
    .catch(error => {
        console.error('Error saving client:', error);
        alert('Ошибка при сохранении');
    });
}

// Show add client modal
function showAddClientModal() {
    console.log('showAddClientModal called');
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Добавить нового клиента</h3>
            <form id="add-client-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя *</label>
                        <input type="text" id="add-client-full-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required minlength="2" maxlength="100">
                        <div class="text-xs text-gray-500 mt-1">Введите имя и фамилию</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="add-client-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                        <div class="text-xs text-gray-500 mt-1">Формат: example@domain.com</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        <input type="tel" id="add-client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="+7-918-123-45-67">
                        <div class="text-xs text-gray-500 mt-1">Формат: +7-918-123-45-67</div>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="add-client-active" checked class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Активный клиент</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddClientModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Добавить</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add phone number formatting with better UX
    const phoneInput = document.getElementById('add-client-phone');
    phoneInput.addEventListener('input', function(e) {
        let cursorPosition = e.target.selectionStart;
        let value = e.target.value.replace(/\D/g, '');
        
        // Handle different input patterns
        if (value.startsWith('7')) {
            value = value.substring(1);
        } else if (value.startsWith('8')) {
            value = value.substring(1);
        }
        
        let formattedValue = '';
        if (value.length > 0) {
            formattedValue = '+7';
            if (value.length >= 1) {
                formattedValue += '-' + value.substring(0, Math.min(3, value.length));
            }
            if (value.length >= 4) {
                formattedValue += '-' + value.substring(3, Math.min(6, value.length));
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, Math.min(8, value.length));
            }
            if (value.length >= 9) {
                formattedValue += '-' + value.substring(8, Math.min(10, value.length));
            }
        }
        
        e.target.value = formattedValue;
        
        // Restore cursor position approximately
        if (cursorPosition <= formattedValue.length) {
            e.target.setSelectionRange(cursorPosition, cursorPosition);
        }
    });
    
    // Auto-start with +7- when user starts typing
    phoneInput.addEventListener('focus', function(e) {
        if (!e.target.value) {
            e.target.value = '+7-';
        }
    });
    
    // Clear placeholder text on empty
    phoneInput.addEventListener('blur', function(e) {
        if (e.target.value === '+7-' || e.target.value === '+7') {
            e.target.value = '';
        }
    });
    
    // Handle form submission
    document.getElementById('add-client-form').addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        e.preventDefault();
        console.log('Default prevented, calling validateAndSaveNewClient');
        validateAndSaveNewClient();
    });
}

// Close add client modal
function closeAddClientModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Validate and save new client
function validateAndSaveNewClient() {
    const fullName = document.getElementById('add-client-full-name').value.trim();
    const email = document.getElementById('add-client-email').value.trim();
    const phone = document.getElementById('add-client-phone').value.trim();
    
    console.log('Validating client data:', {fullName, email, phone});
    
    // Validation
    if (!fullName || fullName.length < 2) {
        alert('Пожалуйста, введите корректное полное имя (минимум 2 символа)');
        return;
    }
    
    // Email validation
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    if (!email || !emailRegex.test(email)) {
        alert('Пожалуйста, введите корректный email адрес');
        return;
    }
    
    // Phone validation (optional but must be correct format if provided)
    const phoneRegex = /^\+7-\d{3}-\d{3}-\d{2}-\d{2}$/;
    if (phone && !phoneRegex.test(phone)) {
        alert('Пожалуйста, введите телефон в формате +7-918-123-45-67 или оставьте поле пустым');
        return;
    }
    
    console.log('Validation passed, calling saveNewClient');
    saveNewClient(fullName, email, phone);
}

// Save new client
function saveNewClient(fullName, email, phone) {
    const requestData = {
        full_name: fullName,
        email: email,
        phone: phone || null,
        is_active: document.getElementById('add-client-active').checked
    };
    
    console.log('Sending client data:', requestData);
    
    fetch('/api/manager/add-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert(`Клиент "${fullName}" успешно добавлен!`);
            closeAddClientModal();
            
            // Force reload clients with a small delay to ensure server processing
            setTimeout(() => {
                loadClients();
                // Also update the client select dropdown
                loadClientsForCollectionSelect();
            }, 500);
        } else {
            alert(data.error || 'Ошибка при добавлении клиента');
        }
    })
    .catch(error => {
        console.error('Error adding client:', error);
        alert('Ошибка при добавлении клиента. Проверьте подключение к интернету.');
    });
}

// Load clients for collection select dropdown
function loadClientsForCollectionSelect() {
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('collection-client');
                if (select) {
                    select.innerHTML = '<option value="">Выберите клиента</option>' + 
                        data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
                }
            }
        })
        .catch(error => console.error('Error loading clients for collection select:', error));
}

// Event listeners
// Remove application modal functionality - causes unwanted popups
function removeApplicationModals() {
    // Remove any existing application modals
    const modals = document.querySelectorAll('.modal, [id*="application"], [id*="Application"]');
    modals.forEach(modal => {
        if (modal.id !== 'user-menu' && !modal.closest('.content-section')) {
            modal.remove();
        }
    });
    
    // Disable any application form handlers
    const forms = document.querySelectorAll('form[action*="application"]');
    forms.forEach(form => form.style.display = 'none');
}

document.addEventListener('DOMContentLoaded', function() {
    // Remove unwanted application modals first
    removeApplicationModals();
    // No auto-activation - let other handler manage initial section
    
    // Toggle advanced filters (only if element exists)
    const toggleFiltersButton = document.getElementById('toggle-advanced-filters');
    if (toggleFiltersButton) {
        toggleFiltersButton.addEventListener('click', function() {
            const advancedFilters = document.getElementById('advanced-filters');
            const button = this;
            
            if (advancedFilters && advancedFilters.classList.contains('manager-favorites-hidden')) {
                advancedFilters.classList.remove('manager-favorites-hidden');
                button.textContent = '- Скрыть дополнительные фильтры';
            } else if (advancedFilters) {
                advancedFilters.classList.add('manager-favorites-hidden');
                button.textContent = '+ Дополнительные фильтры';
            }
        });
    }

    // View toggle buttons (only if elements exist)
    const viewGridBtn = document.getElementById('view-grid-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    
    if (viewGridBtn) {
        viewGridBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'grid';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewListBtn) {
                viewListBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewListBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }

    if (viewListBtn) {
        viewListBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'list';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewGridBtn) {
                viewGridBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewGridBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }
    
    // Search apartments button
    document.getElementById('search-apartments-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        searchApartments();
    });
    
    // Add filter change listeners to trigger search
    ['filter-district', 'filter-developer', 'filter-rooms', 'filter-complex', 'filter-price-min', 'filter-price-max', 'filter-area-min', 'filter-area-max', 'filter-floor-min', 'filter-floor-max', 'filter-status', 'filter-finishing'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                // Only search if we already have results
                const container = document.getElementById('properties-results');
                if (container && !container.querySelector('p')) {
                    searchApartments();
                }
            });
        }
    });

    // Load complexes for filter
    loadComplexes();
    
    // Add client button
    document.getElementById('add-client-btn').addEventListener('click', function() {
        showAddClientModal();
    });
    
    // Clear selection button
    document.getElementById('clear-selection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectedProperties = [];
        updateSelectedProperties();
        updateButtons();
        
        // Refresh search results
        const searchContainer = document.getElementById('properties-results');
        if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
            searchApartments();
        }
    });
    
    // Save collection button
    document.getElementById('save-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        fetch('/api/manager/collections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                client_id: clientId,
                property_ids: selectedProperties
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Подборка успешно создана!');
                // Reset form
                document.getElementById('collection-name').value = '';
                document.getElementById('collection-client').value = '';
                selectedProperties = [];
                updateSelectedProperties();
                updateButtons();
                // Clear search results
                document.getElementById('properties-results').innerHTML = 
                    '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
            } else {
                alert('Ошибка создания подборки: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving collection:', error);
            alert('Ошибка сохранения подборки');
        });
    });
    
    // Send collection button
    document.getElementById('send-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        if (confirm('Отправить подборку клиенту по email?')) {
            fetch('/api/manager/send-collection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    client_id: clientId,
                    property_ids: selectedProperties
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Подборка отправлена клиенту!');
                    // Reset form
                    document.getElementById('collection-name').value = '';
                    document.getElementById('collection-client').value = '';
                    selectedProperties = [];
                    updateSelectedProperties();
                    updateButtons();
                    // Clear search results
                    document.getElementById('properties-results').innerHTML = 
                        '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
                } else {
                    alert('Ошибка отправки: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error sending collection:', error);
                alert('Ошибка отправки подборки');
            });
        }
    });
    
    // Load initial data based on active section
    loadClients();
    
    // Clean up any remaining unwanted modals periodically
    setInterval(removeApplicationModals, 5000);
});

// Manager Saved Searches functionality
window.loadManagerSavedSearches = async function() {
    try {
        const response = await fetch('/api/manager/saved-searches');
        if (!response.ok) {
            console.error('❌ Saved searches API error - Status:', response.status);
            const text = await response.text();
            console.error('❌ Response text:', text.substring(0, 200));
            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
        }
        const data = await response.json();
        
        const grid = document.getElementById('saved-searches-grid');
        if (!data.success || !data.searches.length) {
            grid.innerHTML = `
                <div class="text-center py-16 col-span-full">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900 mb-1">Нет сохранённых поисков</h4>
                    <p class="text-sm text-gray-500 mb-4">Создайте свой первый поиск</p>
                    <button onclick="createNewSearch()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Создать поиск
                    </button>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = data.searches.map(search => {
            const filters = search.additional_filters ? JSON.parse(search.additional_filters) : {};
            const filterTags = search.additional_filters ? formatSearchFilters(filters) : '';
            const date = formatDate(search.created_at);
            return `
            <div class="bg-white rounded-2xl border border-gray-100 hover:shadow-md transition-all overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-sm text-gray-900 truncate flex-1">${search.name}</h3>
                        <button onclick="deleteManagerSearch(${search.id})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors ml-2 flex-shrink-0" title="Удалить">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                    ${search.description ? `<p class="text-xs text-gray-500 mb-3">${search.description}</p>` : ''}
                    ${filterTags ? `<div class="flex flex-wrap gap-1.5 mb-3">${filterTags}</div>` : ''}
                    <div class="flex items-center gap-3 text-xs text-gray-400 mb-3">
                        <span class="flex items-center">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            ${date}
                        </span>
                        <span class="flex items-center">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                            ${search.usage_count || 0} раз
                        </span>
                    </div>
                    <div class="flex gap-2 pt-3 border-t border-gray-100">
                        <button onclick="viewManagerSearch(${search.id})" class="flex-1 inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-[#0088CC] bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            Просмотр
                        </button>
                        <button onclick="sendSearchToClient(${search.id})" class="flex-1 inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-[#0088CC] rounded-lg hover:bg-[#006699] transition-colors">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                            Отправить
                        </button>
                    </div>
                </div>
            </div>`;
        }).join('');
        
        // Update saved searches count in menu
        const savedSearchesCount = document.getElementById('saved-searches-count');
        if (savedSearchesCount) {
            savedSearchesCount.textContent = data.searches.length;
            savedSearchesCount.style.display = data.searches.length > 0 ? 'inline' : 'none';
            console.log('🔄 Updated saved searches count to:', data.searches.length);
        }
        
    } catch (error) {
        console.error('Error loading saved searches:', error);
        document.getElementById('saved-searches-grid').innerHTML = `
            <div class="text-center py-12 col-span-full">
                <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                </div>
                <p class="text-sm text-red-600">Ошибка загрузки сохранённых поисков</p>
            </div>
        `;
    }
};

window.viewManagerSearch = async function(searchId) {
    try {
        const response = await fetch('/api/manager/saved-searches');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.success) {
            const search = data.searches.find(s => s.id === searchId);
            if (search && search.additional_filters) {
                const filters = JSON.parse(search.additional_filters);
                if (filters.search_url) {
                    window.open(filters.search_url, '_blank');
                    return;
                }
                const params = new URLSearchParams();
                if (filters.rooms && filters.rooms.length > 0) filters.rooms.forEach(r => params.append('rooms[]', r));
                if (filters.price_min && filters.price_min !== '') params.append('price_min', filters.price_min);
                if (filters.price_max && filters.price_max !== '') params.append('price_max', filters.price_max);
                if (filters.area_min && filters.area_min !== '') params.append('area_min', filters.area_min);
                if (filters.area_max && filters.area_max !== '') params.append('area_max', filters.area_max);
                if (filters.floor_min && filters.floor_min !== '') params.append('floor_min', filters.floor_min);
                if (filters.floor_max && filters.floor_max !== '') params.append('floor_max', filters.floor_max);
                if (filters.districts && filters.districts.length > 0) filters.districts.forEach(d => params.append('districts[]', d));
                if (filters.developers && filters.developers.length > 0) filters.developers.forEach(d => params.append('developers[]', d));
                if (filters.completion && filters.completion.length > 0) filters.completion.forEach(c => params.append('completion[]', c));
                if (filters.object_classes && filters.object_classes.length > 0) filters.object_classes.forEach(c => params.append('object_classes[]', c));
                if (filters.renovation && filters.renovation.length > 0) filters.renovation.forEach(r => params.append('renovation[]', r));
                if (filters.building_released && filters.building_released.length > 0) filters.building_released.forEach(b => params.append('building_released[]', b));
                if (filters.floor_options && filters.floor_options.length > 0) filters.floor_options.forEach(f => params.append('floor_options[]', f));
                if (filters.property_type) params.append('property_type', filters.property_type);
                window.open(`/properties?${params.toString()}`, '_blank');
            } else {
                window.open('/properties', '_blank');
            }
        }
    } catch (error) {
        console.error('Error viewing search:', error);
        window.open('/properties', '_blank');
    }
};

window.createNewSearch = function() {
    window.open('/properties', '_blank');
};

window.sendSearchToClient = async function(searchId) {
    // Open modal to select client
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                    <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]">
                        <option value="">Выберите клиента...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                    <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]" placeholder="Дополнительное сообщение для клиента..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSendSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients into select
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('client-select');
        if (data.success && data.clients.length > 0) {
            select.innerHTML = '<option value="">Выберите клиента...</option>' + 
                data.clients.map(client => `<option value="${client.id}">${client.full_name} (${client.email})</option>`).join('');
        } else {
            select.innerHTML = '<option value="">Клиенты не найдены</option>';
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = async function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value.trim();
    
    if (!clientId) {
        alert('Выберите клиента');
        return;
    }
    
    try {
        const response = await fetch('/api/manager/send-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                search_id: searchId,
                client_id: clientId,
                message: message
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Поиск успешно отправлен клиенту!');
            closeSendSearchModal();
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка отправки: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending search:', error);
        alert('Ошибка отправки поиска');
    }
};

window.deleteManagerSearch = async function(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/manager/saved-search/${searchId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка удаления: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка удаления поиска');
    }
};

function formatSearchFilters(filters) {
    const tags = [];
    if (filters.rooms && filters.rooms.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${filters.rooms.join(', ')}</span>`);
    }
    if (filters.districts && filters.districts.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-green-800 text-xs rounded-full">${filters.districts.join(', ')}</span>`);
    }
    if (filters.priceTo || filters.priceFrom) {
        const priceText = `${filters.priceFrom || '0'}-${filters.priceTo || '∞'} млн`;
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-yellow-800 text-xs rounded-full">${priceText}</span>`);
    }
    if (filters.developers && filters.developers.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-sky-100 text-sky-800 text-xs rounded-full">${filters.developers[0]}${filters.developers.length > 1 ? '...' : ''}</span>`);
    }
    return tags.join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('ru-RU');
}

// Recommendations functionality - using global window.loadRecommendations

function updateRecommendationStats(recommendations) {
    const stats = {
        sent: recommendations.length,
        viewed: recommendations.filter(r => r.viewed_at).length,
        interested: recommendations.filter(r => r.client_response === 'interested').length,
        scheduled: recommendations.filter(r => r.viewing_scheduled_at).length
    };
    
    document.getElementById('recommendations-sent').textContent = stats.sent;
    document.getElementById('recommendations-viewed').textContent = stats.viewed;
    document.getElementById('recommendations-interested').textContent = stats.interested;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-paper-plane text-4xl mb-4"></i>
                <p>Рекомендации не найдены</p>
                <p class="text-sm">Перейдите на страницу недвижимости, чтобы отправить первую рекомендацию</p>
            </div>
        `;
        return;
    }
    
    const html = recommendations.map(rec => {
        const statusClass = getStatusClass(rec.status);
        const priorityClass = getPriorityClass(rec.priority_level);
        const createdAt = new Date(rec.created_at).toLocaleDateString('ru-RU');
        const viewedAt = rec.viewed_at ? new Date(rec.viewed_at).toLocaleDateString('ru-RU') : null;
        
        return `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">${rec.title}</h4>
                        <p class="text-gray-600 text-sm mb-2">
                            <i class="fas ${rec.recommendation_type === 'property' ? 'fa-home' : 'fa-building'} mr-1"></i>
                            ${rec.recommendation_type === 'property' ? 'Квартира' : 'ЖК'}: ${rec.item_name}
                        </p>
                        <p class="text-gray-700 text-sm">
                            <i class="fas fa-user mr-1"></i>
                            Клиент: ${rec.client_name} (${rec.client_email})
                        </p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                            ${getStatusText(rec.status)}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full ${priorityClass}">
                            ${getPriorityText(rec.priority_level)}
                        </span>
                    </div>
                </div>
                
                ${rec.description ? `<p class="text-gray-600 mb-3">${rec.description}</p>` : ''}
                ${rec.manager_notes ? `<p class="text-sm text-gray-500 bg-gray-50 p-2 rounded mb-3"><strong>Ваши заметки:</strong> ${rec.manager_notes}</p>` : ''}
                
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>
                        <span>Отправлено: ${createdAt}</span>
                        ${viewedAt ? ` • <span class="text-green-600">Просмотрено: ${viewedAt}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${rec.recommendation_type === 'property' ? 
                            `<a href="/object/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть объект</a>` :
                            `<a href="/complex/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть ЖК</a>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-gray-100 text-gray-700',
        'viewed': 'bg-gray-100 text-green-800', 
        'interested': 'bg-sky-100 text-sky-800',
        'not_interested': 'bg-gray-100 text-red-800',
        'scheduled_viewing': 'bg-gray-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getPriorityClass(priority) {
    const classes = {
        'urgent': 'bg-gray-100 text-red-800',
        'high': 'bg-gray-100 text-orange-800',
        'normal': 'bg-gray-100 text-gray-800',
        'low': 'bg-gray-100 text-green-800'
    };
    return classes[priority] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

function getPriorityText(priority) {
    const texts = {
        'urgent': 'Срочно',
        'high': 'Высокий',
        'normal': 'Обычный',
        'low': 'Низкий'
    };
    return texts[priority] || 'Обычный';
}

// Adaptive welcome message function
window.loadWelcomeMessage = function() {
    console.log('🌟 Loading adaptive welcome message...');
    fetch('/api/manager/welcome-message')
        .then(response => {
            console.log('📡 Welcome message response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Welcome message data received:', data);
            if (data.success) {
                const container = document.getElementById('welcome-messages');
                const iconContainer = document.getElementById('welcome-icon');
                
                if (!container) {
                    console.error('❌ welcome-messages container not found');
                    return;
                }
                
                // Create messages HTML
                const messagesHtml = data.messages.map((message, index) => {
                    if (index === 0) {
                        // First message is the title
                        document.getElementById('welcome-title').textContent = message;
                        return '';
                    } else {
                        // Subsequent messages
                        const className = index === 1 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }
                }).filter(html => html).join('');
                
                container.innerHTML = messagesHtml;
                
                // Update icon based on activity context
                if (data.context && iconContainer) {
                    const icon = iconContainer.querySelector('svg');
                    if (data.context.high_activity) {
                        // High activity - star icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-green-500 to-green-600');
                    } else if (data.context.needs_attention) {
                        // Needs attention - notification icon
                        icon.innerHTML = '<path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-orange-500 to-orange-600');
                    } else if (data.context.new_day) {
                        // New day - sun icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-yellow-500 to-yellow-600');
                    }
                }
                
                console.log('✅ Welcome message loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
            }
        })
        .catch(error => {
            console.error('💥 Error loading welcome message:', error);
        });
};

window.loadRecentRecommendations = function() {
    console.log('🔄 Loading manager activity feed...');
    fetch('/api/manager/activity-feed')
        .then(response => {
            console.log('📡 Activity feed response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Activity feed data received:', data);
            if (data.success) {
                const recentActivities = data.activities.slice(0, 5);
                const container = document.getElementById('recent-recommendations');
                
                if (!container) {
                    console.error('❌ recent-recommendations container not found');
                    return;
                }
                
                if (recentActivities.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">Активности пока нет</div>';
                    return;
                }
                
                const html = recentActivities.map(activity => {
                    let bgColor = 'bg-blue-100';
                    let textColor = 'text-blue-600';
                    let iconSvg = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>';
                    
                    if (activity.type === 'presentation_view' || activity.icon === 'eye') {
                        bgColor = 'bg-sky-100';
                        textColor = 'text-[#0088CC]';
                        iconSvg = '<path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>';
                    } else if (activity.type === 'recommendation' || activity.icon === 'paper-plane') {
                        bgColor = 'bg-blue-100';
                        textColor = 'text-blue-600';
                        iconSvg = '<path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>';
                    } else if (activity.type === 'deal_update' || activity.icon === 'briefcase') {
                        bgColor = 'bg-sky-100';
                        textColor = 'text-[#0088CC]';
                        iconSvg = '<path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/><path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>';
                    } else if (activity.type === 'task_update' || activity.icon === 'clipboard') {
                        bgColor = 'bg-amber-100';
                        textColor = 'text-amber-600';
                        iconSvg = '<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>';
                    } else if (activity.type === 'comment' || activity.icon === 'chat') {
                        bgColor = 'bg-gray-100';
                        textColor = 'text-gray-600';
                        iconSvg = '<path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>';
                    } else if (activity.type === 'task_reminder' || activity.icon === 'clock') {
                        bgColor = 'bg-orange-100';
                        textColor = 'text-orange-600';
                        iconSvg = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>';
                    } else if (activity.icon === 'user-plus') {
                        bgColor = 'bg-green-100';
                        textColor = 'text-green-600';
                        iconSvg = '<path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>';
                    }
                    
                    return `
                        <div class="flex items-start space-x-4 p-4 rounded-xl hover:bg-gray-50 transition-colors">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 ${textColor}" fill="currentColor" viewBox="0 0 20 20">
                                        ${iconSvg}
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                                <p class="text-sm text-gray-600 truncate">${activity.description}</p>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${activity.time_ago}</span>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                console.log('✅ Manager activity feed loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки активности</div>';
                }
            }
        })
        .catch(error => {
            console.error('💥 Error loading activity feed:', error);
            const container = document.getElementById('recent-recommendations');
            if (container) {
                container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки активности</div>';
            }
        });
};

// Load recommendations function
function loadRecommendations() {
    // Get filter values
    const clientFilter = document.getElementById('rec-filter-client').value;
    const statusFilter = document.getElementById('rec-filter-status').value;
    const typeFilter = document.getElementById('rec-filter-type').value;
    const priorityFilter = document.getElementById('rec-filter-priority').value;
    
    // Build query params
    const params = new URLSearchParams();
    if (clientFilter) params.append('client_id', clientFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    if (priorityFilter) params.append('priority', priorityFilter);
    
    const url = '/api/manager/recommendations' + (params.toString() ? '?' + params.toString() : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recommendations = data.recommendations;
                const stats = data.stats;
                
                // Update stats
                document.getElementById('recommendations-sent').textContent = stats.sent || 0;
                document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
                document.getElementById('recommendations-interested').textContent = stats.interested || 0;
                document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
                document.getElementById('sidebar-recommendations-count').textContent = stats.sent || 0;
                
                // Update recommendations list
                const container = document.getElementById('recommendations-container');
                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Рекомендации не найдены</p>
                            <p class="text-sm mt-2">Отправьте первые рекомендации клиентам через страницу "Недвижимость"</p>
                        </div>
                    `;
                    return;
                }
                
                const html = recommendations.map(rec => {
                    const statusClass = {
                        'sent': 'bg-gray-100 text-gray-700',
                        'viewed': 'bg-gray-100 text-green-800',
                        'interested': 'bg-sky-100 text-sky-800',
                        'not_interested': 'bg-gray-100 text-gray-800',
                        'scheduled_viewing': 'bg-gray-100 text-orange-800'
                    }[rec.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'sent': 'Отправлено',
                        'viewed': 'Просмотрено',
                        'interested': 'Заинтересованы',
                        'not_interested': 'Не заинтересованы',
                        'scheduled_viewing': 'Просмотр назначен'
                    }[rec.status] || rec.status;
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 mb-1">${rec.title}</h3>
                                    <p class="text-sm text-gray-600">для ${rec.client_name} (${rec.client_email})</p>
                                    <p class="text-xs text-gray-500 mt-1">${rec.item_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            
                            ${rec.description ? `<p class="text-sm text-gray-700 mb-3">${rec.description}</p>` : ''}
                            
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Отправлено: ${new Date(rec.sent_at).toLocaleDateString('ru-RU')}</span>
                                <div class="flex items-center gap-2">
                                    ${rec.viewed_at ? `<span>Просмотрено: ${new Date(rec.viewed_at).toLocaleDateString('ru-RU')}</span>` : ''}
                                    <button onclick="deleteRecommendation(${rec.id}, '${rec.title}')" 
                                            class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" 
                                            title="Удалить рекомендацию">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-red-500 text-center py-8">Ошибка загрузки рекомендаций</div>';
        });
}

// Delete recommendation function
function deleteRecommendation(recommendationId, title) {
    if (!confirm(`Вы уверены, что хотите удалить рекомендацию "${title}"?`)) {
        return;
    }
    
    fetch(`/api/manager/recommendations/${recommendationId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Рекомендация успешно удалена');
            loadRecommendations(); // Reload the list
        } else {
            alert(data.error || 'Ошибка при удалении рекомендации');
        }
    })
    .catch(error => {
        console.error('Error deleting recommendation:', error);
        alert('Ошибка при удалении рекомендации');
    });
}

// Load clients for filter
function loadClientsForFilter() {
    fetch('/api/manager/clients-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('rec-filter-client');
                select.innerHTML = '<option value="">Все клиенты</option>' + 
                    data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading clients for filter:', error));
}

// Load collections function
function loadCollections() {
    console.log('Loading collections...');
    const container = document.getElementById('collections-grid');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка подборок...</p></div>';
    
    fetch('/api/manager/collections')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const collections = data.collections || [];
                
                if (collections.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 mb-2">У вас пока нет подборок</p>
                            <button onclick="showSection('create-collection')" class="text-[#0088cc] hover:text-[#006699] font-medium">
                                Создать первую подборку
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const html = collections.map(collection => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-gray-800">${collection.name}</h3>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(collection.status)}">
                                ${collection.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Клиент: ${collection.client_name || 'Не указан'}</p>
                        <p class="text-sm text-gray-500 mb-3">Объектов: ${collection.properties_count || 0}</p>
                        <p class="text-xs text-gray-500">Создано: ${new Date(collection.created_at).toLocaleDateString('ru-RU')}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="viewCollection(${collection.id})" class="text-[#0088cc] hover:text-[#006699] text-sm">
                                Просмотр
                            </button>
                            <button onclick="editCollection(${collection.id})" class="text-gray-600 hover:text-gray-800 text-sm">
                                Редактировать
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
            }
        })
        .catch(error => {
            console.error('Error loading collections:', error);
            container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
        });
}

// Load applications function
function loadApplications() {
    console.log('Loading applications...');
    // For now, show a message that this section is under development
    const container = document.querySelector('#applications .overflow-x-auto table tbody');
    if (!container) {
        // If table body doesn't exist, find the applications section
        const appsSection = document.getElementById('applications');
        if (appsSection) {
            const tableContainer = appsSection.querySelector('.overflow-x-auto');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 mb-2">Заявки на кешбек</p>
                        <p class="text-sm text-gray-400">Эта функция находится в разработке</p>
                    </div>
                `;
            }
        }
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
                Загрузка заявок...
            </td>
        </tr>
    `;
    
    // For demo, show empty state after a delay
    setTimeout(() => {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <p>Заявки на кешбек пока отсутствуют</p>
                    <p class="text-sm mt-1">Клиенты смогут подавать заявки после покупки недвижимости</p>
                </td>
            </tr>
        `;
    }, 1000);
}

// Load deals function - новая функция для сделок
function loadDeals() {
    console.log('🤝 Loading deals...');
    
    const dealsSection = document.getElementById('deals');
    if (!dealsSection) {
        console.error('❌ Deals section not found');
        return;
    }
    
    // Show loading state
    dealsSection.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">🤝 Управление сделками</h2>
                        <p class="text-gray-600 mt-1">Отслеживайте и управляйте сделками с клиентами</p>
                    </div>
                    <button onclick="openCreateDealModal()" 
                            class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Новая сделка
                    </button>
                </div>
                
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Загрузка сделок...</p>
                </div>
            </div>
        </div>
    `;
    
    // Load deals from API
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Deals data received:', data);
        
        // Update deals statistics counters
        updateStaticDealsStats(data);
        
        let dealsHtml = '';
        
        if (data.success && data.deals && data.deals.length > 0) {
            // Show deals table
            dealsHtml = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">🤝 Управление сделками</h2>
                                <p class="text-gray-600 mt-1">Найдено сделок: ${data.deals.length}</p>
                            </div>
                            <button onclick="openCreateDealModal()" 
                                    class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Новая сделка
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ЖК</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сумма</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Кешбек</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${data.deals.map(deal => {
                                        const statusColors = {
                                            'new': 'bg-blue-100 text-blue-800',
                                            'in_progress': 'bg-sky-100 text-sky-800',
                                            'calculation': 'bg-indigo-100 text-indigo-800',
                                            'meeting_scheduled': 'bg-violet-100 text-violet-800',
                                            'meeting_done': 'bg-fuchsia-100 text-fuchsia-800',
                                            'postponed': 'bg-amber-100 text-amber-800',
                                            'verbal_reserve': 'bg-orange-100 text-orange-800',
                                            'reserved': 'bg-red-100 text-red-800',
                                            'object_reserved': 'bg-orange-100 text-orange-800',
                                            'documents': 'bg-pink-100 text-pink-800',
                                            'mortgage': 'bg-teal-100 text-teal-800',
                                            'ddu_preparation': 'bg-cyan-100 text-cyan-800',
                                            'ddu_signing': 'bg-sky-100 text-sky-800',
                                            'registration': 'bg-indigo-100 text-indigo-800',
                                            'receivables': 'bg-red-100 text-red-800',
                                            'completed': 'bg-green-100 text-green-800',
                                            'successful': 'bg-green-100 text-green-800',
                                            'rejected': 'bg-gray-100 text-gray-800',
                                            'pending': 'bg-yellow-100 text-yellow-800',
                                            'approved': 'bg-green-100 text-green-800'
                                        };
                                        
                                        const statusText = {
                                            'new': 'Новая',
                                            'in_progress': 'В работе',
                                            'calculation': 'Сделан расчёт',
                                            'meeting_scheduled': 'Встреча назначена',
                                            'meeting_done': 'Встреча проведена',
                                            'postponed': 'Отложена',
                                            'verbal_reserve': 'Устная бронь',
                                            'reserved': 'Бронь',
                                            'object_reserved': 'Забронирован',
                                            'documents': 'Сбор документов',
                                            'mortgage': 'Ипотека',
                                            'ddu_preparation': 'Подготовка ДДУ',
                                            'ddu_signing': 'Подписание ДДУ',
                                            'registration': 'Регистрация',
                                            'receivables': 'Дебиторка',
                                            'completed': 'Завершена',
                                            'successful': 'Успешная',
                                            'rejected': 'Отклонена',
                                            'pending': 'Ожидает',
                                            'approved': 'Одобрено'
                                        };
                                        
                                        const dealInitials = (deal.client_name || 'К').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                                        const dealColorIdx = (deal.id || 0) % 5;
                                        const dealColors = ['bg-[#0088CC]', 'bg-green-500', 'bg-blue-500', 'bg-teal-500', 'bg-indigo-500'];
                                        
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center space-x-3">
                                                        ${deal.client_profile_image
                                                            ? `<img src="${deal.client_profile_image}" alt="${deal.client_name || ''}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
                                                            : ''}
                                                        <div class="w-8 h-8 ${dealColors[dealColorIdx]} rounded-full items-center justify-center text-white font-bold text-xs flex-shrink-0" style="display:${deal.client_profile_image ? 'none' : 'flex'}">
                                                            ${dealInitials}
                                                        </div>
                                                        <div class="text-sm font-medium text-gray-900">${deal.client_name || 'Не указан'}</div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900">${deal.complex_name || 'Не указан'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">${deal.property_price ? (parseFloat(deal.property_price).toLocaleString('ru-RU') + ' ₽') : '0 ₽'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-[#059669]">${deal.cashback_amount ? (parseFloat(deal.cashback_amount).toLocaleString('ru-RU') + ' ₽') : '0 ₽'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[deal.status] || 'bg-gray-100 text-gray-800'}">
                                                        ${statusText[deal.status] || deal.status}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${new Date(deal.created_at).toLocaleDateString('ru-RU')}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button onclick="openCreateDealModal()" 
                                    class="inline-flex items-center px-4 py-2 border border-[#0088CC] text-[#0088CC] hover:bg-[#0088CC] hover:text-white rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать новую сделку
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Show empty state
            dealsHtml = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">🤝 Управление сделками</h2>
                                <p class="text-gray-600 mt-1">Система управления сделками с клиентами</p>
                            </div>
                        </div>
                        
                        <div class="text-center py-12">
                            <i class="fas fa-handshake text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Сделки пока отсутствуют</h3>
                            <p class="text-gray-500 mb-6">Создайте первую сделку с клиентом для начала работы</p>
                            <button onclick="openCreateDealModal()" 
                                    class="inline-flex items-center px-6 py-3 bg-[#0088CC] hover:bg-[#0077BB] text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать новую сделку
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        dealsSection.innerHTML = dealsHtml;
        console.log('✅ Deals loaded successfully');
    })
    .catch(error => {
        console.error('❌ Error loading deals:', error);
        dealsSection.innerHTML = `
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">🤝 Управление сделками</h2>
                            <p class="text-red-600 mt-1">Ошибка загрузки данных</p>
                        </div>
                        <button onclick="openCreateDealModal()" 
                                class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Новая сделка
                        </button>
                    </div>
                    
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Ошибка загрузки</h3>
                        <p class="text-gray-500 mb-6">Не удалось загрузить данные о сделках</p>
                        <button onclick="loadDeals()" 
                                class="inline-flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-redo mr-2"></i>Попробовать снова
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
}

// Helper function for status classes
function getStatusClass(status) {
    const statusClasses = {
        'Черновик': 'bg-gray-100 text-gray-800',
        'Отправлена': 'bg-blue-100 text-blue-800',
        'Просмотрена': 'bg-green-100 text-green-800',
        'Архив': 'bg-red-100 text-red-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

// Collection management functions
function viewCollection(collectionId) {
    // Redirect to collection view page
    window.location.href = `/manager/collection/${collectionId}`;
}

function editCollection(collectionId) {
    // For now, redirect to collection view
    viewCollection(collectionId);
}

// Ensure functions are available globally before initialization
window.showAddClientModal = function() {
    console.log('showAddClientModal called');
    const modal = document.getElementById('client-modal');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error('Client modal not found');
    }
};

// Removed fallback functions - using main functions above

// Initialize on page load  
document.addEventListener('DOMContentLoaded', function() {
    console.log('Manager dashboard DOMContentLoaded - initializing...');
    
    // Setup initial view - only if no hash is present
    const hash = window.location.hash.replace('#', '');
    const initialSection = hash || 'dashboard';
    showSection(initialSection);
    
    // Load data with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('🚀 Starting OPTIMIZED dashboard load...');
        
        // ===== OPTIMIZED: Load all dashboard data with ONE API call =====
        if (typeof window.loadDashboardData === 'function') {
            window.loadDashboardData();
        } else {
            console.error('❌ loadDashboardData function not available - falling back to individual calls');
            // Fallback to individual calls if optimized function not available
            if (typeof window.loadClients === 'function') window.loadClients();
            if (typeof window.loadRecommendations === 'function') window.loadRecommendations();
            if (typeof window.loadRecentRecommendations === 'function') window.loadRecentRecommendations();
            if (typeof window.loadWelcomeMessage === 'function') window.loadWelcomeMessage();
        }
        
        // Load clients for filter dropdown (separate endpoint, not in aggregated call)
        if (typeof loadClientsForFilter === 'function') {
            loadClientsForFilter();
        }
    }, 500);
});

// Removed duplicate - now defined at top

// Presentation functions
function createPresentation() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Создать презентацию</h3>
            <form id="presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Например: Подборка для семьи Ивановых" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Имя клиента</label>
                    <input type="text" id="client-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Иван Петров">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон клиента</label>
                    <input type="tel" id="client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="+7 900 123 45 67">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" rows="3" placeholder="Краткое описание презентации"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#005588] transition-all">Создать</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value;
        const clientName = document.getElementById('client-name').value;
        const clientPhone = document.getElementById('client-phone').value;
        const description = document.getElementById('presentation-description').value;
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    client_name: clientName,
                    client_phone: clientPhone,
                    description: description
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadPresentations();
                showNotification('Презентация создана успешно!', 'success');
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeModal() {
    const modals = document.querySelectorAll('[data-modal-overlay]');
    if (modals.length > 0) {
        modals[modals.length - 1].remove();
        return;
    }
    const fallback = document.querySelectorAll('.fixed.inset-0.bg-black');
    if (fallback.length > 0) {
        fallback[fallback.length - 1].remove();
    }
}

// Show create presentation modal
function showCreatePresentationModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.setAttribute('data-modal', 'create-presentation');
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Создать презентацию</h3>
                <button onclick="closeCreatePresentationModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="create-presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
                           placeholder="Например: Лучшие предложения для Иванова">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Для клиента (необязательно)</label>
                    <input type="text" id="presentation-client" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
                           placeholder="Имя клиента">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
                              placeholder="Краткое описание презентации"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeCreatePresentationModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#005588] text-white rounded-lg transition-colors">
                        Создать
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.currentPresentationModal = modal;
    
    // Handle form submission
    document.getElementById('create-presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value.trim();
        const client = document.getElementById('presentation-client').value.trim();
        const description = document.getElementById('presentation-description').value.trim();
        
        if (!title) {
            alert('Введите название презентации');
            return;
        }
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    title: title,
                    client_name: client || null,
                    description: description || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeCreatePresentationModal();
                showNotification('Презентация создана успешно!', 'success');
                loadPresentations(); // Refresh the list
            } else {
                showNotification(`Ошибка: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error creating presentation:', error);
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeCreatePresentationModal() {
    if (window.currentPresentationModal) {
        window.currentPresentationModal.remove();
        window.currentPresentationModal = null;
    }
}

function loadPresentations() {
    fetch('/api/manager/presentations', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('Raw response:', text);
            // Извлекаем JSON из ответа, игнорируя HTML редирект
            const jsonStart = text.indexOf('{');
            if (jsonStart !== -1) {
                const jsonText = text.substring(jsonStart);
                const data = JSON.parse(jsonText);
                if (data.success) {
                    displayPresentations(data.presentations);
                } else {
                    console.error('Error loading presentations:', data.error);
                }
            } else {
                console.error('No JSON found in response:', text);
            }
        })
        .catch(error => {
            console.error('Error loading presentations:', error);
        });
}

function displayPresentations(presentations) {
    const container = document.getElementById('presentations-container');
    
    if (!container) return;
    
    if (!presentations || presentations.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет презентаций</h4>
                <p class="text-sm text-gray-500">Создайте первую презентацию для клиентов</p>
            </div>`;
        return;
    }
    
    const statusColors = {
        'Просмотрена': 'bg-green-100 text-green-800',
        'Отправлена': 'bg-blue-100 text-blue-800',
        'Создана': 'bg-gray-100 text-gray-800',
        'Черновик': 'bg-yellow-100 text-yellow-800'
    };
    const iconColors = ['from-[#0088CC] to-[#006699]', 'from-green-500 to-emerald-600', 'from-blue-500 to-blue-600', 'from-teal-500 to-cyan-600', 'from-indigo-500 to-blue-600'];
    
    container.innerHTML = presentations.map(presentation => {
        const colorIndex = (presentation.id || 0) % iconColors.length;
        const initials = (presentation.title || 'П').substring(0, 2).toUpperCase();
        const statusClass = statusColors[presentation.status] || 'bg-gray-100 text-gray-800';
        const createdDate = new Date(presentation.created_at).toLocaleDateString('ru-RU');
        const lastViewed = presentation.last_viewed_at ? new Date(presentation.last_viewed_at).toLocaleDateString('ru-RU') : null;
        const safeTitle = (presentation.title || '').replace(/"/g, '&quot;');
        
        return `
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 hover:shadow-md transition-all group">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-11 h-11 bg-gradient-to-r ${iconColors[colorIndex]} rounded-xl flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-semibold text-gray-900 text-sm truncate">${presentation.title || 'Без названия'}</h4>
                            ${presentation.client_name ? `<p class="text-xs text-gray-500 mt-0.5">Для: ${presentation.client_name}</p>` : ''}
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass} flex-shrink-0 ml-2">${presentation.status || 'Создана'}</span>
                </div>
                
                <div class="space-y-1.5 mb-3">
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span>${presentation.property_count || 0} объектов</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <span>${presentation.view_count || 0} просмотров</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>Создано: ${createdDate}</span>
                    </div>
                    ${lastViewed ? `
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Просмотр: ${lastViewed}</span>
                    </div>` : ''}
                </div>
                
                <div class="flex items-center justify-end space-x-2 pt-3 border-t border-gray-100">
                    <button onclick="sharePresentation(${presentation.id})" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-[#0088CC] bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                        Отправить
                    </button>
                    <button onclick="event.stopPropagation(); showPresentationInDashboard(${presentation.id})" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg hover:from-[#006699] hover:to-[#004466] transition-colors">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Подробнее
                    </button>
                </div>
            </div>`;
    }).join('');
}

function sharePresentation(presentationId) {
    console.log(`🚀 Starting sharePresentation for ID: ${presentationId}`);
    
    fetch(`/api/manager/presentation/${presentationId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({})
    })
    .then(response => {
        console.log(`📡 Response received:`, response);
        console.log(`📊 Response status: ${response.status}`);
        console.log(`📝 Response statusText: ${response.statusText}`);
        console.log(`📋 Response ok: ${response.ok}`);
        console.log(`📄 Response type: ${response.type}`);
        console.log(`🔗 Response url: ${response.url}`);
        
        if (!response.ok) {
            console.error(`❌ Response not ok: ${response.status} ${response.statusText}`);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log(`✅ Response ok, parsing JSON...`);
        return response.json();
    })
    .then(data => {
        console.log(`📦 JSON data received:`, data);
        
        if (data.success) {
            console.log(`✅ Success! Share data:`, data.share_data);
            const shareData = data.share_data;
            
            // Create share modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.setAttribute('data-modal-overlay', 'share');
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between p-5 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900">Отправить презентацию</h3>
                        <button onclick="this.closest('[data-modal-overlay]').remove()" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Ссылка на презентацию</label>
                            <div class="flex">
                                <input type="text" id="presentation-url" value="${shareData.presentation_url}" class="flex-1 px-3 py-2.5 border border-gray-200 rounded-l-xl bg-gray-50 text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent" readonly>
                                <button onclick="copyToClipboard('presentation-url')" class="px-3 py-2.5 bg-[#0088CC] text-white rounded-r-xl hover:bg-[#006699] transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Готовое сообщение</label>
                            <textarea id="message-text" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50 text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent" rows="5" readonly>${shareData.message_text}</textarea>
                        </div>
                        
                        <div class="space-y-2.5">
                            <a href="${shareData.whatsapp_url}" target="_blank" class="flex items-center justify-center px-4 py-2.5 bg-[#25D366] text-white rounded-xl hover:bg-[#1da851] transition-colors text-sm font-medium">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                Отправить в WhatsApp
                            </a>
                            <a href="${shareData.telegram_url}" target="_blank" class="flex items-center justify-center px-4 py-2.5 bg-[#0088CC] text-white rounded-xl hover:bg-[#006699] transition-colors text-sm font-medium">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                                Отправить в Telegram
                            </a>
                            <button onclick="copyToClipboard('message-text')" class="flex items-center justify-center w-full px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors text-sm font-medium">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                Копировать сообщение
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`🎉 Modal added to DOM successfully!`);
        } else {
            console.error(`❌ API returned error:`, data.error);
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Error in sharePresentation:', error);
        console.error('📍 Error name:', error.name);
        console.error('📝 Error message:', error.message);
        console.error('📚 Error stack:', error.stack);
        
        if (error.message.includes('Authentication required') || error.message.includes('401')) {
            showNotification('Ошибка: Необходимо войти в систему заново', 'error');
            setTimeout(() => window.location.href = '/manager/login', 2000);
        } else {
            showNotification(`Ошибка при получении ссылки: ${error.message}`, 'error');
        }
    });
}

// Show client selection modal
async function showClientSelectionModal(presentationId) {
    try {
        // Fetch manager's clients
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        if (!data.success || !data.clients || data.clients.length === 0) {
            showNotification('У вас нет закрепленных клиентов', 'error');
            return;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'client-selection-modal';
        modal.className = 'fixed inset-0 bg-black/50 z-[10010] flex items-end sm:items-center justify-center sm:p-4';
        
        let clientsHTML = '';
        data.clients.forEach(client => {
            const searchText = `${client.full_name} ${client.email} ${client.phone || ''}`.toLowerCase();
            clientsHTML += `
                <div class="client-item border border-gray-200 rounded-lg p-3 sm:p-4 hover:bg-gray-50 cursor-pointer transition-colors" 
                     data-search="${searchText}"
                     onclick="selectClient(${presentationId}, ${client.id}, '${client.full_name}')">
                    <div class="flex items-center justify-between">
                        <div class="min-w-0 flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base truncate">${client.full_name}</h4>
                            <p class="text-xs sm:text-sm text-gray-600 truncate">${client.email}</p>
                            ${client.phone ? `<p class="text-xs sm:text-sm text-gray-500">${client.phone}</p>` : ''}
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 ml-2 flex-shrink-0"></i>
                    </div>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="bg-white w-full sm:max-w-2xl sm:rounded-xl rounded-t-2xl max-h-[90vh] sm:max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
                <div class="sticky top-0 bg-white border-b border-gray-200 p-4 sm:p-6 flex-shrink-0 rounded-t-2xl sm:rounded-t-xl">
                    <div class="flex justify-center sm:hidden mb-2"><div class="w-10 h-1 bg-gray-300 rounded-full"></div></div>
                    <div class="flex items-center justify-between mb-3 sm:mb-4">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900">Выберите клиента</h3>
                        <button id="close-client-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-lg sm:text-xl"></i>
                        </button>
                    </div>
                    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">Выберите клиента для отправки презентации</p>
                    
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" 
                               id="client-search-input" 
                               placeholder="Поиск по имени, email или телефону..." 
                               class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none text-sm">
                    </div>
                    <div id="client-count" class="text-xs sm:text-sm text-gray-500 mt-2">
                        Клиентов: ${data.clients.length}
                    </div>
                </div>
                
                <div id="clients-list" class="p-3 sm:p-6 space-y-2 sm:space-y-3 overflow-y-auto flex-1">
                    ${clientsHTML}
                </div>
                
                <div id="no-results" class="hidden p-6 text-center text-gray-500">
                    <i class="fas fa-search text-3xl sm:text-4xl mb-3 text-gray-300"></i>
                    <p class="text-base sm:text-lg">Клиенты не найдены</p>
                    <p class="text-xs sm:text-sm">Попробуйте изменить поисковый запрос</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add click handlers after modal is in DOM
        document.getElementById('close-client-modal-btn').addEventListener('click', closeClientSelectionModal);
        modal.addEventListener('click', closeClientSelectionModal); // Click on backdrop closes modal
        
        // Add search functionality
        const searchInput = document.getElementById('client-search-input');
        const clientsList = document.getElementById('clients-list');
        const noResults = document.getElementById('no-results');
        const clientCount = document.getElementById('client-count');
        const totalClients = data.clients.length;
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const clientItems = clientsList.querySelectorAll('.client-item');
            let visibleCount = 0;
            
            clientItems.forEach(item => {
                const searchText = item.getAttribute('data-search');
                if (searchText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update count and show/hide no results message
            if (visibleCount === 0) {
                clientsList.classList.add('hidden');
                noResults.classList.remove('hidden');
                clientCount.textContent = 'Клиентов не найдено';
            } else {
                clientsList.classList.remove('hidden');
                noResults.classList.add('hidden');
                clientCount.textContent = `Показано: ${visibleCount} из ${totalClients}`;
            }
        });
        
        // Auto-focus search input
        setTimeout(() => searchInput.focus(), 100);
        
    } catch (error) {
        console.error('Error loading clients:', error);
        showNotification('Ошибка загрузки списка клиентов', 'error');
    }
}

function closeClientSelectionModal() {
    const modal = document.getElementById('client-selection-modal');
    if (modal) {
        modal.remove();
    }
}

async function selectClient(presentationId, clientId, clientName) {
    closeClientSelectionModal();
    
    if (!confirm(`Отправить презентацию клиенту ${clientName}? Клиент получит уведомление в личном кабинете.`)) {
        return;
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        
        // First, assign client to presentation
        const assignResponse = await fetch(`/api/manager/collection/${presentationId}/assign-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ client_id: clientId })
        });
        
        const assignData = await assignResponse.json();
        
        if (!assignData.success) {
            showNotification(assignData.error || 'Ошибка при назначении клиента', 'error');
            return;
        }
        
        // Then send to client dashboard
        const sendResponse = await fetch(`/api/manager/collection/${presentationId}/send-to-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const sendData = await sendResponse.json();
        
        if (sendData.success) {
            showNotification('Презентация успешно отправлена клиенту!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(sendData.error || 'Ошибка при отправке презентации', 'error');
        }
    } catch (error) {
        console.error('Error sending presentation to client:', error);
        showNotification('Ошибка при отправке презентации', 'error');
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    let text = '';
    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        text = element.value;
    } else {
        text = element.textContent;
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Скопировано в буфер обмена', 'success');
        }).catch(() => {
            fallbackCopy(element);
        });
    } else {
        fallbackCopy(element);
    }
}
function fallbackCopy(element) {
    try {
        element.select();
        document.execCommand('copy');
        showNotification('Скопировано в буфер обмена', 'success');
    } catch(e) {
        showNotification('Не удалось скопировать', 'error');
    }
}

function viewPresentation(uniqueUrl) {
    window.open(`/presentation/modern/${uniqueUrl}`, '_blank');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
// Enhanced notification with action button
function showNotificationWithAction(message, type = 'info', actionText = null, actionCallback = null) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 shadow-lg ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    }`;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-center gap-3';
    
    // Icon
    const icon = document.createElement('span');
    icon.className = 'text-2xl';
    icon.textContent = type === 'error' ? '⚠️' : type === 'warning' ? '⏱️' : '✓';
    messageDiv.appendChild(icon);
    
    // Message text
    const textDiv = document.createElement('div');
    textDiv.className = 'flex-1';
    textDiv.textContent = message;
    messageDiv.appendChild(textDiv);
    
    notification.appendChild(messageDiv);
    
    // Add action button if provided
    if (actionText && actionCallback) {
        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'mt-3 flex gap-2';
        
        const actionButton = document.createElement('button');
        actionButton.className = 'px-4 py-2 bg-white text-gray-900 rounded hover:bg-gray-100 font-semibold';
        actionButton.textContent = actionText;
        actionButton.onclick = () => {
            actionCallback();
            notification.remove();
        };
        
        const dismissButton = document.createElement('button');
        dismissButton.className = 'px-4 py-2 bg-transparent border border-white rounded hover:bg-white hover:bg-opacity-20';
        dismissButton.textContent = 'Закрыть';
        dismissButton.onclick = () => notification.remove();
        
        buttonDiv.appendChild(actionButton);
        buttonDiv.appendChild(dismissButton);
        notification.appendChild(buttonDiv);
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 8 seconds if no action
    if (!actionText) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    return notification;
}

// Global authentication error handler
function handleAuthError(response) {
    console.log('🔒 handleAuthError called with status:', response.status);
    
    if (response.status === 401 || response.status === 403) {
        console.log('❌ Authentication failed - showing notification');
        
        // Show notification with login button
        showNotificationWithAction(
            'Ваша сессия истекла. Пожалуйста, войдите снова.',
            'warning',
            'Войти',
            () => {
                window.location.href = '/manager/login';
            }
        );
        
        // Auto-redirect after 5 seconds
        setTimeout(() => {
            window.location.href = '/manager/login';
        }, 5000);
        
        return true; // Error handled
    }
    
    return false; // Not an auth error
}

// Enhanced fetch wrapper with auth error handling
async function fetchWithAuth(url, options = {}) {
    try {
        console.log(`🌐 fetchWithAuth: ${options.method || 'GET'} ${url}`);
        const response = await fetch(url, options);
        
        // Check for auth errors
        if (handleAuthError(response)) {
            throw new Error('Authentication required');
        }
        
        return response;
    } catch (error) {
        console.error('❌ fetchWithAuth error:', error);
        throw error;
    }
}

// Presentation viewer functions
function showPresentationInDashboard(presentationId) {
    console.log('🎯 NEW DEBUG v2.0 - Showing presentation in dashboard:', presentationId);
    
    // Hide list view
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    console.log('🔍 DOM elements check:', {
        listView: listView ? 'found' : 'NOT FOUND',
        viewerView: viewerView ? 'found' : 'NOT FOUND'
    });
    
    if (listView && viewerView) {
        console.log('✅ Both elements found, hiding list and showing viewer');
        listView.style.display = 'none';
        viewerView.classList.remove('hidden');
        
        console.log('📞 About to call loadPresentationContent with ID:', presentationId);
        
        // Check if function exists
        if (typeof loadPresentationContent !== 'function') {
            console.error('❌ loadPresentationContent is not a function!');
            return;
        }
        
        console.log('✅ loadPresentationContent function exists, calling it...');
        
        // Load presentation content
        try {
            loadPresentationContent(presentationId);
            console.log('📞 loadPresentationContent call completed successfully');
        } catch (error) {
            console.error('❌ Error calling loadPresentationContent:', error);
        }
    } else {
        console.error('❌ Required DOM elements not found!');
    }
}

function showPresentationsList() {
    console.log('🔙 Returning to presentations list');
    
    // Show list view, hide viewer
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    if (listView && viewerView) {
        listView.style.display = 'block';
        viewerView.classList.add('hidden');
        
        // Clear viewer content
        const content = document.getElementById('presentation-content');
        if (content) {
            content.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Загрузка презентации...</p></div>';
        }
    }
}

function loadPresentationContent(presentationId) {
    console.log('📥 Loading presentation content:', presentationId);
    
    const contentContainer = document.getElementById('presentation-content');
    const actionsContainer = document.getElementById('presentation-viewer-actions');
    
    if (!contentContainer) {
        console.error('❌ Presentation content container not found');
        return;
    }
    
    // Show loading
    contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Загрузка презентации...</p></div>';
    
    // Fetch presentation data from the new JSON API
    fetch(`/api/manager/presentation/${presentationId}`)
        .then(response => response.json())
        .then(data => {
            console.log('🎯 API response data:', data);
            if (data.success) {
                const presentation = data.presentation;
                console.log('✅ Presentation data:', presentation);
                console.log('🏠 Properties count:', presentation.properties ? presentation.properties.length : 'no properties');
                
                // Generate presentation content in dashboard style
                const generatedHTML = generatePresentationHTML(presentation);
                console.log('🏗️ Generated HTML length:', generatedHTML.length);
                console.log('📝 Generated HTML preview:', generatedHTML.substring(0, 200));
                
                contentContainer.innerHTML = generatedHTML;
        console.log('📋 Content container after update:', contentContainer);
        console.log('📋 Container visible:', contentContainer.style.display);
        console.log('📋 Container HTML length:', contentContainer.innerHTML.length);
        
        // Force visibility
        contentContainer.style.display = 'block';
        contentContainer.style.visibility = 'visible';
        contentContainer.style.opacity = '1';
                
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="sharePresentation('${presentationId}')" class="inline-flex items-center px-2 sm:px-3 py-1.5 sm:py-2 text-[11px] sm:text-xs font-medium text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1 sm:mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                            <span class="hidden sm:inline">Поделиться</span><span class="sm:hidden">Поделиться</span>
                        </button>
                        <button onclick="showClientSelectionModal('${presentationId}')" class="inline-flex items-center px-2 sm:px-3 py-1.5 sm:py-2 text-[11px] sm:text-xs font-medium text-white bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg hover:from-[#006699] hover:to-[#004466] transition-colors">
                            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1 sm:mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                            <span class="hidden sm:inline">Отправить клиенту</span><span class="sm:hidden">Отправить</span>
                        </button>
                        <button onclick="downloadAllPresentation('${presentationId}', '${presentation.title}')" class="inline-flex items-center px-2 sm:px-3 py-1.5 sm:py-2 text-[11px] sm:text-xs font-medium text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1 sm:mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            <span class="hidden sm:inline">Скачать</span><span class="sm:hidden">Скачать</span>
                        </button>
                    `;
                }
                
                console.log('✅ Presentation loaded successfully in dashboard style');
                
            } else {
                contentContainer.innerHTML = `<div class="text-center py-8"><p class="text-red-500">Ошибка: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('❌ Error loading presentation:', error);
            contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Ошибка загрузки презентации</p></div>';
        });
}

// Function to count unique residential complexes in properties
function getUniqueComplexesCount(properties) {
    if (!properties || !Array.isArray(properties)) return 0;
    
    const uniqueComplexes = new Set();
    properties.forEach(property => {
        if (property.residential_complex || property.complex_name) {
            uniqueComplexes.add(property.residential_complex || property.complex_name);
        }
    });
    
    return uniqueComplexes.size;
}

function generatePresentationHTML(presentation) {
    const createdDate = presentation.created_at ? new Date(presentation.created_at).toLocaleDateString('ru-RU') : '';
    let html = `
        <div class="mb-4 sm:mb-6">
            <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-4 sm:p-6">
                <div class="flex items-start justify-between mb-3 sm:mb-4">
                    <div class="min-w-0 flex-1 mr-2">
                        <h1 class="text-lg sm:text-2xl font-bold text-gray-900 break-words">${presentation.title || 'Без названия'}</h1>
                        ${presentation.description ? `<p class="text-xs sm:text-sm text-gray-600 mt-1">${presentation.description}</p>` : ''}
                        ${presentation.client_name ? `<p class="text-xs sm:text-sm text-gray-500 mt-1 flex items-center"><svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1 sm:mr-1.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Для: ${presentation.client_name}</p>` : ''}
                    </div>
                    ${createdDate ? `<span class="text-xs text-gray-400 flex-shrink-0">${createdDate}</span>` : ''}
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3">
                    <div class="bg-white rounded-xl p-2 sm:p-3 text-center shadow-sm">
                        <div class="text-lg sm:text-xl font-bold text-[#0088CC]">${presentation.properties_count || 0}</div>
                        <div class="text-[10px] sm:text-xs text-gray-500 mt-0.5">Объектов</div>
                    </div>
                    <div class="bg-white rounded-xl p-2 sm:p-3 text-center shadow-sm">
                        <div class="text-lg sm:text-xl font-bold text-gray-900">${presentation.view_count || 0}</div>
                        <div class="text-[10px] sm:text-xs text-gray-500 mt-0.5">Просмотров</div>
                    </div>
                    <div class="bg-white rounded-xl p-2 sm:p-3 text-center shadow-sm">
                        <div class="text-lg sm:text-xl font-bold text-gray-900">${getUniqueComplexesCount(presentation.properties || [])}</div>
                        <div class="text-[10px] sm:text-xs text-gray-500 mt-0.5">ЖК</div>
                    </div>
                    <div class="bg-white rounded-xl p-2 sm:p-3 text-center shadow-sm">
                        <div class="text-sm sm:text-xl font-bold text-gray-900">${presentation.status || 'Создана'}</div>
                        <div class="text-[10px] sm:text-xs text-gray-500 mt-0.5">Статус</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (presentation.properties && presentation.properties.length > 0) {
        html += `
            <div>
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900">Объекты недвижимости</h2>
                    <span class="text-xs sm:text-sm text-gray-500">${presentation.properties.length} шт.</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        `;
        presentation.properties.forEach(property => {
            html += generatePropertyCard(property, presentation.id);
        });
        html += `</div></div>`;
    } else {
        html += `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                </div>
                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет объектов</h4>
                <p class="text-sm text-gray-500">В этой презентации пока нет добавленных объектов</p>
            </div>
        `;
    }
    
    return html;
}

function generatePropertyCard(property, presentationId) {
    const formatPrice = (price) => {
        return price ? price.toLocaleString('ru-RU') + ' ₽' : 'Цена не указана';
    };
    const formatArea = (area) => {
        return area ? area + ' м²' : 'Не указана';
    };
    const mainImage = (property.images && property.images.length > 0) ? property.images[0] : (property.main_image || '/static/images/no-photo.jpg');
    
    return `
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all group">
            <div class="relative h-40 sm:h-44">
                <img src="${mainImage}" 
                     alt="${property.title || 'Объект'}"
                     class="w-full h-full object-cover"
                     onerror="this.src='/static/images/no-photo.jpg'">
                <div class="absolute top-2.5 left-2.5 flex gap-1.5">
                    <span class="bg-[#0088CC] text-white px-2 py-0.5 rounded-lg text-[11px] sm:text-xs font-medium">
                        ${property.rooms === 0 ? 'Студия' : (property.rooms ? property.rooms + '-комн.' : '')}
                    </span>
                </div>
                ${property.cashback && property.cashback > 0 ? `
                <div class="absolute top-2.5 right-2.5">
                    <span class="bg-green-500 text-white px-1.5 sm:px-2 py-0.5 rounded-lg text-[11px] sm:text-xs font-medium">
                        ${property.cashback.toLocaleString('ru-RU')} ₽
                    </span>
                </div>` : ''}
            </div>
            <div class="p-3 sm:p-4">
                <h4 class="font-semibold text-gray-900 text-sm mb-1 truncate">${property.complex_name || 'ЖК не указан'}</h4>
                ${property.address ? 
                    `<p class="text-xs text-gray-500 mb-2 sm:mb-3 truncate flex items-center">
                        <svg class="w-3.5 h-3.5 mr-1 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        ${property.address}
                    </p>` : '<div class="mb-2 sm:mb-3"></div>'
                }
                <div class="grid grid-cols-3 gap-1.5 sm:gap-2 mb-2 sm:mb-3">
                    <div class="bg-gray-50 rounded-lg p-1.5 sm:p-2 text-center">
                        <div class="text-[11px] sm:text-sm font-bold text-gray-900 truncate">${formatPrice(property.price)}</div>
                        <div class="text-[10px] sm:text-xs text-gray-400">Цена</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-1.5 sm:p-2 text-center">
                        <div class="text-[11px] sm:text-sm font-bold text-gray-900 truncate">${formatArea(property.area)}</div>
                        <div class="text-[10px] sm:text-xs text-gray-400">Площадь</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-1.5 sm:p-2 text-center">
                        <div class="text-[11px] sm:text-sm font-bold text-gray-900">${property.floor || '—'}/${property.total_floors || '—'}</div>
                        <div class="text-[10px] sm:text-xs text-gray-400">Этаж</div>
                    </div>
                </div>
                ${property.manager_note ? `
                <div class="mb-3 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2 flex items-start gap-2 cursor-pointer" onclick="editPropertyNote('${presentationId}', '${property.id}')">
                    <svg class="w-3.5 h-3.5 text-amber-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                    <p class="text-xs text-amber-800 line-clamp-2">${property.manager_note}</p>
                </div>` : ''}
                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                    <div class="flex items-center space-x-1">
                        <button onclick="viewPropertyDetails('${property.id}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-colors" title="Подробнее">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <button onclick="sharePropertyLink('${presentationId}', '${property.id}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-colors" title="Поделиться">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                        </button>
                        <button onclick="downloadPropertyPDF('${presentationId}', '${property.id}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-colors" title="Скачать PDF">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        </button>
                        <button onclick="editPropertyNote('${presentationId}', '${property.id}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-amber-500 hover:bg-amber-50 rounded-lg transition-colors" title="Комментарий">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        </button>
                    </div>
                    <button onclick="removePropertyFromPresentation('${presentationId}', '${property.property_id}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Удалить">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function viewPropertyDetails(propertyId) {
    // Open property in new tab
    window.open(`/object/${propertyId}`, '_blank');
}

function editPropertyNote(presentationId, propertyId) {
    var existing = '';
    var card = document.querySelector(`[onclick*="editPropertyNote('${presentationId}', '${propertyId}')"]`);
    if (card) {
        var noteEl = card.closest('.bg-white')?.querySelector('.bg-amber-50 p');
        if (noteEl) existing = noteEl.textContent.trim();
    }
    var modal = document.createElement('div');
    modal.id = 'note-edit-modal';
    modal.className = 'fixed inset-0 bg-black/50 z-[10010] flex items-end sm:items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-5 sm:p-6" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">Комментарий к объекту</h3>
                <button onclick="document.getElementById('note-edit-modal').remove()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <textarea id="note-edit-textarea" rows="4" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none resize-none" placeholder="Введите комментарий...">${existing}</textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('note-edit-modal').remove()" class="flex-1 px-4 py-2.5 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-50">Отмена</button>
                <button onclick="submitPropertyNote('${presentationId}', '${propertyId}')" class="flex-1 px-4 py-2.5 bg-[#0088CC] text-white rounded-xl text-sm font-medium hover:bg-[#006699]">Сохранить</button>
            </div>
        </div>
    `;
    modal.addEventListener('click', function() { modal.remove(); });
    document.body.appendChild(modal);
    setTimeout(function() { document.getElementById('note-edit-textarea')?.focus(); }, 100);
}

function submitPropertyNote(presentationId, propertyId) {
    var textarea = document.getElementById('note-edit-textarea');
    if (!textarea) return;
    var note = textarea.value.trim();
    fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manager_note: note })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('note-edit-modal')?.remove();
        if (data.success) {
            showNotification('Комментарий обновлен', 'success');
            loadPresentationContent(presentationId);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        document.getElementById('note-edit-modal')?.remove();
        showNotification('Ошибка при обновлении комментария', 'error');
    });
}

async function removePropertyFromPresentation(presentationId, propertyId) {
    if (!confirm('Удалить объект из презентации?')) return;
    
    const url = `/api/manager/presentation/${presentationId}/property/${propertyId}/delete`;
    try {
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (handleAuthError(response)) return;
        
        const responseText = await response.text();
        
        if (!response.ok) {
            let errMsg = 'Ошибка при удалении';
            try {
                const errData = JSON.parse(responseText);
                errMsg = errData.error || errMsg;
            } catch(e) {}
            showNotification(errMsg, 'error');
            return;
        }
        
        let data = { success: true };
        if (responseText) {
            try { data = JSON.parse(responseText); } catch(e) {}
        }
        
        if (data.success) {
            showNotification('Объект удален из презентации', 'success');
            loadPresentationContent(presentationId);
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    } catch (error) {
        console.error('DELETE request network error:', error);
        showNotification('Ошибка сети при удалении объекта', 'error');
    }
}
function downloadPropertyPDF(presentationId, propertyId) {
    const downloadUrl = `/api/presentation/${presentationId}/property/${propertyId}/download`;
    
    // Create download link
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${propertyId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('PDF скачивается...', 'success');
}

// Print individual property
function printProperty(presentationId, propertyId) {
    const printUrl = `/api/presentation/${presentationId}/property/${propertyId}/print`;
    const printWindow = window.open(printUrl, '_blank', 'width=800,height=600');
    
    if (printWindow) {
        printWindow.focus();
    } else {
        showNotification('Не удалось открыть окно печати', 'error');
    }
}

// Add comment to property
function addPropertyComment(presentationId, propertyId) {
    const comment = prompt('Введите комментарий к объекту:');
    if (comment !== null && comment.trim()) {
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ manager_note: comment.trim() })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Комментарий добавлен', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Ошибка при добавлении комментария', 'error');
        });
    }
}

// Share property link function
function sharePropertyLink(presentationId, propertyId) {
    const propertyUrl = `${window.location.origin}/object/${propertyId}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(propertyUrl).then(() => {
        showNotification('Ссылка на объект скопирована', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = propertyUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Ссылка на объект скопирована', 'success');
    });
}

// Toggle presentation status between Черновик and Опубликовано
function togglePresentationStatus(presentationId, currentStatus) {
    // Определяем новый статус
    const newStatus = currentStatus === 'Черновик' ? 'Опубликовано' : 'Черновик';
    
    // Подтверждение действия
    if (!confirm(`Изменить статус на "${newStatus}"?`)) {
        return;
    }
    
    fetch(`/api/manager/presentation/${presentationId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Статус изменен на "${data.status}"`, 'success');
            // Перезагрузить содержимое презентации
            loadPresentationContent(presentationId);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating presentation status:', error);
        showNotification('Ошибка при изменении статуса', 'error');
    });
}

function downloadAllPresentation(presentationId, title) {
    console.log(`🔥 Starting downloadAllPresentation for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/manager/presentation/${presentationId}/download-all`;
    link.download = `${title || 'Презентация'} - Все материалы.zip`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Скачивание начато...', 'success');
}

function downloadPresentationPdf(presentationId, title) {
    console.log(`🔥 Starting downloadPresentationPdf for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/presentation/pdf/${presentationId}`;
    link.download = `${title || 'Презентация'}.pdf`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Генерация PDF начата...', 'success');
}

function initializePresentationScripts() {
    // Initialize any additional functionality for presentation view
    console.log('✅ Presentation scripts initialized');
}

// ============================================================================
// FAVORITES FUNCTIONALITY FOR MANAGER DASHBOARD
// ============================================================================

// Global favorites data
let managerFavoriteProperties = [];
let managerFavoriteComplexes = [];
let favoritesPropertiesFiltered = [];
let favoritesComplexesFiltered = [];

// Load favorite properties from API
window.loadFavoriteProperties = function() {
    console.log('🔄 Loading favorite properties...');
    
    // Add delay to ensure DOM elements are available
    setTimeout(function() {
        const container = document.getElementById('properties-container');
        const emptyState = document.getElementById('empty-properties');
        const grid = document.getElementById('properties-grid');
        
        console.log('🔍 DOM elements check:', {
            container: container ? 'found' : 'NOT FOUND',
            emptyState: emptyState ? 'found' : 'NOT FOUND', 
            grid: grid ? 'found' : 'NOT FOUND'
        });
        
        // If elements not found, try alternative approach
        if (!container || !emptyState || !grid) {
            console.warn('⚠️ Primary elements not found, trying alternative selectors...');
            
            // Try finding elements within the specific section
            const section = document.getElementById('favorites');
            if (section) {
                const altContainer = section.querySelector('[id*="container"]');
                const altEmptyState = section.querySelector('[id*="empty"]');
                const altGrid = section.querySelector('[id*="grid"]');
                
                console.log('🔍 Alternative elements check:', {
                    section: 'found',
                    altContainer: altContainer ? 'found' : 'NOT FOUND',
                    altEmptyState: altEmptyState ? 'found' : 'NOT FOUND',
                    altGrid: altGrid ? 'found' : 'NOT FOUND'
                });
                
                if (!altContainer || !altEmptyState || !altGrid) {
                    console.error('❌ Could not find favorite properties elements after retries');
                    return;
                }
            } else {
                console.error('❌ Could not find favorite-properties section');
                return;
            }
        }
        
        // Show loading state
        if (container) container.classList.add('manager-favorites-hidden');
        if (emptyState) {
            emptyState.innerHTML = `
                <div class="text-center py-16">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-500">Загрузка избранных объектов...</p>
                </div>
            `;
            emptyState.classList.remove('manager-favorites-hidden');
        }
        
        // Load from API
        console.log('🌐 Calling /api/manager/favorites/list');
        fetch('/api/manager/favorites/list')
            .then(response => response.json())
            .then(data => {
                console.log('📦 API response:', data);
                if (data.success) {
                    managerFavoriteProperties = data.favorites || [];
                    favoritesPropertiesFiltered = [...managerFavoriteProperties];
                    
                    console.log('✅ Loaded', managerFavoriteProperties.length, 'favorite properties');
                    console.log('📊 Sample data:', managerFavoriteProperties.slice(0, 2));
                    
                    displayFavoriteProperties();
                    updateFavoritesCounts();
                    populatePropertiesFilters();
                } else {
                    console.error('❌ API error:', data.error);
                    showEmptyFavoriteProperties('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('💥 Network error:', error);
                showEmptyFavoriteProperties('Ошибка сети при загрузке избранного');
            });
    }, 100); // 100ms delay to ensure DOM is ready
};

// Load favorite complexes from API
window.loadFavoriteComplexes = function() {
    console.log('🔄 Loading favorite complexes...');
    
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    
    if (!container || !emptyState || !grid) {
        console.error('❌ Favorite complexes elements not found');
        return;
    }
    
    // Show loading state
    container.classList.add('manager-favorites-hidden');
    emptyState.innerHTML = `
        <div class="text-center py-16">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-500">Загрузка избранных ЖК...</p>
        </div>
    `;
    emptyState.classList.remove('manager-favorites-hidden');
    
    // Load from API
    fetch('/api/manager/complexes/favorites/list')
        .then(response => response.json())
        .then(data => {
            console.log('📦 Complexes list API payload:', data);
            if (data.success) {
                // ИСПРАВЛЕНИЕ: добавить fallback чтение с диагностикой
                const items = data.complexes || data.favorite_complexes || data.favorites || [];
                console.log('🔍 Fallback reading result:', {
                    'data.complexes': data.complexes?.length || 0,
                    'data.favorite_complexes': data.favorite_complexes?.length || 0, 
                    'data.favorites': data.favorites?.length || 0,
                    'final_items_count': items.length
                });
                
                managerFavoriteComplexes = items;
                favoritesComplexesFiltered = [...managerFavoriteComplexes];
                
                console.log('✅ Loaded', managerFavoriteComplexes.length, 'favorite complexes');
                if (managerFavoriteComplexes.length > 0) {
                    console.log('📊 Sample complex data:', managerFavoriteComplexes[0]);
                }
                
                displayFavoriteComplexes();
                updateFavoritesCounts();
                populateComplexesFilters();
            } else {
                console.error('❌ API error:', data.error);
                showEmptyFavoriteComplexes('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('💥 Network error:', error);
            showEmptyFavoriteComplexes('Ошибка сети при загрузке избранного');
        });
};

// Display favorite properties
function displayFavoriteProperties() {
    console.log('🎯 displayFavoriteProperties called, data length:', favoritesPropertiesFiltered?.length);
    
    // First try direct element lookup
    let container = document.getElementById('properties-container');
    let emptyState = document.getElementById('empty-properties');
    let grid = document.getElementById('properties-grid');
    let totalCount = document.getElementById('favorites-properties-total-count');
    let clearBtn = document.getElementById('clear-all-properties');
    let exportBtn = document.getElementById('export-properties');
    
    console.log('🔍 Display DOM elements check:', {
        container: container ? 'found' : 'NOT FOUND',
        emptyState: emptyState ? 'found' : 'NOT FOUND',
        grid: grid ? 'found' : 'NOT FOUND',
        totalCount: totalCount ? 'found' : 'NOT FOUND'
    });
    
    // If elements not found, try alternative approach
    if (!container || !emptyState || !grid) {
        console.warn('⚠️ Primary display elements not found, trying alternative selectors...');
        
        // Try finding elements within the specific section
        const section = document.getElementById('favorites');
        if (section) {
            if (!container) container = section.querySelector('[id*="container"]');
            if (!emptyState) emptyState = section.querySelector('[id*="empty"]');
            if (!grid) grid = section.querySelector('[id*="grid"]');
            if (!totalCount) totalCount = section.querySelector('[id*="total-count"]');
            if (!clearBtn) clearBtn = section.querySelector('[id*="clear-all"]');
            if (!exportBtn) exportBtn = section.querySelector('[id*="export"]');
            
            console.log('🔍 Alternative display elements check:', {
                section: 'found',
                container: container ? 'found' : 'NOT FOUND',
                emptyState: emptyState ? 'found' : 'NOT FOUND',
                grid: grid ? 'found' : 'NOT FOUND'
            });
        }
        
        if (!container || !emptyState || !grid) {
            console.error('❌ Required display elements still not found after retries!');
            return;
        }
    }
    
    if (favoritesPropertiesFiltered.length === 0) {
        console.log('📭 No properties to display, showing empty state');
        showEmptyFavoriteProperties();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) {
        totalCount.textContent = favoritesPropertiesFiltered.length;
        console.log('📊 Updated total count to:', favoritesPropertiesFiltered.length);
    }
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    console.log('👀 Showing container and hiding empty state');
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // 🔧 FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('🔧 Forced container visibility with style.display = block');
    
    // Generate property cards
    const cardsHTML = favoritesPropertiesFiltered.map(property => createPropertyCard(property)).join('');
    console.log('🏗️ Generated HTML length:', cardsHTML.length);
    console.log('📝 Sample HTML (first 200 chars):', cardsHTML.substring(0, 200));
    
    grid.innerHTML = cardsHTML;
    
    
    console.log('✅ Displayed', favoritesPropertiesFiltered.length, 'properties');
    console.log('🧮 Grid children count:', grid.children.length);
}

// Display favorite complexes
function displayFavoriteComplexes() {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (favoritesComplexesFiltered.length === 0) {
        showEmptyFavoriteComplexes();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) totalCount.textContent = favoritesComplexesFiltered.length;
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // 🔧 FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('🔧 Forced complexes container visibility with style.display = block');
    
    // Generate complex cards
    grid.innerHTML = favoritesComplexesFiltered.map(complex => createComplexCard(complex)).join('');
    
    console.log('✅ Displayed', favoritesComplexesFiltered.length, 'complexes');
}

function createPropertyCard(property) {
    const propertyId = property.id || property.property_id;
    const price = property.price || property.property_price || 0;
    const title = property.title || property.property_name || 'Объект';
    const district = property.district || property.property_district || '';
    const complex = property.complex || property.property_complex || '';
    const cashback = property.cashback_amount || Math.floor(price * 0.05);
    const imageUrl = property.image || property.property_image_url || '/static/images/placeholder-property.jpg';
    const notes = property.notes || property.recommended_for || '';
    
    const areaMatch = title.match(/(\d+(?:\.\d+)?)\s*м²/);
    const area = areaMatch ? parseFloat(areaMatch[1]) : 0;
    const pricePerSqm = area > 0 ? Math.floor(price / area) : 0;
    
    return `
        <a href="/object/${propertyId}" class="block bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg hover:border-[#0088CC]/30 transition-all property-favorite-card group" data-property-id="${propertyId}">
            <div class="relative h-44">
                <img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='/static/images/placeholder-property.jpg'">
                ${cashback > 0 ? `<div class="absolute top-2.5 left-2.5"><span class="bg-green-500 text-white px-2 py-0.5 rounded-lg text-xs font-medium">${cashback.toLocaleString('ru-RU')} ₽</span></div>` : ''}
                <button onclick="event.preventDefault(); event.stopPropagation(); removeFromFavorites(${propertyId})" class="absolute top-2.5 right-2.5 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-red-500 hover:bg-red-50 transition-colors" title="Удалить из избранного">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                </button>
            </div>
            <div class="p-4">
                <h4 class="font-semibold text-gray-900 text-sm mb-1 truncate group-hover:text-[#0088CC] transition-colors">${title}</h4>
                ${(district || complex) ? `<p class="text-xs text-gray-500 mb-3 line-clamp-2 flex items-start" title="${district}${complex ? ', ' + complex : ''}">
                    <svg class="w-3.5 h-3.5 mr-1 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>${district}${complex ? ', ' + complex : ''}</span>
                </p>` : '<div class="mb-3"></div>'}
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-gray-50 rounded-lg p-2 text-center">
                        <div class="text-sm font-bold text-gray-900">${price.toLocaleString('ru-RU')} ₽</div>
                        <div class="text-xs text-gray-400">Цена</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 text-center">
                        <div class="text-sm font-bold text-gray-900">${area > 0 ? area + ' м²' : '—'}</div>
                        <div class="text-xs text-gray-400">${pricePerSqm > 0 ? pricePerSqm.toLocaleString('ru-RU') + ' ₽/м²' : 'Площадь'}</div>
                    </div>
                </div>
                ${notes ? `<div class="mb-3 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2"><p class="text-xs text-amber-800 line-clamp-2">${notes}</p></div>` : ''}
                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                    <div class="flex items-center space-x-1">
                        <span class="w-7 h-7 flex items-center justify-center text-gray-400 group-hover:text-[#0088CC] rounded-lg transition-colors" title="Подробнее">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </span>
                        <button onclick="event.preventDefault(); event.stopPropagation(); addToPresentation(${propertyId})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="В презентацию">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                    <button onclick="event.preventDefault(); event.stopPropagation(); removeFromFavorites(${propertyId})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Удалить">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            </div>
        </a>
    `;
}

function createComplexCard(complex) {
    const complexId = complex.id || complex.complex_id;
    const complexName = complex.name || complex.complex_name || 'ЖК';
    const imageUrl = complex.image || complex.complex_image_url || '/static/images/placeholder-complex.jpg';
    const address = complex.address || complex.complex_district || '';
    const developer = complex.developer || complex.complex_developer || '';
    const status = complex.status || complex.complex_status || '';
    const minPrice = complex.min_price || complex.complex_price_from || 0;
    const priceFrom = minPrice ? formatPrice(minPrice) : '';
    const apartmentsCount = complex.apartments_count || complex.complex_properties_count || 0;
    const complexUrl = complex.url || '';
    const notes = complex.notes || complex.manager_note || '';
    
    const statusColors = {
        'строится': 'bg-yellow-100 text-yellow-800',
        'сдан': 'bg-green-100 text-green-800',
        'проект': 'bg-blue-100 text-blue-800'
    };
    const statusColor = statusColors[status.toLowerCase()] || 'bg-gray-100 text-gray-800';
    
    const cardUrl = complexUrl || '/complexes';
    
    return `
        <a href="${cardUrl}" class="block bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg hover:border-[#0088CC]/30 transition-all complex-favorite-card group" data-complex-id="${complexId}">
            <div class="relative h-44">
                <img src="${imageUrl}" alt="${complexName}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='/static/images/placeholder-complex.jpg'">
                ${status ? `<div class="absolute top-2.5 left-2.5"><span class="${statusColor} px-2 py-0.5 rounded-lg text-xs font-medium">${status}</span></div>` : ''}
                <button onclick="event.preventDefault(); event.stopPropagation(); removeFavoriteComplex('${complexId}')" class="absolute top-2.5 right-2.5 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-red-500 hover:bg-red-50 transition-colors" title="Удалить из избранного">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                </button>
            </div>
            <div class="p-4">
                <h4 class="font-semibold text-gray-900 text-sm mb-1 truncate group-hover:text-[#0088CC] transition-colors">${complexName}</h4>
                ${address ? `<p class="text-xs text-gray-500 mb-3 line-clamp-2 flex items-start" title="${address}">
                    <svg class="w-3.5 h-3.5 mr-1 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>${address}</span>
                </p>` : '<div class="mb-3"></div>'}
                <div class="grid grid-cols-2 gap-2 mb-3">
                    ${priceFrom ? `<div class="bg-gray-50 rounded-lg p-2 text-center"><div class="text-sm font-bold text-gray-900">от ${priceFrom}</div><div class="text-xs text-gray-400">Цена</div></div>` : ''}
                    ${developer ? `<div class="bg-gray-50 rounded-lg p-2 text-center"><div class="text-sm font-bold text-gray-900 truncate" title="${developer}">${developer}</div><div class="text-xs text-gray-400">Застройщик</div></div>` : ''}
                    ${apartmentsCount ? `<div class="bg-gray-50 rounded-lg p-2 text-center"><div class="text-sm font-bold text-gray-900">${apartmentsCount}</div><div class="text-xs text-gray-400">Квартир</div></div>` : ''}
                </div>
                ${notes ? `<div class="mb-3 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2"><p class="text-xs text-amber-800 line-clamp-2">${notes}</p></div>` : ''}
                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                    <div class="flex items-center space-x-1">
                        <span class="w-7 h-7 flex items-center justify-center text-gray-400 group-hover:text-[#0088CC] rounded-lg transition-colors" title="Подробнее">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </span>
                        <button onclick="event.preventDefault(); event.stopPropagation(); searchComplexProperties('${complexId}', '${complexName.replace(/'/g, "\\'")}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-colors" title="Квартиры в ЖК">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </button>
                    </div>
                    <button onclick="event.preventDefault(); event.stopPropagation(); removeFavoriteComplex('${complexId}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Удалить">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            </div>
        </a>
    `;
}

// Show empty state for properties
function showEmptyFavoriteProperties(message = null) {
    const container = document.getElementById('properties-container');
    const emptyState = document.getElementById('empty-properties');
    const totalCount = document.getElementById('favorites-properties-total-count');
    const clearBtn = document.getElementById('clear-all-properties');
    const exportBtn = document.getElementById('export-properties');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (emptyState) {
        if (message) {
            emptyState.innerHTML = `
                <div class="text-center py-16">
                    <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-600 text-lg font-medium">${message}</p>
                </div>
            `;
        } else {
            emptyState.innerHTML = `
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                </div>
                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет избранных объектов</h4>
                <p class="text-sm text-gray-500 mb-4">Добавьте квартиры в избранное для быстрого доступа</p>
                <button onclick="window.location.href='/properties'" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Найти квартиру
                </button>
            `;
        }
        emptyState.classList.remove('manager-favorites-hidden');
    }
}

// Show empty state for complexes
function showEmptyFavoriteComplexes(message = null) {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-complexes');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (emptyState) {
        if (message) {
            emptyState.innerHTML = `
                <div class="text-center py-16">
                    <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-600 text-lg font-medium">${message}</p>
                </div>
            `;
        } else {
            emptyState.innerHTML = `
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
                <h4 class="text-sm font-medium text-gray-900 mb-1">Нет избранных ЖК</h4>
                <p class="text-sm text-gray-500 mb-4">Добавьте жилые комплексы в избранное для отслеживания</p>
                <button onclick="window.location.href='/complexes'" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Посмотреть ЖК
                </button>
            `;
        }
        emptyState.classList.remove('manager-favorites-hidden');
    }
}

// Update favorites counts in navigation
function updateFavoritesCounts() {
    console.log('🔢 updateFavoritesCounts called');
    
    const propertiesNavCount = document.getElementById('favorites-properties-count');
    const complexesNavCount = document.getElementById('favorites-complexes-count');
    
    console.log('🔍 Count elements check:', {
        propertiesNavCount: propertiesNavCount ? 'found' : 'NOT FOUND',
        complexesNavCount: complexesNavCount ? 'found' : 'NOT FOUND'
    });
    
    // Update local counts first
    const propertiesCount = managerFavoriteProperties?.length || 0;
    const complexesCount = managerFavoriteComplexes?.length || 0;
    
    console.log('📊 Local counts - properties:', propertiesCount, 'complexes:', complexesCount);
    
    if (propertiesNavCount) {
        propertiesNavCount.textContent = propertiesCount;
        console.log('✅ Updated properties nav count to:', propertiesCount);
    }
    if (complexesNavCount) {
        complexesNavCount.textContent = complexesCount;
        console.log('✅ Updated complexes nav count to:', complexesCount);
    }
    
    // Also make API call to ensure sync
    console.log('🌐 Making API call to /api/manager/favorites/count for sync');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            console.log('📦 Count API response:', data);
            if (data.success) {
                if (propertiesNavCount) propertiesNavCount.textContent = data.properties_count;
                if (complexesNavCount) complexesNavCount.textContent = data.complexes_count;
                
                const totalFavoritesCount = document.getElementById('favorites-total-count');
                if (totalFavoritesCount && data.total_count !== undefined) totalFavoritesCount.textContent = data.total_count;
                
                const propsBadge = document.getElementById('favorites-props-badge');
                if (propsBadge) propsBadge.textContent = data.properties_count || 0;
                const cxBadge = document.getElementById('favorites-cx-badge');
                if (cxBadge) cxBadge.textContent = data.complexes_count || 0;
                
                const newPropsCount = document.getElementById('new-properties-count');
                if (newPropsCount) newPropsCount.textContent = data.properties_count || 0;
                const newCxCount = document.getElementById('new-complexes-count');
                if (newCxCount) newCxCount.textContent = data.complexes_count || 0;
            }
        })
        .catch(error => {
            console.error('Error fetching favorites count:', error);
        });
    
    // Also update comparison count
    console.log('🌐 Making API call to /api/manager/comparison/count for comparison sync');
    fetch('/api/manager/comparison/count')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Comparison API response:', data);
            if (data.success) {
                const comparisonCount = document.getElementById('comparison-count');
                if (comparisonCount && data.total_count !== undefined) {
                    comparisonCount.textContent = data.total_count;
                    console.log('🔄 Synced comparison count to:', data.total_count);
                }
                const comparisonStat = document.getElementById('comparison-stat-count');
                if (comparisonStat && data.total_count !== undefined) {
                    comparisonStat.textContent = data.total_count;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching comparison count:', error);
        });
    
    // Also update deals count
    console.log('🌐 Making API call to /api/manager/deals for deals count sync');
    fetch('/api/manager/deals')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Deals API response:', data);
            if (data.success && data.total !== undefined) {
                const dealsCount = document.getElementById('deals-count');
                if (dealsCount) {
                    dealsCount.textContent = data.total;
                    console.log('🔄 Synced deals count to:', data.total);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching deals count:', error);
        });
    
    // Also update saved searches count
    console.log('🌐 Making API call to /api/manager/saved-searches for saved searches count sync');
    fetch('/api/manager/saved-searches')
        .then(response => {
            if (!response.ok) {
                console.error('❌ Saved searches API error - Status:', response.status);
                return response.text().then(text => {
                    console.error('❌ Response text:', text.substring(0, 200));
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Saved searches API response:', data);
            if (data.success) {
                const savedSearchesCount = document.getElementById('saved-searches-count');
                if (savedSearchesCount) {
                    // Use count field from API, fallback to searches.length
                    const count = data.count !== undefined ? data.count : (data.searches ? data.searches.length : 0);
                    savedSearchesCount.textContent = count;
                    // Show the counter if there are saved searches
                    if (count > 0) {
                        savedSearchesCount.style.display = 'inline-flex';
                    } else {
                        savedSearchesCount.style.display = 'none';
                    }
                    console.log('🔄 Synced saved searches count to:', count);
                }
            }
        })
        .catch(error => {
            console.error('❌ Error fetching saved searches count:', error);
        });
}

// Initialize favorites counts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial counts
    updateFavoritesCounts();
    
    // DISABLED - conflicts with presentation viewer 
    // setInterval(updateFavoritesCounts, 30000);
});

// Remove favorite property
window.removeFavoriteProperty = function(propertyId) {
    if (!confirm('Удалить этот объект из избранного?')) {
        return;
    }
    
    fetch(`/api/manager/favorites/${propertyId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Объект удален из избранного', 'success');
            loadFavoriteProperties();
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite:', error);
        showNotification('Ошибка при удалении из избранного', 'error');
    });
};

// Remove favorite complex
window.removeFavoriteComplex = function(complexId) {
    if (!confirm('Удалить этот ЖК из избранного?')) {
        return;
    }
    
    fetch(`/api/manager/complexes/favorites/${complexId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('ЖК удален из избранного', 'success');
            loadFavoriteComplexes();
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite complex:', error);
        showNotification('Ошибка при удалении из избранного', 'error');
    });
};

window.removeFromFavorites = function(propertyId) {
    window.removeFavoriteProperty(propertyId);
};

window.addToPresentation = function(propertyId) {
    const modal = document.getElementById('modal-overlay');
    if (modal) {
        modal.classList.remove('hidden');
        modal.setAttribute('data-modal', 'create-presentation');
        modal.setAttribute('data-property-id', propertyId);
        const titleInput = document.getElementById('presentation-title');
        if (titleInput) titleInput.value = '';
        const descInput = document.getElementById('presentation-description');
        if (descInput) descInput.value = '';
    } else {
        showNotification('Для добавления в презентацию перейдите в раздел Презентации', 'info');
    }
};

// Clear all favorite properties
window.clearAllFavoriteProperties = function() {
    if (!confirm('Вы уверены, что хотите удалить все избранные объекты? Это действие нельзя отменить.')) {
        return;
    }
    
    // Remove all properties one by one
    const promises = managerFavoriteProperties.map(property => 
        fetch(`/api/manager/favorites/${property.property_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('Все объекты удалены из избранного', 'success');
                loadFavoriteProperties();
            } else {
                showNotification(`Удалено, но ${failedCount} объектов не удалось удалить`, 'warning');
                loadFavoriteProperties();
            }
        })
        .catch(error => {
            console.error('Error clearing favorites:', error);
            showNotification('Ошибка при очистке избранного', 'error');
        });
};

// Clear all favorite complexes
window.clearAllFavoriteComplexes = function() {
    if (!confirm('Вы уверены, что хотите удалить все избранные ЖК? Это действие нельзя отменить.')) {
        return;
    }
    
    // Remove all complexes one by one
    const promises = managerFavoriteComplexes.map(complex => 
        fetch(`/api/manager/complexes/favorites/${complex.complex_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('Все ЖК удалены из избранного', 'success');
                loadFavoriteComplexes();
            } else {
                showNotification(`Удалено, но ${failedCount} ЖК не удалось удалить`, 'warning');
                loadFavoriteComplexes();
            }
        })
        .catch(error => {
            console.error('Error clearing favorite complexes:', error);
            showNotification('Ошибка при очистке избранного', 'error');
        });
};

// Filtering and sorting functions
window.filterFavoriteProperties = function() {
    const roomsFilter = document.getElementById('filter-favorite-rooms')?.value || '';
    const districtFilter = document.getElementById('filter-favorite-district')?.value || '';
    const priceFilter = document.getElementById('filter-favorite-price')?.value || '';
    
    favoritesPropertiesFiltered = managerFavoriteProperties.filter(property => {
        // Rooms filter
        if (roomsFilter && property.property_rooms && !property.property_rooms.toLowerCase().includes(roomsFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && property.property_district && !property.property_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Price filter
        if (priceFilter && property.property_price) {
            const maxPrice = parseInt(priceFilter);
            if (property.property_price > maxPrice) {
                return false;
            }
        }
        
        return true;
    });
    
    displayFavoriteProperties();
};

window.filterFavoriteComplexes = function() {
    const statusFilter = document.getElementById('filter-complex-status')?.value || '';
    const districtFilter = document.getElementById('filter-complex-district')?.value || '';
    const developerFilter = document.getElementById('filter-complex-developer')?.value || '';
    
    favoritesComplexesFiltered = managerFavoriteComplexes.filter(complex => {
        // Status filter
        if (statusFilter && complex.complex_status && !complex.complex_status.toLowerCase().includes(statusFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && complex.complex_district && !complex.complex_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developerFilter && complex.complex_developer && !complex.complex_developer.toLowerCase().includes(developerFilter.toLowerCase())) {
            return false;
        }
        
        return true;
    });
    
    displayFavoriteComplexes();
};

window.sortFavoriteProperties = function() {
    const sortBy = document.getElementById('sort-favorite-properties')?.value || 'date_desc';
    
    favoritesPropertiesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'price_asc':
                return (a.property_price || 0) - (b.property_price || 0);
            case 'price_desc':
                return (b.property_price || 0) - (a.property_price || 0);
            case 'area_asc':
                return (a.property_area || 0) - (b.property_area || 0);
            case 'area_desc':
                return (b.property_area || 0) - (a.property_area || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteProperties();
};

window.sortFavoriteComplexes = function() {
    const sortBy = document.getElementById('sort-favorite-complexes')?.value || 'date_desc';
    
    favoritesComplexesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'name_asc':
                return (a.complex_name || '').localeCompare(b.complex_name || '');
            case 'price_asc':
                return (a.complex_price_from || 0) - (b.complex_price_from || 0);
            case 'price_desc':
                return (b.complex_price_from || 0) - (a.complex_price_from || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteComplexes();
};

// Populate filter dropdowns
function populatePropertiesFilters() {
    const districtFilter = document.getElementById('filter-favorite-district');
    
    if (districtFilter && managerFavoriteProperties.length > 0) {
        const districts = [...new Set(managerFavoriteProperties
            .map(p => p.property_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">Все районы</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
}

function populateComplexesFilters() {
    const districtFilter = document.getElementById('filter-complex-district');
    const developerFilter = document.getElementById('filter-complex-developer');
    
    if (districtFilter && managerFavoriteComplexes.length > 0) {
        const districts = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">Все районы</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
    
    if (developerFilter && managerFavoriteComplexes.length > 0) {
        const developers = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_developer)
            .filter(d => d))];
        
        developerFilter.innerHTML = '<option value="">Все застройщики</option>' +
            developers.map(developer => `<option value="${developer}">${developer}</option>`).join('');
    }
}

// Action functions
window.viewPropertyDetails = function(propertyId) {
    window.open(`/object/${propertyId}`, '_blank');
};

window.viewComplexDetails = function(complexId) {
    window.open(`/complex/${complexId}`, '_blank');
};

window.addToCollection = function(propertyId) {
    // Show collection selection modal or redirect to create collection with pre-selected property
    showSection('create-collection');
    // TODO: Pre-select the property in collection creation form
    showNotification('Перейдите к созданию подборки и добавьте этот объект', 'info');
};

window.searchComplexProperties = function(complexId, complexName) {
    if (complexName) {
        window.open(`/properties?residential_complex=${encodeURIComponent(complexName)}`, '_blank');
    } else {
        window.open(`/properties?complex=${complexId}`, '_blank');
    }
};

// Export functions
window.exportFavoriteProperties = function() {
    if (managerFavoriteProperties.length === 0) {
        showNotification('Нет объектов для экспорта', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['Название', 'Цена', 'Площадь', 'Комнаты', 'Район', 'ЖК', 'Застройщик', 'Дата добавления'];
    const rows = managerFavoriteProperties.map(property => [
        property.property_name || '',
        property.property_price || '',
        property.property_area || '',
        property.property_rooms || '',
        property.property_district || '',
        property.property_complex || '',
        property.property_developer || '',
        property.added_at ? new Date(property.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-properties-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('Экспорт избранных объектов начат', 'success');
};

window.exportFavoriteComplexes = function() {
    if (managerFavoriteComplexes.length === 0) {
        showNotification('Нет ЖК для экспорта', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['Название', 'Цена от', 'Район', 'Застройщик', 'Статус', 'Дата добавления'];
    const rows = managerFavoriteComplexes.map(complex => [
        complex.complex_name || '',
        complex.complex_price_from || '',
        complex.complex_district || '',
        complex.complex_developer || '',
        complex.complex_status || '',
        complex.added_at ? new Date(complex.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-complexes-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('Экспорт избранных ЖК начат', 'success');
};

// ================================================
// NEW WORKING FAVORITES SECTIONS with Flexbox
// ================================================

// Load new favorite properties with simple layout
window.loadNewFavoriteProperties = async function() {
    console.log('🆕 Loading NEW favorite properties with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('❌ Failed to load favorites:', data);
            return;
        }
        
        const properties = data.favorites || [];
        console.log(`📊 Loaded ${properties.length} properties for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-properties-count');
        if (countEl) countEl.textContent = properties.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-properties-total');
        if (totalEl) totalEl.textContent = properties.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-properties');
        const container = document.getElementById('new-properties-container');
        const list = document.getElementById('new-properties-list');
        
        if (properties.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = properties.map(property => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${property.image || '/static/images/no-photo.jpg'}" 
                         alt="${property.title}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-sm">
                        ₽${Number(property.cashback_amount || 0).toLocaleString('ru-RU')}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${property.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${property.complex}</p>
                <p class="text-lg font-bold text-blue-600">₽${Number(property.price || 0).toLocaleString('ru-RU')}</p>
                <div class="mt-3 text-xs text-gray-500">
                    Добавлено: ${property.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`✅ NEW section displayed ${properties.length} properties successfully`);
        
    } catch (error) {
        console.error('❌ Error loading NEW favorite properties:', error);
    }
};

// Load new favorite complexes with simple layout
window.loadNewFavoriteComplexes = async function() {
    console.log('🆕 Loading NEW favorite complexes with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/complexes/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('❌ Failed to load favorite complexes:', data);
            return;
        }
        
        const complexes = data.favorites || [];
        console.log(`📊 Loaded ${complexes.length} complexes for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-complexes-count');
        if (countEl) countEl.textContent = complexes.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-complexes-total');
        if (totalEl) totalEl.textContent = complexes.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-complexes');
        const container = document.getElementById('new-complexes-container');
        const list = document.getElementById('new-complexes-list');
        
        if (complexes.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = complexes.map(complex => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${complex.image || '/static/images/no-photo.jpg'}" 
                         alt="${complex.name}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-blue-500 text-white px-2 py-1 rounded text-sm">
                        ${complex.status || 'ЖК'}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">${complex.name}</h3>
                <p class="text-sm text-gray-600 mb-1">${complex.developer}</p>
                <p class="text-sm text-gray-600 mb-2">${complex.district}</p>
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        ${complex.min_price ? `от ₽${Number(complex.min_price).toLocaleString('ru-RU')}` : 'Цена не указана'}
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    Добавлено: ${complex.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`✅ NEW section displayed ${complexes.length} complexes successfully`);
        
    } catch (error) {
        console.error('❌ Error loading NEW favorite complexes:', error);
    }
};

// Export functions for new sections
window.exportNewFavoriteProperties = function() {
    console.log('📋 Exporting from NEW properties section...');
    showNotification('Экспорт из новой секции объектов', 'info');
};

window.exportNewFavoriteComplexes = function() {
    console.log('📋 Exporting from NEW complexes section...');
    showNotification('Экспорт из новой секции ЖК', 'info');
};

// Load dashboard counts on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ Dashboard initialization started');
    
    // 🎯 AUTO-SHOW FAVORITES: Show favorite-properties section by default if user has favorites
    // DISABLED AUTO-SWITCH TO FAVORITES - it conflicts with presentation viewer
    // setTimeout(() => {
    //     fetch('/api/manager/favorites/count')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success && data.properties_count > 0) {
    //                 console.log(`🎯 Auto-showing favorites section (${data.properties_count} properties found)`);
    //                 showSection('favorites');
    //             }
    //         })
    //         .catch(error => console.log('No auto-show for favorites:', error));
    // }, 1000);
    
    // 🔄 Load dashboard card counts
    console.log('🔢 Loading dashboard card counts...');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update dashboard card counts
                const newPropCount = document.getElementById('new-properties-count');
                const newComplexCount = document.getElementById('new-complexes-count');
                
                if (newPropCount) {
                    newPropCount.textContent = data.properties_count || 0;
                    console.log(`📋 Updated properties card: ${data.properties_count || 0}`);
                }
                if (newComplexCount) {
                    newComplexCount.textContent = data.complexes_count || 0;
                    console.log(`📋 Updated complexes card: ${data.complexes_count || 0}`);
                }
                
                // Update horizontal tab counts
                const tabPropCount = document.getElementById('favorites-properties-count');
                const tabComplexCount = document.getElementById('favorites-complexes-count');
                
                if (tabPropCount) {
                    tabPropCount.textContent = data.properties_count || 0;
                    console.log(`🔗 Updated horizontal properties tab: ${data.properties_count || 0}`);
                }
                if (tabComplexCount) {
                    tabComplexCount.textContent = data.complexes_count || 0;
                    console.log(`🔗 Updated horizontal complexes tab: ${data.complexes_count || 0}`);
                }
                
                console.log(`✅ Dashboard cards updated successfully!`);
            }
        })
        .catch(error => console.error('❌ Error loading dashboard counts:', error));
});

// Utility functions
function formatPrice(price) {
    if (!price) return '';
    
    const numPrice = parseInt(price);
    if (numPrice >= 1000000) {
        return (numPrice / 1000000).toFixed(1) + ' млн ₽';
    } else if (numPrice >= 1000) {
        return (numPrice / 1000).toFixed(0) + ' тыс ₽';
    } else {
        return numPrice.toLocaleString('ru-RU') + ' ₽';
    }
}

// Устанавливаем флаг менеджера для системы сравнения
sessionStorage.setItem('is_manager', 'true');
console.log('🔑 Manager session flag set: true');

console.log('✅ Manager Favorites functionality initialized');

// ===== DEALS MANAGEMENT FUNCTIONS =====
// Deal Management Functions for Dashboard
async function openCreateDealModal() {
    // Load clients dynamically before showing modal
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        if (data.success && data.clients) {
            const clientSelect = document.getElementById('client_id');
            // Clear existing options except the first one
            clientSelect.innerHTML = '<option value="">Выберите клиента</option>';
            
            // Add clients from API
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;  // Use client.id, not index!
                option.textContent = client.full_name || client.email;
                clientSelect.appendChild(option);
            });
            
            console.log(`✅ Loaded ${data.clients.length} clients into select`);
        }
    } catch (error) {
        console.error('❌ Error loading clients:', error);
    }
    
    document.getElementById('createDealModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeCreateDealModal() {
    document.getElementById('createDealModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    document.getElementById('createDealForm').reset();
}

function openEditStatusModal(dealId, currentStatus) {
    document.getElementById('edit-deal-id').value = dealId;
    document.getElementById('edit-status').value = currentStatus;
    document.getElementById('editStatusModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeEditStatusModal() {
    document.getElementById('editStatusModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    document.getElementById('editStatusForm').reset();
}

// Complete Deal Modal Functions
async function openCompleteDealModal(dealId, statusNotes) {
    console.log('🎯 Opening complete deal modal for deal:', dealId);
    
    // Fetch deal details to pre-fill the form
    try {
        const response = await fetch(`/api/deals/${dealId}`);
        const data = await response.json();
        
        if (data.success && data.deal) {
            const deal = data.deal;
            console.log('✅ Deal loaded for completion:', deal);
            
            // Populate form fields
            document.getElementById('complete-deal-id').value = dealId;
            document.getElementById('complete-deal-number').textContent = deal.deal_number;
            document.getElementById('complete-property-price').value = deal.property_price || '';
            document.getElementById('complete-cashback-amount').value = deal.cashback_amount || '';
            document.getElementById('complete-contract-date').value = deal.contract_date || '';
            document.getElementById('complete-completion-date').value = new Date().toISOString().split('T')[0]; // Today's date
            document.getElementById('complete-notes').value = statusNotes || deal.notes || '';
            
            // Format numbers with spaces
            formatPriceInput(document.getElementById('complete-property-price'));
            formatPriceInput(document.getElementById('complete-cashback-amount'));
            
            // Show modal
            document.getElementById('completeDealModal').classList.remove('hidden');
            if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
        } else {
            console.error('❌ Failed to load deal details:', data.error);
            alert('Ошибка при загрузке данных сделки');
        }
    } catch (error) {
        console.error('❌ Error loading deal for completion:', error);
        alert('Ошибка при загрузке данных сделки');
    }
}

function closeCompleteDealModal() {
    document.getElementById('completeDealModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    document.getElementById('completeDealForm').reset();
}

function formatPriceInput(input) {
    if (!input || !input.value) return;
    
    // Remove all non-digit characters
    let value = input.value.replace(/\D/g, '');
    
    // Format with spaces (Russian number format)
    if (value) {
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    input.value = value;
}

function completeDeal() {
    const dealId = document.getElementById('complete-deal-id').value;
    const propertyPrice = document.getElementById('complete-property-price').value.replace(/\s/g, '');
    const cashbackAmount = document.getElementById('complete-cashback-amount').value.replace(/\s/g, '');
    const contractDate = document.getElementById('complete-contract-date').value;
    const completionDate = document.getElementById('complete-completion-date').value;
    const notes = document.getElementById('complete-notes').value;
    const csrfToken = document.querySelector('[name="csrf_token"]').value;
    
    console.log('💰 Completing deal:', { dealId, propertyPrice, cashbackAmount, contractDate, completionDate, notes });
    
    // Validation
    if (!propertyPrice || parseFloat(propertyPrice) <= 0) {
        alert('Укажите корректную стоимость объекта');
        return;
    }
    
    if (!cashbackAmount || parseFloat(cashbackAmount) < 0) {
        alert('Укажите корректную сумму кешбека');
        return;
    }
    
    if (parseFloat(cashbackAmount) > parseFloat(propertyPrice)) {
        alert('Сумма кешбека не может превышать стоимость объекта');
        return;
    }
    
    if (!contractDate) {
        alert('Укажите дату договора');
        return;
    }
    
    if (!completionDate) {
        alert('Укажите дату завершения');
        return;
    }
    
    const completeBtn = document.getElementById('completeDealBtn');
    completeBtn.disabled = true;
    completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Завершение...';
    
    fetch(`/api/deals/${dealId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            status: 'successful',
            property_price: parseFloat(propertyPrice),
            cashback_amount: parseFloat(cashbackAmount),
            contract_date: contractDate,
            completion_date: completionDate,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('✅ Deal completion response:', data);
        
        if (data.success) {
            closeCompleteDealModal();
            // Reload deals data
            if (typeof loadStaticDealsData === 'function') {
                loadStaticDealsData();
            }
            // Show success message
            showSuccessMessage('Сделка успешно завершена! Кешбек начислен клиенту.');
        } else {
            console.error('❌ Failed to complete deal:', data.error);
            alert('Ошибка: ' + (data.error || 'Не удалось завершить сделку'));
        }
    })
    .catch(error => {
        console.error('❌ Error completing deal:', error);
        alert('Ошибка при завершении сделки');
    })
    .finally(() => {
        completeBtn.disabled = false;
        completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Подтвердить завершение';
    });
}

// Handle status form submission
document.addEventListener('DOMContentLoaded', function() {
    const editStatusForm = document.getElementById('editStatusForm');
    if (editStatusForm) {
        editStatusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            updateDealStatus();
        });
    }
});

// Update deal status function
function updateDealStatus() {
    const dealId = document.getElementById('edit-deal-id').value;
    const newStatus = document.getElementById('edit-status').value;
    const statusNotes = document.getElementById('status-notes').value;
    const csrfToken = document.querySelector('[name="csrf_token"]').value;
    
    console.log('🔄 Updating deal status:', { dealId, newStatus, statusNotes });
    
    // If changing to 'successful', open completion modal instead
    if (newStatus === 'successful') {
        console.log('🎯 Status changing to successful - opening completion modal');
        closeEditStatusModal();
        openCompleteDealModal(dealId, statusNotes);
        return;
    }
    
    const updateBtn = document.getElementById('updateStatusBtn');
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Обновляется...';
    
    fetch(`/api/deals/${dealId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            status: newStatus,
            notes: statusNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('✅ Status update response:', data);
        
        if (data.success) {
            closeEditStatusModal();
            // Reload deals data
            if (typeof loadStaticDealsData === 'function') {
                loadStaticDealsData();
            }
            // Show success message
            showSuccessMessage('Статус сделки успешно обновлен');
        } else {
            console.error('❌ Failed to update status:', data.error);
            alert('Ошибка: ' + (data.error || 'Не удалось обновить статус'));
        }
    })
    .catch(error => {
        console.error('❌ Error updating status:', error);
        alert('Ошибка при обновлении статуса');
    })
    .finally(() => {
        updateBtn.disabled = false;
        updateBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Обновить статус';
    });
}

// View deal details - redirect to deal card page
window.viewDealDetails = function(dealId) {
    window.location.href = '/manager/deals/' + dealId;
    return;
    
    fetch(`/api/deals/${dealId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('📄 Deal details response:', data);
        
        if (data.success && data.deal) {
            openDealDetailsModal(data.deal);
        } else {
            console.error('❌ Failed to load deal details:', data.error);
            alert('Ошибка: ' + (data.error || 'Не удалось загрузить детали сделки'));
        }
    })
    .catch(error => {
        console.error('❌ Error loading deal details:', error);
        alert('Ошибка при загрузке деталей сделки');
    });
}

// Open deal card page (open in side panel)
function openDealDetailsModal(deal) {
    openDealPanel(deal.id);
    return;
    const statusLabels = {
        'new': 'Новая',
        'object_reserved': 'Объект зарезервирован', 
        'mortgage': 'Ипотека',
        'successful': 'Успешная',
        'rejected': 'Отклонена'
    };
    
    const statusColors = {
        'new': 'bg-blue-100 text-blue-800',
        'object_reserved': 'bg-orange-100 text-orange-800',
        'mortgage': 'bg-yellow-100 text-yellow-800', 
        'successful': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800'
    };
    
    const modalHtml = `
        <div id="dealDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">Детали сделки #${deal.id}</h3>
                        <button onclick="closeDealDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <!-- Deal Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Номер сделки</label>
                                <p class="text-lg font-semibold text-gray-900">#${deal.id}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[deal.status] || 'bg-gray-100 text-gray-800'}">
                                    ${statusLabels[deal.status] || deal.status}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Client Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Информация о клиенте</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Имя клиента</label>
                                    <p class="text-gray-900">${deal.client_name || 'Не указано'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <p class="text-gray-900">${deal.client_email || 'Не указан'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Информация о недвижимости</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ЖК</label>
                                    <p class="text-gray-900">${deal.complex_name || 'Не указан'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Стоимость</label>
                                    <p class="text-lg font-semibold text-gray-900">${deal.property_price ? (parseFloat(deal.property_price).toLocaleString('ru-RU') + ' ₽') : '0 ₽'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Финансовая информация</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Кешбек</label>
                                    <p class="text-lg font-semibold text-[#059669]">${deal.cashback_amount ? (parseFloat(deal.cashback_amount).toLocaleString('ru-RU') + ' ₽') : '0 ₽'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Дата создания</label>
                                    <p class="text-gray-900">${deal.created_at ? new Date(deal.created_at).toLocaleDateString('ru-RU') : 'Недавно'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Комментарии</h4>
                            <div id="deal-comments" class="space-y-2 mb-4">
                                ${deal.notes ? `<p class="text-gray-700 bg-gray-50 p-3 rounded">${deal.notes}</p>` : '<p class="text-gray-500 italic">Комментариев пока нет</p>'}
                            </div>
                            
                            <!-- Add Comment Form -->
                            <form id="addCommentForm" class="space-y-3">
                                <input type="hidden" id="detail-deal-id" value="${deal.id}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div>
                                    <label for="new-comment" class="block text-sm font-medium text-gray-700 mb-1">
                                        Добавить комментарий
                                    </label>
                                    <textarea id="new-comment" name="comment" rows="3"
                                              placeholder="Введите комментарий..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                                </div>
                                <button type="submit" id="addCommentBtn"
                                        class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Добавить комментарий
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 p-6 border-t bg-gray-50">
                        <button onclick="openEditStatusModal(${deal.id}, '${deal.status}')" 
                                class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                            <i class="fas fa-edit mr-2"></i>Изменить статус
                        </button>
                        <button onclick="closeDealDetailsModal()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Закрыть
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('dealDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
    
    // Add comment form submission handler
    document.getElementById('addCommentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addDealComment();
    });
}

// Close deal details modal
function closeDealDetailsModal() {
    const modal = document.getElementById('dealDetailsModal');
    if (modal) {
        modal.remove();
        if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    }
}

// Add comment to deal
function addDealComment() {
    const dealId = document.getElementById('detail-deal-id').value;
    const comment = document.getElementById('new-comment').value.trim();
    const csrfToken = document.querySelector('[name="csrf_token"]').value;
    
    if (!comment) {
        alert('Введите комментарий');
        return;
    }
    
    console.log('💬 Adding comment to deal:', { dealId, comment });
    
    const addBtn = document.getElementById('addCommentBtn');
    addBtn.disabled = true;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Добавляется...';
    
    fetch(`/api/deals/${dealId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            notes: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('✅ Comment added response:', data);
        
        if (data.success) {
            // Refresh the modal with updated data
            closeDealDetailsModal();
            viewDealDetails(dealId);
            showSuccessMessage('Комментарий успешно добавлен');
        } else {
            console.error('❌ Failed to add comment:', data.error);
            alert('Ошибка: ' + (data.error || 'Не удалось добавить комментарий'));
        }
    })
    .catch(error => {
        console.error('❌ Error adding comment:', error);
        alert('Ошибка при добавлении комментария');
    })
    .finally(() => {
        addBtn.disabled = false;
        addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Добавить комментарий';
    });
}

// Success message helper
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

console.log('✅ Deals modal functions defined');

// Загрузка сделок для статической секции
window.loadStaticDealsData = function() {
    console.log('📊 Loading deals for static section...');
    
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Static deals data received:', data);
        console.log('📊 Deals count:', data.deals ? data.deals.length : 0);
        console.log('📊 First deal:', data.deals && data.deals[0] ? data.deals[0] : 'No deals');
        
        updateStaticDealsSection(data);
        updateStaticDealsStats(data);
        
        // 🎯 ПРЯМОЕ ОБНОВЛЕНИЕ СЧЕТЧИКА В ТАБЕ
        if (data.success && data.deals) {
            const tabCounter = document.getElementById('deals-count');
            if (tabCounter) {
                tabCounter.textContent = data.deals.length;
                console.log(`🏷️ DIRECT: Updated deals tab counter: ${data.deals.length}`);
            } else {
                console.warn(`❌ DIRECT: deals-count element not found!`);
            }
        }
    })
    .catch(error => {
        console.error('❌ Error loading static deals:', error);
        console.error('❌ Error details:', error.message, error.stack);
    });
}

// Обновление статической секции сделок
function updateStaticDealsSection(data) {
    const dealsTable = document.getElementById('deals-tbody');
    if (!dealsTable) {
        console.error('❌ Deals table body not found');
        return;
    }

    if (data.success && data.deals && data.deals.length > 0) {
        dealsTable.innerHTML = '';
        
        data.deals.forEach(deal => {
            const row = createDealRow(deal);
            dealsTable.appendChild(row);
        });
        
        var mobileDeals = document.getElementById('deals-mobile-cards');
        if (mobileDeals) {
            var statusLabels = {
                'new': 'Новая', 'in_progress': 'В работе', 'calculation': 'Сделан расчёт',
                'meeting_scheduled': 'Встреча', 'meeting_done': 'Встреча ОК',
                'postponed': 'Отложена', 'verbal_reserve': 'Устная бронь', 'reserved': 'Бронь',
                'object_reserved': 'Забронирован', 'documents': 'Документы', 'mortgage': 'Ипотека',
                'ddu_preparation': 'ДДУ подг.', 'ddu_signing': 'ДДУ подпис.',
                'registration': 'Регистрация', 'receivables': 'Дебиторка',
                'completed': 'Завершена', 'successful': 'Успешная', 'rejected': 'Отклонена'
            };
            var statusDots = {
                'new': '#3B82F6', 'in_progress': '#0EA5E9', 'completed': '#10B981', 'successful': '#10B981',
                'rejected': '#6B7280', 'postponed': '#F59E0B', 'reserved': '#EF4444', 'mortgage': '#14B8A6'
            };
            mobileDeals.innerHTML = data.deals.map(function(deal) {
                var price = deal.property_price ? deal.property_price.toLocaleString() : '0';
                var cashback = deal.cashback_amount ? deal.cashback_amount.toLocaleString() : '0';
                var label = statusLabels[deal.status] || deal.status;
                var dotColor = statusDots[deal.status] || '#6B7280';
                return '<div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 cursor-pointer" onclick="openDealPanel(' + deal.id + ')">' +
                    '<div class="flex items-center justify-between mb-2">' +
                    '<span class="text-xs font-semibold text-[#0088CC]">#' + deal.id + '</span>' +
                    '<span class="flex items-center gap-1 text-xs"><span style="width:6px;height:6px;border-radius:50%;background:' + dotColor + ';display:inline-block"></span> ' + label + '</span>' +
                    '</div>' +
                    '<p class="text-sm font-medium text-gray-900 truncate">' + (deal.client_name || 'Клиент') + '</p>' +
                    '<p class="text-xs text-gray-500 truncate mb-2">' + (deal.complex_name || deal.property_description || '—') + '</p>' +
                    '<div class="flex items-center justify-between text-xs">' +
                    '<span class="text-gray-600">' + price + ' ₽</span>' +
                    '<span class="text-emerald-600 font-medium">Кешбэк: ' + cashback + ' ₽</span>' +
                    '</div></div>';
            }).join('');
        }
        
        console.log(`✅ Loaded ${data.deals.length} deals into static section`);
        initializeSearch();
    } else {
        dealsTable.innerHTML = `
            <tr id="no-deals-row">
                <td colspan="8" class="px-6 py-16 text-center">
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <h4 class="text-sm font-medium text-gray-900 mb-1">Нет сделок</h4>
                        <p class="text-sm text-gray-500 mb-4">Создайте первую сделку с клиентом</p>
                        <button onclick="openCreateDealModal()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl hover:bg-[#006699] transition-colors">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Создать сделку
                        </button>
                    </div>
                </td>
            </tr>
        `;
        var mobileDeals = document.getElementById('deals-mobile-cards');
        if (mobileDeals) {
            mobileDeals.innerHTML = '<div class="text-center py-8"><p class="text-sm font-medium text-gray-900 mb-1">Нет сделок</p><p class="text-xs text-gray-500 mb-3">Создайте первую сделку</p><button onclick="openCreateDealModal()" class="px-4 py-2 text-sm font-medium text-white bg-[#0088CC] rounded-xl">+ Создать</button></div>';
        }
        console.log('ℹ️ No deals found - showing placeholder');
    }
}

// Создание строки таблицы для сделки
function createDealRow(deal) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-blue-50/30 cursor-pointer transition-colors';
    row.onclick = function(e) {
        if (e.target.closest('button') || e.target.closest('a')) return;
        openDealPanel(deal.id);
    };
    
    const statusColors = {
        'new': 'bg-blue-50 text-blue-700 border border-blue-200',
        'in_progress': 'bg-sky-50 text-sky-700 border border-sky-200',
        'calculation': 'bg-indigo-50 text-indigo-700 border border-indigo-200',
        'meeting_scheduled': 'bg-violet-50 text-violet-700 border border-violet-200',
        'meeting_done': 'bg-sky-50 text-sky-700 border border-sky-200',
        'postponed': 'bg-amber-50 text-amber-700 border border-amber-200',
        'verbal_reserve': 'bg-orange-50 text-orange-700 border border-orange-200',
        'reserved': 'bg-red-50 text-red-700 border border-red-200',
        'object_reserved': 'bg-orange-50 text-orange-700 border border-orange-200',
        'documents': 'bg-pink-50 text-pink-700 border border-pink-200',
        'mortgage': 'bg-teal-50 text-teal-700 border border-teal-200',
        'ddu_preparation': 'bg-cyan-50 text-cyan-700 border border-cyan-200',
        'ddu_signing': 'bg-sky-50 text-sky-700 border border-sky-200',
        'registration': 'bg-indigo-50 text-indigo-700 border border-indigo-200',
        'receivables': 'bg-red-50 text-red-700 border border-red-200',
        'completed': 'bg-emerald-50 text-emerald-700 border border-emerald-200',
        'successful': 'bg-emerald-50 text-emerald-700 border border-emerald-200',
        'rejected': 'bg-gray-50 text-gray-700 border border-gray-200'
    };
    
    const statusLabels = {
        'new': 'Новая', 'in_progress': 'В работе', 'calculation': 'Сделан расчёт',
        'meeting_scheduled': 'Встреча назначена', 'meeting_done': 'Встреча проведена',
        'postponed': 'Отложена', 'verbal_reserve': 'Устная бронь', 'reserved': 'Бронь',
        'object_reserved': 'Забронирован', 'documents': 'Сбор документов', 'mortgage': 'Ипотека',
        'ddu_preparation': 'Подготовка ДДУ', 'ddu_signing': 'Подписание ДДУ',
        'registration': 'Регистрация', 'receivables': 'Дебиторка',
        'completed': 'Завершена', 'successful': 'Успешная', 'rejected': 'Отклонена'
    };
    
    const statusColor = statusColors[deal.status] || 'bg-gray-50 text-gray-700 border border-gray-200';
    const statusLabel = statusLabels[deal.status] || deal.status;
    
    const cashback = deal.cashback_amount ? deal.cashback_amount.toLocaleString() : '0';
    const price = deal.property_price ? deal.property_price.toLocaleString() : '0';
    
    row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-semibold text-[#0088CC]">#${deal.id}</div>
            <div class="text-xs text-gray-400">${deal.deal_number || ''}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                ${deal.client_profile_image
                    ? `<img src="${deal.client_profile_image}" alt="${deal.client_name || ''}" class="w-8 h-8 rounded-full object-cover mr-3 flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
                    : ''}
                <div class="w-8 h-8 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full items-center justify-center mr-3 flex-shrink-0" style="display:${deal.client_profile_image ? 'none' : 'flex'}">
                    <span class="text-white text-xs font-medium">
                        ${deal.client_name ? deal.client_name[0].toUpperCase() : 'К'}
                    </span>
                </div>
                <div class="min-w-0">
                    <div class="text-sm font-medium text-gray-900 truncate">${deal.client_name || 'Клиент'}</div>
                    <div class="text-xs text-gray-400 truncate">${deal.client_email || ''}</div>
                </div>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-700">${deal.complex_name || deal.property_description || '—'}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-semibold text-gray-900">${price} ₽</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-semibold text-emerald-600">${cashback} ₽</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2.5 py-1 inline-flex text-xs font-medium rounded-lg ${statusColor}" data-status="${deal.status}">
                ${statusLabel}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${deal.created_at ? new Date(deal.created_at).toLocaleDateString('ru-RU') : 'Недавно'}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="flex items-center space-x-1">
                <button onclick="event.stopPropagation(); openEditStatusModal(${deal.id}, '${deal.status}')"
                        class="p-1.5 text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-all" title="Изменить статус">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
                <button onclick="event.stopPropagation(); openDealPanel(${deal.id})"
                   class="p-1.5 text-gray-400 hover:text-[#0088CC] hover:bg-blue-50 rounded-lg transition-all" title="Открыть карточку">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Фильтрация и поиск сделок
function applyFilters(saveToStorage = true) {
    const statusFilter = document.getElementById('status-filter').value;
    const searchInput = document.getElementById('search-deals');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    console.log('🔍 Applying filter - Status:', statusFilter, 'Search:', searchTerm);
    
    // Сохранить параметры поиска
    if (saveToStorage) {
        localStorage.setItem('manager_deals_status_filter', statusFilter);
        localStorage.setItem('manager_deals_search', searchTerm);
        console.log('💾 Saved search params to localStorage');
    }
    
    const tableBody = document.querySelector('#deals-tbody');
    if (!tableBody) {
        console.error('❌ Table body not found: #deals-tbody');
        return;
    }
    
    const rows = tableBody.querySelectorAll('tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Пропустить строку "нет данных"
        if (row.id === 'no-deals-row') return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        // Получаем данные из строки
        const dealNumber = cells[0]?.textContent?.toLowerCase() || '';
        const clientName = cells[1]?.textContent?.toLowerCase() || '';
        const complexName = cells[2]?.textContent?.toLowerCase() || '';
        
        // Получаем статус из data-атрибута
        const statusBadge = row.querySelector('[data-status]');
        const dealStatus = statusBadge?.getAttribute('data-status') || '';
        
        // Проверка поиска (ищем по номеру, клиенту и ЖК)
        const matchesSearch = !searchTerm || 
            dealNumber.includes(searchTerm) || 
            clientName.includes(searchTerm) || 
            complexName.includes(searchTerm);
        
        // Проверка фильтра статуса (используем data-атрибут!)
        const matchesStatus = !statusFilter || statusFilter === '' || 
            statusFilter === 'all' ||
            dealStatus === statusFilter;
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    var mobileCards = document.getElementById('deals-mobile-cards');
    if (mobileCards) {
        var cards = mobileCards.querySelectorAll('[onclick]');
        cards.forEach(function(card) {
            var text = card.textContent.toLowerCase();
            var matchSearch = !searchTerm || text.includes(searchTerm);
            card.style.display = matchSearch ? '' : 'none';
        });
    }
    
    console.log(`📊 Filtered results: ${visibleCount} deals visible out of ${rows.length}`);
}

// Очистка фильтров и поиска
function clearFilters() {
    // Очистить фильтр статуса
    const statusFilter = document.getElementById('status-filter');
    if (statusFilter) statusFilter.value = '';
    
    // Очистить поле поиска
    const searchInput = document.getElementById('search-deals');
    if (searchInput) searchInput.value = '';
    
    // Очистить localStorage
    localStorage.removeItem('manager_deals_status_filter');
    localStorage.removeItem('manager_deals_search');
    console.log('🗑️ Cleared search params from localStorage');
    
    // Применить фильтры (без сохранения, т.к. уже очистили)
    applyFilters(false);
}

// Инициализация поиска в реальном времени
function initializeSearch() {
    const searchInput = document.getElementById('search-deals');
    const statusFilter = document.getElementById('status-filter');
    
    // Восстановить сохраненные параметры поиска
    const savedStatus = localStorage.getItem('manager_deals_status_filter');
    const savedSearch = localStorage.getItem('manager_deals_search');
    
    if (savedStatus && statusFilter) {
        statusFilter.value = savedStatus;
        console.log('📂 Restored status filter:', savedStatus);
    }
    
    if (savedSearch && searchInput) {
        searchInput.value = savedSearch;
        console.log('📂 Restored search term:', savedSearch);
    }
    
    // Применить восстановленные фильтры
    if (savedStatus || savedSearch) {
        applyFilters(false); // Не сохранять снова, уже загрузили из storage
    }
    
    // Автоматическая фильтрация при вводе текста
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            applyFilters();
        });
        console.log('🔍 Search input initialized with auto-filter');
    }
    
    // Автоматическая фильтрация при изменении статуса
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            applyFilters();
        });
        console.log('🔍 Status filter initialized with auto-change');
    }
}

// Обновление статистики сделок
function updateStaticDealsStats(data) {
    if (!data.success || !data.deals) return;
    
    const deals = data.deals;
    const activeDeals = deals.filter(d => d.status === 'new' || d.status === 'object_reserved' || d.status === 'mortgage').length;
    const completedDeals = deals.filter(d => d.status === 'successful').length;
    const inProgressDeals = deals.filter(d => d.status === 'object_reserved' || d.status === 'mortgage').length;
    const totalCashback = deals.reduce((sum, d) => sum + (d.cashback_amount || 0), 0);
    const totalDeals = deals.length;
    
    // Обновляем счётчики в секции
    const activeCount = document.getElementById('active-deals-count');
    const completedCount = document.getElementById('completed-deals-count');
    const inProgressCount = document.getElementById('in-progress-deals-count');
    const totalCashbackEl = document.getElementById('total-cashback');
    
    if (activeCount) activeCount.textContent = activeDeals;
    if (completedCount) completedCount.textContent = completedDeals;
    if (inProgressCount) inProgressCount.textContent = inProgressDeals;
    if (totalCashbackEl) totalCashbackEl.textContent = `${totalCashback.toLocaleString()} ₽`;
    
    // ✅ ИСПРАВЛЕНИЕ: Обновляем счетчик в табе!
    const dealsTabCounter = document.getElementById('deals-count');
    console.log(`🔍 Looking for deals-count element:`, dealsTabCounter);
    if (dealsTabCounter) {
        dealsTabCounter.textContent = totalDeals;
        console.log(`🏷️ Updated deals tab counter: ${totalDeals}`);
    } else {
        console.warn(`❌ deals-count element not found! Available elements:`, document.querySelectorAll('[id*="deals"]'));
    }
    
    console.log(`📊 Updated deals stats: active=${activeDeals}, completed=${completedDeals}, inProgress=${inProgressDeals}, total=${totalDeals}`);
}

// Обработка создания сделки
function submitCreateDeal(event) {
    event.preventDefault();
    console.log('📝 Submitting new deal...');
    
    const form = document.getElementById('createDealForm');
    const formData = new FormData(form);
    
    const dealData = {
        client_id: formData.get('client_id'),
        residential_complex_name: formData.get('residential_complex_name'),
        property_price: parseFloat(formData.get('property_price')),
        cashback_amount: parseFloat(formData.get('cashback_amount')),
        property_description: formData.get('property_description'),
        property_floor: formData.get('property_floor') ? parseInt(formData.get('property_floor')) : null,
        property_area: formData.get('property_area') ? parseFloat(formData.get('property_area')) : null,
        property_rooms: formData.get('property_rooms'),
        notes: formData.get('notes')
    };
    
    console.log('📝 Deal data:', dealData);
    
    // Отправляем на API
    fetch('/api/deals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrf_token')
        },
        body: JSON.stringify(dealData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📝 Create deal response:', data);
        
        if (data.success) {
            closeCreateDealModal();
            if (data.deal && data.deal.id) {
                window.location.href = '/manager/deals/' + data.deal.id;
            } else {
                loadStaticDealsData();
            }
        } else {
            console.error('❌ Failed to create deal:', data.error);
            alert('Ошибка при создании сделки: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('❌ Error creating deal:', error);
        alert('Ошибка при создании сделки. Попробуйте еще раз.');
    });
}

</script>

<!-- Modal: Create New Deal -->
<div id="createDealModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Создать новую сделку</h3>
                <button onclick="closeCreateDealModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createDealForm" class="p-6 space-y-6" onsubmit="submitCreateDeal(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Client Selection -->
                <div>
                    <label for="client_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Клиент <span class="text-red-500">*</span>
                    </label>
                    <select id="client_id" name="client_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <option value="">Загрузка клиентов...</option>
                    </select>
                </div>

                <!-- Residential Complex Name -->
                <div>
                    <label for="residential_complex_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Жилой комплекс <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="residential_complex_name" name="residential_complex_name" required
                           placeholder="Введите название ЖК (например: ЖК Летний)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                </div>

                <!-- Property Price -->
                <div>
                    <label for="property_price" class="block text-sm font-medium text-gray-700 mb-2">
                        Стоимость объекта (₽) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="property_price" name="property_price" required
                           min="100000" step="10000" placeholder="3500000"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                </div>

                <!-- Cashback Amount -->
                <div>
                    <label for="cashback_amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Сумма кешбека (₽) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="cashback_amount" name="cashback_amount" required
                           min="0" step="1000" placeholder="87500"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">Обычно 2-5% от стоимости объекта</p>
                </div>

                <!-- Property Description -->
                <div>
                    <label for="property_description" class="block text-sm font-medium text-gray-700 mb-2">
                        Описание объекта
                    </label>
                    <textarea id="property_description" name="property_description" rows="3"
                              placeholder="Квартира с отделкой, панорамные окна, хорошая планировка..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Property Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="property_floor" class="block text-sm font-medium text-gray-700 mb-2">
                            Этаж
                        </label>
                        <input type="number" id="property_floor" name="property_floor" 
                               min="1" max="50" placeholder="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="property_area" class="block text-sm font-medium text-gray-700 mb-2">
                            Площадь (м²)
                        </label>
                        <input type="number" id="property_area" name="property_area" 
                               min="10" step="0.1" placeholder="65.5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="property_rooms" class="block text-sm font-medium text-gray-700 mb-2">
                            Комнат
                        </label>
                        <select id="property_rooms" name="property_rooms"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            <option value="">Не указано</option>
                            <option value="студия">Студия</option>
                            <option value="1">1 комната</option>
                            <option value="2">2 комнаты</option>
                            <option value="3">3 комнаты</option>
                            <option value="4">4 комнаты</option>
                            <option value="5+">5+ комнат</option>
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                        Заметки менеджера
                    </label>
                    <textarea id="notes" name="notes" rows="2"
                              placeholder="Дополнительные заметки о сделке..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeCreateDealModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" id="createDealBtn"
                            class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                        <i class="fas fa-plus mr-2"></i>Создать сделку
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Edit Status -->
<div id="editStatusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-lg w-full">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Изменить статус сделки</h3>
                <button onclick="closeEditStatusModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editStatusForm" class="p-6 space-y-4">
                <input type="hidden" id="edit-deal-id" name="deal_id">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div>
                    <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-2">
                        Новый статус <span class="text-red-500">*</span>
                    </label>
                    <select id="edit-status" name="status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <option value="new">Новая</option>
                        <option value="object_reserved">Объект зарезервирован</option>
                        <option value="mortgage">Ипотека</option>
                        <option value="successful">Успешная</option>
                        <option value="rejected">Отклонена</option>
                    </select>
                </div>
                
                <div>
                    <label for="status-notes" class="block text-sm font-medium text-gray-700 mb-2">
                        Комментарий к изменению
                    </label>
                    <textarea id="status-notes" name="status_notes" rows="3"
                              placeholder="Причина изменения статуса..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeEditStatusModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" id="updateStatusBtn"
                            class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                        <i class="fas fa-save mr-2"></i>Обновить статус
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Complete Deal -->
<div id="completeDealModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full">
            <div class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-[#0088CC] to-[#006699]">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Завершение сделки #<span id="complete-deal-number"></span></h3>
                        <p class="text-sm text-white/80">Подтверждение успешной сделки</p>
                    </div>
                </div>
                <button onclick="closeCompleteDealModal()" class="text-white/80 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            
            <form id="completeDealForm" class="p-6 space-y-5">
                <input type="hidden" id="complete-deal-id" name="deal_id">
                
                <!-- Warning Alert -->
                <div class="bg-blue-50 border-l-4 border-[#0088CC] p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-800 font-medium">
                                После завершения сделки кешбек будет автоматически начислен клиенту
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Property Price -->
                    <div>
                        <label for="complete-property-price" class="block text-sm font-medium text-gray-700 mb-2">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                                <span>Стоимость объекта <span class="text-red-500">*</span></span>
                            </div>
                        </label>
                        <input type="text" id="complete-property-price" name="property_price" required
                               oninput="formatPriceInput(this)"
                               placeholder="5 000 000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <p class="mt-1 text-xs text-gray-500">Укажите полную стоимость недвижимости</p>
                    </div>

                    <!-- Cashback Amount -->
                    <div>
                        <label for="complete-cashback-amount" class="block text-sm font-medium text-gray-700 mb-2">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                <span>Сумма кешбека <span class="text-red-500">*</span></span>
                            </div>
                        </label>
                        <input type="text" id="complete-cashback-amount" name="cashback_amount" required
                               oninput="formatPriceInput(this)"
                               placeholder="350 000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <p class="mt-1 text-xs text-gray-500">Кешбек будет зачислен на баланс клиента</p>
                    </div>

                    <!-- Contract Date -->
                    <div>
                        <label for="complete-contract-date" class="block text-sm font-medium text-gray-700 mb-2">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                </svg>
                                <span>Дата договора <span class="text-red-500">*</span></span>
                            </div>
                        </label>
                        <input type="date" id="complete-contract-date" name="contract_date" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>

                    <!-- Completion Date -->
                    <div>
                        <label for="complete-completion-date" class="block text-sm font-medium text-gray-700 mb-2">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span>Дата завершения <span class="text-red-500">*</span></span>
                            </div>
                        </label>
                        <input type="date" id="complete-completion-date" name="completion_date" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="complete-notes" class="block text-sm font-medium text-gray-700 mb-2">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/>
                            </svg>
                            <span>Комментарий менеджера</span>
                        </div>
                    </label>
                    <textarea id="complete-notes" name="notes" rows="3"
                              placeholder="Дополнительная информация о завершении сделки..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeCompleteDealModal()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                        Отмена
                    </button>
                    <button type="button" onclick="completeDeal()" id="completeDealBtn"
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all font-medium shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Подтвердить завершение
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

</div><!-- End sidebar content wrapper -->

<!-- Sidebar tab switching for manager dashboard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔄 Manager sidebar tab switching initialized');
    
    const sidebarLinks = document.querySelectorAll('.sidebar-link[data-page]');
    console.log('🔍 Found sidebar links:', sidebarLinks.length);
    
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const page = this.getAttribute('data-page');
            const href = this.getAttribute('href');
            
            if (href && !href.startsWith('#')) {
                console.log('🔗 Following external link:', href);
                return;
            }
            
            e.preventDefault();
            if (typeof window.showSection === 'function') {
                window.showSection(page);
            }
            
            const mobileSidebarMenu = document.getElementById('mobile-sidebar-menu');
            const hamburgerIcon = document.getElementById('hamburger-icon');
            const closeIcon = document.getElementById('close-icon');
            const sidebar = document.getElementById('app-sidebar');
            if (mobileSidebarMenu && !mobileSidebarMenu.classList.contains('hidden')) {
                mobileSidebarMenu.classList.add('hidden');
                if (hamburgerIcon) hamburgerIcon.classList.remove('hidden');
                if (closeIcon) closeIcon.classList.add('hidden');
                if (sidebar) sidebar.classList.remove('mobile-open');
            }
        });
    });
    
    const savedTab = localStorage.getItem('manager_dashboard_active_tab');
    if (savedTab && document.getElementById(savedTab)) {
        window.showSection(savedTab);
    }

    // Comparison tab switching
    document.querySelectorAll('.comp-tab-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const tab = this.dataset.compTab;
            window.compCurrentTab = tab;
            document.querySelectorAll('.comp-tab-button').forEach(b => {
                const isActive = b.dataset.compTab === tab;
                b.classList.toggle('border-[#0088CC]', isActive);
                b.classList.toggle('text-[#0088CC]', isActive);
                b.classList.toggle('border-transparent', !isActive);
                b.classList.toggle('text-gray-500', !isActive);
            });
            if (typeof window.loadComparisonData === 'function') {
                window.loadComparisonData();
            }
        });
    });
});

// ===== COMPARISON SECTION LOGIC =====
window.compCurrentTab = 'properties';
window.compPropertyData = [];
window.compComplexData = [];

function getCSRFTokenComp() {
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    return (csrfInput && csrfInput.value) || (csrfMeta && csrfMeta.content) || '';
}

window.loadComparisonData = function() {
    console.log('📊 Loading comparison data for tab:', window.compCurrentTab);
    
    fetch('/api/manager/comparison/load')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.compPropertyData = data.properties || [];
                window.compComplexData = data.complexes || [];
                if (window.compCurrentTab === 'properties') {
                    renderComparisonTable(window.compPropertyData, 'properties');
                } else {
                    renderComparisonTable(window.compComplexData, 'complexes');
                }
            }
        })
        .catch(err => console.error('Error loading comparison data:', err));
};

function renderComparisonTable(items, type) {
    const emptyState = document.getElementById('comp-empty-state');
    const tableContainer = document.getElementById('comp-table-container');
    const totalCount = document.getElementById('comp-total-count');
    const avgPrice = document.getElementById('comp-average-price');
    const avgArea = document.getElementById('comp-average-area');
    
    if (totalCount) totalCount.textContent = items.length;
    
    if (!items || items.length === 0) {
        if (emptyState) emptyState.classList.remove('hidden');
        if (tableContainer) tableContainer.classList.add('hidden');
        if (avgPrice) avgPrice.textContent = '—';
        if (avgArea) avgArea.textContent = '—';
        return;
    }
    
    if (emptyState) emptyState.classList.add('hidden');
    if (tableContainer) tableContainer.classList.remove('hidden');
    
    if (type === 'properties') {
        const prices = items.map(p => p.property_price || p.current_price || p.price || 0).filter(p => p > 0);
        const areas = items.map(p => p.area || p.property_size || 0).filter(a => a > 0);
        
        if (avgPrice && prices.length > 0) {
            const avg = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            avgPrice.textContent = avg.toLocaleString('ru-RU') + ' ₽';
        }
        if (avgArea && areas.length > 0) {
            const avg = Math.round(areas.reduce((a, b) => a + b, 0) / areas.length * 10) / 10;
            avgArea.textContent = avg + ' м²';
        }
        
        renderPropertyComparisonTable(items);
    } else {
        const prices = items.map(c => c.min_price || c.price_from || 0).filter(p => p > 0);
        if (avgPrice && prices.length > 0) {
            const avg = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            avgPrice.textContent = 'от ' + avg.toLocaleString('ru-RU') + ' ₽';
        }
        if (avgArea) avgArea.textContent = items.length + ' ЖК';
        
        renderComplexComparisonTable(items);
    }
}

function renderPropertyComparisonTable(items) {
    const header = document.getElementById('comp-table-header');
    const body = document.getElementById('comp-table-body');
    if (!header || !body) return;
    
    header.innerHTML = '<th class="px-6 py-4 text-left text-sm font-medium text-gray-500 w-48 sticky left-0 bg-gray-50">Характеристика</th>';
    items.forEach((p, i) => {
        const name = p.property_name || p.title || `Объект ${i + 1}`;
        const img = p.property_image || p.main_image || '/static/images/no-photo.jpg';
        header.innerHTML += `<th class="px-6 py-4 text-center text-sm font-medium text-gray-500 min-w-[280px]">
            <div class="flex flex-col items-center gap-2">
                <img src="${Array.isArray(img) ? img[0] : img}" class="w-32 h-24 object-cover rounded-lg cursor-pointer" onerror="this.src='/static/images/no-photo.jpg'" onclick="event.stopPropagation(); document.getElementById('compZoomedPhoto').src=this.src; document.getElementById('compPhotoZoomModal').classList.remove('hidden')">
                <span class="text-gray-900 font-semibold">${name}</span>
                <button onclick="removeFromComparison(${p.property_id || p.id}, 'property')" class="text-xs text-red-500 hover:text-red-700">Удалить</button>
            </div>
        </th>`;
    });
    
    const rows = [
        {label: 'Цена', key: p => (p.property_price || p.current_price || p.price || 0).toLocaleString('ru-RU') + ' ₽'},
        {label: 'Площадь', key: p => (p.area || p.property_size || '—') + ' м²'},
        {label: 'Комнаты', key: p => p.rooms == 0 || p.rooms === '0' ? 'Студия' : (p.rooms || '—')},
        {label: 'Этаж', key: p => (p.floor || '—') + (p.total_floors || p.floors_total ? '/' + (p.total_floors || p.floors_total) : '')},
        {label: 'Цена за м²', key: p => { const price = p.property_price || p.current_price || p.price || 0; const area = p.area || p.property_size || 0; return area > 0 ? Math.round(price / area).toLocaleString('ru-RU') + ' ₽' : '—'; }},
        {label: 'ЖК', key: p => p.complex_name || p.residential_complex || '—'},
        {label: 'Застройщик', key: p => p.developer_name || p.developer || '—'},
        {label: 'Класс жилья', key: p => p.housing_class || '—'},
        {label: 'Срок сдачи', key: p => p.delivery_date || '—'},
        {label: 'Адрес', key: p => p.address || '—'},
        {label: 'Кэшбэк', key: p => { const rate = p.cashback_rate || 5; const price = p.property_price || p.current_price || p.price || 0; return Math.round(price * rate / 100).toLocaleString('ru-RU') + ' ₽ (' + rate + '%)'; }},
    ];
    
    body.innerHTML = '';
    rows.forEach((row, i) => {
        let vals = items.map(p => row.key(p));
        const allSame = vals.every(v => v === vals[0]);
        const best = findBestValue(row.label, vals);
        
        let html = `<tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="px-6 py-3 text-sm font-medium text-gray-700 sticky left-0 ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">${row.label}</td>`;
        vals.forEach((v, j) => {
            const highlight = best === j ? 'text-green-700 font-semibold bg-green-50' : '';
            html += `<td class="px-6 py-3 text-sm text-center text-gray-900 ${highlight}">${v}</td>`;
        });
        html += '</tr>';
        body.innerHTML += html;
    });
}

function renderComplexComparisonTable(items) {
    const header = document.getElementById('comp-table-header');
    const body = document.getElementById('comp-table-body');
    if (!header || !body) return;
    
    header.innerHTML = '<th class="px-6 py-4 text-left text-sm font-medium text-gray-500 w-48 sticky left-0 bg-gray-50">Характеристика</th>';
    items.forEach((c, i) => {
        const name = c.complex_name || c.name || `ЖК ${i + 1}`;
        const img = c.photo || c.image || c.main_image || '/static/images/no-photo.jpg';
        header.innerHTML += `<th class="px-6 py-4 text-center text-sm font-medium text-gray-500 min-w-[280px]">
            <div class="flex flex-col items-center gap-2">
                <img src="${img}" class="w-32 h-24 object-cover rounded-lg" onerror="this.src='/static/images/no-photo.jpg'">
                <span class="text-gray-900 font-semibold">${name}</span>
                <button onclick="removeFromComparison(${c.complex_id || c.id}, 'complex')" class="text-xs text-red-500 hover:text-red-700">Удалить</button>
            </div>
        </th>`;
    });
    
    const rows = [
        {label: 'Цена от', key: c => (c.min_price || 0) > 0 ? c.min_price.toLocaleString('ru-RU') + ' ₽' : '—'},
        {label: 'Цена до', key: c => (c.max_price || 0) > 0 ? c.max_price.toLocaleString('ru-RU') + ' ₽' : '—'},
        {label: 'Застройщик', key: c => c.developer_name || c.developer || '—'},
        {label: 'Адрес', key: c => c.district || c.address || '—'},
        {label: 'Корпусов', key: c => c.buildings_count || '—'},
        {label: 'Квартир', key: c => c.apartments_count || '—'},
        {label: 'Класс', key: c => c.complex_class || '—'},
        {label: 'Статус', key: c => c.status || '—'},
        {label: 'Срок сдачи', key: c => c.completion_date || '—'},
        {label: 'Кэшбэк', key: c => (c.cashback_rate || 5) + '%'},
    ];
    
    body.innerHTML = '';
    rows.forEach((row, i) => {
        let html = `<tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="px-6 py-3 text-sm font-medium text-gray-700 sticky left-0 ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">${row.label}</td>`;
        items.forEach(c => {
            html += `<td class="px-6 py-3 text-sm text-center text-gray-900">${row.key(c)}</td>`;
        });
        html += '</tr>';
        body.innerHTML += html;
    });
}

function findBestValue(label, vals) {
    if (vals.length < 2) return -1;
    const numVals = vals.map(v => parseFloat(v.replace(/[^\d.,]/g, '').replace(',', '.')));
    if (numVals.some(isNaN)) return -1;
    
    const lowerLabels = ['цена', 'цена за м²'];
    const higherLabels = ['площадь', 'кэшбэк'];
    
    if (lowerLabels.some(l => label.toLowerCase().includes(l))) {
        const min = Math.min(...numVals.filter(v => v > 0));
        return numVals.indexOf(min);
    }
    if (higherLabels.some(l => label.toLowerCase().includes(l))) {
        const max = Math.max(...numVals);
        return numVals.indexOf(max);
    }
    return -1;
}

function removeFromComparison(id, type) {
    if (!confirm('Удалить из сравнения?')) return;
    
    const endpoint = type === 'complex' 
        ? '/api/manager/comparison/complex/remove' 
        : '/api/manager/comparison/property/remove';
    const bodyKey = type === 'complex' ? 'complex_id' : 'property_id';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFTokenComp()},
        body: JSON.stringify({[bodyKey]: String(id)})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.loadComparisonData();
        }
    })
    .catch(err => console.error('Error removing from comparison:', err));
}

document.getElementById('clear-comparison-btn')?.addEventListener('click', function() {
    if (!confirm('Очистить все объекты из сравнения?')) return;
    
    fetch('/api/manager/comparison/clear', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFTokenComp()}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.loadComparisonData();
        }
    })
    .catch(err => console.error('Error clearing comparison:', err));
});

// Export comparison to PDF
document.getElementById('export-comparison-btn')?.addEventListener('click', function() {
    const tableContainer = document.getElementById('comp-table-container');
    if (!tableContainer) {
        alert('Нет данных для экспорта');
        return;
    }
    const printWin = window.open('', '_blank');
    if (!printWin) {
        alert('Разрешите всплывающие окна для печати');
        return;
    }
    const tableHtml = tableContainer.querySelector('.overflow-x-auto')?.innerHTML || tableContainer.innerHTML;
    printWin.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Сравнение объектов - InBack</title><style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;padding:30px;color:#000;background:#fff}
.header{text-align:center;margin-bottom:30px;padding-bottom:15px;border-bottom:2px solid #0088CC}
.header h1{font-size:24px;color:#0088CC;margin-bottom:5px}
.header p{font-size:14px;color:#666}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th,td{border:1px solid #ddd;padding:10px 12px;text-align:left;vertical-align:top}
th{background:#f8f9fa;font-weight:600;color:#333}
tr:nth-child(even){background:#fafafa}
img{max-width:120px;max-height:80px;object-fit:cover;border-radius:6px}
button,.text-red-500,.text-red-700{display:none!important}
.bg-green-50{background:#ecfdf5!important}
.text-green-600,.text-green-700{color:#059669!important;font-weight:600}
.footer{text-align:center;margin-top:30px;padding-top:15px;border-top:1px solid #ddd;font-size:12px;color:#888}
.print-btn{position:fixed;top:20px;right:20px;background:#0088CC;color:#fff;border:none;padding:12px 24px;font-size:14px;cursor:pointer;border-radius:8px;font-weight:600}
.print-btn:hover{background:#006699}
@media print{body{padding:15px}.print-btn{display:none!important}img{max-width:100px;max-height:70px}}
</style></head><body>
<button onclick="window.print()" class="print-btn">Печать</button>
<div class="header"><h1>InBack Недвижимость</h1><p>Сравнение объектов</p></div>
${tableHtml}
<div class="footer"><p>InBack.ru — ваш кешбек за новостройки | ${new Date().toLocaleDateString('ru-RU')}</p></div>
<script>window.onload=function(){setTimeout(function(){window.print()},300)}</script>
</body></html>`);
    printWin.document.close();
});

// Send comparison to client
document.getElementById('send-comp-btn')?.addEventListener('click', function() {
    document.getElementById('sendCompClientModal')?.classList.remove('hidden');
});

document.getElementById('sendCompClientForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('compRecipientName').value;
    const notes = document.getElementById('compMessageNotes').value;
    
    const properties = (window.compPropertyData || []).map(p => ({
        property_id: p.property_id || p.id,
        property_name: p.property_name || p.title || '',
        property_price: p.property_price || p.current_price || p.price || 0,
        property_size: p.area || p.property_size || '',
        property_image: Array.isArray(p.property_image || p.main_image) ? (p.property_image || p.main_image)[0] : (p.property_image || p.main_image || ''),
        rooms: p.rooms || '',
        floor: p.floor || '',
        total_floors: p.total_floors || '',
        developer_name: p.developer_name || p.developer || '',
        address: p.address || '',
        cashback_rate: p.cashback_rate || 5,
        is_sold: p.is_sold || false,
        complex_name: p.complex_name || ''
    }));
    
    const complexes = (window.compComplexData || []).map(c => ({
        name: c.name || c.title || '',
        photo: c.photo || c.image || c.main_image || '',
        min_price: c.min_price || c.price_from || 0,
        max_price: c.max_price || c.price_to || 0,
        completion_date: c.completion_date || '',
        cashback_rate: c.cashback_rate || 0,
        developer: c.developer || c.developer_name || '',
        address: c.address || '',
        object_class: c.object_class || c.housing_class || '',
        is_sold: c.is_sold || false
    }));
    
    fetch('/api/manager/generate-comparison-pdf', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFTokenComp()},
        body: JSON.stringify({recipient_name: name, notes: notes, properties: properties, complexes: complexes})
    })
    .then(r => {
        if (r.headers.get('Content-Disposition')?.includes('attachment')) {
            return r.blob().then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = r.headers.get('Content-Disposition').match(/filename="(.+)"/)?.[1] || 'comparison.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('sendCompClientModal').classList.add('hidden');
            });
        }
        return r.json().then(data => {
            document.getElementById('sendCompClientModal').classList.add('hidden');
            if (data.success && data.pdf_url) {
                window.open(data.pdf_url, '_blank');
            } else {
                alert(data.message || 'Документ создан');
            }
        });
    })
    .catch(err => {
        console.error('Error sending comparison:', err);
        document.getElementById('sendCompClientModal').classList.add('hidden');
    });
});
</script>

<!-- Side Panel: Deal Card (Bitrix24 style) -->
<div id="dealSidePanel" class="fixed inset-y-0 right-0 w-full md:w-[950px] bg-white shadow-2xl z-[60] transform translate-x-full transition-all duration-500 ease-[cubic-bezier(0.4,0,0.2,1)] border-l border-gray-200">
    <div class="h-full flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b bg-white/80 backdrop-blur-md sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <button onclick="closeDealPanel()" class="group p-2 hover:bg-gray-100 rounded-xl transition-all text-gray-400 hover:text-gray-900">
                    <i class="fas fa-times text-lg group-hover:rotate-90 transition-transform duration-300"></i>
                </button>
                <div class="h-8 w-px bg-gray-200"></div>
                <div>
                    <h3 class="font-black text-gray-900 text-xl tracking-tight" id="panelDealNumber">Загрузка...</h3>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="flex h-2 w-2 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                        </span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.1em]">CRM &bull; Карточка сделки</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="expandDealPanel()" id="expandPanelBtn" class="flex items-center gap-2 px-5 py-2.5 text-xs font-bold uppercase tracking-wider text-[#0088CC] hover:bg-[#0088CC]/5 rounded-xl transition-all border border-[#0088CC]/20 hover:border-[#0088CC]/40">
                    <i class="fas fa-expand-alt" id="expandPanelIcon"></i>
                    <span id="expandPanelText">На весь экран</span>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto bg-[#F8FAFC]" id="dealPanelContent">
            <div class="flex flex-col items-center justify-center h-full space-y-6">
                <div class="relative">
                    <div class="w-16 h-16 border-[3px] border-gray-100 border-t-[#0088CC] rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-handshake text-[#0088CC] animate-pulse"></i>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-gray-900 font-bold text-lg">Загружаем данные</p>
                    <p class="text-gray-400 text-sm mt-1">Это займет всего секунду...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="panelOverlay" class="fixed inset-0 bg-gray-900/60 backdrop-blur-[4px] z-[55] hidden transition-all duration-500 opacity-0" onclick="closeDealPanel()"></div>

<script>
let currentDealId = null;
const PANEL_LOADING_HTML = `
    <div class="flex flex-col items-center justify-center h-full space-y-6">
        <div class="relative">
            <div class="w-16 h-16 border-[3px] border-gray-100 border-t-[#0088CC] rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-handshake text-[#0088CC] animate-pulse"></i>
            </div>
        </div>
        <div class="text-center">
            <p class="text-gray-900 font-bold text-lg">Загружаем данные</p>
            <p class="text-gray-400 text-sm mt-1">Это займет всего секунду...</p>
        </div>
    </div>
`;

function loadDealContent(dealId) {
    const content = document.getElementById('dealPanelContent');
    content.innerHTML = PANEL_LOADING_HTML;
    document.getElementById('panelDealNumber').textContent = 'Загрузка...';

    fetch(`/manager/deals/${dealId}?partial=1`)
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.text();
        })
        .then(html => {
            content.innerHTML = html;
            const h1 = content.querySelector('h1');
            if (h1) {
                document.getElementById('panelDealNumber').textContent = h1.textContent;
                h1.parentElement.classList.add('hidden');
            }
            const scripts = content.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        })
        .catch(err => {
            content.innerHTML = `
                <div class="p-12 text-center">
                    <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                    </div>
                    <p class="text-gray-900 font-bold text-xl">Ошибка загрузки</p>
                    <p class="text-gray-500 mt-2 max-w-sm mx-auto">Не удалось загрузить данные. Проверьте соединение.</p>
                    <button onclick="openDealPanel(${dealId})" class="mt-6 px-6 py-3 bg-gray-900 text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition-all">
                        Попробовать снова
                    </button>
                </div>
            `;
        });
}

function openDealPanel(dealId) {
    currentDealId = dealId;
    const panel = document.getElementById('dealSidePanel');
    const overlay = document.getElementById('panelOverlay');

    document.body.style.overflow = 'hidden';
    overlay.classList.remove('hidden');

    history.pushState({dealPanel: true, dealId: dealId}, '', `/manager/deals/${dealId}`);

    setTimeout(() => {
        overlay.classList.add('opacity-100');
        panel.classList.remove('translate-x-full');
    }, 10);

    loadDealContent(dealId);
}

window.reloadDealPanel = function() {
    if (currentDealId) {
        loadDealContent(currentDealId);
    }
}

function closeDealPanel() {
    const panel = document.getElementById('dealSidePanel');
    const overlay = document.getElementById('panelOverlay');
    panel.classList.add('translate-x-full');
    overlay.classList.remove('opacity-100');
    setTimeout(() => {
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
        document.getElementById('dealPanelContent').innerHTML = PANEL_LOADING_HTML;
    }, 500);

    if (currentDealId) {
        history.replaceState({dealPanel: false}, '', '/manager/dashboard');
    }
    currentDealId = null;
    if (isPanelExpanded) {
        const panel = document.getElementById('dealSidePanel');
        panel.classList.remove('md:w-full');
        panel.classList.add('md:w-[950px]');
        isPanelExpanded = false;
        document.getElementById('expandPanelIcon').className = 'fas fa-expand-alt';
        document.getElementById('expandPanelText').textContent = 'На весь экран';
    }
}

let isPanelExpanded = false;
function expandDealPanel() {
    const panel = document.getElementById('dealSidePanel');
    isPanelExpanded = !isPanelExpanded;
    if (isPanelExpanded) {
        panel.classList.remove('md:w-[950px]');
        panel.classList.add('md:w-full');
        document.getElementById('expandPanelIcon').className = 'fas fa-compress-alt';
        document.getElementById('expandPanelText').textContent = 'Свернуть';
    } else {
        panel.classList.remove('md:w-full');
        panel.classList.add('md:w-[950px]');
        document.getElementById('expandPanelIcon').className = 'fas fa-expand-alt';
        document.getElementById('expandPanelText').textContent = 'На весь экран';
    }
}

window.addEventListener('popstate', function(e) {
    if (e.state && e.state.dealPanel && e.state.dealId) {
        currentDealId = e.state.dealId;
        const panel = document.getElementById('dealSidePanel');
        const overlay = document.getElementById('panelOverlay');
        document.body.style.overflow = 'hidden';
        overlay.classList.remove('hidden');
        overlay.classList.add('opacity-100');
        panel.classList.remove('translate-x-full');
        loadDealContent(e.state.dealId);
    } else {
        const panel = document.getElementById('dealSidePanel');
        if (panel && !panel.classList.contains('translate-x-full')) {
            panel.classList.add('translate-x-full');
            const overlay = document.getElementById('panelOverlay');
            overlay.classList.remove('opacity-100');
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }, 500);
            currentDealId = null;
        }
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentDealId) closeDealPanel();
});
</script>

<!-- Manager Mobile Bottom Nav -->
<nav class="md:hidden mgr-bottom-nav" id="mgrBottomNav">
    <div class="flex items-center justify-around py-1">
        <button class="mgr-bottom-nav-item active" data-page="dashboard" onclick="switchMgrTab('dashboard')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span>Главная</span>
        </button>
        <button class="mgr-bottom-nav-item" data-page="clients" onclick="switchMgrTab('clients')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            <span>Клиенты</span>
        </button>
        <div class="relative">
            <button class="mgr-bottom-nav-item dash-deals-toggle" data-page="deals" onclick="toggleDashDealsSubmenu(event)" type="button" style="background:none;border:none;cursor:pointer;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <span>Сделки</span>
                <span class="nav-badge" id="mgrDealsBadge" style="display:none;">0</span>
            </button>
            <div id="dashDealsSubmenu" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-[10002]">
                <button onclick="hideDashDealsSubmenu(); switchMgrTab('deals');" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 w-full text-left">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Мои сделки
                </button>
                <a href="/manager/kanban" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50">
                    <svg class="w-4 h-4 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4zm5 0a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H8a1 1 0 01-1-1V4zm6-1a1 1 0 00-1 1v12a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3z"/></svg>
                    Канбан
                </a>
                <a href="/manager/deals-archive" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                    Архив сделок
                </a>
                <a href="/manager/calendar" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50">
                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Календарь задач
                </a>
            </div>
        </div>
        <button class="mgr-bottom-nav-item" data-page="presentations" onclick="switchMgrTab('presentations')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span>Презентации</span>
        </button>
        <button class="mgr-bottom-nav-item" onclick="openMgrMore()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg>
            <span>Ещё</span>
        </button>
    </div>
</nav>

<!-- More Menu Overlay + Panel -->
<div class="md:hidden mgr-more-overlay" id="mgrMoreOverlay" onclick="closeMgrMore()"></div>
<div class="md:hidden mgr-more-panel" id="mgrMorePanel">
    <div class="flex justify-center pt-3 pb-2">
        <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
    </div>
    <div class="px-4 pb-6 space-y-1">
        <button onclick="closeMgrMore(); switchMgrTab('favorites');" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-red-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Избранное</span>
        </button>
        <button onclick="closeMgrMore(); switchMgrTab('comparison');" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-orange-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Сравнение</span>
        </button>
        <button onclick="closeMgrMore(); switchMgrTab('saved-searches');" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-cyan-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-cyan-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Сохраненные поиски</span>
        </button>
        <button onclick="closeMgrMore(); switchMgrTab('presentations');" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-emerald-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-emerald-600" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/><path d="M16 5a1 1 0 011 1v8a1 1 0 01-1 1h-4V5h4z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Презентации</span>
        </button>
        <a href="/manager/kanban" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-sky-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4zm5 0a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H8a1 1 0 01-1-1V4zm6-1a1 1 0 00-1 1v12a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Канбан сделок</span>
        </a>
        <a href="/manager/calendar" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-amber-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Календарь задач</span>
        </a>
        <button onclick="closeMgrMore(); openMgrNotifications();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-blue-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Уведомления</span>
        </button>
        <button onclick="closeMgrMore(); toggleCheckin();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-green-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900" id="mgr-checkin-label-mobile">Отметиться</span>
        </button>
        <button onclick="closeMgrMore(); openMgrProfile();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <span class="text-sm font-medium text-gray-900">Профиль</span>
        </button>
        <a href="{{ url_for('logout') }}" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 transition-colors">
            <div class="w-9 h-9 bg-red-50 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            </div>
            <span class="text-sm font-medium text-red-600">Выйти</span>
        </a>
    </div>
</div>

<!-- Manager Mobile Notifications Modal -->
<div id="mgrNotifModal" class="mgr-fullscreen-modal">
    <div class="sticky top-0 z-10 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-900">Уведомления</h2>
        <button onclick="closeMgrNotifications()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
    <div id="mgr-mob-notif-list" class="p-4 space-y-3">
        <div class="flex items-center justify-center py-12 text-gray-400">
            <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            <span class="text-sm">Загрузка уведомлений...</span>
        </div>
    </div>
</div>

<!-- Manager Mobile Profile Modal -->
<div id="mgrProfileModal" class="mgr-fullscreen-modal">
    <div class="sticky top-0 z-10 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-900">Профиль</h2>
        <button onclick="closeMgrProfile()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
    <div class="p-4 pb-24">
        <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-2xl p-5 mb-4 text-white">
            <div class="flex items-center gap-4">
                {% if current_manager.profile_image and 'randomuser.me' not in current_manager.profile_image %}
                    <img src="{{ current_manager.profile_image }}" alt="{{ current_manager.full_name }}" class="w-14 h-14 rounded-full object-cover border-2 border-white/30">
                {% else %}
                    <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-xl border-2 border-white/30">
                        {{ current_manager.full_name[0].upper() if current_manager.full_name else 'M' }}
                    </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <h3 class="text-base font-bold truncate">{{ current_manager.full_name }}</h3>
                    <p class="text-sm text-white/80">{{ current_manager.display_position }}</p>
                    <p class="text-xs text-white/60">{{ current_manager.email }}</p>
                </div>
            </div>
        </div>

        <div id="mgrProfileShiftBlock" class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-4 overflow-hidden">
            <div class="flex items-center gap-3 px-4 py-3">
                <div id="mgrShiftIconWrap" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg id="mgrShiftIconInactive" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <svg id="mgrShiftIconActive" class="w-5 h-5 text-green-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div id="mgrShiftLabel" class="text-xs text-gray-400">Смена не начата</div>
                    <div class="text-sm font-bold text-gray-900" id="mgrProfileShiftDuration">--:--:--</div>
                </div>
                <button id="mgrShiftToggleBtn" onclick="toggleCheckin()" class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 hover:bg-green-600 text-white transition-colors shadow-sm">
                    <svg id="mgrShiftPlayIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                    <svg id="mgrShiftStopIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/></svg>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-4 overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b border-gray-100">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Контакты</span>
            </div>
            <div class="divide-y divide-gray-100">
                {% if current_manager.phone %}
                <div class="flex items-center gap-3 px-4 py-3">
                    <div class="w-8 h-8 bg-green-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-400">Телефон</div>
                        <div class="text-sm font-medium text-gray-900">{{ current_manager.phone }}</div>
                    </div>
                </div>
                {% endif %}
                <div class="flex items-center gap-3 px-4 py-3">
                    <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-400">Email</div>
                        <div class="text-sm font-medium text-gray-900 truncate">{{ current_manager.email }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-4 overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b border-gray-100">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Меню</span>
            </div>
            <div class="divide-y divide-gray-100">
                <a href="{{ url_for('manager_profile') }}" class="flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors">
                    <div class="w-8 h-8 bg-[#0088CC]/10 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Редактировать профиль</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
                <button onclick="closeMgrProfile(); openMgrNotifications();" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors text-left">
                    <div class="w-8 h-8 bg-amber-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Уведомления</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
                <button onclick="closeMgrProfile(); switchMgrTab('favorites');" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors text-left">
                    <div class="w-8 h-8 bg-red-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Избранное</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
                <button onclick="closeMgrProfile(); switchMgrTab('comparison');" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors text-left">
                    <div class="w-8 h-8 bg-orange-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Сравнение</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
                <a href="/manager/kanban" class="flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors">
                    <div class="w-8 h-8 bg-sky-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4zm5 0a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1H8a1 1 0 01-1-1V4zm6-1a1 1 0 00-1 1v12a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3z"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Канбан сделок</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
                <a href="/manager/calendar" class="flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors">
                    <div class="w-8 h-8 bg-amber-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Календарь задач</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
                <a href="/manager/employees" class="flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition-colors">
                    <div class="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Сотрудники</span>
                    <svg class="w-4 h-4 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" class="flex items-center justify-center gap-2 w-full py-3 text-center text-red-500 rounded-xl font-medium text-sm border border-red-200 hover:bg-red-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            Выйти из системы
        </a>
    </div>
</div>

<script>
// Manager Mobile Navigation
function switchMgrTab(page) {
    if (typeof window.showSection === 'function') {
        window.showSection(page);
    } else {
        document.querySelectorAll('.content-section').forEach(function(s) { s.classList.remove('active'); });
        var target = document.getElementById(page);
        if (target) target.classList.add('active');
    }
    document.querySelectorAll('.mgr-bottom-nav-item[data-page]').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-page') === page);
    });
    window.scrollTo({top: 0, behavior: 'smooth'});
}
window.switchMgrTab = switchMgrTab;

function toggleDashDealsSubmenu(e) {
    e.stopPropagation();
    var sub = document.getElementById('dashDealsSubmenu');
    if (sub) sub.classList.toggle('hidden');
}
function hideDashDealsSubmenu() {
    var sub = document.getElementById('dashDealsSubmenu');
    if (sub) sub.classList.add('hidden');
}
document.addEventListener('click', function(e) {
    var sub = document.getElementById('dashDealsSubmenu');
    if (sub && !sub.classList.contains('hidden') && !e.target.closest('#dashDealsSubmenu') && !e.target.closest('.dash-deals-toggle')) {
        sub.classList.add('hidden');
    }
});

// Sync mobile bottom nav when showSection is called
(function() {
    var _checkInterval = setInterval(function() {
        if (typeof window.showSection === 'function') {
            var _orig = window.showSection;
            window.showSection = function(sectionId) {
                _orig(sectionId);
                document.querySelectorAll('.mgr-bottom-nav-item[data-page]').forEach(function(btn) {
                    btn.classList.toggle('active', btn.getAttribute('data-page') === sectionId);
                });
            };
            window.switchToSection = window.showSection;
            clearInterval(_checkInterval);
        }
    }, 100);
    setTimeout(function() { clearInterval(_checkInterval); }, 5000);
})();

// More panel
function openMgrMore() {
    document.getElementById('mgrMoreOverlay').classList.add('open');
    document.getElementById('mgrMorePanel').classList.add('open');
}
function closeMgrMore() {
    document.getElementById('mgrMoreOverlay').classList.remove('open');
    document.getElementById('mgrMorePanel').classList.remove('open');
}
window.openMgrMore = openMgrMore;
window.closeMgrMore = closeMgrMore;

// Notifications modal
function openMgrNotifications() {
    var modal = document.getElementById('mgrNotifModal');
    if (modal) {
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
        loadMgrMobileNotifications();
    }
}
function closeMgrNotifications() {
    var modal = document.getElementById('mgrNotifModal');
    if (modal) {
        modal.classList.remove('open');
        document.body.style.overflow = '';
    }
}
function loadMgrMobileNotifications() {
    fetch('/api/manager/notifications')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var list = document.getElementById('mgr-mob-notif-list');
            if (!list) return;
            var notifs = data.notifications || data.items || [];
            if (notifs.length === 0) {
                list.innerHTML = '<div class="flex flex-col items-center justify-center py-16 text-gray-400"><svg class="w-12 h-12 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="text-sm">Нет уведомлений</span></div>';
                return;
            }
            var html = '';
            notifs.forEach(function(n) {
                var isRead = n.is_read;
                html += '<div class="bg-white rounded-xl p-4 shadow-sm ' + (isRead ? '' : 'border-l-4 border-[#0088CC]') + '">';
                html += '<div class="flex items-start gap-3">';
                html += '<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ' + (isRead ? 'bg-gray-100' : 'bg-[#0088CC]/10') + '">';
                html += '<svg class="w-4 h-4 ' + (isRead ? 'text-gray-400' : 'text-[#0088CC]') + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>';
                html += '</div>';
                html += '<div class="flex-1 min-w-0"><p class="text-sm ' + (isRead ? 'text-gray-600' : 'font-medium text-gray-900') + '">' + (n.message || n.title || n.description || '') + '</p>';
                html += '<p class="text-xs text-gray-400 mt-1">' + (n.created_at_human || n.time_ago || '') + '</p></div></div></div>';
            });
            list.innerHTML = html;
        })
        .catch(function() {
            var list = document.getElementById('mgr-mob-notif-list');
            if (list) list.innerHTML = '<div class="text-center py-12 text-gray-400"><p class="text-sm">Не удалось загрузить</p></div>';
        });
}
window.openMgrNotifications = openMgrNotifications;
window.closeMgrNotifications = closeMgrNotifications;

// Profile modal
function openMgrProfile() {
    var modal = document.getElementById('mgrProfileModal');
    if (modal) {
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
}
function closeMgrProfile() {
    var modal = document.getElementById('mgrProfileModal');
    if (modal) {
        modal.classList.remove('open');
        document.body.style.overflow = '';
    }
}
window.openMgrProfile = openMgrProfile;
window.closeMgrProfile = closeMgrProfile;

function toggleCheckin() {
    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
    var csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
    fetch('/api/manager/checkin', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken}})
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            updateCheckinLabels(data.status === 'checked_in');
            if (data.status === 'checked_in') {
                showCheckinToast('Смена начата в ' + (data.time || ''));
                startShiftTimer(null);
            } else {
                showCheckinToast('Смена завершена. Время: ' + (data.duration || ''));
                stopShiftTimer();
            }
        } else {
            showCheckinToast('Ошибка: ' + (data.error || 'неизвестная ошибка'));
        }
    })
    .catch(function(err) { console.error('Checkin error:', err); showCheckinToast('Ошибка при отметке'); });
}
window.toggleCheckin = toggleCheckin;

function updateCheckinLabels(isActive) {
    var label = document.getElementById('mgr-checkin-label');
    var labelMobile = document.getElementById('mgr-checkin-label-mobile');
    var labelProfile = document.getElementById('mgr-checkin-label-profile');
    var text = isActive ? 'Завершить смену' : 'Отметиться';
    if (label) label.textContent = text;
    if (labelMobile) labelMobile.textContent = text;
    if (labelProfile) labelProfile.textContent = text;
}

function showCheckinToast(msg) {
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;padding:12px 24px;border-radius:12px;font-size:14px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 300); }, 3000);
}

var _shiftTimerInterval = null;
var _shiftStartTime = null;

function _applyShiftUI(prefix, size, isActive) {
    var iconWrap = document.getElementById(prefix + 'ShiftIconWrap') || document.getElementById(prefix + 'ShiftIconWrap');
    var iconInactive = document.getElementById(prefix + 'ShiftIconInactive');
    var iconActive = document.getElementById(prefix + 'ShiftIconActive');
    var label = document.getElementById(prefix + 'ShiftLabel');
    var toggleBtn = document.getElementById(prefix + 'ShiftToggleBtn');
    var playIcon = document.getElementById(prefix + 'ShiftPlayIcon');
    var stopIcon = document.getElementById(prefix + 'ShiftStopIcon');
    var durationEl = document.getElementById(prefix + 'ShiftDuration') || document.getElementById(prefix + 'ProfileShiftDuration');
    if (isActive) {
        if (iconWrap) iconWrap.className = 'w-' + size + ' h-' + size + ' bg-green-50 rounded-full flex items-center justify-center flex-shrink-0';
        if (iconInactive) iconInactive.classList.add('hidden');
        if (iconActive) iconActive.classList.remove('hidden');
        if (label) { label.textContent = 'Смена активна'; label.className = 'text-xs text-green-600 font-medium'; }
        var btnSize = size == '10' ? '10' : '8';
        if (toggleBtn) { toggleBtn.className = 'flex items-center justify-center w-' + btnSize + ' h-' + btnSize + ' rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors shadow-sm'; }
        if (playIcon) playIcon.classList.add('hidden');
        if (stopIcon) stopIcon.classList.remove('hidden');
    } else {
        if (iconWrap) iconWrap.className = 'w-' + size + ' h-' + size + ' bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0';
        if (iconInactive) iconInactive.classList.remove('hidden');
        if (iconActive) iconActive.classList.add('hidden');
        if (label) { label.textContent = 'Смена не начата'; label.className = 'text-xs text-gray-400'; }
        var btnSize2 = size == '10' ? '10' : '8';
        if (toggleBtn) { toggleBtn.className = 'flex items-center justify-center w-' + btnSize2 + ' h-' + btnSize2 + ' rounded-full bg-green-500 hover:bg-green-600 text-white transition-colors shadow-sm'; }
        if (playIcon) playIcon.classList.remove('hidden');
        if (stopIcon) stopIcon.classList.add('hidden');
        if (durationEl) durationEl.textContent = '--:--:--';
    }
}

function updateShiftTimerUI(isActive) {
    _applyShiftUI('mgr', '10', isActive);
    _applyShiftUI('desk', '9', isActive);
}

function updateShiftTimer() {
    if (!_shiftStartTime) return;
    var diff = Math.floor((Date.now() - _shiftStartTime) / 1000);
    var h = Math.floor(diff / 3600);
    var m = Math.floor((diff % 3600) / 60);
    var s = diff % 60;
    var timeStr = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    var durationEl = document.getElementById('mgrProfileShiftDuration');
    var deskDuration = document.getElementById('deskShiftDuration');
    if (durationEl) durationEl.textContent = timeStr;
    if (deskDuration) deskDuration.textContent = timeStr;
}

function startShiftTimer(startedAt) {
    _shiftStartTime = startedAt ? new Date(startedAt).getTime() : Date.now();
    if (_shiftTimerInterval) clearInterval(_shiftTimerInterval);
    _shiftTimerInterval = setInterval(updateShiftTimer, 1000);
    updateShiftTimer();
    updateShiftTimerUI(true);
}

function stopShiftTimer() {
    _shiftStartTime = null;
    if (_shiftTimerInterval) { clearInterval(_shiftTimerInterval); _shiftTimerInterval = null; }
    updateShiftTimerUI(false);
}

(function checkCheckinStatus() {
    fetch('/api/manager/checkin/status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.is_checked_in) {
            updateCheckinLabels(true);
            startShiftTimer(data.checked_in_at || null);
        } else {
            updateCheckinLabels(false);
            updateShiftTimerUI(false);
        }
    }).catch(function(){ updateShiftTimerUI(false); });
})();


</script>

{% endblock %}